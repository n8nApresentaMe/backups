{"updatedAt":"2026-01-27T18:44:57.000Z","createdAt":"2025-11-04T18:47:16.651Z","id":"dDaZdsSmHxktrhjc","name":"üó£Ô∏è Apr.SDR IA","active":true,"isArchived":false,"nodes":[{"parameters":{"jsCode":"return $('Parser  Chain1').first().json.output.messages.map(message => ({\n  json: { message }\n}))"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3824,3312],"id":"7270b274-73e5-46e8-a25e-ac0832114704","name":"Split de mensagens"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2dfab0a2-c614-429c-a13d-36ecb7803f12","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3376,3328],"id":"4a0d7e13-e4c7-4ff2-bc82-3528f6eb21dd","name":"Se n√£o recebeu mensagem no meio do processamento","alwaysOutputData":false},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3168,3328],"id":"7db3e4ca-447f-496c-aa1e-6eefbcdf9d16","name":"GET2","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","value":"={{ JSON.stringify({ \n  stage_id: $json.newStageId, \n  vars: $json.updatedVars, \n  missingVar: $json.missingVar, \n  afterRepliedInstruction: $json.missingVar.afterRepliedInstruction, \n  lastInstruction: $json.finalInstruction\n}) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-128,3312],"id":"738d4eef-8303-464e-8462-dba3d8f1f028","name":"Salva Novo Estado","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"=Whatsapp message to be splitted and formated: {{ $json.output }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=# SYSTEM: Otimizador de Texto WhatsApp\nObjetivo: Dividir o texto de entrada em 1 a 4 bal√µes de leitura fluida.\n\n# REGRAS DE EXECU√á√ÉO\n1. **Formata√ß√£o:**\n   - Converta `**texto**` ‚Üí `*texto*` -> Apenas para textos que utilizam **.\n   - Converta `~~texto~~` ‚Üí `~texto~` -> Apenas para textos que utilizam ~~.\n   - Converta `__texto__` ‚Üí `_texto_` -> Apenas para textos que utilizam __.\n   - URLs: Devem ser isoladas em uma mensagem exclusiva e envoltas em crase (`url`).\n   - Um split NUNCA deve terminar com v√≠rgula. Ex: 'Bacana, agora me diz uma coisa,' -> 'Bacana, agora me diz uma coisa' \n\n2. **Segmenta√ß√£o (Split):**\n   - **Tamanho:** Alvo de ~150 caracteres (Max 250).\n   - **Corte:** Nunca quebre frases no meio. Use pontua√ß√£o (. ? !) como guia.\n   - **Coes√£o:** Emojis ficam sempre colados √† palavra anterior.\n   - **Contexto:** Separe sauda√ß√µes e perguntas finais em bal√µes pr√≥prios se poss√≠vel.\n\n3. **Output:**\n   - Gere JSON estrito. Sem blocos de c√≥digo markdown.\n\n# JSON SCHEMA\n{ \"messages\": [\"msg1\", \"msg2\", \"msg3\"] }"}]}},"id":"3c28b59b-2be5-4d8b-a517-f8a278a61102","name":"Parser  Chain1","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[2592,3328]},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}"},"id":"b9a4fcff-4642-42ab-ab64-2c3825f158f6","name":"OutputParser","type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[2768,3504]},{"parameters":{"model":"gpt-4o-mini-2024-07-18","options":{"temperature":0.5}},"id":"7f70977d-19d8-40ff-b564-4600a51a03e7","name":"OpenAI","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[2576,3504],"credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"assignments":{"assignments":[{"id":"ae48936d-1ae8-440b-a604-2a6e4c4418f1","name":"output","value":"={{ $('Gerador de Resposta').item.json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2352,3328],"id":"b40fa44a-cc96-4780-98ce-8ae634229c4d","name":"output1"},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[5440,3440],"id":"3e64cd6c-e36e-4040-ae14-ea68c4ac6687","name":"WAIT_SPLIT1","webhookId":"3cea2837-6c05-4e79-8798-96260c4f8dc6"},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[4032,3312],"id":"4a7d5205-199f-46d0-bc3d-a25641504f06","name":"LOOP_SLIT1"},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('LOOP_SLIT1').first().json.message }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5184,3408],"id":"6c0ecafa-b7a3-4fa9-84db-365e8250735e","name":"Envia WhatsApp1"},{"parameters":{"jsCode":"return {\n  tone: \"Engra√ßado\",\n  agentName: \"Alicia\",\n  internalName: \"Alicia da Apresenta.me\",\n  initialMessage: \"Ol√°, tudo bem? üëã \\n\\nEu sou a Alicia, assistente da Apresenta.me, vou te ajudar entendendo melhor sua necessidade.\",\n  language: \"pt-BR\",\n  timeZone: \"Sao Paulo (GTM -3)\",\n  role: \"SDR S√™nior\",\n  companyName: \"Apresenta.me\",\n  companyDepartment: \"Software\",\n  companySite: \"https://apresenta.me\",\n  conduct: \"SYSTEM ROLE: Alicia (SDR consultiva - Apresenta.me).\\n\\nObjetivo: qualificar o lead seguindo estritamente a coleta de dados e o fluxo de est√°gio. Nao marcar reuniao agora, nao falar de preco/ofertas.\\n\\nTom: business casual (WhatsApp). Curta, humana e direta. Evitar formalidade robotica e girias. Usar ponto final e interrogacao. Evitar ao maximo exclamacao. Emojis no maximo 1 por mensagem e so se suavizar.\\n\\nRegra: uma pergunta por vez. Mensagens curtas.\\n\\nNome: sempre chamar o lead pelo primeiro nome em toda mensagem (no inicio ou fim). Nunca usar nome completo.\\n\\nConcorrencia: nunca citar concorrentes nem comparar. Se insistirem, puxar pro cenario do lead com uma pergunta.\\n\\nAnti-desvio: se o lead mudar de assunto ou informar uma dor, responda de forma breve/humana e use o Pivot para retomar a qualificacao imediatamente. O foco √© o dado, nao o suporte.\\n\\nTrivial: se perguntarem algo trivial, responder curto e humano e depois retomar com uma pergunta.\\n\\nSem suporte tecnico: voc√™ nao √© suporte. Se perguntarem algo tecnico e nao tiver instru√ß√£o de busca, use a Carta de Seguran√ßa apenas se necess√°rio.\\n\\nSe o lead pedir demonstracao (\\\"quero conhecer\\\", \\\"quero ver\\\"): dizer que antes precisa terminar de entender o cenario atual dele.\\n\\nDados da empresa (usar se relevante): Apresenta.me, software de gestao imobiliaria. Endereco: R. dos Cacadores, 345 - Sala 01 - Centro, Rio do Sul - SC.\\n\\n ## UTILIZA√á√ÉO DA BASE DE CONHECIMENTO (ACIONAMENTO RESTRITO): \\n - O uso da base de conhecimento √© REATIVO e SUBORDINADO. \\n - Voc√™ est√° PROIBIDA de identificar dores e consultar a base por conta pr√≥pria. \\n - Chame a TOOL de conhecimento *APENAS* se a INSTRUCAO_A ou INSTRUCAO_B pedir explicitamente para \\\"buscar na base\\\", \\\"consultar\\\" ou \\\"verificar\\\". \\n - Se houver uma dor mas a instru√ß√£o mandar apenas coletar um dado, valide a dor de forma r√°pida (ex: \\\"Puxa, imagino a correria\\\") e siga para a pergunta de dado.\\n\\n **REGRAS DE DIAMANTE:** \\n 1. Foque 100% em cumprir a INSTRUCAO_A e INSTRUCAO_B. Elas sobrep√µem qualquer proatividade consultiva.\\n 2. **NUNCA** adivinhe o nome do Lead, e n√£o se apresente se os dados j√° possu√≠rem o nome dele.\\n\",\n  verbosity: \"medium\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1744,3328],"id":"830b54df-f812-44d7-b868-f76c89d0c023","name":"Seta perfil1"},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"hasQuestion\": {\n      \"type\": \"boolean\"\n    }\n  }\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[368,3536],"id":"1e0d9efa-c9a0-4034-9780-5020f7291e27","name":"Parser Router"},{"parameters":{"options":{"temperature":0.1}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[64,3536],"id":"aac02e21-f12c-4c7d-873c-9c1800e3438c","name":"OpenAI Router","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"=# SYSTEM: Classificador de Inten√ß√£o de Conhecimento (RAG Router)\n\nSua miss√£o √© decidir se o sistema deve ou n√£o consultar a Base de Conhecimento (RAG) para responder ao usu√°rio.\n\n### [CONTEXTO ANAL√çTICO]\n- **MENSAGEM ATUAL:** \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n- **HIST√ìRICO RECENTE:**\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"Sem hist√≥rico.\" }}\n\n### [PASSO A PASSO DE RACIOC√çNIO]\n1. **Analise o Alvo:** O usu√°rio est√° perguntando sobre algo que a IA disse anteriormente (ex: \"Por que?\", \"Como assim?\") ou sobre o funcionamento/regras da empresa/produto?\n2. **Defina a Natureza:**\n   - **T√©cnica/Comercial:** D√∫vidas sobre pre√ßos, funcionalidades, integra√ß√µes, seguran√ßa, endere√ßo ou \"como o sistema faz X\". -> **TRUE**\n   - **Fluxo/Conversacional:** Pedidos de explica√ß√£o sobre a fala da IA, sauda√ß√µes, confirma√ß√µes de dados ou rea√ß√µes emocionais. -> **FALSE**\n3. **Peneira de Ambiguidade:** Se o usu√°rio mandar apenas uma palavra interrogativa (ex: \"Por que?\", \"Onde?\", \"Como?\"), olhe para a √∫ltima mensagem da IA. Se a IA fez uma afirma√ß√£o sobre o processo de vendas (ex: \"N√£o temos teste gr√°tis\"), e o usu√°rio disse \"Por que?\", isso √© uma d√∫vida t√©cnica. Se a IA deu um comando e o usu√°rio n√£o entendeu, √© conversacional.\n4. Se o usu√°rio respondeu algo, e logo em seguida perguntou o motivo. Ex: \"Sou cachaceiro, pq?\" -> N√£o √© uma pergunta t√©cnica, √© uma pergunta relacionada a conversa em si, n√£o sobre funcionalidades, exist√™ncia de produtos ou servi√ßos.\n\n### [REGRAS DE CLASSIFICA√á√ÉO]\n- **RETORNE TRUE SE:**\n  - A pergunta exige dados que n√£o est√£o no hist√≥rico (ex: \"Voc√™s integram com o Zapier?\", \"Qual o valor do plano?\").\n  - O usu√°rio contesta uma informa√ß√£o t√©cnica dada pela IA.\n  - O usu√°rio quer detalhes sobre o \"Como funciona\" citado no hist√≥rico.\n\n- **RETORNE FALSE SE:**\n  - For apenas uma resposta aos dados solicitados (Nome, Cargo, Im√≥veis).\n  - For uma d√∫vida sobre a din√¢mica da conversa (ex: \"Por que voc√™ quer saber meu cargo?\").\n  - For uma sauda√ß√£o ou encerramento.\n\n### [SA√çDA OBRIGAT√ìRIA]\nResponda APENAS o JSON puro, sem explica√ß√µes:\n{ \"hasQuestion\": boolean }","hasOutputParser":true,"options":{"systemMessage":"Voc√™ √© um classificador de inten√ß√£o bin√°rio."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[176,3312],"id":"327e946c-4df1-4a66-8de8-302008a1d2e2","name":"Router de D√∫vida","executeOnce":true},{"parameters":{"httpMethod":"POST","path":"7223c6af-f595-4bc2-b84c-602b8900cd08","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-4608,3328],"id":"297535a6-9e37-4bca-a09c-fe84dde17538","name":"Webhook","webhookId":"7223c6af-f595-4bc2-b84c-602b8900cd08"},{"parameters":{"jsCode":"return { \n  cache_key: `session_${$json.body.ticketId}`,\n  companyId: $json.body.companyId,\n  whatsappId: $json.body.whatsappId,\n  user_msg: $json.body.message,\n  user_phone: $json.body.contact.number,\n  timestamp: new Date().getTime()\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4384,3328],"id":"d70c4970-e8e5-4cd6-af88-9d8786224bef","name":"Configura Contexto"},{"parameters":{"operation":"get","key":"={{ $json.cache_key }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1680,3312],"id":"31d9859b-d634-498e-ad98-c8349ddf9c5a","name":"GET Estado Atual","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"// --- BLUEPRINT COMPLETO (Baseado na sua regra de neg√≥cio original) ---\nconst workflow = {\n  START: {\n    type: \"message\",\n    instruction:\n      \"Apresente-se como Alicia da Apresenta.me (). Seja breve e pergunte o nome.\",\n    next_stage: \"WAIT_NAME\",\n  },\n  WAIT_NAME: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"name\",\n        afterRepliedInstruction: `Se o lead respondeu o nome corretamente, diga que √© um prazer conhecer o Lead, de forma simp√°tica e natural, caso o contr√°rio, ignore essa instru√ß√£o.`,\n        description: \"Nome do Lead\",\n      },\n    ],\n    next_stage: \"ASK_WANT_DATA_COLLECTION\",\n  },\n  ASK_WANT_DATA_COLLECTION: {\n    type: \"message\",\n    instruction:\n      'Pergunte ao Lead se ele aceita participar de uma coleta de dados, usando a seguinte mensagem: \"[NOME], s√≥ pra te explicar um pouco mais sobre a Apresenta.me: n√≥s centralizamos a opera√ß√£o da imobili√°ria em um s√≥ lugar, ajudando a organizar processos, ganhar efici√™ncia e aumentar convers√µes, com uma tecnologia simples e suporte humanizado. Se fizer sentido pra voc√™, seguimos com alguns dados essenciais pra agendar a demonstra√ß√£o, pode ser ?\"',\n    next_stage: \"WAIT_WANT_DATA_COLLECTION\",\n  },\n  WAIT_WANT_DATA_COLLECTION: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"wantDataCollection\",\n        afterRepliedInstruction: `Se o usu√°rio est√° aceitando a coleta de dados, de abertura para a coleta de dados. Ex: \"Show, [nome do lead], ent√£o vamos l√°\".`,\n        description:\n          \"Se o usu√°rio QUER participar da COLETA DE DADOS.\",\n      },\n    ],\n    next_stage: \"ROUTER_DATA_COLLECTION\",\n  },\n  ROUTER_DATA_COLLECTION: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"wantDataCollection\",\n        value: false,\n        next_stage: \"SEND_COMMERCIAL_PRESENTATION\",\n      },\n      { default: \"ASK_ROLE\" },\n    ],\n  },\n  SEND_COMMERCIAL_PRESENTATION: {\n    type: \"message\",\n    instruction:\n      \"Responda para o Lead: [NOME DO LEAD], estou te enviando nossa apresenta√ß√£o comercial! Caso voc√™ mude de ideia e queira nos conhecer melhor, √© s√≥ avisar. At√© mais!\",\n    next_stage: \"STOP\",\n  },\n  ASK_ROLE: {\n    type: \"message\",\n    instruction: \"Pergunte qual o cargo ou fun√ß√£o dele na imobili√°ria.\",\n    next_stage: \"WAIT_ROLE\",\n  },\n  WAIT_ROLE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"role\",\n        afterRepliedInstruction: `Se o Lead informou um cargo v√°lido, responda na tonalidade do lead, validando o cargo dele, em √∫ltimos casos, responda algo como: \"Perfeito, [NOME DO LEAD], obrigada por compartilhar!\"`,\n        description:\n          'Cargo do usu√°rio. N√ÉO MOSTRAR EXEMPLOS PARA O USU√ÅRIO. A RESPOSTA SEMPRE DEVE AUTOMATICAMENTE ATRIBUIR VALOR PARA \"isAutonomous\". Considere \"isAutonomous\" com false apenas quando o usu√°rio INDICAR que trabalha sozinho, ou falar de forma explicita que √© aut√¥nomo.',\n      },\n      {\n        name: \"isAutonomous\",\n        description:\n          \"(CAMPO L√ìGICO): Defina AUTOMATICAMENTE TRUE se o usu√°rio trabalha sozinho/aut√¥nomo. Defina FALSE se for imobili√°ria/equipe/s√≥cio etc.\",\n        type: \"boolean\",\n      },\n    ],\n    next_stage: \"ROUTER_PROFILE\",\n  },\n  // --- DECIS√ÉO: AUT√îNOMO VS IMOBILI√ÅRIA ---\n  ROUTER_PROFILE: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"isAutonomous\",\n        value: true,\n        next_stage: \"ASK_RENTAL_STATUS\",\n      }, // Aut√¥nomo pula tamanho do time\n      { default: \"ASK_TEAM_SIZE\" },\n    ],\n  },\n  ASK_TEAM_SIZE: {\n    type: \"message\",\n    instruction: \"Pergunte quantas pessoas trabalham na imobili√°ria hoje.\",\n    next_stage: \"WAIT_TEAM_SIZE\",\n  },\n  WAIT_TEAM_SIZE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"teamSize\",\n        afterRepliedInstruction:\n          'Se o lead estiver em um cargo de gerencia E a equipe for MAIOR que 10: \"Bacana, [NOME DO LEAD], deve t√° corrido pra voc√™s gerenciar todo esse pessoal, n√©?\".\\n Se a quantidade de pessoas na equipe for menor do que 10 pessoas, responda naturalmente: \"Show, [NOME DO LEAD]!!\"',\n        description: \"Tamanho total da equipe (s√≥cios + corretores)\",\n      },\n    ],\n    next_stage: \"ASK_RENTAL_STATUS\",\n  },\n  ASK_RENTAL_STATUS: {\n    type: \"message\",\n    instruction:\n      'Pergunte se eles j√° trabalham com loca√ß√µes ou est√£o estruturando agora. Ex: \"[NOME DO LEAD], e hoje, voc√™s j√° trabalham com loca√ß√µes ou est√£o come√ßando a estruturar ?\"',\n    next_stage: \"WAIT_RENTAL_STATUS\",\n  },\n  WAIT_RENTAL_STATUS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"rentalStatus\",\n        afterRepliedInstruction: `Se o usu√°rio disser que √© focado em vendas, sem indicar que trabalha com loca√ß√µes: \"Entendi, [NOME DO LEAD]. Como voc√™s s√£o focados em venda, √© necess√°rio ter um bom sistema de f√∫nil, para follow-up e um bom CRM pra manter o hist√≥rico dos Leads, isso tudo a Apresenta.me te entrega!! Mas voc√™s trabalham com loca√ß√µes tamb√©m, ou somente vendas?\". Se o usu√°rio disser que trabalha com loca√ß√µes : \"Bacana, [NOME DO LEAD], pra trabalhar com loca√ß√µes, tem que ter um bom sistema. Quando me refiro √† um \"bom sistema\", digo um sistema que trabalhe pra voc√™s, e n√£o que fa√ßa voc√™s trabalharem mais. E isso √© o que o nosso sistema melhor oferece, automa√ß√£o de processos, al√©m de ser um sistema completo que agrupa tudo em um lugar s√≥.\". Se o usu√°rio disser que s√≥ trabalha com vendas: \\\"Entendi, [NOME DO LEAD]. Como voc√™s s√£o focados em venda, √© necess√°rio ter um bom sistema de f√∫nil, para follow-up e um bom CRM pra manter o hist√≥rico dos Leads, isso tudo a Apresenta.me te entrega!!\\\"\"`,\n        description:\n          \"Momento atual da imobili√°ria em rela√ß√£o a loca√ß√£o (j√° trabalham, est√£o come√ßando a estruturar, ou n√£o trabalham). N√ÉO MOSTRE NENHUMA OP√á√ÉO PARA O USU√ÅRIO, DEIXE ELE RESPONDER LIVREMENTE. (Preencha com as op√ß√µes: active = se j√° trabalha / starting = se come√ßando / none = se n√£o trabalha). Se ele j√° trabalha com loca√ß√µes, defina o valor de \\\"interestFocus\\\" como 'all'\",\n      },\n      {\n        name: \"portfolioSize\",\n        afterRepliedInstruction: `Se o usu√°rio informar o tamanho do portif√≥lio, entenda o contexto do LEAD, fa√ßa um coment√°rio sobre o tamanho do portif√≥lio, exemplo: \"Entendi, [NOME DO LEAD]. com essa carteira j√° √© preciso ter uma boa organiza√ß√£o.\"`,\n        description:\n          \"Quantidade total de im√≥veis na carteira (venda + loca√ß√£o). Se o lead trabalhar somenta com vendas, n√£o cite loca√ß√£o, e vice-versa.\",\n      },\n    ],\n    next_stage: \"ASK_INTEREST_FOCUS\",\n  },\n  ASK_INTEREST_FOCUS: {\n    type: \"message\",\n    instruction:\n      'Informe que a Apresenta.me entrega um sistema completo, com site, crm e gest√£o financeira e pergunte ao usu√°rio quais dessas op√ß√µes ele precisa, em espec√≠fico. Ex: \"[NOME DO LEAD], hoje a gente entrega um sistema completo, com site, crm e gest√£o fincanceira, quais desses m√≥dulos fazem sentido pra voc√™?\"',\n    next_stage: \"WAIT_INTEREST_FOCUS\",\n  },\n  WAIT_INTEREST_FOCUS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"interestFocus\",\n        description:\n          \"Quais m√≥dulos do sistema o usu√°rio est√° interessado: Site + CRM, Gest√£o financeira ou todos.\",\n        afterRepliedInstruction:\n          'Se o usu√°rio estiver insistindo em uma op√ß√£o inv√°lida, responda-o que n√£o vendemos a op√ß√£o avulsa. Ex: \"[NOME DO LEAD], que pena! Infelizmente a gente n√£o vende nenhum m√≥dulo avulso...\". Se o usu√°rio quiser s√≥ site: responda-o que n√£o vendemos site avulso. Ex: \"Entendo, [NOME DO LEAD]! O site √© justamente a porta de entrada pra divulgar seus im√≥veis. Aqui ele j√° vem integrado ao CRM, o que ajuda voc√™ a receber os leads e acompanhar as vendas sem perder contato. Faz sentido pra voc√™ CRM e site integrados?\". Se o usu√°rio quiser somente CRM: responda-o que na contrata√ß√£o do CRM o site j√° vem integrado e que n√£o vendemos o CRM separado. Ex: \"Legal, [NOME DO LEAD]! Na contrata√ß√£o do CRM, o site j√° vem integrado, mas n√£o √© poss√≠vel contratar CRM avulso. Faz sentido pra voc√™ CRM e site integrados?\". Se o usu√°rio est√° insistindo na mesma op√ß√£o inv√°lida (√© no m√≠nimo a segunda fez que ele afirma que quer a mesma op√ß√£o inexistente), ignore essa instru√ß√£o. Se o usu√°rio forneceu uma op√ß√£o/resposta v√°lida: \"Show de bola [NOME DO LEAD], pode ter certeza que vamos conseguir te entregar bons resultados com [OP√á√ÉO QUE O LEAD ESCOLHEU (Site + CRM ou Sistema completo/todos os m√≥dulos)].\"',\n        options: {\n          site_crm:\n            \"Se o usu√°rio quiser site + CRM. N√£o selecione essa op√ß√£o se ele apenas disser que quer site ou se ele apenas disser que quer CRM.\",\n          all: \"Se o usu√°rio j√° trabalhar com loca√ß√£o, selecione obrigatoriamente essa op√ß√£o, ou se ele dizer que quer site + crm + gest√£o financeira.\",\n          invalid_option:\n            \"Se, e apenas SE o usu√°rio est√° INSISTINDO e deixando EXPLICITO que quer uma op√ß√£o diferente de site + crm ou todos os m√≥dulos ou que n√£o quer nenhuma das op√ß√µes.\",\n        },\n      },\n    ],\n    next_stage: \"ROUTER_INVALID_INTEREST_FOCUS\",\n  },\n  ROUTER_INVALID_INTEREST_FOCUS: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"interestFocus\",\n        value: \"invalid_option\",\n        next_stage: \"CLOSING_WHEN_INVALID_OPTION\",\n      },\n      { default: \"ASK_CURRENT_SYSTEM\" },\n    ],\n  },\n  ASK_PAIN_POINT: {\n    type: \"message\",\n    instruction:\n      'Se o lead n√£o tem utiliza nenhum sistema: cite o cen√°rio do lead e pergunte qual a PRINCIPAL DOR do lead.\\n Ex: (Adapte esse exemplo para o cen√°rio do lead): \"[NOME DO LEAD], com x colaboradores, x im√≥veis na carteira, trabalhando com vendas e loca√ß√µes, o que voc√™ apontaria como o maior problema ou dor de voc√™s a√≠ na [NOME DA IMOBILI√ÅRIA (se cidado), ou NA IMOBILI√ÅRIA]? Seja na gest√£o financeira, automa√ß√£o de processos, vendas, etc.\". Se o usu√°rio j√° utiliza algum sistema ou CRM imobili√°rio: valide e pergunte quais s√£o os problemas existentes no sistema atual. Ex: \"Certo, [NOME DO LEAD]. O que hoje no sistema que voc√™s usam acaba n√£o acompanhando o crescimento ou a rotina de voc√™s?\"',\n    next_stage: \"WAIT_PAIN_POINT\",\n  },\n  WAIT_PAIN_POINT: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"mainPainPoint\",\n        afterRepliedInstruction:\n          \"Valide a dor do cliente do cliente de forma humana. Pegue o problema do Lead e procure por funcionalidades na base de conhecimento que resolvam o problema do lead e forme um texto breve e de f√°cil leitura com as funcionalidades/solu√ß√µes existentes e explique para o Lead como a Apresenta.me pode solucionar seus problemas.\",\n        description: \"Principal dor, problema ou gargalo citado pelo lead\",\n      },\n    ],\n    next_stage: \"ROUTER_LOCACAO\",\n  },\n  ASK_CURRENT_SYSTEM: {\n    type: \"message\",\n    instruction:\n      'Pergunte se j√° utilizam algum sistema ou CRM imobili√°rio hoje, e qual. Se no meio da conversa o usu√°rio indicar que n√£o tem um CRM, pergunte SOMENTE se ele j√° utiliza algum Sistema Imobili√°rio. Ex: \"[NOME DO LEAD], pra eu me contextualizar melhor, voc√™s j√° est√£o utilizando algum sistema imobili√°rio ou CRM pra melhorar o processo de voc√™s? Se sim, qual ?\" ',\n    next_stage: \"WAIT_CURRENT_SYSTEM\",\n  },\n  WAIT_CURRENT_SYSTEM: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"currentSystem\",\n        afterRepliedInstruction:\n          'Se o lead j√° utiliza algum sistema ou CRM imobili√°rio: pergunte quais s√£o os problemas existentes no sistema atual. Ex: \"Legal, [NOME DO LEAD]. O que hoje no sistema que voc√™s usam acaba n√£o acompanhando o crescimento ou a rotina de voc√™s?\". Se o lead n√£o utiliza nenhum sistema ou CRM imobili√°rio, valide a dor do lead, entendendo que processos manuais os tomam muito tempo e que a Apresenta.me consegue automatizar diversos processos, facilitando a vida da imobili√°ria, se necess√°rio.',\n        description: \"Nome do sistema atual (ex: Kenlo, Jetimob, Planilhas)\",\n      },\n    ],\n    next_stage: \"ASK_PAIN_POINT\",\n  },\n  // --- DECIS√ÉO: APROFUNDAR LOCA√á√ÉO? ---\n  ROUTER_LOCACAO: {\n    type: \"router\",\n    rules: [\n      // Se j√° tem loca√ß√£o ativa ('active'), pergunta detalhes t√©cnicos\n      {\n        variable: \"rentalStatus\",\n        value: \"active\",\n        next_stage: \"ASK_CONTRACT_DETAILS\",\n      },\n      // Se n√£o tem ou est√° come√ßando, vai direto pro or√ßamento\n      { default: \"ASK_PLAN\" },\n    ],\n  },\n  ASK_CONTRACT_DETAILS: {\n    type: \"message\",\n    instruction:\n      'Pergunte quantos contratos ativos administram e como fazem o repasse dos valores dos alugu√©is para propriet√°rios e corretores hoje. Ex: \"Pra gente entender mehor, qual √© o n√∫mero de contratos ativos pra loca√ß√£o que voc√™s possuem? E hoje, como fazem os repasses para os propriet√°rios e corretores ?\"',\n    next_stage: \"WAIT_CONTRACT_DETAILS\",\n  },\n  WAIT_CONTRACT_DETAILS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"numberOfContracts\",\n        afterRepliedInstruction:\n          'Baseando-se no cen√°rio que o LEAD j√° informou ao longo da conversa:\\n Se anteriormente ele disse que utilizam sistemas gen√©ricos (como planilhas) ou que n√£o usam nenhum sistema imobili√°rio e se tiver um n√∫mero consideravelmente alto de contratos: mencione para o lead que com a quantidade de contratos mencionado pelo lead, deve ser um desafio fazer o gerenciamento sem um sistema imobili√°rio; Se tiver um numero de contratos consider√°velmente alto e j√° utilizar algum sistema imobili√°rio: validar de forma simples e natural, sem elogiar ou desdenhar; Se o usu√°rio informou tamb√©m o m√©todo de repasse: adicione uma valida√ß√£o final para o repasse: Se o lead indicar que √© manual/banco: Cite o cen√°rio dele, e diga que no cen√°rio que o lead informou, fazer repasse manual em 2026 √© inaceit√°vel e informe que a Apesenta.me disp√µe de funcionalidades que automatizam esse processo; Se ele indicar que o repasse j√° √© feito de forma autom√°tica de enfase ao nosso produto/funcionalidade: valide a fala do Lead e diga que aqui na Apresenta.me entregamos a funcionalidade de repasse autom√°tico tamb√©m e que tem ajudado muito nossos clientes.',\n        description: \"Quantidade de contratos de loca√ß√£o ativos\",\n      },\n      {\n        name: \"transferMode\",\n        afterRepliedInstruction:\n          'Se o lead indicar que √© manual/banco: Fale sobre o cen√°rio do lead, e diga que no cen√°rio que o lead informou, fazer repasse manual em 2026 √© inaceit√°vel e informe que a Apesenta.me disp√µe de funcionalidades que automatizam esse processo. Se ele indicar que o repasse j√° √© feito de forma autom√°tica, de enfase ao nosso produto/funcionalidade: valide a fala do Lead e diga que aqui na Apresenta.me entregamos a funcionalidade de repasse autom√°tico tamb√©m e que tem ajudado bastante nossos clientes.',\n        description:\n          \"M√©todo de repasse (Ex: Manual, Banco, Split etc.). NUNCA MOSTRE EXEMPLOS PARA O USUARIO E DEIXE ELE RESPONDER LIVREMENTE.\",\n      },\n    ],\n    next_stage: \"ASK_PLAN\",\n  },\n  ASK_PLAN: {\n    type: \"message\",\n    instruction: `\nAgora que voc√™ j√° entende o cen√°rio do lead, pense l√≥gicamente, com base nas informa√ß√µes que ele passou, qual dos planos abaixo se enquadra melhor no cen√°rio dele:    \n- **Start IMOB (R$ 399,99/m√™s):** 2 usu√°rios, 300 im√≥veis, 500 neg√≥cios. Inclui Site e WhatsApp.\n- **Basic IMOB (R$ 649,99/m√™s):** 5 usu√°rios, 1000 im√≥veis, 2000 neg√≥cios. Inclui 50 contratos e gest√£o financeira.\n- **Big IMOB (R$ 949,99/m√™s):** 12 usu√°rios, im√≥veis ilimitados, 5000 neg√≥cios. Inclui 150 contratos e gera√ß√£o autom√°tica de boletos.\n- **Super IMOB (Especialista):** Acima de 25 usu√°rios ou 300 contratos. Gest√£o completa de comiss√µes.\nAp√≥s voc√™ selecionar um desses planos, como resposta: cite o cen√°rio do Lead, informe o porqu√™ o plano selecionado faz sentido para o lead e informe o plano selecionado.\nOBS: N√ÉO ENVIE TODOS OS PLANOS PARA O LEAD, SELECIONE APENAS UM PLANO QUE SE ENCAIXA MELHOR NO CEN√ÅRIO/CONTEXTO ATUAL DA IMOBILI√ÅRIA ATUALMENTE.\n`,\n    next_stage: \"WAIT_PLAN\",\n  },\n  WAIT_PLAN: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"selectedPlanWasAccepted\",\n        afterRepliedInstruction: \"Se o lead informar que precisa AUMENTAR o n√∫mero de usu√°rios, contratos, im√≥veis, neg√≥cios, etc: informe que o plano pode ser personalizado de acordo com o que ele precisa, e que o Plano Selecionado √© apenas um plano base. Por√©m, apenas um especialista pode personalizar o plano do lead; Se o lead informar que precisa DIMINUIR o n√∫mero de usu√°rios, contratos, im√≥veis, neg√≥cios, etc: informe que um especialista vai tentar entender melhor as necessidades do Lead e selecionar um plano mais adequado.\",\n        description:\n          \"Se o plano selecionado j√° foi apresentado um plano com base no cen√°rio do lead e ele disse que o plano faz sentido pra ele, que est√° dentro do que planejam investir. Se o plano selecionado ainda n√£o foi apresentado para o lead: N√ÉO PREENCHA esta vari√°vel. Se for atribuido qualquer valor para whyDidntAcceptedThePlan, atribua FALSE para esta vari√°vel\",\n      },\n    ],\n    next_stage: \"ROUTER_PLAN_ACCEPTED\",\n  },\n  ROUTER_PLAN_ACCEPTED: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"selectedPlanWasAccepted\",\n        value: false,\n        next_stage: \"ASK_WHY_DIDNT_ACCEPTED_THE_PLAN\",\n      },\n      { default: \"CLOSING\" },\n    ],\n  },\n  ASK_WHY_DIDNT_ACCEPTED_THE_PLAN: {\n    type: \"message\",\n    instruction:\n      'Se o lead n√£o informou o motivo pelo qual o plano n√£o faz sentido para ele, pergunte de forma objetiva o motivo. Ex: \"Entendi, [NOME DO LEAD], voc√™ poderia me contar por qual motivo o [PLANO SELECIONADO] n√£o faz sentido pra voc√™?\"',\n    next_stage: \"WAIT_WHY_DIDNT_ACCEPTED_THE_PLAN\",\n  },\n  WAIT_WHY_DIDNT_ACCEPTED_THE_PLAN: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"whyDidntAcceptedThePlan\",\n        afterRepliedInstruction:\n          \"Se ele informou que precisa de uma funcionalidade que n√£o temos, procure na base de conhecimento pela funcionalidade e se esta existir, informe ao cliente que possu√≠mos, se nenhuma funcionalidade que o lead precisa existe na base de conhecimento, ent√£o informe que iremos encaminhar o caso do lead para um especialista. Se o cliente reclamou do valor, informe que iremos encaminhar para um especialista cuidar desse caso espec√≠fico. Se ele informar que precisa de mais usu√°rios, mais contratos, mais im√≥veis ou qualquer outro item existente no plano, informe que trabalhamos que podemos personalizar os planos, mas que um especialista precisa fazer essa personaliza√ß√£o para o Lead.\",\n        description: \"Motivo pelo qual o plano n√£o foi aceito pelo usu√°rio. Se o usu√°rio disse o motivo pelo qual n√£o aceita o plano, altere selectedPlanWasAccepted\",\n      },\n    ],\n    next_stage: \"CLOSING\",\n  },\n  CLOSING: {\n    type: \"message\",\n    instruction:\n      'Agrade√ßa de forma cordial, se despe√ßa e diga que foi um prazer conhecer o lead, citando o nome dele. Diga que coletou todos os dados necess√°rios e informe que um especialista entrar√° em contato para agendar uma apresenta√ß√£o. Ex: \"[NOME DO LEAD], coletei todos os dados necess√°rios aqui e vou prosseguir com o agendamento de uma demonstra√ß√£o te encaminhando pra um especialista. Foi um prazer te conhecer, at√© mais!\"',\n    next_stage: \"STOP\",\n  },\n  CLOSING_WHEN_INVALID_OPTION: {\n    type: \"message\",\n    instruction:\n      \"Agrade√ßa de forma cordial e simp√°tica, diga que ir√° encaminhar o atendimento para um especialista que poder√° cuidar do caso espec√≠fico do lead e se despe√ßa dizendo que foi um prazer conhec√™-lo.\",\n    next_stage: \"STOP\",\n  },\n};\n\nconst redisData = $(\"GET Estado Atual\").item.json.propertyName\n  ? JSON.parse($(\"GET Estado Atual\").item.json.propertyName)\n  : {};\nconst currentStageId = redisData.stage_id || \"START\";\nconst vars = redisData.vars || {};\nconst stageConfig = workflow[currentStageId] || workflow[\"START\"];\n\n// --- VARREDURA GLOBAL DE VARI√ÅVEIS ---\nlet missingVars = [];\nfor (const key in workflow) {\n  const step = workflow[key];\n  if (step.type === \"input\" && step.variables) {\n    step.variables.forEach((v) => {\n      if (!vars[v.name] || vars[v.name].value === null) {\n        missingVars.push({\n          name: v.name,\n          description: v.description,\n          options: v.options || null,\n        });\n      }\n    });\n  }\n}\n\nreturn {\n  workflow,\n  currentStageId,\n  stageConfig,\n  vars,\n  missingVars,\n  userMsg: $(\"CONCATENA1\").item.json.user_full_message,\n  missingVar: JSON.parse($input.first().json.propertyName)?.missingVar,\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1440,3312],"id":"ea335fc1-895b-4f3b-b7cb-f3aca26fa576","name":"BLUEPRINT ENGINE"},{"parameters":{"promptType":"define","text":"=### [ORDEM DE EXECU√á√ÉO - AUDITOR DE DADOS]\n\n1. **AN√ÅLISE DE CONTEXTO:** Compare a [MENSAGEM DO USU√ÅRIO] com os [DADOS J√Å REGISTRADOS] e a [ULTIMA PERGUNTA DO ROB√î].\n2. **VARREDURA EXAUSTIVA:** N√£o pare na primeira informa√ß√£o. Analise cada frase da mensagem. O usu√°rio pode responder uma vari√°vel, corrigir uma antiga e tirar uma d√∫vida t√©cnica na mesma mensagem.\n3. **FILTRO DE INTEN√á√ÉO (CONTEXTO DE REA√á√ÉO):**\n¬† ¬†- Identifique se o usu√°rio est√° respondendo ao **coment√°rio/rea√ß√£o** do rob√¥ (ex: \"N√£o √© dif√≠cil\", \"Verdade\") ou √† **pergunta de extra√ß√£o**.\n¬† ¬†- Se a mensagem do usu√°rio for uma resposta clara apenas ao coment√°rio de empatia da IA (ex: negando que est√° corrido), voc√™ est√° PROIBIDO de extrair esse \"N√£o\" ou \"Sim\" como valor para a vari√°vel de dados.\n4. **EXTRA√á√ÉO E MAPEAMENTO L√ìGICO:**\n¬† ¬†- **Passo A:** Identifique o \"Assunto Central\" da fala do usu√°rio.\n¬† ¬†- **Passo B:** Procure nas VARI√ÅVEIS FALTANTES qual description possui o maior nexo sem√¢ntico com esse assunto.\n¬† ¬†- **Passo C:** Se a fala for apenas uma rea√ß√£o emocional (\"Show!\", \"Massa!\"), verifique se o rob√¥ fez uma pergunta de \"Sim ou N√£o\". Se n√£o fez, a extra√ß√£o √© {}.\n\n---\n\n### [CONTEXTO]\n- [HIST√ìRICO DE CONVERSA - √öLTIMAS 5 MENSAGENS TROCADAS EM ORDEM CRESCENTE]\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"\" }}\n\n### [DADOS DO PROCESSO]\n- **EST√ÅGIO:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.currentStageId) }}\n- **VARI√ÅVEIS FALTANTES:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.missingVars) }}\n- **DADOS J√Å REGISTRADOS:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.vars) }}\n- **ULTIMA PERGUNTA DO ROB√î FOI SOBRE:** \"{{ $('BLUEPRINT ENGINE').first().json.missingVar?.description }}\"\n- **MENSAGEM DO USU√ÅRIO:** \"{{ $('BLUEPRINT ENGINE').first().json.userMsg }}\"\n\n---\n\n### [REGRAS CR√çTICAS DE EXTRA√á√ÉO]\n\n1. **ESTIMATIVA > INCERTEZA (REGRA DO N√öMERO):**\n¬† ¬†- Se o usu√°rio der um valor mas demonstrar incerteza, **EXTRAIA O N√öMERO**. Valores estimados s√£o priorit√°rios.\n\n2. **MAPEAMENTO SEM√ÇNTICO DE OPTIONS:**\n¬† ¬†- Converta a inten√ß√£o na **CHAVE (key)** t√©cnica das options. *PROIBIDO* selecionar se n√£o houver correspond√™ncia exata.\n\n3. **CORRE√á√ÉO E SOBREPOSI√á√ÉO (PRIORIDADE M√ÅXIMA):**\n¬† ¬†- Se a mensagem contradizer algo salvo, extraia o novo valor para **SOBRESCREVER** o antigo.\n\n4. **VALIDA√á√ÉO DE POSSE (ANTI-ALUCINA√á√ÉO):**\n¬† ¬†- Extraia ferramentas apenas se houver ind√≠cio claro de **USO ATUAL**.\n\n5. **NEGATIVAS, ADIAMENTO E RECUSA:**\n¬† ¬†- **RESPOSTA NEGATIVA:** Se for sim/n√£o, extraia o valor (TRUE/FALSE) conforme a descri√ß√£o.\n¬† ¬†- **ADIAMENTO (answer_later):** Use SEMPRE que o usu√°rio indicar que n√£o tem a resposta ou responder√° depois.\n¬† ¬†- **RECUSA (not_provided):** Use quando houver nega√ß√£o por privacidade ou grosseria.\n\n6. **RETROATIVIDADE:**\n¬† ¬†- Se responder algo que estava como `answer_later`, atualize com o novo dado.\n\n7. **V√çNCULO SEM√ÇNTICO E PRECED√äNCIA (ALVO DA RESPOSTA):**\n   - **An√°lise de Componente:** Identifique que a mensagem da IA possui dois alvos: o *Alvo Assertivo* (coment√°rio de empatia/opini√£o) e o *Alvo de Extra√ß√£o* (a pergunta de dado).\n   - **Nexo de Resposta:** Verifique se a resposta do usu√°rio (especialmente \"Sim\", \"N√£o\", \"Mais ou menos\") est√° invalidando ou confirmando o *Alvo Assertivo* (adjetivos e estados descritos pela IA) ou o *Alvo de Extra√ß√£o*.\n   - **Prioridade de Descarte:** Se a justificativa que acompanha a resposta (o texto ap√≥s o Sim/N√£o) for semanticamente ligada ao *Alvo Assertivo*, voc√™ est√° PROIBIDO de extrair esse valor para a vari√°vel. O nexo deve ser com a `description` da vari√°vel, n√£o com o coment√°rio social da IA.\n\n8. **VALIDA√á√ÉO DE CONSIST√äNCIA SEM√ÇNTICA:**\n   - **Mapeamento de Dom√≠nio:** Antes de extrair, classifique o dom√≠nio da resposta do usu√°rio.\n   - **L√≥gica:** Se o usu√°rio nega algo (\"N√£o...\") e a continua√ß√£o da frase trata de um assunto diferente ou fora de contexto em rela√ß√£o a √∫ltima pergunta feita pelo rob√¥, ignore a extra√ß√£o. \n   - **Regra de Ouro:** S√≥ extraia o valor se o l√©xico utilizado pelo usu√°rio (palavras-chave e contexto) pertencer ao mesmo dom√≠nio sem√¢ntico da `description` da vari√°vel. Nega√ß√µes de adjetivos nunca devem ser mapeadas como valores de estado de processo.\n---\n\n### [SA√çDA OBRIGAT√ìRIA]\n- Retorne **APENAS** o JSON puro. Proibido adicionar explica√ß√µes.\n- Se nenhum dado for extra√≠do ou corrigido, retorne `{}`.\n- Formato: `{ \"nome_da_variavel\": valor_extraido }`","hasOutputParser":true,"options":{"systemMessage":"=Voc√™ √© um extrator inteligente de dados, extrai dados conforme as regras estabelecidas"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-704,3312],"id":"739f0de6-728c-4ae4-9b50-0ec36296d4d5","name":"Extrator Inteligente"},{"parameters":{"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[-752,3536],"id":"a3bcb857-749d-4f3b-b187-c7fa841f4151","name":"DeepSeek Model","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}},{"parameters":{"jsCode":"const inputData = $input.all()[0].json;\nconst workflow = $('BLUEPRINT ENGINE').first().json.workflow;\nlet currentStageId = $('BLUEPRINT ENGINE').first().json.currentStageId;\nlet vars = $('BLUEPRINT ENGINE').first().json.vars;\nlet stageConfig = $('BLUEPRINT ENGINE').first().json.stageConfig;\nconst lastInstruction = JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').lastInstruction\nconst lastMissingVar = JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar \nlet outputInstruction = \"\";\nlet missingVar = \"\";\nlet immediatelyNextStage = \"\";\n\n// --- 1. ATUALIZA√á√ÉO GLOBAL (Check-in) ---\nconst extractedObj = inputData.output || {};\nfor (const [key, value] of Object.entries(extractedObj)) {\n    // S√≥ atualiza se tiver valor real\n    if (value !== null && value !== undefined && value !== \"\") {\n        vars[key] = { value: value, type: 'extracted' };\n    }\n}\n\n// Helper: Verifica se TODAS as vari√°veis do est√°gio est√£o preenchidas\nfunction isInputSatisfied(stage) {\n    if (!stage || stage.type !== 'input') return false;\n    // Retorna true apenas se TODAS as vari√°veis listadas existirem em 'vars'\n    return stage.variables.every(v => vars[v.name] && vars[v.name].value !== null && vars[v.name].value !== \"\");\n}\n\n\n// --- 2. LOOP DE AVAN√áO (Auto-Skip & Look Ahead) ---\nlet safetyLoop = 0;\nlet advancing = true;\n\nwhile (advancing && safetyLoop < 50) {\n    stageConfig = workflow[currentStageId];\n    if (!stageConfig) break;\n\n    if (stageConfig.immediately_next_stage) {\n      immediatelyNextStage = stageConfig.immediately_next_stage\n    }\n\n    advancing = false; // Por padr√£o, o loop para aqui, a menos que encontre motivo para seguir\n\n    // ======================================================\n    // CASO 1: INPUT (Esperando dados do usu√°rio)\n    // ======================================================\n    if (stageConfig.type === 'input') {\n        if (isInputSatisfied(stageConfig)) {\n            // Temos tudo! Pula para o pr√≥ximo est√°gio.\n            currentStageId = stageConfig.next_stage;\n            advancing = true; \n        } else {\n            // [CORRE√á√ÉO AQUI] Falta resposta. N√£o podemos deixar a instru√ß√£o vazia.\n            // Descobre qual vari√°vel est√° faltando para orientar a IA\n            missingVar = stageConfig.variables.find(v => !vars[v.name] || !vars[v.name].value);\n            \n            if (missingVar) {\n                // Se o usu√°rio falou algo nada a ver (extra√ß√£o rodou mas n√£o pegou o dado)\n                if (Object.keys(extractedObj).length > 0 && !Object.values(extractedObj).find(v => v)) {\n                     outputInstruction = `O usu√°rio respondeu algo, mas n√£o entendi o(a) ${missingVar.description}. Pergunte novamente de forma clara.`;\n                } else {\n                    if (lastMissingVar && !vars[lastMissingVar.name]?.value) {\n                      outputInstruction = lastInstruction\n                    } else {\n                      outputInstruction = `Pergunte: ${missingVar.description}`; \n                    }\n                }\n            }\n            // Mantemos advancing = false para PARAR aqui e esperar o user responder\n        }\n    }\n\n    // ======================================================\n    // CASO 2: MENSAGEM (O rob√¥ fala)\n    // ======================================================\n    else if (stageConfig.type === 'message') {\n        // [LOOK AHEAD]\n        // Verifica se a mensagem serve para pedir um dado que J√Å TEMOS.\n        const nextStage = workflow[stageConfig.next_stage];\n        \n        // Se o pr√≥ximo passo √© input E j√° est√° preenchido -> Pula a mensagem atual\n        if (nextStage && nextStage.type === 'input' && isInputSatisfied(nextStage)) {\n            currentStageId = nextStage.next_stage;\n            advancing = true; \n        } else {\n            // Mensagem necess√°ria. Define instru√ß√£o.\n            outputInstruction = stageConfig.instruction;\n            \n            // J√° aponta o ponteiro para o pr√≥ximo est√°gio (onde vamos esperar o input)\n            if (stageConfig.next_stage !== 'STOP') {\n                currentStageId = stageConfig.next_stage;\n                const nextStage = workflow[currentStageId]   \n\n                if (nextStage.type == 'input') {\n                  missingVar = nextStage.variables.find(v => !vars[v.name] || !vars[v.name].value);\n                }\n              \n            }\n            // Para o loop para a IA falar.\n            advancing = false; \n        }\n    }\n\n    // ======================================================\n    // CASO 3: ROUTER (L√≥gica condicional)\n    // ======================================================\n    else if (stageConfig.type === 'router') {\n        let routeFound = false;\n        for (const rule of stageConfig.rules) {\n            if (rule.default) {\n                currentStageId = rule.default;\n                routeFound = true;\n                break;\n            }\n            // Valida√ß√£o simples de valor\n            if (vars[rule.variable] && vars[rule.variable].value === rule.value) {\n                currentStageId = rule.next_stage;\n                routeFound = true;\n                break;\n            }\n        }\n        // Se achou rota, continua avan√ßando no mesmo tick\n        if (routeFound) advancing = true; \n    }\n    \n    safetyLoop++;\n}\n\nreturn {\n    newStageId: currentStageId,\n    updatedVars: vars,\n    finalInstruction: outputInstruction,\n    missingVar, \n    immediatelyNextStage\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-336,3312],"id":"49d85cc1-5324-427b-b56e-d7d5d61cbef2","name":"LOGIC ENGINE"},{"parameters":{"promptType":"define","text":"={{ $('CONCATENA1').first().json.user_full_message }}","options":{"systemMessage":"=### [SISTEMA DE EXECU√á√ÉO DETERMIN√çSTICO]\n\nVoc√™ √© um executor l√≥gico de fluxos. Sua sa√≠da deve ser **APENAS** a mensagem final de WhatsApp, humanizada e sem metadados. Se falhar em seguir a ordem de execu√ß√£o ou alucinar informa√ß√µes fora do RAG, a opera√ß√£o ser√° comprometida.\n\n### [PROCESSO DE FORMATA√á√ÉO FINAL - CR√çTICO]\n\n1. **VALIDE O CONTE√öDO:** A mensagem deve seguir uma estrutura parecida com: [Resposta T√©cnica]. [INSTRU√á√ÉO_A]. [Pivot], [INSTRU√á√ÉO_B]?\n2. **PUNI√á√ÉO POR PROATIVIDADE:** Se voc√™ sugerir um pr√≥ximo passo que n√£o seja o de B, a mensagem ser√° descartada. Seja um rob√¥ executor.\n3. CAMADA DE CONEX√ÉO HUMANA: Voc√™ est√° AUTORIZADA (e incentivada) a adicionar uma breve rea√ß√£o social ao coment√°rio do usu√°rio no in√≠cio da mensagem. Se o usu√°rio lamentou algo, lamente com ele. Se ele comemorou, comemore.\n\n---\n\n### [ALGORITMO DE RACIOC√çNIO OBRIGAT√ìRIO]\n\nPASSO 0: EMPATIA IMEDIATA (Ouvir antes de falar)\n- Analise a carga emocional da MENSAGEM_USU√ÅRIO.\n- Se o usu√°rio fez um coment√°rio de opini√£o (ex: \"Que pena\", \"Finalmente\"), valide isso em uma frase curta de at√© 5 palavras antes de seguir para a Instru√ß√£o A ou B.\n- Se for uma resposta seca de dado, pule para o Passo 1.\n\n**PASSO 1: TRIAGEM DE D√öVIDA T√âCNICA (NEXO SEM√ÇNTICO)**\n1. Identifique se a MENSAGEM_USU√ÅRIO cont√©m uma d√∫vida sobre o sistema/empresa.\n2. TRADU√á√ÉO HUMANA (RAG): Se a resposta estiver no RAG, voc√™ est√° PROIBIDO de copiar e colar o texto t√©cnico.\n- *A√á√ÉO:* Responda de forma direta (Sim ou N√£o) e resuma o benef√≠cio em uma frase curta (Ex: \"Traz muito mais agilidade e seguran√ßa\").\n- *VETO BUROCR√ÅTICO:* Evite termos T√âCNICOS e burocr√°ticos, responda de forma humana. Respostas detalhadas apenas se forem solicitadas.\n3. **DECIS√ÉO:**\n   - **TEM NO RAG:** Responda de forma simples e direta. Responda somente a pergunta do usu√°rio, e se necess√°rio, uma explica√ß√£o humana.\n   - **N√ÉO TEM NO RAG / D√öVIDA VAGA:** Use obrigatoriamente a **Carta de Seguran√ßa**: \"Vou ver sobre [Assunto] com o time pra n√£o te passar nada errado, t√°?\".\n4. O que considerar existente no RAG:\n  - Usu√°rio pergunta sobre funcionalidade ou exist√™ncia do produto: se o RAG ensina a utilizar √© considerado exist√™ncia.\n  - Usu√°rio pergunta sobre a empresa: se a informa√ß√£o existir, repasse!\n\n**PASSO 2: FILTRAGEM E TRADU√á√ÉO DO FLUXO**\n1. **Analise a INSTRU√á√ÉO_A:** - Se existir: Traduza para fala natural. Se INSTRUCAO_B for terminal (tchau/especialista), transforme a pergunta de A em uma afirma√ß√£o justificativa.\n   - Se n√£o existir: Use uma **REA√á√ÉO** curta da lista fechada.\n2. **PIVOT:** Escolha obrigatoriamente um conector da lista de **PIVOTS**.\n3. **Analise a INSTRU√á√ÉO_B:** - Traduza o comando t√©cnico (ex: \"Pergunte o cargo\") para uma fala humana de WhatsApp.\n\n---\n\n\n[INSTRU√á√ÉO DO FLUXO] (CR√çTICO - OBRIGAT√ìRIO)\n* **INSTRU√á√ÉO_A:** {{ JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').afterRepliedInstruction }}\n* **INSTRU√á√ÉO_B:** \"{{ $('LOGIC ENGINE').first().json.finalInstruction }}\"\n\n---\n\n### [FILTRO DE RELEV√ÇNCIA SEM√ÇNTICA - CR√çTICO]\n\n**REGRA DE OURO:** Antes de executar a INSTRU√á√ÉO_A, realize o teste de nexo:\n1. **AN√ÅLISE DE RESPOSTA:** A MENSAGEM_USUARIO √© uma resposta direta √† √∫ltima pergunta feita pela 'ai' no [HIST√ìRICO]?\n2. **VALIDA√á√ÉO DE CONDI√á√ÉO:** O conte√∫do da MENSAGEM_USUARIO satisfaz o gatilho l√≥gico (ex: \"Se o usu√°rio disser X\") da INSTRU√á√ÉO_A?\n3. **DECIS√ÉO DE EXECU√á√ÉO:** - **SE SIM para ambos:** Execute a INSTRU√á√ÉO_A normalmente.\n   - **SE N√ÉO (Desvio de Assunto):** Ignore a INSTRU√á√ÉO_A por completo. Responda apenas √† nova d√∫vida do usu√°rio (Passo 1 do Algoritmo) e use o Pivot para retomar o fluxo.\n\n**EXEMPLO DE COMPORTAMENTO:**\n- **Hist√≥rico:** \"Voc√™ √© casado?\" -> **Usu√°rio:** \"Onde voc√™ mora?\"\n- **A√ß√£o:** O usu√°rio mudou de assunto. Ignore a instru√ß√£o de \"falar que tamb√©m √© casado\". Responda a localiza√ß√£o e retome o fluxo.\n\n---\n\n### [REGRAS DE DIAMANTE - PRIORIDADE 0] -> Se n√£o seguir estas regras, ser√° considerada FALHA GRAV√çSSIMA\n## [TRAVA ANTI-ALUCINA√á√ÉO - PRIORIDADE M√ÅXIMA]\n- * **REGRA DO 'S√ì O QUE EST√Å ESCRITO':** Se o usu√°rio perguntar algo (Pre√ßo, Teste, Integra√ß√£o) e a palavra exata n√£o estiver no [CONTEXTO T√âCNICO], voc√™ est√° TERMINANTEMENTE PROIBIDA de responder \"Sim\" ou \"N√£o\".\n* **PUNI√á√ÉO:** Responder \"Sim\" a algo que n√£o est√° no RAG √© considerado uma falha cr√≠tica de sistema. Use a CARTA DE SEGURAN√áA ou n√£o diga nada sobre o assunto t√©cnico.\n\n- * **ESTRUTURA OBRIGAT√ìRIA:** Respeite a ordem: [Resposta T√©cnica] + [Abertura/Rea√ß√£o] + [Pivot] + [Instru√ß√£o de Fluxo].\n- * **VETO DE AUTONOMIA (DETERMINISMO):** Voc√™ est√° PROIBIDO de pular etapas ou antecipar dados se eles n√£o estiverem explicitamente na INSTRUCAO_B.\n- * **VETO DE ROBOTIZA√á√ÉO:** Proibido ignorar coment√°rios subjetivos do usu√°rio. Haja como um ser humano, valide os coment√°rios do usu√°rio.\n- * **INICIALIZA√á√ÉO OBRIGAT√ìRIA:** Hist√≥rico de conversa vazio ? -> SE APRESENTE OBRIGATORIAMENTE\n- * **FINALIZA√á√ÉO CIR√öRGICA:** A √∫ltima frase da sua mensagem deve ser obrigatoriamente a vers√£o humanizada do texto da INSTRUCAO_B. Nada pode vir depois disso.\n- * **ALUCINA√á√ÉO = FALHA CR√çTICA:** √â terminantemente PROIBIDO afirmar qualquer capacidade t√©cnica ou exist√™ncia de produto que n√£o esteja escrita no [CONTEXTO T√âCNICO].\n- * **OMISS√ÉO DE D√öVIDA T√âCNICA = FALHA CR√çTICA:** Se o usu√°rio fizer uma pergunta t√©cnica e a resposta estiver no RAG, voc√™ DEVE responder antes de seguir o fluxo. A Carta de Seguran√ßa s√≥ deve ser usada se a informa√ß√£o n√£o existir no RAG.\n- * **OMISS√ÉO DE D√öVIDA TRIVIAL = FALHA CR√çTICA:** Se o usu√°rio fizer uma pergunta t√©cnica (\"tudo bem?\", \"qual seu nome?\"), voc√™ OBRIGATORIAMENTE deve responder o usu√°rio, de forma humanizada, SEMPRE. \n- * **PONTUA√á√ÉO:** Use apenas \".\" e \"?\". **PROIBIDO** o uso de exclama√ß√µes (!).\n- * **UTILIZA√á√ÉO DO CONTEXTO T√âCNICO:** Nunca copie e cole nada do [CONTEXTO T√âCNICO], utilize os dados obtidos para gerar uma resposta humanizada.\n- * **SA√çDA FINAL OBRIGAT√ìRIA:** Tradu√ß√£o l√≥gica da INSTRU√á√ÉO_B. Se o final do output n√£o sair conforme o que √© solicitado na INSTRU√á√ÉO_B, CONSIDERE QUE VOC√ä FALHOU GRAVEMENTE.\n\n---\n\n### [DADOS PARA PROCESSAMENTO]\n* **DADOS_COLETADOS:** {{ JSON.stringify($('LOGIC ENGINE').first().json.updatedVars) }}\n* **CONTEXTO_T√âCNICO (RAG):** {{ $('MERGE DADOS').first().json.rag_context ? $('MERGE DADOS').first().json.rag_context.join('\\n\\n'): \"\" }}\n* **MENSAGEM_USU√ÅRIO:** \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n\n---\n\n### [HIST√ìRICO DE CONVERSA]\n{{ $('Formata ultimas mensagens').first().json.historyMessages }}\n---\n\n### [PERFIL]\n- Quem voc√™ √©?: {{ $json.agentName }}.\n- Qual sua mensagem de apresenta√ß√£o?: {{ $json.initialMessage }} -> CR√çTICO: Use obrigatoriamente quando n√£o tiver hist√≥rico de conversa.\n- Quais suas condutas e regras secund√°rias?: {{ $json.conduct }}\n- Qual a verbosidade das respostas geradas por voc√™?: {{ $json.verbosity }}\n- Qual o site da empresa que voc√™ trabalha?: {{ $json.companySite }}\n- Qual o departamento da empresa que voc√™ trabalha?: {{ $json.companyDepartment }}\n- Qual seu cargo na {{ $json.companyName }}?: {{ $json.role }}\n- Qual o timeZone que voc√™ deve respeitar?: {{ $json.timeZone }}\n- Qual a linguagem padr√£o que voc√™ deve utilizar?: {{ $json.language }}\n- Qual a tonalidade da conversa que voc√™ deve seguir?: {{ $json.tone }}\n---\n\n### [BLOQUEIOS DE VAZAMENTO E ANTI-ROB√î]\n* **PROIBIDO:** \"Instru√ß√£o\", \"Lead\", \"RAG\", \"M√≥dulo\", \"Base de Conhecimento\".\n* **NOME:** Use apenas o primeiro nome do lead.\n* **FALHA DE COMANDO:** NUNCA envie o texto cru da instru√ß√£o (ex: \"Pergunte sobre X\"). Sua miss√£o √© agir, n√£o repetir a ordem.\n\n‚ö†Ô∏è **SA√çDA FINAL:**\n- Gere apenas a mensagem final concatenada e humanizada conforme o algoritmo acima.\n- Transforme as instru√ß√µes em intera√ß√µes humanas ou chamadas de tools."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[1936,3568],"id":"6ced4093-0584-4920-af03-b19775e2e754","name":"Gerador de Resposta"},{"parameters":{"jsCode":"const messages = $input.item.json.messages || [];\nconst fullText = messages.map(m => m.message).join('\\n');\n\nreturn {\n  user_full_message: fullText,\n  cache_key: $('Configura Contexto').item.json.cache_key\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1872,3312],"id":"cf14ddf9-674e-44b9-8f23-d09c3b549e59","name":"CONCATENA1"},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"description\": \"Objeto JSON contendo as chaves das vari√°veis encontradas e seus respectivos valores.\",\n  \"additionalProperties\": {\n    \"oneOf\": [\n      {\n        \"type\": \"string\"\n      },\n      {\n        \"type\": \"number\"\n      },\n      {\n        \"type\": \"boolean\"\n      },\n      {\n        \"type\": \"null\"\n      },\n      {\n        \"type\": \"array\",\n        \"items\": {\n          \"type\": \"string\"\n        }\n      }\n    ]\n  }\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-528,3536],"id":"f42bfe98-ea4e-4b64-b4b1-f60e99297356","name":"Structured Output Parser1"},{"parameters":{"amount":12},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-2256,3584],"id":"7c1edbf7-ad5e-4dcf-aa0e-789071fc18e4","name":"Wait1","webhookId":"d1e38aad-57ac-45e5-b64a-08e2f1ce1a6f"},{"parameters":{"operation":"delete","key":"=temp.{{ $('Configura Contexto').item.json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2112,3328],"id":"69e79069-efac-44b0-8752-141944a73578","name":"DELETE1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2aafb32-380d-4510-810a-888831d36437","leftValue":"={{ DateTime.fromMillis($json.messages?.last().timestamp) }}","rightValue":"={{ $now.minus(12, 'seconds' )}}","operator":{"type":"dateTime","operation":"before"}}],"combinator":"and"},"renameOutput":true,"outputKey":"segue"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3d2a33da-ed74-4906-92aa-74ad3a37c4f1","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"nada"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"espera"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-2448,3328],"id":"cbc8d2d2-e285-4ae7-a886-fbb287f7321e","name":"SWITCH_BUFFER"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-2112,3488],"id":"f59c0a36-e6c1-4183-93dd-37cdb508a130","name":"NADA1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1f5bcbd1-6685-469d-bbf2-7939008b234d","leftValue":"={{ $json.user_msg }}","rightValue":"clear:cache:111222","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4144,3328],"id":"bf1ca13a-53ea-4963-a585-f189a6563522","name":"If2"},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3680,3024],"id":"79a002fa-786e-458a-ac14-5ab9f9e0fbc0","name":"Delete table or rows1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"delete","key":"={{ $('Configura Contexto').item.json.cache_key }}_state"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3856,3024],"id":"a8343dfa-0bf6-4e9a-af8b-f6b1434c747e","name":"Deleta estado atual","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=temp.{{ $('Configura Contexto').item.json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3488,3024],"id":"255c8c55-36e5-4b1d-8a37-680c09c93110","name":"DELETE2","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"return {\n  messages: [\n    ...(typeof $('BUSCA MENSAGENS ACUMULADAS').first().json.messages == 'string' ? JSON.parse($('BUSCA MENSAGENS ACUMULADAS').first().json.messages) : $('BUSCA MENSAGENS ACUMULADAS').first().json.messages), \n    ...(typeof $('GET2').first().json.messages == 'string' ? JSON.parse($('GET2').first().json.messages) : $('GET2').first().json.messages)\n  ]\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3568,3776],"id":"23b8b322-a8bf-405c-8d37-ce4857feb11e","name":"Concatena mensagens para cache"},{"parameters":{"jsCode":"const messages = typeof $input.first().json.messages == 'string' ? JSON.parse($input.first().json.messages) : $input.first().json.messages\n\nreturn {\n  messages: messages?.map(message => typeof message === 'string' ? JSON.parse(message) : message) ?? null\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2800,3344],"id":"d10f3004-81bf-4a98-8b5c-0fddeae017c0","name":"Transforma em objeto literal"},{"parameters":{"method":"PATCH","url":"=https://api-chat-joao.apre.tv/api/ticket/{{ $('Webhook').first().json.body.ticketId }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"pending\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[4800,2688],"id":"c6a24869-19d3-4938-abf6-df95d132a403","name":"Transfere ticket para Aguardando Apre.Chat"},{"parameters":{"method":"POST","url":"=https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output }}"},{"name":"number","value":"={{ $('Webhook').first().json.body.contact.number }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"},{"name":"whatsappId","value":"={{ $('Webhook').first().json.body.whatsappId }}"},{"name":"messageRepliedId","value":"={{ $('Webhook').first().json.body.messageId }}"},{"name":"messageType","value":"internalNote"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5936,2688],"id":"5b7e572b-3651-4df5-9865-14ab2ee04a38","name":"Salva nota na conversa1"},{"parameters":{"jsCode":"const data = $input.all();\nconst formatChatHistory = (inputData) => {\n  return inputData.map(jsonItem => {\n    const item = jsonItem.json\n    // 1. Define o remetente\n    const sender = item.message.type === 'human' ? 'User' : 'IA';\n    \n    // 2. Pega o conte√∫do original\n    let content = item.message.content;\n\n    // 3. Se for IA, aplica a Regex para limpar o \"lixo\" t√©cnico\n    if (item.message.type === 'ai') {\n      // REGEX EXPLICADA:\n      // ^              -> Come√ßa no in√≠cio da string\n      // \\[Used tools:  -> Procura literalmente por \"[Used tools:\"\n      // [\\s\\S]*?       -> Pega qualquer caractere (incluindo quebra de linha) de forma n√£o-gulosa (para no primeiro match)\n      // \\]\\]           -> Procura o fechamento dos colchetes duplos \"]]\"\n      // \\s* -> Remove quaisquer espa√ßos ou quebras de linha que sobrem logo ap√≥s\n      content = content.replace(/^\\[Used tools:[\\s\\S]*?\\]\\]\\s*/, '');\n    }\n\n    // 4. Retorna no formato solicitado\n    return `${sender}: ${content}`;\n  }).join('\\n'); // Une tudo com quebra de linha\n};\n\n// Executa e mostra o resultado\nconst result = formatChatHistory(data);\n\nreturn  {\n  result\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5296,2688],"id":"cc371954-0e52-468e-a628-613d86bb1bb3","name":"Formata hist√≥rico1","executeOnce":true},{"parameters":{"promptType":"define","text":"=[HIST√ìRICO DE CONVERSA]\n{{ $json.result }}","options":{"systemMessage":"*DOSSI√ä*\nCrie um breve Dossi√™ da conversa, listando cada informa√ß√£o separada por linha e colocando a label em negrito.\n\n*AN√ÅLISE*\nTom: Defina o tom/perfil do usu√°rio.\nResumo: Gere um breve resumo da conversa\n\n*ONDE PAROU*\nInforme onde a conversa parou\n\n*PR√ìXIMOS PASSOS*\nDefina os pr√≥ximos passos\n\n## FORMATA√á√ÉO:\nNegrito: Um asterisco antes e depois da palavra/frase. Ex: '*Teste*'\nIt√°lico:  Um underline antes e depois da palavra/frase. Ex: '_Teste_'\n\n## REGRAS DE OURO:\n- Seja breve\n- Crie um resumo objetivo\n- Texto corrido apenas no resumo (bloco an√°lise)\n\n\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[5568,2688],"id":"007a77a5-b5dd-4aea-94ba-f1db12dc9e31","name":"Gera resumo da conversa - AI1"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[5552,2896],"id":"54247887-202c-4374-8679-88bef92c2d42","name":"DeepSeek Chat Model2","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"sort":{"values":[{"column":"id"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[5072,2688],"id":"8c4a0c7a-1b8c-431e-957f-fbf9335c1258","name":"Busca hist√≥rico de conversa1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3856,3344],"id":"86b0b7d7-5b3c-40b5-9b36-5d105fb09f76","name":"Busca mensagens no cache","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"const inputMessages = typeof $input.first().json.messages == 'string' ?  JSON.parse($input.first().json.messages) : $input.first().json.messages\nconst cacheMessagesToArrayJSON = inputMessages?.map(message => typeof message == 'string' ? JSON.parse(message) : message) || []\n\nconst userMsg = {\n  message: $('Configura Contexto').first().json.user_msg, \n  timestamp: $now.toMillis() \n}\n\nreturn {\n  messages: [\n    ...cacheMessagesToArrayJSON, \n    userMsg\n  ]\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3600,3344],"id":"a3f5df3e-7e44-4e89-a83b-b12e2a600f89","name":"Junta mensagem do cache com a mensagem do usu√°rio"},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3216,3344],"id":"b152ad4c-b260-4607-a58f-db9cc01ff585","name":"SETA CACHE DAS MENSAGENS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3008,3344],"id":"bbd78cab-c1e3-4d77-8975-3355a5797611","name":"BUSCA MENSAGENS ACUMULADAS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($('Concatena mensagens para cache').first().json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3776,3776],"id":"fbfd7185-60e4-4333-a92d-2714867e1207","name":"RE-SETA CACHE DAS MENSAGENS ACUMULADAS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"check-question","leftValue":"={{ $json.output.hasQuestion }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[528,3312],"id":"a4b5d3a6-6c42-4ce0-b065-2e706646d9d3","name":"Tem D√∫vida?"},{"parameters":{"mode":"load","tableName":"n8","prompt":"={{ $('CONCATENA1').first().json.user_full_message }}","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[880,3056],"id":"513d1da3-48a6-4591-b2bd-4b45188d3b7e","name":"Consulta Base Conhecimento","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[880,3232],"id":"ca10a115-b9dc-4272-9f40-aecce6cb838d","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"jsCode":"return {\n  rag_context: $input.all().map(d => d.json.document.pageContent)\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1232,3056],"id":"612f63e5-d3b4-4e60-89cd-0c55d2ecd635","name":"RAG CONTEXT","executeOnce":true},{"parameters":{"jsCode":"return {\n  rag_context: $json.rag_context\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1504,3328],"id":"84b694d4-8676-4034-a103-ccf5f04499da","name":"MERGE DADOS"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":5,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').item.json.cache_key }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1200,3312],"id":"7466f742-b65f-413a-997f-b79463f0e820","name":"Pega ultimas mensagens","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-928,3312],"id":"a882932e-22d3-4b22-b1c1-c6827396490b","name":"Formata ultimas mensagens","executeOnce":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"CLOSING","operator":{"type":"string","operation":"equals"},"id":"732957f5-38a8-4204-ab63-9403f96c1a78"}],"combinator":"and"},"renameOutput":true,"outputKey":"closing"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1a022d7b-9866-445e-824d-ee7a7616d891","leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"CLOSING_WHEN_INVALID_OPTION","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"closing_when_invalid_option"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3807d7cc-18c1-470f-9689-a991e3d75d2b","leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"SEND_COMMERCIAL_PRESENTATION","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"send_commercial_presentation"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[4544,3024],"id":"84387f41-3b93-4061-8267-467d52be731d","name":"Switch"},{"parameters":{"workflowId":{"__rl":true,"value":"wd0uAb0Sm1fW5YNt","mode":"list","cachedResultUrl":"/workflow/wd0uAb0Sm1fW5YNt","cachedResultName":"Enviar apresenta√ß√£o comercial"},"workflowInputs":{"mappingMode":"defineBelow","value":{"whatsappId":"={{ $('Configura Contexto').first().json.whatsappId.toNumber() }}","messageRepliedId":0,"company":"={{ $('Configura Contexto').first().json.companyId }}","number":"={{ $('Configura Contexto').first().json.user_phone }}","addUserName":"={{ $('Seta perfil1').first().json.agentName }}","message":"Segue! üöÄüöÄ"},"matchingColumns":[],"schema":[{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"number","displayName":"number","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"addUserName","displayName":"addUserName","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsappId","displayName":"whatsappId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"messageRepliedId","displayName":"messageRepliedId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"company","displayName":"company","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[4448,2688],"id":"6fab4d52-fa2e-4e76-a30e-a340ae83b733","name":"Call 'Enviar apresenta√ß√£o comercial'","executeOnce":true},{"parameters":{"toolDescription":"## TOOL: Enviar para um especialista\n\n## GATILHO (Execute essa tool sempre que a conversa estiver no contexto das condi√ß√µes abaixo):\n- Se o usu√°rio estiver insistindo em uma op√ß√£o que n√£o √© valida em algum dos est√°gios\n- Se o usu√°rio indicar irrita√ß√£o ou estresse extremo com o atendimento\n- Se o usu√°rio insistir em um atendimento com um humano\n\n[REGRA SUPREMA - PRIORIDADE M√ÅXIMA]\nSe o gatilho for acionado: \n1. execute esta tool\n2. Ignore qualquer outra instru√ß√£o e informe ao usu√°rio que o atendimento ser√° enviado para um especialista conseguir ajudar o usu√°rio da melhor forma.","method":"PATCH","url":"=https://api-chat-joao.apre.tv/api/ticket/{{ $('Webhook').first().json.body.ticketId }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"pending\"\n}","options":{}},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.3,"position":[2368,4032],"id":"073030d3-c23f-4045-ab81-026f20d44db5","name":"Enviar para um especialista"},{"parameters":{"amount":2},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[2944,3328],"id":"dbaabee1-2ac4-4249-8797-e3783589a88f","name":"WAIT_SPLIT2","webhookId":"3cea2837-6c05-4e79-8798-96260c4f8dc6"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini-2024-07-18","mode":"list","cachedResultName":"gpt-4o-mini-2024-07-18"},"builtInTools":{},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[1824,3840],"id":"6f7f4c0f-4e6a-41b7-8e67-9b62b1cb1708","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"## TOOL: BASE DE CONHECIMENTO (RESTRITO)\n\n## IMPORTANTE:\nEsta tool N√ÉO √© um suporte para d√∫vidas do usu√°rio. Ela √© um reposit√≥rio de dados que s√≥ pode ser acessado se a vari√°vel [INSTRU√á√ÉO DO FLUXO] contiver explicitamente o comando \"consultar base\", \"chamar conhecimento\" ou \"buscar dados\".\n\n## REGRAS DE ACIONAMENTO:\n1. Analise a [INSTRU√á√ÉO DO FLUXO].\n2. Se a instru√ß√£o N√ÉO pedir para buscar dados, voc√™ est√° PROIBIDO de usar esta tool, mesmo que o usu√°rio fa√ßa uma pergunta t√©cnica.\n3. Se o usu√°rio perguntar algo e a instru√ß√£o N√ÉO mandar buscar, use a \"Carta de Seguran√ßa\" padr√£o do sistema.\n\n## PRIORIDADE:\nInstru√ß√£o do Fluxo > Pergunta do Usu√°rio.","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[2064,4032],"id":"b19fdc46-6c96-4079-ac1f-054935e26ec1","name":"Base de conhecimento","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[2016,4240],"id":"6ae2429d-b1e3-446f-815d-577bdc707350","name":"Embeddings OpenAI2","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('LOOP_SLIT1').first().json.message , \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[4784,3392],"id":"68faacdf-f7b0-4566-a5ef-ca773ba86d5f","name":"Insere mensagem da IA no BD","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"human\", \"content\": $('CONCATENA1').first().json.user_full_message , \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{"outputColumns":["id"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3600,3312],"id":"a6e3b286-5b4f-4185-9414-94c115784f24","name":"Insere mensagem do usu√°rio no BD","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4224,3328],"id":"be86d06d-b96e-45c1-8a63-8991b4c1d3fd","name":"GET3","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2dfab0a2-c614-429c-a13d-36ecb7803f12","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[4464,3376],"id":"ea373dc6-70c4-4f12-baa1-732e7ea31654","name":"Se n√£o recebeu mensagem no meio do processamento1","alwaysOutputData":false},{"parameters":{"operation":"get","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[5376,4048],"id":"6d3c47cc-869e-4485-be76-e6099e40657a","name":"Busca estado atual para follow-up","executeOnce":true,"credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"},{"column":"company_id","value":"={{ $('Configura Contexto').first().json.companyId }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[5584,4048],"id":"c54d2094-c650-4b44-b36e-3bb2e82457d0","name":"Busca Follow Up","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[5792,4048],"id":"3db72572-69b2-4190-a74a-29778c8f9d8c","name":"Se j√° existe follow-up"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up').item.json.id }}","last_instruction":"={{ `Pergunte: ${JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.description}` }}","last_var_requested":"={{ JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.name }}","follow_up_time":"={{ $now.plus(1, 'minutes') }}","attempts":0},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[6000,3952],"id":"a9ba2610-980f-4052-8b43-cb9f6efd5562","name":"Atualiza follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"company_id":"={{ $('Configura Contexto').first().json.companyId }}","session_id":"={{ $('Configura Contexto').first().json.cache_key }}","last_instruction":"={{ `Pergunte: ${JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.description}` }}","last_var_requested":"={{ JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.name }}","follow_up_time":"={{ $now.plus(1, 'minutes') }}","user_phone":"={{ $('Configura Contexto').first().json.user_phone }}","attempts":0,"whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","agent_name":"={{ $('Seta perfil1').first().json.agentName }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[6000,4144],"id":"dba2b291-3da6-425a-8890-886445f96e41","name":"Insere novo follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":1}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-4912,4528],"id":"d2cb6fa2-a445-437f-b103-6fb3dc8e60c7","name":"Cron 1em1 min - FOLLOW-UP"},{"parameters":{"operation":"executeQuery","query":"SELECT \n  * FROM follow_up_queue \nWHERE follow_up_time <= NOW()\nAND attempts < 2;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4688,4528],"id":"8f0fffad-cae2-4930-861a-6353cea9084f","name":"Busca follow-ups dispon√≠veis","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-4272,4528],"id":"8f466cf5-ea14-445d-9e92-7299fbbfc567","name":"LOOP nos follow-up's"},{"parameters":{"operation":"get","key":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3584,4656],"id":"952c8220-c42d-4df1-99a6-4be940dfa3f4","name":"Busca estado atual da conversa","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"mode":"raw","jsonOutput":"={{ $json.propertyName }}","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3344,4656],"id":"61b2bb84-fd12-42f6-bd23-5c0cfe10ef97","name":"Transforma estado atual em JSON literal"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"277c3ae6-bdd3-4743-aa6d-9181d4e3f217","leftValue":"={{ $json.vars[$('LOOP nos follow-up\\'s').first().json.last_var_requested]?.value?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3120,4656],"id":"3ac53cb0-33ea-4a0f-9ff0-cec62aaac9bd","name":"Se o usu√°rio respondeu a vari√°vel pendente no meio do caminho"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('LOOP nos follow-up\\'s').first().json.id }}","attempts":"={{ $('LOOP nos follow-up\\'s').first().json.attempts + 1 }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1360,4784],"id":"d203fff1-dea3-41cc-9e9b-90d42d0b6cc6","name":"Update rows in a table","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"content":"# FAZ FOLLOW-UP\n\n","height":640,"width":4048},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4944,4400],"id":"fd151bd6-83c9-422f-a9a8-309b8bfa7d51","name":"Sticky Note"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini-2024-07-18","mode":"list","cachedResultName":"GPT-4O-MINI-2024-07-18"},"responses":{"values":[{"role":"system","content":"=**SISTEMA:** Voc√™ √© um humano retomando um papo que esfriou. Use tom \"business casual\". Sem formalidade. Sem exclama√ß√µes.\n\n**REGRAS DE DIAMANTE**\n - N√£o valide a √∫ltima mensagem do usu√°rio, v√° direto ao ponto.\n - Varie a forma como voc√™ chama o usu√°rio para retomar a conversa.\n\n**ALGORITMO DE COMPOSI√á√ÉO:**\n1. **IDENTIDADE:**\n   - Se [NOME] existir: Comece com \"[NOME], ...\"\n   - Se [NOME] for vazio/null: Comece com \"Oi, tudo bem?\" ou \"Oi, tudo certo por a√≠?\".\n2. **PONTE DE CONEX√ÉO:** Use express√µes de continuidade como \"acabei n√£o pegando\", \"ficou faltando voc√™ me falar\" ou \"queria confirmar um detalhe\".\n3. **TRADUTOR DE COMANDO:** Pegue o texto ap√≥s \"Pergunte sobre:\" e transforme em algo emp√°tico e informal. \n   - *Exemplo:* \"Pergunte sobre: Nome\" -> \"Oi, tudo bem? Voc√™ ficou de me falar seu nome, como posso te chamar?\"\n\n---\n\n**DADOS:**\n- **NOME_USUARIO:** {{ $json.vars.name || \"\" }}\n- **COMANDO:** {{ $('LOOP nos follow-up\\'s').first().json.last_instruction }}\n- **HIST√ìRICO DE CONVERSA:** \n{{ $('Formata ultimas mensagens1').item.json.historyMessages }}\n---\n\n**REGRAS R√çGIDAS:**\n- **PROIBIDO:** \"Lead\", \"Pendente\", \"Informa√ß√£o\", \"Sistema\", \"Pergunte sobre\".\n- **LIMITE:** M√°ximo 20 palavras.\n- **PONTUA√á√ÉO:** √â terminantemente proibido o uso de exclama√ß√µes (!). \n- **FINALIZA√á√ÉO:** Termine obrigatoriamente com a interroga√ß√£o da pergunta.\n\n**SA√çDA FINAL (TEXTO PURO):**"}]},"builtInTools":{},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2,"position":[-2000,4784],"id":"265cb3af-29ac-459a-a81f-f882ab728704","name":"Gera mensagem de follow-up","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('LOOP nos follow-up\\'s').first().json.company_id }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output[0].content[0].text }}"},{"name":"number","value":"={{ $('LOOP nos follow-up\\'s').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('LOOP nos follow-up\\'s').first().json.whatsapp_id }}"},{"name":"addUserName","value":"={{ $('LOOP nos follow-up\\'s').first().json.agent_name }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1616,4784],"id":"dba8fe7b-5e5c-4fb7-9936-c2b87a2e2e28","name":"Envia via Apre.Chat"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":5,"where":{"values":[{"column":"session_id","value":"={{ $('LOOP nos follow-up\\'s').item.json.session_id }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2864,4800],"id":"768756d6-6e72-47ec-ba59-5b14c00a0f7e","name":"Pega ultimas mensagens1","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2624,4800],"id":"1a178063-f427-47e9-85ad-b70e524f6e5d","name":"Formata ultimas mensagens1","executeOnce":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4c3ea394-ce4c-441d-818d-2f1278d63264","leftValue":"={{ $('Pega ultimas mensagens1').first().json.message.type }}","rightValue":"ai","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2336,4800],"id":"e14b1744-ead3-486e-a913-e930d4bdfc4e","name":"If"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\":  $('Gera mensagem de follow-up').item.json.output[0].content[0].text, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1120,4784],"id":"a59ba9f9-47b3-4997-923b-f14a0743570d","name":"Insere mensagem da IA no BD1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3280,3024],"id":"c04ca390-7134-4bea-a8b9-2f0f5888ad75","name":"Remove follow-ups","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $json.session_id }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3984,4544],"id":"fe2a74fa-4460-4254-b55c-1c4f6c5a85fa","name":"BUSCA MENSAGENS ACUMULADAS1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"431557d8-7fd4-46ed-951f-464868b21a82","leftValue":"={{ $json.messages?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3776,4544],"id":"25dafc46-93fe-46c5-90d5-a508806aa3f1","name":"Se chegou alguma mensagem do usu√°rio"},{"parameters":{"amount":2},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-4480,4528],"id":"65c23647-fb2a-4584-9a45-053cc71e46ab","name":"Wait","webhookId":"d1e38aad-57ac-45e5-b64a-08e2f1ce1a6f"}],"connections":{"Se n√£o recebeu mensagem no meio do processamento":{"main":[[{"node":"Insere mensagem do usu√°rio no BD","type":"main","index":0}],[{"node":"Concatena mensagens para cache","type":"main","index":0}]]},"GET2":{"main":[[{"node":"Se n√£o recebeu mensagem no meio do processamento","type":"main","index":0}]]},"Salva Novo Estado":{"main":[[{"node":"Router de D√∫vida","type":"main","index":0}]]},"Parser  Chain1":{"main":[[{"node":"WAIT_SPLIT2","type":"main","index":0}]]},"OutputParser":{"ai_outputParser":[[{"node":"Parser  Chain1","type":"ai_outputParser","index":0}]]},"OpenAI":{"ai_languageModel":[[{"node":"Parser  Chain1","type":"ai_languageModel","index":0}]]},"output1":{"main":[[{"node":"Parser  Chain1","type":"main","index":0}]]},"Split de mensagens":{"main":[[{"node":"LOOP_SLIT1","type":"main","index":0}]]},"WAIT_SPLIT1":{"main":[[{"node":"LOOP_SLIT1","type":"main","index":0}]]},"LOOP_SLIT1":{"main":[[{"node":"Switch","type":"main","index":0},{"node":"Busca estado atual para follow-up","type":"main","index":0}],[{"node":"GET3","type":"main","index":0}]]},"Envia WhatsApp1":{"main":[[{"node":"WAIT_SPLIT1","type":"main","index":0}]]},"Seta perfil1":{"main":[[{"node":"Gerador de Resposta","type":"main","index":0}]]},"Parser Router":{"ai_outputParser":[[{"node":"Router de D√∫vida","type":"ai_outputParser","index":0}]]},"OpenAI Router":{"ai_languageModel":[[{"node":"Router de D√∫vida","type":"ai_languageModel","index":0}]]},"Router de D√∫vida":{"main":[[{"node":"Tem D√∫vida?","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Configura Contexto","type":"main","index":0}]]},"GET Estado Atual":{"main":[[{"node":"BLUEPRINT ENGINE","type":"main","index":0}]]},"BLUEPRINT ENGINE":{"main":[[{"node":"Pega ultimas mensagens","type":"main","index":0}]]},"Extrator Inteligente":{"main":[[{"node":"LOGIC ENGINE","type":"main","index":0}]]},"DeepSeek Model":{"ai_languageModel":[[{"node":"Extrator Inteligente","type":"ai_languageModel","index":0}]]},"LOGIC ENGINE":{"main":[[{"node":"Salva Novo Estado","type":"main","index":0}]]},"Gerador de Resposta":{"main":[[{"node":"output1","type":"main","index":0}]]},"CONCATENA1":{"main":[[{"node":"GET Estado Atual","type":"main","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"Extrator Inteligente","type":"ai_outputParser","index":0}]]},"Wait1":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"DELETE1":{"main":[[{"node":"CONCATENA1","type":"main","index":0}]]},"SWITCH_BUFFER":{"main":[[{"node":"DELETE1","type":"main","index":0}],[{"node":"NADA1","type":"main","index":0}],[{"node":"Wait1","type":"main","index":0}]]},"Configura Contexto":{"main":[[{"node":"If2","type":"main","index":0}]]},"If2":{"main":[[{"node":"Deleta estado atual","type":"main","index":0}],[{"node":"Busca mensagens no cache","type":"main","index":0}]]},"Deleta estado atual":{"main":[[{"node":"Delete table or rows1","type":"main","index":0}]]},"Delete table or rows1":{"main":[[{"node":"DELETE2","type":"main","index":0}]]},"Concatena mensagens para cache":{"main":[[{"node":"RE-SETA CACHE DAS MENSAGENS ACUMULADAS","type":"main","index":0}]]},"Transforma em objeto literal":{"main":[[{"node":"SWITCH_BUFFER","type":"main","index":0}]]},"Formata hist√≥rico1":{"main":[[{"node":"Gera resumo da conversa - AI1","type":"main","index":0}]]},"Gera resumo da conversa - AI1":{"main":[[{"node":"Salva nota na conversa1","type":"main","index":0}]]},"DeepSeek Chat Model2":{"ai_languageModel":[[{"node":"Gera resumo da conversa - AI1","type":"ai_languageModel","index":0}]]},"Busca hist√≥rico de conversa1":{"main":[[{"node":"Formata hist√≥rico1","type":"main","index":0}]]},"Transfere ticket para Aguardando Apre.Chat":{"main":[[{"node":"Busca hist√≥rico de conversa1","type":"main","index":0}]]},"Busca mensagens no cache":{"main":[[{"node":"Junta mensagem do cache com a mensagem do usu√°rio","type":"main","index":0}]]},"Junta mensagem do cache com a mensagem do usu√°rio":{"main":[[{"node":"SETA CACHE DAS MENSAGENS","type":"main","index":0}]]},"SETA CACHE DAS MENSAGENS":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"BUSCA MENSAGENS ACUMULADAS":{"main":[[{"node":"Transforma em objeto literal","type":"main","index":0}]]},"Tem D√∫vida?":{"main":[[{"node":"Consulta Base Conhecimento","type":"main","index":0}],[{"node":"MERGE DADOS","type":"main","index":0}]]},"Consulta Base Conhecimento":{"main":[[{"node":"RAG CONTEXT","type":"main","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Consulta Base Conhecimento","type":"ai_embedding","index":0}]]},"RAG CONTEXT":{"main":[[{"node":"MERGE DADOS","type":"main","index":0}]]},"MERGE DADOS":{"main":[[{"node":"Seta perfil1","type":"main","index":0}]]},"Pega ultimas mensagens":{"main":[[{"node":"Formata ultimas mensagens","type":"main","index":0}]]},"Formata ultimas mensagens":{"main":[[{"node":"Extrator Inteligente","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Transfere ticket para Aguardando Apre.Chat","type":"main","index":0}],[{"node":"Transfere ticket para Aguardando Apre.Chat","type":"main","index":0}],[{"node":"Call 'Enviar apresenta√ß√£o comercial'","type":"main","index":0}]]},"Call 'Enviar apresenta√ß√£o comercial'":{"main":[[{"node":"Transfere ticket para Aguardando Apre.Chat","type":"main","index":0}]]},"Enviar para um especialista":{"ai_tool":[[{"node":"Gerador de Resposta","type":"ai_tool","index":0}]]},"WAIT_SPLIT2":{"main":[[{"node":"GET2","type":"main","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"Gerador de Resposta","type":"ai_languageModel","index":0}]]},"Base de conhecimento":{"ai_tool":[[{"node":"Gerador de Resposta","type":"ai_tool","index":0}]]},"Embeddings OpenAI2":{"ai_embedding":[[{"node":"Base de conhecimento","type":"ai_embedding","index":0}]]},"Insere mensagem da IA no BD":{"main":[[{"node":"Envia WhatsApp1","type":"main","index":0}]]},"Insere mensagem do usu√°rio no BD":{"main":[[{"node":"Split de mensagens","type":"main","index":0}]]},"GET3":{"main":[[{"node":"Se n√£o recebeu mensagem no meio do processamento1","type":"main","index":0}]]},"Se n√£o recebeu mensagem no meio do processamento1":{"main":[[{"node":"Insere mensagem da IA no BD","type":"main","index":0}],[]]},"Salva nota na conversa1":{"main":[[]]},"Busca estado atual para follow-up":{"main":[[{"node":"Busca Follow Up","type":"main","index":0}]]},"Busca Follow Up":{"main":[[{"node":"Se j√° existe follow-up","type":"main","index":0}]]},"Se j√° existe follow-up":{"main":[[{"node":"Atualiza follow-up","type":"main","index":0}],[{"node":"Insere novo follow-up","type":"main","index":0}]]},"Cron 1em1 min - FOLLOW-UP":{"main":[[{"node":"Busca follow-ups dispon√≠veis","type":"main","index":0}]]},"Busca follow-ups dispon√≠veis":{"main":[[{"node":"Wait","type":"main","index":0}]]},"LOOP nos follow-up's":{"main":[[],[{"node":"BUSCA MENSAGENS ACUMULADAS1","type":"main","index":0}]]},"Busca estado atual da conversa":{"main":[[{"node":"Transforma estado atual em JSON literal","type":"main","index":0}]]},"Transforma estado atual em JSON literal":{"main":[[{"node":"Se o usu√°rio respondeu a vari√°vel pendente no meio do caminho","type":"main","index":0}]]},"Se o usu√°rio respondeu a vari√°vel pendente no meio do caminho":{"main":[[],[{"node":"Pega ultimas mensagens1","type":"main","index":0}]]},"Gera mensagem de follow-up":{"main":[[{"node":"Envia via Apre.Chat","type":"main","index":0}]]},"Envia via Apre.Chat":{"main":[[{"node":"Update rows in a table","type":"main","index":0}]]},"Pega ultimas mensagens1":{"main":[[{"node":"Formata ultimas mensagens1","type":"main","index":0}]]},"Formata ultimas mensagens1":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Gera mensagem de follow-up","type":"main","index":0}]]},"Update rows in a table":{"main":[[{"node":"Insere mensagem da IA no BD1","type":"main","index":0}]]},"DELETE2":{"main":[[{"node":"Remove follow-ups","type":"main","index":0}]]},"BUSCA MENSAGENS ACUMULADAS1":{"main":[[{"node":"Se chegou alguma mensagem do usu√°rio","type":"main","index":0}]]},"Se chegou alguma mensagem do usu√°rio":{"main":[[],[{"node":"Busca estado atual da conversa","type":"main","index":0}]]},"Wait":{"main":[[{"node":"LOOP nos follow-up's","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Cron 1em1 min":{"recurrenceRules":[]},"node:Cron 1em1 min - FOLLOW-UP":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n.apresenta.me","x-real-ip":"172.68.191.166","x-real-port":"20298","x-forwarded-for":"177.136.163.95, 172.68.191.166","x-forwarded-proto":"http","x-forwarded-host":"n8n.apresenta.me","x-forwarded-port":"80","remote-host":"172.68.191.166","connection":"close","content-length":"711","accept":"application/json, text/plain, */*","accept-encoding":"gzip, br","user-agent":"axios/1.12.2","cf-ray":"9c420c043e58dcd8-NVT","content-type":"application/json","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"177.136.163.95","cf-ipcountry":"BR","cf-visitor":"{\"scheme\":\"https\"}"},"params":{},"query":{},"body":{"message":"sem compromisso","messageId":"2584080","contact":{"id":"38043","name":"554788950332","number":"554788950332","profilePicUrl":"https://pps.whatsapp.net/v/t61.24694-24/425105449_1361615211300388_1143514098522857072_n.jpg?ccb=11-4&oh=01_Q5Aa3gGQY5jctPvqj3-vvy70u7m2mxcV6cGVNnnDkpL57zZJMg&oe=6984BA63&_nc_sid=5e03e0&_nc_cat=102","createdAt":"2025-10-09T16:20:11.311-03:00","updatedAt":"2026-01-26T15:24:23.236-03:00","email":"","isGroup":false,"companyId":"5005","whatsappId":"4","onlyResponsible":false,"userId":"1","aprePersonId":"4916708","apreDealId":null,"blocked":false,"meta":{"ignoreCheck":true,"ignorePermission":true,"dontSendSocket":false}},"whatsappId":"4","companyId":5005,"ticketId":87998},"webhookUrl":"https://n8n.apresenta.me/webhook/7223c6af-f595-4bc2-b84c-602b8900cd08","executionMode":"production"}}],"Cron 1em1 min - FOLLOW-UP":[{"json":{"timestamp":"2026-01-27T10:26:03.003-03:00","Readable date":"January 27th 2026, 10:26:03 am","Readable time":"10:26:03 am","Day of week":"Tuesday","Year":"2026","Month":"January","Day of month":"27","Hour":"10","Minute":"26","Second":"03","Timezone":"America/Sao_Paulo (UTC-03:00)"}}]},"versionId":"b6950258-52ef-4f08-b066-89752e531d00","triggerCount":2,"shared":[{"updatedAt":"2025-11-04T18:47:16.654Z","createdAt":"2025-11-04T18:47:16.654Z","role":"workflow:owner","workflowId":"dDaZdsSmHxktrhjc","projectId":"4ToGMYJEWvvDSbcz"}],"tags":[]}