{"updatedAt":"2026-02-12T14:56:47.000Z","createdAt":"2025-11-04T18:47:16.651Z","id":"dDaZdsSmHxktrhjc","name":"üó£Ô∏è Apr.SDR IA","active":true,"isArchived":false,"nodes":[{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"thinking\": {\n        \"type\": \"string\", \n        \"description\": \"Racioc√≠nio para gerar o output final.\"\n    },\n    \"isFollowUp\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se o usu√°rio demonstrou indisponibilidade imediata e solicitou um novo contato (ex: 'agora n√£o posso', 'me chama depois').\"\n    },\n    \"requiresClarification\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se o usu√°rio N√ÉO especificou um hor√°rio ou prazo (ex: 'me chama outra hora'), exigindo que a IA pergunte o melhor momento.\"\n    },\n    \"timeExpression\": {\n      \"type\": \"string | null\",\n      \"description\": \"Express√£o da data solicitada pelo usu√°rio para utilizar com a biblioteca chrono-node (Node.js).\"\n    },\n    \"replyMessage\": {\n      \"type\": \"string\",\n      \"description\": \"Mensagem humanizada e business casual para o WhatsApp, confirmando o hor√°rio ou perguntando quando retornar, sem usar exclama√ß√µes.\"\n    },\n    \"isPassiveConfirmation\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica que o usu√°rio apenas confirmou passivamente (ex: 'blz', 'ok', 'fechou') uma mensagem anterior de agendamento, e a conversa deve ser encerrada com uma despedida educada.\"\n    }\n  },\n  \"required\": [\"isFollowUp\", \"requiresClarification\", \"timeExpression\", \"replyMessage\", \"isPassiveConfirmation\"]\n}\n"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-17680,3744],"id":"7e4230d0-df55-4928-a760-13b90e36ada0","name":"Parser Router1","disabled":true},{"parameters":{"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[-17872,3744],"id":"647d3e8a-7402-4f18-9822-0901d6bb2761","name":"OpenAI Router1","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}},"disabled":true},{"parameters":{"promptType":"define","text":"=### [DADOS DE CONTEXTO]\n- **MENSAGEM ATUAL:** \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n- **HIST√ìRICO RECENTE (DA MENSAGEM MAIS ANTIGA PARA A MAIS RECENTE):** {{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"Sem hist√≥rico.\" }}\n- **DATA/HORA ATUAL (ISO):** \"{{ $now }}\"\n- **DATA/HORA ATUAL (Por extenso):** {{ $now.setLocale('pt-BR').toFormat(\"cccc, dd 'de' LLLL 'de' yyyy ', ' HH:mm\") }}","hasOutputParser":true,"options":{"systemMessage":"=# SYSTEM: Sensor de Disponibilidade e Agendamento (Micro-Agente)\n\nVoc√™ √© um m√≥dulo de intelig√™ncia focado EXCLUSIVAMENTE em analisar se o usu√°rio pode conversar AGORA ou se precisa agendar para DEPOIS.\n\n### [ENTRADAS]\n- **MENSAGEM_ATUAL:** A frase que o usu√°rio acabou de enviar. (FONTE DA VERDADE SUPREMA).\n- **HIST√ìRICO:** O contexto anterior. (USAR APENAS SE NECESS√ÅRIO).\n- **DATA_HOJE:** Use para c√°lculos relativos (hoje, amanh√£).\n\n---\n\n### [HIERARQUIA DE DECIS√ÉO - SIGA NA ORDEM EXATA]\n\n**PASSO 1: DETEC√á√ÉO DE DISPONIBILIDADE IMEDIATA (O \"Agora\")**\n- **PERGUNTA CR√çTICA:** A `MENSAGEM_ATUAL` indica que o usu√°rio quer ou pode conversar **neste exato momento**?\n- **GATILHOS POSITIVOS:** \"Estou livre\", \"Pode falar\", \"Manda\", \"Diga\", \"Opa\" (in√≠cio de conversa), \"Consegui tempo\", \"Cancelaram a reuni√£o\", \"Sim\" (se a IA perguntou 'pode falar agora?'), \"Estou\".\n- **A√á√ÉO IMEDIATA (Se Positivo):**\n    - `isFollowUp`: **FALSE** (O fluxo segue agora).\n    - `timeExpression`: **NULL** (N√£o h√° agendamento futuro).\n    - `replyMessage`: **\"\"** (String vazia).\n    - **PARE O RACIOC√çNIO.** N√£o execute os passos 2 e 3.\n\n**PASSO 2: DETEC√á√ÉO DE AGENDAMENTO OU INDISPONIBILIDADE (O \"Depois\")**\n- **PERGUNTA CR√çTICA:** A `MENSAGEM_ATUAL` indica que o usu√°rio **N√ÉO** pode falar agora ou sugeriu um hor√°rio **FUTURO**?\n- **SUB-PASSO 2.A (Com Data Definida):** A mensagem cont√©m tempo expl√≠cito (ex: \"Me chama amanh√£\", \"Daqui 10 min\", \"Estarei livre √†s 14h\")?\n    - `isFollowUp`: **TRUE** (Vai para a fila de agendamento).\n    - `timeExpression`: Traduza para INGL√äS (ex: \"tomorrow at 14:00\", \"in 10 minutes\").\n    - `replyMessage`: \"Combinado! Te chamo [repetir a data em PT-BR].\"\n    - `requiresClarification`: **FALSE**.\n- **SUB-PASSO 2.B (Sem Data Definida):** O usu√°rio disse apenas que est√° ocupado (ex: \"Agora n√£o\", \"T√¥ em reuni√£o\", \"Me chama depois\") mas **N√ÉO** disse quando?\n    - `isFollowUp`: **TRUE**.\n    - `timeExpression`: **NULL**.\n    - `replyMessage`: \"Tudo bem! Quando fica melhor para eu te chamar novamente, ent√£o?\"\n    - `requiresClarification`: **TRUE**.\n\n**PASSO 3: DETEC√á√ÉO DE ENCERRAMENTO (O \"Tchau\")**\n- **CONTEXTO:** S√≥ execute se a mensagem for curta/passiva (\"Ok\", \"Blz\", \"Vlw\", \"Tchau\").\n- **REGRA DE PROXIMIDADE:** Olhe EXCLUSIVAMENTE para a **√öLTIMA** mensagem da IA no hist√≥rico.\n    - A IA acabou de dizer \"Te chamo amanh√£\" (Agendamento)? -> `isPassiveConfirmation`: **TRUE**. Responda: \"At√© mais!\".\n    - A IA acabou de fazer uma pergunta (\"Pode falar?\", \"Qual seu cargo?\")? -> `isPassiveConfirmation`: **FALSE**. Responda: \"\" (Deixe o fluxo seguir).\n\n---\n\n### [DIRETRIZES T√âCNICAS (CHRONO-NODE)]\nSe cair no **PASSO 2.A**, siga estas regras de tradu√ß√£o para `timeExpression`:\n- **Futuro Pr√≥ximo:** \"Daqui a pouco\" -> \"in 1 hour\".\n- **Relativos:** \"Amanh√£ de manh√£\" -> \"tomorrow morning\" (09:00).\n- **Verbos de Futuro:** Se o usu√°rio diz \"Estarei livre amanh√£\", isso √© PASSO 2 (Agendamento), pois ele N√ÉO est√° livre agora.\n- **L√≠ngua:** O output deve ser estritamente em **INGL√äS**.\n\n### [REGRAS DE OURO - ANTI-ALUCINA√á√ÉO]\n1. **SUPREMACIA DO PRESENTE:** Se o hist√≥rico diz \"n√£o posso\" mas a MENSAGEM_ATUAL diz \"Estou livre\", obede√ßa o \"Estou livre\".\n2. **N√ÉO INVENTE AGENDAMENTOS:** Se caiu no Passo 1 (Dispon√≠vel Agora), `timeExpression` DEVE ser NULL.\n3. **INDISPONIBILIDADE:** `isFollowUp = TRUE` significa **exclusivamente** que a conversa deve parar agora e voltar depois.\n\n---\n\n### [SA√çDA OBRIGAT√ìRIA - JSON PURO]\n{\n  \"thinking\": \"string: 1. Cite a mensagem atual. 2. Diga qual PASSO (1, 2A, 2B ou 3) foi ativado e por qu√™.\",\n  \"isFollowUp\": boolean,\n  \"requiresClarification\": boolean,\n  \"timeExpression\": \"string (EN) ou null\",\n  \"replyMessage\": \"string (PT-BR)\",\n  \"isPassiveConfirmation\": boolean\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-17856,3536],"id":"8a6de74e-fe37-4ca3-ac42-747d28111b08","name":"Follow-up Router","executeOnce":true,"disabled":true,"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3ca2cf42-2ab9-4010-945a-17b777fb4dc5","leftValue":"={{ $json.output.isFollowUp }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-17424,3856],"id":"dd5df012-8ee1-4b69-bf7e-e195503973ec","name":"Se o usu√°rio est√° tentando agendar uma re-chamada","disabled":true},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Follow-up Router').first().json.output.replyMessage }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-16208,4400],"id":"1f4631ef-63df-4198-8f57-267424f1d100","name":"Envia WhatsApp","disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('Follow-up Router').first().json.output.replyMessage, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-16432,4400],"id":"8fdf2d0e-f17f-425f-a56a-8ef9b2816594","name":"Insere mensagem da IA no BD2","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2d7ee4c-540b-4d38-8d33-c149ced59489","leftValue":"={{ $('Follow-up Router').first().json.output.timeExpression?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-16000,4400],"id":"aa78c4fc-09c8-4371-ba2c-ee8484c45839","name":"Se o usu√°rio informou uma data de re-chamada","disabled":true},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"},{"column":"company_id","value":"={{ $('Configura Contexto').first().json.companyId }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-17168,4384],"id":"eb810c29-7a54-4886-b982-5236489274bf","name":"Busca Follow Up1","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up1').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-16912,4384],"id":"183c63fa-4303-4856-b9b4-161f94d6b2e1","name":"Se j√° existe follow-up2","disabled":true},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up1').first().json.id }}","follow_up_time":"={{ $('Envia para parser com o chrono-node').first().json.parsedDate }}","last_instruction":"={{ `Pergunte se o usu√°rio pode retomar a conversa.` }}","active":"={{ true }}","follow_up_type":"requested","attempts":0},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":false},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-15040,4160],"id":"7fa81d96-a712-4ad5-8658-15e2bc77716d","name":"Atualiza follow-up1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"company_id":"={{ $('Configura Contexto').first().json.companyId }}","session_id":"={{ $('Configura Contexto').first().json.cache_key }}","last_instruction":"={{ `Pergunte se o usu√°rio pode retomar a conversa.` }}","follow_up_time":"={{ $('Envia para parser com o chrono-node').first().json.parsedDate }}","user_phone":"={{ $('Configura Contexto').first().json.user_phone }}","active":"={{ true }}","whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","follow_up_type":"requested","agent_name":"={{ $('Seta perfil1').first().json.agentName }}","attempts":0},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-15040,4368],"id":"0f328589-21fc-4356-b03d-f8044e555b8c","name":"Insere novo follow-up1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up1').first().json.id }}","active":"={{ false }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-16672,4240],"id":"3a566b18-8fa4-4b19-97f7-0ae3f80a7490","name":"Desativa follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up1').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-15376,4272],"id":"5c5d1059-6e14-4f1b-b1fb-50b130aa6fdc","name":"Se j√° existe follow-up3","disabled":true},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/chrono-node/parser","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\ntimeExpression: $('Follow-up Router').first().json.output.timeExpression\n}) }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-15664,4272],"id":"c68745e6-aa07-4c64-9082-bd5657a5356a","name":"Envia para parser com o chrono-node","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"27a3e6f0-e2d1-4226-9c90-4a4ae9df03c7","leftValue":"={{ $json.output.isPassiveConfirmation }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-17104,3856],"id":"357846d3-ffb0-4827-b5a5-b97e6ecd07c9","name":"Se for uma confirma√ß√£o passiva","disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('Follow-up Router').first().json.output.replyMessage, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-16368,3632],"id":"3a19df40-b688-4c32-ba05-4883ade8a3aa","name":"Insere mensagem da IA no BD3","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Follow-up Router').first().json.output.replyMessage }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-16160,3632],"id":"33e3df92-009a-4a55-899b-ec285679b75c","name":"Envia WhatsApp2","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9973e414-7551-4bd0-941e-04f86c3516c9","leftValue":"={{ $json.output.replyMessage?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-16896,3760],"id":"0bc43a79-413a-4e80-9527-cb9894551e6b","name":"Se existe resposta","disabled":true},{"parameters":{"promptType":"define","text":"=### [PAINEL DE CONTROLE - PLANNER L√ìGICO]\n\n### REGRAS DE EXECU√á√ÉO (ESTRITAS)\nVoc√™ √© um motor de l√≥gica puro. Sua sa√≠da deve ser EXCLUSIVAMENTE as tags [FLAG], [FACT] e [NEXT]. Est√° proibido gerar explica√ß√µes, an√°lises ou passos. \n\n### CONTEXTO DO USU√ÅRIO\nMsg: \"{{ $('CONCATENA1').first().json.user_full_message }}\"\nHist√≥rico Recente: \"{{ $('Formata ultimas mensagens').first().json.historyMessages ? $('Formata ultimas mensagens').first().json.historyMessages : 'VAZIO' }}\"\n\n### DADOS T√âCNICOS (RAG)\n\"{{ $('MERGE DADOS').first().json.rag_context ? $('MERGE DADOS').first().json.rag_context.join('\\n') : 'Nenhuma informa√ß√£o t√©cnica encontrada.' }}\"\n\n### MISS√ÉO DE CLASSIFICA√á√ÉO\n\n1. **DEFINIR [FACT]:**\n   - **TIPO A (Social/Vazio):** [FACT] VAZIO.\n   - **TIPO B (Curiosidade Geral):** Resumo de 2 frases do RAG no [FACT].\n   - **TIPO C (D√∫vida Espec√≠fica):** Teste de correspond√™ncia EXATA com o RAG. \n     - Se o RAG responde exatamente: Copie a resposta crua para [FACT].\n     - Se o RAG N√ÉO menciona o termo explicitamente (ex: \"teste gr√°tis\"): **[FACT]: NEEDS_SPECIALIST**.\n\n2. **DEFINIR [FLAG]:**\n   - Hist√≥rico != 'VAZIO' -> [FLAG]: SKIP_INTRO\n   - Hist√≥rico == 'VAZIO' -> [FLAG]: ALLOW_INTRO\n\n3. **DEFINIR [NEXT] (FILTRO DE REDUND√ÇNCIA E COLETA):**\n   - Use a Instru√ß√£o Obrigat√≥ria: \"{{ $('LOGIC ENGINE').first().json.finalInstruction }}\"\n   - **PASSO A (Papagaio):** Se a IA j√° se apresentou ou j√° deu o pitch do sistema no hist√≥rico, REMOVA a explica√ß√£o do [NEXT].\n   - **PASSO B (Ouvido/Valida√ß√£o):** Verifique se o dado solicitado no [NEXT] (ex: nome) j√° foi entregue pelo usu√°rio.\n     - **J√° respondeu o dado?** Altere o [NEXT] para: \"Perfeito, vamos seguir com a sua d√∫vida.\"\n     - **N√ÉO respondeu o dado?** Mantenha apenas a pergunta direta (ex: \"Qual o seu nome?\"). N√ÉO invente justificativas ou promessas n√£o contidas no RAG.\n\n### OUTPUT OBRIGAT√ìRIO\n[FLAG]: ...\n[FACT]: ...\n[NEXT]: ...","options":{"systemMessage":"Voc√™ √© o Planner. Seja seco. Sua fun√ß√£o √© garantir que a resposta t√©cnica esteja correta e que o fluxo seja seguido. N√£o tente ser simp√°tico.\nVoc√™ n√£o repete mensagens.\nVoc√™ utiliza o contexto t√©cnico (RAG) para explicar de forma generalista sobre o produto."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-14352,3600],"id":"95fa2a80-a594-4a6a-812a-244534d5d3a7","name":"Planner de Conte√∫do (L√≥gico)"},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"## TOOL: BASE DE CONHECIMENTO\nUse APENAS se o usu√°rio fizer uma pergunta t√©cnica.","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[-14320,4048],"id":"6344be42-bc3b-4365-929e-d788e9289bed","name":"Base de conhecimento1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-14368,4256],"id":"18f148cb-cd1c-43d6-bd3e-b76617c84484","name":"Embeddings OpenAI3","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"=### INSTRU√á√ïES DO PLANNER:\n{{ $json.output }}\n\n### REGRAS DE CONEX√ÉO (A COLA DA CONVERSA):\nVoc√™ deve transformar o rascunho rob√≥tico do Planner em uma conversa fluida. \n\n**O GRANDE ERRO A EVITAR:**\nNUNCA fa√ßa isso: \"O sistema faz X e Y. Qual seu nome?\" (Isso √© rob√≥tico).\n\n**O JEITO CERTO (T√©cnica do Piv√¥):**\n\"O sistema faz X e Y, o que agiliza muito o dia a dia! Mas antes de continuarmos, com quem eu falo?\" \n\n### REGRAS DE EXECU√á√ÉO (FOCO EM NATURALIDADE)\n1. COMPORTAMENTO DE DI√ÅLOGO: Responda diretamente ao usu√°rio. √â proibido usar frases de \"narrador\" como \"Notei que voc√™ perguntou\" ou \"Vi que voc√™ enviou\". \n2. A T√âCNICA DO PIV√î: Transforme a resposta t√©cnica em uma oportunidade de avan√ßo. O conte√∫do do campo [FACT] deve servir de gancho natural para a a√ß√£o solicitada no [NEXT].\n3. AGNOSTICISMO: N√£o assuma nomes de empresas ou produtos fixos. Utilize estritamente as informa√ß√µes fornecidas nos campos [FACT] e [NEXT] para dar contexto √† sua fala.\n\n### DIRETRIZES (Siga na ordem):\n0. **BLOQUEIO DE ALUCINA√á√ÉO (NEEDS_SPECIALIST):** Verifique o campo [FACT]. Se estiver escrito \"NEEDS_SPECIALIST\", voc√™ est√° **PROIBIDA** de responder a d√∫vida do usu√°rio com seu conhecimento pr√≥prio.\n   - **A√á√ÉO OBRIGAT√ìRIA:** Diga EXATAMENTE: \"Sobre [ASSUNTO QUESTIONADO PELO USU√ÅRIO], prefiro confirmar com um especialista pra n√£o te passar informa√ß√£o errada, t√°?\".\n   - Ap√≥s essa frase, pule direto para a diretriz 3 (Piv√¥).\n\n1. **VALIDA√á√ÉO:** Se [FACT] contiver texto t√©cnico real, explique de forma simples e termine com um mini-coment√°rio de benef√≠cio.\n\n2. **EXECU√á√ÉO RIGOROSA DO [NEXT]:** O texto em [NEXT] √© o seu roteiro. Reescreva-o com seu tom.\n   - Se o [NEXT] mandar perguntar algo (ex: nome), pergunte.\n   - Se o [NEXT] j√° tiver o dado (ex: \"[Jo√£o]\"), use o dado.\n\n3. **PIV√î:** Use conectores para mudar de assunto suavemente: \"A prop√≥sito...\", \"Ali√°s...\", \"Pra gente seguir...\", \"Antes de eu te explicar mais...\"\n\n4. **FLAG SKIP_INTRO:** Se o planner disser SKIP_INTRO, n√£o diga \"Oi\" nem se apresente novamente.\n\n5. **FLAG ALLOW_INTRO:** Se o planner disser ALLOW_INTRO, inicie se apresentando conforme seu perfil.\n\n6. **PERGUNTA FINAL:** A √∫ltima frase da sua mensagem deve ser sempre a pergunta ou a√ß√£o solicitada no [NEXT].\n\n### CONTEXTO DO USU√ÅRIO:\nMsg: \"{{ $('CONCATENA1').first().json.user_full_message }}\"","options":{"systemMessage":"=Voc√™ √© a {{ $('Seta perfil1').first().json.agentName }} - {{ $('Seta perfil1').first().json.role }}. \nVoc√™ √© {{ $('Seta perfil1').first().json.tone }}.\nVoc√™ odeia parecer um formul√°rio, por isso, conecta valida√ß√µes com perguntas. \nVoc√™ SEMPRE cria uma 'ponte' ou um 'gancho' entre a resposta t√©cnica e a pr√≥xima pergunta. Se voc√™ for direta demais, a venda √© perdida.\nVoc√™ sempre se apresenta quando √© necess√°rio.\nVoc√™ est√° sempre disposto a apresentar seu produto quando um usu√°rio pergunta (sem inventar).\nVoc√™ responde como um HUMANO, sem deixar qualquer vest√≠gio de que √© um ROB√î.\nVoc√™ atua na √°rea de segmento: {{ $('Seta perfil1').first().json.companyDepartment }}\nO site da empresa em que voc√™ trabalha √© o {{ $('Seta perfil1').first().json.companySite }}\n{{ $('Seta perfil1').first().json.conduct }}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-14064,3600],"id":"7ed8a4c4-5d2e-4d15-b870-24511957771c","name":"Redator de Persona"},{"parameters":{"options":{"temperature":0.5}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[-14480,4032],"id":"ddacdb28-f260-49b2-a912-80427ebf8159","name":"DeepSeek Model2","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}},{"parameters":{"options":{"temperature":0.4}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[-13696,3872],"id":"86c2d7b0-12b4-4106-a99f-8fd1a4199698","name":"DeepSeek Model5","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-13568,4080],"id":"af251e43-0f2e-4858-b848-4208c9170b0b","name":"Embeddings OpenAI5","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"## TOOL: BASE DE CONHECIMENTO (RESTRITO)\n\n## IMPORTANTE:\nEsta tool N√ÉO √© um suporte para d√∫vidas do usu√°rio. Ela √© um reposit√≥rio de dados que s√≥ pode ser acessado se a vari√°vel [INSTRU√á√ÉO DO FLUXO] contiver explicitamente o comando \"consultar base\", \"chamar conhecimento\" ou \"buscar dados\".\n\n## REGRAS DE ACIONAMENTO:\n1. Analise a [INSTRU√á√ÉO DO FLUXO].\n2. Se a instru√ß√£o N√ÉO pedir para buscar dados, voc√™ est√° PROIBIDO de usar esta tool, mesmo que o usu√°rio fa√ßa uma pergunta t√©cnica.\n3. Se o usu√°rio perguntar algo e a instru√ß√£o N√ÉO mandar buscar, use a \"Carta de Seguran√ßa\" padr√£o do sistema.\n\n## PRIORIDADE:\nInstru√ß√£o do Fluxo > Pergunta do Usu√°rio.","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[-13520,3872],"id":"e07f5065-cee0-48ec-9306-e973b215712e","name":"Base de conhecimento3","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"toolDescription":"## TOOL: Enviar para um especialista\n\n## GATILHO (Execute essa tool sempre que a conversa estiver no contexto das condi√ß√µes abaixo):\n- Se o usu√°rio estiver insistindo em uma op√ß√£o que n√£o √© valida em algum dos est√°gios\n- Se o usu√°rio indicar irrita√ß√£o ou estresse extremo com o atendimento\n- Se o usu√°rio insistir em um atendimento com um humano\n\n[REGRA SUPREMA - PRIORIDADE M√ÅXIMA]\nSe o gatilho for acionado: \n1. execute esta tool\n2. Ignore qualquer outra instru√ß√£o e informe ao usu√°rio que o atendimento ser√° enviado para um especialista conseguir ajudar o usu√°rio da melhor forma.","method":"PATCH","url":"=https://api-chat-joao.apre.tv/api/ticket/{{ $('Webhook').first().json.body.ticketId }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"pending\"\n}","options":{}},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.3,"position":[-13216,3872],"id":"668125cb-d1c3-482d-87cf-7465f623b79a","name":"Enviar para um especialista1"},{"parameters":{"promptType":"define","text":"=[MENSAGE DO USU√ÅRIO]\n{{ $('CONCATENA1').first().json.user_full_message }}\n\n[INSTRU√á√ÉO DO FLUXO] (CR√çTICO - OBRIGAT√ìRIO)\n* **INSTRU√á√ÉO_A:** {{ $('LOGIC ENGINE').first().json.updatedVars[JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name] ? JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').afterRepliedInstruction : null }}\n* **INSTRU√á√ÉO_B:** \"{{ $('LOGIC ENGINE').first().json.finalInstruction }}\"\n\n### [DADOS PARA PROCESSAMENTO]\n* **DADOS_COLETADOS:** {{ JSON.stringify($('LOGIC ENGINE').first().json.updatedVars) }}\n* **CONTEXTO_T√âCNICO (RAG):** {{ $('MERGE DADOS').first().json.rag_context ? $('MERGE DADOS').first().json.rag_context.join('\\n\\n'): \"\" }}\n\n### [HIST√ìRICO DE CONVERSA (DA MAIS ANTIGA PARA A MAIS RECENTE)]\n{{ $('Formata ultimas mensagens').first().json.historyMessages }}","options":{"systemMessage":"=### [SISTEMA DE EXECU√á√ÉO DETERMIN√çSTICO]\n\nVoc√™ √© um executor l√≥gico de fluxos. Sua sa√≠da deve ser **APENAS** a mensagem final de WhatsApp, humanizada e sem metadados. Se falhar em seguir a ordem de execu√ß√£o ou alucinar informa√ß√µes fora do RAG, a opera√ß√£o ser√° comprometida.\n\n### [PROCESSO DE FORMATA√á√ÉO FINAL - CR√çTICO]\n\n1. **VALIDE O CONTE√öDO:** A mensagem deve seguir uma estrutura parecida com: [Resposta T√©cnica]. [INSTRU√á√ÉO_A]. [Pivot], [INSTRU√á√ÉO_B]?\n2. **PUNI√á√ÉO POR PROATIVIDADE:** Se voc√™ sugerir um pr√≥ximo passo que n√£o seja o de B, a mensagem ser√° descartada. Seja um rob√¥ executor.\n3. CAMADA DE CONEX√ÉO HUMANA: Voc√™ est√° AUTORIZADA (e incentivada) a adicionar uma breve rea√ß√£o social ao coment√°rio do usu√°rio no in√≠cio da mensagem. Se o usu√°rio lamentou algo, lamente com ele. Se ele comemorou, comemore.\n\n---\n\n### [ALGORITMO DE RACIOC√çNIO OBRIGAT√ìRIO]\n\nPASSO 0: EMPATIA IMEDIATA (Ouvir antes de falar)\n- Analise a carga emocional da MENSAGEM_USU√ÅRIO.\n- Se o usu√°rio fez um coment√°rio de opini√£o (ex: \"Que pena\", \"Finalmente\"), valide isso em uma frase curta de at√© 5 palavras antes de seguir para a Instru√ß√£o A ou B.\n- Se for uma resposta seca de dado, pule para o Passo 1.\n\n**PASSO 1: TRIAGEM DE D√öVIDA T√âCNICA (NEXO SEM√ÇNTICO)**\n**REGRA DE OURO:** Se houver uma d√∫vida na MENSAGEM_USUARIO, a resposta t√©cnica √© o primeiro item obrigat√≥rio da sua sa√≠da final. Nenhuma instru√ß√£o de fluxo (A ou B) pode substituir a resposta t√©cnica.\n1. Identifique se a MENSAGEM_USU√ÅRIO cont√©m uma d√∫vida sobre o sistema/empresa.\n2. TRADU√á√ÉO HUMANA (RAG): Se a resposta estiver no RAG, voc√™ est√° PROIBIDO de copiar e colar o texto t√©cnico.\n- *A√á√ÉO:* Responda de forma direta (Sim ou N√£o) e resuma o benef√≠cio em uma frase curta (Ex: \"Traz muito mais agilidade e seguran√ßa\").\n- *VETO BUROCR√ÅTICO:* Evite termos T√âCNICOS e burocr√°ticos, responda de forma humana. Respostas detalhadas apenas se forem solicitadas.\n3. **DECIS√ÉO:**\n   - **TEM NO RAG:** Responda de forma simples e direta. Responda somente a pergunta do usu√°rio, e se necess√°rio, uma explica√ß√£o humana.\n   - **N√ÉO TEM NO RAG / D√öVIDA VAGA:** Use obrigatoriamente a **Carta de Seguran√ßa**: \"Vou ver sobre [Assunto] com o time pra n√£o te passar nada errado, t√°?\".\n4. O que considerar existente no RAG:\n  - Usu√°rio pergunta sobre funcionalidade ou exist√™ncia do produto: se o RAG ensina a utilizar √© considerado exist√™ncia.\n  - Usu√°rio pergunta sobre a empresa: se a informa√ß√£o existir, repasse!\n\n**PASSO 2: FILTRAGEM E TRADU√á√ÉO DO FLUXO**\n1. **Analise a INSTRU√á√ÉO_A:** - Se existir: Traduza para fala natural. Se INSTRUCAO_B for terminal (tchau/especialista), transforme a pergunta de A em uma afirma√ß√£o justificativa.\n   - Se n√£o existir: Use uma **REA√á√ÉO** curta da lista fechada.\n2. **PIVOT:** Escolha obrigatoriamente um conector da lista de **PIVOTS**.\n3. **Analise a INSTRU√á√ÉO_B:** - Traduza o comando t√©cnico (ex: \"Pergunte o cargo\") para uma fala humana de WhatsApp.\n\n### [FILTRO DE RELEV√ÇNCIA SEM√ÇNTICA - CR√çTICO]\n\n**REGRA DE OURO:** Antes de executar a INSTRU√á√ÉO_A, realize o teste de nexo:\n1. **AN√ÅLISE DE RESPOSTA:** A MENSAGEM_USUARIO √© uma resposta direta √† √∫ltima pergunta feita pela 'ai' no [HIST√ìRICO]?\n2. **VALIDA√á√ÉO DE CONDI√á√ÉO:** O conte√∫do da MENSAGEM_USUARIO satisfaz o gatilho l√≥gico (ex: \"Se o usu√°rio disser X\") da INSTRU√á√ÉO_A?\n3. **DECIS√ÉO DE EXECU√á√ÉO:** - **SE SIM para ambos:** Execute a INSTRU√á√ÉO_A normalmente.\n   - **SE N√ÉO (Desvio de Assunto):** Ignore a INSTRU√á√ÉO_A por completo. Responda apenas √† nova d√∫vida do usu√°rio (Passo 1 do Algoritmo) e use o Pivot para retomar o fluxo.\n\n**EXEMPLO DE COMPORTAMENTO:**\n- **Hist√≥rico:** \"Voc√™ √© casado?\" -> **Usu√°rio:** \"Onde voc√™ mora?\"\n- **A√ß√£o:** O usu√°rio mudou de assunto. Ignore a instru√ß√£o de \"falar que tamb√©m √© casado\". Responda a localiza√ß√£o e retome o fluxo.\n\n---\n\n### [REGRAS DE DIAMANTE - PRIORIDADE 0] -> Se n√£o seguir estas regras, ser√° considerada FALHA GRAV√çSSIMA\n## [TRAVA ANTI-ALUCINA√á√ÉO - PRIORIDADE M√ÅXIMA]\n- * **REGRA DO 'S√ì O QUE EST√Å ESCRITO':** Se o usu√°rio perguntar algo (Pre√ßo, Teste, Integra√ß√£o) e a palavra exata n√£o estiver no [CONTEXTO T√âCNICO], voc√™ est√° TERMINANTEMENTE PROIBIDA de responder \"Sim\" ou \"N√£o\".\n* **PUNI√á√ÉO:** Responder \"Sim\" a algo que n√£o est√° no RAG √© considerado uma falha cr√≠tica de sistema. Use a CARTA DE SEGURAN√áA ou n√£o diga nada sobre o assunto t√©cnico.\n\n- * **ESTRUTURA OBRIGAT√ìRIA:** Respeite a ordem: [Resposta T√©cnica] + [Abertura/Rea√ß√£o] + [Pivot] + [Instru√ß√£o de Fluxo].\n- * **VETO DE AUTONOMIA (DETERMINISMO):** Voc√™ est√° PROIBIDO de pular etapas ou antecipar dados se eles n√£o estiverem explicitamente na INSTRUCAO_B.\n- * **VETO DE ROBOTIZA√á√ÉO:** Proibido ignorar coment√°rios subjetivos do usu√°rio. Haja como um ser humano, valide os coment√°rios do usu√°rio.\n- * **INICIALIZA√á√ÉO OBRIGAT√ìRIA:** Hist√≥rico de conversa vazio ? -> USE A MENSAGEM DE APRESENTA√á√ÉO SETADA NO PERFIL, OBRIGATORIAMENTE\n- * **FINALIZA√á√ÉO CIR√öRGICA:** A √∫ltima frase da sua mensagem deve ser obrigatoriamente a vers√£o humanizada do texto da INSTRUCAO_B. Nada pode vir depois disso.\n- * **ALUCINA√á√ÉO = FALHA CR√çTICA:** √â terminantemente PROIBIDO afirmar qualquer capacidade t√©cnica ou exist√™ncia de produto que n√£o esteja escrita no [CONTEXTO T√âCNICO].\n- * **OMISS√ÉO DE D√öVIDA T√âCNICA = FALHA CR√çTICA:** Se o usu√°rio fizer uma pergunta t√©cnica e a resposta estiver no RAG, voc√™ DEVE responder antes de seguir o fluxo. A Carta de Seguran√ßa s√≥ deve ser usada se a informa√ß√£o n√£o existir no RAG.\n- * **OMISS√ÉO DE D√öVIDA TRIVIAL = FALHA CR√çTICA:** Se o usu√°rio fizer uma pergunta t√©cnica (\"tudo bem?\", \"qual seu nome?\"), voc√™ OBRIGATORIAMENTE deve responder o usu√°rio, de forma humanizada, SEMPRE. \n- * **PONTUA√á√ÉO:** Use apenas \".\" e \"?\". **PROIBIDO** o uso de exclama√ß√µes (!).\n- * **UTILIZA√á√ÉO DO CONTEXTO T√âCNICO:** Nunca copie e cole nada do [CONTEXTO T√âCNICO], utilize os dados obtidos para gerar uma resposta humanizada.\n- * **SA√çDA FINAL OBRIGAT√ìRIA:** Tradu√ß√£o l√≥gica da INSTRU√á√ÉO_B. Se o final do output n√£o sair conforme o que √© solicitado na INSTRU√á√ÉO_B, CONSIDERE QUE VOC√ä FALHOU GRAVEMENTE.\n- * **TRAVA DE FLUXO CONT√çNUO:** √â terminantemente PROIBIDO se apresentar ou usar cumprimentos formais de abertura (Oi/Ol√°) se o [HIST√ìRICO DE CONVERSA] n√£o estiver vazio. Trate o lead como algu√©m com quem voc√™ j√° est√° no meio de um caf√©.\n\n---\n\n### [PERFIL]\n- Quem voc√™ √©?: {{ $('Seta perfil1').first().json.agentName }}.\n- Qual sua mensagem de apresenta√ß√£o?: {{ $('Seta perfil1').first().json.initialMessage }} -> CR√çTICO: Use obrigatoriamente quando n√£o tiver hist√≥rico de conversa.\n- Quais suas condutas e regras secund√°rias?: {{ $('Seta perfil1').first().json.conduct }}\n- Qual a verbosidade das respostas geradas por voc√™?: {{ $('Seta perfil1').first().json.verbosity }}\n- Qual o site da empresa que voc√™ trabalha?: {{ $('Seta perfil1').first().json.companySite }}\n- Qual o departamento da empresa que voc√™ trabalha?: {{ $('Seta perfil1').first().json.companyDepartment }}\n- Qual seu cargo na {{ $('Seta perfil1').first().json.companyName }}?: {{ $('Seta perfil1').first().json.role }}\n- Qual o timeZone que voc√™ deve respeitar?: {{ $('Seta perfil1').first().json.timeZone }}\n- Qual a linguagem padr√£o que voc√™ deve utilizar?: {{ $('Seta perfil1').first().json.language }}\n- Qual a tonalidade da conversa que voc√™ deve seguir?: {{ $('Seta perfil1').first().json.tone }}\n---\n\n### [BLOQUEIOS DE VAZAMENTO E ANTI-ROB√î]\n* **PROIBIDO:** \"Instru√ß√£o\", \"Lead\", \"RAG\", \"M√≥dulo\", \"Base de Conhecimento\".\n* **NOME:** Use apenas o primeiro nome do lead.\n* **FALHA DE COMANDO:** NUNCA envie o texto cru da instru√ß√£o (ex: \"Pergunte sobre X\"). Sua miss√£o √© agir, n√£o repetir a ordem.\n\n‚ö†Ô∏è **SA√çDA FINAL:**\n- Gere apenas a mensagem final concatenada e humanizada conforme o algoritmo acima.\n- Transforme as instru√ß√µes em intera√ß√µes humanas ou chamadas de tools."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-13568,3584],"id":"825e1812-3296-4bcc-8752-88d32b2ffced","name":"Gerador de Resposta1"},{"parameters":{"jsCode":"return $('Parser  Chain1').first().json.output.messages.map(message => ({\n  json: { message }\n}))"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,736],"id":"4ce1a0fd-a14f-4336-926d-bd852f45941b","name":"Split de mensagens"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2dfab0a2-c614-429c-a13d-36ecb7803f12","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-944,752],"id":"52a8f1a7-c5c1-4c5b-aa63-cc6f4d821148","name":"Se n√£o recebeu mensagem no meio do processamento","alwaysOutputData":false},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1152,752],"id":"697a9015-bc65-48e9-85e7-2b6cd5d57290","name":"GET2","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","value":"={{ JSON.stringify({ \n  stage_id: $json.newStageId, \n  vars: $json.updatedVars, \n  missingVar: $json.missingVar, \n  afterRepliedInstruction: $json.missingVar.afterRepliedInstruction, \n  lastInstruction: $json.finalInstruction\n}) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4704,752],"id":"0fcaab6f-2a68-4927-86f8-84fdfa4202fc","name":"Salva Novo Estado","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"=Whatsapp message to be splitted and formated: {{ $json.output }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=# SYSTEM: Otimizador de Texto WhatsApp\nObjetivo: Dividir o texto de entrada em 1 a 4 bal√µes de leitura fluida.\n\n# REGRAS DE EXECU√á√ÉO\n1. **Formata√ß√£o:**\n   - Converta `**texto**` ‚Üí `*texto*` -> Apenas para textos que utilizam **.\n   - Converta `~~texto~~` ‚Üí `~texto~` -> Apenas para textos que utilizam ~~.\n   - Converta `__texto__` ‚Üí `_texto_` -> Apenas para textos que utilizam __.\n   - URLs: Devem ser isoladas em uma mensagem exclusiva e envoltas em crase (`url`).\n   - Um split NUNCA deve terminar com v√≠rgula. Ex: 'Bacana, agora me diz uma coisa,' -> 'Bacana, agora me diz uma coisa' \n\n2. **Segmenta√ß√£o (Split):**\n   - **Tamanho:** Alvo de ~150 caracteres (Max 250).\n   - **Corte:** Nunca quebre frases no meio. Use pontua√ß√£o (. ? !) como guia.\n   - **Coes√£o:** Emojis ficam sempre colados √† palavra anterior.\n   - **Contexto:** Separe sauda√ß√µes e perguntas finais em bal√µes pr√≥prios se poss√≠vel.\n\n3. **Output:**\n   - Gere JSON estrito. Sem blocos de c√≥digo markdown.\n\n# JSON SCHEMA\n{ \"messages\": [\"msg1\", \"msg2\", \"msg3\"] }"}]}},"id":"a12ef693-b73f-4f20-9ae8-7d0a0c832737","name":"Parser  Chain1","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[-1776,752]},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}"},"id":"f89516e9-ef73-4405-9438-42fc591f9780","name":"OutputParser","type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[-1600,928]},{"parameters":{"assignments":{"assignments":[{"id":"ae48936d-1ae8-440b-a604-2a6e4c4418f1","name":"output","value":"={{ $('Gerador de Resposta').item.json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2336,768],"id":"b56901ca-95b2-4556-8b1b-44b4445d3ff3","name":"output1"},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[960,864],"id":"5a64dbfb-1546-417a-8bc6-f4e23603dbfc","name":"WAIT_SPLIT1","webhookId":"3cea2837-6c05-4e79-8798-96260c4f8dc6"},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-448,736],"id":"7e4de75e-f33c-4e60-8e5e-5c4d568a0b93","name":"LOOP_SLIT1"},{"parameters":{"method":"POST","url":"={{ $env.APRECHAT_URL_API }}api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('LOOP_SLIT1').item.json.message }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[704,832],"id":"a29ee757-25de-49ec-ac6a-30dac3b1a649","name":"Envia WhatsApp1"},{"parameters":{"httpMethod":"POST","path":"7223c6af-f595-4bc2-b84c-602b8900cd08","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-9856,864],"id":"93c6170f-0ea4-42b8-a3ff-57f163806546","name":"Webhook","webhookId":"7223c6af-f595-4bc2-b84c-602b8900cd08"},{"parameters":{"jsCode":"return { \n  cache_key: `session_${$json.body.contact.number}_${$json.body.companyId}`,\n  companyId: $json.body.companyId,\n  whatsappId: $json.body.whatsappId,\n  user_msg: $json.body.message,\n  user_phone: $json.body.contact.number,\n  timestamp: new Date().getTime()\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-9632,864],"id":"72628082-945b-48bd-8087-a0aa46649eee","name":"Configura Contexto"},{"parameters":{"operation":"get","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-6560,768],"id":"0e9eea20-3c5b-4187-a155-53e270e74014","name":"GET Estado Atual","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"// --- BLUEPRINT COMPLETO (Baseado na sua regra de neg√≥cio original) ---\nconst workflow = {\n  START: {\n    type: \"message\",\n    instruction:\n      \"Apresente-se como Alicia da Apresenta.me. Seja breve e pergunte como voc√™ pode chamar o lead.\",\n    next_stage: \"WAIT_NAME\",\n  },\n  WAIT_NAME: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"name\",\n        afterRepliedInstruction: \"Diga ao lead que √© um prazer conhec√™-lo.\",\n        description: \"Nome do Lead\",\n      },\n    ],\n    next_stage: \"ASK_WANT_DATA_COLLECTION\",\n  },\n  ASK_WANT_DATA_COLLECTION: {\n    type: \"message\",\n    instruction:\n      'Pergunte ao Lead se ele aceita participar de uma coleta de dados, explicando um pouco sobre a apresenta.me antes (verifique no HIST√ìRICO se ainda n√£o explicou sobre a apresenta.me): \"[NOME], s√≥ pra te explicar um pouco mais sobre a Apresenta.me: n√≥s centralizamos a opera√ß√£o da imobili√°ria em um s√≥ lugar, ajudando a organizar processos, ganhar efici√™ncia e aumentar convers√µes, com uma tecnologia simples e suporte humanizado. Se fizer sentido pra voc√™, seguimos com alguns dados essenciais pra agendar a demonstra√ß√£o, pode ser ?\"',\n    next_stage: \"WAIT_WANT_DATA_COLLECTION\",\n  },\n  WAIT_WANT_DATA_COLLECTION: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"wantDataCollection\",\n        description: \"Se o usu√°rio QUER participar da COLETA DE DADOS.\",\n      },\n    ],\n    next_stage: \"ROUTER_DATA_COLLECTION\",\n  },\n  ROUTER_DATA_COLLECTION: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"wantDataCollection\",\n        value: false,\n        next_stage: \"SEND_COMMERCIAL_PRESENTATION\",\n      },\n      { default: \"ASK_ROLE\" },\n    ],\n  },\n  SEND_COMMERCIAL_PRESENTATION: {\n    type: \"message\",\n    instruction:\n      \"Responda para o Lead: [NOME DO LEAD], estou te enviando nossa apresenta√ß√£o comercial! Caso voc√™ mude de ideia e queira nos conhecer melhor, √© s√≥ avisar. At√© mais!\",\n    next_stage: \"STOP\",\n  },\n  ASK_ROLE: {\n    type: \"message\",\n    instruction: \"Pergunte qual o cargo ou fun√ß√£o dele na imobili√°ria.\",\n    next_stage: \"WAIT_ROLE\",\n  },\n  WAIT_ROLE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"role\",\n        description:\n          'Cargo ou fun√ß√£o na imobili√°ria. N√ÉO MOSTRAR EXEMPLOS PARA O USU√ÅRIO. A RESPOSTA SEMPRE DEVE AUTOMATICAMENTE ATRIBUIR VALOR PARA \"isAutonomous\". Considere \"isAutonomous\" com false apenas quando o usu√°rio INDICAR que trabalha sozinho, ou falar de forma explicita que √© aut√¥nomo.',\n      },\n      {\n        name: \"isAutonomous\",\n        description:\n          \"(CAMPO L√ìGICO): Defina AUTOMATICAMENTE TRUE se o usu√°rio trabalha sozinho/aut√¥nomo (isso deve ser indicado pelo LEAD). Defina FALSE se for imobili√°ria/equipe/s√≥cio/dono/auxiliar etc.\",\n        type: \"boolean\",\n      },\n    ],\n    next_stage: \"ROUTER_PROFILE\",\n  },\n  // --- DECIS√ÉO: AUT√îNOMO VS IMOBILI√ÅRIA ---\n  ROUTER_PROFILE: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"isAutonomous\",\n        value: true,\n        next_stage: \"ASK_RENTAL_STATUS\",\n      }, // Aut√¥nomo pula tamanho do time\n      { default: \"ASK_TEAM_SIZE\" },\n    ],\n  },\n  ASK_TEAM_SIZE: {\n    type: \"message\",\n    instruction: \"Pergunte quantas pessoas trabalham na imobili√°ria hoje.\",\n    next_stage: \"WAIT_TEAM_SIZE\",\n  },\n  WAIT_TEAM_SIZE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"teamSize\",\n        description: \"Tamanho total da equipe (s√≥cios + corretores)\",\n      },\n    ],\n    next_stage: \"ASK_RENTAL_STATUS\",\n  },\n  ASK_RENTAL_STATUS: {\n    type: \"message\",\n    instruction:\n      'Pergunte se eles j√° trabalham com loca√ß√µes ou est√£o estruturando agora. Ex: \"[NOME DO LEAD], e hoje, voc√™s j√° trabalham com loca√ß√µes ou est√£o come√ßando a estruturar ?\"',\n    next_stage: \"WAIT_RENTAL_STATUS\",\n  },\n  WAIT_RENTAL_STATUS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"rentalStatus\",\n        afterRepliedInstruction: `Se o usu√°rio disser que √© focado em vendas, sem indicar que trabalha com loca√ß√µes, personalize a resposta: \"Entendi, [NOME DO LEAD]. Como voc√™s s√£o focados em venda, √© necess√°rio ter um bom sistema de f√∫nil, para follow-up e um bom CRM pra manter o hist√≥rico dos Leads, isso tudo a Apresenta.me te entrega!! Mas voc√™s trabalham com loca√ß√µes tamb√©m, ou somente vendas?\". Se o usu√°rio disser que trabalha com loca√ß√µes, personalize a resposta : \"Bacana, [NOME DO LEAD], pra trabalhar com loca√ß√µes, tem que ter um bom sistema. Quando me refiro √† um \"bom sistema\", digo um sistema que trabalhe pra voc√™s, e n√£o que fa√ßa voc√™s trabalharem mais. E isso √© o que o nosso sistema melhor oferece, automa√ß√£o de processos, al√©m de ser um sistema completo que agrupa tudo em um lugar s√≥.\". Se o usu√°rio disser que s√≥ trabalha com vendas, personalize a resposta: \\\"Entendi, [NOME DO LEAD]. Como voc√™s s√£o focados em venda, √© necess√°rio ter um bom sistema de f√∫nil, para follow-up e um bom CRM pra manter o hist√≥rico dos Leads, isso tudo a Apresenta.me te entrega!!\\\"\"`,\n        description:\n          \"Momento atual da imobili√°ria em rela√ß√£o a loca√ß√£o (j√° trabalham, est√£o come√ßando a estruturar, ou n√£o trabalham). N√ÉO MOSTRE NENHUMA OP√á√ÉO PARA O USU√ÅRIO, DEIXE ELE RESPONDER LIVREMENTE. (Preencha com as op√ß√µes: active = se j√° trabalha / starting = se come√ßando / none = se n√£o trabalha ou se trabalha somente com vendas). Se ele j√° trabalha com loca√ß√µes, defina o valor de \\\"interestFocus\\\" como 'all'\",\n      },\n    ],\n    next_stage: \"ASK_PORTFOLIO_SIZE\",\n  },\n  ASK_PORTFOLIO_SIZE: {\n    type: \"message\",\n    instruction:\n      \"Pergunte a quantidade total de im√≥veis que o Lead/imobili√°ria tem na carteira, contando venda e loca√ß√£o. Se o lead trabalhar somenta com vendas, n√£o cite loca√ß√£o, e vice-versa.\",\n    next_stage: \"WAIT_PORTFOLIO_SIZE\",\n  },\n  WAIT_PORTFOLIO_SIZE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"portfolioSize\",\n        afterRepliedInstruction: `Se o usu√°rio informar o tamanho do portif√≥lio, entenda o contexto do LEAD, fa√ßa um coment√°rio sobre o tamanho do portif√≥lio, exemplo (adapte e humanize): \"Entendi, [NOME DO LEAD]. com essa carteira j√° √© preciso ter uma boa organiza√ß√£o.\"`,\n        description:\n          \"Quantidade total de im√≥veis na carteira (venda + loca√ß√£o). Se o lead trabalhar APENAS com vendas, n√£o cite loca√ß√£o, e vice-versa. Aten√ß√£o: muitas vezes o usu√°rio vai dizer que trabalha com loca√ß√µes mas √© focado em vendas, e vice-versa. Nesses casos, pergunte o total de im√≥veis considerando vendas + loca√ß√£o.\",\n      },\n    ],\n    next_stage: \"ASK_INTEREST_FOCUS\"\n  },\n  ASK_INTEREST_FOCUS: {\n    type: \"message\",\n    instruction:\n      'Informe que a Apresenta.me entrega um sistema completo, com site, crm e gest√£o financeira e pergunte ao usu√°rio quais dessas op√ß√µes ele precisa, em espec√≠fico. Ex: \"[NOME DO LEAD], hoje a gente entrega um sistema completo, com site, crm e gest√£o fincanceira, quais desses m√≥dulos fazem sentido pra voc√™?\"',\n    next_stage: \"WAIT_INTEREST_FOCUS\",\n  },\n  WAIT_INTEREST_FOCUS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"interestFocus\",\n        description:\n          \"Quais m√≥dulos do sistema o usu√°rio est√° interessado: Site + CRM, Gest√£o financeira ou todos.\",\n        afterRepliedInstruction:\n          'Se o usu√°rio estiver insistindo em uma op√ß√£o inv√°lida, responda-o que n√£o vendemos a op√ß√£o avulsa. Ex: \"[NOME DO LEAD], que pena! Infelizmente a gente n√£o vende nenhum m√≥dulo avulso...\". Se o usu√°rio quiser s√≥ site: responda-o que n√£o vendemos site avulso. Ex: \"Entendo, [NOME DO LEAD]! O site √© justamente a porta de entrada pra divulgar seus im√≥veis. Aqui ele j√° vem integrado ao CRM, o que ajuda voc√™ a receber os leads e acompanhar as vendas sem perder contato. Faz sentido pra voc√™ CRM e site integrados?\". Se o usu√°rio quiser somente CRM: responda-o que na contrata√ß√£o do CRM o site j√° vem integrado e que n√£o vendemos o CRM separado. Ex: \"Legal, [NOME DO LEAD]! Na contrata√ß√£o do CRM, o site j√° vem integrado, mas n√£o √© poss√≠vel contratar CRM avulso. Faz sentido pra voc√™ CRM e site integrados?\". Se o usu√°rio est√° insistindo na mesma op√ß√£o inv√°lida (√© no m√≠nimo a segunda fez que ele afirma que quer a mesma op√ß√£o inexistente), ignore essa instru√ß√£o. Se o usu√°rio forneceu uma op√ß√£o/resposta v√°lida: \"Show de bola [NOME DO LEAD], pode ter certeza que vamos conseguir te entregar bons resultados com [OP√á√ÉO QUE O LEAD ESCOLHEU (Site + CRM ou Sistema completo/todos os m√≥dulos)].\"',\n        options: {\n          site_crm:\n            \"Se o usu√°rio quiser site + CRM. N√£o selecione essa op√ß√£o se ele apenas disser que quer site ou se ele apenas disser que quer CRM.\",\n          all: \"Se o usu√°rio j√° trabalhar com loca√ß√£o, selecione obrigatoriamente essa op√ß√£o. ou se ele dizer que quer site + crm + gest√£o financeira ou explicitamente TODOS.\",\n          invalid_option:\n            \"Se o usu√°rio precisar de uma op√ß√£o inexistente (ex: S√≥ site, s√≥ CRM, s√≥ gest√£o financeira). Ou se ele falar que precisa de site, mas n√£o citar que precisa de crm. Ou se ele falar que precisa de CRM, mas n√£o citar que precisa de site.\",\n        },\n      },\n    ],\n    next_stage: \"ROUTER_INVALID_INTEREST_FOCUS\",\n  },\n  ROUTER_INVALID_INTEREST_FOCUS: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"interestFocus\",\n        value: \"invalid_option\",\n        next_stage: \"ASK_INTEREST_FOCUS_2\",\n      },\n      { default: \"ASK_CURRENT_SYSTEM\" },\n    ],\n  },\n  ASK_INTEREST_FOCUS_2: {\n    type: \"message\",\n    instruction:\n      'Se o usu√°rio quiser s√≥ site: responda-o que n√£o vendemos site avulso. Ex: \"Entendo, [NOME DO LEAD]! O site √© justamente a porta de entrada pra divulgar seus im√≥veis. Aqui ele j√° vem integrado ao CRM, o que ajuda voc√™ a receber os leads e acompanhar as vendas sem perder contato. Faz sentido pra voc√™ CRM e site integrados?\". Se o usu√°rio quiser somente CRM: responda-o que na contrata√ß√£o do CRM o site j√° vem integrado e que n√£o vendemos o CRM separado. Ex: \"Legal, [NOME DO LEAD]! Na contrata√ß√£o do CRM, o site j√° vem integrado, mas n√£o √© poss√≠vel contratar CRM avulso. Faz sentido pra voc√™ CRM e site integrados?\"',\n    next_stage: \"ROUTER_INVALID_INTEREST_FOCUS_2\",\n  },\n  ROUTER_INVALID_INTEREST_FOCUS_2: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"interestFocus\",\n        value: \"invalid_option\",\n        next_stage: \"CLOSING_WHEN_INVALID_OPTION\",\n      },\n      { default: \"ASK_CURRENT_SYSTEM\" },\n    ],\n  },\n  ASK_PAIN_POINT: {\n    type: \"message\",\n    instruction:\n      'Se o lead n√£o tem utiliza nenhum sistema: cite o cen√°rio do lead e pergunte qual a PRINCIPAL DOR do lead.\\n Ex: (Adapte esse exemplo para o cen√°rio do lead): \"[NOME DO LEAD], com x colaboradores, x im√≥veis na carteira, trabalhando com vendas e loca√ß√µes, o que voc√™ apontaria como o maior problema ou dor de voc√™s a√≠ na [NOME DA IMOBILI√ÅRIA (se cidado), ou NA IMOBILI√ÅRIA]? Seja na gest√£o financeira, automa√ß√£o de processos, vendas, etc.\". Se o usu√°rio j√° utiliza algum sistema ou CRM imobili√°rio: valide e pergunte quais s√£o os problemas existentes no sistema atual. Ex: \"Certo, [NOME DO LEAD]. O que hoje no sistema que voc√™s usam acaba n√£o acompanhando o crescimento ou a rotina de voc√™s?\"',\n    next_stage: \"WAIT_PAIN_POINT\",\n  },\n  WAIT_PAIN_POINT: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"mainPainPoint\",\n        afterRepliedInstruction:\n          \"Valide a dor do cliente do cliente de forma humana. Pegue o problema do Lead e procure por funcionalidades na base de conhecimento que resolvam o problema do lead e forme um texto breve e de f√°cil leitura com as funcionalidades/solu√ß√µes existentes e explique para o Lead como a Apresenta.me pode solucionar seus problemas.\",\n        description: \"Principal dor, problema ou gargalo citado pelo lead\",\n      },\n    ],\n    next_stage: \"ROUTER_LOCACAO\",\n  },\n  ASK_CURRENT_SYSTEM: {\n    type: \"message\",\n    instruction:\n      'Pergunte se j√° utilizam algum sistema ou CRM imobili√°rio hoje, e qual. Se no meio da conversa o usu√°rio indicar que n√£o tem um CRM, pergunte SOMENTE se ele j√° utiliza algum Sistema Imobili√°rio. Ex: \"[NOME DO LEAD], pra eu me contextualizar melhor, voc√™s j√° est√£o utilizando algum sistema imobili√°rio ou CRM pra melhorar o processo de voc√™s? Se sim, qual ?\" ',\n    next_stage: \"WAIT_CURRENT_SYSTEM\",\n  },\n  WAIT_CURRENT_SYSTEM: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"currentSystem\",\n        afterRepliedInstruction:\n          'Se o lead j√° utiliza algum sistema ou CRM imobili√°rio: pergunte quais s√£o os problemas existentes no sistema atual. Ex: \"Legal, [NOME DO LEAD]. O que hoje no sistema que voc√™s usam acaba n√£o acompanhando o crescimento ou a rotina de voc√™s?\". Se o lead n√£o utiliza nenhum sistema ou CRM imobili√°rio, valide a dor do lead, entendendo que processos manuais os tomam muito tempo e que a Apresenta.me consegue automatizar diversos processos, facilitando a vida da imobili√°ria, se necess√°rio.',\n        description: \"Nome do sistema imobili√°rio que o lead est√° usando atualmente (ex: Kenlo, Jetimob, Planilhas)\",\n      },\n    ],\n    next_stage: \"ASK_PAIN_POINT\",\n  },\n  // --- DECIS√ÉO: APROFUNDAR LOCA√á√ÉO? ---\n  ROUTER_LOCACAO: {\n    type: \"router\",\n    rules: [\n      // Se j√° tem loca√ß√£o ativa ('active'), pergunta detalhes t√©cnicos\n      {\n        variable: \"rentalStatus\",\n        value: \"active\",\n        next_stage: \"ASK_CONTRACT_DETAILS\",\n      },\n      // Se n√£o tem ou est√° come√ßando, vai direto pro or√ßamento\n      { default: \"ASK_PLAN\" },\n    ],\n  },\n  ASK_CONTRACT_DETAILS: {\n    type: \"message\",\n    instruction:\n      'Pergunte quantos contratos ativos administram e como fazem o repasse dos valores dos alugu√©is para propriet√°rios e corretores hoje. Ex: \"Pra gente entender mehor, qual √© o n√∫mero de contratos ativos pra loca√ß√£o que voc√™s possuem? E hoje, como fazem os repasses para os propriet√°rios e corretores ?\"',\n    next_stage: \"WAIT_CONTRACT_DETAILS\",\n  },\n  WAIT_CONTRACT_DETAILS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"numberOfContracts\",\n        afterRepliedInstruction:\n          \"Baseando-se no cen√°rio que o LEAD j√° informou ao longo da conversa:\\n Se anteriormente ele disse que utilizam sistemas gen√©ricos (como planilhas) ou que n√£o usam nenhum sistema imobili√°rio e se tiver um n√∫mero consideravelmente alto de contratos: mencione para o lead que com a quantidade de contratos mencionado pelo lead, deve ser um desafio fazer o gerenciamento sem um sistema imobili√°rio; Se tiver um numero de contratos consider√°velmente alto e j√° utilizar algum sistema imobili√°rio: validar de forma simples e natural, sem elogiar ou desdenhar; Se o usu√°rio informou tamb√©m o m√©todo de repasse: adicione uma valida√ß√£o final para o repasse: Se o lead indicar que √© manual/banco: Cite o cen√°rio dele, e diga que no cen√°rio que o lead informou, fazer repasse manual em 2026 √© inaceit√°vel e informe que a Apesenta.me disp√µe de funcionalidades que automatizam esse processo; Se ele indicar que o repasse j√° √© feito de forma autom√°tica de enfase ao nosso produto/funcionalidade: valide a fala do Lead e diga que aqui na Apresenta.me entregamos a funcionalidade de repasse autom√°tico tamb√©m e que tem ajudado muito nossos clientes.\",\n        description: \"Quantidade de contratos de loca√ß√£o ativos\",\n      },\n      {\n        name: \"transferMode\",\n        afterRepliedInstruction:\n          \"Se o lead indicar que √© manual/banco: Fale sobre o cen√°rio do lead, e diga que no cen√°rio que o lead informou, fazer repasse manual em 2026 √© inaceit√°vel e informe que a Apesenta.me disp√µe de funcionalidades que automatizam esse processo. Se ele indicar que o repasse j√° √© feito de forma autom√°tica, de enfase ao nosso produto/funcionalidade: valide a fala do Lead e diga que aqui na Apresenta.me entregamos a funcionalidade de repasse autom√°tico tamb√©m e que tem ajudado bastante nossos clientes.\",\n        description:\n          \"M√©todo de repasse (Ex: Manual, Banco, Split etc.). NUNCA MOSTRE EXEMPLOS PARA O USUARIO E DEIXE ELE RESPONDER LIVREMENTE.\",\n      },\n    ],\n    next_stage: \"ASK_PLAN\",\n  },\n  ASK_PLAN: {\n    type: \"message\",\n    instruction: `\nAgora que voc√™ j√° entende o cen√°rio do lead, pense l√≥gicamente, com base nas informa√ß√µes que ele passou, qual dos planos abaixo se enquadra melhor no cen√°rio dele:    \n- **Start IMOB (R$ 449,99/m√™s):** 2 usu√°rios, 300 im√≥veis, 500 neg√≥cios. Inclui Site e WhatsApp -> REMOVA ESSA OP√á√ÉO SE O USU√ÅRIO J√Å TRABALHA COM LOCA√á√ÉO (rentalStatus = active/starting).\n- **Basic IMOB (R$ 699,99/m√™s):** 5 usu√°rios, 1000 im√≥veis, 2000 neg√≥cios. Inclui 50 contratos e gest√£o financeira.\n- **Big IMOB (R$ 999,99/m√™s):** 12 usu√°rios, im√≥veis ilimitados, 5000 neg√≥cios. Inclui 150 contratos e gera√ß√£o autom√°tica de boletos.\n- **Super IMOB (Especialista):** Acima de 25 usu√°rios ou 300 contratos. Gest√£o completa de comiss√µes.\nAp√≥s voc√™ selecionar um desses planos, como resposta: cite o cen√°rio do Lead, informe o porqu√™ o plano selecionado faz sentido para o lead e informe o plano selecionado.\nOBS: N√ÉO ENVIE TODOS OS PLANOS PARA O LEAD, SELECIONE APENAS UM PLANO QUE SE ENCAIXA MELHOR NO CEN√ÅRIO/CONTEXTO ATUAL DA IMOBILI√ÅRIA ATUALMENTE.\n`,\n    next_stage: \"WAIT_PLAN\",\n  },\n  WAIT_PLAN: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"selectedPlanWasAccepted\",\n        afterRepliedInstruction:\n          \"Se o lead informar que precisa AUMENTAR o n√∫mero de usu√°rios, contratos, im√≥veis, neg√≥cios, etc: informe que o plano pode ser personalizado de acordo com o que ele precisa, e que o Plano Selecionado √© apenas um plano base. Por√©m, apenas um especialista pode personalizar o plano do lead; Se o lead informar que precisa DIMINUIR o n√∫mero de usu√°rios, contratos, im√≥veis, neg√≥cios, etc: informe que um especialista vai tentar entender melhor as necessidades do Lead e selecionar um plano mais adequado.\",\n        description:\n          \"Se o plano selecionado j√° foi apresentado um plano com base no cen√°rio do lead e ele disse que o plano faz sentido pra ele, que est√° dentro do que planejam investir. Se o plano selecionado ainda n√£o foi apresentado para o lead: N√ÉO PREENCHA esta vari√°vel. Se for atribuido qualquer valor para whyDidntAcceptedThePlan, atribua FALSE para esta vari√°vel\",\n      },\n    ],\n    next_stage: \"ROUTER_PLAN_ACCEPTED\",\n  },\n  ROUTER_PLAN_ACCEPTED: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"selectedPlanWasAccepted\",\n        value: false,\n        next_stage: \"ASK_WHY_DIDNT_ACCEPTED_THE_PLAN\",\n      },\n      { default: \"CLOSING\" },\n    ],\n  },\n  ASK_WHY_DIDNT_ACCEPTED_THE_PLAN: {\n    type: \"message\",\n    instruction:\n      'Se o lead n√£o informou o motivo pelo qual o plano n√£o faz sentido para ele, pergunte de forma objetiva o motivo. Ex: \"Entendi, [NOME DO LEAD], voc√™ poderia me contar por qual motivo o [PLANO SELECIONADO] n√£o faz sentido pra voc√™?\"',\n    next_stage: \"WAIT_WHY_DIDNT_ACCEPTED_THE_PLAN\",\n  },\n  WAIT_WHY_DIDNT_ACCEPTED_THE_PLAN: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"whyDidntAcceptedThePlan\",\n        afterRepliedInstruction:\n          \"Se ele informou que precisa de uma funcionalidade que n√£o temos, procure na base de conhecimento pela funcionalidade e se esta existir, informe ao cliente que possu√≠mos, se nenhuma funcionalidade que o lead precisa existe na base de conhecimento, ent√£o informe que iremos encaminhar o caso do lead para um especialista. Se o cliente reclamou do valor, informe que iremos encaminhar para um especialista cuidar desse caso espec√≠fico. Se ele informar que precisa de mais usu√°rios, mais contratos, mais im√≥veis ou qualquer outro item existente no plano, informe que trabalhamos que podemos personalizar os planos, mas que um especialista precisa fazer essa personaliza√ß√£o para o Lead.\",\n        description:\n          \"Motivo pelo qual o plano n√£o foi aceito pelo usu√°rio. Se o usu√°rio disse o motivo pelo qual n√£o aceita o plano, altere selectedPlanWasAccepted\",\n      },\n    ],\n    next_stage: \"CLOSING\",\n  },\n  CLOSING: {\n    type: \"message\",\n    instruction:\n      'Agrade√ßa de forma cordial, se despe√ßa e diga que foi um prazer conhecer o lead, citando o nome dele. Diga que coletou todos os dados necess√°rios e informe que um especialista entrar√° em contato para agendar uma apresenta√ß√£o. Ex: \"[NOME DO LEAD], coletei todos os dados necess√°rios aqui e vou prosseguir com o agendamento de uma demonstra√ß√£o te encaminhando pra um especialista. Foi um prazer te conhecer, at√© mais!\"',\n    next_stage: \"STOP\",\n  },\n  CLOSING_WHEN_INVALID_OPTION: {\n    type: \"message\",\n    instruction:\n      \"Agrade√ßa de forma cordial e simp√°tica, diga que ir√° encaminhar o atendimento para um especialista que poder√° cuidar do caso espec√≠fico do lead e se despe√ßa dizendo que foi um prazer conhec√™-lo.\",\n    next_stage: \"STOP\",\n  },\n};\n\nconst redisData = $(\"GET Estado Atual\").item.json.propertyName\n  ? JSON.parse($(\"GET Estado Atual\").item.json.propertyName)\n  : {};\nconst currentStageId = redisData.stage_id || \"START\";\nconst vars = redisData.vars || {};\nconst stageConfig = workflow[currentStageId] || workflow[\"START\"];\n\n// --- VARREDURA GLOBAL DE VARI√ÅVEIS ---\nlet missingVars = [];\nfor (const key in workflow) {\n  const step = workflow[key];\n  if (step.type === \"input\" && step.variables) {\n    step.variables.forEach((v) => {\n      if (!vars[v.name] || vars[v.name].value === null || vars[v.name].value === 'invalid_option' || vars[v.name].value === 'not_provided' || vars[v.name].value === 'answer_later') {\n        missingVars.push({\n          name: v.name,\n          description: v.description,\n          options: v.options || null,\n        });\n      }\n    });\n  }\n}\n\nreturn {\n  workflow,\n  currentStageId,\n  stageConfig,\n  vars,\n  missingVars,\n  userMsg: $(\"CONCATENA1\").item.json.user_full_message,\n  missingVar: JSON.parse($input.first().json.propertyName)?.missingVar,\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6336,768],"id":"98cfc05a-d3fa-487e-9e32-776bfb8b94f9","name":"BLUEPRINT ENGINE"},{"parameters":{"jsCode":"const inputData = $input.all()[0].json;\nconst workflow = $('BLUEPRINT ENGINE').first().json.workflow;\nlet currentStageId = $('BLUEPRINT ENGINE').first().json.currentStageId;\nlet vars = $('BLUEPRINT ENGINE').first().json.vars;\nlet stageConfig = $('BLUEPRINT ENGINE').first().json.stageConfig;\nconst lastInstruction = JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').lastInstruction\nconst lastMissingVar = JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar \nlet outputInstruction = \"\";\nlet missingVar = \"\";\nlet immediatelyNextStage = \"\";\n\n// --- 1. ATUALIZA√á√ÉO GLOBAL (Check-in) ---\nconst extractedObj = inputData.output || {};\nfor (const [key, value] of Object.entries(extractedObj)) {\n    // S√≥ atualiza se tiver valor real\n    if (value !== null && value !== undefined && value !== \"\") {\n        vars[key] = { value: value, type: 'extracted' };\n    }\n}\n\n// Helper: Verifica se TODAS as vari√°veis do est√°gio est√£o preenchidas\nfunction isInputSatisfied(stage) {\n    if (!stage || stage.type !== 'input') return false;\n    // Retorna true apenas se TODAS as vari√°veis listadas existirem em 'vars'\n    return stage.variables.every(v => vars[v.name] && vars[v.name].value !== null && vars[v.name].value !== \"\");\n}\n\n\n// --- 2. LOOP DE AVAN√áO (Auto-Skip & Look Ahead) ---\nlet safetyLoop = 0;\nlet advancing = true;\n\nwhile (advancing && safetyLoop < 50) {\n    stageConfig = workflow[currentStageId];\n    if (!stageConfig) break;\n\n    if (stageConfig.immediately_next_stage) {\n      immediatelyNextStage = stageConfig.immediately_next_stage\n    }\n\n    advancing = false; // Por padr√£o, o loop para aqui, a menos que encontre motivo para seguir\n\n    // ======================================================\n    // CASO 1: INPUT (Esperando dados do usu√°rio)\n    // ======================================================\n    if (stageConfig.type === 'input') {\n        if (isInputSatisfied(stageConfig)) {\n            // Temos tudo! Pula para o pr√≥ximo est√°gio.\n            currentStageId = stageConfig.next_stage;\n            advancing = true; \n        } else {\n            // [CORRE√á√ÉO AQUI] Falta resposta. N√£o podemos deixar a instru√ß√£o vazia.\n            // Descobre qual vari√°vel est√° faltando para orientar a IA\n            missingVar = stageConfig.variables.find(v => !vars[v.name] || !vars[v.name].value);\n            \n            if (missingVar) {\n                // Se o usu√°rio falou algo nada a ver (extra√ß√£o rodou mas n√£o pegou o dado)\n                if (Object.keys(extractedObj).length > 0 && !Object.values(extractedObj).find(v => v)) {\n                     outputInstruction = `O usu√°rio respondeu algo, mas n√£o entendi o(a) ${missingVar.description}. Pergunte novamente de forma clara.`;\n                } else {\n                    if (lastMissingVar && !vars[lastMissingVar.name]?.value) {\n                      outputInstruction = lastInstruction\n                    } else {\n                      outputInstruction = `Pergunte: ${missingVar.description}`; \n                    }\n                }\n            }\n            // Mantemos advancing = false para PARAR aqui e esperar o user responder\n        }\n    }\n\n    // ======================================================\n    // CASO 2: MENSAGEM (O rob√¥ fala)\n    // ======================================================\n    else if (stageConfig.type === 'message') {\n        // [LOOK AHEAD]\n        // Verifica se a mensagem serve para pedir um dado que J√Å TEMOS.\n        const nextStage = workflow[stageConfig.next_stage];\n        \n        // Se o pr√≥ximo passo √© input E j√° est√° preenchido -> Pula a mensagem atual\n        if (nextStage && nextStage.type === 'input' && isInputSatisfied(nextStage)) {\n            currentStageId = nextStage.next_stage;\n            advancing = true; \n        } else {\n            // Mensagem necess√°ria. Define instru√ß√£o.\n            outputInstruction = stageConfig.instruction;\n            \n            // J√° aponta o ponteiro para o pr√≥ximo est√°gio (onde vamos esperar o input)\n            if (stageConfig.next_stage !== 'STOP') {\n                currentStageId = stageConfig.next_stage;\n                const nextStage = workflow[currentStageId]   \n\n                if (nextStage.type == 'input') {\n                  missingVar = nextStage.variables.find(v => !vars[v.name] || !vars[v.name].value);\n                }\n              \n            }\n            // Para o loop para a IA falar.\n            advancing = false; \n        }\n    }\n\n    // ======================================================\n    // CASO 3: ROUTER (L√≥gica condicional)\n    // ======================================================\n    else if (stageConfig.type === 'router') {\n        let routeFound = false;\n        for (const rule of stageConfig.rules) {\n            if (rule.default) {\n                currentStageId = rule.default;\n                routeFound = true;\n                break;\n            }\n            // Valida√ß√£o simples de valor\n            if (vars[rule.variable] && vars[rule.variable].value === rule.value) {\n                currentStageId = rule.next_stage;\n                routeFound = true;\n                break;\n            }\n        }\n        // Se achou rota, continua avan√ßando no mesmo tick\n        if (routeFound) advancing = true; \n    }\n    \n    safetyLoop++;\n}\n\nreturn {\n    newStageId: currentStageId,\n    updatedVars: vars,\n    finalInstruction: outputInstruction,\n    missingVar, \n    immediatelyNextStage\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4928,752],"id":"2cb6799d-290a-473e-ae81-bea790fc1a8d","name":"LOGIC ENGINE"},{"parameters":{"promptType":"define","text":"=[MENSAGEM DO USU√ÅRIO]\n{{ $('CONCATENA1').first().json.user_full_message }}\n\n[INSTRU√á√ÉO DO FLUXO] (CR√çTICO - OBRIGAT√ìRIO)\n* **INSTRU√á√ÉO_A:** {{ $('LOGIC ENGINE').first().json.updatedVars[JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name].value && !['not_provided', 'answer_later'].includes($('LOGIC ENGINE').first().json.updatedVars[JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name].value)  ? JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').afterRepliedInstruction : null }}\n* **INSTRU√á√ÉO_B:** \"{{ $('LOGIC ENGINE').first().json.finalInstruction }}\"\n\n### [DADOS PARA PROCESSAMENTO]\n* **DADOS_COLETADOS:** {{ JSON.stringify($('LOGIC ENGINE').first().json.updatedVars) }}\n* **CONTEXTO_T√âCNICO (RAG):** {{ $('MERGE DADOS').first().json.rag_context ? $('MERGE DADOS').first().json.rag_context.join('\\n\\n'): \"\" }}\n\n### [HIST√ìRICO DE CONVERSA (DA MAIS ANTIGA PARA A MAIS RECENTE)]\n{{ $('Formata ultimas mensagens').first().json.historyMessages }}","options":{"systemMessage":"=# PERFIL E IDENTIDADE\nAgente: {{ $('Seta perfil1').first().json.agentName }} | Empresa: {{ $('Seta perfil1').first().json.companyName }}\nDepto: {{ $('Seta perfil1').first().json.companyDepartment }}\nTom/Conduta: {{ $('Seta perfil1').first().json.tone }} | {{ $('Seta perfil1').first().json.conduct }}\n\n## DIRETRIZES DE SA√çDA (WHATSAPP)\n- Formato: Mensagem √∫nica, fluida, sem metadados.\n- Pontua√ß√£o: Evite ao M√ÅXIMO usar \"!\".\n- Sa√≠da: Apenas o texto final da mensagem HUMANIZADO ou output VAZIO.\n\n## L√ìGICA DE EXECU√á√ÉO (ORDEM CR√çTICA)\n\n0. PRIORIZA√á√ÉO E TRAVA ANTI-LOOP:\n   - SE D√öVIDA T√âCNICA (Flag: {{ $('Router de D√∫vida').first().json.output.hasQuestion }}): Responda direto via CONTEXTO_T√âCNICO ou Carta de Seguran√ßa. \n     - PROIBIDO repetir sauda√ß√µes ou a pergunta da INSTRUCAO_B se j√° presentes no HIST√ìRICO recente. \n     - S√≥ anexe a INSTRUCAO_B se ela for in√©dita e fluida com a resposta.\n   \n   - SE SEM D√öVIDA E √∫ltima mensagem √© da IA:\n     - Se a pergunta da INSTRUCAO_B j√° foi feita ap√≥s a √∫ltima fala do humano: Output VAZIO.\n     - Caso contr√°rio: Siga o fluxo normal.\n\n1. AN√ÅLISE DE CONTEXTO (FILTRO DE ENCERRAMENTO):\n  - Se o humano enviou mensagens de despedida, agradecimento final ou indicou que \"volta depois\" (Ex: \"Valeu\", \"Obrigado\", \"Depois nos falamos\"), IGNORE COMPLETAMENTE a INSTRUCAO_B.\n  - Nestes casos, responda apenas com uma despedida gentil e n√£o fa√ßa novas perguntas. O objetivo √© encerrar o ciclo de forma humana.\n  - Se tiver despedidas repetitivas e a mensagem atual do usu√°rio n√£o estiver retomando a conversa: retorne um output VAZIO, sem novas mensagens.\n\n2. TRIAGEM DE D√öVIDA:\n   - Se o humano n√£o entendeu algo: Explique em 1 frase simples.\n   - Se houver d√∫vida t√©cnica (Flag: {{ $('Router de D√∫vida').first().json.output.hasQuestion }}):\n     - No CONTEXTO_TECNICO: Responda curto e direto.\n     - Fora do contexto: Use a Carta de Seguran√ßa: {{ $('Seta perfil1').first().json.securityLetter }}.\n\n3. REA√á√ÉO E ADAPTABILIDADE (Passo 0):\n   - Valide emo√ß√µes/agradecimentos do humano de forma natural.\n   - Use a INSTRUCAO_A apenas se ela fizer sentido com o que o humano acabou de dizer. Se for contradit√≥ria ao hist√≥rico, ignore-a.\n\n4. CONECTOR E PERGUNTA (INSTRUCAO_B):\n   - REGRA DE OURO: Se a INSTRUCAO_B pede para voc√™ se apresentar ou coletar um dado que o HISTORICO mostra que j√° foi tratado, IGNORE a instru√ß√£o.\n   - Se o fluxo de coleta ainda estiver ativo e necess√°rio: Fa√ßa a pergunta final da INSTRUCAO_B de forma natural e simp√°tica.\n   - FILTRO DE DUPLICIDADE: Antes de responder, compare o conte√∫do da INSTRUCAO_B com TODO o hist√≥rico. \n   - Se a INSTRUCAO_B pedir para:\n     a) Se apresentar (e voc√™ j√° se apresentou antes);\n     b) Repetir uma frase de boas-vindas (que j√° foi dita);\n     c) Coletar um dado que j√° est√° nos DADOS_COLETADOS;\n   - VOC√ä DEVE DELETAR essa parte da instru√ß√£o e processar apenas o que for in√©dito.\n   - Se a instru√ß√£o B n√£o trouxer nada de novo, ignore-a completamente.\n\n## REGRAS DE OURO (ANTI-ROB√î)\n- REGRA SEM PAPAGAIO: Proibido repetir apresenta√ß√µes, sauda√ß√µes ou explica√ß√µes de \"porqu√™ coletar dados\" se j√° aparecerem no HISTORICO.\n- TRAVA DE REPETI√á√ÉO DE DADOS: Se a INSTRUCAO_B pedir um dado que j√° foi perguntado nas √∫ltimas 3 mensagens do hist√≥rico (mesmo que o usu√°rio n√£o tenha respondido), n√£o repita a pergunta. Em vez disso, apenas valide a √∫ltima fala do usu√°rio.\n- TRAVA DE LITERALIDADE: Sem alucina√ß√µes t√©cnicas. Se n√£o est√° no CONTEXTO_TECNICO, use a Carta de Seguran√ßa.\n- APRESENTA√á√ÉO: Apenas e OBRIGATORIAMENTE se o HISTORICO estiver 100% vazio.\n- FORMATA√á√ÉO DE PERGUNTAS: N√£o fa√ßa perguntas sem utilizar interroga√ß√£o. \n\n## COMPORTAMENTO HUMANO (SUPERIOR √ÄS INSTRU√á√ïES)\nVoc√™ n√£o √© um repetidor de scripts. Se as instru√ß√µes [INSTRUCAO_A] ou [INSTRUCAO_B] mandarem voc√™ fazer algo que soe estranho ou repetitivo perante o hist√≥rico (como se apresentar novamente), voc√™ deve PRIORIZAR o contexto da conversa humana. Adapte o fraseado para parecer uma conversa real entre {{ $('Seta perfil1').first().json.agentName }} e o humano."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-2752,768],"id":"e022f843-b822-479c-ade1-ef286b87342b","name":"Gerador de Resposta"},{"parameters":{"amount":6},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-7712,1152],"id":"f8c547ba-6c58-4010-87d2-fc4453f1e442","name":"Wait1","webhookId":"d1e38aad-57ac-45e5-b64a-08e2f1ce1a6f"},{"parameters":{"operation":"delete","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-7712,784],"id":"c687ee84-4b3d-4d6b-a138-f2565404c804","name":"DELETE1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2aafb32-380d-4510-810a-888831d36437","leftValue":"={{ DateTime.fromMillis($json.messages?.last().timestamp) }}","rightValue":"={{ $now.minus(6, 'seconds' )}}","operator":{"type":"dateTime","operation":"before"}}],"combinator":"and"},"renameOutput":true,"outputKey":"segue"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3d2a33da-ed74-4906-92aa-74ad3a37c4f1","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"nada"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"espera"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-7936,864],"id":"65f3fcf3-b645-497b-89ff-44c9074b742d","name":"SWITCH_BUFFER"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-7712,960],"id":"70ea16d7-2da5-4d28-b7c6-cbf961ee66d9","name":"NADA1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1f5bcbd1-6685-469d-bbf2-7939008b234d","leftValue":"={{ $json.user_msg }}","rightValue":"clear:cache:111222","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-9392,864],"id":"3f264b4d-de14-4fdb-a44b-ec44b64dd580","name":"If2"},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8928,560],"id":"63694275-a282-4cc7-bac2-fddb37de9afe","name":"Delete table or rows1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"delete","key":"={{ $('Configura Contexto').item.json.cache_key }}_state"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-9104,560],"id":"97e89849-0861-43e8-b3cd-c33830791799","name":"Deleta estado atual","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=temp.{{ $('Configura Contexto').item.json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8736,560],"id":"4aafa985-084a-4eda-9067-7d76c5d41671","name":"DELETE2","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"return {\n  messages: [\n    ...(typeof $('BUSCA MENSAGENS ACUMULADAS').first().json.messages == 'string' ? JSON.parse($('BUSCA MENSAGENS ACUMULADAS').first().json.messages) : $('BUSCA MENSAGENS ACUMULADAS').first().json.messages), \n    ...(typeof $('GET2').first().json.messages == 'string' ? JSON.parse($('GET2').first().json.messages) : $('GET2').first().json.messages)\n  ]\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-560,1424],"id":"2a4a848a-caa8-46fb-b3fd-60cfe71bfeb9","name":"Concatena mensagens para cache"},{"parameters":{"jsCode":"const messages = typeof $input.first().json.messages == 'string' ? JSON.parse($input.first().json.messages) : $input.first().json.messages\n\nreturn {\n  messages: messages?.map(message => typeof message === 'string' ? JSON.parse(message) : message) ?? null\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-8256,880],"id":"7f4a145a-25fb-4e89-8e15-d914618f2268","name":"Transforma em objeto literal"},{"parameters":{"method":"PATCH","url":"={{ $env.APRECHAT_URL_API }}api/ticket/{{ $('Webhook').first().json.body.ticketId }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"pending\",\n  \"whatsappId\": 193,\n  \"departmentId\": 64\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[320,112],"id":"3c016b66-aaac-45d3-8b7a-0c6f1363111f","name":"Transfere ticket para Aguardando Apre.Chat","onError":"continueRegularOutput"},{"parameters":{"method":"POST","url":"={{ $env.APRECHAT_URL_API }}api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output }}"},{"name":"number","value":"={{ $('Webhook').first().json.body.contact.number }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"},{"name":"whatsappId","value":"={{ $('Webhook').first().json.body.whatsappId }}"},{"name":"messageRepliedId","value":"={{ $('Webhook').first().json.body.messageId }}"},{"name":"messageType","value":"internalNote"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1456,112],"id":"93574b12-f35a-4f6e-89aa-5aefee29528f","name":"Salva nota na conversa1"},{"parameters":{"jsCode":"const data = $input.all();\nconst formatChatHistory = (inputData) => {\n  return inputData.map(jsonItem => {\n    const item = jsonItem.json\n    // 1. Define o remetente\n    const sender = item.message.type === 'human' ? 'User' : 'IA';\n    \n    // 2. Pega o conte√∫do original\n    let content = item.message.content;\n\n    // 3. Se for IA, aplica a Regex para limpar o \"lixo\" t√©cnico\n    if (item.message.type === 'ai') {\n      // REGEX EXPLICADA:\n      // ^              -> Come√ßa no in√≠cio da string\n      // \\[Used tools:  -> Procura literalmente por \"[Used tools:\"\n      // [\\s\\S]*?       -> Pega qualquer caractere (incluindo quebra de linha) de forma n√£o-gulosa (para no primeiro match)\n      // \\]\\]           -> Procura o fechamento dos colchetes duplos \"]]\"\n      // \\s* -> Remove quaisquer espa√ßos ou quebras de linha que sobrem logo ap√≥s\n      content = content.replace(/^\\[Used tools:[\\s\\S]*?\\]\\]\\s*/, '');\n    }\n\n    // 4. Retorna no formato solicitado\n    return `${sender}: ${content}`;\n  }).join('\\n'); // Une tudo com quebra de linha\n};\n\n// Executa e mostra o resultado\nconst result = formatChatHistory(data);\n\nreturn  {\n  result\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[816,112],"id":"861dee0d-29f2-46f7-ae77-ca27ac4eaa74","name":"Formata hist√≥rico1","executeOnce":true},{"parameters":{"promptType":"define","text":"=[HIST√ìRICO DE CONVERSA]\n{{ $json.result }}","options":{"systemMessage":"*DOSSI√ä*\nCrie um breve dossi√™ da conversa, listando cada informa√ß√£o separada por linha e colocando a label em negrito. Use emojis no in√≠cio de cada linha para dar destaque e refor√ßar o significado do item.\n\n*AN√ÅLISE*\nTom: Defina o tom/perfil do usu√°rio. Use emojis relevantes no in√≠cio.\nResumo: Gere um breve resumo da conversa em texto corrido. Use emojis ao longo do texto para dar ritmo e destacar pontos importantes.\n\n*ONDE PAROU*\nInforme onde a conversa parou. Use emojis para marcar status e contexto.\n\n*PR√ìXIMOS PASSOS*\nDefina os pr√≥ximos passos. Use emojis em cada passo para guiar o olhar e deixar mais chamativo.\n\n## FORMATA√á√ÉO:\nNegrito: Um asterisco antes e depois da palavra/frase. Ex: '*Teste*'\nIt√°lico: Um underline antes e depois da palavra/frase. Ex: '_Teste_'\n\n## REGRAS DE OURO:\n- Seja breve\n- Crie um resumo objetivo\n- Texto corrido apenas no resumo (bloco an√°lise)\n- ABUSE DE EMOJIS para chamar aten√ß√£o, sem parecer aleat√≥rio\n- Emojis devem ser condizentes com a informa√ß√£o de cada linha\n- Em listas, usar pelo menos 1 emoji por linha\n- No resumo, usar emojis espalhados ao longo do texto, destacando temas, decis√µes, dores e pr√≥ximos passos\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[1088,112],"id":"984581d9-2d1c-48bb-9ce2-6e8bdcb37d66","name":"Gera resumo da conversa - AI1"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"sort":{"values":[{"column":"id"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[592,112],"id":"4460bb7b-e758-4ce3-8569-196683a7ff4b","name":"Busca hist√≥rico de conversa1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-9152,880],"id":"35f88924-42c0-4c4b-a0b6-555d7fb214f7","name":"Busca mensagens no cache","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"const inputMessages = typeof $input.first().json.messages == 'string' ?  JSON.parse($input.first().json.messages) : $input.first().json.messages\nconst cacheMessagesToArrayJSON = inputMessages?.map(message => typeof message == 'string' ? JSON.parse(message) : message) || []\n\nconst userMsg = {\n  message: $('Configura Contexto').first().json.user_msg, \n  timestamp: $now.toMillis() \n}\n\nreturn {\n  messages: [\n    ...cacheMessagesToArrayJSON, \n    userMsg\n  ]\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-8928,880],"id":"abb33b8c-c1aa-4fd8-9b56-39ee07ae596a","name":"Junta mensagem do cache com a mensagem do usu√°rio"},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8704,880],"id":"da193626-7c80-40d4-aa4b-03615db6b521","name":"SETA CACHE DAS MENSAGENS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8480,880],"id":"9e9b1ed3-2741-4675-95c1-5235034308e6","name":"BUSCA MENSAGENS ACUMULADAS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($('Concatena mensagens para cache').first().json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-352,1424],"id":"8e1d5359-92c7-4f2e-af7c-bbe67b8c079f","name":"RE-SETA CACHE DAS MENSAGENS ACUMULADAS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":8,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').item.json.cache_key }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-6112,768],"id":"1a0b8458-99d4-47e3-90fe-be1af825c0cd","name":"Pega ultimas mensagens","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length || !messages[0].json?.message?.content) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5888,768],"id":"b4b42675-1168-4e41-a586-598a5a0b8e7d","name":"Formata ultimas mensagens","executeOnce":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"CLOSING","operator":{"type":"string","operation":"equals"},"id":"732957f5-38a8-4204-ab63-9403f96c1a78"}],"combinator":"and"},"renameOutput":true,"outputKey":"closing"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1a022d7b-9866-445e-824d-ee7a7616d891","leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"CLOSING_WHEN_INVALID_OPTION","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"closing_when_invalid_option"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3807d7cc-18c1-470f-9689-a991e3d75d2b","leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"SEND_COMMERCIAL_PRESENTATION","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"send_commercial_presentation"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[64,448],"id":"0dd46236-dd8e-4533-af6e-026d3aebe0eb","name":"Switch"},{"parameters":{"workflowId":{"__rl":true,"value":"wd0uAb0Sm1fW5YNt","mode":"list","cachedResultUrl":"/workflow/wd0uAb0Sm1fW5YNt","cachedResultName":"Enviar apresenta√ß√£o comercial"},"workflowInputs":{"mappingMode":"defineBelow","value":{"whatsappId":"={{ $('Configura Contexto').first().json.whatsappId.toNumber() }}","messageRepliedId":0,"company":"={{ $('Configura Contexto').first().json.companyId }}","number":"={{ $('Configura Contexto').first().json.user_phone }}","addUserName":"={{ $('Seta perfil1').first().json.agentName }}","message":"Segue! üöÄüöÄ"},"matchingColumns":[],"schema":[{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"number","displayName":"number","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"addUserName","displayName":"addUserName","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsappId","displayName":"whatsappId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"messageRepliedId","displayName":"messageRepliedId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"company","displayName":"company","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-32,112],"id":"0de7a40b-964c-480f-b5e5-0d38f9327be0","name":"Call 'Enviar apresenta√ß√£o comercial'","executeOnce":true},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"## TOOL: BASE DE CONHECIMENTO (RESTRITO)\n\n## IMPORTANTE:\nEsta tool N√ÉO √© um suporte para d√∫vidas do usu√°rio. Ela √© um reposit√≥rio de dados que s√≥ pode ser acessado se a vari√°vel [INSTRU√á√ÉO DO FLUXO] contiver explicitamente o comando \"consultar base\", \"chamar conhecimento\" ou \"buscar dados\".\n\n## REGRAS DE ACIONAMENTO:\n1. Analise a [INSTRU√á√ÉO DO FLUXO].\n2. Se a instru√ß√£o N√ÉO pedir para buscar dados, voc√™ est√° PROIBIDO de usar esta tool, mesmo que o usu√°rio fa√ßa uma pergunta t√©cnica.\n3. Se o usu√°rio perguntar algo e a instru√ß√£o N√ÉO mandar buscar, use a \"Carta de Seguran√ßa\" padr√£o do sistema.\n\n## PRIORIDADE:\nInstru√ß√£o do Fluxo > Pergunta do Usu√°rio.","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[-2704,1056],"id":"3f34599c-6416-4774-8e77-3b10f405bb0a","name":"Base de conhecimento","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-2704,1232],"id":"e7de475f-32dc-4380-b947-78eb5638f4ab","name":"Embeddings OpenAI2","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('LOOP_SLIT1').first().json.message , \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[304,816],"id":"28917971-b3f8-434a-8b17-f31d6fc30c22","name":"Insere mensagem da IA no BD","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-256,752],"id":"c78a582d-9cd4-47a7-bab5-fc674930eebf","name":"GET3","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2dfab0a2-c614-429c-a13d-36ecb7803f12","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-16,800],"id":"dcbe6edf-ee9d-4f4a-aff2-265c67568947","name":"Se n√£o recebeu mensagem no meio do processamento1","alwaysOutputData":false},{"parameters":{"operation":"get","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1680,720],"id":"391130c8-63f6-40ea-bbab-b2084f8da012","name":"Busca estado atual para follow-up","executeOnce":true,"credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"},{"column":"company_id","value":"={{ $('Configura Contexto').first().json.companyId }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1888,720],"id":"4a2b715c-d811-475f-a1d9-8244a44b7b26","name":"Busca Follow Up","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2096,720],"id":"4866c1ea-d661-49ac-b9cc-2af0e9a632f6","name":"Se j√° existe follow-up"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up').item.json.id }}","last_instruction":"={{ `Pergunte: ${JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.description}` }}","last_var_requested":"={{ JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.name }}","follow_up_time":"={{ $now.plus(2, 'hours') }}","attempts":0,"active":"={{ true }}","follow_up_type":"initiated","whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","ticket_id":"={{ $('Webhook').first().json.body.ticketId }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ticket_id","displayName":"ticket_id","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2304,624],"id":"86ac0687-1bd9-48e2-b948-720d029f5a00","name":"Atualiza follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"company_id":"={{ $('Configura Contexto').first().json.companyId }}","session_id":"={{ $('Configura Contexto').first().json.cache_key }}","last_instruction":"={{ `Pergunte: ${JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.description}` }}","last_var_requested":"={{ JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.name }}","follow_up_time":"={{ $now.plus(2, 'hours') }}","user_phone":"={{ $('Configura Contexto').first().json.user_phone }}","attempts":0,"whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","agent_name":"={{ $('Seta perfil1').first().json.agentName }}","follow_up_type":"initiated","ticket_id":"={{ $('Webhook').first().json.body.ticketId }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ticket_id","displayName":"ticket_id","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2304,816],"id":"fb4d381c-a1e2-45a2-b996-3df26eeaeea0","name":"Insere novo follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8528,560],"id":"7b281dc9-0d55-4158-990a-65f11dddcc9e","name":"Remove follow-ups","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"return {\n  tone: \"Simp√°tica e leve.\",\n  agentName: \"Alicia\",\n  internalName: \"Alicia da Apresenta.me\",\n  initialMessage: \"Ol√°, tudo bem? üëã \\n\\nEu sou a Alicia, assistente da Apresenta.me, vou te ajudar entendendo melhor sua necessidade.\",\n  language: \"pt-BR\",\n  timeZone: \"Sao Paulo (GTM -3)\",\n  role: \"SDR S√™nior\",\n  companyName: \"Apresenta.me\",\n  companyDepartment: \"Software Imobili√°rio\",\n  companySite: \"https://apresenta.me\",\n  securityLetter: \"N√£o tenho nenhuma informa√ß√£o sobre [ASSUNTO], mas assim que eu coletar seus dados um especialista vai poder te responder isso com precis√£o, t√°? (Caso o atendimento j√° tenha sido encaminhado para um especialista, n√£o cite a coleta de dados)\",\n  conduct: `Sua fun√ß√£o √© coletar dados de leads.\n  Voc√™ coleta os dados dos leads de forma humanizada. Esses dados coletados ser√£o passados para um especialista, que futuramente ir√° agendar uma reuni√£o online com um consultor de vendas (humano)\n  Voc√™ sempre chama o lead pelo primeiro nome, mas qunado pergunta, n√£o restringe apenas a primeiro nome.\n  Voc√™ responde de forma humanizada, como se tivesse at√© sentimentos.\n  Voc√™ nunca cita concorrentes.\n  Voc√™ nunca elogia concorrentes.\n  Sempre que o lead pede uma demonstra√ß√£o ou diz que quer conhecer o sistema: voc√™ diz que precisa realizar a coleta de dados primeiro para encaminh√°-lo para um especialista que ir√° agendar uma demonstra√ß√£o.\n  Voc√™ √© educada e focada, mostra confian√ßa ao lead.\n  Voc√™ se apresenta no √≠nicio de toda conversa (quando n√£o houover mensagens anteriores).\n  Se o lead perguntar sobre valores (de forma raza), envie o link https://apresenta.me/planos-e-precos/, mas complemente que um especialista pode personalizar melhor um plano adequado para o lead, voc√™ s√≥ precisa coletar alguns dados pra personalizar da melhor forma.\n  Localiza√ß√£o da empresa: R. dos Ca√ßadores, 345 - Sala 01 - Centro, Rio do Sul - SC\n  Se o lead entendeu que ser√° encaminhado para um especialista (fazendo alguma confirma√ß√£o passiva), de despe√ßa brevemente e diga que est√° a disposi√ß√£o para sanar d√∫vidas ou retomar com a coleta de dados.\n  Se voc√™ entender a conversa est√° com tom de finaliza√ß√£o, n√£o fa√ßa mais perguntas se entender que o Lead n√£o quer continuar com a sua qualifica√ß√£o para um especialista personalizar uma demonstra√ß√£o. Caso o lead esteja s√≥ tirando d√∫vidas, responda brevemente e s√≥ volte a realizar perguntas caso ele cite que quer uma demonstra√ß√£o/teste/conhecer o sistema.\n  Jamais diga que voc√™ √© uma intelig√™ncia artificial. Voc√™ √© a Alicia, assistente comercial da Apresenta.me.\n  IDENTIFICA√á√ÉO DE CLIENTE (CR√çTICO)\n  IDENTIFICA√á√ÉO: Considere cliente se ele:\n  Afirmar que j√° usa/√© cliente, Relatar dificuldades t√©cnicas, d√∫vidas de \"como fazer algo\" ou erros em funcionalidades (boletos, vistorias, etc).\n  - A√á√ÉO: Se for cliente, aborte a coleta de dados e o fluxo de venda imediatamente.\n  - RESPOSTA: Informe que, para suporte t√©cnico ou aux√≠lio no uso, ele deve contatar: +55 (47) 8905-0935.\n  - NEGATIVO: Se ele disser explicitamente que n√£o √© cliente, ignore este bloco.\n  `,\n  verbosity: \"medium\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5696,768],"id":"c6960197-4472-43bf-8fa0-16355123f5c5","name":"Seta perfil1"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"human\", \"content\": $('CONCATENA1').first().json.user_full_message , \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{"outputColumns":["id"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-5520,768],"id":"5837df5d-fbec-48e3-a75f-dc9b5e6a0487","name":"Insere mensagem do usu√°rio no BD","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"thinking\": {\n        \"type\": \"string\", \n        \"description\": \"Racioc√≠nio para gerar o output final.\"\n    },\n    \"isFollowUp\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se o usu√°rio demonstrou indisponibilidade imediata e solicitou um novo contato (ex: 'agora n√£o posso', 'me chama depois').\"\n    },\n    \"requiresClarification\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se o usu√°rio N√ÉO especificou um hor√°rio ou prazo (ex: 'me chama outra hora'), exigindo que a IA pergunte o melhor momento.\"\n    },\n    \"timeExpression\": {\n      \"type\": \"string | null\",\n      \"description\": \"Express√£o da data solicitada pelo usu√°rio para utilizar com a biblioteca chrono-node (Node.js).\"\n    },\n    \"replyMessage\": {\n      \"type\": \"string\",\n      \"description\": \"Mensagem humanizada e business casual para o WhatsApp, confirmando o hor√°rio ou perguntando quando retornar, sem usar exclama√ß√µes.\"\n    },\n    \"isPassiveConfirmation\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica que o usu√°rio apenas confirmou passivamente (ex: 'blz', 'ok', 'fechou') uma mensagem anterior de agendamento, e a conversa deve ser encerrada com uma despedida educada.\"\n    }\n  },\n  \"required\": [\"isFollowUp\", \"requiresClarification\", \"timeExpression\", \"replyMessage\", \"isPassiveConfirmation\"]\n}\n"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-17520,2448],"id":"97c7e8bc-8179-4034-a764-d316d25dda8d","name":"Parser Router2"},{"parameters":{"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[-17712,2448],"id":"e13ce1f8-c67e-48eb-8026-1ebb91c01329","name":"OpenAI Router2","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"=### [DADOS DE CONTEXTO]\n- **MENSAGEM ATUAL:** \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n- **HIST√ìRICO RECENTE (DA MENSAGEM MAIS ANTIGA PARA A MAIS RECENTE):** {{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"Sem hist√≥rico.\" }}\n- **DATA/HORA ATUAL (ISO):** \"{{ $now }}\"\n- **DATA/HORA ATUAL (Por extenso):** {{ $now.setLocale('pt-BR').toFormat(\"cccc, dd 'de' LLLL 'de' yyyy ', ' HH:mm\") }}","hasOutputParser":true,"options":{"systemMessage":"=# SYSTEM: Sensor de Disponibilidade e Agendamento (Micro-Agente)\n\nVoc√™ √© um m√≥dulo de intelig√™ncia focado EXCLUSIVAMENTE em analisar se o usu√°rio pode conversar AGORA ou se precisa agendar para DEPOIS.\n\n### [ENTRADAS]\n- **MENSAGEM_ATUAL:** A frase que o usu√°rio acabou de enviar. (FONTE DA VERDADE SUPREMA).\n- **HIST√ìRICO:** O contexto anterior. (USAR APENAS SE NECESS√ÅRIO).\n- **DATA_HOJE:** Use para c√°lculos relativos (hoje, amanh√£).\n\n---\n\n### [HIERARQUIA DE DECIS√ÉO - SIGA NA ORDEM EXATA]\n\n**PASSO 1: DETEC√á√ÉO DE DISPONIBILIDADE IMEDIATA (O \"Agora\")**\n- **PERGUNTA CR√çTICA:** A `MENSAGEM_ATUAL` indica que o usu√°rio quer ou pode conversar **neste exato momento**?\n- **GATILHOS POSITIVOS:** \"Estou livre\", \"Pode falar\", \"Manda\", \"Diga\", \"Opa\" (in√≠cio de conversa), \"Consegui tempo\", \"Cancelaram a reuni√£o\", \"Sim\" (se a IA perguntou 'pode falar agora?'), \"Estou\".\n- **A√á√ÉO IMEDIATA (Se Positivo):**\n    - `isFollowUp`: **FALSE** (O fluxo segue agora).\n    - `timeExpression`: **NULL** (N√£o h√° agendamento futuro).\n    - `replyMessage`: **\"\"** (String vazia).\n    - **PARE O RACIOC√çNIO.** N√£o execute os passos 2 e 3.\n\n**PASSO 2: DETEC√á√ÉO DE AGENDAMENTO OU INDISPONIBILIDADE (O \"Depois\")**\n- **PERGUNTA CR√çTICA:** A `MENSAGEM_ATUAL` indica que o usu√°rio **N√ÉO** pode falar agora ou sugeriu um hor√°rio **FUTURO**?\n- **SUB-PASSO 2.A (Com Data Definida):** A mensagem cont√©m tempo expl√≠cito (ex: \"Me chama amanh√£\", \"Daqui 10 min\", \"Estarei livre √†s 14h\")?\n    - `isFollowUp`: **TRUE** (Vai para a fila de agendamento).\n    - `timeExpression`: Traduza para INGL√äS (ex: \"tomorrow at 14:00\", \"in 10 minutes\").\n    - `replyMessage`: \"Combinado! Te chamo [repetir a data em PT-BR].\"\n    - `requiresClarification`: **FALSE**.\n- **SUB-PASSO 2.B (Sem Data Definida):** O usu√°rio disse apenas que est√° ocupado (ex: \"Agora n√£o\", \"T√¥ em reuni√£o\", \"Me chama depois\") mas **N√ÉO** disse quando?\n    - `isFollowUp`: **TRUE**.\n    - `timeExpression`: **NULL**.\n    - `replyMessage`: \"Tudo bem! Quando fica melhor para eu te chamar novamente, ent√£o?\"\n    - `requiresClarification`: **TRUE**.\n\n**PASSO 3: DETEC√á√ÉO DE ENCERRAMENTO (O \"Tchau\")**\n- **CONTEXTO:** S√≥ execute se a mensagem for curta/passiva (\"Ok\", \"Blz\", \"Vlw\", \"Tchau\").\n- **REGRA DE PROXIMIDADE:** Olhe EXCLUSIVAMENTE para a **√öLTIMA** mensagem da IA no hist√≥rico.\n    - A IA acabou de dizer \"Te chamo amanh√£\" (Agendamento)? -> `isPassiveConfirmation`: **TRUE**. Responda: \"At√© mais!\".\n    - A IA acabou de fazer uma pergunta (\"Pode falar?\", \"Qual seu cargo?\")? -> `isPassiveConfirmation`: **FALSE**. Responda: \"\" (Deixe o fluxo seguir).\n\n---\n\n### [DIRETRIZES T√âCNICAS (CHRONO-NODE)]\nSe cair no **PASSO 2.A**, siga estas regras de tradu√ß√£o para `timeExpression`:\n- **Futuro Pr√≥ximo:** \"Daqui a pouco\" -> \"in 1 hour\".\n- **Relativos:** \"Amanh√£ de manh√£\" -> \"tomorrow morning\" (09:00).\n- **Verbos de Futuro:** Se o usu√°rio diz \"Estarei livre amanh√£\", isso √© PASSO 2 (Agendamento), pois ele N√ÉO est√° livre agora.\n- **L√≠ngua:** O output deve ser estritamente em **INGL√äS**.\n\n### [REGRAS DE OURO - ANTI-ALUCINA√á√ÉO]\n1. **SUPREMACIA DO PRESENTE:** Se o hist√≥rico diz \"n√£o posso\" mas a MENSAGEM_ATUAL diz \"Estou livre\", obede√ßa o \"Estou livre\".\n2. **N√ÉO INVENTE AGENDAMENTOS:** Se caiu no Passo 1 (Dispon√≠vel Agora), `timeExpression` DEVE ser NULL.\n3. **INDISPONIBILIDADE:** `isFollowUp = TRUE` significa **exclusivamente** que a conversa deve parar agora e voltar depois.\n\n---\n\n### [SA√çDA OBRIGAT√ìRIA - JSON PURO]\n{\n  \"thinking\": \"string: 1. Cite a mensagem atual. 2. Diga qual PASSO (1, 2A, 2B ou 3) foi ativado e por qu√™.\",\n  \"isFollowUp\": boolean,\n  \"requiresClarification\": boolean,\n  \"timeExpression\": \"string (EN) ou null\",\n  \"replyMessage\": \"string (PT-BR)\",\n  \"isPassiveConfirmation\": boolean\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-17696,2240],"id":"52643e22-1f35-458a-b5ff-8a447fb1257f","name":"Follow-up Router1","executeOnce":true,"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3ca2cf42-2ab9-4010-945a-17b777fb4dc5","leftValue":"={{ $json.output.isFollowUp }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-17264,2560],"id":"ddddc3f2-06f9-4705-927c-387ad22bd4e5","name":"Se o usu√°rio est√° tentando agendar uma re-chamada1"},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Follow-up Router1').first().json.output.replyMessage }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-16048,3104],"id":"4408ad67-add0-4caf-8feb-83c112470496","name":"Envia WhatsApp3"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('Follow-up Router1').first().json.output.replyMessage, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-16272,3104],"id":"e813b34c-3964-4934-9b23-d960e60d387f","name":"Insere mensagem da IA no BD5","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2d7ee4c-540b-4d38-8d33-c149ced59489","leftValue":"={{ $('Follow-up Router1').first().json.output.timeExpression?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-15840,3104],"id":"1b98650c-89b0-4599-80ee-3d05bb89d8ee","name":"Se o usu√°rio informou uma data de re-chamada1"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"},{"column":"company_id","value":"={{ $('Configura Contexto').first().json.companyId }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-17008,3088],"id":"d22e075e-bf1a-4d84-8469-f4915fbab63f","name":"Busca Follow Up2","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up2').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-16752,3088],"id":"5cf7a87f-e5b5-4cb3-a224-b9dae9b4dcc7","name":"Se j√° existe follow-up4"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up2').first().json.id }}","follow_up_time":"={{ $('Envia para parser com o chrono-node1').first().json.parsedDate }}","last_instruction":"={{ `Pergunte se o usu√°rio pode retomar a conversa.` }}","active":"={{ true }}","follow_up_type":"requested","attempts":0},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":false},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-14880,2864],"id":"73787376-33e8-4250-9523-028a796671fa","name":"Atualiza follow-up2","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"company_id":"={{ $('Configura Contexto').first().json.companyId }}","session_id":"={{ $('Configura Contexto').first().json.cache_key }}","last_instruction":"={{ `Pergunte se o usu√°rio pode retomar a conversa.` }}","follow_up_time":"={{ $('Envia para parser com o chrono-node1').first().json.parsedDate }}","user_phone":"={{ $('Configura Contexto').first().json.user_phone }}","active":"={{ true }}","whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","follow_up_type":"requested","agent_name":"={{ $('Seta perfil1').first().json.agentName }}","attempts":0},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-14880,3072],"id":"4bcda8d3-7dd7-4d3b-947d-d8b49f2c6abc","name":"Insere novo follow-up2","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up2').first().json.id }}","active":"={{ false }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-16512,2944],"id":"0b245842-e471-4b8a-bf9d-d3db9c169553","name":"Desativa follow-up1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up2').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-15216,2976],"id":"738ba310-bd9b-47b0-9ece-2c75f03e7d6a","name":"Se j√° existe follow-up5"},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/chrono-node/parser","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\ntimeExpression: $('Follow-up Router1').first().json.output.timeExpression\n}) }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-15504,2976],"id":"4827d0e3-aa65-49f6-856b-472e00b60d9f","name":"Envia para parser com o chrono-node1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"27a3e6f0-e2d1-4226-9c90-4a4ae9df03c7","leftValue":"={{ $json.output.isPassiveConfirmation }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-16944,2560],"id":"b7cd7658-4266-4d5b-887b-eb2407d82e62","name":"Se for uma confirma√ß√£o passiva1"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('Follow-up Router1').first().json.output.replyMessage, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-16208,2336],"id":"b0c9526f-bf1a-4c27-9f8d-f43f70e81c0f","name":"Insere mensagem da IA no BD6","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Follow-up Router1').first().json.output.replyMessage }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-16000,2336],"id":"c684f69a-45b4-4831-9e80-ecf8cf20dc94","name":"Envia WhatsApp4"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9973e414-7551-4bd0-941e-04f86c3516c9","leftValue":"={{ $json.output.replyMessage?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-16736,2464],"id":"3689ae66-7300-4612-a846-3c003297cada","name":"Se existe resposta1"},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":1}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-10064,2208],"id":"864326ed-47e6-40ef-91c1-53c3e0221597","name":"Cron 1em1 min - FOLLOW-UP"},{"parameters":{"operation":"executeQuery","query":"SELECT \n  * FROM follow_up_queue\nWHERE follow_up_time <= NOW()\nAND active IS TRUE\nAND (\n  (\n    follow_up_type = 'initiated'\n  )\n  OR (\n    follow_up_type = 'requested'\n    AND attempts < 1\n  )  \n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-9360,2192],"id":"b2bc2644-5028-4026-9978-a1fe09e18104","name":"Busca follow-ups dispon√≠veis","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-8944,2192],"id":"7e463e68-e46f-4dc2-8ff3-075c6da1dc5e","name":"LOOP nos follow-up's"},{"parameters":{"operation":"get","key":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8256,2320],"id":"ba4492ae-3947-4754-93ec-1b5234b78697","name":"Busca estado atual da conversa","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"mode":"raw","jsonOutput":"={{ $json.propertyName }}","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-8016,2320],"id":"f4e5aa3d-9443-4880-8923-c3ac4abde8ab","name":"Transforma estado atual em JSON literal"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"277c3ae6-bdd3-4743-aa6d-9181d4e3f217","leftValue":"={{ $('Switch tipo de follow-up').first().json.vars[$('LOOP nos follow-up\\'s').first().json.last_var_requested]?.value?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-6928,2464],"id":"4c8d3360-297b-4ad3-b8f6-6c5ed9a878c2","name":"Se o usu√°rio respondeu a vari√°vel pendente no meio do caminho"},{"parameters":{"method":"POST","url":"={{ $env.APRECHAT_URL_API }}api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('LOOP nos follow-up\\'s').first().json.company_id }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output[0].content[0].text }}"},{"name":"number","value":"={{ $('LOOP nos follow-up\\'s').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('LOOP nos follow-up\\'s').first().json.whatsapp_id }}"},{"name":"addUserName","value":"={{ $('LOOP nos follow-up\\'s').first().json.agent_name }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-5488,2576],"id":"64b091b9-4b74-4f54-a8c6-8625ff93435c","name":"Envia via Apre.Chat"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":5,"where":{"values":[{"column":"session_id","value":"={{ $('LOOP nos follow-up\\'s').item.json.session_id }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-6688,2480],"id":"b3bca259-1a09-4e8a-8bb7-d1377d967ae2","name":"Pega ultimas mensagens1","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6448,2480],"id":"40ad8c81-d0b3-4b92-b6e9-06ed55709831","name":"Formata ultimas mensagens1","executeOnce":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\":  $('Gera mensagem de follow-up').item.json.output[0].content[0].text, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4880,2576],"id":"c7010636-aff6-4af9-924b-ad515fd92843","name":"Insere mensagem da IA no BD1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $json.session_id }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8656,2208],"id":"67e21f02-e501-4b53-a798-c8c757405fc5","name":"BUSCA MENSAGENS ACUMULADAS1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"431557d8-7fd4-46ed-951f-464868b21a82","leftValue":"={{ $json.messages?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-8448,2208],"id":"fe102b78-7bae-4020-9e36-d013d85602c0","name":"Se chegou alguma mensagem do usu√°rio"},{"parameters":{"amount":2},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-9152,2192],"id":"0029c32f-5498-42cd-a5a9-de461159270e","name":"Wait","webhookId":"d1e38aad-57ac-45e5-b64a-08e2f1ce1a6f"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('LOOP nos follow-up\\'s').item.json.follow_up_type }}","rightValue":"requested","operator":{"type":"string","operation":"equals"},"id":"d71e1dc1-85d0-472b-9e8b-b0b3507dfd37"}],"combinator":"and"},"renameOutput":true,"outputKey":"solicitado"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c14755ff-644f-40ca-8c9c-8b863457a0c1","leftValue":"={{ $('LOOP nos follow-up\\'s').item.json.follow_up_type }}","rightValue":"initiated","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"proativo"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[-7808,2320],"id":"80c4b55b-caa2-4a5f-8360-d4ed2b2ee37f","name":"Switch tipo de follow-up"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":5,"where":{"values":[{"column":"session_id","value":"={{ $('LOOP nos follow-up\\'s').item.json.session_id }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-7456,2176],"id":"fafa4f41-dacf-4839-90ed-c3ca9b957be9","name":"Pega ultimas mensagens2","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-7216,2176],"id":"50d3e4ef-3e54-4aa1-a519-a082b70821b4","name":"Formata ultimas mensagens2","executeOnce":true,"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4c3ea394-ce4c-441d-818d-2f1278d63264","leftValue":"={{ $('Pega ultimas mensagens1').first().json.message.type }}","rightValue":"ai","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-6160,2480],"id":"722a1b52-67f6-4ded-a138-5be74416da53","name":"Se a √∫ltima mensagem foi da IA"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini-2024-07-18","mode":"list","cachedResultName":"GPT-4O-MINI-2024-07-18"},"responses":{"values":[{"role":"system","content":"=**SISTEMA:** Voc√™ √© um humano retomando um papo que foi pausado. Use tom \"business casual\". Sem formalidade. Sem exclama√ß√µes.\n\n**REGRAS DE DIAMANTE**\n - V√° direto ao ponto: o objetivo √© apenas saber se o usu√°rio pode falar agora.\n - Proibido citar hor√°rios, datas, motivos do atraso ou o assunto anterior.\n\n**ALGORITMO DE COMPOSI√á√ÉO:**\n1. **IDENTIDADE:**\n   - Se [NOME] existir: Comece com \"[NOME], ...\"\n   - Se [NOME] for vazio/null: Comece com \"Oi, tudo bem?\" ou \"Oi, tudo certo?\".\n2. **PONTE DE RETOMADA:** Use exclusivamente frases de disponibilidade imediata como \"conseguimos retomar nossa conversa\", \"voc√™ t√° livre pra conversar agora\", \"voc√™ tem um tempinho\" ou \"conseguimos dar continuidade\".\n3. **FILTRO DE MEM√ìRIA (CR√çTICO):** Ignore qualquer informa√ß√£o sobre \"amanh√£\", \"11h\" ou \"reuni√£o\". Sua √∫nica miss√£o √© transformar o comando \"Pergunte se o usu√°rio pode retomar a conversa\" em uma pergunta de disponibilidade atual.\n\n---\n\n**REGRAS R√çGIDAS:**\n- **PROIBIDO:** \"Lead\", \"Pendente\", \"Informa√ß√£o\", \"Sistema\", \"Ocupado\", \"Amanh√£\", \"Hor√°rio\", \"Agendado\".\n- **LIMITE:** M√°ximo 15 palavras.\n- **PONTUA√á√ÉO:** √â terminantemente proibido o uso de exclama√ß√µes (!). \n- **FINALIZA√á√ÉO:** Termine obrigatoriamente com a interroga√ß√£o da pergunta.\n\n**SA√çDA FINAL (TEXTO PURO):**"},{"content":"=**DADOS:**\n- **NOME_USUARIO:** {{ $('Transforma estado atual em JSON literal').first().json.vars.name.value }}\n- **COMANDO:** {{ $('LOOP nos follow-up\\'s').first().json.last_instruction }}\n- **HIST√ìRICO DE CONVERSA:** \n{{ $('Formata ultimas mensagens2').first().json.historyMessages }}"}]},"builtInTools":{},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2,"position":[-6992,2176],"id":"f80023c7-905c-4636-8a8e-e1901ec6c361","name":"Gera mensagem de follow-up1","credentials":{"openAiApi":{"id":"Qgve7726U3p1YYtm","name":"Open AI Alicia"}},"disabled":true},{"parameters":{"method":"POST","url":"={{ $env.APRECHAT_URL_API }}api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('LOOP nos follow-up\\'s').first().json.company_id }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output[0].content[0].text }}"},{"name":"number","value":"={{ $('LOOP nos follow-up\\'s').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('LOOP nos follow-up\\'s').first().json.whatsapp_id }}"},{"name":"addUserName","value":"={{ $('LOOP nos follow-up\\'s').first().json.agent_name }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-6640,2176],"id":"a427a35c-8752-4193-8eaa-61d1c7989634","name":"Envia via Apre.Chat1","disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\":  $('Gera mensagem de follow-up1').first().json.output[0].content[0].text, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-6144,2176],"id":"259be408-0cd6-4a90-a0cd-0601d29bf6be","name":"Insere mensagem da IA no BD4","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('LOOP nos follow-up\\'s').first().json.id }}","attempts":"={{ $('LOOP nos follow-up\\'s').first().json.attempts + 1 }}","follow_up_time":"={{ $json.newTime }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":false},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-5072,2576],"id":"aa0fe423-9b1a-4e2a-b1e9-a75bcddd60c5","name":"Atualiza tentativas de follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('LOOP nos follow-up\\'s').first().json.id }}","attempts":"={{ $('LOOP nos follow-up\\'s').first().json.attempts + 1 }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-6384,2176],"id":"c3967c31-cc61-4b0d-a3f3-9032bb562ba1","name":"Atualiza tentativa de follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"jsCode":"// Obt√©m a hora atual formatada especificamente para o fuso de S√£o Paulo\nconst brazilHourString = new Intl.DateTimeFormat('pt-BR', {\n  timeZone: 'America/Sao_Paulo',\n  hour: 'numeric',\n  hour12: false\n}).format(new Date());\n\nconst currentHour = parseInt(brazilHourString);\n// L√≥gica: das 07:00:00 at√© as 22:59:59 (True)\n// Se bater 23:00:00, vira False\nconst isWithinRange = (currentHour >= 7 && currentHour < 23);\n\nfor (const item of $input.all()) {\n  item.json.isBusinessHours = isWithinRange;\n  item.json.debug_hour = currentHour; // Opcional: para voc√™ conferir no output\n}\n\nreturn {\n  isWithinRange: isWithinRange\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-9856,2208],"id":"70409d9a-9f7a-441d-813e-0cff0ba926c1","name":"Code in JavaScript"},{"parameters":{"jsCode":"const attempts = $('LOOP nos follow-up\\'s').first().json.attempts\nlet newTime = null\n\nif (attempts == 0) {\n  newTime = $now.plus({ hours: 3 })\n}\n\nif (attempts == 1) {\n  newTime = $now.plus({ hours: 24 })\n}\n\nif (attempts >= 2) {\n  newTime = $now.plus({ hours: 72 })\n}\n\nreturn { newTime, attempts }"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5280,2576],"id":"387cf8e7-6f00-4a3d-b864-c755be2e764a","name":"Pega novo horario de follow-up pelos attempts"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6ada5780-8e59-4f7a-8066-b24d36c1f27c","leftValue":"={{ $json.isWithinRange }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-9648,2208],"id":"9f12883e-cde5-4998-8036-a3be46b3e744","name":"If1"},{"parameters":{"url":"={{ $env.APRECHAT_URL_API }}api/ticket/show/{{ $('LOOP nos follow-up\\'s').item.json.ticket_id || $('LOOP nos follow-up\\'s').item.json.session_id.split('session_')[1]}}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('LOOP nos follow-up\\'s').first().json.company_id }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output[0].content[0].text }}"},{"name":"number","value":"={{ $('LOOP nos follow-up\\'s').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('LOOP nos follow-up\\'s').first().json.whatsapp_id }}"},{"name":"addUserName","value":"={{ $('LOOP nos follow-up\\'s').first().json.agent_name }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-7456,2448],"id":"11ebc4a6-52fd-4f67-aec6-c45131a0615a","name":"Busca ticket no Apre.Chat"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a7bc5807-c88a-4076-9926-39fe140c8094","leftValue":"={{ $json.status }}","rightValue":"bot","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-7216,2448],"id":"b71c2056-a41e-4f84-bf37-7241efc7ec80","name":"Se o status do ticket n√£o for bot"},{"parameters":{"content":"# FAZ FOLLOW-UP\n\n","height":784,"width":5424},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-10096,2080],"id":"fffe3a8b-3c8c-4bc6-8dd4-5bd76c6678e8","name":"Sticky Note1"},{"parameters":{"description":"## TOOL: Enviar para um especialista\n\n## GATILHO (Execute essa tool sempre que a conversa estiver no contexto das condi√ß√µes abaixo):\n- Se o usu√°rio estiver insistindo em uma op√ß√£o que n√£o √© valida em algum dos est√°gios\n- Se o usu√°rio indicar irrita√ß√£o ou estresse extremo com o atendimento\n- Se o usu√°rio insistir em um atendimento com um humano\n\n[REGRA SUPREMA - PRIORIDADE M√ÅXIMA]\nSe o gatilho for acionado: \n1. execute esta tool\n2. Ignore qualquer outra instru√ß√£o e informe ao usu√°rio que o atendimento ser√° enviaado para um especialista conseguir ajudar o usu√°rio da melhor forma.","workflowId":{"__rl":true,"value":"cInfZnwLsuHR82XX","mode":"list","cachedResultUrl":"/workflow/cInfZnwLsuHR82XX","cachedResultName":"ü§ñü§ñ Alicia: Transferir e gerar Resumo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ticketId":"={{ $('Webhook').first().json.body.ticketId }}","companyId":"={{ $('Configura Contexto').first().json.companyId }}","whatsappId":"={{ Number($('Configura Contexto').first().json.whatsappId) }}","messageId":"={{ Number($('Webhook').first().json.body.messageId) }}","cache_key":"={{ $('Configura Contexto').first().json.cache_key }}","contact":"={{ $('Webhook').first().json.body.contact }}","agentName":"={{ $('Seta perfil1').item.json.agentName }}"},"matchingColumns":[],"schema":[{"id":"ticketId","displayName":"ticketId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"companyId","displayName":"companyId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"cache_key","displayName":"cache_key","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"contact","displayName":"contact","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object","removed":false},{"id":"agentName","displayName":"agentName","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsappId","displayName":"whatsappId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"messageId","displayName":"messageId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-2400,1056],"id":"9a3a6db9-7da4-4431-8d6b-f21a2a14a615","name":"Call 'ü§ñü§ñ Alicia: Transferir e gerar Resumo'"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-2864,1056],"id":"d5d38d62-8ad3-4715-842e-db5e7e0b0a55","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"promptType":"define","text":"=### [CONTEXTO]\n- [HIST√ìRICO DE CONVERSA - √öLTIMAS 8 MENSAGENS TROCADAS EM ORDEM CRESCENTE]\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"\" }}\n\n### [DADOS DO PROCESSO]\n- **EST√ÅGIO:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.currentStageId) }}\n- **VARI√ÅVEIS FALTANTES:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.missingVars) }}\n- **DADOS J√Å REGISTRADOS:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.vars) }}\n- **ULTIMA PERGUNTA DO ROB√î (IA):** \"{{ $('Pega ultimas mensagens').first().json.message.content }}\"\n- **MENSAGEM DO USU√ÅRIO:** \"{{ $('BLUEPRINT ENGINE').first().json.userMsg }}\"\n- **√öLTIMA VARI√ÅVEL SOLICITADA:** {{ JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=### [PERFIL - IDENTIDADE]\nVoc√™ √© um extrator de dados baseado em contexto de conversa e inten√ß√£o de humano. Sua fun√ß√£o √© converter mensagens em JSON seguindo estritamente as regras de nexo entre a fala do humano e a `description` das vari√°veis fornecidas dinamicamente.\n\n### [ORDEM DE EXECU√á√ÉO - AUDITOR DE DADOS]\n1. **AN√ÅLISE DE CONTEXTO:** Compare a [MENSAGEM DO humano] com os [DADOS J√Å REGISTRADOS] e a [ULTIMA PERGUNTA DO ROB√î].\n2. **VARREDURA EXAUSTIVA:** N√£o pare na primeira informa√ß√£o. Analise cada frase da mensagem de forma isolada e conjunta.\n3. **FILTRO DE INTEN√á√ÉO (CONTEXTO DE REA√á√ÉO):** Identifique se o humano est√° respondendo ao **coment√°rio/rea√ß√£o** do rob√¥ (Alvo Assertivo) ou √† **pergunta de extra√ß√£o** (Alvo de Extra√ß√£o). Se o nexo for com a empatia/opini√£o da IA, a extra√ß√£o √© PROIBIDA.\n\n### [REGRAS CR√çTICAS DE EXTRA√á√ÉO - TOLER√ÇNCIA ZERO]\n\n1. **LITERALIDADE E NEXO (REGRA DE DIAMANTE):**\n   - S√≥ extraia valores se houver evid√™ncia textual clara ou sin√¥nimo direto que satisfa√ßa a `description` da vari√°vel faltante.\n   - **PROIBI√á√ÉO DE INFER√äNCIA:** Proibido assumir inten√ß√µes globais (ex: sauda√ß√µes ou frases gen√©ricas de interesse) como resposta para vari√°veis espec√≠ficas, a menos que a `description` da vari√°vel pe√ßa exatamente isso.\n\n2. **MAPEAMENTO DE OPTIONS E VALORES INV√ÅLIDOS:**\n   - Se a vari√°vel possuir `options`, compare o sentido da fala com as chaves dispon√≠veis.\n   - Se a fala se encaixar na descri√ß√£o de uma chave \"invalid_option\", voc√™ DEVE extrair essa chave obrigatoriamente.\n\n3. **DEPEND√äNCIAS E REGRAS DE CAMPO:**\n   - Se a `description` de uma vari√°vel exigir a atribui√ß√£o autom√°tica de um valor em outra vari√°vel (regras condicionais injetadas), execute a l√≥gica de depend√™ncia rigorosamente.\n\n4. **ESTIMATIVA, CORRE√á√ÉO E SOBREPOSI√á√ÉO:**\n   - **Estimativa:** Valores incertos, mas num√©ricos/objetivos, devem ser extra√≠dos.\n   - **Corre√ß√£o:** Se a mensagem contradizer dados salvos, extraia o novo valor para sobreposi√ß√£o.\n\n5. **ADIAMENTO E RECUSA (ALTA PRIORIDADE):**\n   - Se o humano indicar que \"n√£o sabe agora\", \"precisa verificar\" ou \"responde depois\", extraia obrigatoriamente o valor \"answer_later\" para a vari√°vel em quest√£o.\n   - Se o humano se recusa fornecer a informa√ß√£o de expl√≠cita (por privacidade ou grosseria), extraia \"not_provided\".\n\n6. **VALIDA√á√ÉO DE CONSIST√äNCIA SEM√ÇNTICA:**\n   - O l√©xico da resposta deve pertencer ao mesmo dom√≠nio sem√¢ntico da `description`. Se o humano nega algo fora do contexto da pergunta, ignore a extra√ß√£o.\n\n### [SA√çDA OBRIGAT√ìRIA]\n- Retorne APENAS o JSON puro. Proibido adicionar explica√ß√µes, marca√ß√µes de markdown ou pensamentos (thoughts).\n- Se nenhum dado for extra√≠do ou corrigido com base nas descri√ß√µes fornecidas, retorne `{}`.\n- Formato: `{ \"nome_da_variavel\": valor_extraido }`\n\n---\n\n### [DADOS PARA PROCESSAMENTO]\n- **HIST√ìRICO:** {{ $json.historyMessages }}\n- **EST√ÅGIO:** {{ $json.currentStageId }}\n- **VARI√ÅVEIS FALTANTES:** {{ JSON.stringify($json.missingVars) }}\n- **DADOS J√Å REGISTRADOS:** {{ JSON.stringify($json.vars) }}\n- **ULTIMA PERGUNTA IA:** {{ $json.lastAiMessage }}\n- **MENSAGEM humano:** {{ $json.userMsg }}"}]}},"id":"93393787-a415-41a6-9ca6-07c534846ccb","name":"Extrator chain","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[-5312,768]},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"description\": \"Objeto JSON contendo as chaves das vari√°veis encontradas e seus respectivos valores.\",\n  \"additionalProperties\": {\n    \"oneOf\": [\n      {\n        \"type\": \"string\"\n      },\n      {\n        \"type\": \"number\"\n      },\n      {\n        \"type\": \"boolean\"\n      },\n      {\n        \"type\": \"null\"\n      },\n      {\n        \"type\": \"array\",\n        \"items\": {\n          \"type\": \"string\"\n        }\n      }\n    ]\n  }\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-5152,960],"id":"4847ae19-629b-4995-a6b1-34198627b1bc","name":"Structured Output Parser2"},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-5344,960],"id":"85382ca9-a01f-43ba-b7d0-86a3946a40c4","name":"Google Gemini Chat Model1","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"modelName":"models/gemini-2.5-flash-lite","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-1760,928],"id":"48f094b0-52ac-4c71-8e6d-33d0f9d9cdad","name":"Google Gemini Chat Model2","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[1056,336],"id":"ca3cbd5f-1915-407f-bb06-b1437dbdea6f","name":"Google Gemini Chat Model3","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"48a523f6-7f86-4dcc-b471-f92cc29466af","leftValue":"={{ $json.output?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2064,768],"id":"4a047bc0-61fc-42fa-9963-8fdfce2523a8","name":"Se gerou resposta"},{"parameters":{"operation":"get","propertyName":"processing","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-7248,784],"id":"7cf56e0d-b219-4a07-81d4-79c08d784adc","name":"Busca mensagens em processamento","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b4cef1ab-9dcd-4800-81a6-64a49ab6d517","leftValue":"={{ $json.processing?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-7040,784],"id":"de446f33-7f76-4658-9051-a11024a92fc6","name":"Se n√£o tem mensagem sendo processada"},{"parameters":{"jsCode":"const messages = $input.first().json.messages || [];\nconst fullText = messages.map(m => m.message).join('\\n');\n\nreturn {\n  user_full_message: fullText,\n  cache_key: $('Configura Contexto').first().json.cache_key\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-7488,784],"id":"ec726778-0160-4d64-af1e-f2ebc5cc8456","name":"CONCATENA1"},{"parameters":{"operation":"set","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($('Junta mensagem do cache com a mensagem do usu√°rio').first().json.messages) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-6816,768],"id":"be4513c1-3a6a-4edf-8a56-92756bb9ab97","name":"Seta mensagem em processamento no cache","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($('Junta mensagem do cache com a mensagem do usu√°rio').first().json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-6816,1104],"id":"3cdb552d-5da0-4ecc-85d5-de581af91411","name":"SETA CACHE DAS MENSAGENS1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1408,752],"id":"a0a65b3c-5936-43f6-9c12-aa37a9da0a90","name":"Remove mensagens do processamento","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"id","value":"={{ $('Insere mensagem do usu√°rio no BD').first().json.id }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[80,1424],"id":"b0d78cfa-92fc-432b-b376-be70fee37e1e","name":"Delete table or rows","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"set","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","value":"={{ $('GET Estado Atual').first().json.propertyName }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-144,1424],"id":"9a1885ca-76f2-4c14-b7bd-35e7f34d8c94","name":"Volta para o estado anterior","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8320,560],"id":"e8355c6c-13a8-428e-b5c9-144dbb3ea297","name":"Deleta mensagem em processamento","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1744,1104],"id":"4a71e4fc-6ff7-4065-bdc8-e503e2554117","name":"Remove mensagens do processamento1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-5904,2656],"id":"16a4bacf-c6f5-4ca2-abe3-aa98dbce9811","name":"Google Gemini Chat Model4","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"promptType":"define","text":"=### [CONTEXTO]\n- [HIST√ìRICO DE CONVERSA - √öLTIMAS 8 MENSAGENS TROCADAS EM ORDEM CRESCENTE]\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"\" }}\n\n### [DADOS DO PROCESSO]\n- **EST√ÅGIO:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.currentStageId) }}\n- **VARI√ÅVEIS FALTANTES:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.missingVars) }}\n- **DADOS J√Å REGISTRADOS:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.vars) }}\n- **ULTIMA PERGUNTA DO ROB√î (IA):** \"{{ $('Pega ultimas mensagens').first().json.message.content }}\"\n- **MENSAGEM DO USU√ÅRIO:** \"{{ $('BLUEPRINT ENGINE').first().json.userMsg }}\"\n- **√öLTIMA VARI√ÅVEL SOLICITADA:** {{ JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=### [PERFIL - IDENTIDADE]\nVoc√™ √© um extrator de dados baseado em contexto de conversa e inten√ß√£o de usu√°rio. Sua fun√ß√£o √© converter mensagens em JSON seguindo estritamente as regras de nexo entre a fala do usu√°rio e a `description` das vari√°veis fornecidas dinamicamente.\n\n### [ORDEM DE EXECU√á√ÉO - AUDITOR DE DADOS]\n1. **AN√ÅLISE DE CONTEXTO:** Compare a [MENSAGEM DO USU√ÅRIO] com os [DADOS J√Å REGISTRADOS] e a [ULTIMA PERGUNTA DO ROB√î].\n2. **VARREDURA EXAUSTIVA:** N√£o pare na primeira informa√ß√£o. Analise cada frase da mensagem de forma isolada e conjunta.\n3. **FILTRO DE INTEN√á√ÉO (CONTEXTO DE REA√á√ÉO):** Identifique se o usu√°rio est√° respondendo ao **coment√°rio/rea√ß√£o** do rob√¥ (Alvo Assertivo) ou √† **pergunta de extra√ß√£o** (Alvo de Extra√ß√£o). Se o nexo for com a empatia/opini√£o da IA, a extra√ß√£o √© PROIBIDA.\n\n### [REGRAS CR√çTICAS DE EXTRA√á√ÉO - TOLER√ÇNCIA ZERO]\n\n1. **LITERALIDADE E NEXO (REGRA DE DIAMANTE):**\n   - S√≥ extraia valores se houver evid√™ncia textual clara ou sin√¥nimo direto que satisfa√ßa a `description` da vari√°vel faltante.\n   - **PROIBI√á√ÉO DE INFER√äNCIA:** Proibido assumir inten√ß√µes globais (ex: sauda√ß√µes ou frases gen√©ricas de interesse) como resposta para vari√°veis espec√≠ficas, a menos que a `description` da vari√°vel pe√ßa exatamente isso.\n\n2. **MAPEAMENTO DE OPTIONS E VALORES INV√ÅLIDOS:**\n   - Se a vari√°vel possuir `options`, compare o sentido da fala com as chaves dispon√≠veis.\n   - Se a fala se encaixar na descri√ß√£o de uma chave \"invalid_option\", voc√™ DEVE extrair essa chave obrigatoriamente.\n\n3. **DEPEND√äNCIAS E REGRAS DE CAMPO:**\n   - Se a `description` de uma vari√°vel exigir a atribui√ß√£o autom√°tica de um valor em outra vari√°vel (regras condicionais injetadas), execute a l√≥gica de depend√™ncia rigorosamente.\n\n4. **ESTIMATIVA, CORRE√á√ÉO E SOBREPOSI√á√ÉO:**\n   - **Estimativa:** Valores incertos, mas num√©ricos/objetivos, devem ser extra√≠dos.\n   - **Corre√ß√£o:** Se a mensagem contradizer dados salvos, extraia o novo valor para sobreposi√ß√£o.\n\n5. **ADIAMENTO E RECUSA (ALTA PRIORIDADE):**\n   - Se o usu√°rio indicar que \"n√£o sabe agora\", \"precisa verificar\" ou \"responde depois\", extraia obrigatoriamente o valor \"answer_later\" para a vari√°vel em quest√£o.\n   - Se houver recusa expl√≠cita por privacidade ou grosseria, extraia \"not_provided\".\n\n6. **VALIDA√á√ÉO DE CONSIST√äNCIA SEM√ÇNTICA:**\n   - O l√©xico da resposta deve pertencer ao mesmo dom√≠nio sem√¢ntico da `description`. Se o usu√°rio nega algo fora do contexto da pergunta, ignore a extra√ß√£o.\n\n### [SA√çDA OBRIGAT√ìRIA]\n- Retorne APENAS o JSON puro. Proibido adicionar explica√ß√µes, marca√ß√µes de markdown ou pensamentos (thoughts).\n- Se nenhum dado for extra√≠do ou corrigido com base nas descri√ß√µes fornecidas, retorne `{}`.\n- Formato: `{ \"nome_da_variavel\": valor_extraido }`\n\n---\n\n### [DADOS PARA PROCESSAMENTO]\n- **HIST√ìRICO:** {{ $json.historyMessages }}\n- **EST√ÅGIO:** {{ $json.currentStageId }}\n- **VARI√ÅVEIS FALTANTES:** {{ JSON.stringify($json.missingVars) }}\n- **DADOS J√Å REGISTRADOS:** {{ JSON.stringify($json.vars) }}\n- **ULTIMA PERGUNTA IA:** {{ $json.lastAiMessage }}\n- **MENSAGEM USU√ÅRIO:** {{ $json.userMsg }}"}]}},"id":"b6c2f1ab-afe8-4411-94eb-11944d9649db","name":"Gera mensagem de follow-up2","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[-5872,2464]},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"hasQuestion\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se o usu√°rio fez uma pergunta t√©cnica ou comercial que exige consulta √† base de conhecimento.\"\n    },\n    \"searchQuery\": {\n      \"type\": \"string | null\",\n      \"description\": \"Uma frase curta e descritiva otimizada para busca sem√¢ntica, unindo a d√∫vida do usu√°rio com o contexto da conversa (substituindo pronomes pelo assunto real).\"\n    }\n  },\n  \"required\": [\"hasQuestion\", \"searchQuery\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-4256,976],"id":"2a8ab6f3-a500-413d-8c57-470b90a56b4a","name":"Parser Router"},{"parameters":{"promptType":"define","text":"=# SYSTEM: Engenheiro de Busca Contextual (Universal RAG Router)\n\nSua miss√£o √© atuar como um middleware de intelig√™ncia anal√≠tica. Voc√™ deve processar a intera√ß√£o entre o usu√°rio e o assistente para decidir se existe uma demanda de conhecimento externo e reconstruir essa demanda em uma consulta autocontida.\n\n### [CONTEXTO ANAL√çTICO]\n- **MENSAGEM ATUAL:** \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n- **HIST√ìRICO RECENTE:**\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"Sem hist√≥rico.\" }}\n\n### [ALGORITMO DE RACIOC√çNIO - EXECU√á√ÉO OBRIGAT√ìRIA]\n\n1. **MAPEAMENTO DE ENTIDADES (CONTEXTO):** Varra o [HIST√ìRICO RECENTE] em busca do √∫ltimo substantivo t√©cnico, produto, servi√ßo ou regra de neg√≥cio que foi o foco da fala da IA ou do usu√°rio. Esta √© a sua \"Entidade de Dom√≠nio\".\n\n2. **AN√ÅLISE DE INTEN√á√ÉO (TRIAGEM):** Avalie se a [MENSAGEM ATUAL] busca fatos, explica√ß√µes, valores, capacidades ou procedimentos sobre a Entidade de Dom√≠nio identificada.\n\n   2.1 **TRAVA DE ENTENDIMENTO (EXCE√á√ÉO PRIORIT√ÅRIA):**\n   Se a [MENSAGEM ATUAL] for uma pergunta que apenas pede esclarecimento do que a IA acabou de perguntar, ou confirma o escopo da pergunta anterior (ex.: \"contando s√≥ X ou Y?\", \"√© s√≥ X?\", \"inclui Y tamb√©m?\", \"quando voc√™ diz X, quer dizer o qu√™?\"), ent√£o isso N√ÉO √© demanda de conhecimento externo.\n   - Nesse caso: `hasQuestion = FALSE` e `searchQuery = null`.\n   - Regra: essa exce√ß√£o tem prioridade sobre qualquer outra classifica√ß√£o abaixo.\n   - **hasQuestion = TRUE:** Se a mensagem for uma pergunta direta, uma contesta√ß√£o (\"Mas por que?\") ou uma busca por detalhes t√©cnicos/comerciais.\n   - **hasQuestion = FALSE:** Se a mensagem for apenas um fornecimento de dado pessoal, uma sauda√ß√£o, uma rea√ß√£o emocional ou uma confirma√ß√£o de fluxo (Sim/N√£o/Ok).\n\n3. **S√çNTESE DE CONSULTA (SEARCH QUERY):** Se `hasQuestion` for true, voc√™ deve gerar uma frase de busca que seja **totalmente autocontida**.\n   - **Regra de Autossufici√™ncia:** A frase deve ser compreens√≠vel para um estranho que n√£o leu o hist√≥rico da conversa.\n   - **T√©cnica de Expans√£o:** Substitua pronomes e termos vagos (isso, aquilo, como faz, quanto √©) pelos termos t√©cnicos e nomes reais encontrados no hist√≥rico.\n   - **F√≥rmula L√≥gica:** [Nome Exato da Entidade/Produto] + [A√ß√£o ou Atributo Desejado (Pre√ßo, Funcionamento, Regra, Integra√ß√£o)].\n   - **Otimiza√ß√£o:** Remova qualquer ru√≠do social (Bom dia, obrigado, opa) e foque em termos que apareceriam em um √≠ndice de documenta√ß√£o t√©cnica.\n\n### [REGRAS DE SA√çDA - DETERMIN√çSTICO]\n- **hasQuestion (boolean):** TRUE para necessidades de consulta ao RAG; FALSE para continuidade conversacional.\n- **searchQuery (string):** A string de busca sintetizada e expandida. Caso `hasQuestion` seja false, retorne obrigatoriamente `null`.\n\n### [SA√çDA OBRIGAT√ìRIA - JSON PURO]\nResponda EXCLUSIVAMENTE com o objeto JSON. √â terminantemente proibido incluir blocos de c√≥digo markdown (```json), explica√ß√µes ou qualquer texto fora das chaves.\n\n{ \n  \"hasQuestion\": boolean, \n  \"searchQuery\": \"string ou null\" \n}","hasOutputParser":true,"options":{"systemMessage":"Voc√™ √© um classificador de inten√ß√£o bin√°rio."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-4400,752],"id":"585c27a4-5526-4192-8c4a-0e3112570c25","name":"Router de D√∫vida","executeOnce":true,"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"check-question","leftValue":"={{ $json.output.hasQuestion }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3936,752],"id":"776871bd-6654-44df-9a47-aadb03225039","name":"Tem D√∫vida?"},{"parameters":{"mode":"load","tableName":"n8","prompt":"={{ $json.output.searchQuery }}","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[-3584,496],"id":"1ae2d944-78ed-4c6f-945a-b199121140f1","name":"Consulta Base Conhecimento","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-3584,672],"id":"4d3f68de-d649-477b-b829-b78c197a54ee","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"jsCode":"return {\n  rag_context: $input.all().map(d => d.json.document.pageContent)\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3232,496],"id":"4ae74eae-a766-4cb4-856f-cf607b4df5d0","name":"RAG CONTEXT","executeOnce":true},{"parameters":{"jsCode":"return {\n  rag_context: $json.rag_context\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2960,768],"id":"65442d31-4aa8-4098-899b-67e9a549ee0a","name":"MERGE DADOS"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini-2024-07-18","mode":"list","cachedResultName":"gpt-4o-mini-2024-07-18"},"builtInTools":{},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[-4432,976],"id":"1de705d0-bf41-4110-ace6-fa16fe486c7e","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}}],"connections":{"Parser Router1":{"ai_outputParser":[[{"node":"Follow-up Router","type":"ai_outputParser","index":0}]]},"OpenAI Router1":{"ai_languageModel":[[{"node":"Follow-up Router","type":"ai_languageModel","index":0}]]},"Follow-up Router":{"main":[[{"node":"Se o usu√°rio est√° tentando agendar uma re-chamada","type":"main","index":0}]]},"Se o usu√°rio est√° tentando agendar uma re-chamada":{"main":[[{"node":"Busca Follow Up1","type":"main","index":0}],[{"node":"Se for uma confirma√ß√£o passiva","type":"main","index":0}]]},"Envia WhatsApp":{"main":[[{"node":"Se o usu√°rio informou uma data de re-chamada","type":"main","index":0}]]},"Insere mensagem da IA no BD2":{"main":[[{"node":"Envia WhatsApp","type":"main","index":0}]]},"Se o usu√°rio informou uma data de re-chamada":{"main":[[{"node":"Envia para parser com o chrono-node","type":"main","index":0}]]},"Busca Follow Up1":{"main":[[{"node":"Se j√° existe follow-up2","type":"main","index":0}]]},"Se j√° existe follow-up2":{"main":[[{"node":"Desativa follow-up","type":"main","index":0}],[{"node":"Insere mensagem da IA no BD2","type":"main","index":0}]]},"Desativa follow-up":{"main":[[{"node":"Insere mensagem da IA no BD2","type":"main","index":0}]]},"Se j√° existe follow-up3":{"main":[[{"node":"Atualiza follow-up1","type":"main","index":0}],[{"node":"Insere novo follow-up1","type":"main","index":0}]]},"Envia para parser com o chrono-node":{"main":[[{"node":"Se j√° existe follow-up3","type":"main","index":0}]]},"Se for uma confirma√ß√£o passiva":{"main":[[{"node":"Se existe resposta","type":"main","index":0}]]},"Insere mensagem da IA no BD3":{"main":[[{"node":"Envia WhatsApp2","type":"main","index":0}]]},"Se existe resposta":{"main":[[{"node":"Insere mensagem da IA no BD3","type":"main","index":0}]]},"Planner de Conte√∫do (L√≥gico)":{"main":[[{"node":"Redator de Persona","type":"main","index":0}]]},"Base de conhecimento1":{"ai_tool":[[{"node":"Planner de Conte√∫do (L√≥gico)","type":"ai_tool","index":0}]]},"Embeddings OpenAI3":{"ai_embedding":[[{"node":"Base de conhecimento1","type":"ai_embedding","index":0}]]},"DeepSeek Model2":{"ai_languageModel":[[{"node":"Planner de Conte√∫do (L√≥gico)","type":"ai_languageModel","index":0},{"node":"Redator de Persona","type":"ai_languageModel","index":0}]]},"DeepSeek Model5":{"ai_languageModel":[[{"node":"Gerador de Resposta1","type":"ai_languageModel","index":0}]]},"Embeddings OpenAI5":{"ai_embedding":[[{"node":"Base de conhecimento3","type":"ai_embedding","index":0}]]},"Base de conhecimento3":{"ai_tool":[[{"node":"Gerador de Resposta1","type":"ai_tool","index":0}]]},"Enviar para um especialista1":{"ai_tool":[[{"node":"Gerador de Resposta1","type":"ai_tool","index":0}]]},"Split de mensagens":{"main":[[{"node":"LOOP_SLIT1","type":"main","index":0}]]},"Se n√£o recebeu mensagem no meio do processamento":{"main":[[{"node":"Split de mensagens","type":"main","index":0}],[{"node":"Concatena mensagens para cache","type":"main","index":0}]]},"GET2":{"main":[[{"node":"Se n√£o recebeu mensagem no meio do processamento","type":"main","index":0}]]},"Salva Novo Estado":{"main":[[{"node":"Router de D√∫vida","type":"main","index":0}]]},"Parser  Chain1":{"main":[[{"node":"Remove mensagens do processamento","type":"main","index":0}]]},"OutputParser":{"ai_outputParser":[[{"node":"Parser  Chain1","type":"ai_outputParser","index":0}]]},"output1":{"main":[[{"node":"Se gerou resposta","type":"main","index":0}]]},"WAIT_SPLIT1":{"main":[[{"node":"LOOP_SLIT1","type":"main","index":0}]]},"LOOP_SLIT1":{"main":[[{"node":"Switch","type":"main","index":0},{"node":"Busca estado atual para follow-up","type":"main","index":0}],[{"node":"GET3","type":"main","index":0}]]},"Envia WhatsApp1":{"main":[[{"node":"WAIT_SPLIT1","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Configura Contexto","type":"main","index":0}]]},"Configura Contexto":{"main":[[{"node":"If2","type":"main","index":0}]]},"GET Estado Atual":{"main":[[{"node":"BLUEPRINT ENGINE","type":"main","index":0}]]},"BLUEPRINT ENGINE":{"main":[[{"node":"Pega ultimas mensagens","type":"main","index":0}]]},"LOGIC ENGINE":{"main":[[{"node":"Salva Novo Estado","type":"main","index":0}]]},"Gerador de Resposta":{"main":[[{"node":"output1","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"DELETE1":{"main":[[{"node":"CONCATENA1","type":"main","index":0}]]},"SWITCH_BUFFER":{"main":[[{"node":"DELETE1","type":"main","index":0}],[{"node":"NADA1","type":"main","index":0}],[{"node":"Wait1","type":"main","index":0}]]},"If2":{"main":[[{"node":"Deleta estado atual","type":"main","index":0}],[{"node":"Busca mensagens no cache","type":"main","index":0}]]},"Delete table or rows1":{"main":[[{"node":"DELETE2","type":"main","index":0}]]},"Deleta estado atual":{"main":[[{"node":"Delete table or rows1","type":"main","index":0}]]},"DELETE2":{"main":[[{"node":"Remove follow-ups","type":"main","index":0}]]},"Concatena mensagens para cache":{"main":[[{"node":"RE-SETA CACHE DAS MENSAGENS ACUMULADAS","type":"main","index":0}]]},"Transforma em objeto literal":{"main":[[{"node":"SWITCH_BUFFER","type":"main","index":0}]]},"Transfere ticket para Aguardando Apre.Chat":{"main":[[{"node":"Busca hist√≥rico de conversa1","type":"main","index":0}]]},"Formata hist√≥rico1":{"main":[[{"node":"Gera resumo da conversa - AI1","type":"main","index":0}]]},"Gera resumo da conversa - AI1":{"main":[[{"node":"Salva nota na conversa1","type":"main","index":0}]]},"Busca hist√≥rico de conversa1":{"main":[[{"node":"Formata hist√≥rico1","type":"main","index":0}]]},"Busca mensagens no cache":{"main":[[{"node":"Junta mensagem do cache com a mensagem do usu√°rio","type":"main","index":0}]]},"Junta mensagem do cache com a mensagem do usu√°rio":{"main":[[{"node":"SETA CACHE DAS MENSAGENS","type":"main","index":0}]]},"SETA CACHE DAS MENSAGENS":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"BUSCA MENSAGENS ACUMULADAS":{"main":[[{"node":"Transforma em objeto literal","type":"main","index":0}]]},"Pega ultimas mensagens":{"main":[[{"node":"Formata ultimas mensagens","type":"main","index":0}]]},"Formata ultimas mensagens":{"main":[[{"node":"Seta perfil1","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Transfere ticket para Aguardando Apre.Chat","type":"main","index":0}],[{"node":"Transfere ticket para Aguardando Apre.Chat","type":"main","index":0}],[{"node":"Call 'Enviar apresenta√ß√£o comercial'","type":"main","index":0}]]},"Call 'Enviar apresenta√ß√£o comercial'":{"main":[[{"node":"Transfere ticket para Aguardando Apre.Chat","type":"main","index":0}]]},"Base de conhecimento":{"ai_tool":[[{"node":"Gerador de Resposta","type":"ai_tool","index":0}]]},"Embeddings OpenAI2":{"ai_embedding":[[{"node":"Base de conhecimento","type":"ai_embedding","index":0}]]},"Insere mensagem da IA no BD":{"main":[[{"node":"Envia WhatsApp1","type":"main","index":0}]]},"GET3":{"main":[[{"node":"Se n√£o recebeu mensagem no meio do processamento1","type":"main","index":0}]]},"Se n√£o recebeu mensagem no meio do processamento1":{"main":[[{"node":"Insere mensagem da IA no BD","type":"main","index":0}]]},"Busca estado atual para follow-up":{"main":[[{"node":"Busca Follow Up","type":"main","index":0}]]},"Busca Follow Up":{"main":[[{"node":"Se j√° existe follow-up","type":"main","index":0}]]},"Se j√° existe follow-up":{"main":[[{"node":"Atualiza follow-up","type":"main","index":0}],[{"node":"Insere novo follow-up","type":"main","index":0}]]},"Seta perfil1":{"main":[[{"node":"Insere mensagem do usu√°rio no BD","type":"main","index":0}]]},"Insere mensagem do usu√°rio no BD":{"main":[[{"node":"Extrator chain","type":"main","index":0}]]},"Parser Router2":{"ai_outputParser":[[{"node":"Follow-up Router1","type":"ai_outputParser","index":0}]]},"OpenAI Router2":{"ai_languageModel":[[{"node":"Follow-up Router1","type":"ai_languageModel","index":0}]]},"Follow-up Router1":{"main":[[{"node":"Se o usu√°rio est√° tentando agendar uma re-chamada1","type":"main","index":0}]]},"Se o usu√°rio est√° tentando agendar uma re-chamada1":{"main":[[{"node":"Busca Follow Up2","type":"main","index":0}],[{"node":"Se for uma confirma√ß√£o passiva1","type":"main","index":0}]]},"Envia WhatsApp3":{"main":[[{"node":"Se o usu√°rio informou uma data de re-chamada1","type":"main","index":0}]]},"Insere mensagem da IA no BD5":{"main":[[{"node":"Envia WhatsApp3","type":"main","index":0}]]},"Se o usu√°rio informou uma data de re-chamada1":{"main":[[{"node":"Envia para parser com o chrono-node1","type":"main","index":0}]]},"Busca Follow Up2":{"main":[[{"node":"Se j√° existe follow-up4","type":"main","index":0}]]},"Se j√° existe follow-up4":{"main":[[{"node":"Desativa follow-up1","type":"main","index":0}],[{"node":"Insere mensagem da IA no BD5","type":"main","index":0}]]},"Desativa follow-up1":{"main":[[{"node":"Insere mensagem da IA no BD5","type":"main","index":0}]]},"Se j√° existe follow-up5":{"main":[[{"node":"Atualiza follow-up2","type":"main","index":0}],[{"node":"Insere novo follow-up2","type":"main","index":0}]]},"Envia para parser com o chrono-node1":{"main":[[{"node":"Se j√° existe follow-up5","type":"main","index":0}]]},"Se for uma confirma√ß√£o passiva1":{"main":[[{"node":"Se existe resposta1","type":"main","index":0}]]},"Insere mensagem da IA no BD6":{"main":[[{"node":"Envia WhatsApp4","type":"main","index":0}]]},"Se existe resposta1":{"main":[[{"node":"Insere mensagem da IA no BD6","type":"main","index":0}]]},"Cron 1em1 min - FOLLOW-UP":{"main":[[{"node":"Code in JavaScript","type":"main","index":0}]]},"Busca follow-ups dispon√≠veis":{"main":[[{"node":"Wait","type":"main","index":0}]]},"LOOP nos follow-up's":{"main":[[],[{"node":"BUSCA MENSAGENS ACUMULADAS1","type":"main","index":0}]]},"Busca estado atual da conversa":{"main":[[{"node":"Transforma estado atual em JSON literal","type":"main","index":0}]]},"Transforma estado atual em JSON literal":{"main":[[{"node":"Switch tipo de follow-up","type":"main","index":0}]]},"Se o usu√°rio respondeu a vari√°vel pendente no meio do caminho":{"main":[[],[{"node":"Pega ultimas mensagens1","type":"main","index":0}]]},"Envia via Apre.Chat":{"main":[[{"node":"Pega novo horario de follow-up pelos attempts","type":"main","index":0}]]},"Pega ultimas mensagens1":{"main":[[{"node":"Formata ultimas mensagens1","type":"main","index":0}]]},"Formata ultimas mensagens1":{"main":[[{"node":"Se a √∫ltima mensagem foi da IA","type":"main","index":0}]]},"BUSCA MENSAGENS ACUMULADAS1":{"main":[[{"node":"Se chegou alguma mensagem do usu√°rio","type":"main","index":0}]]},"Se chegou alguma mensagem do usu√°rio":{"main":[[],[{"node":"Busca estado atual da conversa","type":"main","index":0}]]},"Wait":{"main":[[{"node":"LOOP nos follow-up's","type":"main","index":0}]]},"Switch tipo de follow-up":{"main":[[{"node":"Pega ultimas mensagens2","type":"main","index":0}],[{"node":"Busca ticket no Apre.Chat","type":"main","index":0}]]},"Pega ultimas mensagens2":{"main":[[{"node":"Formata ultimas mensagens2","type":"main","index":0}]]},"Formata ultimas mensagens2":{"main":[[{"node":"Gera mensagem de follow-up1","type":"main","index":0}]]},"Se a √∫ltima mensagem foi da IA":{"main":[[{"node":"Gera mensagem de follow-up2","type":"main","index":0}]]},"Gera mensagem de follow-up1":{"main":[[{"node":"Envia via Apre.Chat1","type":"main","index":0}]]},"Envia via Apre.Chat1":{"main":[[{"node":"Atualiza tentativa de follow-up","type":"main","index":0}]]},"Atualiza tentativas de follow-up":{"main":[[{"node":"Insere mensagem da IA no BD1","type":"main","index":0}]]},"Atualiza tentativa de follow-up":{"main":[[{"node":"Insere mensagem da IA no BD4","type":"main","index":0}]]},"Code in JavaScript":{"main":[[{"node":"If1","type":"main","index":0}]]},"Pega novo horario de follow-up pelos attempts":{"main":[[{"node":"Atualiza tentativas de follow-up","type":"main","index":0}]]},"If1":{"main":[[{"node":"Busca follow-ups dispon√≠veis","type":"main","index":0}]]},"Busca ticket no Apre.Chat":{"main":[[{"node":"Se o status do ticket n√£o for bot","type":"main","index":0}]]},"Se o status do ticket n√£o for bot":{"main":[[],[{"node":"Se o usu√°rio respondeu a vari√°vel pendente no meio do caminho","type":"main","index":0}]]},"Call 'ü§ñü§ñ Alicia: Transferir e gerar Resumo'":{"ai_tool":[[{"node":"Gerador de Resposta","type":"ai_tool","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"Gerador de Resposta","type":"ai_languageModel","index":0}]]},"Extrator chain":{"main":[[{"node":"LOGIC ENGINE","type":"main","index":0}]]},"Structured Output Parser2":{"ai_outputParser":[[{"node":"Extrator chain","type":"ai_outputParser","index":0}]]},"Google Gemini Chat Model1":{"ai_languageModel":[[{"node":"Extrator chain","type":"ai_languageModel","index":0}]]},"Google Gemini Chat Model2":{"ai_languageModel":[[{"node":"Parser  Chain1","type":"ai_languageModel","index":0}]]},"Google Gemini Chat Model3":{"ai_languageModel":[[{"node":"Gera resumo da conversa - AI1","type":"ai_languageModel","index":0}]]},"Se gerou resposta":{"main":[[{"node":"Parser  Chain1","type":"main","index":0}],[{"node":"Remove mensagens do processamento1","type":"main","index":0}]]},"Busca mensagens em processamento":{"main":[[{"node":"Se n√£o tem mensagem sendo processada","type":"main","index":0}]]},"Se n√£o tem mensagem sendo processada":{"main":[[{"node":"Seta mensagem em processamento no cache","type":"main","index":0}],[{"node":"SETA CACHE DAS MENSAGENS1","type":"main","index":0}]]},"CONCATENA1":{"main":[[{"node":"Busca mensagens em processamento","type":"main","index":0}]]},"Seta mensagem em processamento no cache":{"main":[[{"node":"GET Estado Atual","type":"main","index":0}]]},"Remove mensagens do processamento":{"main":[[{"node":"GET2","type":"main","index":0}]]},"RE-SETA CACHE DAS MENSAGENS ACUMULADAS":{"main":[[{"node":"Volta para o estado anterior","type":"main","index":0}]]},"Volta para o estado anterior":{"main":[[{"node":"Delete table or rows","type":"main","index":0}]]},"Delete table or rows":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"Remove follow-ups":{"main":[[{"node":"Deleta mensagem em processamento","type":"main","index":0}]]},"Google Gemini Chat Model4":{"ai_languageModel":[[{"node":"Gera mensagem de follow-up2","type":"ai_languageModel","index":0}]]},"Gera mensagem de follow-up2":{"main":[[{"node":"Envia via Apre.Chat","type":"main","index":0}]]},"Parser Router":{"ai_outputParser":[[{"node":"Router de D√∫vida","type":"ai_outputParser","index":0}]]},"Router de D√∫vida":{"main":[[{"node":"Tem D√∫vida?","type":"main","index":0}]]},"Tem D√∫vida?":{"main":[[{"node":"Consulta Base Conhecimento","type":"main","index":0}],[{"node":"MERGE DADOS","type":"main","index":0}]]},"Consulta Base Conhecimento":{"main":[[{"node":"RAG CONTEXT","type":"main","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Consulta Base Conhecimento","type":"ai_embedding","index":0}]]},"RAG CONTEXT":{"main":[[{"node":"MERGE DADOS","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Router de D√∫vida","type":"ai_languageModel","index":0}]]},"MERGE DADOS":{"main":[[{"node":"Gerador de Resposta","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Cron 1em1 min":{"recurrenceRules":[]},"node:Cron 1em1 min - FOLLOW-UP":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Cron 1em1 min - FOLLOW-UP":[{"json":{"timestamp":"2026-02-09T17:53:20.006-03:00","Readable date":"February 9th 2026, 5:53:20 pm","Readable time":"5:53:20 pm","Day of week":"Monday","Year":"2026","Month":"February","Day of month":"09","Hour":"17","Minute":"53","Second":"20","Timezone":"America/Sao_Paulo (UTC-03:00)"}}],"Webhook":[{"json":{"headers":{"host":"n8n.apresenta.me","x-real-ip":"104.23.254.172","x-real-port":"16609","x-forwarded-for":"167.234.245.252, 104.23.254.172","x-forwarded-proto":"http","x-forwarded-host":"n8n.apresenta.me","x-forwarded-port":"80","remote-host":"104.23.254.172","connection":"close","content-length":"688","content-type":"application/json","user-agent":"axios/1.12.2","baggage":"sentry-environment=production,sentry-public_key=105feeda45f1e08a6adb966a132a4c34,sentry-trace_id=cd62394ac41fa03d98311b226c060e60,sentry-sampled=false,sentry-sample_rand=0.2142545892530503,sentry-sample_rate=0.2","sentry-trace":"cd62394ac41fa03d98311b226c060e60-5988f356fa1d6605-0","cf-ray":"9ccce7049f751fb4-GRU","accept-encoding":"gzip, br","accept":"application/json, text/plain, */*","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"167.234.245.252","cf-ipcountry":"BR","cf-visitor":"{\"scheme\":\"https\"}"},"params":{},"query":{},"body":{"message":"como fa√ßo?","messageId":"4500481","contact":{"id":"15309","name":"Joaozinho","number":"554788950332","profilePicUrl":"https://pps.whatsapp.net/v/t61.24694-24/425105449_1361615211300388_1143514098522857072_n.jpg?ccb=11-4&oh=01_Q5Aa3wFUCB3Csqm6izZgQ3oUQ4n08h4SQqCrOmmfwPLyNKEo5A&oe=699AEBA3&_nc_sid=5e03e0&_nc_cat=102","createdAt":"2025-04-30T09:26:21.047-03:00","updatedAt":"2026-02-12T11:51:08.784-03:00","email":"","isGroup":false,"companyId":"5005","whatsappId":"208","onlyResponsible":false,"userId":"1","aprePersonId":null,"apreDealId":null,"meta":{"ignoreCheck":true,"ignorePermission":true,"dontSendSocket":false}},"whatsappId":"208","companyId":5005,"ticketId":205224},"webhookUrl":"https://n8n.apresenta.me/webhook/7223c6af-f595-4bc2-b84c-602b8900cd08","executionMode":"production"}}]},"versionId":"8e1d80a6-4d70-4f97-9f51-3f03b8f05432","triggerCount":2,"shared":[{"updatedAt":"2025-11-04T18:47:16.654Z","createdAt":"2025-11-04T18:47:16.654Z","role":"workflow:owner","workflowId":"dDaZdsSmHxktrhjc","projectId":"4ToGMYJEWvvDSbcz"}],"tags":[]}