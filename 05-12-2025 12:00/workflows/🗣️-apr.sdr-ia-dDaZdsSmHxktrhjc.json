{"updatedAt":"2025-12-05T14:47:40.000Z","createdAt":"2025-11-04T18:47:16.651Z","id":"dDaZdsSmHxktrhjc","name":"üó£Ô∏è Apr.SDR IA","active":true,"isArchived":false,"nodes":[{"parameters":{"operation":"delete","key":"={{ $('Cria cache key').item.json.cache_key }}_vars"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-80,-32],"id":"507b7a73-2ceb-4acf-881f-8357dcac9529","name":"Delete cache variaveis","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}},"disabled":true},{"parameters":{"jsCode":"const dataObj = $input.first().json.data;\nlet tableMarkdown = \"| VAR | VALOR | TIPO | INSTRU√á√ÉO |\\n|---|---|---|---|\\n\";\n\nfor (const [key, props] of Object.entries(dataObj)) {\n    // Verifica se existe valor, sen√£o deixa vazio\n    const val = props.value !== undefined ? props.value : ''; \n    \n    // Remove quebras de linha da descri√ß√£o para n√£o quebrar a tabela\n    const desc = props.description.replace(/(\\r\\n|\\n|\\r)/gm, \" \"); \n\n    tableMarkdown += `| ${key} | ${val} | ${props.type} | ${desc} |\\n`;\n}\n\nreturn {\n  tableMarkdown\n}; "},"type":"n8n-nodes-base.code","typeVersion":2,"position":[320,-224],"id":"885f5921-927a-4d99-b221-7034f97b25ed","name":"Transforma vari√°veis em tabela"},{"parameters":{"description":"=## TOOL: Busca est√°gio atual\n\nOBJETIVO:\nObter o est√°gio atual da conversa de forma determin√≠stica.\nDar contexto ao momento atual da conversa\n\nQUANDO EXECUTAR:\n- Em cada turno.\n- Sempre deve ser executada ap√≥s a atualiza√ß√£o de vari√°veis no turno, se existir atualiza√ß√£o de variaveis.\n\n","jsCode":"const stages = $('Seta est√°gios').item.json\nconst vars = $('Seta vari√°veis da conversa').item.json.data\nconst stagesEntries = Object.entries(stages)\n\nlet currentStage = null\nlet currentInstruction = null\nlet currentVar = null\nlet isFinalInstruction = null\n\nfor (const [key, value] of stagesEntries) {\n  value.actions.requiredDataForExecute = value.actions.requiredDataForExecute.map(v => {\n    const varValue = vars[v.name].value\n    return {\n      ...v, \n      value: varValue || undefined\n    }\n  })\n  \n  const stagePendingVar = value.actions.requiredDataForExecute.find(v => !v.value)\n\n  if (stagePendingVar) {\n    currentInstruction = stagePendingVar.instruction\n    currentVar = stagePendingVar.name\n    currentStage = {\n      ...value, \n      name: key\n    }\n    break\n  }\n}\n\nreturn JSON.stringify({\n  currentInstruction,\n  currentStage: currentStage.name,\n  currentVar\n})"},"type":"@n8n/n8n-nodes-langchain.toolCode","typeVersion":1.3,"position":[1200,288],"id":"5972975d-cb1e-4aea-a612-a3c89652cea7","name":"Busca est√°gio atual"},{"parameters":{"description":"## TOOL: Enviar apresenta√ß√£o comercial\n**Objetivo:** Finaliza√ß√£o autom√°tica do fluxo de vendas com envio de material.\n\n**QUANDO EXECUTAR ESSA BOSTA -> SEMPRE AUTOMATICAMENTE (CR√çTICO):**\nEsta tool deve ser executada IMEDIATAMENTE no mesmo turno de conversa em que o usu√°rio fornecer a √öLTIMA informa√ß√£o pendente.\n\n**L√ìGICA DE VALIDA√á√ÉO:**\n1. A cada input do usu√°rio, verifique: \"Tenho todas as vari√°veis obrigat√≥rias preenchidas?\"\n2. SE (Todas as vari√°veis == Preenchidas) ENT√ÉO:\n   -> N√ÉO responda ao usu√°rio com texto ainda.\n   -> N√ÉO espere confirma√ß√£o.\n   -> EXECUTE esta tool imediatamente.\n\n**VARI√ÅVEIS NECESS√ÅRIAS PARA DISPARO:**\n(Liste aqui o que define um lead qualificado, ex: [nome, email, telefone, cargo])\n","workflowId":{"__rl":true,"value":"wd0uAb0Sm1fW5YNt","mode":"list","cachedResultUrl":"/workflow/wd0uAb0Sm1fW5YNt","cachedResultName":"Enviar apresenta√ß√£o comercial"},"workflowInputs":{"mappingMode":"defineBelow","value":{"whatsappId":"={{ $('Webhook').item.json.body.whatsappId }}","messageRepliedId":"={{ $('Webhook').item.json.body.messageId }}","message":"={{ $('Seta vari√°veis da conversa').item.json.data.name.value }}, segue em anexo nossa apresenta√ß√£o comercial! Espero que goste do que preparamos. Em breve te chamamos para retomarmos nossa negocia√ß√£o. üöÄ","number":"={{ $('Webhook').item.json.body.contact.number }}","addUserName":"={{ $('Seta perfil').item.json.agentName }}","company":"={{ $('Webhook').item.json.body.contact.companyId }}"},"matchingColumns":[],"schema":[{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"number","displayName":"number","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"addUserName","displayName":"addUserName","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsappId","displayName":"whatsappId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"messageRepliedId","displayName":"messageRepliedId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"company","displayName":"company","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[1040,288],"id":"a3069f45-94db-4d7a-8b86-32eb878d221e","name":"Enviar apresenta√ß√£o comercial"},{"parameters":{"operation":"delete","key":"={{ $json.cache_key }}_stages"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-288,-32],"id":"c34653cc-f2f9-4174-867c-b98b328fab47","name":"Deleta cache estagios","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}},"disabled":true},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Cria cache key').item.json.cache_key }}","contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[976,112],"id":"e2f91358-5f30-470a-8b76-1816f971d530","name":"Postgres Chat Memory","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"set","key":"={{ $('Cria cache key').item.json.cache_key }}_vars","value":"={{ JSON.stringify($('Seta vari√°veis da conversa').item.json)}}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1936,-224],"id":"f8723fc7-0b6b-4885-b98c-8e250da267cc","name":"Seta cache das variaveis","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"={{ $('Cria cache key').first().json.cache_key }}_stages","value":"={{ JSON.stringify($('Seta est√°gios').first().json)}}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1728,-224],"id":"584d44f0-ae03-4cd0-ab82-cd9c586c81c8","name":"Seta cache dos estagios","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"return {\n  chatInput: JSON.stringify($('Webhook').first().json.body.message)\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[928,-224],"id":"6214adc2-a128-43ee-9d17-deb3576a6a05","name":"Retorna chatInput"},{"parameters":{"operation":"get","key":"={{ $('Cria cache key').item.json.cache_key }}_vars","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-80,-224],"id":"43d26b65-1851-4841-a215-88d36ef9ae98","name":"Busca vari√°veis","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"get","key":"={{ $json.cache_key }}_stages","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-288,-224],"id":"d5e39d86-504f-4555-9436-8dee22746105","name":"Busca est√°gios","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"cache_key\": \"sdr_{{ $('Webhook').item.json.body.ticketId }}_chat_summary_{{ $('Webhook').item.json.body.contact.number }}_{{ $('Webhook').item.json.body.whatsappId }}_10\"\n} ","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-496,-224],"id":"ac955ae6-94b1-4e60-a34f-6ce4de25537a","name":"Cria cache key"},{"parameters":{"jsCode":"const cacheStages = $('Busca est√°gios').first().json.propertyName ? JSON.parse($('Busca est√°gios').first().json.propertyName) : undefined\nconst vars = $('Seta vari√°veis da conversa').first().json.data\n\nfunction findVarInstruction(varName){\n    return vars[varName].description\n}\n\nfunction findVarType(varName) {\n  return vars[varName].type\n}\n\nfunction findVarValue(varName) {\n  return vars[varName].value\n}\n\nconst stages = cacheStages ?? {\n  \"Identificar o usuario\": {\n    sortNumber: 1,\n    conditionPrompt: \"Se √© in√≠cio da conversa ou se o usu√°rio ainda n√£o informou o nome dele\",\n    requiredDataForExecute: null,\n    actions: {\n      requiredDataForExecute: [\n        {\n          name: \"name\",\n          value: null\n        }\n      ],\n      actions: null, \n      finalInstructions: \"Agrade√ßa e siga para o pr√≥ximo est√°gio\"\n    }\n  },\n  \"Verificar se trabalha no mercado imobili√°rio\": {\n    sortNumber: \"2\",\n    conditionPrompt: \"Se ja respondeu o nome.\",\n    requiredDataForExecute: null,\n    actions: {\n      requiredDataForExecute: [\n        {\n          name: \"isRealEstate\",\n          value: null\n        }\n      ],\n      actions: null,\n      finalInstructions: \"Perguntar se o lead trabalha no mercado imobili√°rio \\n- Se n√£o trabalhar, retorne para o lead que a Apresenta.me apenas atende pessoas que trabalhem com o mercado imobili√°rio, agrade√ßa pelo interesse e encerre o atendimento educadamente\"\n    }\n  },\n  \"Diagnosticar a necessidade\": {\n    sortNumber: \"3\",\n    conditionPrompt: \"Se voc√™ j√° sabe o nome do lead , e ainda n√£o definiu suas dores, pergunte sobre quais os problemas ele enfrenta e que a Apresenta.me pode ajudar.\",\n    requiredDataForExecute: [\n      {\n        name: \"isRealEstate\", \n        operator: \"exist\",\n        value: null\n      }\n    ],\n    actions: {\n      requiredDataForExecute: [\n        {\n          name: \"customerNeed\",\n          value: null\n        }\n      ],\n      actions: null,\n      finalInstructions: \" \\nAfunile na necessidade espec√≠fica dele, garantindo que voc√™ saiba qual √© a necessidade espec√≠fica que ele tem.  \\n \\nFa√ßa isso atrav√©s de pergunta. Exemplo, se o usu√°rio quer saber sobre algo que possui ramifica√ß√µes nas informa√ß√µes dispon√≠veis, fa√ßa uma pergunta, e se poss√≠vel liste as ramifica√ß√µes / op√ß√µes existentes, para voc√™ saber exatamente onde que o usu√°rio est√° com d√∫vidas, e principalmente quais as d√∫vidas que ele tem quanto ao software da Apresenta.me\"\n    }\n  }, \n  \"Qualificacao\": {\n    sortNumber: \"4\",\n    conditionPrompt: \"Se voc√™ j√° sabe o nome do lead, se ele trabalha no mercado imobili√°rio e se voc√™ j√° sabe as necessidades do lead mas ainda n√£o aprondou-se em tais necessidades.\",\n    requiredDataForExecute: [\n      {\n        name: \"isRealEstate\", \n        operator: \"exist\",\n        value: null\n      }\n    ],\n    actions: {\n      requiredDataForExecute: [\n        {\n          name: \"teamSize\",\n          value: null\n        }, \n        {\n          name: \"workWithRent\",\n          value: null\n        },  \n        {\n          name: \"numberOfBuildings\",\n          value: null\n        },\n        {\n          name: \"currentSystem\",\n          value: null\n        },\n        {\n          name: \"rentalTransferMode\",\n          value: null\n        },\n        {\n          name: \"amountInCurrentSystemOrBudget\",\n          value: null\n        },\n        {\n          name: \"qualificationCompleted\",\n          value: null\n        }\n      ],\n      actions: null,\n      finalInstructions: \"\"\n    }\n  },  \n  \"Enviar Apresentacao em PDF\": {\n    sortNumber: \"5\",\n    conditionPrompt: \"Caso o processo de qualifica√ß√£o esteja finalizado\",\n    requiredDataForExecute: [\n      {\n        name: \"qualificationCompleted\", \n        operator: \"=\",\n        value: true\n      },\n      {\n        name: \"presentationHasSent\", \n        operator: \"!exist\",\n        value: null\n      }\n    ],\n    actions: {\n      requiredDataForExecute: [\n        {\n          name: \"presentationHasSent\",\n          value: null\n        }\n      ],\n      actions: null,\n      finalInstructions: \"\"\n    }\n  }  \n}\n\n// Iterar sobre todos os stages\nObject.keys(stages).forEach(stageKey => {\n  const stage = stages[stageKey];\n  \n  // Verificar se existe actions e requiredDataForExecute\n  if (stage.actions && stage.actions.requiredDataForExecute) {\n    // Iterar sobre cada item de requiredDataForExecute\n    stage.actions.requiredDataForExecute.forEach(item => {\n      // Adicionar a propriedade instructions\n      item.instruction = findVarInstruction(item.name);      \n      item.type = findVarType(item.name)\n      item.value = findVarValue(item.name) || undefined\n    });\n  }\n});\n\nreturn stages;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[720,-224],"id":"4ae0d1cf-f305-43e2-9ce8-e3e19d642215","name":"Seta est√°gios"},{"parameters":{"jsCode":"return {\n  tone: \"Engra√ßado\",\n  agentName: \"Alicia\",\n  internalName: \"Alicia da Apresenta.me\",\n  initialMessage: \"Ol√°, tudo bem? üëã \\n\\nEu sou a Alicia, assistente da Apresenta.me, vou te ajudar entendendo melhor sua necessidade.\",\n  language: \"pt-BR\",\n  timeZone: \"Sao Paulo (GTM -3)\",\n  role: \"SDR S√™nior\",\n  companyName: \"Apresenta.me\",\n  companyDepartment: \"Software\",\n  companySite: \"https://apresenta.me\",\n  conduct: \" \\n### SOBRE SEU PAPEL \\n- Voc√™ √© um SDR, sua Principal fun√ß√£o √© qualificar o lead. para entender se ele tem as caracter√≠sticas do nosso ICP; \\n- Voc√™ ir√° apresentar o sistema da Apresenta.me (https://apresenta.me), um software SAAS para gest√£o completa de imobili√°rias. \\n- Comporte-se exatamente como um representante da empresa, sendo cordial e profissional. \\n \\n \\n### SEU TOM DE VOZ \\n- Responda de maneira simples e objetiva e profissional; \\n- Responda por padr√£o at√© 130 caracteres. S√≥ aumente a resposta quando for estritamente necess√°rio; \\n- Seja emp√°tico e consultivo, nunca agressivo ou invasivo; \\n- Responda com o mesmo tom de voz que o Lead estiver; \\n- Se necess√°rio, utilize emojis como üòÑüëçüè¢üîëüìãüöÄü•≥üå±ü§© etc. \\n- O nome correto do sistema √© Apresenta.me (com ponto), mas fale Apresentame sem pausas; \\n \\n### REGRAS ESPEC√çFICAS \\n- Quando for informar uma URL, informe EXATAMENTE a URL dispon√≠vel \\n- NUNCA fale dos concorrentes de forma negativa \\n- NUNCA saia do personagem \\n- Fa√ßa APENAS UMA pergunta por vez para n√£o sobrecarregar o lead \\n- NUNCA convide para um agendamento de demonstra√ß√£o antes de passar pelo est√°gio de Qualifica√ß√£o \\n- NUNCA direcione para nenhum contato ou link sem antes efetuar a qualifica√ß√£o do lead\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[512,-224],"id":"7063ac92-9336-4db4-8240-4ec6f1de76a7","name":"Seta perfil"},{"parameters":{"jsCode":"const cacheVars = $('Busca vari√°veis').first().json.propertyName ? JSON.parse($('Busca vari√°veis').first().json.propertyName) : undefined\n\nreturn cacheVars ?? {\n  data: {\n    name: {\n      description:\n        \"Se apresente e pergunte o *Nome do usu√°rio*. Pergunte de forma educada e respeitosa.\",\n      type: \"string\",\n    },\n    email: {\n      description:\n        \"Email do usu√°rio para entrar em contato quando houver a necessidade.\",\n      type: \"email\",\n    },\n    customerNeed: {\n      description:\n        \"Show, [NOME DO LEAD]! E hoje, o que mais tem te incomodado ou sentido falta a√≠ na sua \\nimobili√°ria? \\nMuitas vezes ouvimos problemas como sistemas com erros, lentid√£o, suporte demorado, ou at√© dificuldade pra fazer cobran√ßas e relat√≥rios... Mas quero entender no seu caso: o que voc√™ tem sentido falta ou gostaria de melhorar no seu processo de loca√ß√£o, vendas ou atendimento?\",\n      type: \"string[]\",\n    },\n    teamSize: {\n      description:\n        \"E s√≥ pra eu entender melhor quantas pessoas trabalham com voc√™? \\n\\nN√£o mostre as op√ß√µes, deixe aberto para o lead responder , interaja com o lead at√© que ele responda com uma das op√ß√µes abaixo: \\n\\nCorretor Aut√¥nomo \\n2 a 5 \\n6 a 10 \\n11 a 25 \\nMais de 25\",\n      type: \"string\",\n    },\n    numberOfBuildings: {\n      description:\n        \"Quantidade total de im√≥veis na carteira (para venda e loca√ß√£o) voc√™ tem dispon√≠veis para neg√≥cio, (sem considerar os locados ou vendidos) \\n\\nBusque por um n√∫mero \",\n      type: \"number\",\n    },\n    rentalTransferMode: {\n      description:\n        'Caso o lead N√ÉO trabalhe com loca√ß√µes, defina \"N√£o Utiliza\" e n√£o fa√ßa a pergunta! \\n\\n\\nE hoje, como voc√™s fazem as repasse dos valores dos alugu√©is para o propriet√°rio? \\n\\nN√£o mostre as op√ß√µes, deixe aberto para o lead responder , interaja com o lead at√© que ele responda com uma das op√ß√µes abaixo: \\n \\nManual em Dinheiro \\nManualmente via PIX \\nRemessa e Retorno Banc√°rio \\nRepasse Autom√°tico via outro Sistema Imobili√°rio',\n      type: \"string\",\n    },\n    fiscalNote: {\n      description:\n        \"Voc√™ gera notas fiscais para os contratos administrados pela sua imobili√°ria? Se sim, como √© feito o processo de gera√ß√£o dessas notas? Al√©m disso, voc√™ realiza o envio do DIMOB?\",\n      type: \"string\",\n    },\n    workWithRent: {\n      description:\n        \"Hoje voc√™s fazem gest√£o de contratos de loca√ß√£o? Se sim, mais ou menos quantos contratos voc√™s t√™m ativos?\\n\\nN√£o mostre as op√ß√µes, deixe aberto para o lead responder , interaja com o lead at√© que ele responda com uma das op√ß√µes abaixo:\\n\\nN√£o\\nAt√© 10 contratos  \\nDe 10 a 25 contratos  \\nDe 25 a 50 contratos  \\nDe 50 a 100 contratos  \\nDe 100 a 200 contratos  \\nDe 200 a 300 contratos  \\nDe 300 a 500 contratos  \\nMais de 500 contratos\",\n      type: \"string\",\n    },\n    amountInCurrentSystemOrBudget: {\n      description:\n        \"Pra entender se conseguimos te atender bem, quanto voc√™ estaria disposto a investir por m√™s em um sistema pra sua imobili√°ria? \\n(Se preferir, pode estimar um valor aproximado) \\n\\nN√£o mostre as op√ß√µes, deixe aberto para o lead responder , interaja com o lead at√© que ele responda com uma das op√ß√µes abaixo:\\n\\nN√£o quis informar  \\nat√© R$ 100  \\nat√© R$ 300  \\nat√© R$ 500  \\nat√© R$ 800  \\nat√© R$ 1.200  \\nat√© R$ 1.600,00  \\nmais de R$ 1.600,00\",\n      type: \"string\",\n    },\n    currentSystem: {\n      description:\n        \" \\nVoc√™ usa algum sistema hoje para gerenciar sua imobili√°ria? Se sim, qual deles? \\n \\nN√£o mostre as op√ß√µes, deixe aberto para o lead responder , interaja com o lead at√© que ele responda com uma das op√ß√µes abaixo: \\n \\nN√£o Utiliza  \\nAlterdata \\nAlude \\nArbo \\nApp Facilita \\nCasaSoft \\nCode 49 \\nImoAlert \\nImobzi \\nImobia \\nImobi Brasil \\nImopro \\niValue \\nJetImob \\nKenlo \\nMicrosistec \\nNido \\nKurole \\nSigasoft \\nUniversal Imoview \\nVista \\nWideSys \\nSami Sistemas \\nSuperL√≥gica \\nSi9 Sistemas \\nSistema Pr√≥prio \\nSite Pr√≥prio \\nProperfy\",\n      type: \"string\",\n    },\n    rentalChargeMode: {\n      description:\n        ' \\nCaso o lead N√ÉO trabalhe com loca√ß√µes, defina \"N√£o Utiliza\" e n√£o fa√ßa a pergunta! \\n \\nE hoje, como voc√™s fazem as cobran√ßas dos alugu√©is? \\n \\nN√£o mostre as op√ß√µes, deixe aberto para o lead responder , interaja com o lead at√© que ele responda com uma das op√ß√µes abaixo: \\n \\nManual/Dinheiro   \\nPIX   \\nTED   \\nBoleto   \\nBoleto - Autom√°tico',\n      type: \"string\",\n    },\n    isRealEstate: {\n      description:\n        ' \\nPergunte qual cargo o lead ocupa no mercado imobili√°rio (ex: \"Qual sua fun√ß√£o na imobili√°ria?\").  \\n \\nS√≥cio / Diretor \\nPropriet√°rio \\nCorretor de Im√≥veis \\nGerente de Vendas \\nGerente de Alugu√©is \\nAuxiliar Administrativo \\nEstagi√°rio \\nMarketing \\nOutro Cargo na imobili√°ria \\nou \"N√£o trabalho no setor\" \\n \\nSe n√£o trabalhar no setor, agrade√ßa e encerre educadamente.',\n      type: \"string\",\n    },\n    qualificationCompleted: {\n      description:\n        \"Marque como true quando o usu√°rio responder a √∫ltima pergunta de qualifica√ß√£o (or√ßamento mensal para a vari√°vel amountInCurrentSystemOrBudget)\",\n      type: \"boolean\",\n    },\n    presentationHasSent: {\n      description:\n        \"Marque como true quando a apresenta√ß√£o em PDF for enviada ao cliente. IMPORTANTE: Sempre defina como true ap√≥s enviar a apresenta√ß√£o para evitar envios duplicados\",\n      type: \"boolean\",\n    },\n  },\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[112,-224],"id":"4a0946f8-454e-4af7-ae50-0377fc7a6196","name":"Seta vari√°veis da conversa"},{"parameters":{"description":"=## TOOL: Atualizar Par√¢metros\n\nSCHEMA (OBRIGAT√ìRIO):\n{\"name\":\"<varName>\",\"value\":<valorTipado>}\n\nOBJETIVO:\nSalvar/corrigir vari√°veis do fluxo.\n\nQUANDO EXECUTAR:\n- Sempre que a mensagem do usu√°rio preencher OU corrigir QUALQUER vari√°vel.\n- Sem pedir confirma√ß√£o. Detectou ‚Üí executou.\n- Pode executar v√°rias vezes no mesmo turno.\n\nTIPAGEM:\n- boolean ‚Üí true/false  \n- number ‚Üí extrair n√∫mero (ex: \"300 contratos\" ‚Üí 300)  \n- string ‚Üí texto literal  \n- string[] ‚Üí lista de textos  \n- number[] ‚Üí lista de n√∫meros  \n- Se tipo exigir number/boolean ‚Üí nunca enviar string.  \n- Valor vazio/irrelevante ‚Üí n√£o chamar.\n","jsCode":"const stages = $('Seta est√°gios').first().json\nconst vars = $('Seta vari√°veis da conversa').item.json.data\nconst newQuery = typeof query == 'string' ? JSON.parse(query) : query\n\nconst data = {\n  \"name\": newQuery.name, \n  \"value\": newQuery.value\n}\n\nif (vars[data.name]) {\n  vars[data.name].value = data.value\n}\n\nreturn JSON.stringify({ data, query })","specifyInputSchema":true,"jsonSchemaExample":"{\n\t\"name\": \"name_of_extracted_var\",\n    \"value\": \"value_of_extracted_var\"\n}"},"type":"@n8n/n8n-nodes-langchain.toolCode","typeVersion":1.3,"position":[1616,288],"id":"1e02b9cb-d355-434a-a724-01e95af6e2e1","name":"Atualizar param√™tros"},{"parameters":{"httpMethod":"POST","path":"7223c6af-f595-4bc2-b84c-602b8900cd08","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-864,-224],"id":"02c85270-569d-4b7e-ba3c-74ee8239cc0c","name":"Webhook","webhookId":"7223c6af-f595-4bc2-b84c-602b8900cd08"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o","mode":"list","cachedResultName":"gpt-4o"},"options":{"temperature":0}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[848,112],"id":"3ab262e6-1dd6-4aca-8c8e-50589120221f","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"method":"POST","url":"=https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').item.json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('AI Agent').item.json.output }}"},{"name":"number","value":"={{ $('Webhook').item.json.body.contact.number }}"},{"name":"addUserName","value":"={{ $('Seta perfil').item.json.agentName }}"},{"name":"whatsappId","value":"={{ $('Webhook').item.json.body.whatsappId }}"},{"name":"messageRepliedId","value":"={{ $('Webhook').item.json.body.messageId }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1520,-224],"id":"48b4e210-e95f-4211-9a20-ffd18f9715f6","name":"HTTP Request"},{"parameters":{"jsCode":"return {chatInput: $input.first().json.body.message}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-688,-224],"id":"ab22d418-ae56-418e-96fa-eba9859ca7eb","name":"Retorna message"},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"=## TOOL: Busca informa√ß√µes do banco de dados\n**Objetivo:** Buscar informa√ß√µes institucionais, t√©cnicas ou pre√ßos para responder d√∫vidas.\n\n**REGRA DE OURO (PRIORIDADE M√ÅXIMA):**\nEsta tool tem preced√™ncia sobre a coleta de dados. Se o usu√°rio fizer uma pergunta, **PAUSE** o fluxo atual, execute esta tool, responda a d√∫vida e depois retome a coleta.\n\n**QUANDO EXECUTAR ESSA BOSTA:**\n- O input cont√©m perguntas (ex: \"?\", \"Como funciona\", \"Quanto custa\", \"O que √©\").\n- O usu√°rio demonstra d√∫vida ou inseguran√ßa sobre o produto/servi√ßo.\n- O usu√°rio pede detalhes que n√£o est√£o no hist√≥rico da conversa.\n\n**N√ÉO EXECUTAR SE:**\n- O usu√°rio est√° apenas respondendo dados (ex: \"Sim\", \"Meu nome √© Jo√£o\").\n- A resposta √© trivial (ex: \"Bom dia\").","tableName":"n8","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[1328,288],"id":"1d4ff1aa-4661-4c20-aa93-518b6820a745","name":"Busca informa√ß√µes do banco de dados","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{"systemMessage":"=# SYSTEM: Executor de Fluxo Cont√≠nuo\n\nVoc√™ est√° rodando dentro de um fluxo no n8n. Seu papel √© ORQUESTRAR TOOLS. √â proibido responder de forma ‚Äúlivre‚Äù ou inventar passos do fluxo.\n\n================================\n1. IDENTIDADE & CONTEXTO\n================================\n- Agente: {{ $('Seta perfil').first().json.agentName }}\n- Cargo: {{ $('Seta perfil').first().json.role }}\n- Empresa: {{ $('Seta perfil').first().json.companyName }}\n- Tom/Idioma: {{ $('Seta perfil').first().json.tone }} | {{ $('Seta perfil').first().json.language }}\n- Mensagem inicial: {{ $('Seta perfil').first().json.initialMessage }}\n- Conduta: {{ $('Seta perfil').first().json.conduct }}\n\nTabela de vari√°veis do fluxo (estado atual):\n{{ $('Transforma vari√°veis em tabela').first().json.tableMarkdown }}\n\nUse SEMPRE esse contexto, mas seja econ√¥mico nas respostas.\n\n================================\n2. TOOLS DISPON√çVEIS\n================================\nVoc√™ NUNCA simula tools em texto. Sempre chama a tool real.\n\n- UP(name, value)\n  ‚Üí Tool: \"Atualizar param√™tros\"\n  ‚Üí Atualiza vari√°veis do fluxo.\n  ‚Üí Input (JSON OBRIGAT√ìRIO):\n    {\"name\":\"<nome_da_variavel>\",\"value\":<valor_tipado>}\n\n- GET_STAGE()\n  ‚Üí Tool: \"Busca est√°gio atual\"\n  ‚Üí Retorna JSON com:\n    - currentInstruction: o que fazer/perguntar agora\n    - currentStage: nome do est√°gio atual\n    - currentVar: vari√°vel alvo do momento\n\n- BK(query)\n  ‚Üí Tool: \"Busca informa√ß√µes do banco de dados\"\n  ‚Üí Use para buscar informa√ß√µes factuais (produto, processos, pre√ßos, etc.).\n  ‚Üí query = mensagem COMPLETA do usu√°rio.\n\n- PROP()\n  ‚Üí Tool: \"Enviar apresenta√ß√£o comercial\"\n  ‚Üí Use quando o fluxo indicar que a qualifica√ß√£o terminou e a apresenta√ß√£o deve ser enviada.\n\n================================\n3. FLUXO OBRIGAT√ìRIO POR TURNO\n================================\nCada mensagem do usu√°rio = 1 turno. Em TODO turno siga exatamente:\n\n1) LER & ANALISAR\n   - Leia a mensagem atual + hist√≥rico.\n   - Detecte dados novos ou corre√ß√µes de vari√°veis.\n\n2) ATUALIZAR VARI√ÅVEIS (UP)\n   - Se a mensagem for LONGA/COMPLEXA:\n     ‚Ä¢ Ative ‚ÄúModo Scanner‚Äù.\n     ‚Ä¢ Extraia TODAS as vari√°veis respondidas.\n     ‚Ä¢ Execute m√∫ltiplos UPs se necess√°rio.\n   - Se a mensagem for CURTA/DIRETA (ex: \"Sim\", \"N√£o\", \"Ok\", \"Pode ser\"):\n     ‚Ä¢ Ative ‚ÄúModo Infer√™ncia‚Äù.\n     ‚Ä¢ Considere que responde APENAS √† √öLTIMA pergunta feita pelo bot.\n     ‚Ä¢ Fa√ßa EXATAMENTE 1 UP para a vari√°vel associada a essa pergunta.\n\n3) CHAMAR GET_STAGE()\n   - Depois de TODOS os UP do turno, √© OBRIGAT√ìRIO chamar GET_STAGE() pelo menos uma vez antes de falar com o usu√°rio.\n\n4) LOOP DE A√á√ïES AUTOM√ÅTICAS\n   - Se o est√°gio atual exigir a√ß√£o de sistema (ex: enviar apresenta√ß√£o, marcar vari√°vel derivada, etc.):\n     ‚Ä¢ Execute as tools necess√°rias (UP, PROP, BK se √∫til).\n     ‚Ä¢ Em seguida, chame GET_STAGE() NOVAMENTE.\n   - Repita esse ciclo at√© que a instru√ß√£o retornada seja apenas de fala/pergunta para o usu√°rio.\n\n5) RESPOSTA AO USU√ÅRIO\n   - S√≥ responda depois de resolver o loop do passo 4.\n   - A resposta DEVE seguir a currentInstruction retornada pelo GET_STAGE.\n\n================================\n4. REGRAS DE UP (ATUALIZAR PAR√ÇMETROS)\n================================\nObjetivo: manter o estado do fluxo sempre correto.\n\nMensagens LONGAS (texto mais elaborado):\n- Leia a tabela de vari√°veis (VAR, TIPO, INSTRU√á√ÉO).\n- Para cada vari√°vel sem valor:\n  ‚Ä¢ Se a mensagem atual responde diretamente √† instru√ß√£o, chame UP.\n- Uma mesma mensagem longa pode preencher V√ÅRIAS vari√°veis.\n\nMensagens CURTAS (at√© ~3 palavras: \"sim\", \"n√£o\", \"ok\", \"pode ser\", \"agora n√£o\", etc.):\n1) ASSUMA que √© resposta direta √† √öLTIMA pergunta enviada.\n2) Ache na tabela a vari√°vel cuja INSTRU√á√ÉO mais se parece com a √∫ltima pergunta.\n3) Fa√ßa EXATAMENTE 1 UP:\n   - name = nome dessa vari√°vel (targetVar)\n   - value = resposta convertida para o tipo correto.\n\nRegras duras para respostas curtas:\n- NUNCA atualizar mais de 1 vari√°vel com uma resposta curta.\n- NUNCA reaproveitar a mesma resposta curta para v√°rias vari√°veis.\n- Se n√£o conseguir mapear com seguran√ßa:\n  ‚Ä¢ N√ÉO chama UP.\n  ‚Ä¢ Apenas segue o fluxo (GET_STAGE + resposta).\n\nConvers√£o de tipos:\n- boolean:\n  ‚Ä¢ Positivo: \"sim\", \"claro\", \"pode ser\", \"ok\" ‚Üí true\n  ‚Ä¢ Negativo: \"n√£o\", \"nao\", \"prefiro que n√£o\", \"agora n√£o\" ‚Üí false\n- number:\n  ‚Ä¢ Extraia s√≥ o n√∫mero (ex: \"temos 300 contratos\" ‚Üí 300).\n- enum/op√ß√µes:\n  ‚Ä¢ Se a resposta corresponder claramente a uma op√ß√£o, salve a op√ß√£o exata.\n- string / texto:\n  ‚Ä¢ Use o texto relevante, sem enfeitar.\n\n================================\n5. USO DE GET_STAGE()\n================================\nDepois de atualizar vari√°veis com UP:\n\n- SEMPRE chame GET_STAGE().\n- Use o retorno assim:\n  ‚Ä¢ currentInstruction:\n    - Se for descri√ß√£o de pergunta/vari√°vel ‚Üí transforme em UMA pergunta clara e objetiva, alinhada ao tom.\n    - Fa√ßa apenas UMA pergunta por vez.\n  ‚Ä¢ currentStage: s√≥ como contexto mental, n√£o precisa falar o nome do est√°gio.\n  ‚Ä¢ currentVar: vari√°vel em foco no momento.\n\nSe ap√≥s executar a√ß√µes l√≥gicas + novo GET_STAGE() n√£o houver mais instru√ß√£o clara:\n- Considere que o fluxo est√° finalizado.\n- Agrade√ßa e encerre de forma educada.\n\n================================\n6. USO DE BK(query)\n================================\nBK n√£o √© obrigat√≥rio, mas ajuda a evitar alucina√ß√µes.\n\nUse BK(query) quando:\n- O usu√°rio fizer perguntas sobre Apresenta.me, funcionalidades, processos, pre√ßos ou detalhes t√©cnicos.\n- Voc√™ n√£o tiver certeza da resposta.\n\nComo usar:\n1) Chame BK(query) com a mensagem COMPLETA do usu√°rio.\n2) Use o resultado como base factual.\n3) Combine o conte√∫do de BK com a currentInstruction de GET_STAGE para montar a resposta.\n\nSe BK n√£o trouxer nada √∫til:\n- Seja honesto: diga que n√£o encontrou na base.\n- N√ÉO invente detalhes espec√≠ficos (n√∫meros, regras, processos).\n\n================================\n7. USO DE PROP()\n================================\nQuando identificar (pelas vari√°veis e/ou est√°gio) que:\n- a qualifica√ß√£o terminou, e\n- √© hora de enviar a apresenta√ß√£o comercial:\n\n1) Chame \"Enviar apresenta√ß√£o comercial\" (PROP()).\n2) Depois, chame UP(\"presentationHasSent\", true) para n√£o reenviar depois.\n3) Em seguida chame GET_STAGE novamente para saber qual mensagem mandar ao usu√°rio (ex: avisar que enviou o material).\n\n================================\n8. ESTILO DAS RESPOSTAS\n================================\nQuando falar com o usu√°rio:\n\n- Use SEMPRE o tom, linguagem e conduta de {{ $('Seta perfil').first().json.agentName }} da {{ $('Seta perfil').first().json.companyName }}.\n- Seja simples, direto e objetivo.\n- Por padr√£o, mantenha respostas curtas (at√© ~130 caracteres), a n√£o ser que precise explicar algo.\n- Fa√ßa APENAS UMA pergunta por vez.\n- N√£o fale sobre tools, vari√°veis internas, Redis, n8n, etc.\n- N√£o invente dados de neg√≥cio; em caso de d√∫vida, pergunte ou use BK.\n\n================================\n9. CHECKLIST R√ÅPIDO (RESUMO OPERACIONAL)\n================================\nPara CADA mensagem do usu√°rio, confira se voc√™ fez, nesta ordem:\n\n1) Li a mensagem + hist√≥rico?\n2) Detectei se ela preenche/corrige alguma vari√°vel?\n3) Se era mensagem curta (sim/n√£o/ok): atualizei NO M√ÅXIMO 1 vari√°vel ligada √† √öLTIMA pergunta?\n4) Se era mensagem longa: fiz TODOS os UP necess√°rios?\n5) Chamei GET_STAGE() depois dos UP?\n6) Se o est√°gio pediu alguma a√ß√£o (UP extra, PROP, BK): executei e chamei GET_STAGE de novo?\n7) Montei a resposta seguindo a currentInstruction, com apenas 1 pergunta, no tom configurado?\n8) Se n√£o havia mais instru√ß√£o: encerrei educadamente?","returnIntermediateSteps":true}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2,"position":[1184,-224],"id":"fab43240-fecb-4360-88b8-37379509dc72","name":"AI Agent","retryOnFail":false},{"parameters":{"options":{"dimensions":1536}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[1328,448],"id":"1d403bed-a7d8-4b99-8506-98029296bc0b","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}}],"connections":{"Deleta cache estagios":{"main":[[{"node":"Delete cache variaveis","type":"main","index":0}]]},"Transforma vari√°veis em tabela":{"main":[[{"node":"Seta perfil","type":"main","index":0}]]},"Seta cache dos estagios":{"main":[[{"node":"Seta cache das variaveis","type":"main","index":0}]]},"Retorna chatInput":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Busca vari√°veis":{"main":[[{"node":"Seta vari√°veis da conversa","type":"main","index":0}]]},"Busca est√°gios":{"main":[[{"node":"Busca vari√°veis","type":"main","index":0}]]},"Cria cache key":{"main":[[{"node":"Deleta cache estagios","type":"main","index":0},{"node":"Busca est√°gios","type":"main","index":0}]]},"Seta est√°gios":{"main":[[{"node":"Retorna chatInput","type":"main","index":0}]]},"Seta perfil":{"main":[[{"node":"Seta est√°gios","type":"main","index":0}]]},"Seta vari√°veis da conversa":{"main":[[{"node":"Transforma vari√°veis em tabela","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Retorna message","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Seta cache dos estagios","type":"main","index":0}]]},"Retorna message":{"main":[[{"node":"Cria cache key","type":"main","index":0}]]},"Busca est√°gio atual":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Enviar apresenta√ß√£o comercial":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"Atualizar param√™tros":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Busca informa√ß√µes do banco de dados":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"AI Agent":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Busca informa√ß√µes do banco de dados","type":"ai_embedding","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"55f388dc-f061-4dad-b00a-6268bcb7db79","triggerCount":1,"shared":[{"updatedAt":"2025-11-04T18:47:16.654Z","createdAt":"2025-11-04T18:47:16.654Z","role":"workflow:owner","workflowId":"dDaZdsSmHxktrhjc","projectId":"4ToGMYJEWvvDSbcz"}],"tags":[]}