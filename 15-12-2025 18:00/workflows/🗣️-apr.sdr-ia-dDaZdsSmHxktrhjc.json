{"updatedAt":"2025-12-15T20:55:41.000Z","createdAt":"2025-11-04T18:47:16.651Z","id":"dDaZdsSmHxktrhjc","name":"üó£Ô∏è Apr.SDR IA","active":true,"isArchived":false,"nodes":[{"parameters":{"operation":"delete","key":"={{ $('Cria cache key').item.json.cache_key }}_vars"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2160,-304],"id":"82d16a2d-7240-45c6-9e10-4c474f1e6242","name":"Delete cache variaveis","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"const inputData = $input.first().json;\nconst dataObj = Array.isArray(inputData) ? inputData[0] : inputData;\n\nlet tableMarkdown = \"| VAR | TIPO | OP√á√ïES | DESCRI√á√ÉO | VALOR | \\n|---|---|---|---|\\n\";\n\nfor (const [key, props] of Object.entries(dataObj)) {\n  let optionsFormatted = '-';\n\n  if (props.options) {\n    optionsFormatted = Object.entries(props.options)\n      .map(([optKey, optVal]) => `\\`${optKey}\\`: ${optVal}`)\n      .join('<br>');\n  }\n\n  const cleanDesc = (props.description || '').replace(/\\n/g, ' ');\n\n  tableMarkdown += `| **${key}** | \\`${props.type}\\` | ${optionsFormatted} | ${cleanDesc} | ${props.value} |\\n`;\n}\n\nreturn { tableMarkdown };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1536,-16],"id":"715ad9c6-1b55-46ab-be41-ef8771d55cbd","name":"Transforma vari√°veis em tabela"},{"parameters":{"jsCode":"return {\n  chatInput: JSON.stringify($('Webhook').first().json.body.message)\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,-16],"id":"785efff2-7dfd-486c-ab8e-79dd10dfc9c1","name":"Retorna chatInput"},{"parameters":{"operation":"get","key":"={{ $('Cria cache key').item.json.cache_key }}_vars","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2160,-16],"id":"fe06e47a-c5bc-494f-bc1b-53f306da4e52","name":"Busca vari√°veis","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"cache_key\": \"sdr_{{ $('Webhook').item.json.body.ticketId }}_chat_summary_{{ $('Webhook').item.json.body.contact.number }}_{{ $('Webhook').item.json.body.whatsappId }}_10\"\n} ","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2816,-16],"id":"0616bdad-72a1-40be-8797-c2b6f60329a9","name":"Cria cache key"},{"parameters":{"jsCode":"const vars = $('Seta vari√°veis da conversa').first().json\nconst cacheStages = JSON.parse($('Busca est√°gios').first().json.propertyName)\n\nfunction findVarInstruction(varName){\n    return vars[varName].description\n}\n\nfunction findVarType(varName) {\n  return vars[varName].type\n}\n\nfunction findVarValue(varName) {\n  return vars[varName].value\n}\n\nconst stages = cacheStages ?? {\n  \"1. Identifica√ß√£o Inicial\": {\n    \"sortNumber\": 1,\n    \"conditionPrompt\": \"Se √© o in√≠cio da conversa.\",\n    \"requiredDataForExecute\": null,\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"name\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"Agrade√ßa e pergunte qual a fun√ß√£o dele na imobili√°ria hoje.\"\n    }\n  },\n  \"2. Classifica√ß√£o de Perfil (Cargo)\": {\n    \"sortNumber\": 2,\n    \"conditionPrompt\": \"Se j√° temos o nome, mas n√£o sabemos o cargo.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"name\",\n        \"operator\": \"exist\",\n        \"value\": null\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"role\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"\"\n    }\n  },\n  \"3. Tamanho do Time (Apenas Empresas)\": {\n    \"sortNumber\": 3,\n    \"conditionPrompt\": \"Se n√£o for aut√¥nomo, precisamos saber o tamanho do time.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"isAutonomous\",\n        \"operator\": \"=\",\n        \"value\": false\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"teamSize\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"\"\n    }\n  },\n  \"4. Contexto de Loca√ß√£o e Carteira\": {\n    \"sortNumber\": 4,\n    \"conditionPrompt\": \"Precisamos entender se trabalham com loca√ß√£o e o tamanho da carteira.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"role\",\n        \"operator\": \"exist\",\n        \"value\": null\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"rentalStatus\",\n          \"value\": null\n        },\n        {\n          \"name\": \"portfolioSize\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"\"\n    }\n  },\n  \"5. Foco e Dores\": {\n    \"sortNumber\": 5,\n    \"conditionPrompt\": \"Entender o que buscam (M√≥dulos) e a dor principal.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"rentalStatus\",\n        \"operator\": \"exist\",\n        \"value\": null\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"mainPainPoint\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": null\n    }\n  },\n  \"6. Sistema Atual\": {\n    \"sortNumber\": 6,\n    \"conditionPrompt\": \"Saber a stack atual.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"mainPainPoint\",\n        \"operator\": \"exist\",\n        \"value\": null\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"currentSystem\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"\"\n    }\n  },\n  \"7. Detalhamento Loca√ß√£o (Galho Ativo)\": {\n    \"sortNumber\": 7,\n    \"conditionPrompt\": \"SE E SOMENTE SE o lead j√° atua com loca√ß√µes ('active'), aprofundar em contratos e repasse.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"rentalStatus\",\n        \"operator\": \"=\",\n        \"value\": \"active\"\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"numberOfContracts\",\n          \"value\": null\n        },\n        {\n          \"name\": \"transferMode\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"\"\n    }\n  },\n  \"8. Or√ßamento\": {\n    \"sortNumber\": 8,\n    \"conditionPrompt\": \"Fase final de qualifica√ß√£o.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"currentSystem\",\n        \"operator\": \"exist\",\n        \"value\": null\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"budget\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"\"\n    }\n  },\n  \"9. Verificar se o lead aceita agendamento (Handover)\": {\n    \"sortNumber\": 9,\n    \"conditionPrompt\": \"Finalizar e passar para humano.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"budget\",\n        \"operator\": \"exist\",\n        \"value\": null\n      },\n      {\n        \"name\": \"handoverConfirmed\",\n        \"operator\": \"!exist\",\n        \"value\": null\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"handoverConfirmed\",\n          \"value\": null\n        }, \n        {\n          \"name\": \"bestTimeToContact\", \n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"\"\n    }\n  },\n  \"10. Extrair o melhor hor√°rio de agendamento desejado\": {\n    \"sortNumber\": 10,\n    \"conditionPrompt\": \"\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"handoverConfirmed\",\n        \"operator\": \"=\",\n        \"value\": true\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"bestTimeToContact\", \n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"1. Agrade√ßa o usu√°rio e acrescente: 'Anotei as informa√ß√µes aqui, e assim que poss√≠vel um especialista vai te chamar! At√© mais üëã'.\\n 2. N√£o diga que ir√° realizar o agendamento, n√£o √© sua responsabilidade.\\n 3. Encerre o atendimento de forma cordial, falando o nome do usu√°rio.\"\n    }\n  }\n}\n\n// Iterar sobre todos os stages\nObject.keys(stages).forEach(stageKey => {\n  const stage = stages[stageKey];\n  \n  // Verificar se existe actions e requiredDataForExecute\n  if (stage.actions && stage.actions.requiredDataForExecute) {\n    // Iterar sobre cada item de requiredDataForExecute\n    stage.actions.requiredDataForExecute.forEach(item => {\n      // Adicionar a propriedade instructions\n      item.instruction = findVarInstruction(item.name);      \n      item.type = findVarType(item.name)\n      item.value = findVarValue(item.name) || undefined\n    });\n  }\n});\n\nreturn stages;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-928,-16],"id":"26867d44-c0b8-48de-9d4b-bb61ffc4cb36","name":"Seta est√°gios"},{"parameters":{"jsCode":"return {\n  tone: \"Engra√ßado\",\n  agentName: \"Alicia\",\n  internalName: \"Alicia da Apresenta.me\",\n  initialMessage: \"Ol√°, tudo bem? üëã \\n\\nEu sou a Alicia, assistente da Apresenta.me, vou te ajudar entendendo melhor sua necessidade.\",\n  language: \"pt-BR\",\n  timeZone: \"Sao Paulo (GTM -3)\",\n  role: \"SDR S√™nior\",\n  companyName: \"Apresenta.me\",\n  companyDepartment: \"Software\",\n  companySite: \"https://apresenta.me\",\n    conduct: \"\\n### IDENTIDADE E OBJETIVO\\n- ATUA√á√ÉO: Voc√™ √© um SDR profissional da Apresenta.me (SaaS de gest√£o imobili√°ria);\\n- MISS√ÉO: Qualificar o lead para verificar ader√™ncia ao ICP. Seu sucesso √© definido pela qualidade da informa√ß√£o extra√≠da, n√£o pela venda imediata;\\n- POSTURA: Aja como um consultor especialista: cordial, breve e focado em entender o cen√°rio do cliente.\\n\\n### DIRETRIZES DE COMUNICA√á√ÉO\\n- CONCIS√ÉO: Respostas limitadas a 130 caracteres (salvo extrema necessidade). Seja direto;\\n- TOM DE VOZ: Espelhamento (calibre conforme o lead). Use emojis moderados (üòÑüëçüè¢üöÄ) para suavizar;\\n- MARCA: O sistema escreve-se 'Apresenta.me', mas refira-se a ele foneticamente como 'Apresentame' (fluido);\\n\\n### PROTOCOLO DE NEUTRALIDADE (CR√çTICO)\\n- IMPARCIALIDADE TOTAL: Ao ouvir sobre o sistema, m√©todo ou ferramenta atual do lead, RESTRINJA-SE a confirmar o entendimento.\\n- PROIBIDO ELOGIAR: Jamais use adjetivos como '√≥timo', 'interessante' ou 'muito bom' para qualquer ferramenta utilizada pelo lead.\\n- PROIBIDO DESDENHAR: Jamais critique ou aponte falhas sobre qualquer ferramenta utilizada pelo lead. O foco √© a qualifica√ß√£o, n√£o a compara√ß√£o.\\n- A√á√ÉO ESPERADA: Se o lead disser 'Uso planilha', responda: 'Entendi, usa planilhas.' e siga para a pr√≥xima pergunta de qualifica√ß√£o.\\n\\n### REGRAS OPERACIONAIS\\n- URLS: Apenas forne√ßa URLs oficiais e exatas;\\n- FLUXO: Apenas UMA pergunta por vez. Evite sobrecarga cognitiva;\\n- CONVERS√ÉO: O convite para demonstra√ß√£o s√≥ deve ocorrer AP√ìS a valida√ß√£o completa do ICP;\\n- MENU: Jamais apresente op√ß√µes de m√∫ltipla escolha. Fa√ßa perguntas abertas e interprete a resposta;\\n- CONCORR√äNCIA: Nunca mencione concorrentes, foque apenas na dor e no cen√°rio do lead.\",\n  verbosity: \"medium\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1344,-16],"id":"95ead263-a07f-473e-99aa-3499332685b3","name":"Seta perfil"},{"parameters":{"jsCode":"const cacheVars = $(\"Busca vari√°veis\").first().json.propertyName\n  ? JSON.parse($(\"Busca vari√°veis\").first().json.propertyName)\n  : undefined;\n\nreturn (\n  cacheVars ?? {\n    name: {\n      description:\n        \"Pergunte diretamente o nome do lead para iniciar o atendimento. Ex: 'Com quem eu falo?' ou 'Qual seu nome?'. üòä\",\n      type: \"string\",\n    },\n    role: {\n      description:\n        \"Precisamos saber o cargo exato. Pergunte objetivamente sem mostrar as op√ß√µes do exemplo: 'Qual √© o seu cargo ou fun√ß√£o na imobili√°ria hoje?'. (Ex: Corretor, S√≥cio, Gerente, etc). üè¢ -> Se a resposta indicar que o usu√°rio trabalha sozinho ou de forma explicita dizer que o usu√°rio √© aut√¥nomo, ent√£o isAutonomus = true -> SE N√ÉO, isAutonomus = false.\",\n      type: \"string\",\n    },\n    isAutonomous: {\n      description:\n        \"Classifica√ß√£o Interna ü§ñ: Baseado na resposta sobre o cargo ('role'). Defina 'true' se ele trabalha sozinho/aut√¥nomo. Se o lead for aut√¥nomo, teamSize = 1 -> SEMPRE.\",\n      type: \"boolean\",\n    },\n    teamSize: {\n      description:\n        \"Pergunte o tamanho total da equipe. Ex: 'Quantas pessoas trabalham na opera√ß√£o da imobili√°ria hoje (incluindo s√≥cios e corretores)?'. üë•\",\n      type: \"number\",\n    },\n    rentalStatus: {\n      description:\n        \"Pergunte se o usu√°rio j√° trabalha com loca√ß√µes, se est√° come√ßando a estruturar agora.\\n Deixe o usu√°rio responder livremente e assuma os valores aceitos das op√ß√µes.\",\n      type: \"string\",\n      options: {\n        active: \"J√° trabalha com loca√ß√µes.\",\n        starting: \"Est√° come√ßando agora com loca√ß√µes.\",\n        none: \"N√£o trabalha com loca√ß√µes.\",\n      },\n    },\n    portfolioSize: {\n      description:\n        \"Queremos o volume de im√≥veis. Pergunte objetivamente: 'Quantos im√≥veis (venda + loca√ß√£o) voc√™s t√™m na carteira hoje, aproximadamente?'. üèòÔ∏è\",\n      type: \"number\",\n    },\n    interestFocus: {\n      description:\n        \"Classifica√ß√£o Interna üéØ: Baseado nas dores, o que ele precisa.\",\n      type: \"string\",\n      options: {\n        site_crm: \"Precisa de SITE + CRM (gerenciar vendas)\",\n        finance: \"Precisa de gest√£o financeira\",\n        all: \"Precisa de tudo\",\n        unknown: \"N√£o precisa de nada (improv√°vel, mas poss√≠vel)\",\n      },\n    },\n    mainPainPoint: {\n      description:\n        \"Pergunte qual √© o maior problema que o lead identifica na imobili√°ria. (Ex: '[NOME DO LEAD], e hoje, como voc√™ descreveria o maior problema ou dificuldade que voc√™(s) t√™m identificado?'). A resposta do usu√°rio descrever√° um problema, reclama√ß√£o do sistema atual, gargalo no processo ou ir√° informar que n√£o possui um sistema (seja CRM, ou gest√£o). Capture o texto integral desse relato. Se a resposta for o suficiente para responder interestFocus, responda-a tamb√©m.\",\n      type: \"string\",\n    },\n    currentSystem: {\n      description:\n        \"Pergunte se o lead j√° utiliza algum sistema atualmente. Exemplo de pergunta: 'Voc√™s utilizam algum sistema ou CRM imobili√°rio hoje? Se sim, qual?'. üíª\",\n      type: \"string\",\n      options: {\n        superlogica: \"Superl√≥gica\",\n        tecimob: \"Tecimob\",\n        kenlo: \"Kenlo\",\n        jetimob: \"Jetimob\",\n        vista: \"Vista Software / Loft\",\n        si9: \"Si9 Sistemas\",\n        imobibrasil: \"ImobiBrasil\",\n        imobex: \"Imobex\",\n        mold_systems: \"Mold Systems\",\n        code49: \"CODE49\",\n        sub100: \"Sub 100 (SGL)\",\n        colibex: \"CRM Colibex\",\n        painel_imobiliario: \"Painel Imobili√°rio\",\n        imovel_integrado: \"Im√≥vel Integrado\",\n        imopro: \"CRM Imopro\",\n        imoalert: \"ImoAlert\",\n        facilita: \"Facilita / App Facilita\",\n        imobzi: \"Imobzi\",\n        waysoft: \"WaySoft\",\n        midas: \"Midas\",\n        galax_imob: \"Galax Imob\",\n        flip: \"Flip CRM\",\n        univen: \"Univen\",\n        imobia: \"Imobia\",\n        promentor: \"Pr√≥Mentor\",\n        imob_system: \"Imob System\",\n        imob_integrada: \"Imob Integrada\",\n        alude: \"Alude\",\n        sobressai: \"Sobressai\",\n        imonov: \"Imonov\",\n        gedaim: \"Geda√≠m / Goyaz Sistemas\",\n        pepin: \"Pepin Tecnologia\",\n        orange_imob: \"OrangeImob\",\n        migmidia: \"MigMidia\",\n        sigasoft: \"SigaSoft\",\n        universal: \"Universal Software\",\n        castel_digital: \"Castel Digital\",\n        gestao_real: \"Gest√£o Real\",\n        nido: \"Nido Tecnologia\",\n        samiloca: \"Samiloca\",\n        microsistec: \"Microsistec\",\n        imogestao: \"ImoGest√£o\",\n        union: \"Union Software\",\n        simbo: \"Simbo CRM\",\n        arbo: \"Arbo\",\n        alterdata: \"Alterdata\",\n        widesys: \"Widesys\",\n        kurole: \"Kurole\",\n        other: \"Outro / N√£o listado\",\n      },\n    },\n    numberOfContracts: {\n      description:\n        \"Precisamos do volume da carteira de aluguel. Pergunte: 'Quantos contratos de loca√ß√£o ativos voc√™s administram atualmente?'. üìÑ\",\n      type: \"number\",\n    },\n    transferMode: {\n      description:\n        \"Entenda o processo financeiro, deixe o lead responder abertamente. Pergunte: 'Qual m√©todo voc√™s usam para repassar o aluguel aos propriet√°rios hoje?'. N√£o mostre: (Ex: Manual, via banco, split de pagamento). Deixe o usu√°rio responder livremente, apenas abstraia e responda. üí∏\",\n      type: \"string\",\n    },\n    budget: {\n      description:\n        \"Valide o potencial de compra. Pergunte: 'Voc√™ tem uma estimativa de investimento mensal para contratar um sistema?'. üí∞ Regra: Se ele n√£o quiser falar, salve: 'N√£o quis informar'.\",\n      type: \"string\",\n    },\n    handoverConfirmed: {\n      description:\n        \"Confirma√ß√£o de agendamento. O lead aceita EXPLICITAMENTE o agendamento? Considere que ele aceitou o agendamento de forma explicita se ele responder com 'Sim', 'Claro', 'Pode ser', 'Aham' ou algo que indique a positividade, por favor!. ü§ù\",\n      type: \"boolean\",\n    },\n      bestTimeToContact: {\n      description:\n        \"Pergunta para o Lead exatamente com esta mensagem: √ìtimo! Um de nossos especialistas vai entrar em contato para informar os hor√°rios dispon√≠veis para a sua demonstra√ß√£o.\\n\\n Qual √© o melhor hor√°rio para que possamos falar com voc√™?.IMPORTANTE: Converta a resposta para um valor no padr√£o 00:00 (ex: 15h -> 15:00) \",\n      type: \"time\",\n      },\n  }\n);\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1744,-16],"id":"5a47b4a7-0f5d-470e-974e-6beac81cdf8f","name":"Seta vari√°veis da conversa"},{"parameters":{"httpMethod":"POST","path":"7223c6af-f595-4bc2-b84c-602b8900cd08","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-3184,-16],"id":"054ca6ef-f66b-43bf-84b3-b66e8edd4be4","name":"Webhook","webhookId":"7223c6af-f595-4bc2-b84c-602b8900cd08"},{"parameters":{"jsCode":"return {chatInput: $input.first().json.body.message}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3008,-16],"id":"d4deacac-a978-4f28-ade2-2b8996662359","name":"Retorna message"},{"parameters":{"operation":"set","key":"={{ $('Cria cache key').item.json.cache_key }}_vars","value":"={{ JSON.stringify($('Atualiza vari√°veis').first().json.vars)}}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1168,-16],"id":"47583b2b-4618-4fec-a268-691eebda95dc","name":"Seta cache das variaveis","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"method":"POST","url":"=https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').item.json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Parse na resposta').first().json.output.response }}"},{"name":"number","value":"={{ $('Webhook').item.json.body.contact.number }}"},{"name":"addUserName","value":"={{ $('Seta perfil').item.json.agentName }}"},{"name":"whatsappId","value":"={{ $('Webhook').item.json.body.whatsappId }}"},{"name":"messageRepliedId","value":"={{ $('Webhook').item.json.body.messageId }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[944,-16],"id":"dd3f6a1b-f56b-4496-ba0d-0599333e25ee","name":"HTTP Request"},{"parameters":{"operation":"get","key":"={{ $('Cria cache key').first().json.cache_key }}_lastVar","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2368,-16],"id":"49b22786-bfb8-46bd-a6ec-c52f8cde2a15","name":"Busca last var","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"const lastVarCache = $('Busca last var').first().json.propertyName\n\nreturn {\n  lastVar: lastVarCache\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1136,-16],"id":"fb3b3349-693c-46f2-a126-69d4ad419a8e","name":"Seta lastVar solicitada"},{"parameters":{"operation":"set","key":"={{ $('Cria cache key').item.json.cache_key }}_lastVar","value":"={{ JSON.stringify($('Busca est√°gio').first().json.currentVar)}}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1376,-16],"id":"c1074199-bd68-4d51-887f-47651cfc9cd8","name":"Seta cache lastVar solicitada","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"={{ $('Cria cache key').first().json.cache_key }}_lastVar"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2368,-304],"id":"f6e2392d-5a28-4841-9880-0defef0b75c7","name":"Deleta cache lastVar","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"get","key":"={{ $('Cria cache key').item.json.cache_key }}_stages","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1952,-16],"id":"75d7c66c-6c25-496d-a069-2aec43c46d34","name":"Busca est√°gios","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"={{ $('Cria cache key').item.json.cache_key }}_stages","value":"={{ JSON.stringify($('Busca est√°gio').first().json.stages) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1616,-16],"id":"517f5a78-3ce0-40e3-9160-ded03c6013c1","name":"Seta cache est√°gios","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"// Pega o output bruto\nconst rawOutput = $input.first().json.output;\n\n// REGEX PODEROSA:\n// 1. \\[Used tools: -> Encontra onde come√ßa o log\n// 2. [\\s\\S]*?      -> Pega qualquer coisa (incluindo quebras de linha)\n// 3. \\]\\]          -> At√© encontrar o fechamento duplo de colchetes\n// A flag 'g' remove todas as ocorr√™ncias\nlet cleanText = rawOutput.replace(/\\[Used tools:[\\s\\S]*?\\]\\]/g, \"\");\n\n// Remove espa√ßos em branco do come√ßo e do fim que sobraram\ncleanText = cleanText.trim();\n\n// O DeepSeek as vezes solta um \"Thought:\" perdido, removemos tamb√©m\ncleanText = cleanText.replace(/^Thought:[\\s\\S]*?Answer:/im, \"\").trim();\n\nreturn {\n  // Retornamos um JSON criado AGORA, na m√£o, j√° que a IA n√£o mandou\n  output: {\n    response: cleanText\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[752,-16],"id":"37d13c20-1e04-4a3b-a151-5fdecf3d199d","name":"Parse na resposta"},{"parameters":{"operation":"delete","key":"={{ $json.cache_key }}_stages"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1984,-304],"id":"e7735817-393d-469e-a393-c9538efcb2c1","name":"Deleta cache est√°gios","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Cria cache key').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1776,-304],"id":"e90ef4db-97a0-4734-a1fc-dcdb5a6232fc","name":"Delete table or rows","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1f5bcbd1-6685-469d-bbf2-7939008b234d","leftValue":"={{ $('Webhook').item.json.body.message.trim() }}","rightValue":"clear:cache:111222","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2608,-16],"id":"f3686edf-ea09-4fcf-ad9f-048b6c91d9c3","name":"If"},{"parameters":{"options":{"dimensions":1536}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[464,528],"id":"eed76718-9114-48da-b56c-2864e5ec663d","name":"Embeddings OpenAI1","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Cria cache key').item.json.cache_key }}","contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[304,304],"id":"d9447668-6f6c-44d1-99ef-79cd3fb29c50","name":"Postgres Chat Memory","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"=## TOOL: BK_res\nDESCRI√á√ÉO/FUN√á√ÉO: Consultar a Base de Conhecimento para buscar informa√ß√µes sobre a empresa, funcionalidades, pre√ßos ou regras de neg√≥cio.\n\n### GATILHOS DE EXECU√á√ÉO (QUANDO CHAMAR A TOOL)\nVoc√™ √© OBRIGADO a executar esta ferramenta sempre que a mensagem do usu√°rio (analisada isoladamente ou com base no **HIST√ìRICO RECENTE**) contiver:\n\n1. **PERGUNTAS EXPL√çCITAS (?):**\n   - Qualquer frase com interroga√ß√£o ou pronomes interrogativos (\"Como\", \"Qual\", \"Quanto\", \"Voc√™s t√™m\").\n\n2. **D√öVIDAS DE NEG√ìCIO (MESMO SEM INTERROGA√á√ÉO):**\n   - Men√ß√µes a termos t√©cnicos ou comerciais: \"funcionalidade\", \"integra√ß√£o\", \"valor\", \"plano\", \"relat√≥rio\", \"sistema\", \"suporte\".\n   - Express√µes de incerteza ou desejo: \"Gostaria de ver\", \"Preciso saber\", \"N√£o sei se serve\", \"Achei interessante\".\n\n3. **CONTINUIDADE DE T√ìPICO (CONTEXTO DO HIST√ìRICO):**\n   - Perguntas curtas ou fragmentadas que se referem a um assunto tratado nas mensagens anteriores.\n   - *Exemplo:* Se a conversa era sobre \"Financeiro\" e o usu√°rio pergunta \"E contas a pagar?\", **EXECUTE A TOOL**.\n   - *L√≥gica:* Se o usu√°rio pede detalhes sobre algo j√° mencionado, busque a informa√ß√£o t√©cnica.\n\n4. **INPUT H√çBRIDO (DADO + D√öVIDA):**\n   - O usu√°rio responde o dado solicitado no fluxo MAS insere uma d√∫vida na mesma mensagem.\n   - *Exemplo:* \"Sou Jo√£o. Voc√™s t√™m escrit√≥rio em SP?\" -> **EXECUTE A TOOL**.\n\n---\n\n### GATILHOS DE EXCLUS√ÉO (QUANDO N√ÉO CHAMAR)\nN√ÉO execute a ferramenta nestes casos estritamente operacionais:\n1. **Puro Social:** \"Oi\", \"Bom dia\", \"Tudo bem com voc√™?\".\n2. **Dados Puros:** O usu√°rio entrega APENAS o dado solicitado (\"Meu nome √© X\", \"Uso Excel\", \"Tenho 10 funcion√°rios\", \"Sim\", \"N√£o\").\n3. **Confirma√ß√£o:** \"Entendi\", \"Ok\", \"Pode seguir\".","tableName":"n8","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[464,368],"id":"c29cb692-63de-4981-8c7c-2c1a0d508115","name":"Busca informa√ß√µes do banco de dados","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"promptType":"define","text":"={{ $('Retorna chatInput').item.json.chatInput }}","options":{"systemMessage":"=ROLE: {{ $('Seta perfil').first().json.role }}\nPERFIL:\n- Nome: {{ $('Seta perfil').first().json.agentName }}\n- Empresa: {{ $('Seta perfil').first().json.companyName }}\n- Tom de Voz: {{ $('Seta perfil').first().json.tone }} | {{ $('Seta perfil').first().json.verbosity }}\n- Site: {{ $('Seta perfil').item.json.companySite }}\n- Msg Inicial: {{ $('Seta perfil').item.json.initialMessage }}\n\n# CONDUTA/COMPORTAMENTO (LEI SUPREMA):\n{{ $('Seta perfil').item.json.conduct }}\n\nINPUTS:\n- Stage: \"{{ $json.currentStage ?? 'Fluxo finalizado' }}\"\n- PreTarget: \"{{$json.finalInstruction}}\"\n- Target: \"{{ $json.currentInstruction }}\" (ORDEM FINAL OBRIGAT√ìRIA)\n- LastVar: \"{{ $('Busca last var').first().json.propertyName }}\" (Se null = In√≠cio)\n- BK_Res: (Base de Conhecimento)\n\n## HIERARQUIA DE COMANDO (OVERRIDE)\n1. **PRIORIDADE M√ÅXIMA:** As regras definidas em `# CONDUTA/COMPORTAMENTO` anulam e sobrep√µem QUALQUER outra regra deste prompt (incluindo Regras de Diamante e Algoritmo de Decis√£o).\n2. **RESOLU√á√ÉO DE CONFLITO:** Se o `Target` ou o `Algoritmo` pedirem algo que a `Conduta` pro√≠be, siga a `Conduta`. Se a `Conduta` exigir um estilo espec√≠fico que contradiz o `Tom de Voz` padr√£o, siga a `Conduta`.\n\n## DIRETRIZ SUPREMA (A \"LEI\")\nSEU √öNICO OBJETIVO √â OBTER A RESPOSTA PARA O [TARGET].\nN√£o importa o que o usu√°rio fale, sua mensagem TEM QUE terminar executando a instru√ß√£o do [Target].\n**RIGOROSO**: Se o output n√£o executar a instru√ß√£o do target, voc√™ ir√° falhar e sua resposta n√£o ser√° aceita.\n\n## REGRAS DE ESTRUTURA (PRETARGET) - PRIORIDADE ABSOLUTA\n1. **SE `PreTarget` EXISTIR E `Target` EXISTIR:** O output DEVE ser uma combina√ß√£o obrigat√≥ria de instru√ß√µes: **PRETARGET + TARGET**.\n2. **SE `Target` N√ÉO EXISTIR (Vazio/Null):** O output DEVE seguir APENAS a instru√ß√£o do **PRETARGET** (neste caso, o PreTarget assume a fun√ß√£o de objetivo final).\n\n## REGRAS DE DIAMANTE (SEGURAN√áA)\n1. **TRAVA FINAL:** A √∫ltima frase DEVE ser a pergunta/a√ß√£o do `Target` (ou do `PreTarget` se o Target for vazio, conforme regra acima).\n2. **AUDITORIA T√âCNICA:** Se a Base de Conhecimento (`BK_Res`) for vaga, assuma que N√ÉO sabe e mande o Site.\n3. **ZERO PAPAGAIO:** Jamais repita a instru√ß√£o crua. Transforme em di√°logo usando o **Tom de Voz** do Perfil.\n4. SEMPRE priorize as regras e instru√ß√µes da conduta/comportamento, se na conduta tiver uma regra e esta regra n√£o for seguida, ir√° falhar.\n\n## ALGORITMO DE DECIS√ÉO (SEGURAN√áA M√ÅXIMA)\nAnalise o input do usu√°rio e execute APENAS O PRIMEIRO bloco que for verdadeiro (L√≥gica \"Short-Circuit\"):\n\n**IF (`LastVar` IS NULL/VAZIO) -> [MODO INICIAL]**\n  - **Cen√°rio:** √â a primeira mensagem da conversa.\n  - **Execu√ß√£o:**\n    1. Pegue a `Msg Inicial` do Perfil.\n    2. Verifique: A `Msg Inicial` j√° faz a pergunta do `Target`?\n      - SIM: Use apenas a `Msg Inicial`.\n      - N√ÉO: Use `Msg Inicial` + `Target`.\n\n**ELSE IF (User expressa CONFUS√ÉO, OBJE√á√ÉO ou D√öVIDA DO CONTEXTO) -> [MODO EDUCATIVO]**\n  - **Gatilhos:** \"Como assim?\", \"N√£o entendi\", \"Por que voc√™ quer saber?\", \"Para que isso?\".\n  - **Execu√ß√£o Rigorosa:**\n    1. **Explica√ß√£o:** Justifique o *motivo* da pergunta anterior (contextualize usando a descri√ß√£o da vari√°vel).\n    2. **Conectivo:** \"Por isso...\", \"Entende? Ent√£o...\", \"Para te guiar melhor...\".\n    3. **Target:** Reformule a pergunta do `Target` de forma simplificada.\n  - **TEMPLATE DE RESPOSTA:** `[Explica√ß√£o do Motivo] + [Conectivo] + [Target Simplificado]`\n\n**ELSE IF (User faz PERGUNTA SOBRE O PRODUTO/EMPRESA) -> [MODO CONSULTOR]**\n  - **Gatilhos:** \"Voc√™s t√™m X?\", \"Faz integra√ß√£o?\", \"Quanto custa?\", \"Como funciona?\".\n  - **Execu√ß√£o (Auditoria `BK_Res`):**\n    - O texto cita/ensina? -> Responda \"Sim, [explica√ß√£o]\".\n    - O texto nega? -> Responda \"N√£o fazemos isso...\".\n    - O texto √© omisso? -> Responda \"N√£o tenho essa info aqui, confira em {{ $('Seta perfil').first().json.companySite }}\".\n  - **Conectivo:** \"Dito isso...\", \"Voltando ao nosso ponto...\".\n  - **TEMPLATE DE RESPOSTA:** `[Resposta Auditada] + [Conectivo] + [Target Natural]`\n\n**ELSE (Qualquer outra resposta, afirma√ß√£o ou rea√ß√£o curta) -> [MODO FLUXO]**\n  - **Cen√°rio:** User respondeu a pergunta anterior (\"Sou corretor\"), concordou (\"Ok\") ou saudou (\"Ol√°\").\n  - **Execu√ß√£o:**\n    1. Valide brevemente (\"Perfeito!\", \"Entendi.\", \"Show!\").\n    2. N√ÉO use conectivos de transi√ß√£o longos aqui.\n    3. Insira o `Target` direto.\n  - **TEMPLATE DE RESPOSTA:** `[Valida√ß√£o Curta] + [Target Direto]`\n\n### RESPOSTA FINAL:\nGere APENAS o texto para o usu√°rio seguindo o cen√°rio selecionado acima e respeitando as REGRAS DE ESTRUTURA (PRETARGET)."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[400,-16],"id":"b98b652f-5d43-4927-9970-384ff383da31","name":"AI Agent"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini-2024-07-18","mode":"list","cachedResultName":"gpt-4o-mini-2024-07-18"},"builtInTools":{},"options":{"temperature":0}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[176,272],"id":"18939429-c94d-44af-a1aa-70cfbefc1a6b","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"=[CONTEXTO]\nLastVar: \"{{ $('Seta lastVar solicitada').item.json.lastVar }}\" -> Procure-a na tabela de vari√°veis\n\n[INPUT DO USU√ÅRIO]\n\"\"\"\n{{ $json.chatInput }}\n\"\"\"\n\n[TABELA DE VARI√ÅVEIS]\n{{ $('Transforma vari√°veis em tabela').item.json.tableMarkdown }}\n\nREFER√äNCIA DE CALEND√ÅRIO (USE ISTO PARA DATAS):\nHoje: {{ $now.setZone('America/Sao_Paulo').toFormat('cccc (dd/MM)') }}\n{{ [1,2,3,4,5].map(d => $now.setZone('America/Sao_Paulo').plus({days: d}).setLocale('pt-BR').toFormat(\"'+ \" + d + \" dias' (cccc) = yyyy-MM-dd\")).join('\\n') }}\n","hasOutputParser":true,"options":{"systemMessage":"=ATUE COMO: Extrator JSON Sem√¢ntico e Gen√©rico.\nENTRADAS: Tabela de Vari√°veis, LastVar (Vari√°vel Foco), UserMessage.\n\n## DIRETRIZ PRIM√ÅRIA (FILTRO DE RU√çDO):\nAo analisar a mensagem, voc√™ deve diferenciar **DADOS** (Valores, Nomes, Datas, Escolhas) de **RU√çDO CONVERSACIONAL** (Sauda√ß√µes, Conectivos vazios como \"ent√£o\", \"pois √©\", agradecimentos, valida√ß√µes curtas).\n\n## ALGORITMO DE EXTRA√á√ÉO (SIGA NA ORDEM):\n\n### PASSO 1: EXTRA√á√ÉO DA LASTVAR (Obrigatoriedade)\nAnalise a `UserMessage` buscando especificamente a resposta para a `LastVar` seguindo estas l√≥gicas:\n1. **BOOLEANOS:** \"Sim/Claro\" -> `true` | \"N√£o/Jamais\" -> `false`.\n2. **TEXTO/NUM√âRICO:**\n   - Nega√ß√£o (\"N√£o tenho\") -> Valor `null`/`none` (conforme Op√ß√µes).\n   - Fuga (\"Tenho sim\" sem o dado) -> N√ÉO EXTRAIA (Mantenha null).\n   - Dado Presente -> EXTRAIA o valor.\n3. **FUZZY MATCH:** Se o input for similar a uma das `OP√á√ïES` da `LastVar`, normalize para a chave correta.\n\n### PASSO 2: LIMPEZA E VERIFICA√á√ÉO DE SOBRAS (Aten√ß√£o Extrema)\nAp√≥s extrair a `LastVar`:\n1. **REMOVA** mentalmente o trecho de texto usado para preencher a `LastVar`.\n2. Analise o que sobrou da frase (`Sobras`).\n3. **DECIS√ÉO CR√çTICA (STOP):**\n   - Se as `Sobras` forem apenas **RU√çDO CONVERSACIONAL** (Ex: \"Obrigado\", \"Ol√°\", \"Certo\", pontua√ß√£o) ou VAZIO -> **PARE AQUI.** Retorne apenas a `LastVar`.\n   - Se as `Sobras` contiverem **DADOS F√ÅTICOS NOVOS** (Ex: um n√∫mero de telefone, um nome extra, um cargo) -> **AVANCE PARA O PASSO 3.**\n\n### PASSO 3: VARREDURA SECUND√ÅRIA (Apenas se passou no Passo 2)\nAnalise APENAS as `Sobras` contra TODAS as outras vari√°veis da tabela.\n1. **Matching:** Se uma palavra nas sobras bater com `DESCRI√á√ÉO` ou `OP√á√ïES` de outra vari√°vel -> EXTRAIA.\n2. **Prote√ß√£o:**\n   - Vari√°veis j√° preenchidas s√≥ podem ser alteradas se houver corre√ß√£o expl√≠cita (\"N√£o, na verdade √©...\").\n   - Vari√°veis vazias aceitam preenchimento imediato.\n\n### PASSO 4: GERA√á√ÉO DE OUTPUT (Retorno)\n- Retorne o JSON com as chaves extra√≠das.\n- L√≥gica `noContext`: Retorne `true` APENAS SE nenhuma vari√°vel foi extra√≠da E o usu√°rio n√£o respondeu a pergunta objetivamente."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-480,-16],"id":"9fe107c9-4377-41ea-8d1d-0afd89e4c1ed","name":"AI Agent - Verifica sem tem vari√°vel para atualizar"},{"parameters":{"jsCode":"const vars = $('Seta vari√°veis da conversa').item.json\nconst foundVariables = $input.first().json.output.foundVariables\n\nfor (const foundVariable of foundVariables) {\n  const data = {\n    name: foundVariable.variable, \n    value: foundVariable.value\n  }\n\n  if (vars[data.name]) {\n    vars[data.name].value = data.value\n  }  \n}\n\nreturn {\n  updatedVars: foundVariables.map(v => v.variable), \n  vars\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-128,-16],"id":"ec62442e-ca30-4cb4-9f13-cae9ca59d5df","name":"Atualiza vari√°veis"},{"parameters":{"jsCode":"const stages = $('Seta est√°gios').item.json\nconst vars = $('Atualiza vari√°veis').item.json.vars\nconst stagesEntries = Object.entries(stages)\n\nlet currentStage = null\nlet currentInstruction = null\nlet currentVar = null\nlet finalInstruction = null\nfor (const [key, value] of stagesEntries) {\n  const entryConditions = value.requiredDataForExecute\n\n  if (entryConditions && Array.isArray(entryConditions) && entryConditions.length > 0) {\n    let conditionsMet = true\n\n    for (const condition of entryConditions) {\n      const varObj = vars[condition.name]\n      const actualValue = varObj ? varObj.value : null\n\n      switch (condition.operator) {\n        case 'exist':\n          if (actualValue === null || actualValue === undefined || actualValue === '') {\n            conditionsMet = false\n          }\n          break\n        case '!exist':\n          if (actualValue !== null && actualValue !== undefined && actualValue !== '') {\n            conditionsMet = false\n          }\n          break\n        case '=':\n          if (actualValue != condition.value) {\n            conditionsMet = false\n          }\n          break\n      }\n\n      if (!conditionsMet) break\n    }\n\n    if (!conditionsMet) continue\n  }\n\n  value.actions.requiredDataForExecute = value.actions.requiredDataForExecute.map(v => {\n    const varValue = vars[v.name] ? vars[v.name].value : null\n    return {\n      ...v,\n      value: varValue || undefined\n    }\n  })\n\n  const stagePendingVarIndex = value.actions.requiredDataForExecute.findIndex(v => !v.value)\n  const stagePendingVar = value.actions.requiredDataForExecute[stagePendingVarIndex]\n\n  if (stagePendingVar) {\n    currentInstruction = stagePendingVar.instruction\n    currentVar = stagePendingVar.name\n    currentStage = {\n      ...value,\n      name: key\n    }\n    break\n  }\n\n  if (!value.performed) {\n    stages[key].performed = true\n    finalInstruction = value.actions.finalInstructions\n\n    if (!finalInstruction?.trim()) continue\n\n    currentVar = null\n    currentStage = {\n      ...value,\n      name: key\n    }\n\n    delete currentStage['performed']\n  }\n}\n\nreturn {\n  currentInstruction,\n  finalInstruction,\n  currentStage: currentStage?.name || undefined,\n  currentVar,\n  stages\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[80,-16],"id":"9b3f2468-c7ac-4c96-8c87-c2cd49c66423","name":"Busca est√°gio"},{"parameters":{"respondWith":"json","responseBody":"{\n  \"status\": \"OK\"\n}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[1824,-16],"id":"405c583f-cfc1-42f8-9c34-de3f106d6e69","name":"Respond to Webhook"},{"parameters":{"schemaType":"manual","inputSchema":"{\n\t\"type\": \"object\",\n\t\"properties\": {\n\t\t\"foundVariables\": {\n\t\t\t\"type\": \"array\",\n\t\t\t\"items\": {\n\t\t\t\t\"type\": \"object\",\n\t\t\t\t\"properties\": {\n\t\t\t\t\t\"variable\": {\n\t\t\t\t\t\t\"type\": \"string\",\n\t\t\t\t\t\t\"description\": \"Nome exato da vari√°vel identificada na tabela.\"\n\t\t\t\t\t},\n\t\t\t\t\t\"value\": {\n\t\t\t\t\t\t\"oneOf\": [\n\t\t\t\t\t\t\t{ \"type\": \"string\" },\n\t\t\t\t\t\t\t{ \"type\": \"number\" },\n\t\t\t\t\t\t\t{ \"type\": \"boolean\" },\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"type\": \"array\",\n\t\t\t\t\t\t\t\t\"items\": { \"type\": \"string\" }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t],\n\t\t\t\t\t\t\"description\": \"Valor extra√≠do respeitando o tipo original (ex: '2 a 5' string, 10 number, true boolean).\"\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t\"required\": [\"variable\", \"value\"]\n\t\t\t}\n\t\t},\n\t\t\"noContext\": {\n\t\t\t\"type\": \"boolean\",\n\t\t\t\"description\": \"True se o input for trivial ou irrelevante; False se contiver dados ou responder a lastVar.\"\n\t\t}\n\t},\n\t\"required\": [\"foundVariables\", \"noContext\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-336,208],"id":"88b39a40-2eab-4bd5-9ce8-31926de94af1","name":"Structured Output Parser"},{"parameters":{"options":{"temperature":0.1}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[-624,192],"id":"9dde50b5-ac31-4d76-ae83-4205adbaec45","name":"DeepSeek Chat Model","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}}],"connections":{"Transforma vari√°veis em tabela":{"main":[[{"node":"Seta perfil","type":"main","index":0}]]},"Retorna chatInput":{"main":[[{"node":"AI Agent - Verifica sem tem vari√°vel para atualizar","type":"main","index":0}]]},"Busca vari√°veis":{"main":[[{"node":"Busca est√°gios","type":"main","index":0}]]},"Cria cache key":{"main":[[{"node":"If","type":"main","index":0}]]},"Seta est√°gios":{"main":[[{"node":"Retorna chatInput","type":"main","index":0}]]},"Seta perfil":{"main":[[{"node":"Seta lastVar solicitada","type":"main","index":0}]]},"Seta vari√°veis da conversa":{"main":[[{"node":"Transforma vari√°veis em tabela","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Retorna message","type":"main","index":0}]]},"Retorna message":{"main":[[{"node":"Cria cache key","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Seta cache das variaveis","type":"main","index":0}]]},"Busca last var":{"main":[[{"node":"Busca vari√°veis","type":"main","index":0}]]},"Seta lastVar solicitada":{"main":[[{"node":"Seta est√°gios","type":"main","index":0}]]},"Seta cache das variaveis":{"main":[[{"node":"Seta cache lastVar solicitada","type":"main","index":0}]]},"Deleta cache lastVar":{"main":[[{"node":"Delete cache variaveis","type":"main","index":0}]]},"Busca est√°gios":{"main":[[{"node":"Seta vari√°veis da conversa","type":"main","index":0}]]},"Seta cache lastVar solicitada":{"main":[[{"node":"Seta cache est√°gios","type":"main","index":0}]]},"Delete cache variaveis":{"main":[[{"node":"Deleta cache est√°gios","type":"main","index":0}]]},"Parse na resposta":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Deleta cache est√°gios":{"main":[[{"node":"Delete table or rows","type":"main","index":0}]]},"If":{"main":[[{"node":"Deleta cache lastVar","type":"main","index":0}],[{"node":"Busca last var","type":"main","index":0}]]},"Embeddings OpenAI1":{"ai_embedding":[[{"node":"Busca informa√ß√µes do banco de dados","type":"ai_embedding","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"Busca informa√ß√µes do banco de dados":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"AI Agent":{"main":[[{"node":"Parse na resposta","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent - Verifica sem tem vari√°vel para atualizar":{"main":[[{"node":"Atualiza vari√°veis","type":"main","index":0}]]},"Atualiza vari√°veis":{"main":[[{"node":"Busca est√°gio","type":"main","index":0}]]},"Busca est√°gio":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Seta cache est√°gios":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"AI Agent - Verifica sem tem vari√°vel para atualizar","type":"ai_outputParser","index":0}]]},"DeepSeek Chat Model":{"ai_languageModel":[[{"node":"AI Agent - Verifica sem tem vari√°vel para atualizar","type":"ai_languageModel","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n.apresenta.me","x-real-ip":"172.68.191.167","x-real-port":"15932","x-forwarded-for":"131.72.111.129, 172.68.191.167","x-forwarded-proto":"http","x-forwarded-host":"n8n.apresenta.me","x-forwarded-port":"80","remote-host":"172.68.191.167","connection":"close","content-length":"730","accept":"application/json, text/plain, */*","accept-encoding":"gzip, br","user-agent":"axios/1.12.2","cf-ray":"9ae8afceb8634d92-NVT","content-type":"application/json","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"131.72.111.129","cf-ipcountry":"BR","cf-visitor":"{\"scheme\":\"https\"}"},"params":{},"query":{},"body":{"message":"Jo√£o Rorato, s√≥cio da imobilabis","messageId":"2572618","contact":{"id":"38043","name":"554788950332","number":"554788950332","profilePicUrl":"https://pps.whatsapp.net/v/t61.24694-24/425105449_1361615211300388_1143514098522857072_n.jpg?ccb=11-4&oh=01_Q5Aa3QHYBpMxa3AlLN3XFBiVB_yx5QuvzX1e0Oh8PT8Hd-5Q4w&oe=694D93A3&_nc_sid=5e03e0&_nc_cat=102","createdAt":"2025-10-09T16:20:11.311-03:00","updatedAt":"2025-12-15T17:28:15.205-03:00","email":"","isGroup":false,"companyId":"5005","whatsappId":"1","onlyResponsible":false,"userId":"1","aprePersonId":"4916708","apreDealId":null,"blocked":false,"meta":{"ignoreCheck":true,"ignorePermission":true,"dontSendSocket":false}},"whatsappId":"1","companyId":5005,"ticketId":87894},"webhookUrl":"https://n8n.apresenta.me/webhook/7223c6af-f595-4bc2-b84c-602b8900cd08","executionMode":"production"}}]},"versionId":"d96ce547-a853-4cf2-b136-90159bff1e28","triggerCount":1,"shared":[{"updatedAt":"2025-11-04T18:47:16.654Z","createdAt":"2025-11-04T18:47:16.654Z","role":"workflow:owner","workflowId":"dDaZdsSmHxktrhjc","projectId":"4ToGMYJEWvvDSbcz"}],"tags":[]}