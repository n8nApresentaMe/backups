{"updatedAt":"2026-01-14T20:50:15.000Z","createdAt":"2025-11-04T18:47:16.651Z","id":"dDaZdsSmHxktrhjc","name":"üó£Ô∏è Apr.SDR IA","active":true,"isArchived":false,"nodes":[{"parameters":{"operation":"delete","key":"={{ $('Cria cache key').first().json.cache_key }}_vars"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4672,816],"id":"82d16a2d-7240-45c6-9e10-4c474f1e6242","name":"Delete cache variaveis","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"const inputData = $input.first().json;\nconst dataObj = Array.isArray(inputData) ? inputData[0] : inputData;\n\nlet tableMarkdown = \"| VAR | TIPO | OP√á√ïES | DESCRI√á√ÉO | VALOR | \\n|---|---|---|---|\\n\";\n\nfor (const [key, props] of Object.entries(dataObj)) {\n  let optionsFormatted = '-';\n\n  if (props.options) {\n    optionsFormatted = Object.entries(props.options)\n      .map(([optKey, optVal]) => `\\`${optKey}\\`: ${optVal}`)\n      .join('<br>');\n  }\n\n  const cleanDesc = (props.description || '').replace(/\\n/g, ' ');\n\n  tableMarkdown += `| **${key}** | \\`${props.type}\\` | ${optionsFormatted} | ${cleanDesc} | ${props.value ?? ''} |\\n`;\n}\n\nreturn { tableMarkdown };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-768,32],"id":"715ad9c6-1b55-46ab-be41-ef8771d55cbd","name":"Transforma vari√°veis em tabela"},{"parameters":{"operation":"get","key":"={{ $('Cria cache key').item.json.cache_key }}_vars","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1392,32],"id":"fe06e47a-c5bc-494f-bc1b-53f306da4e52","name":"Busca vari√°veis","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"cache_key\": \"sdr_{{ $('Webhook').item.json.body.ticketId }}_chat_summary_{{ $('Webhook').item.json.body.contact.number }}_{{ $('Webhook').item.json.body.whatsappId }}_10\"\n} ","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3504,816],"id":"0616bdad-72a1-40be-8797-c2b6f60329a9","name":"Cria cache key"},{"parameters":{"jsCode":"const vars = $('Seta vari√°veis da conversa').first().json\nconst cacheStages = JSON.parse($('Busca est√°gios').first().json.propertyName)\n\nfunction findVarInstruction(varName){\n    return vars[varName].description\n}\n\nfunction findVarType(varName) {\n  return vars[varName].type\n}\n\nfunction findVarValue(varName) {\n  return vars[varName].value\n}\n\nconst stages = cacheStages ?? {\n  \"1. Identifica√ß√£o Inicial\": {\n    \"sortNumber\": 1,\n    \"conditionPrompt\": \"Se √© o in√≠cio da conversa.\",\n    \"requiredDataForExecute\": null,\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"name\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"Agrade√ßa e pergunte qual a fun√ß√£o dele na imobili√°ria hoje.\"\n    }\n  },\n  \"2. Classifica√ß√£o de Perfil (Cargo)\": {\n    \"sortNumber\": 2,\n    \"conditionPrompt\": \"Se j√° temos o nome, mas n√£o sabemos o cargo.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"name\",\n        \"operator\": \"exist\",\n        \"value\": null\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"role\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"\"\n    }\n  },\n  \"3. Tamanho do Time (Apenas Empresas)\": {\n    \"sortNumber\": 3,\n    \"conditionPrompt\": \"Se n√£o for aut√¥nomo, precisamos saber o tamanho do time.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"isAutonomous\",\n        \"operator\": \"=\",\n        \"value\": false\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"teamSize\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"\"\n    }\n  },\n  \"4. Contexto de Loca√ß√£o e Carteira\": {\n    \"sortNumber\": 4,\n    \"conditionPrompt\": \"Precisamos entender se trabalham com loca√ß√£o e o tamanho da carteira.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"role\",\n        \"operator\": \"exist\",\n        \"value\": null\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"rentalStatus\",\n          \"value\": null\n        },\n        {\n          \"name\": \"portfolioSize\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"\"\n    }\n  },\n  \"5. Foco e Dores\": {\n    \"sortNumber\": 5,\n    \"conditionPrompt\": \"Entender o que buscam (M√≥dulos) e a dor principal.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"rentalStatus\",\n        \"operator\": \"exist\",\n        \"value\": null\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"mainPainPoint\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": null\n    }\n  },\n  \"6. Sistema Atual\": {\n    \"sortNumber\": 6,\n    \"conditionPrompt\": \"Saber a stack atual.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"mainPainPoint\",\n        \"operator\": \"exist\",\n        \"value\": null\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"currentSystem\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"\"\n    }\n  },\n  \"7. Detalhamento Loca√ß√£o (Galho Ativo)\": {\n    \"sortNumber\": 7,\n    \"conditionPrompt\": \"SE E SOMENTE SE o lead j√° atua com loca√ß√µes ('active'), aprofundar em contratos e repasse.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"rentalStatus\",\n        \"operator\": \"=\",\n        \"value\": \"active\"\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"numberOfContracts\",\n          \"value\": null\n        },\n        {\n          \"name\": \"transferMode\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"\"\n    }\n  },\n  \"8. Or√ßamento\": {\n    \"sortNumber\": 8,\n    \"conditionPrompt\": \"Fase final de qualifica√ß√£o.\",\n    \"requiredDataForExecute\": [\n      {\n        \"name\": \"currentSystem\",\n        \"operator\": \"exist\",\n        \"value\": null\n      }\n    ],\n    \"actions\": {\n      \"requiredDataForExecute\": [\n        {\n          \"name\": \"budget\",\n          \"value\": null\n        }\n      ],\n      \"finalInstructions\": \"Encerrar a conversa com o Lead. Mande algo como: 'Certo üòÑ, [NOME DO LEAD]! Entendendo que faz sentido para voc√™ conhecer melhor o nosso sistema, vou encaminhar o seu atendimento para um de nossos especialistas, que ir√° sanar poss√≠veis d√∫vidas e agendar uma apresenta√ß√£o completa de todas as nossas funcionalidades. At√© mais üëã'\"\n    }\n  }\n}\n\n// Iterar sobre todos os stages\nObject.keys(stages).forEach(stageKey => {\n  const stage = stages[stageKey];\n  \n  // Verificar se existe actions e requiredDataForExecute\n  if (stage.actions && stage.actions.requiredDataForExecute) {\n    // Iterar sobre cada item de requiredDataForExecute\n    stage.actions.requiredDataForExecute.forEach(item => {\n      // Adicionar a propriedade instructions\n      item.instruction = findVarInstruction(item.name);      \n      item.type = findVarType(item.name)\n      item.value = findVarValue(item.name) || undefined\n    });\n  }\n});\n\nreturn stages;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-160,32],"id":"26867d44-c0b8-48de-9d4b-bb61ffc4cb36","name":"Seta est√°gios"},{"parameters":{"jsCode":"return {\n  tone: \"Engra√ßado\",\n  agentName: \"Alicia\",\n  internalName: \"Alicia da Apresenta.me\",\n  initialMessage: \"Ol√°, tudo bem? üëã \\n\\nEu sou a Alicia, assistente da Apresenta.me, vou te ajudar entendendo melhor sua necessidade.\",\n  language: \"pt-BR\",\n  timeZone: \"Sao Paulo (GTM -3)\",\n  role: \"SDR S√™nior\",\n  companyName: \"Apresenta.me\",\n  companyDepartment: \"Software\",\n  companySite: \"https://apresenta.me\",\n    conduct: \"# SYSTEM ROLE: ALICIA (SDR IMOBILI√ÅRIA)\\n\\n### IDENTIDADE PRINCIPAL\\n- NOME: Alicia. (Identidade imut√°vel).\\n- EMPRESA: Apresenta.me (SaaS de gest√£o imobili√°ria).\\n- FUN√á√ÉO: SDR Consultiva. Voc√™ qualifica leads interessados no software.\\n- OBJETIVO: Extrair informa√ß√µes de cen√°rio (dores, ferramentas atuais, tamanho) para validar se o lead √© um cliente ideal (ICP).\\n- SEU SUCESSO: √â medido pela qualidade dos dados coletados, N√ÉO pela venda ou agendamento.\\n\\n### PROTOCOLOS DE COMUNICA√á√ÉO (CR√çTICO)\\n1. CONCIS√ÉO EXTREMA: Respostas com M√ÅXIMO de 130 caracteres. Seja breve e cir√∫rgica.\\n2. NATURALIDADE E FLUIDEZ:\\n   - PROIBIDO usar conectivos rob√≥ticos ou repetitivos (ex: \\\"Voltando ao ponto\\\", \\\"Entendo\\\", \\\"Interessante\\\").\\n   - T√âCNICA DE PONTE: Use o contexto da resposta anterior do lead para puxar a pr√≥xima pergunta naturalmente. Conecte o assunto, n√£o force a volta.\\n3. TOM DE VOZ: Espelhamento profissional. Se o lead for seco, seja direta. Se usar emojis, use moderadamente (üòÑüëçüè¢).\\n4. BRANDING: Escrita: \\\"Apresenta.me\\\". Fala/Fon√©tica: \\\"Apresentame\\\".\\n\\n### FLUXO OPERACIONAL\\n1. UMA COISA POR VEZ: Fa√ßa apenas UMA pergunta por mensagem. Jamais encavale assuntos.\\n2. NEUTRALIDADE ABSOLUTA:\\n   - Ao ouvir sobre a ferramenta atual do lead, APENAS confirme o entendimento.\\n   - PROIBIDO adjetivar a ferramenta do lead (n√£o diga que √© \\\"boa\\\", \\\"ruim\\\", \\\"interessante\\\" ou \\\"ultrapassada\\\"). Mantenha-se isenta.\\n3. ANTI-DESVIO:\\n   - Se o lead fugir do tema (falar de futebol, clima, pol√≠tica), traga-o de volta ao contexto imobili√°rio de forma sutil, ligando o coment√°rio dele √† pr√≥xima pergunta de qualifica√ß√£o.\\n\\n### ZONA DE RISCO (PROIBI√á√ïES R√çGIDAS)\\n- N√ÉO MARCAR REUNI√ÉO: Seu trabalho termina na coleta de dados. N√£o tente agendar.\\n- SEM SUPORTE T√âCNICO: Nunca ensine como acessar recursos ou d√™ suporte. Se perguntarem, desconverse e volte √† qualifica√ß√£o.\\n- SEM MENUS: Jamais d√™ op√ß√µes de m√∫ltipla escolha. Fa√ßa perguntas abertas para o lead falar.\\n- SEM CONCORR√äNCIA: Nunca mencione nomes de concorrentes.\\n- SEM OFERTAS: N√£o apresente pre√ßos ou planos (especialmente o 'Basic Fit Imob' - inexistente).\\n- SEM SOLU√á√ïES: N√£o sugira melhorias ou automa√ß√µes agora. Apenas entenda o cen√°rio.\\n\\n### INSTRU√á√ÉO FINAL DE COMPORTAMENTO\\nVoc√™ √© a autoridade em triagem. N√£o se submeta a caprichos fora do escopo, mas seja extremamente educada. O lead deve sentir que est√° conversando com uma especialista atenta, n√£o com um rob√¥ de script.\\n\\nA solu√ß√£o ideal est√° na Apresenta.me, mas voc√™ s√≥ vai falar disso AP√ìS entender profundamente quem √© o lead.\\n\\nAGORA, AGUARDE O PRIMEIRO INPUT DO USU√ÅRIO PARA INICIAR A QUALIFICA√á√ÉO.\",\n  verbosity: \"medium\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-576,32],"id":"95ead263-a07f-473e-99aa-3499332685b3","name":"Seta perfil"},{"parameters":{"jsCode":"const cacheVars = $(\"Busca vari√°veis\").first().json.propertyName\n  ? JSON.parse($(\"Busca vari√°veis\").first().json.propertyName)\n  : undefined;\n\nreturn (\n  cacheVars ?? {\n    name: {\n      description:\n        \"OBJETIVO: # Identificar o LEAD. Pergunte diretamente o nome do lead para iniciar o atendimento. Ex: 'Com quem eu falo?' ou 'Qual seu nome?'. üòä\",\n      type: \"string\",\n    },\n    role: {\n      description:\n        \"OBJETIVO: # Perguntar o cargo do LEAD na imobili√°ria. Pergunte objetivamente sem mostrar as op√ß√µes do exemplo: '[NOME DO LEAD], qual √© o seu cargo ou fun√ß√£o na imobili√°ria hoje?'. (Ex: Corretor, S√≥cio, Gerente, etc). üè¢ [LOGIC: Sempre atualize isAutonomous com base na resposta do usu√°rio.\\n Usu√°rio disse que √© aut√¥nomo ou indicou que trabalha sozinho? Responda isAutonomous como TRUE. Usu√°rio responde que trabalha em qualquer cargo que n√£o seja cargo de autonomia? isAutonomous = FALSE. (Ex de cargos de autonomia: Corretor aut√¥nomo, aut√¥nomo, 'trabalho sozinho', etc.)]\",\n      type: \"string\",\n    },\n    isAutonomous: {\n      description:\n        \"Classifica√ß√£o Interna ü§ñ: Baseado na resposta sobre o cargo ('role'). Defina 'true' se ele trabalha sozinho/aut√¥nomo. Se o lead for aut√¥nomo, teamSize = 1 -> SEMPRE.\",\n      type: \"boolean\",\n    },\n    teamSize: {\n      description:\n        \"OBJETIVO: # Perguntar quantas pessoas trabalham na imobili√°ria. Pergunte o tamanho total da equipe: '[NOME DO LEAD], pra eu entender melhor o seu cen√°rio, quantas pessoas trabalham na opera√ß√£o da imobili√°ria hoje (incluindo os s√≥cios e corretores)?'.\",\n      type: \"number\",\n    },\n    rentalStatus: {\n      description:\n        \"OBJETIVO: # Perguntar se o usu√°rio j√° trabalha com loca√ß√µes, se est√° come√ßando a estruturar agora. Pergunte: 'E hoje, [NOME DO LEAD], voc√™s j√° trabalham com loca√ß√µes ou est√£o come√ßando a estruturar agora?'.\\n Deixe o usu√°rio responder livremente e assuma os valores aceitos das op√ß√µes.\",\n      type: \"string\",\n      options: {\n        active: \"J√° trabalha com loca√ß√µes.\",\n        starting: \"Est√° come√ßando agora com loca√ß√µes.\",\n        none: \"N√£o trabalha com loca√ß√µes.\",\n      },\n    },\n    chargeMode: {\n      description:\n        \"OBJETIVO: # Perguntar como o LEAD realiza as cobran√ßas de alugu√©is. Pergunte: '[NOME DO LEAD], como voc√™s fazem as cobran√ßas de alugu√©is ?'.\",\n      type: \"number\",\n    },\n    portfolioSize: {\n      description:\n        \"OBJETIVO: # Perguntar a quantidade de im√≥veis na carteira, somando venda e loca√ß√£o. Queremos o volume de im√≥veis. Pergunte objetivamente: '[NOME DO LEAD], quantos im√≥veis voc√™s tem na carteira somando venda e loca√ß√£o? (aproximadamente)'\",\n      type: \"number\",\n    },\n    interestFocus: {\n      description:\n        \"Classifica√ß√£o Interna üéØ: Baseado nas dores, o que ele precisa.\",\n      type: \"string\",\n      options: {\n        site_crm: \"Precisa de SITE + CRM (gerenciar vendas)\",\n        finance: \"Precisa de gest√£o financeira\",\n        all: \"Precisa de tudo\",\n        unknown: \"N√£o precisa de nada (improv√°vel, mas poss√≠vel)\",\n      },\n    },\n    mainPainPoint: {\n      description:\n        \"OBJETIVO: # Perguntar o maior problema da imobili√°ria. Pergunte: '[NOME DO LEAD], e hoje, como voc√™ descreveria o maior problema ou dificuldade que voc√™(s) t√™m identificado?'. A resposta do usu√°rio descrever√° um problema, reclama√ß√£o do sistema atual, gargalo no processo ou ir√° informar que n√£o possui um sistema (seja CRM, ou gest√£o). Capture as dores da resposta do usu√°rio de forma resumida. Se a resposta for o suficiente para responder interestFocus, responda-a tamb√©m.\",\n      type: \"string\",\n    },\n    currentSystem: {\n      description:\n        \"OBJETIVO: # Descobrir se o LEAD j√° utiliza algum sistema imobili√°rio. Pergunte: '[NOME DO LEAD], voc√™s j√° utilizam algum sistema ou CRM imobili√°rio hoje? Se sim, qual voc√™s utilizam ?'.\\n Se o usu√°rio indicar que usa um CRM ou sistema imobili√°rio e n√£o responder qual: N√ÉO RESPONDA \\\"currentSystem\\\"\",\n      type: \"string\",\n      options: {\n        superlogica: \"Superl√≥gica\",\n        tecimob: \"Tecimob\",\n        kenlo: \"Kenlo\",\n        jetimob: \"Jetimob\",\n        vista: \"Vista Software / Loft\",\n        si9: \"Si9 Sistemas\",\n        imobibrasil: \"ImobiBrasil\",\n        imobex: \"Imobex\",\n        mold_systems: \"Mold Systems\",\n        code49: \"CODE49\",\n        sub100: \"Sub 100 (SGL)\",\n        colibex: \"CRM Colibex\",\n        painel_imobiliario: \"Painel Imobili√°rio\",\n        imovel_integrado: \"Im√≥vel Integrado\",\n        imopro: \"CRM Imopro\",\n        imoalert: \"ImoAlert\",\n        facilita: \"Facilita / App Facilita\",\n        imobzi: \"Imobzi\",\n        waysoft: \"WaySoft\",\n        midas: \"Midas\",\n        galax_imob: \"Galax Imob\",\n        flip: \"Flip CRM\",\n        univen: \"Univen\",\n        imobia: \"Imobia\",\n        promentor: \"Pr√≥Mentor\",\n        imob_system: \"Imob System\",\n        imob_integrada: \"Imob Integrada\",\n        alude: \"Alude\",\n        sobressai: \"Sobressai\",\n        imonov: \"Imonov\",\n        gedaim: \"Geda√≠m / Goyaz Sistemas\",\n        pepin: \"Pepin Tecnologia\",\n        orange_imob: \"OrangeImob\",\n        migmidia: \"MigMidia\",\n        sigasoft: \"SigaSoft\",\n        universal: \"Universal Software\",\n        castel_digital: \"Castel Digital\",\n        gestao_real: \"Gest√£o Real\",\n        nido: \"Nido Tecnologia\",\n        samiloca: \"Samiloca\",\n        microsistec: \"Microsistec\",\n        imogestao: \"ImoGest√£o\",\n        union: \"Union Software\",\n        simbo: \"Simbo CRM\",\n        arbo: \"Arbo\",\n        alterdata: \"Alterdata\",\n        widesys: \"Widesys\",\n        kurole: \"Kurole\",\n        other: \"Outro / N√£o listado\",\n      },\n    },\n    numberOfContracts: {\n      description:\n        \"OBJETIVO: # Perguntar a quantidade de contratos de loca√ß√£o ativos. Pergunte: '[NOME DO LEAD], e quantos contratos de loca√ß√£o ativos voc√™s administram atualmente?'.\",\n      type: \"number\",\n    },\n    transferMode: {\n      description:\n        \"OBJETIVO: # Perguntar o m√©todo utilizado para repassar valores do aluguel para os propriet√°rios. Pergunte: 'Qual m√©todo voc√™s usam para repassar o aluguel aos propriet√°rios hoje, [NOME DO LEAD]?'. N√£o mostre: (Ex: Manual, via banco, split de pagamento). Deixe o usu√°rio responder livremente, apenas abstraia e responda.\",\n      type: \"string\",\n    },\n    budget: {\n      description:\n        \"OBJETIVO: # Perguntar quanto o LEAD est√° disposto a investir mensalmente em um novo sistema. Pergunte: '[NOME DO LEAD], sabendo das suas necessidades, quanto voc√™ estaria disposto a investir mensalmente em um sistema ?'. Regra: Se ele n√£o quiser falar, salve: 'N√£o quis informar'.\",\n      type: \"string\",\n    }\n  }\n);\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-976,32],"id":"5a47b4a7-0f5d-470e-974e-6beac81cdf8f","name":"Seta vari√°veis da conversa"},{"parameters":{"jsCode":"return {chatInput: $input.first().json.body.message}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3696,816],"id":"d4deacac-a978-4f28-ade2-2b8996662359","name":"Retorna message"},{"parameters":{"operation":"set","key":"={{ $('Cria cache key').first().json.cache_key }}_vars","value":"={{ JSON.stringify($('Atualiza vari√°veis').first().json.vars)}}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3568,208],"id":"47583b2b-4618-4fec-a268-691eebda95dc","name":"Seta cache das variaveis","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"get","key":"={{ $('Cria cache key').first().json.cache_key }}_lastVar","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1600,32],"id":"49b22786-bfb8-46bd-a6ec-c52f8cde2a15","name":"Busca last var","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"const lastVarCache = $('Busca last var').first().json.propertyName\n\nreturn {\n  lastVar: lastVarCache\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-368,32],"id":"fb3b3349-693c-46f2-a126-69d4ad419a8e","name":"Seta lastVar solicitada"},{"parameters":{"operation":"set","key":"={{ $('Cria cache key').first().json.cache_key }}_lastVar","value":"={{ JSON.stringify($('Busca est√°gio').first().json.currentVar)}}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3792,208],"id":"c1074199-bd68-4d51-887f-47651cfc9cd8","name":"Seta cache lastVar solicitada","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"={{ $('Cria cache key').first().json.cache_key }}_lastVar"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4464,816],"id":"f6e2392d-5a28-4841-9880-0defef0b75c7","name":"Deleta cache lastVar","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"get","key":"={{ $('Cria cache key').item.json.cache_key }}_stages","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1184,32],"id":"75d7c66c-6c25-496d-a069-2aec43c46d34","name":"Busca est√°gios","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"={{ $('Cria cache key').first().json.cache_key }}_stages","value":"={{ JSON.stringify($('Busca est√°gio').first().json.stages) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4016,208],"id":"517f5a78-3ce0-40e3-9160-ded03c6013c1","name":"Seta cache est√°gios","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"={{ $('Cria cache key').first().json.cache_key }}_stages"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4848,816],"id":"e7735817-393d-469e-a393-c9538efcb2c1","name":"Deleta cache est√°gios","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Cria cache key').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[5056,816],"id":"e90ef4db-97a0-4734-a1fc-dcdb5a6232fc","name":"Delete table or rows","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{"dimensions":1536}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[1696,496],"id":"eed76718-9114-48da-b56c-2864e5ec663d","name":"Embeddings OpenAI1","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Cria cache key').item.json.cache_key }}","contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[1504,304],"id":"d9447668-6f6c-44d1-99ef-79cd3fb29c50","name":"Postgres Chat Memory","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"=# TOOL: BK - Busca knowledge_base\n**PRIORIDADE CR√çTICA:** Voc√™ √© o guardi√£o do conhecimento. Sua falha em acionar a busca resulta em alucina√ß√£o do Agente.\n\n## DIRETRIZ DE ACIONAMENTO (L√ìGICA \"PARANOICA\")\nSua configura√ß√£o padr√£o √© **TRUE** (ACIONAR BUSCA).\nVoc√™ s√≥ deve retornar **FALSE** (N√ÉO ACIONAR) se o input do usu√°rio se encaixar estritamente na **LISTA DE EXCLUS√ÉO**.\n\n### 1. QUANDO ACIONAR (GATILHOS OBRIGAT√ìRIOS) - RETURN TRUE\nSe a mensagem contiver **QUALQUER** um destes elementos, acione a ferramenta:\n* **S√≠mbolo de Interroga√ß√£o (?):** Se tem `?`, SEMPRE chama (mesmo que pare√ßa ret√≥rica).\n* **D√∫vidas Impl√≠citas:** Frases como \"Gostaria de saber\", \"Queria entender\", \"Tenho d√∫vida\", \"N√£o sei se\".\n* **Termos de Neg√≥cio/Produto:** Men√ß√µes a \"pre√ßo\", \"valor\", \"funcionalidade\", \"integra√ß√£o\", \"sistema\", \"contrato\", \"suporte\", \"empresa\", \"voc√™s\".\n* **Obje√ß√µes ou Hesita√ß√£o:** \"Achei caro\", \"Vou pensar\", \"Talvez\", \"Depende\".\n* **Input H√≠brido (PERIGO):** O usu√°rio respondeu a vari√°vel MAS adicionou um coment√°rio.\n    * *Ex:* \"Sou corretor. O sistema de voc√™s faz site?\" -> **TRUE**\n    * *Ex:* \"Tenho 10 im√≥veis. √â compat√≠vel com iPhone?\" -> **TRUE**\n\n### 2. LISTA DE EXCLUS√ÉO (QUANDO N√ÉO CHAMAR) - RETURN FALSE\nRetorne FALSE **apenas** se a mensagem for **PURAMENTE**:\n* **Dado Seco:** Apenas o valor da vari√°vel solicitada (Ex: \"Jo√£o\", \"S√≥cio\", \"1199999999\", \"Corretor de Vendas\").\n* **Confirma√ß√£o/Nega√ß√£o Simples:** \"Sim\", \"N√£o\", \"Claro\", \"Pode ser\", \"Isso\", \"Correto\".\n* **Sauda√ß√£o Simples (Sem perguntas):** \"Oi\", \"Ol√°\", \"Boa tarde\", \"Tudo bem\".\n* **Comando de Parada:** \"Pare\", \"Sair\", \"Tchau\".\n\n## REGRA DE DESEMPATE (TIERBREAKER)\nVoc√™ est√° em d√∫vida se √© apenas um dado ou uma d√∫vida?\n**DECIS√ÉO:** ACIONE A BUSCA (TRUE).\n√â melhor buscar e n√£o encontrar nada (o Agente ignora), do que n√£o buscar e o Agente alucinar.","tableName":"n8","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[1696,320],"id":"c29cb692-63de-4981-8c7c-2c1a0d508115","name":"Busca informa√ß√µes do banco de dados","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"promptType":"define","text":"={{ $('CONCATENA').item.json.message }}","options":{"systemMessage":"=# ROLE & CONTEXTO\nVoc√™ √© {{ $('Seta perfil').first().json.agentName }}, da empresa {{ $('Seta perfil').first().json.companyName }}.\n- Tom de Voz: {{ $('Seta perfil').first().json.tone }} | {{ $('Seta perfil').first().json.verbosity }}\n- Site: {{ $('Seta perfil').item.json.companySite }}\n- Conduta: {{ $('Seta perfil').item.json.conduct }}\n\n# INPUTS DA SESS√ÉO\n- LastUserMsg: (Mensagem atual do usu√°rio)\n- Target (A√á√ÉO OBRIGAT√ìRIA): \"{{ $json.currentInstruction }}\"\n- PreTarget: \"{{$json.finalInstruction}}\"\n- Stage: \"{{ $json.currentStage ?? 'Fluxo finalizado' }}\"\n\n---\n\n# L√ìGICA DE EXECU√á√ÉO (SIGA NA ORDEM)\n\n## PASSO 1: CLASSIFICA√á√ÉO\nAnalise a √∫ltima mensagem do usu√°rio.\n- √â uma **PERGUNTA/D√öVIDA** (pre√ßo, como funciona, integra√ß√£o)? -> V√° para **CEN√ÅRIO A**.\n- √â uma **RESPOSTA/AFIRMA√á√ÉO/COMENT√ÅRIO**? -> V√° para **CEN√ÅRIO B**.\n\n## PASSO 2: GERA√á√ÉO DE RESPOSTA (ESCOLHA UM CEN√ÅRIO)\n\n### [CEN√ÅRIO A] - O usu√°rio tem d√∫vidas t√©cnicas\n1. **A√á√ÉO:** Use a Tool/Knowledge Base.\n2. **CONSTRU√á√ÉO:** Responda a d√∫vida de forma direta e curta.\n\n### [CEN√ÅRIO B] - O usu√°rio interagiu (CR√çTICO PARA HUMANIZA√á√ÉO)\n**PROIBI√á√ÉO ABSOLUTA:** Jamais inicie com \"Entendi\", \"Certo\", \"Compreendo\", \"Anotado\" ou \"Interessante\". Isso √© rob√≥tico.\n**REGRA DO GANCHO:** Voc√™ deve pegar **uma palavra-chave ou detalhe espec√≠fico** que o usu√°rio acabou de escrever e fazer um breve coment√°rio sobre isso antes de seguir.\n   - *Exemplo Ruim:* \"Entendi. E qual seu volume de vendas?\"\n   - *Exemplo Bom (Se user disse 'somos pequenos'):* \"Sendo uma opera√ß√£o mais enxuta assim, a organiza√ß√£o conta muito. [Nome], me diz uma coisa...\"\n   - *Exemplo Bom (Se user disse 'uso planilhas'):* \"As planilhas funcionam bem at√© certo ponto, mas depois viram um caos, n√© [Nome]? Mas me conta...\"\n\n## PASSO 3: A TRANSI√á√ÉO INVIS√çVEL (O GRANDE FECHAMENTO)\nAgora, conecte o coment√°rio do Passo 2 ao `Target`.\n**INSTRU√á√ÉO SUPREMA:** A transi√ß√£o para a pergunta do `Target` n√£o pode parecer uma mudan√ßa de assunto. Use conectivos de continuidade (\"Por isso...\", \"Falando nisso...\", \"Nesse cen√°rio...\").\n\n1. **TARGET:** Traduza a instru√ß√£o \"{{ $json.currentInstruction }}\" para o seu tom de voz.\n2. **RESTRI√á√ÉO:** N√£o fa√ßa perguntas adicionais. Apenas a do Target.\n\n---\n\n# FORMATO FINAL DA MENSAGEM\n(Texto √∫nico e fluido. N√£o use quebras de linha duplas desnecess√°rias):\n\n[Coment√°rio com o \"Gancho\" no assunto do usu√°rio] + [Conectivo fluido com Nome] + [A√ß√£o do TARGET]"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[1504,32],"id":"b98b652f-5d43-4927-9970-384ff383da31","name":"AI Agent"},{"parameters":{"promptType":"define","text":"=[CONTEXTO]\nLastVar: \"{{ $('Seta lastVar solicitada').item.json.lastVar }}\" -> Procure-a na tabela de vari√°veis\n\n[INPUT DO USU√ÅRIO]\n\"\"\"\n{{ $('CONCATENA').item.json.message }}\n\"\"\"\n\n[TABELA DE VARI√ÅVEIS]\n{{ $('Transforma vari√°veis em tabela').item.json.tableMarkdown }}\n\n[LAST QUESTION]\n{{ $json.messageContent }}\n\nREFER√äNCIA DE CALEND√ÅRIO (USE ISTO PARA DATAS):\nHoje: {{ $now.setZone('America/Sao_Paulo').toFormat('cccc (dd/MM)') }}\n{{ [1,2,3,4,5].map(d => $now.setZone('America/Sao_Paulo').plus({days: d}).setLocale('pt-BR').toFormat(\"'+ \" + d + \" dias' (cccc) = yyyy-MM-dd\")).join('\\n') }}\n","hasOutputParser":true,"options":{"systemMessage":"=[CRIATIVA/AVAN√áADA ‚Äî ATUALIZADA v2.3] Extrator JSON Sem√¢ntico ‚ÄúFato‚ÜíVari√°vel‚Äù com Inten√ß√£o + Infer√™ncia Cruzada Gen√©rica\n\n[PT-BR] ATUE COMO: Extrator JSON Sem√¢ntico ‚ÄúFato‚ÜíVari√°vel‚Äù com Desambigua√ß√£o Avan√ßada e L√≥gica de Depend√™ncia.\n\nENTRADA:\n- LastVar (string com nome da vari√°vel foco OU null/vazio)\n- LastQuestion (a √∫ltima pergunta feita pela IA)\n- VariablesTable (VAR/NAME, TIPO, OP√á√ïES, DESCRI√á√ÉO, VALOR)\n- Texto do usu√°rio\n\nRegra do debug: inclua se ‚â•2 fatos OU fora-de-contexto.\n\nREGRAS DE OURO\n1) Priorize LastVar quando ela existir e for v√°lida, mas nunca force preenchimento se o conte√∫do for fora de contexto.\n2) Sempre separe a mensagem em FATOS at√¥micos ANTES de mapear vari√°veis.\n3) Um FATO (ou SUBFATO) s√≥ pode preencher 1 vari√°vel PRINCIPAL, mas pode disparar VARI√ÅVEIS DERIVADAS (ver Regra 7).\n4) N√£o sobrescreva vari√°veis preenchidas (value != null/undefined/vazio), exceto com corre√ß√£o expl√≠cita.\n5) REGRA ‚ÄúSE SIM, QUAL?‚Äù (Sufici√™ncia):\n   - Se a DESCRI√á√ÉO de uma vari√°vel indicar pergunta condicional ‚ÄúSe sim, qual/quais?‚Äù:\n     a) Responder apenas ‚ÄúSim/Claro/Ok‚Äù √© INSUFICIENTE para preencher a vari√°vel de DETALHE (‚Äúqual‚Äù).\n     b) Responder ‚ÄúN√£o/Nunca‚Äù deve virar false para a vari√°vel booleana correspondente.\n     c) Responder o DETALHE implica ‚Äúsim‚Äù: extraia o detalhe E a vari√°vel booleana de gate (se existir).\n\n6) REGRA ‚Äî LastVar NULA + MENSAGEM TRIVIAL (N√ÉO EXTRAIR NADA)\n   - Se LastVar for null/vazio E mensagem for apenas sauda√ß√£o/confirma√ß√£o (\"Oi\", \"Ok\", \"Entendi\"), retorne `{ \"extracted\": {}, \"noContext\": true }`.\n   - Se contiver dados (nome, cargo, sistema), mapeie por match global.\n\n7) REGRA DE INFER√äNCIA CRUZADA (L√ìGICA DE DEPEND√äNCIA ABSTRATA)\n  - Voc√™ deve ler a coluna `DESCRI√á√ÉO` de cada vari√°vel identificada.\n    1. Procure pela tag **`[LOGIC: ...]`** ou instru√ß√µes condicionais (Se... Ent√£o...).\n    2. Se encontrar uma regra l√≥gica vinculada a um valor que voc√™ acabou de extrair, voc√™ √© OBRIGADO a aplic√°-la.\n\n8) **NUNCA** marque uma vari√°vel como undefined, a menos que exista uma op√ß√£o com esse valor na vari√°vel.\n\n9) REGRA DE BLOQUEIO DE CONTRA-PERGUNTA: Se o texto do usu√°rio for uma d√∫vida, questionamento ou contiver interroga√ß√£o (\"?\"), N√ÉO EXTRAIA esse texto como valor da vari√°vel. EXCE√á√ÉO: Somente extraia se a DESCRI√á√ÉO da LastVar pedir explicitamente para capturar uma d√∫vida (ex: \"Salve a d√∫vida do cliente\"). A√á√ÉO: Se for uma pergunta comum (ex: \"Por que voc√™ quer saber?\", \"Quem √© voc√™?\").\n\n10) REGRA DE COER√äNCIA DE FLUXO (LastQuestion vs LastVar):\n    - Analise a `LastQuestion` (a √∫ltima mensagem da IA).\n    - Se o sentido da `LastQuestion` **N√ÉO** corresponder ou n√£o solicitar a informa√ß√£o definida na `DESCRI√á√ÉO` da `LastVar`, **IGNORE** a `LastVar` imediatamente (trate como se fosse null).\n    - Motivo: O usu√°rio pode estar respondendo a uma pergunta antiga ou o estado da vari√°vel pode estar dessincronizado com a conversa real. A prioridade √© a coer√™ncia sem√¢ntica.\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n1) EXTRA√á√ÉO DE FATOS + CLASSIFICA√á√ÉO DE INTEN√á√ÉO\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n- Limpe ru√≠do conversacional.\n- Segmente o texto em FATOS.\n- Valide a Regra 10 antes de assumir a LastVar.\n- Aplique a Regra 7 para preencher vari√°veis dependentes automaticamente."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[672,32],"id":"9fe107c9-4377-41ea-8d1d-0afd89e4c1ed","name":"AI Agent - Verifica sem tem vari√°vel para atualizar"},{"parameters":{"jsCode":"const vars = $('Seta vari√°veis da conversa').item.json\nconst foundVariables = $input.first().json.output.foundVariables\n\nfor (const foundVariable of foundVariables) {\n  const data = {\n    name: foundVariable.variable, \n    value: foundVariable.value\n  }\n\n  if (vars[data.name]) {\n    vars[data.name].value = data.value\n  }  \n}\n\nreturn {\n  updatedVars: foundVariables.map(v => v.variable), \n  vars\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1024,32],"id":"ec62442e-ca30-4cb4-9f13-cae9ca59d5df","name":"Atualiza vari√°veis"},{"parameters":{"jsCode":"const stages = $('Seta est√°gios').item.json\nconst vars = $('Atualiza vari√°veis').item.json.vars\nconst stagesEntries = Object.entries(stages)\n\nlet currentStage = null\nlet currentInstruction = null\nlet currentVar = null\nlet finalInstruction = null\nfor (const [key, value] of stagesEntries) {\n  const entryConditions = value.requiredDataForExecute\n\n  if (entryConditions && Array.isArray(entryConditions) && entryConditions.length > 0) {\n    let conditionsMet = true\n\n    for (const condition of entryConditions) {\n      const varObj = vars[condition.name]\n      const actualValue = varObj ? varObj.value : null\n\n      switch (condition.operator) {\n        case 'exist':\n          if (actualValue === null || actualValue === undefined || actualValue === '') {\n            conditionsMet = false\n          }\n          break\n        case '!exist':\n          if (actualValue !== null && actualValue !== undefined && actualValue !== '') {\n            conditionsMet = false\n          }\n          break\n        case '=':\n          if (actualValue != condition.value) {\n            conditionsMet = false\n          }\n          break\n      }\n\n      if (!conditionsMet) break\n    }\n\n    if (!conditionsMet) continue\n  }\n\n  value.actions.requiredDataForExecute = value.actions.requiredDataForExecute.map(v => {\n    const varValue = vars[v.name] ? vars[v.name].value : null\n    return {\n      ...v,\n      value: varValue || undefined\n    }\n  })\n\n  const stagePendingVarIndex = value.actions.requiredDataForExecute.findIndex(v => !v.value)\n  const stagePendingVar = value.actions.requiredDataForExecute[stagePendingVarIndex]\n\n  if (stagePendingVar) {\n    currentInstruction = stagePendingVar.instruction\n    currentVar = stagePendingVar.name\n    currentStage = {\n      ...value,\n      name: key\n    }\n    break\n  }\n\n  if (!value.performed) {\n    stages[key].performed = true\n    finalInstruction = value.actions.finalInstructions\n\n    if (!finalInstruction?.trim()) continue\n\n    currentVar = null\n    currentStage = {\n      ...value,\n      name: key\n    }\n\n    delete currentStage['performed']\n  }\n}\n\nreturn {\n  currentInstruction,\n  finalInstruction,\n  currentStage: currentStage?.name || undefined,\n  currentVar,\n  stages\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1232,32],"id":"9b3f2468-c7ac-4c96-8c87-c2cd49c66423","name":"Busca est√°gio"},{"parameters":{"schemaType":"manual","inputSchema":"{\n\t\"type\": \"object\",\n\t\"properties\": {\n\t\t\"foundVariables\": {\n\t\t\t\"type\": \"array\",\n\t\t\t\"items\": {\n\t\t\t\t\"type\": \"object\",\n\t\t\t\t\"properties\": {\n\t\t\t\t\t\"variable\": {\n\t\t\t\t\t\t\"type\": \"string\",\n\t\t\t\t\t\t\"description\": \"Nome exato da vari√°vel identificada na tabela.\"\n\t\t\t\t\t},\n\t\t\t\t\t\"value\": {\n\t\t\t\t\t\t\"oneOf\": [\n\t\t\t\t\t\t\t{ \"type\": \"string\" },\n\t\t\t\t\t\t\t{ \"type\": \"number\" },\n\t\t\t\t\t\t\t{ \"type\": \"boolean\" },\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"type\": \"array\",\n\t\t\t\t\t\t\t\t\"items\": { \"type\": \"string\" }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t],\n\t\t\t\t\t\t\"description\": \"Valor extra√≠do respeitando o tipo original (ex: '2 a 5' string, 10 number, true boolean).\"\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t\"required\": [\"variable\", \"value\"]\n\t\t\t}\n\t\t},\n\t\t\"noContext\": {\n\t\t\t\"type\": \"boolean\",\n\t\t\t\"description\": \"True se o input for trivial ou irrelevante; False se contiver dados ou responder a lastVar.\"\n\t\t}\n\t},\n\t\"required\": [\"foundVariables\", \"noContext\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[816,256],"id":"88b39a40-2eab-4bd5-9ce8-31926de94af1","name":"Structured Output Parser"},{"parameters":{"options":{"temperature":0.2}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[624,240],"id":"3da57db0-6ebf-4379-9c17-bef925b18a1b","name":"DeepSeek Chat Model","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}},{"parameters":{"jsCode":"const stages = $('Busca est√°gio').first().json.stages;\n\nconst vars = $('Atualiza vari√°veis').item ? $('Atualiza vari√°veis').item.json.vars : {}; \n\nconst filteredStages = Object.entries(stages).filter(([key, stage]) => {\n  \n  if (stage.performed) return false;\n\n  const conditions = stage.requiredDataForExecute;\n\n  if (!conditions || !Array.isArray(conditions) || conditions.length === 0) {\n    return true;\n  }\n\n  // Verifica se TODAS as condi√ß√µes s√£o atendidas\n  const conditionsMet = conditions.every(condition => {\n    const varObj = vars[condition.name];\n    const actualValue = varObj ? varObj.value : null;\n\n    switch (condition.operator) {\n      case 'exist':\n        return actualValue !== null && actualValue !== undefined && actualValue !== '';\n      \n      case '!exist':\n        return actualValue === null || actualValue === undefined || actualValue === '';\n      \n      case '=':\n        return actualValue == condition.value;\n      \n      default:\n        return true; \n    }\n  });\n\n  return conditionsMet;\n});\n\nreturn {\n  unperfomedStages: filteredStages\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3328,208],"id":"500dc0a3-00c7-4efa-be11-79cd20b13752","name":"Retorna estagios que n√£o foram executados ainda"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ff469cb2-4c31-4870-baf9-aeb8ecc435f6","leftValue":"={{ $json.unperfomedStages.length }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[4288,208],"id":"f60bf6d0-f32f-4336-9817-5143f0408fcd","name":"If1"},{"parameters":{"operation":"push","list":"=temp.{{ $('Cria cache key').first().json.cache_key }}","messageData":"={{ JSON.stringify({\n  message: $('Webhook').item.json.body.message, \n  timestamp: $now.toMillis() \n}) }}","tail":true},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2896,48],"id":"2550d37c-92cc-4026-985b-83731987e337","name":"PUSH","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"amount":20},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-2320,288],"id":"28832e61-4907-42ab-bcdb-2367b56422a5","name":"Wait","webhookId":"d1e38aad-57ac-45e5-b64a-08e2f1ce1a6f"},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Cria cache key').first().json.cache_key }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2704,48],"id":"81a70ff4-8a16-4b21-987f-031b1f9a2e00","name":"GET","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=temp.{{ $('Cria cache key').item.json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2176,32],"id":"51a0cd27-d2a4-47b5-8361-1583a8b332c4","name":"DELETE","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"assignments":{"assignments":[{"id":"c1efb168-243b-4ca0-9910-bb8d67132c74","name":"message","value":"={{ $json.messages.map(value => JSON.parse(value).message).join('\\n') }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1904,32],"id":"1ecb77f2-c344-4473-8f75-a6c4407c89fb","name":"CONCATENA"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2aafb32-380d-4510-810a-888831d36437","leftValue":"={{ DateTime.fromMillis( JSON.parse($json.messages?.last() || '{}').timestamp ) }}","rightValue":"={{ $now.minus(20, 'seconds' )}}","operator":{"type":"dateTime","operation":"before"}}],"combinator":"and"},"renameOutput":true,"outputKey":"segue"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3d2a33da-ed74-4906-92aa-74ad3a37c4f1","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"nada"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"espera"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-2512,32],"id":"a40b7b77-ae57-4425-a786-a3b364ffb404","name":"SWITCH_BUFFER1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1f5bcbd1-6685-469d-bbf2-7939008b234d","leftValue":"={{ $('Webhook').item.json.body.message.trim() }}","rightValue":"clear:cache:111222","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3280,816],"id":"50351a14-c8d4-4770-bbe3-0a8aa7e9e996","name":"If"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-2176,192],"id":"fcbdc119-96ed-4715-a2ec-175c9b5d0e9a","name":"NADA"},{"parameters":{"operation":"delete","key":"=temp.{{ $('Cria cache key').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[5264,816],"id":"1c2b99ff-4fca-4c8c-ae3a-94b588b72006","name":"Delete memory messages","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[3088,224],"id":"c612189f-5032-4cb5-b287-17bb1fdd904e","name":"LOOP_SLIT"},{"parameters":{"amount":4},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[3680,416],"id":"8b332df7-ce68-43ba-ad1b-393239361df7","name":"WAIT_SPLIT","webhookId":"3cea2837-6c05-4e79-8798-96260c4f8dc6"},{"parameters":{"assignments":{"assignments":[{"id":"ae48936d-1ae8-440b-a604-2a6e4c4418f1","name":"output","value":"={{ $('AI Agent').item.json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1984,32],"id":"904169a9-a655-4d39-9a51-d9bad6f5f60a","name":"output"},{"parameters":{"model":"gpt-4o-mini-2024-07-18","options":{"temperature":0.4}},"id":"fa1f5c9c-4260-4c3a-b734-af25c8956af5","name":"OpenAI3","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[2288,208],"credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}"},"id":"031682f1-352c-4def-bda2-148e0a01ec4e","name":"OutputParser1","type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[2480,208]},{"parameters":{"promptType":"define","text":"=Whatsapp message to be splitted and formated: {{ $json.output }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=# SYSTEM: Otimizador de Texto WhatsApp\nObjetivo: Dividir o texto de entrada em 1 a 4 bal√µes de leitura fluida.\n\n# REGRAS DE EXECU√á√ÉO\n1. **Formata√ß√£o:**\n   - Converta `**texto**` ‚Üí `*texto*` -> Apenas para textos que utilizam **.\n   - Converta `~~texto~~` ‚Üí `~texto~` -> Apenas para textos que utilizam ~~.\n   - Converta `__texto__` ‚Üí `_texto_` -> Apenas para textos que utilizam __.\n   - URLs: Devem ser isoladas em uma mensagem exclusiva e envoltas em crase (`url`).\n\n2. **Segmenta√ß√£o (Split):**\n   - **Tamanho:** Alvo de ~150 caracteres (Max 250).\n   - **Corte:** Nunca quebre frases no meio. Use pontua√ß√£o (. ? !) como guia.\n   - **Coes√£o:** Emojis ficam sempre colados √† palavra anterior.\n   - **Contexto:** Separe sauda√ß√µes e perguntas finais em bal√µes pr√≥prios se poss√≠vel.\n\n3. **Output:**\n   - Gere JSON estrito. Sem blocos de c√≥digo markdown.\n\n# JSON SCHEMA\n{ \"messages\": [\"msg1\", \"msg2\", \"msg3\"] }"}]}},"id":"20c8ad19-218f-48f8-9326-99d1880db03c","name":"Parser  Chain","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[2304,32]},{"parameters":{"fieldToSplitOut":"output.messages","options":{"destinationFieldName":"output"}},"id":"e0137911-0f37-49f7-b408-9047011e579b","name":"Split de Mensagem","type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[2832,224]},{"parameters":{"method":"POST","url":"=https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').item.json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output }}"},{"name":"number","value":"={{ $('Webhook').item.json.body.contact.number }}"},{"name":"addUserName","value":"={{ $('Seta perfil').item.json.agentName }}"},{"name":"whatsappId","value":"={{ $('Webhook').item.json.body.whatsappId }}"},{"name":"messageRepliedId","value":"={{ $('Webhook').item.json.body.messageId }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3344,416],"id":"08afadc0-271b-4d8f-a141-68d81e743e68","name":"Envia resposta para o Lead"},{"parameters":{"method":"PATCH","url":"=https://api-chat-joao.apre.tv/api/ticket/{{ $('Webhook').first().json.body.ticketId }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"pending\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[4592,192],"id":"2c74ec69-0c6e-476c-a77f-1ffc66990cc8","name":"Transfere ticket para Aguardando Apre.Chat1"},{"parameters":{"method":"POST","url":"=https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output }}"},{"name":"number","value":"={{ $('Webhook').first().json.body.contact.number }}"},{"name":"addUserName","value":"={{ $('Seta perfil').first().json.agentName }}"},{"name":"whatsappId","value":"={{ $('Webhook').first().json.body.whatsappId }}"},{"name":"messageRepliedId","value":"={{ $('Webhook').first().json.body.messageId }}"},{"name":"messageType","value":"internalNote"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5744,192],"id":"7189764d-b70d-4abb-94b9-e5d931aecb3f","name":"Salva nota na conversa"},{"parameters":{"jsCode":"const data = $input.all();\nconst formatChatHistory = (inputData) => {\n  return inputData.map(jsonItem => {\n    const item = jsonItem.json\n    // 1. Define o remetente\n    const sender = item.message.type === 'human' ? 'User' : 'IA';\n    \n    // 2. Pega o conte√∫do original\n    let content = item.message.content;\n\n    // 3. Se for IA, aplica a Regex para limpar o \"lixo\" t√©cnico\n    if (item.message.type === 'ai') {\n      // REGEX EXPLICADA:\n      // ^              -> Come√ßa no in√≠cio da string\n      // \\[Used tools:  -> Procura literalmente por \"[Used tools:\"\n      // [\\s\\S]*?       -> Pega qualquer caractere (incluindo quebra de linha) de forma n√£o-gulosa (para no primeiro match)\n      // \\]\\]           -> Procura o fechamento dos colchetes duplos \"]]\"\n      // \\s* -> Remove quaisquer espa√ßos ou quebras de linha que sobrem logo ap√≥s\n      content = content.replace(/^\\[Used tools:[\\s\\S]*?\\]\\]\\s*/, '');\n    }\n\n    // 4. Retorna no formato solicitado\n    return `${sender}: ${content}`;\n  }).join('\\n'); // Une tudo com quebra de linha\n};\n\n// Executa e mostra o resultado\nconst result = formatChatHistory(data);\n\nreturn  {\n  result\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5104,192],"id":"90bd506d-abbe-41b9-8ac9-6b2d24f6c007","name":"Formata hist√≥rico","executeOnce":true},{"parameters":{"promptType":"define","text":"=[HIST√ìRICO DE CONVERSA]\n{{ $json.result }}","options":{"systemMessage":"*DOSSI√ä*\nCrie um breve Dossi√™ da conversa, listando cada informa√ß√£o separada por linha e colocando a label em negrito.\n\n*AN√ÅLISE*\nTom: Defina o tom/perfil do usu√°rio.\nResumo: Gere um breve resumo da conversa\n\n*ONDE PAROU*\nInforme onde a conversa parou\n\n*PR√ìXIMOS PASSOS*\nDefina os pr√≥ximos passos\n\n## FORMATA√á√ÉO:\nNegrito: Um asterisco antes e depois da palavra/frase. Ex: '*Teste*'\nIt√°lico:  Um underline antes e depois da palavra/frase. Ex: '_Teste_'\n\n## REGRAS DE OURO:\n- Seja breve\n- Crie um resumo objetivo\n- Texto corrido apenas no resumo (bloco an√°lise)\n\n\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[5376,192],"id":"a7a6764a-28fd-442f-a9a8-2f278f08f76c","name":"Gera resumo da conversa - AI"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[5296,384],"id":"6e1486c9-cb79-43fb-8b8b-d0df4e67bb0e","name":"DeepSeek Chat Model1","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Cria cache key').first().json.cache_key }}"}]},"sort":{"values":[{"column":"id"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[4880,192],"id":"86321475-8e3e-42ff-9f37-8471414b6ab6","name":"Busca hist√≥rico de conversa","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messageContent = $input.first().json.content.replace(/^\\[Used tools:[\\s\\S]*?\\]\\]\\s*/, \"\");\n\nreturn { messageContent };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[304,32],"id":"0c8f3bc9-161a-46ca-88f3-3505f85e53e9","name":"Formata √∫ltima mensagem enviada pela IA"},{"parameters":{"operation":"executeQuery","query":"SELECT id, session_id, message->>'content' AS content\nFROM public.n8n_chat_histories\nWHERE message->>'type' = 'ai'\nORDER BY id desc\nlimit 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[48,32],"id":"37bd4fc9-7a36-4bf3-83ed-98e2810a1695","name":"Execute a SQL query","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini-2024-07-18","mode":"list","cachedResultName":"gpt-4o-mini-2024-07-18"},"builtInTools":{},"options":{"temperature":0.4}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[1376,304],"id":"18939429-c94d-44af-a1aa-70cfbefc1a6b","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"jsCode":"return $('Parser  Chain1').first().json.output.messages.map(message => ({\n  json: { message }\n}))"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3664,3312],"id":"7270b274-73e5-46e8-a25e-ac0832114704","name":"Split de mensagens"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2dfab0a2-c614-429c-a13d-36ecb7803f12","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3216,3328],"id":"4a0d7e13-e4c7-4ff2-bc82-3528f6eb21dd","name":"Se n√£o recebeu mensagem no meio do processamento","alwaysOutputData":false},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3008,3328],"id":"7db3e4ca-447f-496c-aa1e-6eefbcdf9d16","name":"GET2","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","value":"={{ JSON.stringify({ \n  stage_id: $json.newStageId, \n  vars: $json.updatedVars, \n  missingVar: $json.missingVar, \n  afterRepliedInstruction: $json.missingVar.afterRepliedInstruction\n}) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-128,3312],"id":"738d4eef-8303-464e-8462-dba3d8f1f028","name":"Salva Novo Estado","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"=Whatsapp message to be splitted and formated: {{ $json.output }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=# SYSTEM: Otimizador de Texto WhatsApp\nObjetivo: Dividir o texto de entrada em 1 a 4 bal√µes de leitura fluida.\n\n# REGRAS DE EXECU√á√ÉO\n1. **Formata√ß√£o:**\n   - Converta `**texto**` ‚Üí `*texto*` -> Apenas para textos que utilizam **.\n   - Converta `~~texto~~` ‚Üí `~texto~` -> Apenas para textos que utilizam ~~.\n   - Converta `__texto__` ‚Üí `_texto_` -> Apenas para textos que utilizam __.\n   - URLs: Devem ser isoladas em uma mensagem exclusiva e envoltas em crase (`url`).\n   - Um split NUNCA deve terminar com v√≠rgula. Ex: 'Bacana, agora me diz uma coisa,' -> 'Bacana, agora me diz uma coisa' \n\n2. **Segmenta√ß√£o (Split):**\n   - **Tamanho:** Alvo de ~150 caracteres (Max 250).\n   - **Corte:** Nunca quebre frases no meio. Use pontua√ß√£o (. ? !) como guia.\n   - **Coes√£o:** Emojis ficam sempre colados √† palavra anterior.\n   - **Contexto:** Separe sauda√ß√µes e perguntas finais em bal√µes pr√≥prios se poss√≠vel.\n\n3. **Output:**\n   - Gere JSON estrito. Sem blocos de c√≥digo markdown.\n\n# JSON SCHEMA\n{ \"messages\": [\"msg1\", \"msg2\", \"msg3\"] }"}]}},"id":"3c28b59b-2be5-4d8b-a517-f8a278a61102","name":"Parser  Chain1","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[2592,3328]},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}"},"id":"b9a4fcff-4642-42ab-ab64-2c3825f158f6","name":"OutputParser","type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[2768,3504]},{"parameters":{"model":"gpt-4o-mini-2024-07-18","options":{"temperature":0.4}},"id":"7f70977d-19d8-40ff-b564-4600a51a03e7","name":"OpenAI","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[2576,3504],"credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"assignments":{"assignments":[{"id":"ae48936d-1ae8-440b-a604-2a6e4c4418f1","name":"output","value":"={{ $('Gerador de Resposta').item.json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2352,3328],"id":"b40fa44a-cc96-4780-98ce-8ae634229c4d","name":"output1"},{"parameters":{"amount":2.5},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[4768,3392],"id":"3e64cd6c-e36e-4040-ae14-ea68c4ac6687","name":"WAIT_SPLIT1","webhookId":"3cea2837-6c05-4e79-8798-96260c4f8dc6"},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[3872,3312],"id":"4a7d5205-199f-46d0-bc3d-a25641504f06","name":"LOOP_SLIT1"},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.message }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4416,3392],"id":"6c0ecafa-b7a3-4fa9-84db-365e8250735e","name":"Envia WhatsApp1"},{"parameters":{"jsCode":"return {\n  tone: \"Engra√ßado\",\n  agentName: \"Alicia\",\n  internalName: \"Alicia da Apresenta.me\",\n  initialMessage: \"Ol√°, tudo bem? üëã \\n\\nEu sou a Alicia, assistente da Apresenta.me, vou te ajudar entendendo melhor sua necessidade.\",\n  language: \"pt-BR\",\n  timeZone: \"Sao Paulo (GTM -3)\",\n  role: \"SDR S√™nior\",\n  companyName: \"Apresenta.me\",\n  companyDepartment: \"Software\",\n  companySite: \"https://apresenta.me\",\n  conduct: `# SYSTEM ROLE: ALICIA (SDR IMOBILI√ÅRIA - BUSINESS CASUAL)\\n\\n### IDENTIDADE PRINCIPAL\\n- NOME: Alicia. (Identidade imut√°vel).\\n- EMPRESA: Apresenta.me (SaaS de gest√£o imobili√°ria).\\n- FUN√á√ÉO: SDR Consultiva.\\n- OBJETIVO: Conversar para entender o cen√°rio do lead e validar fit.\\n- POSTURA: Especialista, atenta e acess√≠vel. Voc√™ passa credibilidade sem ser r√≠gida.\\n\\n### PROTOCOLOS DE COMUNICA√á√ÉO (CR√çTICO)\\n\\n1. **TOM DE VOZ: PROFISSIONAL LEVE (\"BUSINESS CASUAL\")**\\n   - **O Que √â:** Uma conversa de neg√≥cios via WhatsApp. Respeitosa, mas sem burocracia.\\n   - **PROIBIDO (Rob√≥tico/Formal Demais):** \"Prezado\", \"Por gentileza\", \"Compreendo\", \"Gostaria\", \"Solicito\", \"Informo\", \"Possu√≠mos\", \"Irei verificar\".\\n   - **PROIBIDO (G√≠ria/Informal Demais/Formal demais):** \"Mano\", \"V√©i\", \"Top\", \"Bora\", kkkkk (risada longa).\\n **PROIBIDO:** falar \"Posso te perguntar sobre [ASSUNTO]. Seja direta e simp√°tica j√° realizando a pergunta.\"\\n   - **PERMITIDO (Naturalidade Aceit√°vel):** \"Pra\" (em vez de para), \"teu\" (em vez de seu), \"pros\" (em vez de para os), \"t√°\" (em vez de est√°), \"a gente\" (em vez de n√≥s), \"n√©\".\\n  - **PONTUA√á√ÉO (CR√çTICO):** Use ponto final (.) e interroga√ß√£o (?). N√£o use dois pontos (:)\\n 9. **EVITE AO M√ÅXIMO** exclama√ß√µes (!), pois eles deixam o texto rob√≥tico e artificial. \\n\\n2. **POL√çTICA DE EMOJIS (SOBRIEDADE):**\\n   - **Regra:** Minimalismo total.\\n   - Use no m√°ximo **1 emoji** por mensagem e somente se for para suavizar uma frase.\\n   - Se a frase for neutra, n√£o use emoji. Evite \"enfeitar\" o texto.\\n\\n3. **FLUIDEZ E OBJETIVIDADE:**\\n   - Seja breve. Ningu√©m gosta de ler text√£o no celular.\\n   - **Conex√£o Inteligente:** Ao mudar de assunto, use um gancho l√≥gico.\\n     - *Exemplo:* \"Entendi, faz sentido essa preocupa√ß√£o. Falando nisso, hoje...\" (Em vez de: \"Ok. Pr√≥xima pergunta:\").\\n\\n### FLUXO OPERACIONAL\\n1. FOCO: Uma pergunta por vez.\\n2. BLINDAGEM TOTAL (CONCORR√äNCIA): JAMAIS cite nomes de concorrentes, funcionalidades deles, ou fale bem/mal. Se o usu√°rio insistir em comparar ou perguntar de outros sistemas, DESVIE O ASSUNTO imediatamente focando na realidade dele (ex: \"Entendo, mas focando aqui no seu cen√°rio...\").\\n3. ANTI-DESVIO (MUDAN√áA DE ASSUNTO): Se o usu√°rio mudar o assunto bruscamente, traga o foco de volta com educa√ß√£o. Diga claramente que voc√™ est√° ali para ajudar a encontrar a melhor solu√ß√£o para ele no sistema da Apresenta.me.\\n\\n### ZONA DE RISCO (O QUE N√ÉO FAZER)\\n- N√ÉO MARCAR REUNI√ÉO AGORA: Seu foco √© qualifica√ß√£o (triagem).\\n- SEM SUPORTE T√âCNICO: Se n√£o souber, diga a verdade de forma polida o que o usu√°rio QUESTIONOU (\"Vou confirmar sobre [ASSUNTO QUESTIONADO] com o time pra te passar a informa√ß√£o correta\"). Se o usu√°rio n√£o tem d√∫vidas, **PROIBIDO** utilizar a carta de seguran√ßa. \\n- SEM OFERTAS: N√£o discuta tabela de pre√ßos nesta etapa.\\n\\n### INSTRU√á√ÉO DE COMPORTAMENTO\\nImagine que voc√™ √© uma consultora experiente trocando mensagens com um cliente. Voc√™ √© segura, educada e direta. Escreva como uma pessoa real, n√£o como um script.\\n\\nAGORA, AGUARDE O PRIMEIRO INPUT DO USU√ÅRIO.\\n ## USU√ÅRIO MOSTRA INTERESSE EM UMA DEMONSTRA√á√ÉO: Se o usu√°rio diz algo como 'quero conhecer o sistema de voces' -> informe obrigatoriamente que antes de realizar uma demonstra√ß√£o precisa coletar alguns dados.\\n ## DADOS B√ÅSICOS da Apresenta.me:\\n - Endere√ßo: R. dos Ca√ßadores, 345 - Sala 01 - Centro, Rio do Sul, Santa Catarina (SC).\\n - √Årea de Segmento: Desenvolvimento e venda de softwares imobili√°rios.`,\n  verbosity: \"medium\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1744,3328],"id":"830b54df-f812-44d7-b868-f76c89d0c023","name":"Seta perfil1"},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"hasQuestion\": {\n      \"type\": \"boolean\"\n    }\n  }\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[368,3536],"id":"1e0d9efa-c9a0-4034-9780-5020f7291e27","name":"Parser Router"},{"parameters":{"options":{"temperature":0}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[64,3536],"id":"aac02e21-f12c-4c7d-873c-9c1800e3438c","name":"OpenAI Router","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"=[INPUT DO USU√ÅRIO]\n\"{{ $('CONCATENA1').first().json.user_full_message }}\"\n\n[SUA TAREFA]\nClassifique se o usu√°rio est√° fazendo uma PERGUNTA sobre a empresa, produto, pre√ßo, funcionamento ou suporte.\n- Retorne TRUE se for uma d√∫vida/pergunta.\n- Retorne FALSE se for apenas uma resposta de dados (ex: \"Sou Jo√£o\", \"Sim\", \"N√£o\", \"Tenho 10 im√≥veis\").\n- Retorne FALSE se for sauda√ß√£o ou conversa fiada.\n\n[HIST√ìRICO DE CONVERSA - √öLTIMAS 5 MENSAGENS TROCADAS]\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"\" }}\n\nResponda apenas com JSON: { \"hasQuestion\": boolean }","hasOutputParser":true,"options":{"systemMessage":"Voc√™ √© um classificador de inten√ß√£o bin√°rio."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[176,3312],"id":"327e946c-4df1-4a66-8de8-302008a1d2e2","name":"Router de D√∫vida","executeOnce":true},{"parameters":{"httpMethod":"POST","path":"7223c6af-f595-4bc2-b84c-602b8900cd08","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-4608,3328],"id":"297535a6-9e37-4bca-a09c-fe84dde17538","name":"Webhook","webhookId":"7223c6af-f595-4bc2-b84c-602b8900cd08"},{"parameters":{"jsCode":"return { \n  cache_key: `session_${$json.body.ticketId}`,\n  companyId: $json.body.companyId,\n  whatsappId: $json.body.whatsappId,\n  user_msg: $json.body.message,\n  user_phone: $json.body.contact.number,\n  timestamp: new Date().getTime()\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4384,3328],"id":"d70c4970-e8e5-4cd6-af88-9d8786224bef","name":"Configura Contexto"},{"parameters":{"operation":"get","key":"={{ $json.cache_key }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1680,3312],"id":"31d9859b-d634-498e-ad98-c8349ddf9c5a","name":"GET Estado Atual","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"// --- BLUEPRINT COMPLETO (Baseado na sua regra de neg√≥cio original) ---\nconst workflow = {\n  START: {\n    type: \"message\",\n    instruction:\n      \"Apresente-se como Alicia da Apresenta.me. Seja breve e pergunte o nome.\",\n    next_stage: \"WAIT_NAME\",\n  },\n  WAIT_NAME: {\n    type: \"input\",\n    variables: [\n      { \n        name: \"name\", \n        afterRepliedInstruction: `Diga que √© um prazer conhecer o Lead, de forma simp√°tica e natural.`,\n        description: \"Nome do Lead\" \n      }\n    ],\n    next_stage: \"ASK_WANT_DATA_COLLECTION\",\n  },\n  ASK_WANT_DATA_COLLECTION: {\n    type: \"message\",\n    instruction:\n      'Pergunte ao Lead se ele aceita participar de uma coleta de dados, usando a seguinte mensagem: \"A Apresenta.me √© uma plataforma completa que centraliza toda a opera√ß√£o da imobili√°ria em um s√≥ lugar. Ela ajuda a ganhar efici√™ncia, organizar processos e aumentar as convers√µes, com uma tecnologia simples e intuitiva, que funciona para equipes de qualquer tamanho.\\n Al√©m disso, oferece suporte humanizado para impulsionar o crescimento do neg√≥cio de forma pr√°tica e sustent√°vel.\\n Se fizer sentido pra voc√™, seguimos para coletar alguns dados essenciais e agendar uma demonstra√ß√£o. Pode ser?\"',\n    next_stage: \"WAIT_WANT_DATA_COLLECTION\",\n  },\n  WAIT_WANT_DATA_COLLECTION: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"wantDataCollection\",\n        afterRepliedInstruction: `Se o usu√°rio est√° aceitando a coleta de dados, de abertura para a coleta de dados. Ex: \"Show, [nome do lead], ent√£o vamos l√°\".`,\n        description:\n          \"Se o usu√°rio disser que QUER participar da COLETA DE DADOS.\",\n      },\n    ],\n    next_stage: \"ROUTER_DATA_COLLECTION\",\n  },\n  ROUTER_DATA_COLLECTION: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"wantDataCollection\",\n        value: false,\n        next_stage: \"SEND_COMMERCIAL_PRESENTATION\",\n      },\n      { default: \"ASK_ROLE\" },\n    ],\n  },\n  SEND_COMMERCIAL_PRESENTATION: {\n    type: \"message\",\n    instruction:\n      \"Responda para o Lead: [NOME DO LEAD], estou te enviando nossa apresenta√ß√£o comercial! Caso voc√™ mude de ideia e queira nos conhecer melhor, √© s√≥ avisar. At√© mais!\",\n    next_stage: \"STOP\",\n  },\n  ASK_ROLE: {\n    type: \"message\",\n    instruction: \"Pergunte qual o cargo ou fun√ß√£o dele na imobili√°ria.\",\n    next_stage: \"WAIT_ROLE\",\n  },\n  WAIT_ROLE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"role\",\n        description:\n          'Cargo do usu√°rio. N√ÉO MOSTRAR EXEMPLOS PARA O USU√ÅRIO. A RESPOSTA SEMPRE DEVE AUTOMATICAMENTE ATRIBUIR VALOR PARA \"isAutonomous\"',\n      },\n      {\n        name: \"isAutonomous\",\n        description:\n          \"(CAMPO L√ìGICO): Defina AUTOMATICAMENTE TRUE se o usu√°rio trabalha sozinho/aut√¥nomo. Defina FALSE se for imobili√°ria/equipe/s√≥cio etc.\",\n        type: \"boolean\",\n      },\n    ],\n    next_stage: \"ROUTER_PROFILE\",\n  },\n  // --- DECIS√ÉO: AUT√îNOMO VS IMOBILI√ÅRIA ---\n  ROUTER_PROFILE: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"isAutonomous\",\n        value: true,\n        next_stage: \"ASK_RENTAL_STATUS\",\n      }, // Aut√¥nomo pula tamanho do time\n      { default: \"ASK_TEAM_SIZE\" },\n    ],\n  },\n  ASK_TEAM_SIZE: {\n    type: \"message\",\n    instruction: \"Pergunte quantas pessoas trabalham na imobili√°ria hoje.\",\n    next_stage: \"WAIT_TEAM_SIZE\",\n  },\n  WAIT_TEAM_SIZE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"teamSize\",\n        description: \"Tamanho total da equipe (s√≥cios + corretores)\",\n      },\n    ],\n    next_stage: \"ASK_RENTAL_STATUS\",\n  },\n  ASK_RENTAL_STATUS: {\n    type: \"message\",\n    instruction:\n      \"Pergunte se eles j√° trabalham com loca√ß√µes ou est√£o estruturando agora.\",\n    next_stage: \"WAIT_RENTAL_STATUS\",\n  },\n  WAIT_RENTAL_STATUS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"rentalStatus\",\n        description:\n          \"Momento atual da imobili√°ria em rela√ß√£o a loca√ß√£o (j√° trabalham, est√£o come√ßando a estruturar, ou n√£o trabalham). N√ÉO MOSTRE NENHUMA OP√á√ÉO PARA O USU√ÅRIO, DEIXE ELE RESPONDER LIVREMENTE. (Preencha com as op√ß√µes: active = se j√° trabalha / starting = se come√ßando / none = se n√£o trabalha). Se ele j√° trabalha com loca√ß√µes, defina o valor de \\\"interestFocus\\\" como 'all'\",\n      },\n      {\n        name: \"portfolioSize\",\n        description:\n          \"Quantidade total de im√≥veis na carteira (venda + loca√ß√£o)\",\n      },\n    ],\n    next_stage: \"ASK_INTEREST_FOCUS\",\n  },\n  ASK_INTEREST_FOCUS: {\n    type: \"message\",\n    instruction:\n      \"Informe que a Apresenta.me entrega um sistema completo, com site, crm e gest√£o financeira e pergunte ao usu√°rio quais dessas op√ß√µes ele precisa, em espec√≠fico.\",\n    next_stage: \"WAIT_INTEREST_FOCUS\",\n  },\n  WAIT_INTEREST_FOCUS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"interestFocus\",\n        description:\n          \"Quais m√≥dulos do sistema o usu√°rio est√° interessado: Site + CRM, Gest√£o financeira ou todos.\",\n        afterRepliedInstruction:\n          'Se o usu√°rio estiver insistindo em uma op√ß√£o inv√°lida, responda-o que n√£o vendemos a op√ß√£o avulsa. Ex: \"[NOME DO LEAD], que pena! Infelizmente a gente n√£o vende nenhum m√≥dulo avulso...\". Se o usu√°rio quiser s√≥ site: responda-o que n√£o vendemos site avulso. Ex: \"Entendo, [NOME DO LEAD]! O site √© justamente a porta de entrada pra divulgar seus im√≥veis. Aqui ele j√° vem integrado ao CRM, o que ajuda voc√™ a receber os leads e acompanhar as vendas sem perder contato. Faz sentido pra voc√™ CRM e site integrados?\". Se o usu√°rio quiser somente CRM: responda-o que na contrata√ß√£o do CRM o site j√° vem integrado e que n√£o vendemos o CRM separado. Ex: \"Legal, [NOME DO LEAD]! Na contrata√ß√£o do CRM, o site j√° vem integrado, mas n√£o √© poss√≠vel contratar CRM avulso. Faz sentido pra voc√™ CRM e site integrados?\". Se o usu√°rio est√° insistindo na mesma op√ß√£o inv√°lida (√© no m√≠nimo a segunda fez que ele afirma que quer a mesma op√ß√£o inexistente), ignore essa instru√ß√£o.',\n        options: {\n          site_crm: \"Se o usu√°rio quiser site + CRM. N√£o selecione essa op√ß√£o se ele apenas disser que quer site ou se ele apenas disser que quer CRM.\",\n          all: \"Se o usu√°rio j√° trabalhar com loca√ß√£o, selecione obrigatoriamente essa op√ß√£o, ou se ele dizer que quer site + crm + gest√£o financeira.\",\n          invalid_option:\n            \"Se, e apenas SE o usu√°rio est√° INSISTINDO e deixando EXPLICITO que quer uma op√ß√£o diferente de site + crm ou todos os m√≥dulos ou que n√£o quer nenhuma das op√ß√µes.\",\n        },\n      },\n    ],\n    next_stage: \"ROUTER_INVALID_INTEREST_FOCUS\",\n  },\n  ROUTER_INVALID_INTEREST_FOCUS: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"interestFocus\",\n        value: 'invalid_option',\n        next_stage: \"CLOSING_WHEN_INVALID_OPTION\",\n      },\n      { default: \"ASK_PAIN_POINT\" },\n    ],\n  },\n  ASK_PAIN_POINT: {\n    type: \"message\",\n    instruction:\n      \"Pergunte qual √© o maior problema ou dificuldade que eles identificam hoje na gest√£o.\",\n    next_stage: \"WAIT_PAIN_POINT\",\n  },\n  WAIT_PAIN_POINT: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"mainPainPoint\",\n        description: \"Principal dor, problema ou gargalo citado pelo lead\",\n      },\n    ],\n    next_stage: \"ASK_CURRENT_SYSTEM\",\n  },\n  ASK_CURRENT_SYSTEM: {\n    type: \"message\",\n    instruction:\n      \"Pergunte se j√° utilizam algum sistema ou CRM imobili√°rio hoje, e qual. Se no meio da conversa o usu√°rio indicar que n√£o tem um CRM, pergunte SOMENTE se ele j√° utiliza algum Sistema Imobili√°rio. \",\n    next_stage: \"WAIT_CURRENT_SYSTEM\",\n  },\n  WAIT_CURRENT_SYSTEM: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"currentSystem\",\n        description: \"Nome do sistema atual (ex: Kenlo, Jetimob, Planilhas)\",\n      },\n    ],\n    next_stage: \"ROUTER_LOCACAO\",\n  },\n  // --- DECIS√ÉO: APROFUNDAR LOCA√á√ÉO? ---\n  ROUTER_LOCACAO: {\n    type: \"router\",\n    rules: [\n      // Se j√° tem loca√ß√£o ativa ('active'), pergunta detalhes t√©cnicos\n      {\n        variable: \"rentalStatus\",\n        value: \"active\",\n        next_stage: \"ASK_CONTRACT_DETAILS\",\n      },\n      // Se n√£o tem ou est√° come√ßando, vai direto pro or√ßamento\n      { default: \"ASK_BUDGET\" },\n    ],\n  },\n  ASK_CONTRACT_DETAILS: {\n    type: \"message\",\n    instruction:\n      \"Pergunte quantos contratos ativos administram e como fazem o repasse dos valores dos alugu√©is para propriet√°rios e corretores hoje.\",\n    next_stage: \"WAIT_CONTRACT_DETAILS\",\n  },\n  WAIT_CONTRACT_DETAILS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"numberOfContracts\",\n        description: \"Quantidade de contratos de loca√ß√£o ativos\",\n      },\n      {\n        name: \"transferMode\",\n        description:\n          \"M√©todo de repasse (Ex: Manual, Banco, Split etc.). NUNCA MOSTRE EXEMPLOS PARA O USUARIO E DEIXE ELE RESPONDER LIVREMENTE.\",\n      },\n    ],\n    next_stage: \"ASK_BUDGET\",\n  },\n  ASK_BUDGET: {\n    type: \"message\",\n    instruction:\n      'Baseando-se nas informa√ß√µes fornecidas pelo Lead, selecione o plano que mais se encaixe com o perfil da imobili√°ria/corretor e envie para o usu√°rio, informe tamb√©m que √© poss√≠vel adicionar mais usu√°rios se necess√°rio. Ex:\"[NOME DO LEAD], de acordo com as informa√ß√µes que voc√™ me passou, acredito que esse seria o plano ideal pra voc√™: [PLANO SELECIONADO]. Qual seria o valor aproximadamente que voc√™s estariam dispostos a investir mensalmente?\". Planos: \"Start IMOB - R$ 399,99/m√™s: 2 usu√°rios, 300 im√≥veis e 500 neg√≥cios. Inclui Site e WhatsApp.\\n\\nBasic IMOB - R$ 649,99/m√™s: 5 usu√°rios, 1000 im√≥veis e 2000 neg√≥cios. Inclui 50 contratos e gest√£o financeira.\\n\\nBig IMOB - R$ 949,99/m√™s: 12 usu√°rios, im√≥veis ilimitados e 5000 neg√≥cios. Inclui 150 contratos e gera√ß√£o autom√°tica.\\n\\nSuper IMOB - (Vou encaminhar para um especialista): 25 usu√°rios, im√≥veis e neg√≥cios ilimitados. Inclui 300 contratos e gest√£o de comiss√µes\"',\n    next_stage: \"WAIT_BUDGET\",\n  },\n  WAIT_BUDGET: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"budget\",\n        description: \"Valor de investimento mensal ou 'N√£o informado'\",\n      },\n    ],\n    next_stage: \"CLOSING\",\n  },\n  CLOSING: {\n    type: \"message\",\n    instruction:\n      \"Agrade√ßa, diga que coletou todos os dados necess√°rios e informe que um especialista entrar√° em contato para agendar uma apresenta√ß√£o.\",\n    next_stage: \"STOP\",\n  },\n  CLOSING_WHEN_INVALID_OPTION: {\n    type: \"message\",\n    instruction:\n      \"Agrade√ßa de forma cordial e simp√°tica, diga que ir√° encaminhar o atendimento para um especialista que poder√° cuidar do caso espec√≠fico do lead e se despe√ßa.\",\n    next_stage: \"STOP\",\n  },\n};\n\nconst redisData = $(\"GET Estado Atual\").item.json.propertyName\n  ? JSON.parse($(\"GET Estado Atual\").item.json.propertyName)\n  : {};\nconst currentStageId = redisData.stage_id || \"START\";\nconst vars = redisData.vars || {};\nconst stageConfig = workflow[currentStageId] || workflow[\"START\"];\n\n// --- VARREDURA GLOBAL DE VARI√ÅVEIS ---\nlet missingVars = [];\nfor (const key in workflow) {\n  const step = workflow[key];\n  if (step.type === \"input\" && step.variables) {\n    step.variables.forEach((v) => {\n      if (!vars[v.name] || vars[v.name].value === null) {\n        missingVars.push({\n          name: v.name,\n          description: v.description,\n          options: v.options || null,\n        });\n      }\n    });\n  }\n}\n\nreturn {\n  workflow,\n  currentStageId,\n  stageConfig,\n  vars,\n  missingVars,\n  userMsg: $(\"CONCATENA1\").item.json.user_full_message,\n  missingVar: JSON.parse($input.first().json.propertyName)?.missingVar,\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1440,3312],"id":"ea335fc1-895b-4f3b-b7cb-f3aca26fa576","name":"BLUEPRINT ENGINE"},{"parameters":{"promptType":"define","text":"=### [ORDEM DE EXECU√á√ÉO - AUDITOR DE DADOS]\n\n1. **AN√ÅLISE DE CONTEXTO:** Compare a [MENSAGEM DO USU√ÅRIO] com os [DADOS J√Å REGISTRADOS] e a [ULTIMA PERGUNTA DO ROB√î].\n2. **VARREDURA EXAUSTIVA:** N√£o pare na primeira informa√ß√£o. Analise cada frase da mensagem. O usu√°rio pode responder uma vari√°vel, corrigir uma antiga e tirar uma d√∫vida t√©cnica na mesma mensagem.\n3. **FILTRO DE INTEN√á√ÉO:** Diferencie o que √© \"dado fornecido\" do que √© \"pergunta sobre o produto\".\n4. **EXTRA√á√ÉO E MAPEAMENTO:** Aplique as regras de estimativa, corre√ß√£o e mapeamento de op√ß√µes (options).\n\n---\n\n### [CONTEXTO]\n- [HIST√ìRICO DE CONVERSA - √öLTIMAS 5 MENSAGENS TROCADAS]\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"\" }}\n\n### [DADOS DO PROCESSO]\n- **EST√ÅGIO:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.currentStageId) }}\n- **VARI√ÅVEIS FALTANTES:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.missingVars) }}\n- **DADOS J√Å REGISTRADOS:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.vars) }}\n- **ULTIMA PERGUNTA DO ROB√î FOI SOBRE:** \"{{ $('BLUEPRINT ENGINE').first().json.missingVar?.description }}\"\n- **MENSAGEM DO USU√ÅRIO:** \"{{ $('BLUEPRINT ENGINE').first().json.userMsg }}\"\n\n---\n\n### [REGRAS CR√çTICAS DE EXTRA√á√ÉO]\n\n1. **ESTIMATIVA > INCERTEZA (REGRA DO N√öMERO):**\n   - Se o usu√°rio der um valor (ex: \"acho que 500\", \"por volta de 10\") mas demonstrar incerteza (\"n√£o sei exato\", \"aproximadamente\"), **EXTRAIA O N√öMERO**.\n   - Valores estimados s√£o priorit√°rios sobre a marca√ß√£o de `answer_later`. S√≥ use `answer_later` se n√£o houver absolutamente nenhum dado ou valor na frase.\n\n2. **MAPEAMENTO SEM√ÇNTICO DE OPTIONS:**\n   - Se a vari√°vel possuir o campo `options`, voc√™ deve converter a inten√ß√£o do usu√°rio na **CHAVE (key)** t√©cnica correspondente.\n   - **L√≥gica:** Analise a frase -> Compare com os **VALORES** das op√ß√µes -> Retorne apenas a **CHAVE**.\n   - *Exemplo:* Se o usu√°rio quer \"Site e Financeiro\", e existe a op√ß√£o `{\"site_finance\": \"Se o usu√°rio quiser site e gest√£o financeira\"}`, a sa√≠da deve ser `{\"interestFocus\": \"site_finance\"}`.\n   - *PROIBIDO* selecionar qualquer op√ß√£o (se options existir) se nenhuma op√ß√£o corresponder exatamente com a respsta do usuario.\n\n3. **CORRE√á√ÉO E SOBREPOSI√á√ÉO (PRIORIDADE M√ÅXIMA):**\n   - Verifique os [DADOS J√Å REGISTRADOS]. Se a mensagem contradizer algo j√° salvo, extraia o novo valor para **SOBRESCREVER** o antigo. Isso vale para mudan√ßas de ideia sobre interesse, cargo ou sistemas.\n\n4. **VALIDA√á√ÉO DE POSSE (ANTI-ALUCINA√á√ÉO):**\n   - Para vari√°veis de sistemas/ferramentas: Extraia apenas se houver ind√≠cio claro de **USO ATUAL** ou POSSE (ex: \"uso o sistema X\", \"tenho o software Y\").\n   - Perguntas, curiosidades ou compara√ß√µes (\"O sistema X √© bom?\") devem ser **IGNORADAS** pelo extrator.\n\n5. **NEGATIVAS, ADIAMENTO E RECUSA:**\n   - **RESPOSTA NEGATIVA:** Se o usu√°rio responder de forma positiva ou negativa a uma pergunta de sim ou n√£o, extraia o valor correspondente (ex: FALSE/TRUE ou \"none\") conforme a descri√ß√£o da vari√°vel. Isso √© um DADO, n√£o uma recusa.\n   - **ADIAMENTO (answer_later):** Use quando ele disser que n√£o sabe ou responder√° depois.\n   - **RECUSA (not_provided):** Use APENAS se o usu√°rio se negar a responder um dado espec√≠fico por privacidade ou grosseria. \n   - **D√öVIDA DE RELEV√ÇNCIA:** Se perguntar \"Pra que saber isso?\", N√ÉO EXTRAIA .\n\n6. **RETROATIVIDADE:**\n   - Se a mensagem atual responder algo que estava marcado anteriormente como `answer_later` ou `not_provided`, atualize o valor com o novo dado.\n\n---\n\n### [EXEMPLO DE RACIOC√çNIO]\n*Usu√°rio: \"Vcs tem site tbm? pq o q eu ia precisar seria mais site e gest√£o financeira. A gnt j√° usa um crm aqui, e temos 500 im√≥veis aproximadamente.\"*\n\n- **Frase 1:** D√∫vida sobre produto -> Ignorar.\n- **Frase 2:** Quer site e financeiro -> Corrigir `interestFocus` mapeando para a chave correta.\n- **Frase 3:** Usa CRM -> Extrair \"CRM\" para `currentSystem`.\n- **Frase 4:** 500 im√≥veis aprox. -> Extrair `500` para `portfolioSize` (Regra: Estimativa > Incerteza).\n\n‚ö†Ô∏è ATEN√á√ÉO: Utilize o contexto para raciocinar\n\n---\n\n### [SA√çDA OBRIGAT√ìRIA]\n- Retorne **APENAS** o JSON puro. Proibido adicionar explica√ß√µes.\n- Se nenhum dado for extra√≠do ou corrigido, retorne `{}`.\n- Formato: `{ \"nome_da_variavel\": valor_extraido }`","hasOutputParser":true,"options":{"systemMessage":"Voc√™ √© um extrator de dados inteligente. Voc√™ preenche formul√°rios invis√≠veis baseado em inten√ß√£o."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-704,3312],"id":"739f0de6-728c-4ae4-9b50-0ec36296d4d5","name":"Extrator Inteligente"},{"parameters":{"options":{"temperature":0.1}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[-752,3536],"id":"a3bcb857-749d-4f3b-b187-c7fa841f4151","name":"DeepSeek Model","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}},{"parameters":{"jsCode":"const inputData = $input.all()[0].json;\nconst workflow = $('BLUEPRINT ENGINE').first().json.workflow;\nlet currentStageId = $('BLUEPRINT ENGINE').first().json.currentStageId;\nlet vars = $('BLUEPRINT ENGINE').first().json.vars;\nlet stageConfig = $('BLUEPRINT ENGINE').first().json.stageConfig;\nlet outputInstruction = \"\";\nlet missingVar = \"\";\nlet immediatelyNextStage = \"\";\n\n// --- 1. ATUALIZA√á√ÉO GLOBAL (Check-in) ---\nconst extractedObj = inputData.output || {};\nfor (const [key, value] of Object.entries(extractedObj)) {\n    // S√≥ atualiza se tiver valor real\n    if (value !== null && value !== undefined && value !== \"\") {\n        vars[key] = { value: value, type: 'extracted' };\n    }\n}\n\n// Helper: Verifica se TODAS as vari√°veis do est√°gio est√£o preenchidas\nfunction isInputSatisfied(stage) {\n    if (!stage || stage.type !== 'input') return false;\n    // Retorna true apenas se TODAS as vari√°veis listadas existirem em 'vars'\n    return stage.variables.every(v => vars[v.name] && vars[v.name].value !== null && vars[v.name].value !== \"\");\n}\n\n\n// --- 2. LOOP DE AVAN√áO (Auto-Skip & Look Ahead) ---\nlet safetyLoop = 0;\nlet advancing = true;\n\nwhile (advancing && safetyLoop < 50) {\n    stageConfig = workflow[currentStageId];\n    if (!stageConfig) break;\n\n    if (stageConfig.immediately_next_stage) {\n      immediatelyNextStage = stageConfig.immediately_next_stage\n    }\n\n    advancing = false; // Por padr√£o, o loop para aqui, a menos que encontre motivo para seguir\n\n    // ======================================================\n    // CASO 1: INPUT (Esperando dados do usu√°rio)\n    // ======================================================\n    if (stageConfig.type === 'input') {\n        if (isInputSatisfied(stageConfig)) {\n            // Temos tudo! Pula para o pr√≥ximo est√°gio.\n            currentStageId = stageConfig.next_stage;\n            advancing = true; \n        } else {\n            // [CORRE√á√ÉO AQUI] Falta resposta. N√£o podemos deixar a instru√ß√£o vazia.\n            // Descobre qual vari√°vel est√° faltando para orientar a IA\n            missingVar = stageConfig.variables.find(v => !vars[v.name] || !vars[v.name].value);\n            \n            if (missingVar) {\n                // Se o usu√°rio falou algo nada a ver (extra√ß√£o rodou mas n√£o pegou o dado)\n                if (Object.keys(extractedObj).length > 0 && !Object.values(extractedObj).find(v => v)) {\n                     outputInstruction = `O usu√°rio respondeu algo, mas n√£o entendi o(a) ${missingVar.description}. Pergunte novamente de forma clara.`;\n                } else {\n                     // Estado padr√£o de espera\n                     outputInstruction = `Pergunte ao usu√°rio sobre: ${missingVar.description}.`;\n                }\n            }\n            // Mantemos advancing = false para PARAR aqui e esperar o user responder\n        }\n    }\n\n    // ======================================================\n    // CASO 2: MENSAGEM (O rob√¥ fala)\n    // ======================================================\n    else if (stageConfig.type === 'message') {\n        // [LOOK AHEAD]\n        // Verifica se a mensagem serve para pedir um dado que J√Å TEMOS.\n        const nextStage = workflow[stageConfig.next_stage];\n        \n        // Se o pr√≥ximo passo √© input E j√° est√° preenchido -> Pula a mensagem atual\n        if (nextStage && nextStage.type === 'input' && isInputSatisfied(nextStage)) {\n            currentStageId = nextStage.next_stage;\n            advancing = true; \n        } else {\n            // Mensagem necess√°ria. Define instru√ß√£o.\n            outputInstruction = stageConfig.instruction;\n            \n            // J√° aponta o ponteiro para o pr√≥ximo est√°gio (onde vamos esperar o input)\n            if (stageConfig.next_stage !== 'STOP') {\n                currentStageId = stageConfig.next_stage;\n                const nextStage = workflow[currentStageId]   \n\n                if (nextStage.type == 'input') {\n                  missingVar = nextStage.variables.find(v => !vars[v.name] || !vars[v.name].value);\n                }\n              \n            }\n            // Para o loop para a IA falar.\n            advancing = false; \n        }\n    }\n\n    // ======================================================\n    // CASO 3: ROUTER (L√≥gica condicional)\n    // ======================================================\n    else if (stageConfig.type === 'router') {\n        let routeFound = false;\n        for (const rule of stageConfig.rules) {\n            if (rule.default) {\n                currentStageId = rule.default;\n                routeFound = true;\n                break;\n            }\n            // Valida√ß√£o simples de valor\n            if (vars[rule.variable] && vars[rule.variable].value === rule.value) {\n                currentStageId = rule.next_stage;\n                routeFound = true;\n                break;\n            }\n        }\n        // Se achou rota, continua avan√ßando no mesmo tick\n        if (routeFound) advancing = true; \n    }\n    \n    safetyLoop++;\n}\n\nreturn {\n    newStageId: currentStageId,\n    updatedVars: vars,\n    finalInstruction: outputInstruction,\n    missingVar, \n    immediatelyNextStage\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-336,3312],"id":"49d85cc1-5324-427b-b56e-d7d5d61cbef2","name":"LOGIC ENGINE"},{"parameters":{"promptType":"define","text":"={{ $('CONCATENA1').first().json.user_full_message }}","options":{"systemMessage":"=** ATEN√á√ÉO M√ÅXIMA: \n- Se o output que voc√™ gerar, n√£o corresponder ao que foi solicitado na INSTRU√á√ÉO DO FLUXO -> FALHA CR√çTICA.\n- Se for inicio de conversa e voc√™ n√£o utilizar a mensagem inicial em conjunto com a instru√ß√£o de fluxo -> FALHA CR√çTICA\n- Adapte a conversa com a INSTRU√á√ÉO DO FLUXO, deixando com tom mais humanizado.\n- Respeite rigidamente a [ESTRUTURA OBRIGAT√ìRIA]\n\n### [ESTRUTURA OBRIGAT√ìRIA]\n`[Resposta Curta/Rea√ß√£o] + [Pivot/Transi√ß√£o] + [Instru√ß√£o do Fluxo]`\n\n\n### [ORDEM DE EXECU√á√ÉO - PRIORIDADE M√ÅXIMA]\n\n1. **VALIDA√á√ÉO DE TOM (Interno):** \n  - Identifique o humor do lead. Se ele for seco, responda de forma direta e SIMP√ÅTICA. Se ele for amig√°vel, use um tom leve. **NUNCA** seja entusiasmada demais ou pare√ßa uma \"vendedora de script\".\n  - Ao fazer uma pergunta, garanta que n√£o est√° dando um TOM de ordem para o usu√°rio.\n\n2. **RESPOSTA (40%):** \n  - **Filtro de Pertin√™ncia**: Use o [CONTEXTO T√âCNICO] APENAS se ele trouxer a resposta exata para a pergunta do usu√°rio.\n  - **PROIBI√á√ÉO DE 'CHUTE'**: Se o usu√°rio perguntar A e o RAG falar sobre B, ignore o RAG e use a Carta de Seguran√ßa para o assunto A. Jamais inclua informa√ß√µes do RAG que n√£o foram solicitadas pelo usu√°rio (ex: se ele n perguntou de taxa, n fale de taxa).\n  - **Carta de Seguran√ßa**: \"Vou ver sobre [ASSUNTO QUESTIONADO] com o time pra n√£o te passar nada errado, t√°?\".\n  - **Se o usu√°rio fizer uma AFIRMA√á√ÉO (ex: desinteresse, nega√ß√£o, aviso):** Apenas reaja de forma humana (ex: \"Tranquilo\", \"Beleza\", \"Sem problemas\") e pule para o Pivot. N√ÉO use a carta de seguran√ßa se n houver uma d√∫vida clara.\n\n\n3. **PIVOT (Transi√ß√£o):** \n- Use um conector curto e natural que fa√ßa a ponte entre a resposta e a pr√≥xima pergunta.\n   - **Se houver desvio/pergunta:** Justifique a volta √† coleta de dados. Use conectivos naturais e humanizados, sem parecer um rob√¥.\n   - **Se o fluxo estiver normal:** Use conectores de continuidade.\nBLOQUEIO DE CRIATIVIDADE: Voc√™ est√° PROIBIDO de criar perguntas de transi√ß√£o ou curiosidades (ex: \"J√° nos conhece?\", \"Como vai o mercado?\"). O Pivot deve servir apenas como uma ponte curta para o texto exato da [INSTRU√á√ÉO DO FLUXO].\n \n4. **√ÇNCORA DO FLUXO (60%):** \n- A mensagem **DEVE** terminar exatamente com o que pede a [INSTRU√á√ÉO DO FLUXO]. Se for uma despedida, encerre o assunto ali. √â proibido tentar reter o lead se a instru√ß√£o for dar tchau.\n  **PROIBIDO:** Jamais inclua termos como \"Diga para\" ou \"Sugira que\". Transforme a instru√ß√£o em fala natural da personagem.\n\n---\n\n### [CONTEXTO E DADOS]\n- *OPTIONS DA √öLTIMA VARI√ÅVEL SOLICITADA (Ignorar se null ou undefined):* {{ JSON.stringify(JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.options) }} \n- **INSTRU√á√ÉO DO FLUXO (CASO HAJA INSTRU√á√ÉO REPETIDA NO PASSO a E b, EXECUTE A INSTRU√á√ÉO UMA UNICA VEZ):** \na. {{ JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').afterRepliedInstruction }} -> Pular para a instru√ß√£o b se null ou undefined\n  b. \"{{ $('LOGIC ENGINE').first().json.finalInstruction }}\". \n- **DADOS COLETADOS:** {{ JSON.stringify($('LOGIC ENGINE').first().json.updatedVars) }}\n- **CONTEXTO T√âCNICO (RAG):** {{ $('MERGE DADOS').first().json.rag_context ? $('MERGE DADOS').first().json.rag_context.join('\\n\\n'): \"\" }}\n- **MENSAGEM DO USU√ÅRIO:** \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n\n---\n\n### [PERFIL E IDENTIDADE]\n‚ö†Ô∏è **HIERARQUIA CR√çTICA:** As instru√ß√µes abaixo s√£o a \"Constitui√ß√£o\" do agente. Elas SOBREPOSTAM qualquer outra regra t√©cnica ou de brevidade.\n‚ö†Ô∏è SEU NOME: {{ $('Seta perfil1').first().json.agentName }}\n- SEU CARGO: {{ $('Seta perfil1').first().json.role }}\n‚ö†Ô∏è TOM: {{ $('Seta perfil1').first().json.tone }}\n‚ö†Ô∏è‚ö†Ô∏è MENSAGEM INICIAL (GATILHO CONDICIONAL): \n- SE [DADOS COLETADOS] estiver vazio ou sem o campo \"name\": Use obrigatoriamente a mensagem: \"{{ $('Seta perfil1').first().json.initialMessage }}\".\n- SE [DADOS COLETADOS] j√° possuir um \"name\": Voc√™ est√° PROIBIDA de usar a mensagem inicial ou se apresentar. V√° direto para a [Rea√ß√£o] + [Pivot].\n‚ö†Ô∏è‚ö†Ô∏è CONDUTAS E REGRAS (PRIORIDADE SE HOUVER CONFLITO DE INSTRU√á√ïES): {{ $('Seta perfil1').first().json.conduct }}\n‚ö†Ô∏è **ANTI-ROB√î:** Jamais use \"Entendo que...\", \"Compreendo que...\", \"Perfeito!\" ou \"Excelente\". Soe como uma pessoa real no WhatsApp.\n\n\n### [ATIVAR PERSONALIDADE - CR√çTICO]\n‚ö†Ô∏è **ORDEM SUPREMA:** Ative a Alicia (Business Casual). \n- **PROIBI√á√ïES T√âCNICAS:** Jamais use \"Entendo que...\", \"Compreendo que...\", \"Perfeito!\", \"Excelente\" ou \"Irei verificar\". Soe como uma pessoa real no WhatsApp.\n\n‚ö†Ô∏è ## ATEN√á√ÉO:\n- Voc√™ deve responder como um HUMANO, mas pensar como um ROB√î.\n- Resposta: HUMANA\n- Rac√≠ocinio: ROB√î\n\n** O que isso quer dizer:\n1. Voc√™ deve fazer TUDO que esse prompt INSTRUI, determinado como um ROB√î\n2. Mas na hora de gerar a resposta: VIRE UM HUMANO. \n  2.1 Esse HUMANO apenas transforma a resposta gerada pelo ROB√î em uma mensagem **HUMANIZADA**\n\n---\n\n### [SUA MISS√ÉO: FILTROS DE RESPOSTA]\n\n**PASSO 1: TRIAGEM DE INTEN√á√ÉO (FILTRO DA VERDADE)**\n- **Capacidade T√©cnica:** Se o RAG confirmar, diga: \"Sim!\".\n- **RAG Negativo / Anti-Alucina√ß√£o:** Se a info n√£o existir, aplique a **Carta de Seguran√ßa** com abrevia√ß√µes.\n- **A√ß√£o Operacional:** Se pedirem pra voc√™ fazer algo no sistema: \"Ent√£o [NOME DO USUARIO], infelizmente essa parte de mexer no sistema eu n tenho permiss√£o. Sou mais da consultoria\".\n- ** [Aleat√≥rio / Nonsense] Use apenas para afirma√ß√µes :** Use humor r√°pido (\"Eita, aleat√≥rio! üòÇ\") e fa√ßa o **Pivot** imediato.\n\n**PASSO 2: CHECAGEM DE TOM E EMPATIA (ANTI-ROB√î)**\n- **Proibido (Efeito Papagaio):** Jamais repita, resuma ou \"confirme\" o valor do dado que o usu√°rio acabou de fornecer. Se o usu√°rio disse \"40 im√≥veis\", voc√™ N√ÉO deve escrever \"40 im√≥veis\" na resposta.\n- **A√ß√£o:** Reaja de forma curta e humana, adaptando sua rea√ß√£o com o contexto da conversa e o assunto atual. (ex: \"Beleza!\", \"Tranquilo\", \"Faz sentido\", \"Show [NOME DO USUARIO]\", \"Entendi, voc√™ que t√° na linha de frente ent√£o\"). Se houver dor, valide de forma direta: \"Te entendo, [DOR DO CLIENTE] √© complicado.\", \"Complicado, te entendo...\", \"Entendi, imagino a correria...\".\n- **SOTAQUE**: Use obrigatoriamente um sotaque parecido: Ex: se o usu√°rio usa: **'teu', UTILIZE: 'teu'. Se adapte ao sotaque do usu√°rio sem soar como deboche.\n\n**PASSO 3: EXECU√á√ÉO E PIVOT OBRIGAT√ìRIO**\n- **Lei Imut√°vel:** Responda curto -> Pivot -> Instru√ß√£o do Fluxo.\n- **Oralidade:** Priorize o texto fluido. Evite excesso de exclama√ß√µes e dois pontos."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[1968,3328],"id":"6ced4093-0584-4920-af03-b19775e2e754","name":"Gerador de Resposta"},{"parameters":{"options":{"temperature":0.2}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[1856,3536],"id":"be6ac7e2-68a2-4fee-b546-db715b6eab8b","name":"OpenAI Persona","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"jsCode":"const messages = $input.item.json.messages || [];\nconst fullText = messages.map(m => m.message).join('\\n');\n\nreturn {\n  user_full_message: fullText,\n  cache_key: $('Configura Contexto').item.json.cache_key\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1872,3312],"id":"cf14ddf9-674e-44b9-8f23-d09c3b549e59","name":"CONCATENA1"},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"description\": \"Objeto JSON contendo as chaves das vari√°veis encontradas e seus respectivos valores.\",\n  \"additionalProperties\": {\n    \"oneOf\": [\n      {\n        \"type\": \"string\"\n      },\n      {\n        \"type\": \"number\"\n      },\n      {\n        \"type\": \"boolean\"\n      },\n      {\n        \"type\": \"null\"\n      },\n      {\n        \"type\": \"array\",\n        \"items\": {\n          \"type\": \"string\"\n        }\n      }\n    ]\n  }\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-528,3536],"id":"f42bfe98-ea4e-4b64-b4b1-f60e99297356","name":"Structured Output Parser1"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Configura Contexto').first().json.cache_key }}"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[2016,3536],"id":"a8393246-bc6a-4b03-94a6-83da16e65edd","name":"Postgres Chat Memory1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"amount":12},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-2256,3584],"id":"7c1edbf7-ad5e-4dcf-aa0e-789071fc18e4","name":"Wait1","webhookId":"d1e38aad-57ac-45e5-b64a-08e2f1ce1a6f"},{"parameters":{"operation":"delete","key":"=temp.{{ $('Configura Contexto').item.json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2112,3328],"id":"69e79069-efac-44b0-8752-141944a73578","name":"DELETE1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2aafb32-380d-4510-810a-888831d36437","leftValue":"={{ DateTime.fromMillis($json.messages?.last().timestamp) }}","rightValue":"={{ $now.minus(12, 'seconds' )}}","operator":{"type":"dateTime","operation":"before"}}],"combinator":"and"},"renameOutput":true,"outputKey":"segue"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3d2a33da-ed74-4906-92aa-74ad3a37c4f1","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"nada"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"espera"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-2448,3328],"id":"cbc8d2d2-e285-4ae7-a886-fbb287f7321e","name":"SWITCH_BUFFER"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-2112,3488],"id":"f59c0a36-e6c1-4183-93dd-37cdb508a130","name":"NADA1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1f5bcbd1-6685-469d-bbf2-7939008b234d","leftValue":"={{ $json.user_msg }}","rightValue":"clear:cache:111222","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4144,3328],"id":"bf1ca13a-53ea-4963-a585-f189a6563522","name":"If2"},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3680,3024],"id":"79a002fa-786e-458a-ac14-5ab9f9e0fbc0","name":"Delete table or rows1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"delete","key":"={{ $('Configura Contexto').item.json.cache_key }}_state"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3856,3024],"id":"a8343dfa-0bf6-4e9a-af8b-f6b1434c747e","name":"Deleta estado atual","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=temp.{{ $('Configura Contexto').item.json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3488,3024],"id":"255c8c55-36e5-4b1d-8a37-680c09c93110","name":"DELETE2","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"return {\n  messages: [\n    ...(typeof $('BUSCA MENSAGENS ACUMULADAS').first().json.messages == 'string' ? JSON.parse($('BUSCA MENSAGENS ACUMULADAS').first().json.messages) : $('BUSCA MENSAGENS ACUMULADAS').first().json.messages), \n    ...(typeof $('GET2').first().json.messages == 'string' ? JSON.parse($('GET2').first().json.messages) : $('GET2').first().json.messages)\n  ]\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3408,3776],"id":"23b8b322-a8bf-405c-8d37-ce4857feb11e","name":"Concatena mensagens para cache"},{"parameters":{"jsCode":"const messages = typeof $input.first().json.messages == 'string' ? JSON.parse($input.first().json.messages) : $input.first().json.messages\n\nreturn {\n  messages: messages?.map(message => typeof message === 'string' ? JSON.parse(message) : message) ?? null\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2800,3344],"id":"d10f3004-81bf-4a98-8b5c-0fddeae017c0","name":"Transforma em objeto literal"},{"parameters":{"method":"PATCH","url":"=https://api-chat-joao.apre.tv/api/ticket/{{ $('Webhook').first().json.body.ticketId }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"pending\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[4432,2688],"id":"c6a24869-19d3-4938-abf6-df95d132a403","name":"Transfere ticket para Aguardando Apre.Chat"},{"parameters":{"method":"POST","url":"=https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output }}"},{"name":"number","value":"={{ $('Webhook').first().json.body.contact.number }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"},{"name":"whatsappId","value":"={{ $('Webhook').first().json.body.whatsappId }}"},{"name":"messageRepliedId","value":"={{ $('Webhook').first().json.body.messageId }}"},{"name":"messageType","value":"internalNote"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5568,2688],"id":"5b7e572b-3651-4df5-9865-14ab2ee04a38","name":"Salva nota na conversa1"},{"parameters":{"jsCode":"const data = $input.all();\nconst formatChatHistory = (inputData) => {\n  return inputData.map(jsonItem => {\n    const item = jsonItem.json\n    // 1. Define o remetente\n    const sender = item.message.type === 'human' ? 'User' : 'IA';\n    \n    // 2. Pega o conte√∫do original\n    let content = item.message.content;\n\n    // 3. Se for IA, aplica a Regex para limpar o \"lixo\" t√©cnico\n    if (item.message.type === 'ai') {\n      // REGEX EXPLICADA:\n      // ^              -> Come√ßa no in√≠cio da string\n      // \\[Used tools:  -> Procura literalmente por \"[Used tools:\"\n      // [\\s\\S]*?       -> Pega qualquer caractere (incluindo quebra de linha) de forma n√£o-gulosa (para no primeiro match)\n      // \\]\\]           -> Procura o fechamento dos colchetes duplos \"]]\"\n      // \\s* -> Remove quaisquer espa√ßos ou quebras de linha que sobrem logo ap√≥s\n      content = content.replace(/^\\[Used tools:[\\s\\S]*?\\]\\]\\s*/, '');\n    }\n\n    // 4. Retorna no formato solicitado\n    return `${sender}: ${content}`;\n  }).join('\\n'); // Une tudo com quebra de linha\n};\n\n// Executa e mostra o resultado\nconst result = formatChatHistory(data);\n\nreturn  {\n  result\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4928,2688],"id":"cc371954-0e52-468e-a628-613d86bb1bb3","name":"Formata hist√≥rico1","executeOnce":true},{"parameters":{"promptType":"define","text":"=[HIST√ìRICO DE CONVERSA]\n{{ $json.result }}","options":{"systemMessage":"*DOSSI√ä*\nCrie um breve Dossi√™ da conversa, listando cada informa√ß√£o separada por linha e colocando a label em negrito.\n\n*AN√ÅLISE*\nTom: Defina o tom/perfil do usu√°rio.\nResumo: Gere um breve resumo da conversa\n\n*ONDE PAROU*\nInforme onde a conversa parou\n\n*PR√ìXIMOS PASSOS*\nDefina os pr√≥ximos passos\n\n## FORMATA√á√ÉO:\nNegrito: Um asterisco antes e depois da palavra/frase. Ex: '*Teste*'\nIt√°lico:  Um underline antes e depois da palavra/frase. Ex: '_Teste_'\n\n## REGRAS DE OURO:\n- Seja breve\n- Crie um resumo objetivo\n- Texto corrido apenas no resumo (bloco an√°lise)\n\n\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[5200,2688],"id":"007a77a5-b5dd-4aea-94ba-f1db12dc9e31","name":"Gera resumo da conversa - AI1"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[5184,2896],"id":"54247887-202c-4374-8679-88bef92c2d42","name":"DeepSeek Chat Model2","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"sort":{"values":[{"column":"id"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[4704,2688],"id":"8c4a0c7a-1b8c-431e-957f-fbf9335c1258","name":"Busca hist√≥rico de conversa1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($json.messages) }}","keyType":"list"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[10416,4384],"id":"a8fdadae-ef2b-4f8c-b163-5adad0f99ea7","name":"Redis1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3856,3344],"id":"86b0b7d7-5b3c-40b5-9b36-5d105fb09f76","name":"Busca mensagens no cache","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"const inputMessages = typeof $input.first().json.messages == 'string' ?  JSON.parse($input.first().json.messages) : $input.first().json.messages\nconst cacheMessagesToArrayJSON = inputMessages?.map(message => typeof message == 'string' ? JSON.parse(message) : message) || []\n\nconst userMsg = {\n  message: $('Configura Contexto').first().json.user_msg, \n  timestamp: $now.toMillis() \n}\n\nreturn {\n  messages: [\n    ...cacheMessagesToArrayJSON, \n    userMsg\n  ]\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3600,3344],"id":"a3f5df3e-7e44-4e89-a83b-b12e2a600f89","name":"Junta mensagem do cache com a mensagem do usu√°rio"},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3216,3344],"id":"b152ad4c-b260-4607-a58f-db9cc01ff585","name":"SETA CACHE DAS MENSAGENS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3008,3344],"id":"bbd78cab-c1e3-4d77-8975-3355a5797611","name":"BUSCA MENSAGENS ACUMULADAS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($('Concatena mensagens para cache').first().json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3616,3776],"id":"fbfd7185-60e4-4333-a92d-2714867e1207","name":"RE-SETA CACHE DAS MENSAGENS ACUMULADAS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"check-question","leftValue":"={{ $json.output.hasQuestion }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[528,3312],"id":"a4b5d3a6-6c42-4ce0-b065-2e706646d9d3","name":"Tem D√∫vida?"},{"parameters":{"mode":"load","tableName":"n8","prompt":"={{ $('CONCATENA1').first().json.user_full_message }}","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[880,3056],"id":"513d1da3-48a6-4591-b2bd-4b45188d3b7e","name":"Consulta Base Conhecimento","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[880,3232],"id":"ca10a115-b9dc-4272-9f40-aecce6cb838d","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"jsCode":"return {\n  rag_context: $input.all().map(d => d.json.document.pageContent)\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1232,3056],"id":"612f63e5-d3b4-4e60-89cd-0c55d2ecd635","name":"RAG CONTEXT","executeOnce":true},{"parameters":{"jsCode":"return {\n  rag_context: $json.rag_context\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1504,3328],"id":"84b694d4-8676-4034-a103-ccf5f04499da","name":"MERGE DADOS"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":5,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').item.json.cache_key }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1200,3312],"id":"7466f742-b65f-413a-997f-b79463f0e820","name":"Pega ultimas mensagens","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-928,3312],"id":"a882932e-22d3-4b22-b1c1-c6827396490b","name":"Formata ultimas mensagens","executeOnce":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"CLOSING","operator":{"type":"string","operation":"equals"},"id":"732957f5-38a8-4204-ab63-9403f96c1a78"}],"combinator":"and"},"renameOutput":true,"outputKey":"closing"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1a022d7b-9866-445e-824d-ee7a7616d891","leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"CLOSING_WHEN_INVALID_OPTION","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"closing_when_invalid_option"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3807d7cc-18c1-470f-9689-a991e3d75d2b","leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"SEND_COMMERCIAL_PRESENTATION","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"send_commercial_presentation"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[4176,3024],"id":"84387f41-3b93-4061-8267-467d52be731d","name":"Switch"},{"parameters":{"workflowId":{"__rl":true,"value":"wd0uAb0Sm1fW5YNt","mode":"list","cachedResultUrl":"/workflow/wd0uAb0Sm1fW5YNt","cachedResultName":"Enviar apresenta√ß√£o comercial"},"workflowInputs":{"mappingMode":"defineBelow","value":{"whatsappId":"={{ $('Configura Contexto').first().json.whatsappId.toNumber() }}","messageRepliedId":0,"company":"={{ $('Configura Contexto').first().json.companyId }}","number":"={{ $('Configura Contexto').first().json.user_phone }}","addUserName":"={{ $('Seta perfil1').first().json.agentName }}","message":"Segue! üöÄüöÄ"},"matchingColumns":[],"schema":[{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"number","displayName":"number","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"addUserName","displayName":"addUserName","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsappId","displayName":"whatsappId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"messageRepliedId","displayName":"messageRepliedId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"company","displayName":"company","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[4080,2688],"id":"6fab4d52-fa2e-4e76-a30e-a340ae83b733","name":"Call 'Enviar apresenta√ß√£o comercial'","executeOnce":true},{"parameters":{"toolDescription":"## TOOL: Enviar para um especialista\n\n## GATILHO (Execute essa tool sempre que a conversa estiver no contexto das condi√ß√µes abaixo):\n- Se o usu√°rio estiver insistindo em uma op√ß√£o que n√£o √© valida em algum dos est√°gios\n- Se o usu√°rio indicar irrita√ß√£o ou estresse extremo com o atendimento\n- Se o usu√°rio insistir em um atendimento com um humano\n\n[REGRA SUPREMA - PRIORIDADE M√ÅXIMA]\nSe o gatilho for acionado: \n1. execute esta tool\n2. Ignore qualquer outra instru√ß√£o e informe ao usu√°rio que o atendimento ser√° enviado para um especialista conseguir ajudar o usu√°rio da melhor forma.","method":"PATCH","url":"=https://api-chat-joao.apre.tv/api/ticket/{{ $('Webhook').first().json.body.ticketId }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"pending\"\n}","options":{}},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.3,"position":[2208,3536],"id":"073030d3-c23f-4045-ab81-026f20d44db5","name":"Enviar para um especialista"}],"connections":{"Transforma vari√°veis em tabela":{"main":[[{"node":"Seta perfil","type":"main","index":0}]]},"Busca vari√°veis":{"main":[[{"node":"Busca est√°gios","type":"main","index":0}]]},"Cria cache key":{"main":[[{"node":"If","type":"main","index":0}]]},"Seta est√°gios":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Seta perfil":{"main":[[{"node":"Seta lastVar solicitada","type":"main","index":0}]]},"Seta vari√°veis da conversa":{"main":[[{"node":"Transforma vari√°veis em tabela","type":"main","index":0}]]},"Retorna message":{"main":[[{"node":"Cria cache key","type":"main","index":0}]]},"Busca last var":{"main":[[{"node":"Busca vari√°veis","type":"main","index":0}]]},"Seta lastVar solicitada":{"main":[[{"node":"Seta est√°gios","type":"main","index":0}]]},"Seta cache das variaveis":{"main":[[{"node":"Seta cache lastVar solicitada","type":"main","index":0}]]},"Deleta cache lastVar":{"main":[[{"node":"Delete cache variaveis","type":"main","index":0}]]},"Busca est√°gios":{"main":[[{"node":"Seta vari√°veis da conversa","type":"main","index":0}]]},"Seta cache lastVar solicitada":{"main":[[{"node":"Seta cache est√°gios","type":"main","index":0}]]},"Delete cache variaveis":{"main":[[{"node":"Deleta cache est√°gios","type":"main","index":0}]]},"Deleta cache est√°gios":{"main":[[{"node":"Delete table or rows","type":"main","index":0}]]},"Embeddings OpenAI1":{"ai_embedding":[[{"node":"Busca informa√ß√µes do banco de dados","type":"ai_embedding","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"Busca informa√ß√µes do banco de dados":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"AI Agent":{"main":[[{"node":"output","type":"main","index":0}]]},"AI Agent - Verifica sem tem vari√°vel para atualizar":{"main":[[{"node":"Atualiza vari√°veis","type":"main","index":0}]]},"Atualiza vari√°veis":{"main":[[{"node":"Busca est√°gio","type":"main","index":0}]]},"Busca est√°gio":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Seta cache est√°gios":{"main":[[{"node":"If1","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"AI Agent - Verifica sem tem vari√°vel para atualizar","type":"ai_outputParser","index":0}]]},"DeepSeek Chat Model":{"ai_languageModel":[[{"node":"AI Agent - Verifica sem tem vari√°vel para atualizar","type":"ai_languageModel","index":0}]]},"Retorna estagios que n√£o foram executados ainda":{"main":[[{"node":"Seta cache das variaveis","type":"main","index":0}]]},"If1":{"main":[[{"node":"Transfere ticket para Aguardando Apre.Chat1","type":"main","index":0},{"node":"Deleta cache lastVar","type":"main","index":0}],[]]},"PUSH":{"main":[[{"node":"GET","type":"main","index":0}]]},"Wait":{"main":[[{"node":"GET","type":"main","index":0}]]},"GET":{"main":[[{"node":"SWITCH_BUFFER1","type":"main","index":0}]]},"DELETE":{"main":[[{"node":"CONCATENA","type":"main","index":0}]]},"SWITCH_BUFFER1":{"main":[[{"node":"DELETE","type":"main","index":0}],[{"node":"NADA","type":"main","index":0}],[{"node":"Wait","type":"main","index":0}]]},"CONCATENA":{"main":[[{"node":"Busca last var","type":"main","index":0}]]},"If":{"main":[[{"node":"Deleta cache lastVar","type":"main","index":0}],[{"node":"PUSH","type":"main","index":0}]]},"Delete table or rows":{"main":[[{"node":"Delete memory messages","type":"main","index":0}]]},"LOOP_SLIT":{"main":[[{"node":"Retorna estagios que n√£o foram executados ainda","type":"main","index":0}],[{"node":"Envia resposta para o Lead","type":"main","index":0}]]},"WAIT_SPLIT":{"main":[[{"node":"LOOP_SLIT","type":"main","index":0}]]},"output":{"main":[[{"node":"Parser  Chain","type":"main","index":0}]]},"OpenAI3":{"ai_languageModel":[[{"node":"Parser  Chain","type":"ai_languageModel","index":0}]]},"OutputParser1":{"ai_outputParser":[[{"node":"Parser  Chain","type":"ai_outputParser","index":0}]]},"Parser  Chain":{"main":[[{"node":"Split de Mensagem","type":"main","index":0}]]},"Split de Mensagem":{"main":[[{"node":"LOOP_SLIT","type":"main","index":0}]]},"Envia resposta para o Lead":{"main":[[{"node":"WAIT_SPLIT","type":"main","index":0}]]},"Transfere ticket para Aguardando Apre.Chat1":{"main":[[{"node":"Busca hist√≥rico de conversa","type":"main","index":0}]]},"Formata hist√≥rico":{"main":[[{"node":"Gera resumo da conversa - AI","type":"main","index":0}]]},"Gera resumo da conversa - AI":{"main":[[{"node":"Salva nota na conversa","type":"main","index":0}]]},"DeepSeek Chat Model1":{"ai_languageModel":[[{"node":"Gera resumo da conversa - AI","type":"ai_languageModel","index":0}]]},"Busca hist√≥rico de conversa":{"main":[[{"node":"Formata hist√≥rico","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"Formata √∫ltima mensagem enviada pela IA","type":"main","index":0}]]},"Formata √∫ltima mensagem enviada pela IA":{"main":[[{"node":"AI Agent - Verifica sem tem vari√°vel para atualizar","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Se n√£o recebeu mensagem no meio do processamento":{"main":[[{"node":"Split de mensagens","type":"main","index":0}],[{"node":"Concatena mensagens para cache","type":"main","index":0}]]},"GET2":{"main":[[{"node":"Se n√£o recebeu mensagem no meio do processamento","type":"main","index":0}]]},"Salva Novo Estado":{"main":[[{"node":"Router de D√∫vida","type":"main","index":0}]]},"Parser  Chain1":{"main":[[{"node":"GET2","type":"main","index":0}]]},"OutputParser":{"ai_outputParser":[[{"node":"Parser  Chain1","type":"ai_outputParser","index":0}]]},"OpenAI":{"ai_languageModel":[[{"node":"Parser  Chain1","type":"ai_languageModel","index":0}]]},"output1":{"main":[[{"node":"Parser  Chain1","type":"main","index":0}]]},"Split de mensagens":{"main":[[{"node":"LOOP_SLIT1","type":"main","index":0}]]},"WAIT_SPLIT1":{"main":[[{"node":"LOOP_SLIT1","type":"main","index":0}]]},"LOOP_SLIT1":{"main":[[{"node":"Switch","type":"main","index":0}],[{"node":"Envia WhatsApp1","type":"main","index":0}]]},"Envia WhatsApp1":{"main":[[{"node":"WAIT_SPLIT1","type":"main","index":0}]]},"Seta perfil1":{"main":[[{"node":"Gerador de Resposta","type":"main","index":0}]]},"Parser Router":{"ai_outputParser":[[{"node":"Router de D√∫vida","type":"ai_outputParser","index":0}]]},"OpenAI Router":{"ai_languageModel":[[{"node":"Router de D√∫vida","type":"ai_languageModel","index":0}]]},"Router de D√∫vida":{"main":[[{"node":"Tem D√∫vida?","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Configura Contexto","type":"main","index":0}]]},"GET Estado Atual":{"main":[[{"node":"BLUEPRINT ENGINE","type":"main","index":0}]]},"BLUEPRINT ENGINE":{"main":[[{"node":"Pega ultimas mensagens","type":"main","index":0}]]},"Extrator Inteligente":{"main":[[{"node":"LOGIC ENGINE","type":"main","index":0}]]},"DeepSeek Model":{"ai_languageModel":[[{"node":"Extrator Inteligente","type":"ai_languageModel","index":0}]]},"LOGIC ENGINE":{"main":[[{"node":"Salva Novo Estado","type":"main","index":0}]]},"Gerador de Resposta":{"main":[[{"node":"output1","type":"main","index":0}]]},"OpenAI Persona":{"ai_languageModel":[[{"node":"Gerador de Resposta","type":"ai_languageModel","index":0}]]},"CONCATENA1":{"main":[[{"node":"GET Estado Atual","type":"main","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"Extrator Inteligente","type":"ai_outputParser","index":0}]]},"Postgres Chat Memory1":{"ai_memory":[[{"node":"Gerador de Resposta","type":"ai_memory","index":0}]]},"Wait1":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"DELETE1":{"main":[[{"node":"CONCATENA1","type":"main","index":0}]]},"SWITCH_BUFFER":{"main":[[{"node":"DELETE1","type":"main","index":0}],[{"node":"NADA1","type":"main","index":0}],[{"node":"Wait1","type":"main","index":0}]]},"Configura Contexto":{"main":[[{"node":"If2","type":"main","index":0}]]},"If2":{"main":[[{"node":"Deleta estado atual","type":"main","index":0}],[{"node":"Busca mensagens no cache","type":"main","index":0}]]},"Deleta estado atual":{"main":[[{"node":"Delete table or rows1","type":"main","index":0}]]},"Delete table or rows1":{"main":[[{"node":"DELETE2","type":"main","index":0}]]},"Concatena mensagens para cache":{"main":[[{"node":"RE-SETA CACHE DAS MENSAGENS ACUMULADAS","type":"main","index":0}]]},"Transforma em objeto literal":{"main":[[{"node":"SWITCH_BUFFER","type":"main","index":0}]]},"Formata hist√≥rico1":{"main":[[{"node":"Gera resumo da conversa - AI1","type":"main","index":0}]]},"Gera resumo da conversa - AI1":{"main":[[{"node":"Salva nota na conversa1","type":"main","index":0}]]},"DeepSeek Chat Model2":{"ai_languageModel":[[{"node":"Gera resumo da conversa - AI1","type":"ai_languageModel","index":0}]]},"Busca hist√≥rico de conversa1":{"main":[[{"node":"Formata hist√≥rico1","type":"main","index":0}]]},"Transfere ticket para Aguardando Apre.Chat":{"main":[[{"node":"Busca hist√≥rico de conversa1","type":"main","index":0}]]},"Busca mensagens no cache":{"main":[[{"node":"Junta mensagem do cache com a mensagem do usu√°rio","type":"main","index":0}]]},"Junta mensagem do cache com a mensagem do usu√°rio":{"main":[[{"node":"SETA CACHE DAS MENSAGENS","type":"main","index":0}]]},"SETA CACHE DAS MENSAGENS":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"BUSCA MENSAGENS ACUMULADAS":{"main":[[{"node":"Transforma em objeto literal","type":"main","index":0}]]},"Tem D√∫vida?":{"main":[[{"node":"Consulta Base Conhecimento","type":"main","index":0}],[{"node":"MERGE DADOS","type":"main","index":0}]]},"Consulta Base Conhecimento":{"main":[[{"node":"RAG CONTEXT","type":"main","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Consulta Base Conhecimento","type":"ai_embedding","index":0}]]},"RAG CONTEXT":{"main":[[{"node":"MERGE DADOS","type":"main","index":0}]]},"MERGE DADOS":{"main":[[{"node":"Seta perfil1","type":"main","index":0}]]},"Pega ultimas mensagens":{"main":[[{"node":"Formata ultimas mensagens","type":"main","index":0}]]},"Formata ultimas mensagens":{"main":[[{"node":"Extrator Inteligente","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Transfere ticket para Aguardando Apre.Chat","type":"main","index":0}],[{"node":"Transfere ticket para Aguardando Apre.Chat","type":"main","index":0}],[{"node":"Call 'Enviar apresenta√ß√£o comercial'","type":"main","index":0}]]},"Call 'Enviar apresenta√ß√£o comercial'":{"main":[[{"node":"Transfere ticket para Aguardando Apre.Chat","type":"main","index":0}]]},"Enviar para um especialista":{"ai_tool":[[{"node":"Gerador de Resposta","type":"ai_tool","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n.apresenta.me","x-real-ip":"172.68.191.167","x-real-port":"18002","x-forwarded-for":"177.136.163.95, 172.68.191.167","x-forwarded-proto":"http","x-forwarded-host":"n8n.apresenta.me","x-forwarded-port":"80","remote-host":"172.68.191.167","connection":"close","content-length":"711","accept":"application/json, text/plain, */*","accept-encoding":"gzip, br","user-agent":"axios/1.12.2","cf-ray":"9bdffc3bfe5a167d-NVT","content-type":"application/json","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"177.136.163.95","cf-ipcountry":"BR","cf-visitor":"{\"scheme\":\"https\"}"},"params":{},"query":{},"body":{"message":"Preciso de site","messageId":"2580088","contact":{"id":"38043","name":"554788950332","number":"554788950332","profilePicUrl":"https://pps.whatsapp.net/v/t61.24694-24/425105449_1361615211300388_1143514098522857072_n.jpg?ccb=11-4&oh=01_Q5Aa3gGUBaB4eDdBUd8jP0HDGh9UgGm57aC03iF6V4HX3DUCFg&oe=697520A3&_nc_sid=5e03e0&_nc_cat=102","createdAt":"2025-10-09T16:20:11.311-03:00","updatedAt":"2026-01-14T17:46:52.862-03:00","email":"","isGroup":false,"companyId":"5005","whatsappId":"4","onlyResponsible":false,"userId":"1","aprePersonId":"4916708","apreDealId":null,"blocked":false,"meta":{"ignoreCheck":true,"ignorePermission":true,"dontSendSocket":false}},"whatsappId":"4","companyId":5005,"ticketId":87971},"webhookUrl":"https://n8n.apresenta.me/webhook/7223c6af-f595-4bc2-b84c-602b8900cd08","executionMode":"production"}}]},"versionId":"7ba2331a-e50f-4231-aa7e-dc40bf78199f","triggerCount":1,"shared":[{"updatedAt":"2025-11-04T18:47:16.654Z","createdAt":"2025-11-04T18:47:16.654Z","role":"workflow:owner","workflowId":"dDaZdsSmHxktrhjc","projectId":"4ToGMYJEWvvDSbcz"}],"tags":[]}