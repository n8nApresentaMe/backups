{"updatedAt":"2025-11-28T14:17:22.000Z","createdAt":"2025-08-16T14:49:36.978Z","id":"Mf8XNJsuIL3652pf","name":"â¤ï¸ AnÃ¡lise de Lead","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"lead-timeline","responseMode":"lastNode","options":{}},"id":"3306c9b3-336b-4b4e-93ac-aaf207a932c0","name":"Webhook (Lead Timeline)","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-7696,2032],"webhookId":"0baf53e6-8557-49d0-8377-7fe4a87a204e"},{"parameters":{"jsCode":"const { activities, comments, stageHistory } = $('Buscar dados da Timeline do Lead').first().json\n\nfunction toBrazilDate(dateString) {\n  const date = new Date(dateString);\n  date.setHours(date.getHours() - 3);\n  return date;\n}\n\nconst data = []\n\nasync function mapperActivities() {\n  for (const item of activities) {\n    const createdAt = toBrazilDate(item.CREATED)\n    const lastUpdatedAt = toBrazilDate(item.LAST_UPDATED)\n    const startedAt = toBrazilDate(item.START_TIME)\n    const finishedAt = toBrazilDate(item.END_TIME)\n                                    \n    const mappedActivity = {\n      historyName: 'activity',\n      registerId: item.ID, \n      subject: item.SUBJECT,\n      typeId: item.PROVIDER_TYPE_ID,\n      isCompleted: item.COMPLETED == 'Y',\n      createdAt, \n      lastUpdatedAt,\n      startedAt,\n      finishedAt\n    }\n\n    if (item.CALL_DETAILS) {\n      const call = item.CALL_DETAILS\n      \n      mappedActivity.callDetails = {\n        registerId: call.ID,\n        category: call.CALL_CATEGORY,\n        durationInSeconds: call.CALL_DURATION,\n        callUrl: call.CALL_RECORD_URL,\n        callCost: call.COST, \n        callCostCurrency: call.COST_CURRENCY, \n        callKey: call.CALL_ID\n      }\n    }\n    \n    data.push(mappedActivity)\n  }\n}\nfunction mapperComments() {\n  for (const item of comments) {\n    const createdAt = toBrazilDate(item.CREATED)\n    \n    const mappedComments = {\n      historyName: 'comment',\n      registerId: item.ID,\n      createdAt,\n      comment: item.COMMENT\n    }\n\n    data.push(mappedComments)\n  }\n}\nfunction mapperStageHistory() {\n  for (const item of stageHistory) {\n    const createdAt = toBrazilDate(item.CREATED_TIME) \n    \n    const mappedStageHistory = {\n      historyName: 'stageHistory',\n      registerId: item.ID,\n      status: item.STATUS_ID,\n      createdAt\n    }\n\n    data.push(mappedStageHistory)\n  }\n}\n\nawait mapperActivities();\nawait mapperComments();\nawait mapperStageHistory();\n\nreturn data\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6176,2048],"id":"9ff28547-cf67-453a-b273-e9f3e9abbda5","name":"Mapear dados do CRM"},{"parameters":{"jsCode":"const { leadId } = $('Webhook (Lead Timeline)').first().json.query\n\nif (!leadId) {\n  throw new Error('Ã‰ necessÃ¡rio informar o id do lead.')\n}\n\nreturn [{\n  leadId \n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-7280,2032],"id":"64452bca-9aa3-4faf-9d3c-78944cfe8fda","name":"Valida parÃ¢metros"},{"parameters":{"jsCode":"const sleep = (ms) => new Promise((r) => setTimeout(r, ms));\n\nasync function bitrixList(method, params) {\n  const url = `${$env.BITRIX_URL}${method}`;\n  let start = 0;\n  const out = [];\n  let tries = 0;\n\n  while (true) {\n    const body = { ...params };\n    if (start) body.start = start;\n\n    try {\n      const res = await this.helpers.httpRequest({\n        method: \"POST\",\n        url,\n        json: true,\n        body,\n        timeout: 30000,\n      });\n\n      let items = Array.isArray(res?.result) ? (res.result ?? []) : [];\n      items = !items.length && (typeof res?.result == 'object') ? res?.result.items : items \n      out.push(...items);\n\n      if (res?.next !== undefined && res.next !== null) {\n        start = res.next;\n        tries = 0;\n        await sleep(200);\n      } else {\n        break;\n      }\n    } catch (err) {\n      if (++tries <= 3) {\n        await sleep(500 * tries);\n        continue;\n      }\n      throw new Error(`Falha em ${method}: ${err.message || String(err)}`);\n    }\n  }\n  return out;\n}\n\nconst leadId = $input.first().json.id\n\nconst a1 = await bitrixList(\"crm.activity.list\", {\n  entityTypeId: 1,\n  order: { ID: \"ASC\" },\n  filter: { \"OWNER_ID\": leadId },\n  select: [\n    \"ID\",\n    \"SUBJECT\",\n    \"PROVIDER_TYPE_ID\",\n    \"COMPLETED\",\n    \"CREATED\",\n    \"LAST_UPDATED\",\n    \"START_TIME\",\n    \"END_TIME\"\n  ],\n});\n\nconst a2 = await bitrixList(\"crm.timeline.comment.list\", {\n  filter: {\n    ENTITY_ID: leadId,\n    ENTITY_TYPE: \"lead\",\n  },\n  select: [\"ID\", \"COMMENT\", \"CREATED\", \"AUTHOR_ID\", \"FILES\"],\n});\n\nconst a3 = await bitrixList(\"crm.stagehistory.list\", {\n    entityTypeId: 1,\n    order: { \"ID\": \"DESC\"},\n    filter: { \"OWNER_ID\": leadId },\n    select: [\"ID\", \"STATUS_ID\", \"CREATED_TIME\"],\n});\n\nfor (const item of a1) {\n    if (item.PROVIDER_TYPE_ID == 'CALL') {\n      const base = \"https://crm.apresenta.me/rest/1/2a5nmkk1mq5yvpvx\";\n      const url = `${base}/voximplant.statistic.get.json`;\n      \n      const res = await this.helpers.httpRequest({\n        method: \"POST\",\n        url,\n        json: true,\n        body: {\n          \"filter\": {\n            \"CRM_ACTIVITY_ID\": item.ID,\n            \">CALL_DURATION\": 30\n          },\n          \"order\": {\n            \"CALL_START_DATE\": \"DESC\"\n          },\n          \"start\": 0,\n          \"select\": [\n            \"CALL_ID\",\n            \"CALL_TYPE\",\n            \"CALL_START_DATE\",\n            \"DURATION\",\n            \"COMMENT\"\n          ]\n        },\n        timeout: 30000,\n      });\n  \n      item.CALL_DETAILS = res.result[0]\n    }  \n}\n\nconst out = [\n  {\n    activities: a1,\n    comments: a2,\n    stageHistory: a3,\n  },\n];\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6560,2048],"id":"3f3bfea8-fb8f-4b2c-82e6-98a5eaf9c57f","name":"Buscar dados da Timeline do Lead"},{"parameters":{"jsCode":"const messages = $input.first().json.messages\n\nreturn {\n  messages: messages?.data?.filter(message => ['audio', 'audioMessage'].includes(message.messageType) && !!message.mediaUrl && !!message.file).map(message => ({ json: message })) || []\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5552,2816],"id":"e5c90540-33f2-440b-801f-ffd4e215323d","name":"Filtra por Ã¡udio"},{"parameters":{"jsCode":"const stories = $input.all()\n\nreturn {\n  stories: stories.filter(history => history.json.historyName === 'activity' && history.json.typeId === 'CALL' && !!history.json.callDetails?.callUrl && history.json.isCompleted)\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6384,2048],"id":"fd502f8a-acdc-4991-be4e-28448f31fc62","name":"Filtra por call"},{"parameters":{"jsCode":"const allStories = $('Mapear dados do CRM').all()\nconst allStoriesMap = new Map()\nconst historyCalls = $('Filtra por call').first().json.stories\nconst transcribedCalls = $input.all()\n\nfor (const history of allStories) {\n  allStoriesMap.set(`${history.json.registerId}-${history.json.historyName}`, history)\n\n}\n\nfor (const transcribed of transcribedCalls) {\n  const call = historyCalls[transcribed.pairedItem.item]\n  const transcription = transcribed.json.text\n\n  call.json.callDetails = {\n    ...call.json.callDetails, \n    transcription\n  }\n  \n  allStoriesMap.set(`${call.json.registerId}-${call.json.historyName}`, call)\n}\n\nreturn Array.from(allStoriesMap.values())"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5424,2048],"id":"3ccf0972-21f7-4255-9f4e-0e8031325ed7","name":"Junta as transcriÃ§Ãµes com a timeline"},{"parameters":{"jsCode":"const allMessages = $('Busca Mensagens do lead no Apre.Chat').first().json.messages.data\nconst allMessagesMap = new Map()\nconst audioMessages = $('Filtra por Ã¡udio').first().json.messages\nconst transcribedAudios =  $input.all()\n\nfor (const message of allMessages) {\n  allMessagesMap.set(String(message.id), {json:{\n    ...message\n  }})\n}\n\nconsole.log(audioMessages)\nconsole.log(transcribedAudios)\n\nfor (const transcribed of transcribedAudios) {\n  const audioMessage = audioMessages[transcribed.pairedItem.item]\n  const transcription = transcribed.json.text\n\n  allMessagesMap.set(String(audioMessage.json.id), {\n    json: {\n      ...audioMessage, \n      transcription: transcription\n    }\n  })\n}\n\nreturn Array.from(allMessagesMap.values())\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4624,2816],"id":"a6cef695-101b-4c4d-9a79-870ff6d92f9f","name":"Junta as transcriÃ§Ãµes com as mensagens"},{"parameters":{"method":"POST","url":"https://api.apresenta.me/comercial/bitrix/leadGet","sendQuery":true,"queryParameters":{"parameters":[{"name":"id","value":"={{ $json.leadId }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-7072,2032],"id":"426a5cc3-fa3b-469b-ad52-f9ae6d24bb01","name":"Busca dados do Lead"},{"parameters":{"url":"=https://api.apre.chat/api/messages/{{ $json.whatsapp || '00' }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8="},{"name":"company","value":"10"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-6144,2512],"id":"2f1cc56f-f209-4557-998e-6088ede36761","name":"Busca Mensagens do lead no Apre.Chat","onError":"continueRegularOutput"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-3984,2272],"id":"de3dac9e-cb12-4c23-a354-3476a602da8b","name":"Junta mensagens com histÃ³rico da timeline do Lead","alwaysOutputData":true},{"parameters":{"method":"POST","url":"https://n8n.apresenta.me/webhook/audio-transcribe","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"url\": \"{{ $json.url }}\", \n  \"key\": \"{{ $json.key }}\",\n  \"force\": {{ $json.force }}\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-5632,2048],"id":"6d1d563b-6b59-4aa8-a107-57604de7727b","name":"Transcrever calls"},{"parameters":{"jsCode":"const calls = $input.first().json.stories\n\nreturn calls.map(call => ({\n  url: call.json.callDetails.callUrl, \n  key: `${call.json.callDetails.registerId}_${call.json.callDetails.callKey}`,\n  force: $('Webhook (Lead Timeline)').first().json.query.force == 'Y'\n}))"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5856,2048],"id":"81851c23-0714-4941-9188-9f82e677ea00","name":"Mapear url das calls"},{"parameters":{"jsCode":"const audios = $(\"Filtra por Ã¡udio\").first().json.messages\n\nreturn audios?.map(audio => ({\n  url: audio.json.mediaUrl, \n  force: $('Webhook (Lead Timeline)').first().json.query.force == 'Y',\n  key: `${audio.json.id}_${audio.json.file.fileName}`\n}))"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5056,2816],"id":"43d2abdf-490c-43f4-8aee-49f75ccb7670","name":"Mapear url dos Ã¡udios"},{"parameters":{"method":"POST","url":"https://n8n.apresenta.me/webhook/audio-transcribe","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"url\": \"{{ $json.url }}\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-4848,2816],"id":"28045f47-9912-41ec-a18c-6b331bcc5ef7","name":"Transcrever audios"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0e7bb9f9-1d07-47aa-b731-59c869540da5","leftValue":"={{ $json.whatsapp?.length.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-6416,2528],"id":"5e554bf1-576c-40b0-b655-fe3608411f3a","name":"Verifica se o Lead tem WhatsApp cadastrado"},{"parameters":{"jsCode":"const stories = $input.all()\nconst sortedStories = stories.sort((a, b) => new Date(a.json.createdAt) - new Date(b.json.createdAt))\nreturn {\n  sortedStories\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3776,2272],"id":"e24c935c-bcb2-43d7-ac1c-dd7c67d2b449","name":"Ordena por data de criaÃ§Ã£o"},{"parameters":{"jsCode":"return $('Busca Mensagens do lead no Apre.Chat').first().json.messages?.data?.map(message => ({\n  historyName: 'whatsAppMessage', \n  ...message  \n}))"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5360,2816],"id":"1eec0f50-b2d9-4169-99fd-e68a215b5f96","name":"Normaliza dados"},{"parameters":{"method":"POST","url":"={{ $env.BITRIX_URL }}crm.timeline.logmessage.add","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"fields\": {\n        \"entityTypeId\": 1,\n        \"entityId\": \"{{ $json.query.leadId }}\",\n        \"title\": \"â¤ï¸ AnÃ¡lise de Lead inciada.\",\n        \"text\": \"AnÃ¡lise do Lead foi iniciada com sucesso!\",\n        \"iconCode\": \"task-activity\"\n    }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-7488,2032],"id":"a16315e5-40a7-4cc0-8c37-881c9adbecbc","name":"Salva Log no Lead","retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $env.BITRIX_URL }}crm.lead.update","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"id\": \"{{ $('Busca dados do Lead').first().json.id }}\",\n    \"fields\": {\n        \"UF_CRM_LEAD_ANALYSIS\": {{ $json.lead.analysisWithoutEmojiEncoded }},\n        \"UF_CRM_LEAD_ANALYSIS_DATE\": \"{{ (() => { const d = new Date(); const pad = n => String(n).padStart(2,'0'); const tz = -d.getTimezoneOffset(); const sign = tz >= 0 ? '+' : '-'; const h = pad(Math.floor(Math.abs(tz) / 60)); const m = pad(Math.abs(tz) % 60); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}${sign}${h}:${m}`; })() }}\"\n    }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2800,2272],"id":"0c01e545-6cdf-4611-ac37-3626f9c27d1a","name":"âœï¸ Altera dados do Lead","retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $env.BITRIX_URL }}crm.timeline.comment.add","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"fields\": {\n        \"ENTITY_TYPE\": \"lead\",\n        \"ENTITY_ID\": \"{{ $('Busca dados do Lead').first().json.id }}\",\n        \"COMMENT\": {{ $('Ajusta informaÃ§Ãµes').item.json.lead.analysisBbCodeEncoded }}\n    }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2608,2272],"id":"63037e52-99b6-4c48-a6fe-eb557a46fd43","name":"Salva comentÃ¡rio com AnÃ¡lise no Lead","retryOnFail":true},{"parameters":{"jsCode":"function removeEmojis(str) {\n  const re = /(?:[\\u{1F1E6}-\\u{1F1FF}]{2}|[#*0-9]\\uFE0F?\\u20E3|\\p{Extended_Pictographic}(?:\\uFE0F|\\u200D(?:\\p{Extended_Pictographic}|\\u2640|\\u2642)\\uFE0F?)*|\\uFE0F|\\u200D)/gu;\n  return str.replace(re, '');\n}\n\n\nfunction markdownToBBCode(markdown) {\n  return markdown\n    // TÃ­tulos\n    .replace(/^### (.*$)/gim, '[b]$1[/b]')\n    .replace(/^## (.*$)/gim, '[b]$1[/b]')\n    .replace(/^# (.*$)/gim, '[b]$1[/b]')\n\n    // Negrito\n    .replace(/\\*\\*(.*?)\\*\\*/g, '[b]$1[/b]')\n\n    // ItÃ¡lico (opcional, se quiser suportar *texto*)\n    .replace(/\\*(.*?)\\*/g, '[i]$1[/i]')\n\n    // Quebras de linha duplas viram parÃ¡grafo\n    .replace(/\\n{2,}/g, '\\n\\n')\n}\n\nreturn {\n  lead: {\n    id: $('Busca dados do Lead').first().json.id,\n    analysisBbCodeEncoded: JSON.stringify(markdownToBBCode($input.first().json.output)),\n    analysisWithoutEmojiEncoded: JSON.stringify(removeEmojis($input.first().json.output)),\n  }\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2992,2272],"id":"5c027103-47e7-47d2-8d3e-81b306b59e69","name":"Ajusta informaÃ§Ãµes"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"dcb1dc1a-aa81-4222-a916-5aad835db918","leftValue":"={{ $('Filtra por call').item.json.stories.length.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-6016,1888],"id":"bae7ab7b-7642-4231-8fbe-d8dbcaa60acd","name":"Se tiver call na timeline"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"571ae3a5-3f06-46ff-bae6-6ced09fb6ca4","leftValue":"={{ $json._original.UF_CRM_LEAD_ANALYSIS }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"8ee34270-f834-401c-9cd9-83d920a86df9","leftValue":"={{ $('Webhook (Lead Timeline)').item.json.query.force != 'Y' }}","rightValue":"=","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-6864,2032],"id":"7ec174e4-4081-43c4-997d-d8ddde97cdb1","name":"Se o Lead jÃ¡ tiver anÃ¡lise"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eeeab0b2-44f3-4838-9a0c-30110ac166f2","leftValue":"={{ $('Filtra por Ã¡udio').item.json.messages.length.toBoolean() }}","rightValue":"True","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{"ignoreCase":false}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-5200,3008],"id":"601c9e9e-b2d1-415b-8bf2-abb5f38ee3b2","name":"Verifica se tem audio nas mensagens","alwaysOutputData":false},{"parameters":{"method":"POST","url":"={{ $env.BITRIX_URL }}crm.lead.update","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"id\": \"{{ $('Busca dados do Lead').item.json.id }}\",\n    \"fields\": {\n        \"UF_CRM_LEAD_ANALYSIS_DATE\": \"{{ (() => { const d = new Date(); const pad = n => String(n).padStart(2,'0'); const tz = -d.getTimezoneOffset(); const sign = tz >= 0 ? '+' : '-'; const h = pad(Math.floor(Math.abs(tz) / 60)); const m = pad(Math.abs(tz) % 60); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}${sign}${h}:${m}`; })() }}\"\n    }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-6576,1568],"id":"2da60f4f-67a6-4df8-8aca-6bccc31a6bfd","name":"Altera da da Ãºltima AnÃ¡lise de Lead","retryOnFail":true},{"parameters":{"jsCode":"const stories = $('Ordena por data de criaÃ§Ã£o').first().json.sortedStories;\n\nlet compressedHistory = [];\n\nfor (const story of stories) {\n  const item = story.json;\n  const createdAt = item.createdAt || item.CREATED_TIME || item.CREATED;\n  let entry = '';\n\n  switch (item.historyName) {\n    case 'whatsAppMessage':\n      const sender = item.fromMe ? 'Vendedor' : 'Lead';\n      let messageContent = item.body || item.caption || '';\n      if (item.transcription) {\n        messageContent += ` [TranscriÃ§Ã£o do Ãudio: ${item.transcription}]`;\n      }\n      entry = `[${sender} (WhatsApp) - ${createdAt}]: ${messageContent}`;\n      break;\n\n    case 'activity':\n      let activityDetails = `Assunto: ${item.subject}. Status: ${item.isCompleted ? 'ConcluÃ­da' : 'Pendente'}.`;\n      if (item.callDetails && item.callDetails.transcription) {\n        activityDetails += ` TranscriÃ§Ã£o: ${item.callDetails.transcription}`;\n      }\n      entry = `[ATIVIDADE (CRM) - ${createdAt}]: ${activityDetails}`;\n      break;\n\n    case 'comment':\n      entry = `[COMENTÃRIO (CRM) - ${createdAt}]: ${item.comment}`;\n      break;\n\n    case 'stageHistory':\n      entry = `[MUDANÃ‡A DE ETAPA (CRM) - ${createdAt}]: Status do Lead alterado para \"${item.status}\".`;\n      break;\n      \n    default:\n      continue;\n  }\n  \n  compressedHistory.push(entry);\n}\n\nreturn [{\n  json: {\n    compressedHistory: compressedHistory.join('\\n---\\n')\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3568,2272],"id":"0879117a-8cfa-4a68-bf60-125882d169e0","name":"Transforma em texto e comprime"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"claude-sonnet-4-20250514","cachedResultName":"Claude 4 Sonnet"},"options":{"maxTokensToSample":5000}},"type":"@n8n/n8n-nodes-langchain.lmChatAnthropic","typeVersion":1.3,"position":[-3344,2240],"id":"f4b7c61c-25cf-491e-ab35-fecbef8ca857","name":"Anthropic Chat Model","credentials":{"anthropicApi":{"id":"lyfyzPeMl3RhkeP5","name":"Anthropic account"}}},{"parameters":{"promptType":"define","text":"=ğŸš€ VocÃª Ã© um Diretor de Vendas SÃªnior. Sua missÃ£o Ã© criar uma AnÃ¡lise CrÃ­tica de Lead no ramo imobiliÃ¡rio para a Apresenta.me. \nObjetivo: produzir um BRIEFING ESTRATÃ‰GICO DE CONVERSÃƒO para a reuniÃ£o marcada, com insights acionÃ¡veis, plano de ataque, scripts prontos e priorizaÃ§Ã£o de prÃ³ximos passos.\nâš ï¸ Use exclusivamente os dados do JSON de histÃ³rico. NÃƒO invente nada.\n\nOBS: Esta anÃ¡lise serÃ¡ feita sempre que uma reuniÃ£o de vendas for agendada para o Lead em questÃ£o.\n\n[REGRAS FIXAS â€” NÃƒO ALTERAR]\n- Idioma: PT-BR\n- NÃƒO altere links/IDs a seguir.\n- Nome do Lead: \"{{ $('Busca dados do Lead').first().json.name }}\"\n- Id do Lead (link CRM): https://crm.apresenta.me/crm/lead/details/{{ $('Busca dados do Lead').first().json.id }}/\n- Fonte ÃšNICA de verdade: {{ $json.compressedHistory }}  (HistÃ³rico de InteraÃ§Ãµes)\n- Identifique dentro das mensagens quem Ã© o lead; ignore suposiÃ§Ãµes sem evidÃªncia.\n\n[ENTRADA]\n- HistÃ³rico de InteraÃ§Ãµes (JSON comprimido): {{ $json.compressedHistory }}\n\n[MODO DE ANÃLISE â€” COMO PENSAR]\n1) Rigor de evidÃªncias: justifique conclusÃµes com trechos do histÃ³rico em aspas curtas â€œ...â€. \n2) Temporalidade: monte uma linha do tempo objetiva (datas/horas â†’ evento â†’ evidÃªncia).\n3) Enquadramento Comercial: extraia sinais para BANT, MEDDICC e SPICED (preencha sÃ³ o que tiver evidÃªncia).\n4) Ceticismo & Motivadores: detecte tom (urgÃªncia/risco/polÃ­tica interna) e motivadores (â³ tempo, ğŸ’¸ receita, ğŸ›¡ï¸ seguranÃ§a, ğŸ—‚ï¸ organizaÃ§Ã£o).\n5) ConcorrÃªncia: GRIFE qualquer menÃ§Ã£o a soluÃ§Ãµes atuais/concorrentes e descreva implicaÃ§Ãµes.\n6) SaÃ­da curta e letal: bullets, clareza e aÃ§Ãµes concretas. Use emojis para nÃ­veis/estados âœ…âš ï¸â›”ï¸ğŸ”¥.\n\n[FORMATO DA SAÃDA â€” TXT/Markdown SIMPLES. SIGA Ã€ RISCA]\n\n0) CABEÃ‡ALHO RÃPIDO\n- ğŸ‘¤ Lead: {{ $('Busca dados do Lead').first().json.name }}\n- ğŸ”— CRM: https://crm.apresenta.me/crm/lead/details/{{ $('Busca dados do Lead').first().json.id }}/\n- ğŸ§­ Resumo em 2 linhas: (sÃ­ntese objetiva da dor + objetivo do lead, evidenciada por â€œ...â€)\n\n1) LINHA DO TEMPO ESSENCIAL â±ï¸\n(Ordem cronolÃ³gica. Se houver data/hora, use DD/MM HH:MM)\n- DD/MM HH:MM â€” Evento â†’ evidÃªncia â€œ...â€\n- DD/MM HH:MM â€” Evento â†’ evidÃªncia â€œ...â€\n- DD/MM HH:MM â€” Evento â†’ evidÃªncia â€œ...â€\n\n2) CONTEXTO & NECESSIDADES ğŸ”\n- Dores principais (ğŸ”¥) â€” cada bullet com citaÃ§Ã£o:\n  â€¢ â€œ...â€\n  â€¢ â€œ...â€\n- Perfil aparente (porte, cargo, maturidade tÃ©cnica): â€œ...â€\n- SoluÃ§Ãµes/Concorrentes citados ğŸ¥Š (GRIFAR):\n  â€¢ __â€œ...â€__ â†’ implicaÃ§Ã£o/risco â€œ...â€\n  â€¢ __â€œ...â€__ â†’ implicaÃ§Ã£o/risco â€œ...â€\n\n3) PERSONA & NÃVEL DE CETICISMO ğŸ¤”\n- Persona dominante (ex.: Decisor ROI ğŸ‘‘ / TÃ©cnico ğŸ‘¨â€ğŸ’» / Gestor ğŸ—‚ï¸): evidÃªncia â€œ...â€\n- Ceticismo: Baixo/Moderado/Alto (ğŸŸ¢/ğŸŸ¡/ğŸ”´) â€” por quÃª? â€œ...â€\n- Motivadores chave: â³ / ğŸ’¸ / ğŸ›¡ï¸ / ğŸ—‚ï¸ â€” evidÃªncias â€œ...â€\n- Sinais de urgÃªncia/prazo crÃ­tico: â€œ...â€\n\n4) SCORE DE FECHAMENTO ğŸ’°\n- Probabilidade: Baixa / MÃ©dia / Alta + Nota (0â€“10) + Emoji (ğŸ§Š/ğŸŒ¤ï¸/ğŸ”¥)\n- Sinais positivos âœ… (bullets com â€œ...â€):\n  â€¢ â€œ...â€\n  â€¢ â€œ...â€\n- Riscos/Entraves âš ï¸ (bullets com â€œ...â€):\n  â€¢ â€œ...â€\n  â€¢ â€œ...â€\n- Trigger de avanÃ§o sugerido (o que destrava o sim): â€œ...â€\n\n5) OBJEÃ‡Ã•ES & LACUNAS ğŸš§\n- ObjeÃ§Ãµes explÃ­citas: â€œ...â€ â†’ como tratar â€œ...â€\n- ObjeÃ§Ãµes implÃ­citas (entrelinhas): â€œ...â€ â†’ como tratar â€œ...â€\n- Dados faltantes (perguntar na call) â€” 3â€“7 perguntas objetivas:\n  1) â€œ...?â€\n  2) â€œ...?â€\n  3) â€œ...?â€\n  (Foque em Budget, Authority, DecisÃ£o, Prazos, IntegraÃ§Ãµes, KPIs.)\n\n6) ENQUADRAMENTOS COMERCIAIS (preencher sÃ³ com evidÃªncia) ğŸ§©\n- BANT\n  â€¢ Budget (ğŸ’µ): â€œ...â€ ou â€œsem dadosâ€\n  â€¢ Authority (ğŸ‘‘): â€œ...â€\n  â€¢ Need (ğŸ”¥): â€œ...â€\n  â€¢ Timeline (ğŸ—“ï¸): â€œ...â€\n- MEDDICC\n  â€¢ Metrics: â€œ...â€\n  â€¢ Economic Buyer: â€œ...â€\n  â€¢ Decision Criteria: â€œ...â€\n  â€¢ Decision Process: â€œ...â€\n  â€¢ Identify Pain: â€œ...â€\n  â€¢ Champion: â€œ...â€\n  â€¢ Competition: â€œ...â€\n- SPICED\n  â€¢ Situation: â€œ...â€\n  â€¢ Pain: â€œ...â€\n  â€¢ Impact: â€œ...â€\n  â€¢ Critical Event: â€œ...â€\n  â€¢ Decision: â€œ...â€\n\n7) MAPA DE VALOR (Dor â†’ Prova â†’ Recurso) ğŸ¯\n- Estruture 3â€“6 linhas com evidÃªncia real do histÃ³rico:\n  â€¢ Dor/Objetivo: â€œ...â€\n    â†’ Prova/Resultado que importa: â€œ...â€\n    â†’ Recurso Apresenta.me: CRM + Apre.Chat / ApBank / ERP / Vistoria / Ass. EletrÃ´nica / PainÃ©is\n  â€¢ Dor/Objetivo: â€œ...â€\n    â†’ Prova/Resultado: â€œ...â€\n    â†’ Recurso: â€œ...â€\n\n8) PLANO DE AÃ‡ÃƒO DE 7 DIAS ğŸ”¥\n- D0 (hoje): aÃ§Ãµes tÃ¡ticas (3â€“5 bullets) â€” objetivo + critÃ©rio de sucesso.\n- D1â€“D2: â€œ...â€\n- D3â€“D5: â€œ...â€\n- D6â€“D7: â€œ...â€\n(Exemplos de critÃ©rios: resposta do decisor; confirmar critÃ©rios de decisÃ£o; agendar tÃ©cnica; enviar proposta ancorada; validar prazo jurÃ­dico/financeiro.)\n\n9) TÃTICAS DE REUNIÃƒO (What / Show / Send) ğŸ§°\n- What to SAY (descoberta de alto impacto â€” 5â€“7 perguntas alinhadas Ã s lacunas):\n  â€¢ â€œ...?â€\n  â€¢ â€œ...?â€\n- What to SHOW (demonstraÃ§Ãµes-alvo com prova social/resultado):\n  â€¢ â€œ...â€ (case/indicador relevante)\n- What to SEND (pÃ³s-call imediato):\n  â€¢ Resumo executivo + prÃ³ximos passos + prazo acordado.\n\n10) SCRIPTS DE PRÃ“XIMO CONTATO ğŸ“©\n- WhatsApp (curto, direto, com valor e CTA):\n  â€¢ â€œ[nome], pelo seu ponto sobre â€˜â€¦â€™, amanhÃ£ te mostro como resolvemos isso em X min. Confirma melhor horÃ¡rio entre [opÃ§Ã£o1] e [opÃ§Ã£o2]?â€\n- E-mail (executivo, 5 linhas, com Ã¢ncora de resultado):\n  â€¢ Assunto: â€œ[resultado] em [prazo] â€” passo-a-passoâ€\n  â€¢ Corpo: 1) referÃªncia Ã  dor â€œ...â€; 2) prova/indicador â€œ...â€; 3) proposta de prÃ³ximo passo â€œ...â€; 4) duas janelas de horÃ¡rio; 5) CTA claro.\n\n11) Ã‚NCORAS DE VALOR / ROI ğŸ’¸\n- Indicadores que mais importam ao lead (do histÃ³rico): â€œ...â€\n- Micro-business case (com os dados que EXISTEM):\n  â€¢ Ex.: â€œReduÃ§Ã£o de TMA de â€˜â€¦â€™ para â€˜â€¦â€™ â†’ ganho de â€˜â€¦â€™ horas/mÃªs (â³) e economia estimada de R$ â€˜â€¦â€™/mÃªs.â€\n\n12) RISCOS COMPETITIVOS & CONTRA-ATAQUES ğŸ¥Š\n- Risco/Concorrente (GRIFADO): __â€œ...â€__ \n  â€¢ Gap percebido: â€œ...â€\n  â€¢ Contra-ataque: â€œ...â€ (prova, demo, case, feature especÃ­fica)\n- Risco polÃ­tico interno:\n  â€¢ â€œ...â€ â†’ aÃ§Ã£o: envolver [decisor] / redefinir sucesso / alinhar critÃ©rio tÃ©cnico.\n\n13) FIT COM ICP (AdequaÃ§Ã£o) ğŸ§­\n- Fit ICP: Alto/MÃ©dio/Baixo (ğŸŸ¢/ğŸŸ¡/ğŸ”´) â€” por quÃª? â€œ...â€\n- Sinais de desvio (se houver): â€œ...â€\n- RecomendaÃ§Ã£o: â€œprosseguir agressivoâ€ / â€œmanter em nutriÃ§Ã£oâ€ / â€œdesqualificar educadamenteâ€.\n\n14) PONTES COM APRE.CHAT (o que mostrar) ğŸ’¬\n- Se dor for atendimento/retorno:\n  â€¢ Mostrar: distribuiÃ§Ã£o automÃ¡tica, follow-ups, histÃ³rico Ãºnico, mÃ©tricas de resposta.\n- Se dor for controle/financeiro:\n  â€¢ Mostrar: ApBank, conciliaÃ§Ã£o, repasses, inadimplÃªncia com alertas.\n- Se dor for operaÃ§Ã£o:\n  â€¢ Mostrar: ERP, Vistoria, Assinatura EletrÃ´nica, PainÃ©is.\n\n15) CHECKLIST PRÃ‰-CALL âœ…\n- Confirmar decisores presentes? [ ] \n- CritÃ©rios de decisÃ£o mapeados? [ ]\n- Timeline acordada? [ ]\n- PrÃ³ximo passo definido (com data)? [ ]\n- Material de prova separado (case/indicador)? [ ]\n\n[RESTRIÃ‡Ã•ES FINAIS]\n- NÃ£o extrapole alÃ©m do que o histÃ³rico comprova.\n- Sempre cite â€œ...â€ para justificar afirmaÃ§Ãµes importantes.\n- Use emojis para sinalizar nÃ­veis e prioridades (ex.: ğŸ”¥ prioridade alta, âš ï¸ risco, âœ… confirmado).\n- Mantenha o texto enxuto, orientado a aÃ§Ã£o e pronto para colar no CRM.\n\n[SOBRE A APRESENTA.ME â€” RESUMO PARA CONTEXTO NA CONVERSA]\n- Plataforma SaaS para imobiliÃ¡rias (pequenas e mÃ©dias) focada em eficiÃªncia e escala sem ampliar equipe.\n- ERP completo + CRM com IA e WhatsApp (Apre.Chat) + ApBank + Vistoria + Assinatura EletrÃ´nica + PainÃ©is.\n- BenefÃ­cios-chave: automaÃ§Ã£o total de locaÃ§Ã£o, funil de vendas organizado, alertas, histÃ³rico centralizado, indicadores de performance, suporte humano via WhatsApp, site com SEO.\n- Apre.Chat: integraÃ§Ã£o nativa WhatsApp; automaÃ§Ãµes; distribuiÃ§Ã£o de atendimentos; mÃºltiplos atendentes; histÃ³rico no CRM; assinaturas em mensagens (primeira linha com ASSINATURA).\n\n(FIM)\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2,"position":[-3376,2016],"id":"bce78d02-0a88-479f-981c-b99cdffc59f7","name":"AnÃ¡lise da Call de Lead","retryOnFail":true,"maxTries":5,"waitBetweenTries":5000},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a49d6896-c524-4dfe-8579-457dfbd9a51c","leftValue":"={{ $json.messages.data.length.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-5888,2512],"id":"af57dcb7-137b-4bb3-ab27-d6a758f47388","name":"If"},{"parameters":{"jsCode":"const whatsapp = $input.first().json.whatsapp || '';\n\nreturn {\n  whatsapp: whatsapp.replace(/\\D/g, '') \n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6640,2432],"id":"250375b0-80e8-420b-a4d7-8cd37949c7c0","name":"Remove caracteres diferentes de numero e espaÃ§o do whatsapp do lead"},{"parameters":{"fromEmail":"Apresenta.me <no-reply@apresenta.me>","toEmail":"joao.rorato@apresenta.me, larissa.simplicio@apresenta.me, karina.consoli@apresenta.me, maicon@apresenta.me","subject":"=ğŸ’— AnÃ¡lise de Lead | {{ $('Busca dados do Lead').first().json.last_activity_by_details.name_full }} | {{ $('Busca dados do Lead').first().json.title }}, {{ $('Busca dados do Lead').first().json.company_title }}","html":"={{ $json.message.content }}","options":{"appendAttribution":false,"ccEmail":"={{ $('Busca dados do Lead').first().json.user_seller_details._original.EMAIL }}, {{ $('Busca dados do Lead').first().json.user_sdr_details._original.EMAIL }}"}},"type":"n8n-nodes-base.emailSend","typeVersion":2.1,"position":[-2096,2272],"id":"4fa4a84c-64a0-4ce7-b80c-a4529d01e25e","name":"Envia anÃ¡lise por e-mail","webhookId":"b8842732-9025-4c04-924e-06cfbb051a19","notesInFlow":false,"credentials":{"smtp":{"id":"aeF6k2hPp8cZPPHg","name":"SMTP account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-5-mini","mode":"list","cachedResultName":"GPT-5-MINI"},"messages":{"values":[{"content":"=VocÃª Ã© um ASSISTENTE ESPECIALISTA em formataÃ§Ã£o de relatÃ³rios de anÃ¡lise de leads para aplicaÃ§Ãµes imobiliÃ¡rias, focado em e-mails profissionais otimizados para o Gmail, representando o time da Apresenta.me. Sua missÃ£o Ã© transformar uma anÃ¡lise/relatÃ³rio de lead (conteÃºdo bruto da call de qualificaÃ§Ã£o/demonstraÃ§Ã£o) em HTML de e-mail: bem estruturado, elegante, visualmente atraente e legÃ­vel em qualquer dispositivo.\n\nINSTRUÃ‡Ã•ES PRINCIPAIS (NÃƒO IGNORAR)\n- NUNCA ALTERE, RESUMA OU INTERPRETE o conteÃºdo do relatÃ³rio original do lead.\n- FORMATE COMO E-MAIL (GMAIL) usando SOMENTE HTML com CSS inline (cores, tabelas, boxes).\n- MANTENHA A ORDEM ORIGINAL das seÃ§Ãµes, tÃ­tulos e subtÃ­tulos, sem reordenar ou agrupar blocos.\n- USE NEGRITO para tÃ­tulos e informaÃ§Ãµes importantes.\n- USE ITÃLICO apenas para Ãªnfases pontuais ou na assinatura.\n- ADICIONE EMOJIS de forma moderada para sinalizar aÃ§Ãµes, status e destaques (ex.: âœ…, ğŸ¯, ğŸ”—, âš ï¸, ğŸ“).\n- CRIE BOXES com fundo colorido para destaques (cores compatÃ­veis com Gmail).\n- UTILIZE LISTAS (comuns, numeradas ou com emojis) para organizar informaÃ§Ãµes.\n- CONVERTA todas as quebras de linha â€œ\\nâ€ para <br> ou separe em <p> quando necessÃ¡rio.\n- APRESENTE LINKS apenas como hiperlinks clicÃ¡veis, antecedidos por ğŸ”— (ocultar a URL).\n- NUNCA OMITA SEÃ‡Ã•ES, mesmo que o conteÃºdo pareÃ§a repetido, incompleto ou vazio.\n- MANTENHA TODOS OS TÃTULOS visÃ­veis, mesmo que nÃ£o tenham conteÃºdo associado.\n- FINALIZE com a assinatura padrÃ£o: _RelatÃ³rio pela <b>Sofia</b>, assistente da Apresenta.me_\n- REVISE ortografia, gramÃ¡tica e legibilidade em desktop e mobile.\n- A SAÃDA DEVE SER SOMENTE O HTML FINAL, sem blocos de cÃ³digo e sem tags externas <html>/<head>/<body>, nem comentÃ¡rios.\n\nCADEIA DE RACIOCÃNIO (COMO PROCEDER)\n1) ENTENDA o objetivo: transformar a anÃ¡lise da call em um e-mail 100% fiel e visualmente otimizado.\n2) IDENTIFIQUE todas as seÃ§Ãµes do relatÃ³rio e seus conteÃºdos, sem ignorar nenhuma.\n3) SEPARE as informaÃ§Ãµes em blocos organizados com tÃ­tulos claros e destacados em negrito.\n4) DESTAQUE informaÃ§Ãµes cruciais utilizando boxes com fundos coloridos e emojis apropriados.\n5) CONVERTA â€œ\\nâ€ para <br> em blocos de texto e use <p> para parÃ¡grafos completos.\n6) INSIRA links como hiperlinks clicÃ¡veis precedidos por ğŸ”—, ocultando URLs completas.\n7) GARANTA que todas as seÃ§Ãµes do texto original estejam presentes no HTML final.\n8) NUNCA REORDENE OU REAGRUPE SEÃ‡Ã•ES. Preserve a ordem original integralmente.\n9) FINALIZE com a assinatura profissional obrigatÃ³ria e revise ortografia e gramÃ¡tica.\n\nO QUE NÃƒO FAZER\n- NUNCA modificar, resumir, interpretar ou omitir qualquer informaÃ§Ã£o do relatÃ³rio original.\n- NÃƒO inserir comentÃ¡rios, opiniÃµes ou conteÃºdo adicional.\n- NÃƒO deixar links sem serem clicÃ¡veis ou sem o emoji ğŸ”—.\n- NÃƒO usar cores excessivas ou visuais que prejudiquem a leitura.\n- NÃƒO omitir seÃ§Ãµes vazias ou repetidas; mantenha os tÃ­tulos mesmo sem conteÃºdo.\n- NÃƒO usar sublinhado (exceto em links).\n- NÃƒO quebrar o HTML nem a estrutura das seÃ§Ãµes.\n- NÃƒO formatar em outro padrÃ£o que nÃ£o seja HTML inline compatÃ­vel com Gmail.\n- NÃƒO esquecer a assinatura padrÃ£o com a Sofia.\n\nENTRADAS (INPUT)\n- Dados do lead/empresa (opcional).\n- RELATÃ“RIO_BRUTO: texto completo da anÃ¡lise da call do lead, com seÃ§Ãµes e ordem originais (pode conter â€œ\\nâ€).\n\nDADOS DE ENTRADA:\n{{ $('AnÃ¡lise da Call de Lead').first().json.output }}\n\nSAÃDA (OUTPUT)\n- Somente HTML inline, pronto para colar no Gmail.\n- Manter a ordem das seÃ§Ãµes e tÃ­tulos do RELATÃ“RIO_BRUTO.\n- Preservar todo o conteÃºdo textual, apenas formatando visualmente.\n\nREGRAS DE ESTILO (HTML INLINE)\n- Fonte: Helvetica, Arial, sans-serif; line-height: 1.6; color: #333.\n- Largura fluida com margens/paddings inline para boa leitura em mobile e desktop.\n- TÃ­tulos (H2/H3 simulados): cor #1a73e8; negrito.\n- Boxes de destaque (usar quando fizer sentido):\n  â€¢ InformaÃ§Ã£o: background-color:#E8F0FE; border-radius:6px; padding:12px 14px;\n  â€¢ Sucesso/OK: background-color:#E6F4EA; border-radius:6px; padding:12px 14px;\n  â€¢ Aviso: background-color:#FFF4E5; border-radius:6px; padding:12px 14px;\n  â€¢ Neutro: background-color:#F1F3F4; border-radius:6px; padding:12px 14px;\n- Tabelas (se necessÃ¡rias): border-collapse: collapse; padding interno; cabeÃ§alho em negrito.\n- Emojis: usar com moderaÃ§Ã£o, apenas para guiar leitura (âœ…, ğŸ¯, ğŸ”—, âš ï¸, ğŸ“).\n\nEXEMPLO DE ESTRUTURA (NÃƒO MUDA A ORDEM DO CONTEÃšDO ORIGINAL â€” APENAS FORMATA)\n[HEADER COM LOGO]\n<img src=\"https://s.apresenta.me/comercial/automations/apresentame-300.png\" alt=\"Apresenta.me ~ O Futuro das ImobiliÃ¡rias\" width=\"300\" style=\"display:inline-block;\">\n\n[TÃTULO PRINCIPAL]\n<h2 style=\"color:#1a73e8; font-family: Helvetica, Arial, sans-serif;\">ğŸ¯ AnÃ¡lise de Lead | Apresenta.me | NOME DO LEAD ~ ASSUNTO DA CALL</h2>\n\n[SEÃ‡Ã•ES DO RELATÃ“RIO_BRUTO â€” repetir a sequÃªncia exata do input]\n<strong style=\"font-family: Helvetica, Arial, sans-serif;\">TÃ­tulo da SeÃ§Ã£o</strong>\n<p style=\"margin:8px 0; font-family: Helvetica, Arial, sans-serif;\">ConteÃºdo literal da seÃ§Ã£o. Converter \\n em <br> quando necessÃ¡rio.<br>Sem reescrever conteÃºdo.</p>\n\n[LINKS]\nğŸ”— <a href=\"URL\" style=\"color:#1a73e8; text-decoration:underline;\">Texto do link</a>\n\n[BOX DE DESTAQUE â€” opcional quando o texto exigir]\n<div style=\"background-color:#E8F0FE; border-radius:6px; padding:12px 14px; font-family: Helvetica, Arial, sans-serif;\">âœ… InformaÃ§Ã£o crÃ­tica exatamente como no relatÃ³rio.</div>\n\n[ASSINATURA OBRIGATÃ“RIA]\n<p style=\"font-style:italic; margin-top: 30px; border-top:1px solid #ddd; padding-top:10px; font-family: Helvetica, Arial, sans-serif;\">RelatÃ³rio pela <b>Sofia</b>, assistente da Apresenta.me</p>\n\nINSTRUÃ‡ÃƒO FINAL\n- A saÃ­da deve ser SOMENTE o HTML inline, pronto para colagem no Gmail, sem blocos de cÃ³digo, sem comentÃ¡rios e sem tags externas (<html>/<head>/<body>). Manter 100% do conteÃºdo original do RELATÃ“RIO_BRUTO e a mesma ordem das seÃ§Ãµes.","role":"system"},{"content":"={{ $('AnÃ¡lise da Call de Lead').first().json.output }}"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-2416,2272],"id":"4d019612-967a-473a-b71b-c8a7fb4f2fe3","name":"Cria html da analise de Lead","retryOnFail":true,"credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}}],"connections":{"Webhook (Lead Timeline)":{"main":[[{"node":"Salva Log no Lead","type":"main","index":0}]]},"Mapear dados do CRM":{"main":[[{"node":"Se tiver call na timeline","type":"main","index":0}]]},"Valida parÃ¢metros":{"main":[[{"node":"Busca dados do Lead","type":"main","index":0}]]},"Buscar dados da Timeline do Lead":{"main":[[{"node":"Filtra por call","type":"main","index":0}]]},"Filtra por Ã¡udio":{"main":[[{"node":"Normaliza dados","type":"main","index":0}]]},"Filtra por call":{"main":[[{"node":"Mapear dados do CRM","type":"main","index":0}]]},"Junta as transcriÃ§Ãµes com a timeline":{"main":[[{"node":"Junta mensagens com histÃ³rico da timeline do Lead","type":"main","index":0}]]},"Junta as transcriÃ§Ãµes com as mensagens":{"main":[[{"node":"Junta mensagens com histÃ³rico da timeline do Lead","type":"main","index":1}]]},"Busca dados do Lead":{"main":[[{"node":"Se o Lead jÃ¡ tiver anÃ¡lise","type":"main","index":0}]]},"Busca Mensagens do lead no Apre.Chat":{"main":[[{"node":"If","type":"main","index":0}]]},"Junta mensagens com histÃ³rico da timeline do Lead":{"main":[[{"node":"Ordena por data de criaÃ§Ã£o","type":"main","index":0}]]},"Transcrever calls":{"main":[[{"node":"Junta as transcriÃ§Ãµes com a timeline","type":"main","index":0}]]},"Mapear url das calls":{"main":[[{"node":"Transcrever calls","type":"main","index":0}]]},"Mapear url dos Ã¡udios":{"main":[[{"node":"Transcrever audios","type":"main","index":0}]]},"Transcrever audios":{"main":[[{"node":"Junta as transcriÃ§Ãµes com as mensagens","type":"main","index":0}]]},"Verifica se o Lead tem WhatsApp cadastrado":{"main":[[{"node":"Busca Mensagens do lead no Apre.Chat","type":"main","index":0}]]},"Ordena por data de criaÃ§Ã£o":{"main":[[{"node":"Transforma em texto e comprime","type":"main","index":0}]]},"Normaliza dados":{"main":[[{"node":"Verifica se tem audio nas mensagens","type":"main","index":0}]]},"Salva Log no Lead":{"main":[[{"node":"Valida parÃ¢metros","type":"main","index":0}]]},"âœï¸ Altera dados do Lead":{"main":[[{"node":"Salva comentÃ¡rio com AnÃ¡lise no Lead","type":"main","index":0}]]},"Ajusta informaÃ§Ãµes":{"main":[[{"node":"âœï¸ Altera dados do Lead","type":"main","index":0}]]},"Se tiver call na timeline":{"main":[[{"node":"Mapear url das calls","type":"main","index":0}],[{"node":"Junta mensagens com histÃ³rico da timeline do Lead","type":"main","index":0}]]},"Se o Lead jÃ¡ tiver anÃ¡lise":{"main":[[{"node":"Altera da da Ãºltima AnÃ¡lise de Lead","type":"main","index":0}],[{"node":"Buscar dados da Timeline do Lead","type":"main","index":0},{"node":"Remove caracteres diferentes de numero e espaÃ§o do whatsapp do lead","type":"main","index":0}]]},"Verifica se tem audio nas mensagens":{"main":[[{"node":"Mapear url dos Ã¡udios","type":"main","index":0}],[{"node":"Junta mensagens com histÃ³rico da timeline do Lead","type":"main","index":1}]]},"Transforma em texto e comprime":{"main":[[{"node":"AnÃ¡lise da Call de Lead","type":"main","index":0}]]},"Anthropic Chat Model":{"ai_languageModel":[[{"node":"AnÃ¡lise da Call de Lead","type":"ai_languageModel","index":0}]]},"AnÃ¡lise da Call de Lead":{"main":[[{"node":"Ajusta informaÃ§Ãµes","type":"main","index":0}]]},"If":{"main":[[{"node":"Filtra por Ã¡udio","type":"main","index":0}]]},"Remove caracteres diferentes de numero e espaÃ§o do whatsapp do lead":{"main":[[{"node":"Verifica se o Lead tem WhatsApp cadastrado","type":"main","index":0}]]},"Salva comentÃ¡rio com AnÃ¡lise no Lead":{"main":[[{"node":"Cria html da analise de Lead","type":"main","index":0}]]},"Cria html da analise de Lead":{"main":[[{"node":"Envia anÃ¡lise por e-mail","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook (Lead Timeline)":[{"json":{"headers":{"host":"n8n.apresenta.me","x-real-ip":"104.23.209.47","x-real-port":"16358","x-forwarded-for":"3.217.33.54, 104.23.209.47","x-forwarded-proto":"http","x-forwarded-host":"n8n.apresenta.me","x-forwarded-port":"80","remote-host":"104.23.209.47","connection":"close","content-length":"308","user-agent":"Bitrix24 Webhook Engine","accept-encoding":"gzip, br","content-type":"application/x-www-form-urlencoded","cf-ray":"9a0a52079f4ae76c-IAD","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"3.217.33.54","cf-ipcountry":"US","cf-visitor":"{\"scheme\":\"https\"}"},"params":{},"query":{"leadId":"400","force":"Y"},"body":{"document_id[0]":"crm","document_id[1]":"CCrmDocumentLead","document_id[2]":"LEAD_400","auth[domain]":"crm.apresenta.me","auth[client_endpoint]":"https://crm.apresenta.me/rest/","auth[server_endpoint]":"https://oauth.bitrix.info/rest/","auth[member_id]":"e0399350f7ed44f078e2b21954de695d"},"webhookUrl":"https://n8n.apresenta.me/webhook/lead-timeline","executionMode":"production"}}]},"versionId":"449fa743-4309-4a45-8e34-84b4d51ea2c0","triggerCount":1,"shared":[{"updatedAt":"2025-08-16T14:49:36.984Z","createdAt":"2025-08-16T14:49:36.984Z","role":"workflow:owner","workflowId":"Mf8XNJsuIL3652pf","projectId":"4ToGMYJEWvvDSbcz"}],"tags":[]}