{"updatedAt":"2025-11-25T20:57:58.000Z","createdAt":"2025-11-04T18:47:16.651Z","id":"dDaZdsSmHxktrhjc","name":"üó£Ô∏è Apr.SDR IA","active":true,"isArchived":false,"nodes":[{"parameters":{"options":{"dimensions":1536}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[2112,928],"id":"a7f10ff1-4967-4ed0-8aa7-f99ee2a6cdf0","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"options":{"systemMessage":"=## PERFIL\n**Agente:** {{ $('Seta perfil').item.json.agentName }} ({{ $('Seta perfil').item.json.role }}) | **Empresa:** {{ $('Seta perfil').item.json.companyName }}\n**Lang:** {{ $('Seta perfil').item.json.language }} | **Tom:** {{ $('Seta perfil').item.json.tone }}\n**Conduta:** {{ $('Seta perfil').item.json.conduct }}\n**Intro:** {{ $('Seta perfil').item.json.initialMessage }}\n\n## REGRAS CR√çTICAS (Zero Alucina√ß√£o)\n1. **Consulta KB:** Para QUALQUER d√∫vida, consulte a `Base de Conhecimento`.\n   - *Retorno Vazio?* -> Responda EXATAMENTE: \"Ainda n√£o tenho acesso a essa informa√ß√£o na base de conhecimento.\"\n2. **Integridade:** Jamais considere um est√°gio como conclu√≠do sem executar a instru√ß√£o final (`finalInstructions`).\n\n## DADOS\nEst√°gios atual: {{ JSON.stringify($('Retorna est√°gio atual').item.json) }}\nLegenda: {{ JSON.stringify($('Retorna legenda dos est√°gios').item.json.legend) }}","returnIntermediateSteps":true}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2,"position":[1968,368],"id":"e4c2cdb8-41e6-4644-9ee1-b4299d946e0c","name":"AI Agent","retryOnFail":false},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"=## TOOL: Busca informa√ß√µes do banco de dados\n**Objetivo:** Consultar fatos oficiais da Apresenta.me (produtos, funcionalidades, processos).\n**Descri√ß√£o** Base de conhecimento da Apresenta.me\n\n## RIGOROSO PARA CARALHO\n\n**SEMPRE CHAME ESSSA TOOL QUANDO:**\n- O usu√°rio tiver QUALQUER D√öVIDA, REPITO, QUALQUER D√öVIDA.","tableName":"n8","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[2112,768],"id":"61be998c-9c3d-440c-b661-389b0c721ab7","name":"Busca informa√ß√µes do banco de dados","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"return {chatInput: $input.first().json.body.message}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-784,368],"id":"9ce388d5-9cd4-4686-9556-333b2dcd797b","name":"Retorna message"},{"parameters":{"method":"POST","url":"=https://api.sandbox.apre.chat/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').item.json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('AI Agent').item.json.output }}"},{"name":"number","value":"={{ $('Webhook').item.json.body.contact.number }}"},{"name":"addUserName","value":"={{ $('Seta perfil').item.json.agentName }}"},{"name":"whatsappId","value":"={{ $('Webhook').item.json.body.whatsappId }}"},{"name":"messageRepliedId","value":"={{ $('Webhook').item.json.body.messageId }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2320,368],"id":"51055a9d-03f0-4191-a0ba-476cb7be2d68","name":"HTTP Request"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini-2024-07-18","mode":"list","cachedResultName":"gpt-4o-mini-2024-07-18"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1744,640],"id":"ad961793-d5f5-42d4-821c-94265a99089e","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"httpMethod":"POST","path":"7223c6af-f595-4bc2-b84c-602b8900cd08","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-960,368],"id":"265dfdd6-e7e3-4cab-8841-8fec8945c49f","name":"Webhook","webhookId":"7223c6af-f595-4bc2-b84c-602b8900cd08"},{"parameters":{"description":"=## TOOL: Atualizar Par√¢metros\n**Objetivo:** Persistir valores de vari√°veis (novos ou corre√ß√µes).\n**Descri√ß√£o:** Atualiza√ß√£o/inser√ß√£o de valores de variaveis existentes.\n\n**SEMPRE CHAME ESSA TOOL QUANDO:**\n- A mensagem do usu√°rio responder a informa√ß√£o de alguma vari√°vel.\n- O usu√°rio deseja corrigir/atualizar uma informa√ß√£o dada posteriormente\n\n**EXECUTAR ESSA TOOL APENAS SE:**\n- A mensagem do usu√°rio realmente corresponde a informa√ß√£o de alguma vari√°vel.\n\n**SCHEMA ESPERADO (RIGOROSO PRA CARALHO)**\n# JSON ESTRITO:\n`{\"name\": \"<nome_da_variavel>\", \"value\": \"<valor_da_variavel>\"}`\n- Se o param√™tro passados para esta tool for diferente do schema solicitado, ir√° **FALHAR**","jsCode":"const stages = $('Seta est√°gios').first().json\nconst vars = $('Seta vari√°veis da conversa').item.json.data\nconst newQuery = typeof query == 'string' ? JSON.parse(query) : query\nconst currentStage = $('Retorna est√°gio atual').first().json\n\nconst data = {\n  \"name\": newQuery.name, \n  \"value\": newQuery.value\n}\n\nObject.keys(stages).forEach(stageName => {  \n  stages[stageName].actions.requiredDataForExecute = stages[stageName].actions.requiredDataForExecute.map(r => {\n    if (r.name == data.name) {\n      return {\n        ...r, \n        value: data.value\n      }\n    }\n\n\n    return r\n  })\n})\n\nif (vars[data.name]) {\n  vars[data.name].value = data.value\n}\n\nif (currentStage.n && currentStage.ifi) {\n  stages[currentStage.n].finished = true\n}\n\nreturn JSON.stringify({ data, query })"},"type":"@n8n/n8n-nodes-langchain.toolCode","typeVersion":1.3,"position":[2384,768],"id":"5322e98c-bbb4-49ea-8abd-53c7258771ff","name":"Atualizar param√™tros"},{"parameters":{"jsCode":"const cacheVars = $('Busca vari√°veis').first().json.propertyName ? JSON.parse($('Busca vari√°veis').first().json.propertyName) : undefined\n\nreturn cacheVars ?? {\n  data: {\n    name: {\n      description:\n        \"Se apresente e pergunte o *Nome do usu√°rio*. Pergunte de forma educada e respeitosa.\",\n      type: \"string\",\n    },\n    email: {\n      description:\n        \"Email do usu√°rio para entrar em contato quando houver a necessidade.\",\n      type: \"email\",\n    },\n    customerNeed: {\n      description:\n        \"Show, [NOME DO LEAD]! E hoje, o que mais tem te incomodado ou sentido falta a√≠ na sua \\nimobili√°ria? \\nMuitas vezes ouvimos problemas como sistemas com erros, lentid√£o, suporte demorado, ou at√© dificuldade pra fazer cobran√ßas e relat√≥rios... Mas quero entender no seu caso: o que voc√™ tem sentido falta ou gostaria de melhorar no seu processo de loca√ß√£o, vendas ou atendimento?\",\n      type: \"string[]\",\n    },\n    teamSize: {\n      description:\n        \"E s√≥ pra eu entender melhor quantas pessoas trabalham com voc√™? \\n\\nN√£o mostre as op√ß√µes, deixe aberto para o lead responder , interaja com o lead at√© que ele responda com uma das op√ß√µes abaixo: \\n\\nCorretor Aut√¥nomo \\n2 a 5 \\n6 a 10 \\n11 a 25 \\nMais de 25\",\n      type: \"string\",\n    },\n    numberOfBuildings: {\n      description:\n        \"Quantidade total de im√≥veis na carteira (para venda e loca√ß√£o) voc√™ tem dispon√≠veis para neg√≥cio, (sem considerar os locados ou vendidos) \\n\\nBusque por um n√∫mero \",\n      type: \"number\",\n    },\n    rentalTransferMode: {\n      description:\n        'Caso o lead N√ÉO trabalhe com loca√ß√µes, defina \"N√£o Utiliza\" e n√£o fa√ßa a pergunta! \\n\\n\\nE hoje, como voc√™s fazem as repasse dos valores dos alugu√©is para o propriet√°rio? \\n\\nN√£o mostre as op√ß√µes, deixe aberto para o lead responder , interaja com o lead at√© que ele responda com uma das op√ß√µes abaixo: \\n \\nManual em Dinheiro \\nManualmente via PIX \\nRemessa e Retorno Banc√°rio \\nRepasse Autom√°tico via outro Sistema Imobili√°rio',\n      type: \"string\",\n    },\n    fiscalNote: {\n      description:\n        \"Voc√™ gera notas fiscais para os contratos administrados pela sua imobili√°ria? Se sim, como √© feito o processo de gera√ß√£o dessas notas? Al√©m disso, voc√™ realiza o envio do DIMOB?\",\n      type: \"string\",\n    },\n    workWithRent: {\n      description:\n        \"Hoje voc√™s fazem gest√£o de contratos de loca√ß√£o? Se sim, mais ou menos quantos contratos voc√™s t√™m ativos?\\n\\nN√£o mostre as op√ß√µes, deixe aberto para o lead responder , interaja com o lead at√© que ele responda com uma das op√ß√µes abaixo:\\n\\nN√£o\\nAt√© 10 contratos  \\nDe 10 a 25 contratos  \\nDe 25 a 50 contratos  \\nDe 50 a 100 contratos  \\nDe 100 a 200 contratos  \\nDe 200 a 300 contratos  \\nDe 300 a 500 contratos  \\nMais de 500 contratos\",\n      type: \"string\",\n    },\n    amountInCurrentSystemOrBudget: {\n      description:\n        \"Pra entender se conseguimos te atender bem, quanto voc√™ estaria disposto a investir por m√™s em um sistema pra sua imobili√°ria? \\n(Se preferir, pode estimar um valor aproximado) \\n\\nN√£o mostre as op√ß√µes, deixe aberto para o lead responder , interaja com o lead at√© que ele responda com uma das op√ß√µes abaixo:\\n\\nN√£o quis informar  \\nat√© R$ 100  \\nat√© R$ 300  \\nat√© R$ 500  \\nat√© R$ 800  \\nat√© R$ 1.200  \\nat√© R$ 1.600,00  \\nmais de R$ 1.600,00\",\n      type: \"string\",\n    },\n    currentSystem: {\n      description:\n        \" \\nVoc√™ usa algum sistema hoje para gerenciar sua imobili√°ria? Se sim, qual deles? \\n \\nN√£o mostre as op√ß√µes, deixe aberto para o lead responder , interaja com o lead at√© que ele responda com uma das op√ß√µes abaixo: \\n \\nN√£o Utiliza  \\nAlterdata \\nAlude \\nArbo \\nApp Facilita \\nCasaSoft \\nCode 49 \\nImoAlert \\nImobzi \\nImobia \\nImobi Brasil \\nImopro \\niValue \\nJetImob \\nKenlo \\nMicrosistec \\nNido \\nKurole \\nSigasoft \\nUniversal Imoview \\nVista \\nWideSys \\nSami Sistemas \\nSuperL√≥gica \\nSi9 Sistemas \\nSistema Pr√≥prio \\nSite Pr√≥prio \\nProperfy\",\n      type: \"string\",\n    },\n    rentalChargeMode: {\n      description:\n        ' \\nCaso o lead N√ÉO trabalhe com loca√ß√µes, defina \"N√£o Utiliza\" e n√£o fa√ßa a pergunta! \\n \\nE hoje, como voc√™s fazem as cobran√ßas dos alugu√©is? \\n \\nN√£o mostre as op√ß√µes, deixe aberto para o lead responder , interaja com o lead at√© que ele responda com uma das op√ß√µes abaixo: \\n \\nManual/Dinheiro   \\nPIX   \\nTED   \\nBoleto   \\nBoleto - Autom√°tico',\n      type: \"string\",\n    },\n    isRealEstate: {\n      description:\n        ' \\nPergunte qual cargo o lead ocupa no mercado imobili√°rio (ex: \"Qual sua fun√ß√£o na imobili√°ria?\").  \\n \\nS√≥cio / Diretor \\nPropriet√°rio \\nCorretor de Im√≥veis \\nGerente de Vendas \\nGerente de Alugu√©is \\nAuxiliar Administrativo \\nEstagi√°rio \\nMarketing \\nOutro Cargo na imobili√°ria \\nou \"N√£o trabalho no setor\" \\n \\nSe n√£o trabalhar no setor, agrade√ßa e encerre educadamente.',\n      type: \"string\",\n    },\n    qualificationCompleted: {\n      description:\n        \"Marque como true quando o usu√°rio responder a √∫ltima pergunta de qualifica√ß√£o (or√ßamento mensal para a vari√°vel amountInCurrentSystemOrBudget)\",\n      type: \"boolean\",\n    },\n    presentationHasSent: {\n      description:\n        \"Marque como true quando a apresenta√ß√£o em PDF for enviada ao cliente. IMPORTANTE: Sempre defina como true ap√≥s enviar a apresenta√ß√£o para evitar envios duplicados\",\n      type: \"boolean\",\n    },\n  },\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[48,368],"id":"02a38686-3fa9-4379-93b1-afb5cf1dbcd4","name":"Seta vari√°veis da conversa"},{"parameters":{"jsCode":"return {\n  tone: \"Engra√ßado\",\n  agentName: \"Alicia\",\n  internalName: \"Alicia da Apresenta.me\",\n  initialMessage: \"Ol√°, tudo bem? üëã \\n\\nEu sou a Alicia, assistente da Apresenta.me, vou te ajudar entendendo melhor sua necessidade.\",\n  language: \"pt-BR\",\n  timeZone: \"Sao Paulo (GTM -3)\",\n  role: \"SDR S√™nior\",\n  companyName: \"Apresenta.me\",\n  companyDepartment: \"Software\",\n  companySite: \"https://apresenta.me\",\n  conduct: \" \\n### SOBRE SEU PAPEL \\n- Voc√™ √© um SDR, sua Principal fun√ß√£o √© qualificar o lead. para entender se ele tem as caracter√≠sticas do nosso ICP; \\n- Voc√™ ir√° apresentar o sistema da Apresenta.me (https://apresenta.me), um software SAAS para gest√£o completa de imobili√°rias. \\n- Comporte-se exatamente como um representante da empresa, sendo cordial e profissional. \\n \\n \\n### SEU TOM DE VOZ \\n- Responda de maneira simples e objetiva e profissional; \\n- Responda por padr√£o at√© 130 caracteres. S√≥ aumente a resposta quando for estritamente necess√°rio; \\n- Seja emp√°tico e consultivo, nunca agressivo ou invasivo; \\n- Responda com o mesmo tom de voz que o Lead estiver; \\n- Se necess√°rio, utilize emojis como üòÑüëçüè¢üîëüìãüöÄü•≥üå±ü§© etc. \\n- O nome correto do sistema √© Apresenta.me (com ponto), mas fale Apresentame sem pausas; \\n \\n### REGRAS ESPEC√çFICAS \\n- Quando for informar uma URL, informe EXATAMENTE a URL dispon√≠vel \\n- NUNCA fale dos concorrentes de forma negativa \\n- NUNCA saia do personagem \\n- Fa√ßa APENAS UMA pergunta por vez para n√£o sobrecarregar o lead \\n- NUNCA convide para um agendamento de demonstra√ß√£o antes de passar pelo est√°gio de Qualifica√ß√£o \\n- NUNCA direcione para nenhum contato ou link sem antes efetuar a qualifica√ß√£o do lead\\n\\n ## O QUE N√ÉO FAZER (NUNCA):\\n -Informar para o usu√°rio que ele est√° qualificado.\\n -Fornecer qualquer informa√ß√£o sobre os est√°gios do processo de qualifica√ß√£o.\\n: -Citar concorrentes (apenas se solicitado nos est√°gios)\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[256,368],"id":"bbbbe000-37d3-4957-b3cd-57a2ac649199","name":"Seta perfil"},{"parameters":{"jsCode":"const cacheStages = $('Busca est√°gios').first().json.propertyName ? JSON.parse($('Busca est√°gios').first().json.propertyName) : undefined\nconst vars = $('Seta vari√°veis da conversa').first().json.data\n\nfunction findVarInstruction(varName){\n    return vars[varName].description\n}\n\nfunction findVarType(varName) {\n  return vars[varName].type\n}\n\nconst stages = cacheStages ?? {\n  \"Identificar o usuario\": {\n    finished: false,\n    sortNumber: 1,\n    conditionPrompt: \"Se √© in√≠cio da conversa ou se o usu√°rio ainda n√£o informou o nome dele\",\n    requiredDataForExecute: null,\n    actions: {\n      requiredDataForExecute: [\n        {\n          name: \"name\",\n          value: null\n        }\n      ],\n      actions: null, \n      finalInstructions: \"Agrade√ßa e siga para o pr√≥ximo est√°gio\"\n    }\n  },\n  \"Verificar se trabalha no mercado imobili√°rio\": {\n    finished: false,\n    sortNumber: \"4\",\n    conditionPrompt: \"Se ja respondeu o nome.\",\n    requiredDataForExecute: null,\n    actions: {\n      requiredDataForExecute: [\n        {\n          name: \"isRealEstate\",\n          value: null\n        }\n      ],\n      actions: null,\n      finalInstructions: \"Perguntar se o lead trabalha no mercado imobili√°rio \\n- Se n√£o trabalhar, retorne para o lead que a Apresenta.me apenas atende pessoas que trabalhem com o mercado imobili√°rio, agrade√ßa pelo interesse e encerre o atendimento educadamente\"\n    }\n  },\n  \"Diagnosticar a necessidade\": {\n    finished: false,\n    sortNumber: \"3\",\n    conditionPrompt: \"Se voc√™ j√° sabe o nome do lead , e ainda n√£o definiu suas dores, pergunte sobre quais os problemas ele enfrenta e que a Apresenta.me pode ajudar.\",\n    requiredDataForExecute: [\n      {\n        name: \"isRealEstate\", \n        operator: \"exist\",\n        value: null\n      }\n    ],\n    actions: {\n      requiredDataForExecute: [\n        {\n          name: \"customerNeed\",\n          value: null\n        }\n      ],\n      actions: null,\n      finalInstructions: \" \\nAfunile na necessidade espec√≠fica dele, garantindo que voc√™ saiba qual √© a necessidade espec√≠fica que ele tem.  \\n \\nFa√ßa isso atrav√©s de pergunta. Exemplo, se o usu√°rio quer saber sobre algo que possui ramifica√ß√µes nas informa√ß√µes dispon√≠veis, fa√ßa uma pergunta, e se poss√≠vel liste as ramifica√ß√µes / op√ß√µes existentes, para voc√™ saber exatamente onde que o usu√°rio est√° com d√∫vidas, e principalmente quais as d√∫vidas que ele tem quanto ao software da Apresenta.me\"\n    }\n  }, \n  \"Qualificacao\": {\n    finished: false,\n    sortNumber: \"4\",\n    conditionPrompt: \"Se voc√™ j√° sabe o nome do lead, se ele trabalha no mercado imobili√°rio e se voc√™ j√° sabe as necessidades do lead mas ainda n√£o aprondou-se em tais necessidades.\",\n    requiredDataForExecute: [\n      {\n        name: \"isRealEstate\", \n        operator: \"exist\",\n        value: null\n      }\n    ],\n    actions: {\n      requiredDataForExecute: [\n        {\n          name: \"teamSize\",\n          value: null\n        }, \n        {\n          name: \"workWithRent\",\n          value: null\n        },  \n        {\n          name: \"numberOfBuildings\",\n          value: null\n        },\n        {\n          name: \"currentSystem\",\n          value: null\n        },\n        {\n          name: \"rentalTransferMode\",\n          value: null\n        },\n        {\n          name: \"amountInCurrentSystemOrBudget\",\n          value: null\n        },\n        {\n          name: \"qualificationCompleted\",\n          value: null\n        }\n      ],\n      actions: null,\n      finalInstructions: \"Chamar automaticamente o est√°gio `Enviar Apresentacao em PDF`\"\n    }\n  },  \n  \"Enviar Apresentacao em PDF\": {\n    finished: false,\n    sortNumber: \"5\",\n    conditionPrompt: \"Caso o processo de qualifica√ß√£o esteja finalizado\",\n    requiredDataForExecute: [\n      {\n        name: \"qualificationCompleted\", \n        operator: \"=\",\n        value: true\n      },\n      {\n        name: \"presentationHasSent\", \n        operator: \"!exist\",\n        value: null\n      }\n    ],\n    actions: {\n      requiredDataForExecute: [\n        {\n          name: \"presentationHasSent\",\n          value: null\n        }\n      ],\n      actions: null,\n      finalInstructions: \"Ap√≥s o envio da proposta, agrade√ßa a aten√ß√£o do usu√°rio e informe que um vendedor vai entrar em contato assim que poss√≠vel.\"\n    }\n  }  \n}\n\n// Iterar sobre todos os stages\nObject.keys(stages).forEach(stageKey => {\n  const stage = stages[stageKey];\n  \n  // Verificar se existe actions e requiredDataForExecute\n  if (stage.actions && stage.actions.requiredDataForExecute) {\n    // Iterar sobre cada item de requiredDataForExecute\n    stage.actions.requiredDataForExecute.forEach(item => {\n      // Adicionar a propriedade instructions\n      item.instruction = findVarInstruction(item.name);      \n      item.type = findVarType(item.name)\n    });\n  }\n});\n\nreturn stages;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[464,368],"id":"d21ae8ce-7398-4003-a82a-5bcb129b4592","name":"Seta est√°gios"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"cache_key\": \"sdr_{{ $('Webhook').item.json.body.ticketId }}_chat_summary_{{ $('Webhook').item.json.body.contact.number }}_{{ $('Webhook').item.json.body.whatsappId }}_10\"\n} ","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-560,368],"id":"5216ce5c-d749-4c08-a466-e42cb1bfb985","name":"Cria cache key"},{"parameters":{"operation":"get","key":"={{ $json.cache_key }}_stages","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-352,368],"id":"4431ab91-126b-47b2-8917-557a348322ca","name":"Busca est√°gios","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"get","key":"={{ $('Cria cache key').item.json.cache_key }}_vars","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-144,368],"id":"c01a8e81-2a8c-4bfd-b7ad-f8fc2940be9b","name":"Busca vari√°veis","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"={{ $json.cache_key }}_stages"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-352,576],"id":"73a9a621-de0b-460b-8d83-31f27002cfe0","name":"Deleta cache estagios","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}},"disabled":true},{"parameters":{"operation":"delete","key":"={{ $('Cria cache key').item.json.cache_key }}_vars"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-144,576],"id":"b60e69a8-2b98-48ab-bb60-56a0a9991ad1","name":"Delete cache variaveis","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}},"disabled":true},{"parameters":{"operation":"set","key":"={{ $('Cria cache key').first().json.cache_key }}_stages","value":"={{ JSON.stringify($('Seta est√°gios').first().json)}}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2528,368],"id":"9c2401d6-4caa-4249-b791-d3a0c1588329","name":"Seta cache dos estagios","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"={{ $('Cria cache key').item.json.cache_key }}_vars","value":"={{ JSON.stringify($('Seta vari√°veis da conversa').item.json)}}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2736,368],"id":"411b6839-21cf-4bdd-bed8-1762ee01b9ce","name":"Seta cache das variaveis","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Cria cache key').item.json.cache_key }}","contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[1872,640],"id":"558085fb-8a72-49cc-9595-461d2f48f03c","name":"Postgres Chat Memory","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"let stages = $('Seta est√°gios').first().json\n\nObject.entries(stages).forEach(([key, value]) => {\n  const newValue = {\n    cp: value.conditionPrompt,\n    rd: value.requiredDataForExecute?.map(rd => ({\n      n: rd.name,\n      o: rd.operator, \n      v: rd.value\n    })),\n    a: value.actions?.requiredDataForExecute?.map(rd => ({\n      n: rd.name, \n      v: rd.value, \n      i: rd.instruction,\n      t: rd.type,\n      a: rd.actions\n    })) ?? null,\n    fi: value.actions.finalInstructions,\n    f: value.finished\n  }\n  stages[key] = newValue \n})\n\nreturn {\n  stages\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[864,368],"id":"5b96eec8-f0b4-46ef-b5f4-da4845346a01","name":"Compacta JSON est√°gios"},{"parameters":{"description":"## TOOL: Enviar Apresentacao em PDF\n**Objetivo:** Disparar Apresenta√ß√£o em PDF.\n**Descri√ß√£o:** Envia Apresenta√ß√£o em PDF para o usu√°rio.\n\n**SEMPRE CHAME ESSSA TOOL QUANDO:**\n- O est√°gio de qualifica√ß√£o chegar ao final.\n- Esta tool deve ser executada AUTOMATICAMENTE ap√≥s o processo de qualifica√ß√£o do lead.","workflowId":{"__rl":true,"value":"wd0uAb0Sm1fW5YNt","mode":"list","cachedResultUrl":"/workflow/wd0uAb0Sm1fW5YNt","cachedResultName":"Enviar proposta comercial"},"workflowInputs":{"mappingMode":"defineBelow","value":{"whatsappId":"={{ $('Webhook').item.json.body.whatsappId }}","messageRepliedId":"={{ $('Webhook').item.json.body.messageId }}","message":"Segue proposta comercial üöÄüöÄ","number":"={{ $('Webhook').item.json.body.contact.number }}","addUserName":"={{ $('Seta perfil').item.json.agentName }}","company":"={{ $('Webhook').item.json.body.contact.companyId }}"},"matchingColumns":[],"schema":[{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"number","displayName":"number","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"addUserName","displayName":"addUserName","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsappId","displayName":"whatsappId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"messageRepliedId","displayName":"messageRepliedId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"company","displayName":"company","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[1984,768],"id":"a6b0be6e-0f6b-4fe9-b3d1-5c951c2558e6","name":"Enviar Apresentacao em PDF"},{"parameters":{"jsCode":"const stages = $('Compacta JSON est√°gios').first().json.stages\nconst vars = $('Seta vari√°veis da conversa').first().json.data\n\nlet currentInstruction = null;\nlet isFinalInstruction = false;\nlet nexStage = undefined;\n\nconst currentStage = Object.entries(stages).find(([key, value], index) => {\n  const currentInstructionIndex = value.a?.findIndex(action => !action.value)?.i\n  \n  currentInstruction = currentInstructionIndex > -1 ? value.a[currentInstructionIndex] : null\n  \n  if (currentInstructionIndex === (value.a?.length - 1)) {\n    isFinalInstruction = true\n  }\n\n  if (!currentInstruction) {\n    currentInstruction = value.fi    \n\n    if (!currentInstruction) return false\n\n    isFinalInstruction = true\n    const stagesEntries = Object.entries(stages)\n    nexStage = index == (stagesEntries.length - 1) ? undefined : stagesEntries[index + 1]\n  }\n  \n  const requiredVarEmpty = value.rd?.find(required => {\n    const varValue = vars[required.n]\n\n    if (required.o === 'exist' && (!varValue && varValue !== false)) return true\n    \n    if (required.o === \"!exist\" && (varValue && varValue !== true)) return true\n\n    if (required.o === '!=' && varValue == required.value) return true\n\n    if (required.o === \"=\" && varValue != required.value) return true\n  })\n  \n  return value.f || (currentInstruction && !requiredVarEmpty)\n})\n\nreturn {\n  ...(currentStage ? currentStage[1] : {}),\n  n: currentStage ? currentStage[0] : undefined,\n  i: currentInstruction,\n  ifi: isFinalInstruction,\n  ns: nexStage\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1520,368],"id":"b174f52e-5820-4f17-bfb1-478018f0f643","name":"Retorna est√°gio atual"},{"parameters":{"jsCode":"return {\n  chatInput: JSON.stringify($('Webhook').first().json.body.message)\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1728,368],"id":"59b1246a-ce28-40c5-ac61-24284be57454","name":"Retorna chatInput"},{"parameters":{"jsCode":"const vars = Object.entries($('Seta vari√°veis da conversa').first().json.data)\nlet varsCompact = ''\n\nvars.forEach(([key, value]) => {\n  varsCompact+= `${key} (${value.type})\\n`   \n})\n\nreturn {varsCompact}\n\n\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1072,368],"id":"1826680f-4e37-4708-829e-53955f5cab84","name":"Compacta vari√°veis"},{"parameters":{"jsCode":"return {\n  legend: {\n    \"<EST√ÅGIO>\": {\n      cp: \"conditionPrompt: condi√ß√£o para considerar este est√°gio apto para execu√ß√£o\",\n      rd: \"requiredDataForExecute (n√≠vel do est√°gio): lista de condi√ß√µes para habilitar o est√°gio para execu√ß√£o; null se n√£o houver\",\n      a: {\n         rd: \"requiredDataForExecute: lista de vari√°veis que devem ser solicitados nesste est√°gio\",\n         a: \"actions: reservado para a√ß√µes que devem ser executadas ap√≥s a coleta das vari√°veis\", \n        _rd_item: {\n          n: \"name: nome da vari√°vel a coletar\",\n          v: \"value: valor atual/padr√£o da vari√°vel; pode ser null\",\n          i: \"instruction: pergunta/guia para capturar a vari√°vel\",\n          t: \"type: tipo do campo, ex: boolean, string, string[], number[], number\"\n        },\n        fi: \"finalInstructions: instru√ß√£o a executar ao concluir o est√°gio\",\n        f: \"finished: se o est√°gio foi finalizado\"\n      },\n    },\n    _rd_item: {\n      n: \"nome da vari√°vel verificada na condi√ß√£o do est√°gio\",\n      o:\n        \"operador de verifica√ß√£o: 'exist', '!exist', '=' entre outros\",\n      v:\n        \"valor esperado quando operator='='; null para outros casos\",\n    },\n  },\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[672,368],"id":"f743dd40-2875-4151-9bbb-e4b91b19b0b2","name":"Retorna legenda dos est√°gios"},{"parameters":{"jsCode":"return {\n  legend: {\n    \"<EST√ÅGIO>\": {\n      cp: \"conditionPrompt: condi√ß√£o para considerar este est√°gio apto para execu√ß√£o\",\n      rd: \"requiredDataForExecute (n√≠vel do est√°gio): lista de condi√ß√µes para habilitar o est√°gio para execu√ß√£o; null se n√£o houver\",\n      a: {\n         rd: \"requiredDataForExecute: lista de vari√°veis que devem ser solicitados nesste est√°gio\",\n         a: \"actions: reservado para a√ß√µes que devem ser executadas ap√≥s a coleta das vari√°veis\", \n        _rd_item: {\n          n: \"name: nome da vari√°vel a coletar\",\n          v: \"value: valor atual/padr√£o da vari√°vel; pode ser null\",\n          i: \"instruction: pergunta/guia para capturar a vari√°vel\",\n          t: \"type: tipo do campo, ex: boolean, string, string[], number[], number\"\n        },\n        fi: \"finalInstructions: instru√ß√£o a executar ao concluir o est√°gio\",\n        i: \"instruction: instru√ß√£o atual que deve ser executada imediatamente\",\n        ifi: \"isFinalInstruction: true se for a instru√ß√£o final do est√°gio atual\",\n        ns: \"nextStage: pr√≥ximo est√°gio que dever√° ser executado\"\n      },\n    },\n    _rd_item: {\n      n: \"nome da vari√°vel verificada na condi√ß√£o do est√°gio\",\n      o:\n        \"operador de verifica√ß√£o: 'exist', '!exist', '=' entre outros\",\n      v:\n        \"valor esperado quando operator='='; null para outros casos\",\n    },\n  },\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1280,368],"id":"e49167c6-d6c7-4078-b9c7-c2e52faaab07","name":"Retorna legenda do est√°gio atual"}],"connections":{"Embeddings OpenAI":{"ai_embedding":[[{"node":"Busca informa√ß√µes do banco de dados","type":"ai_embedding","index":0}]]},"AI Agent":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Busca informa√ß√µes do banco de dados":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Retorna message":{"main":[[{"node":"Cria cache key","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Seta cache dos estagios","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Webhook":{"main":[[{"node":"Retorna message","type":"main","index":0}]]},"Atualizar param√™tros":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Seta vari√°veis da conversa":{"main":[[{"node":"Seta perfil","type":"main","index":0}]]},"Seta perfil":{"main":[[{"node":"Seta est√°gios","type":"main","index":0}]]},"Seta est√°gios":{"main":[[{"node":"Retorna legenda dos est√°gios","type":"main","index":0}]]},"Cria cache key":{"main":[[{"node":"Busca est√°gios","type":"main","index":0},{"node":"Deleta cache estagios","type":"main","index":0}]]},"Busca est√°gios":{"main":[[{"node":"Busca vari√°veis","type":"main","index":0}]]},"Busca vari√°veis":{"main":[[{"node":"Seta vari√°veis da conversa","type":"main","index":0}]]},"Deleta cache estagios":{"main":[[{"node":"Delete cache variaveis","type":"main","index":0}]]},"Seta cache dos estagios":{"main":[[{"node":"Seta cache das variaveis","type":"main","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"Compacta JSON est√°gios":{"main":[[{"node":"Compacta vari√°veis","type":"main","index":0}]]},"Enviar Apresentacao em PDF":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Retorna est√°gio atual":{"main":[[{"node":"Retorna chatInput","type":"main","index":0}]]},"Retorna chatInput":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Compacta vari√°veis":{"main":[[{"node":"Retorna legenda do est√°gio atual","type":"main","index":0}]]},"Retorna legenda dos est√°gios":{"main":[[{"node":"Compacta JSON est√°gios","type":"main","index":0}]]},"Retorna legenda do est√°gio atual":{"main":[[{"node":"Retorna est√°gio atual","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n.apresenta.me","x-real-ip":"104.22.10.72","x-real-port":"14651","x-forwarded-for":"137.131.195.237, 104.22.10.72","x-forwarded-proto":"http","x-forwarded-host":"n8n.apresenta.me","x-forwarded-port":"80","remote-host":"104.22.10.72","connection":"close","content-length":"710","content-type":"application/json","user-agent":"axios/1.12.2","baggage":"sentry-environment=sandbox,sentry-public_key=105feeda45f1e08a6adb966a132a4c34,sentry-trace_id=f1cfa507e990c55b89f61d233b1f26b6,sentry-transaction=POST-%2Fevolution%2F%3Aintegration%2F%3Aevent,sentry-sampled=true,sentry-sample_rand=0.556404261198399,sentry-sample_rate=0.8","sentry-trace":"f1cfa507e990c55b89f61d233b1f26b6-4aa59642e5154307-1","cf-ray":"9a43d8e97aced4ad-GRU","accept-encoding":"gzip, br","accept":"application/json, text/plain, */*","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"137.131.195.237","cf-ipcountry":"BR","cf-visitor":"{\"scheme\":\"https\"}"},"params":{},"query":{},"body":{"message":"Jo√£o Rorato","messageId":"2569590","contact":{"id":"38043","name":"554788950332","number":"554788950332","profilePicUrl":"https://pps.whatsapp.net/v/t61.24694-24/425105449_1361615211300388_1143514098522857072_n.jpg?ccb=11-4&oh=01_Q5Aa3AGqtZXFxAqK9sR9wCj0AV9nQ-xmQwxNIZm7xk4oDUcOwQ&oe=693335A3&_nc_sid=5e03e0&_nc_cat=102","createdAt":"2025-10-09T16:20:11.311-03:00","updatedAt":"2025-11-25T17:20:27.468-03:00","email":"","isGroup":false,"companyId":"5005","whatsappId":"79","onlyResponsible":false,"userId":"1","aprePersonId":"4916708","apreDealId":null,"blocked":false,"meta":{"ignoreCheck":true,"ignorePermission":true,"dontSendSocket":false}},"whatsappId":"79","companyId":5005,"ticketId":87870},"webhookUrl":"https://n8n.apresenta.me/webhook/7223c6af-f595-4bc2-b84c-602b8900cd08","executionMode":"production"}}]},"versionId":"7d92c11d-484b-453f-8c19-7d57db538a1f","triggerCount":1,"shared":[{"updatedAt":"2025-11-04T18:47:16.654Z","createdAt":"2025-11-04T18:47:16.654Z","role":"workflow:owner","workflowId":"dDaZdsSmHxktrhjc","projectId":"4ToGMYJEWvvDSbcz"}],"tags":[]}