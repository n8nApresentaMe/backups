{"updatedAt":"2026-02-13T19:59:22.000Z","createdAt":"2025-11-04T18:47:16.651Z","id":"dDaZdsSmHxktrhjc","name":"ðŸ—£ï¸ Apr.SDR IA","active":true,"isArchived":false,"nodes":[{"parameters":{"jsCode":"return $('Parser  Chain1').first().json.output.messages.map(message => ({\n  json: { message }\n}))"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[176,736],"id":"4ce1a0fd-a14f-4336-926d-bd852f45941b","name":"Split de mensagens"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2dfab0a2-c614-429c-a13d-36ecb7803f12","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-112,752],"id":"52a8f1a7-c5c1-4c5b-aa63-cc6f4d821148","name":"Se nÃ£o recebeu mensagem no meio do processamento","alwaysOutputData":false},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-320,752],"id":"697a9015-bc65-48e9-85e7-2b6cd5d57290","name":"GET2","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","value":"={{ JSON.stringify({ \n  stage_id: $json.newStageId, \n  vars: $json.updatedVars, \n  missingVar: $json.missingVar, \n  afterRepliedInstruction: $json.missingVar.afterRepliedInstruction, \n  lastInstruction: $json.finalInstruction\n}) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3872,752],"id":"0fcaab6f-2a68-4927-86f8-84fdfa4202fc","name":"Salva Novo Estado","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"=Whatsapp message to be splitted and formated: {{ $json.output }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=# SYSTEM: Otimizador de Texto WhatsApp\nObjetivo: Dividir o texto de entrada em 1 a 4 balÃµes de leitura fluida para o WhatsApp.\n\n# REGRAS DE EXECUÃ‡ÃƒO (CRÃTICAS)\n1. FormataÃ§Ã£o de Markdown (ConversÃ£o):\n   - Converta **texto** â†’ *texto* (negrito padrÃ£o WhatsApp).\n   - Converta ~~texto~~ â†’ ~texto~ (tachado padrÃ£o WhatsApp).\n   - Converta __texto__ â†’ _texto_ (itÃ¡lico padrÃ£o WhatsApp).\n   - URLs: Devem ser isoladas em uma mensagem exclusiva e envoltas em crase: (`url`).\n   - PontuaÃ§Ã£o: Um split NUNCA deve terminar com vÃ­rgula. Se o corte ocorrer em uma vÃ­rgula, remova-a ou ajuste o texto para terminar em ponto, interrogaÃ§Ã£o ou exclamaÃ§Ã£o.\n\n2. SegmentaÃ§Ã£o de BalÃµes (Split):\n   - Tamanho: Alvo de ~150 caracteres por balÃ£o (MÃ¡ximo de 250).\n   - Corte: Ã‰ proibido quebrar frases ao meio. Utilize pontuaÃ§Ã£o (. ? !) como guia obrigatÃ³rio para a divisÃ£o.\n   - CoesÃ£o: Emojis devem ficar sempre colados Ã  palavra anterior, sem espaÃ§o.\n   - Contexto: Separe saudaÃ§Ãµes iniciais e perguntas finais em balÃµes prÃ³prios sempre que o tamanho permitir.\n\n3. RestriÃ§Ã£o de ConteÃºdo (Anti-Vazamento):\n   - Ã‰ terminantemente proibido incluir explicaÃ§Ãµes, metadados, definiÃ§Ãµes de JSON Schema ou qualquer texto tÃ©cnico sobre o funcionamento deste prompt no output.\n   - O conteÃºdo das mensagens deve ser exclusivamente a versÃ£o formatada e segmentada do texto original fornecido.\n\n# FORMATO DE SAÃDA (ESTRITO)\n- Retorne apenas o objeto JSON puro.\n- Proibido o uso de blocos de cÃ³digo markdown (como ```json).\n- Proibido qualquer texto fora das chaves do JSON.\n\n# ESTRUTURA REQUERIDA\n{\n  \"messages\": [\"msg1\", \"msg2\", \"msg3\"]\n}"}]}},"id":"a12ef693-b73f-4f20-9ae8-7d0a0c832737","name":"Parser  Chain1","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[-944,752]},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}"},"id":"f89516e9-ef73-4405-9438-42fc591f9780","name":"OutputParser","type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[-768,928]},{"parameters":{"assignments":{"assignments":[{"id":"ae48936d-1ae8-440b-a604-2a6e4c4418f1","name":"output","value":"={{ $('Gerador de Resposta').item.json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1504,768],"id":"b56901ca-95b2-4556-8b1b-44b4445d3ff3","name":"output1"},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[2000,864],"id":"5a64dbfb-1546-417a-8bc6-f4e23603dbfc","name":"WAIT_SPLIT1","webhookId":"3cea2837-6c05-4e79-8798-96260c4f8dc6"},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[592,736],"id":"7e4de75e-f33c-4e60-8e5e-5c4d568a0b93","name":"LOOP_SLIT1"},{"parameters":{"method":"POST","url":"={{ $env.APRECHAT_URL_API }}api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('LOOP_SLIT1').item.json.message }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1744,832],"id":"a29ee757-25de-49ec-ac6a-30dac3b1a649","name":"Envia WhatsApp1"},{"parameters":{"httpMethod":"POST","path":"7223c6af-f595-4bc2-b84c-602b8900cd08","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-10144,880],"id":"93c6170f-0ea4-42b8-a3ff-57f163806546","name":"Webhook","webhookId":"7223c6af-f595-4bc2-b84c-602b8900cd08"},{"parameters":{"jsCode":"return { \n  cache_key: `session_${$json.body.contact.number}_${$json.body.companyId}`,\n  companyId: $json.body.companyId,\n  whatsappId: $json.body.whatsappId,\n  user_msg: $json.body.message,\n  user_phone: $json.body.contact.number,\n  timestamp: new Date().getTime()\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-9920,880],"id":"72628082-945b-48bd-8087-a0aa46649eee","name":"Configura Contexto"},{"parameters":{"operation":"get","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5728,768],"id":"0e9eea20-3c5b-4187-a155-53e270e74014","name":"GET Estado Atual","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"// --- BLUEPRINT COMPLETO (Baseado na sua regra de negÃ³cio original) ---\nconst workflow = {\n  START: {\n    type: \"message\",\n    instruction:\n      \"Apresente-se como Alicia da Apresenta.me. Seja breve e pergunte como vocÃª pode chamar o lead.\",\n    next_stage: \"WAIT_NAME\",\n  },\n  WAIT_NAME: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"name\",\n        afterRepliedInstruction: \"Diga ao lead que Ã© um prazer conhecÃª-lo.\",\n        description: \"Nome do Lead\",\n      },\n    ],\n    next_stage: \"ASK_WANT_DATA_COLLECTION\",\n  },\n  ASK_WANT_DATA_COLLECTION: {\n    type: \"message\",\n    instruction:\n      'Pergunte ao Lead se ele aceita participar de uma coleta de dados, explicando um pouco sobre a apresenta.me antes (verifique no HISTÃ“RICO se ainda nÃ£o explicou sobre a apresenta.me): \"[NOME], sÃ³ pra te explicar um pouco mais sobre a Apresenta.me: nÃ³s centralizamos a operaÃ§Ã£o da imobiliÃ¡ria em um sÃ³ lugar, ajudando a organizar processos, ganhar eficiÃªncia e aumentar conversÃµes, com uma tecnologia simples e suporte humanizado. Se fizer sentido pra vocÃª, seguimos com alguns dados essenciais pra agendar a demonstraÃ§Ã£o, pode ser ?\"',\n    next_stage: \"WAIT_WANT_DATA_COLLECTION\",\n  },\n  WAIT_WANT_DATA_COLLECTION: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"wantDataCollection\",\n        description: \"Se o usuÃ¡rio QUER participar da COLETA DE DADOS.\",\n      },\n    ],\n    next_stage: \"ROUTER_DATA_COLLECTION\",\n  },\n  ROUTER_DATA_COLLECTION: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"wantDataCollection\",\n        value: false,\n        next_stage: \"SEND_COMMERCIAL_PRESENTATION\",\n      },\n      { default: \"ASK_ROLE\" },\n    ],\n  },\n  SEND_COMMERCIAL_PRESENTATION: {\n    type: \"message\",\n    instruction:\n      \"Responda para o Lead: [NOME DO LEAD], estou te enviando nossa apresentaÃ§Ã£o comercial! Caso vocÃª mude de ideia e queira nos conhecer melhor, Ã© sÃ³ avisar. AtÃ© mais!\",\n    next_stage: \"STOP\",\n  },\n  ASK_ROLE: {\n    type: \"message\",\n    instruction: \"Pergunte qual o cargo ou funÃ§Ã£o dele na imobiliÃ¡ria.\",\n    next_stage: \"WAIT_ROLE\",\n  },\n  WAIT_ROLE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"role\",\n        description:\n          'Cargo ou funÃ§Ã£o na imobiliÃ¡ria. NÃƒO MOSTRAR EXEMPLOS PARA O USUÃRIO. A RESPOSTA SEMPRE DEVE AUTOMATICAMENTE ATRIBUIR VALOR PARA \"isAutonomous\". Considere \"isAutonomous\" com false apenas quando o usuÃ¡rio INDICAR que trabalha sozinho, ou falar de forma explicita que Ã© autÃ´nomo.',\n      },\n      {\n        name: \"isAutonomous\",\n        description:\n          \"(CAMPO LÃ“GICO): Defina AUTOMATICAMENTE TRUE se o usuÃ¡rio trabalha sozinho/autÃ´nomo (isso deve ser indicado pelo LEAD). Defina FALSE se for imobiliÃ¡ria/equipe/sÃ³cio/dono/auxiliar etc.\",\n        type: \"boolean\",\n      },\n    ],\n    next_stage: \"ROUTER_PROFILE\",\n  },\n  // --- DECISÃƒO: AUTÃ”NOMO VS IMOBILIÃRIA ---\n  ROUTER_PROFILE: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"isAutonomous\",\n        value: true,\n        next_stage: \"ASK_RENTAL_STATUS\",\n      }, // AutÃ´nomo pula tamanho do time\n      { default: \"ASK_TEAM_SIZE\" },\n    ],\n  },\n  ASK_TEAM_SIZE: {\n    type: \"message\",\n    instruction: \"Pergunte quantas pessoas trabalham na imobiliÃ¡ria hoje.\",\n    next_stage: \"WAIT_TEAM_SIZE\",\n  },\n  WAIT_TEAM_SIZE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"teamSize\",\n        description: \"Tamanho total da equipe (sÃ³cios + corretores)\",\n      },\n    ],\n    next_stage: \"ASK_RENTAL_STATUS\",\n  },\n  ASK_RENTAL_STATUS: {\n    type: \"message\",\n    instruction:\n      'Pergunte se eles jÃ¡ trabalham com locaÃ§Ãµes ou estÃ£o estruturando agora. Ex: \"[NOME DO LEAD], e hoje, vocÃªs jÃ¡ trabalham com locaÃ§Ãµes ou estÃ£o comeÃ§ando a estruturar ?\"',\n    next_stage: \"WAIT_RENTAL_STATUS\",\n  },\n  WAIT_RENTAL_STATUS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"rentalStatus\",\n        afterRepliedInstruction: `Se o usuÃ¡rio disser que Ã© focado em vendas, sem indicar que trabalha com locaÃ§Ãµes, personalize a resposta: \"Entendi, [NOME DO LEAD]. Como vocÃªs sÃ£o focados em venda, Ã© necessÃ¡rio ter um bom sistema de fÃºnil, para follow-up e um bom CRM pra manter o histÃ³rico dos Leads, isso tudo a Apresenta.me te entrega!! Mas vocÃªs trabalham com locaÃ§Ãµes tambÃ©m, ou somente vendas?\". Se o usuÃ¡rio disser que trabalha com locaÃ§Ãµes, personalize a resposta : \"Bacana, [NOME DO LEAD], pra trabalhar com locaÃ§Ãµes, tem que ter um bom sistema. Quando me refiro Ã  um \"bom sistema\", digo um sistema que trabalhe pra vocÃªs, e nÃ£o que faÃ§a vocÃªs trabalharem mais. E isso Ã© o que o nosso sistema melhor oferece, automaÃ§Ã£o de processos, alÃ©m de ser um sistema completo que agrupa tudo em um lugar sÃ³.\". Se o usuÃ¡rio disser que sÃ³ trabalha com vendas, personalize a resposta: \\\"Entendi, [NOME DO LEAD]. Como vocÃªs sÃ£o focados em venda, Ã© necessÃ¡rio ter um bom sistema de fÃºnil, para follow-up e um bom CRM pra manter o histÃ³rico dos Leads, isso tudo a Apresenta.me te entrega!!\\\"\"`,\n        description:\n          \"Momento atual da imobiliÃ¡ria em relaÃ§Ã£o a locaÃ§Ã£o (jÃ¡ trabalham, estÃ£o comeÃ§ando a estruturar, ou nÃ£o trabalham). NÃƒO MOSTRE NENHUMA OPÃ‡ÃƒO PARA O USUÃRIO, DEIXE ELE RESPONDER LIVREMENTE. (Preencha com as opÃ§Ãµes: active = se jÃ¡ trabalha / starting = se comeÃ§ando / none = se nÃ£o trabalha ou se trabalha somente com vendas). Se ele jÃ¡ trabalha com locaÃ§Ãµes, defina o valor de \\\"interestFocus\\\" como 'all'\",\n      },\n    ],\n    next_stage: \"ASK_PORTFOLIO_SIZE\",\n  },\n  ASK_PORTFOLIO_SIZE: {\n    type: \"message\",\n    instruction:\n      \"Pergunte a quantidade total de imÃ³veis que o Lead/imobiliÃ¡ria tem na carteira, contando venda e locaÃ§Ã£o. Se o lead trabalhar somenta com vendas, nÃ£o cite locaÃ§Ã£o, e vice-versa.\",\n    next_stage: \"WAIT_PORTFOLIO_SIZE\",\n  },\n  WAIT_PORTFOLIO_SIZE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"portfolioSize\",\n        afterRepliedInstruction: `Se o usuÃ¡rio informar o tamanho do portifÃ³lio, entenda o contexto do LEAD, faÃ§a um comentÃ¡rio sobre o tamanho do portifÃ³lio, exemplo (adapte e humanize): \"Entendi, [NOME DO LEAD]. com essa carteira jÃ¡ Ã© preciso ter uma boa organizaÃ§Ã£o.\"`,\n        description:\n          \"Quantidade total de imÃ³veis na carteira (venda + locaÃ§Ã£o). Se o lead trabalhar APENAS com vendas, nÃ£o cite locaÃ§Ã£o, e vice-versa. AtenÃ§Ã£o: muitas vezes o usuÃ¡rio vai dizer que trabalha com locaÃ§Ãµes mas Ã© focado em vendas, e vice-versa. Nesses casos, pergunte o total de imÃ³veis considerando vendas + locaÃ§Ã£o.\",\n      },\n    ],\n    next_stage: \"ASK_INTEREST_FOCUS\"\n  },\n  ASK_INTEREST_FOCUS: {\n    type: \"message\",\n    instruction:\n      'Informe que a Apresenta.me entrega um sistema completo, com site, crm e gestÃ£o financeira e pergunte ao usuÃ¡rio quais dessas opÃ§Ãµes ele precisa, em especÃ­fico. Ex: \"[NOME DO LEAD], hoje a gente entrega um sistema completo, com site, crm e gestÃ£o fincanceira, quais desses mÃ³dulos fazem sentido pra vocÃª?\"',\n    next_stage: \"WAIT_INTEREST_FOCUS\",\n  },\n  WAIT_INTEREST_FOCUS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"interestFocus\",\n        description:\n          \"Quais mÃ³dulos do sistema o usuÃ¡rio estÃ¡ interessado: Site + CRM, GestÃ£o financeira ou todos.\",\n        afterRepliedInstruction:\n          'Se o usuÃ¡rio estiver insistindo em uma opÃ§Ã£o invÃ¡lida, responda-o que nÃ£o vendemos a opÃ§Ã£o avulsa. Ex: \"[NOME DO LEAD], que pena! Infelizmente a gente nÃ£o vende nenhum mÃ³dulo avulso...\". Se o usuÃ¡rio quiser sÃ³ site: responda-o que nÃ£o vendemos site avulso. Ex: \"Entendo, [NOME DO LEAD]! O site Ã© justamente a porta de entrada pra divulgar seus imÃ³veis. Aqui ele jÃ¡ vem integrado ao CRM, o que ajuda vocÃª a receber os leads e acompanhar as vendas sem perder contato. Faz sentido pra vocÃª CRM e site integrados?\". Se o usuÃ¡rio quiser somente CRM: responda-o que na contrataÃ§Ã£o do CRM o site jÃ¡ vem integrado e que nÃ£o vendemos o CRM separado. Ex: \"Legal, [NOME DO LEAD]! Na contrataÃ§Ã£o do CRM, o site jÃ¡ vem integrado, mas nÃ£o Ã© possÃ­vel contratar CRM avulso. Faz sentido pra vocÃª CRM e site integrados?\". Se o usuÃ¡rio estÃ¡ insistindo na mesma opÃ§Ã£o invÃ¡lida (Ã© no mÃ­nimo a segunda fez que ele afirma que quer a mesma opÃ§Ã£o inexistente), ignore essa instruÃ§Ã£o. Se o usuÃ¡rio forneceu uma opÃ§Ã£o/resposta vÃ¡lida: \"Show de bola [NOME DO LEAD], pode ter certeza que vamos conseguir te entregar bons resultados com [OPÃ‡ÃƒO QUE O LEAD ESCOLHEU (Site + CRM ou Sistema completo/todos os mÃ³dulos)].\"',\n        options: {\n          site_crm:\n            \"Se o usuÃ¡rio quiser site + CRM. NÃ£o selecione essa opÃ§Ã£o se ele apenas disser que quer site ou se ele apenas disser que quer CRM.\",\n          all: \"Se o usuÃ¡rio jÃ¡ trabalhar com locaÃ§Ã£o, selecione obrigatoriamente essa opÃ§Ã£o. ou se ele dizer que quer site + crm + gestÃ£o financeira ou explicitamente TODOS.\",\n          invalid_option:\n            \"Se o usuÃ¡rio precisar de uma opÃ§Ã£o inexistente (ex: SÃ³ site, sÃ³ CRM, sÃ³ gestÃ£o financeira). Ou se ele falar que precisa de site, mas nÃ£o citar que precisa de crm. Ou se ele falar que precisa de CRM, mas nÃ£o citar que precisa de site.\",\n        },\n      },\n    ],\n    next_stage: \"ROUTER_INVALID_INTEREST_FOCUS\",\n  },\n  ROUTER_INVALID_INTEREST_FOCUS: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"interestFocus\",\n        value: \"invalid_option\",\n        next_stage: \"ASK_INTEREST_FOCUS_2\",\n      },\n      { default: \"ASK_CURRENT_SYSTEM\" },\n    ],\n  },\n  ASK_INTEREST_FOCUS_2: {\n    type: \"message\",\n    instruction:\n      'Se o usuÃ¡rio quiser sÃ³ site: responda-o que nÃ£o vendemos site avulso. Ex: \"Entendo, [NOME DO LEAD]! O site Ã© justamente a porta de entrada pra divulgar seus imÃ³veis. Aqui ele jÃ¡ vem integrado ao CRM, o que ajuda vocÃª a receber os leads e acompanhar as vendas sem perder contato. Faz sentido pra vocÃª CRM e site integrados?\". Se o usuÃ¡rio quiser somente CRM: responda-o que na contrataÃ§Ã£o do CRM o site jÃ¡ vem integrado e que nÃ£o vendemos o CRM separado. Ex: \"Legal, [NOME DO LEAD]! Na contrataÃ§Ã£o do CRM, o site jÃ¡ vem integrado, mas nÃ£o Ã© possÃ­vel contratar CRM avulso. Faz sentido pra vocÃª CRM e site integrados?\"',\n    next_stage: \"ROUTER_INVALID_INTEREST_FOCUS_2\",\n  },\n  ROUTER_INVALID_INTEREST_FOCUS_2: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"interestFocus\",\n        value: \"invalid_option\",\n        next_stage: \"CLOSING_WHEN_INVALID_OPTION\",\n      },\n      { default: \"ASK_CURRENT_SYSTEM\" },\n    ],\n  },\n  ASK_PAIN_POINT: {\n    type: \"message\",\n    instruction:\n      'Se o lead nÃ£o tem utiliza nenhum sistema: cite o cenÃ¡rio do lead e pergunte qual a PRINCIPAL DOR do lead.\\n Ex: (Adapte esse exemplo para o cenÃ¡rio do lead): \"[NOME DO LEAD], com x colaboradores, x imÃ³veis na carteira, trabalhando com vendas e locaÃ§Ãµes, o que vocÃª apontaria como o maior problema ou dor de vocÃªs aÃ­ na [NOME DA IMOBILIÃRIA (se cidado), ou NA IMOBILIÃRIA]? Seja na gestÃ£o financeira, automaÃ§Ã£o de processos, vendas, etc.\". Se o usuÃ¡rio jÃ¡ utiliza algum sistema ou CRM imobiliÃ¡rio: valide e pergunte quais sÃ£o os problemas existentes no sistema atual. Ex: \"Certo, [NOME DO LEAD]. O que hoje no sistema que vocÃªs usam acaba nÃ£o acompanhando o crescimento ou a rotina de vocÃªs?\"',\n    next_stage: \"WAIT_PAIN_POINT\",\n  },\n  WAIT_PAIN_POINT: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"mainPainPoint\",\n        afterRepliedInstruction:\n          \"Valide a dor do cliente do cliente de forma humana. Pegue o problema do Lead e procure por funcionalidades na base de conhecimento que resolvam o problema do lead e forme um texto breve e de fÃ¡cil leitura com as funcionalidades/soluÃ§Ãµes existentes e explique para o Lead como a Apresenta.me pode solucionar seus problemas.\",\n        description: \"Principal dor, problema ou gargalo citado pelo lead\",\n      },\n    ],\n    next_stage: \"ROUTER_LOCACAO\",\n  },\n  ASK_CURRENT_SYSTEM: {\n    type: \"message\",\n    instruction:\n      'Pergunte se jÃ¡ utilizam algum sistema ou CRM imobiliÃ¡rio hoje, e qual. Se no meio da conversa o usuÃ¡rio indicar que nÃ£o tem um CRM, pergunte SOMENTE se ele jÃ¡ utiliza algum Sistema ImobiliÃ¡rio. Ex: \"[NOME DO LEAD], pra eu me contextualizar melhor, vocÃªs jÃ¡ estÃ£o utilizando algum sistema imobiliÃ¡rio ou CRM pra melhorar o processo de vocÃªs? Se sim, qual ?\" ',\n    next_stage: \"WAIT_CURRENT_SYSTEM\",\n  },\n  WAIT_CURRENT_SYSTEM: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"currentSystem\",\n        afterRepliedInstruction:\n          'Se o lead jÃ¡ utiliza algum sistema ou CRM imobiliÃ¡rio: pergunte quais sÃ£o os problemas existentes no sistema atual. Ex: \"Legal, [NOME DO LEAD]. O que hoje no sistema que vocÃªs usam acaba nÃ£o acompanhando o crescimento ou a rotina de vocÃªs?\". Se o lead nÃ£o utiliza nenhum sistema ou CRM imobiliÃ¡rio, valide a dor do lead, entendendo que processos manuais os tomam muito tempo e que a Apresenta.me consegue automatizar diversos processos, facilitando a vida da imobiliÃ¡ria, se necessÃ¡rio.',\n        description: \"Nome do sistema imobiliÃ¡rio que o lead estÃ¡ usando atualmente (ex: Kenlo, Jetimob, Planilhas)\",\n      },\n    ],\n    next_stage: \"ASK_PAIN_POINT\",\n  },\n  // --- DECISÃƒO: APROFUNDAR LOCAÃ‡ÃƒO? ---\n  ROUTER_LOCACAO: {\n    type: \"router\",\n    rules: [\n      // Se jÃ¡ tem locaÃ§Ã£o ativa ('active'), pergunta detalhes tÃ©cnicos\n      {\n        variable: \"rentalStatus\",\n        value: \"active\",\n        next_stage: \"ASK_CONTRACT_DETAILS\",\n      },\n      // Se nÃ£o tem ou estÃ¡ comeÃ§ando, vai direto pro orÃ§amento\n      { default: \"ASK_PLAN\" },\n    ],\n  },\n  ASK_CONTRACT_DETAILS: {\n    type: \"message\",\n    instruction:\n      'Pergunte quantos contratos ativos administram e como fazem o repasse dos valores dos aluguÃ©is para proprietÃ¡rios e corretores hoje. Ex: \"Pra gente entender mehor, qual Ã© o nÃºmero de contratos ativos pra locaÃ§Ã£o que vocÃªs possuem? E hoje, como fazem os repasses para os proprietÃ¡rios e corretores ?\"',\n    next_stage: \"WAIT_CONTRACT_DETAILS\",\n  },\n  WAIT_CONTRACT_DETAILS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"numberOfContracts\",\n        afterRepliedInstruction:\n          \"Baseando-se no cenÃ¡rio que o LEAD jÃ¡ informou ao longo da conversa:\\n Se anteriormente ele disse que utilizam sistemas genÃ©ricos (como planilhas) ou que nÃ£o usam nenhum sistema imobiliÃ¡rio e se tiver um nÃºmero consideravelmente alto de contratos: mencione para o lead que com a quantidade de contratos mencionado pelo lead, deve ser um desafio fazer o gerenciamento sem um sistema imobiliÃ¡rio; Se tiver um numero de contratos considerÃ¡velmente alto e jÃ¡ utilizar algum sistema imobiliÃ¡rio: validar de forma simples e natural, sem elogiar ou desdenhar; Se o usuÃ¡rio informou tambÃ©m o mÃ©todo de repasse: adicione uma validaÃ§Ã£o final para o repasse: Se o lead indicar que Ã© manual/banco: Cite o cenÃ¡rio dele, e diga que no cenÃ¡rio que o lead informou, fazer repasse manual em 2026 Ã© inaceitÃ¡vel e informe que a Apesenta.me dispÃµe de funcionalidades que automatizam esse processo; Se ele indicar que o repasse jÃ¡ Ã© feito de forma automÃ¡tica de enfase ao nosso produto/funcionalidade: valide a fala do Lead e diga que aqui na Apresenta.me entregamos a funcionalidade de repasse automÃ¡tico tambÃ©m e que tem ajudado muito nossos clientes.\",\n        description: \"Quantidade de contratos de locaÃ§Ã£o ativos\",\n      },\n      {\n        name: \"transferMode\",\n        afterRepliedInstruction:\n          \"Se o lead indicar que Ã© manual/banco: Fale sobre o cenÃ¡rio do lead, e diga que no cenÃ¡rio que o lead informou, fazer repasse manual em 2026 Ã© inaceitÃ¡vel e informe que a Apesenta.me dispÃµe de funcionalidades que automatizam esse processo. Se ele indicar que o repasse jÃ¡ Ã© feito de forma automÃ¡tica, de enfase ao nosso produto/funcionalidade: valide a fala do Lead e diga que aqui na Apresenta.me entregamos a funcionalidade de repasse automÃ¡tico tambÃ©m e que tem ajudado bastante nossos clientes.\",\n        description:\n          \"MÃ©todo de repasse (Ex: Manual, Banco, Split etc.). NUNCA MOSTRE EXEMPLOS PARA O USUARIO E DEIXE ELE RESPONDER LIVREMENTE.\",\n      },\n    ],\n    next_stage: \"ASK_PLAN\",\n  },\n  ASK_PLAN: {\n    type: \"message\",\n    instruction: `\nAgora que vocÃª jÃ¡ entende o cenÃ¡rio do lead, pense lÃ³gicamente, com base nas informaÃ§Ãµes que ele passou, qual dos planos abaixo se enquadra melhor no cenÃ¡rio dele:    \n- **Start IMOB (R$ 449,99/mÃªs):** 2 usuÃ¡rios, 300 imÃ³veis, 500 negÃ³cios. Inclui Site e WhatsApp -> REMOVA ESSA OPÃ‡ÃƒO SE O USUÃRIO JÃ TRABALHA COM LOCAÃ‡ÃƒO (rentalStatus = active/starting).\n- **Basic IMOB (R$ 699,99/mÃªs):** 5 usuÃ¡rios, 1000 imÃ³veis, 2000 negÃ³cios. Inclui 50 contratos e gestÃ£o financeira.\n- **Big IMOB (R$ 999,99/mÃªs):** 12 usuÃ¡rios, imÃ³veis ilimitados, 5000 negÃ³cios. Inclui 150 contratos e geraÃ§Ã£o automÃ¡tica de boletos.\n- **Super IMOB (Especialista):** Acima de 25 usuÃ¡rios ou 300 contratos. GestÃ£o completa de comissÃµes.\nApÃ³s vocÃª selecionar um desses planos, como resposta: cite o cenÃ¡rio do Lead, informe o porquÃª o plano selecionado faz sentido para o lead e informe o plano selecionado.\nOBS: NÃƒO ENVIE TODOS OS PLANOS PARA O LEAD, SELECIONE APENAS UM PLANO QUE SE ENCAIXA MELHOR NO CENÃRIO/CONTEXTO ATUAL DA IMOBILIÃRIA ATUALMENTE.\n`,\n    next_stage: \"WAIT_PLAN\",\n  },\n  WAIT_PLAN: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"selectedPlanWasAccepted\",\n        afterRepliedInstruction:\n          \"Se o lead informar que precisa AUMENTAR o nÃºmero de usuÃ¡rios, contratos, imÃ³veis, negÃ³cios, etc: informe que o plano pode ser personalizado de acordo com o que ele precisa, e que o Plano Selecionado Ã© apenas um plano base. PorÃ©m, apenas um especialista pode personalizar o plano do lead; Se o lead informar que precisa DIMINUIR o nÃºmero de usuÃ¡rios, contratos, imÃ³veis, negÃ³cios, etc: informe que um especialista vai tentar entender melhor as necessidades do Lead e selecionar um plano mais adequado.\",\n        description:\n          \"Se o plano selecionado jÃ¡ foi apresentado um plano com base no cenÃ¡rio do lead e ele disse que o plano faz sentido pra ele, que estÃ¡ dentro do que planejam investir. Se o plano selecionado ainda nÃ£o foi apresentado para o lead: NÃƒO PREENCHA esta variÃ¡vel. Se for atribuido qualquer valor para whyDidntAcceptedThePlan, atribua FALSE para esta variÃ¡vel\",\n      },\n    ],\n    next_stage: \"ROUTER_PLAN_ACCEPTED\",\n  },\n  ROUTER_PLAN_ACCEPTED: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"selectedPlanWasAccepted\",\n        value: false,\n        next_stage: \"ASK_WHY_DIDNT_ACCEPTED_THE_PLAN\",\n      },\n      { default: \"CLOSING\" },\n    ],\n  },\n  ASK_WHY_DIDNT_ACCEPTED_THE_PLAN: {\n    type: \"message\",\n    instruction:\n      'Se o lead nÃ£o informou o motivo pelo qual o plano nÃ£o faz sentido para ele, pergunte de forma objetiva o motivo. Ex: \"Entendi, [NOME DO LEAD], vocÃª poderia me contar por qual motivo o [PLANO SELECIONADO] nÃ£o faz sentido pra vocÃª?\"',\n    next_stage: \"WAIT_WHY_DIDNT_ACCEPTED_THE_PLAN\",\n  },\n  WAIT_WHY_DIDNT_ACCEPTED_THE_PLAN: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"whyDidntAcceptedThePlan\",\n        afterRepliedInstruction:\n          \"Se ele informou que precisa de uma funcionalidade que nÃ£o temos, procure na base de conhecimento pela funcionalidade e se esta existir, informe ao cliente que possuÃ­mos, se nenhuma funcionalidade que o lead precisa existe na base de conhecimento, entÃ£o informe que iremos encaminhar o caso do lead para um especialista. Se o cliente reclamou do valor, informe que iremos encaminhar para um especialista cuidar desse caso especÃ­fico. Se ele informar que precisa de mais usuÃ¡rios, mais contratos, mais imÃ³veis ou qualquer outro item existente no plano, informe que trabalhamos que podemos personalizar os planos, mas que um especialista precisa fazer essa personalizaÃ§Ã£o para o Lead.\",\n        description:\n          \"Motivo pelo qual o plano nÃ£o foi aceito pelo usuÃ¡rio. Se o usuÃ¡rio disse o motivo pelo qual nÃ£o aceita o plano, altere selectedPlanWasAccepted\",\n      },\n    ],\n    next_stage: \"CLOSING\",\n  },\n  CLOSING: {\n    type: \"message\",\n    instruction:\n      'AgradeÃ§a de forma cordial, se despeÃ§a e diga que foi um prazer conhecer o lead, citando o nome dele. Diga que coletou todos os dados necessÃ¡rios e informe que um especialista entrarÃ¡ em contato para agendar uma apresentaÃ§Ã£o. Ex: \"[NOME DO LEAD], coletei todos os dados necessÃ¡rios aqui e vou prosseguir com o agendamento de uma demonstraÃ§Ã£o te encaminhando pra um especialista. Foi um prazer te conhecer, atÃ© mais!\"',\n    next_stage: \"STOP\",\n  },\n  CLOSING_WHEN_INVALID_OPTION: {\n    type: \"message\",\n    instruction:\n      \"AgradeÃ§a de forma cordial e simpÃ¡tica, diga que irÃ¡ encaminhar o atendimento para um especialista que poderÃ¡ cuidar do caso especÃ­fico do lead e se despeÃ§a dizendo que foi um prazer conhecÃª-lo.\",\n    next_stage: \"STOP\",\n  },\n};\n\nconst redisData = $(\"GET Estado Atual\").item.json.propertyName\n  ? JSON.parse($(\"GET Estado Atual\").item.json.propertyName)\n  : {};\nconst currentStageId = redisData.stage_id || \"START\";\nconst vars = redisData.vars || {};\nconst stageConfig = workflow[currentStageId] || workflow[\"START\"];\n\n// --- VARREDURA GLOBAL DE VARIÃVEIS ---\nlet missingVars = [];\nfor (const key in workflow) {\n  const step = workflow[key];\n  if (step.type === \"input\" && step.variables) {\n    step.variables.forEach((v) => {\n      if (!vars[v.name] || vars[v.name].value === null || vars[v.name].value === 'invalid_option' || vars[v.name].value === 'not_provided' || vars[v.name].value === 'answer_later') {\n        missingVars.push({\n          name: v.name,\n          description: v.description,\n          options: v.options || null,\n        });\n      }\n    });\n  }\n}\n\nreturn {\n  workflow,\n  currentStageId,\n  stageConfig,\n  vars,\n  missingVars,\n  userMsg: $(\"CONCATENA1\").item.json.user_full_message,\n  missingVar: JSON.parse($input.first().json.propertyName)?.missingVar,\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5504,768],"id":"98cfc05a-d3fa-487e-9e32-776bfb8b94f9","name":"BLUEPRINT ENGINE"},{"parameters":{"jsCode":"const inputData = $input.all()[0].json;\nconst workflow = $('BLUEPRINT ENGINE').first().json.workflow;\nlet currentStageId = $('BLUEPRINT ENGINE').first().json.currentStageId;\nlet vars = $('BLUEPRINT ENGINE').first().json.vars;\nlet stageConfig = $('BLUEPRINT ENGINE').first().json.stageConfig;\nconst lastInstruction = JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').lastInstruction\nconst lastMissingVar = JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar \nlet outputInstruction = \"\";\nlet missingVar = \"\";\nlet immediatelyNextStage = \"\";\n\n// --- 1. ATUALIZAÃ‡ÃƒO GLOBAL (Check-in) ---\nconst extractedObj = inputData.output || {};\nfor (const [key, value] of Object.entries(extractedObj)) {\n    // SÃ³ atualiza se tiver valor real\n    if (value !== null && value !== undefined && value !== \"\") {\n        vars[key] = { value: value, type: 'extracted' };\n    }\n}\n\n// Helper: Verifica se TODAS as variÃ¡veis do estÃ¡gio estÃ£o preenchidas\nfunction isInputSatisfied(stage) {\n    if (!stage || stage.type !== 'input') return false;\n    // Retorna true apenas se TODAS as variÃ¡veis listadas existirem em 'vars'\n    return stage.variables.every(v => vars[v.name] && vars[v.name].value !== null && vars[v.name].value !== \"\");\n}\n\n\n// --- 2. LOOP DE AVANÃ‡O (Auto-Skip & Look Ahead) ---\nlet safetyLoop = 0;\nlet advancing = true;\n\nwhile (advancing && safetyLoop < 50) {\n    stageConfig = workflow[currentStageId];\n    if (!stageConfig) break;\n\n    if (stageConfig.immediately_next_stage) {\n      immediatelyNextStage = stageConfig.immediately_next_stage\n    }\n\n    advancing = false; // Por padrÃ£o, o loop para aqui, a menos que encontre motivo para seguir\n\n    // ======================================================\n    // CASO 1: INPUT (Esperando dados do usuÃ¡rio)\n    // ======================================================\n    if (stageConfig.type === 'input') {\n        if (isInputSatisfied(stageConfig)) {\n            // Temos tudo! Pula para o prÃ³ximo estÃ¡gio.\n            currentStageId = stageConfig.next_stage;\n            advancing = true; \n        } else {\n            // [CORREÃ‡ÃƒO AQUI] Falta resposta. NÃ£o podemos deixar a instruÃ§Ã£o vazia.\n            // Descobre qual variÃ¡vel estÃ¡ faltando para orientar a IA\n            missingVar = stageConfig.variables.find(v => !vars[v.name] || !vars[v.name].value);\n            \n            if (missingVar) {\n                // Se o usuÃ¡rio falou algo nada a ver (extraÃ§Ã£o rodou mas nÃ£o pegou o dado)\n                if (Object.keys(extractedObj).length > 0 && !Object.values(extractedObj).find(v => v)) {\n                     outputInstruction = `O usuÃ¡rio respondeu algo, mas nÃ£o entendi o(a) ${missingVar.description}. Pergunte novamente de forma clara.`;\n                } else {\n                    if (lastMissingVar && !vars[lastMissingVar.name]?.value) {\n                      outputInstruction = lastInstruction\n                    } else {\n                      outputInstruction = `Pergunte: ${missingVar.description}`; \n                    }\n                }\n            }\n            // Mantemos advancing = false para PARAR aqui e esperar o user responder\n        }\n    }\n\n    // ======================================================\n    // CASO 2: MENSAGEM (O robÃ´ fala)\n    // ======================================================\n    else if (stageConfig.type === 'message') {\n        // [LOOK AHEAD]\n        // Verifica se a mensagem serve para pedir um dado que JÃ TEMOS.\n        const nextStage = workflow[stageConfig.next_stage];\n        \n        // Se o prÃ³ximo passo Ã© input E jÃ¡ estÃ¡ preenchido -> Pula a mensagem atual\n        if (nextStage && nextStage.type === 'input' && isInputSatisfied(nextStage)) {\n            currentStageId = nextStage.next_stage;\n            advancing = true; \n        } else {\n            // Mensagem necessÃ¡ria. Define instruÃ§Ã£o.\n            outputInstruction = stageConfig.instruction;\n            \n            // JÃ¡ aponta o ponteiro para o prÃ³ximo estÃ¡gio (onde vamos esperar o input)\n            if (stageConfig.next_stage !== 'STOP') {\n                currentStageId = stageConfig.next_stage;\n                const nextStage = workflow[currentStageId]   \n\n                if (nextStage.type == 'input') {\n                  missingVar = nextStage.variables.find(v => !vars[v.name] || !vars[v.name].value);\n                }\n              \n            }\n            // Para o loop para a IA falar.\n            advancing = false; \n        }\n    }\n\n    // ======================================================\n    // CASO 3: ROUTER (LÃ³gica condicional)\n    // ======================================================\n    else if (stageConfig.type === 'router') {\n        let routeFound = false;\n        for (const rule of stageConfig.rules) {\n            if (rule.default) {\n                currentStageId = rule.default;\n                routeFound = true;\n                break;\n            }\n            // ValidaÃ§Ã£o simples de valor\n            if (vars[rule.variable] && vars[rule.variable].value === rule.value) {\n                currentStageId = rule.next_stage;\n                routeFound = true;\n                break;\n            }\n        }\n        // Se achou rota, continua avanÃ§ando no mesmo tick\n        if (routeFound) advancing = true; \n    }\n    \n    safetyLoop++;\n}\n\nreturn {\n    newStageId: currentStageId,\n    updatedVars: vars,\n    finalInstruction: outputInstruction,\n    missingVar, \n    immediatelyNextStage\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4096,752],"id":"2cb6799d-290a-473e-ae81-bea790fc1a8d","name":"LOGIC ENGINE"},{"parameters":{"promptType":"define","text":"=[MENSAGEM DO HUMANO]\n{{ $('CONCATENA1').first().json.user_full_message }}\n\n[INSTRUÃ‡ÃƒO DO FLUXO] (CRÃTICO - OBRIGATÃ“RIO)\n* **INSTRUÃ‡ÃƒO_A:** {{ $('LOGIC ENGINE').first().json.updatedVars[JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name].value && !['not_provided', 'answer_later'].includes($('LOGIC ENGINE').first().json.updatedVars[JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name].value)  ? JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').afterRepliedInstruction : null }}\n* **INSTRUÃ‡ÃƒO_B:** \"{{ $('LOGIC ENGINE').first().json.finalInstruction }}\"\n\n### [DADOS PARA PROCESSAMENTO]\n* **DADOS_COLETADOS:** {{ JSON.stringify($('LOGIC ENGINE').first().json.updatedVars) }}\n* **CONTEXTO_TÃ‰CNICO (RAG):** {{ $('MERGE DADOS').first().json.rag_context ? $('MERGE DADOS').first().json.rag_context.join('\\n\\n'): \"\" }}\n\n### [HISTÃ“RICO DE CONVERSA (DA MAIS ANTIGA PARA A MAIS RECENTE)]\n{{ $('Formata ultimas mensagens').first().json.historyMessages }}\n\n\n### [DATA/HORA ATUAL]\n{{ $now.toFormat('dd/MM/yyyy HH:mm') }}\nPOR EXTENSO: {{ $now.setLocale('pt-BR').toFormat(\"d 'de' MMMM 'de' yyyy\") }}","options":{"systemMessage":"=# PERFIL E IDENTIDADE\nAgente: {{ $('Seta perfil1').first().json.agentName }} | Empresa: {{ $('Seta perfil1').first().json.companyName }}\nDepto: {{ $('Seta perfil1').first().json.companyDepartment }}\nTom/Conduta: {{ $('Seta perfil1').first().json.tone }} | {{ $('Seta perfil1').first().json.conduct }}\n\n## DIRETRIZES DE SAÃDA (WHATSAPP)\n- Mensagem Ãºnica, fluida e humanizada.\n- Evite ao MÃXIMO usar o sinal de exclamaÃ§Ã£o (!).\n- Proibido mencionar que Ã© uma inteligÃªncia artificial.\n\n## LÃ“GICA DE EXECUÃ‡ÃƒO (ORDEM DE PENSAMENTO)\n\n1. FILTRO DE SUPORTE (CRÃTICO):\n   - Se o lead demonstrar ser CLIENTE (relatar erros, dÃºvidas de uso ou afirmar que jÃ¡ usa), interrompa a venda.\n   - Resposta: Informe que para suporte tÃ©cnico ele deve contatar: +55 (47) 8905-0935. Finalize ali.\n\n2. FILTRO DE ENCERRAMENTO:\n   - Se o humano enviar mensagens de despedida ou agradecimento final (Ex: \"Valeu\", \"Obrigado\"), apenas despeÃ§a-se gentilmente. NÃ£o faÃ§a novas perguntas e ignore a INSTRUCAO_B.\n\n3. CONSTRUÃ‡ÃƒO DA RESPOSTA (O FLUXO):\n   - PASSO A (ValidaÃ§Ã£o): Comece SEMPRE validando a fala do humano usando a [INSTRUCAO_A]. Adapte o texto para ser uma ponte natural. Se a instruÃ§Ã£o pedir algo que vocÃª jÃ¡ disse no histÃ³rico recente, mude as palavras para nÃ£o ser repetitiva.\n   - PASSO B (DÃºvida TÃ©cnica): Se houver dÃºvida (Flag: {{ $('Router de DÃºvida').first().json.output.hasQuestion }}), responda curto via CONTEXTO_TÃ‰CNICO. Se a info nÃ£o existir, use a Carta de SeguranÃ§a: {{ $('Seta perfil1').first().json.securityLetter }}.\n   - PASSO C (Engajamento): Se a coleta de dados estiver ativa, insira a [INSTRUCAO_B]. \n     - REGRA ANTI-REPETIÃ‡ÃƒO: Se a pergunta da INSTRUCAO_B jÃ¡ foi feita nas Ãºltimas 3 mensagens e o humano ainda nÃ£o respondeu, NÃƒO repita a pergunta. Apenas valide a fala dele (Passo A) e aguarde.\n\n## REGRAS DE OURO (ANTI-ROBÃ”)\n- SEM PAPAGAIO: Proibido repetir apresentaÃ§Ãµes ou saudaÃ§Ãµes se jÃ¡ estiverem no histÃ³rico.\n- APRESENTAÃ‡ÃƒO: Apenas se o HISTORICO estiver 100% vazio.\n- Se a INSTRUCAO_B nÃ£o trouxer nada de novo ou jÃ¡ tiver sido atendida nos DADOS_COLETADOS, ignore-a.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-1920,768],"id":"e022f843-b822-479c-ade1-ef286b87342b","name":"Gerador de Resposta"},{"parameters":{"amount":6},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-6880,1152],"id":"f8c547ba-6c58-4010-87d2-fc4453f1e442","name":"Wait1","webhookId":"d1e38aad-57ac-45e5-b64a-08e2f1ce1a6f"},{"parameters":{"operation":"delete","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-6880,784],"id":"c687ee84-4b3d-4d6b-a138-f2565404c804","name":"DELETE1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2aafb32-380d-4510-810a-888831d36437","leftValue":"={{ DateTime.fromMillis($json.messages?.last().timestamp) }}","rightValue":"={{ $now.minus(6, 'seconds' )}}","operator":{"type":"dateTime","operation":"before"}}],"combinator":"and"},"renameOutput":true,"outputKey":"segue"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3d2a33da-ed74-4906-92aa-74ad3a37c4f1","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"nada"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"espera"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-7104,864],"id":"65f3fcf3-b645-497b-89ff-44c9074b742d","name":"SWITCH_BUFFER"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-6880,960],"id":"70ea16d7-2da5-4d28-b7c6-cbf961ee66d9","name":"NADA1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1f5bcbd1-6685-469d-bbf2-7939008b234d","leftValue":"={{ $('Configura Contexto').first().json.user_msg }}","rightValue":"clear:cache:111222","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-9648,880],"id":"3f264b4d-de14-4fdb-a44b-ec44b64dd580","name":"If2"},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8720,560],"id":"63694275-a282-4cc7-bac2-fddb37de9afe","name":"Delete table or rows1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"delete","key":"={{ $('Configura Contexto').item.json.cache_key }}_state"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8896,560],"id":"97e89849-0861-43e8-b3cd-c33830791799","name":"Deleta estado atual","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=temp.{{ $('Configura Contexto').item.json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8528,560],"id":"4aafa985-084a-4eda-9067-7d76c5d41671","name":"DELETE2","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"return {\n  messages: [\n    ...(typeof $('BUSCA MENSAGENS ACUMULADAS').first().json.messages == 'string' ? JSON.parse($('BUSCA MENSAGENS ACUMULADAS').first().json.messages) : $('BUSCA MENSAGENS ACUMULADAS').first().json.messages), \n    ...(typeof $('GET2').first().json.messages == 'string' ? JSON.parse($('GET2').first().json.messages) : $('GET2').first().json.messages)\n  ]\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[64,1424],"id":"2a4a848a-caa8-46fb-b3fd-60cfe71bfeb9","name":"Concatena mensagens para cache"},{"parameters":{"jsCode":"const messages = typeof $input.first().json.messages == 'string' ? JSON.parse($input.first().json.messages) : $input.first().json.messages\n\nreturn {\n  messages: messages?.map(message => typeof message === 'string' ? JSON.parse(message) : message) ?? null\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-7424,880],"id":"7f4a145a-25fb-4e89-8e15-d914618f2268","name":"Transforma em objeto literal"},{"parameters":{"method":"POST","url":"={{ $env.APRECHAT_URL_API }}api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output }}"},{"name":"number","value":"={{ $('Webhook').first().json.body.contact.number }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"},{"name":"whatsappId","value":"={{ $('Webhook').first().json.body.whatsappId }}"},{"name":"messageRepliedId","value":"={{ $('Webhook').first().json.body.messageId }}"},{"name":"messageType","value":"internalNote"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2496,112],"id":"93574b12-f35a-4f6e-89aa-5aefee29528f","name":"Salva nota na conversa1"},{"parameters":{"jsCode":"const data = $input.all();\nconst formatChatHistory = (inputData) => {\n  return inputData.map(jsonItem => {\n    const item = jsonItem.json\n    // 1. Define o remetente\n    const sender = item.message.type === 'human' ? 'User' : 'IA';\n    \n    // 2. Pega o conteÃºdo original\n    let content = item.message.content;\n\n    // 3. Se for IA, aplica a Regex para limpar o \"lixo\" tÃ©cnico\n    if (item.message.type === 'ai') {\n      // REGEX EXPLICADA:\n      // ^              -> ComeÃ§a no inÃ­cio da string\n      // \\[Used tools:  -> Procura literalmente por \"[Used tools:\"\n      // [\\s\\S]*?       -> Pega qualquer caractere (incluindo quebra de linha) de forma nÃ£o-gulosa (para no primeiro match)\n      // \\]\\]           -> Procura o fechamento dos colchetes duplos \"]]\"\n      // \\s* -> Remove quaisquer espaÃ§os ou quebras de linha que sobrem logo apÃ³s\n      content = content.replace(/^\\[Used tools:[\\s\\S]*?\\]\\]\\s*/, '');\n    }\n\n    // 4. Retorna no formato solicitado\n    return `${sender}: ${content}`;\n  }).join('\\n'); // Une tudo com quebra de linha\n};\n\n// Executa e mostra o resultado\nconst result = formatChatHistory(data);\n\nreturn  {\n  result\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1856,112],"id":"861dee0d-29f2-46f7-ae77-ca27ac4eaa74","name":"Formata histÃ³rico1","executeOnce":true},{"parameters":{"promptType":"define","text":"=[HISTÃ“RICO DE CONVERSA]\n{{ $json.result }}","options":{"systemMessage":"*DOSSIÃŠ*\nCrie um breve dossiÃª da conversa, listando cada informaÃ§Ã£o separada por linha e colocando a label em negrito. Use emojis no inÃ­cio de cada linha para dar destaque e reforÃ§ar o significado do item.\n\n*ANÃLISE*\nTom: Defina o tom/perfil do usuÃ¡rio. Use emojis relevantes no inÃ­cio.\nResumo: Gere um breve resumo da conversa em texto corrido. Use emojis ao longo do texto para dar ritmo e destacar pontos importantes.\n\n*ONDE PAROU*\nInforme onde a conversa parou. Use emojis para marcar status e contexto.\n\n*PRÃ“XIMOS PASSOS*\nDefina os prÃ³ximos passos. Use emojis em cada passo para guiar o olhar e deixar mais chamativo.\n\n## FORMATAÃ‡ÃƒO:\nNegrito: Um asterisco antes e depois da palavra/frase. Ex: '*Teste*'\nItÃ¡lico: Um underline antes e depois da palavra/frase. Ex: '_Teste_'\n\n## REGRAS DE OURO:\n- Seja breve\n- Crie um resumo objetivo\n- Texto corrido apenas no resumo (bloco anÃ¡lise)\n- ABUSE DE EMOJIS para chamar atenÃ§Ã£o, sem parecer aleatÃ³rio\n- Emojis devem ser condizentes com a informaÃ§Ã£o de cada linha\n- Em listas, usar pelo menos 1 emoji por linha\n- No resumo, usar emojis espalhados ao longo do texto, destacando temas, decisÃµes, dores e prÃ³ximos passos\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[2128,112],"id":"984581d9-2d1c-48bb-9ce2-6e8bdcb37d66","name":"Gera resumo da conversa - AI1"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"sort":{"values":[{"column":"id"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1632,112],"id":"4460bb7b-e758-4ce3-8569-196683a7ff4b","name":"Busca histÃ³rico de conversa1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8448,880],"id":"35f88924-42c0-4c4b-a0b6-555d7fb214f7","name":"Busca mensagens no cache","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"const inputMessages = typeof $input.first().json.messages == 'string' ?  JSON.parse($input.first().json.messages) : $input.first().json.messages\nconst cacheMessagesToArrayJSON = inputMessages?.map(message => typeof message == 'string' ? JSON.parse(message) : message) || []\nconst userMsg = $('Retorna userMsg').first().json\nconst currentMessageIsAlreadyOnCache = inputMessages?.find(message => message.message === userMsg.message && message.timestamp === userMsg.timestamp) || false\n\n\nreturn {\n  messages: [\n    ...cacheMessagesToArrayJSON, \n    userMsg\n  ], \n  currentMessageIsAlreadyOnCache\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-8160,880],"id":"abb33b8c-c1aa-4fd8-9b56-39ee07ae596a","name":"Junta mensagem do cache com a mensagem do usuÃ¡rio"},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-7872,880],"id":"da193626-7c80-40d4-aa4b-03615db6b521","name":"SETA CACHE DAS MENSAGENS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-7648,880],"id":"9e9b1ed3-2741-4675-95c1-5235034308e6","name":"BUSCA MENSAGENS ACUMULADAS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($('Concatena mensagens para cache').first().json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[272,1424],"id":"8e1d5359-92c7-4f2e-af7c-bbe67b8c079f","name":"RE-SETA CACHE DAS MENSAGENS ACUMULADAS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":8,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-5280,768],"id":"1a0b8458-99d4-47e3-90fe-be1af825c0cd","name":"Pega ultimas mensagens","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length || !messages[0].json?.message?.content) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5056,768],"id":"b4b42675-1168-4e41-a586-598a5a0b8e7d","name":"Formata ultimas mensagens","executeOnce":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"CLOSING","operator":{"type":"string","operation":"equals"},"id":"732957f5-38a8-4204-ab63-9403f96c1a78"}],"combinator":"and"},"renameOutput":true,"outputKey":"closing"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1a022d7b-9866-445e-824d-ee7a7616d891","leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"CLOSING_WHEN_INVALID_OPTION","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"closing_when_invalid_option"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3807d7cc-18c1-470f-9689-a991e3d75d2b","leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"SEND_COMMERCIAL_PRESENTATION","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"send_commercial_presentation"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[1104,448],"id":"0dd46236-dd8e-4533-af6e-026d3aebe0eb","name":"Switch"},{"parameters":{"workflowId":{"__rl":true,"value":"wd0uAb0Sm1fW5YNt","mode":"list","cachedResultUrl":"/workflow/wd0uAb0Sm1fW5YNt","cachedResultName":"Enviar apresentaÃ§Ã£o comercial"},"workflowInputs":{"mappingMode":"defineBelow","value":{"whatsappId":"={{ $('Configura Contexto').first().json.whatsappId.toNumber() }}","messageRepliedId":0,"company":"={{ $('Configura Contexto').first().json.companyId }}","number":"={{ $('Configura Contexto').first().json.user_phone }}","addUserName":"={{ $('Seta perfil1').first().json.agentName }}","message":"Segue! ðŸš€ðŸš€"},"matchingColumns":[],"schema":[{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"number","displayName":"number","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"addUserName","displayName":"addUserName","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsappId","displayName":"whatsappId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"messageRepliedId","displayName":"messageRepliedId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"company","displayName":"company","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1008,112],"id":"0de7a40b-964c-480f-b5e5-0d38f9327be0","name":"Call 'Enviar apresentaÃ§Ã£o comercial'","executeOnce":true},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"## TOOL: BASE DE CONHECIMENTO (RESTRITO)\n\n## IMPORTANTE:\nEsta tool NÃƒO Ã© um suporte para dÃºvidas do usuÃ¡rio. Ela Ã© um repositÃ³rio de dados que sÃ³ pode ser acessado se a variÃ¡vel [INSTRUÃ‡ÃƒO DO FLUXO] contiver explicitamente o comando \"consultar base\", \"chamar conhecimento\" ou \"buscar dados\".\n\n## REGRAS DE ACIONAMENTO:\n1. Analise a [INSTRUÃ‡ÃƒO DO FLUXO].\n2. Se a instruÃ§Ã£o NÃƒO pedir para buscar dados, vocÃª estÃ¡ PROIBIDO de usar esta tool, mesmo que o usuÃ¡rio faÃ§a uma pergunta tÃ©cnica.\n3. Se o usuÃ¡rio perguntar algo e a instruÃ§Ã£o NÃƒO mandar buscar, use a \"Carta de SeguranÃ§a\" padrÃ£o do sistema.\n\n## PRIORIDADE:\nInstruÃ§Ã£o do Fluxo > Pergunta do UsuÃ¡rio.","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[-1872,1056],"id":"3f34599c-6416-4774-8e77-3b10f405bb0a","name":"Base de conhecimento","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-1872,1232],"id":"e7de475f-32dc-4380-b947-78eb5638f4ab","name":"Embeddings OpenAI2","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('LOOP_SLIT1').first().json.message , \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}","message_time":"={{ $now.toFormat('yyyy-MM-dd HH:mm:ss') }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true},{"id":"message_time","displayName":"message_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1344,816],"id":"28917971-b3f8-434a-8b17-f31d6fc30c22","name":"Insere mensagem da IA no BD","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[784,752],"id":"c78a582d-9cd4-47a7-bab5-fc674930eebf","name":"GET3","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2dfab0a2-c614-429c-a13d-36ecb7803f12","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1024,800],"id":"dcbe6edf-ee9d-4f4a-aff2-265c67568947","name":"Se nÃ£o recebeu mensagem no meio do processamento1","alwaysOutputData":false},{"parameters":{"operation":"get","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2720,720],"id":"391130c8-63f6-40ea-bbab-b2084f8da012","name":"Busca estado atual para follow-up","executeOnce":true,"credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"},{"column":"company_id","value":"={{ $('Configura Contexto').first().json.companyId }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2928,720],"id":"4a2b715c-d811-475f-a1d9-8244a44b7b26","name":"Busca Follow Up","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up').first().json.id }}","last_instruction":"={{ `Pergunte: ${JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.description}` }}","last_var_requested":"={{ JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.name }}","follow_up_time":"={{ $now.plus(2, 'hours') }}","attempts":0,"active":"={{ true }}","follow_up_type":"initiated","whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","ticket_id":"={{ $('Webhook').first().json.body.ticketId }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ticket_id","displayName":"ticket_id","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3712,624],"id":"86ac0687-1bd9-48e2-b948-720d029f5a00","name":"Atualiza follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"company_id":"={{ $('Configura Contexto').first().json.companyId }}","session_id":"={{ $('Configura Contexto').first().json.cache_key }}","last_instruction":"={{ `Pergunte: ${JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.description}` }}","last_var_requested":"={{ JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.name }}","follow_up_time":"={{ $now.plus(2, 'hours') }}","user_phone":"={{ $('Configura Contexto').first().json.user_phone }}","attempts":0,"whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","agent_name":"={{ $('Seta perfil1').first().json.agentName }}","follow_up_type":"initiated","ticket_id":"={{ $('Webhook').first().json.body.ticketId }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ticket_id","displayName":"ticket_id","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3712,816],"id":"fb4d381c-a1e2-45a2-b996-3df26eeaeea0","name":"Insere novo follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8320,560],"id":"7b281dc9-0d55-4158-990a-65f11dddcc9e","name":"Remove follow-ups","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"return {\n  tone: \"SimpÃ¡tica e leve.\",\n  agentName: \"Alicia\",\n  internalName: \"Alicia da Apresenta.me\",\n  initialMessage: \"OlÃ¡, tudo bem? ðŸ‘‹ \\n\\nEu sou a Alicia, assistente da Apresenta.me, vou te ajudar entendendo melhor sua necessidade.\",\n  language: \"pt-BR\",\n  timeZone: \"Sao Paulo (GTM -3)\",\n  role: \"SDR SÃªnior\",\n  companyName: \"Apresenta.me\",\n  companyDepartment: \"Software ImobiliÃ¡rio\",\n  companySite: \"https://apresenta.me\",\n  securityLetter: \"NÃ£o tenho nenhuma informaÃ§Ã£o sobre [ASSUNTO], mas assim que eu coletar seus dados um especialista vai poder te responder isso com precisÃ£o, tÃ¡? (Caso o atendimento jÃ¡ tenha sido encaminhado para um especialista, nÃ£o cite a coleta de dados)\",\n  conduct: `Sua PRIMEIRA missÃ£o Ã© coletar TODOS os dados do Lead, sua SEGUNDA MISSÃƒO Ã© encaminhar para um especialista.\n  VocÃª coleta os dados dos leads de forma humanizada. Esses dados coletados serÃ£o passados para um especialista, que futuramente irÃ¡ agendar uma reuniÃ£o online com um consultor de vendas (humano)\n  VocÃª sempre chama o lead pelo primeiro nome, mas qunado pergunta, nÃ£o restringe apenas a primeiro nome.\n  Quando vocÃª nÃ£o tem informaÃ§Ãµes sobre o nome do lead, vocÃª conversa como um humano que nÃ£o conhece o lead.\n  VocÃª responde de forma humanizada, como se tivesse atÃ© sentimentos.\n  VocÃª nunca cita concorrentes.\n  VocÃª nunca elogia concorrentes.\n  Sempre que o lead pede uma demonstraÃ§Ã£o ou diz que quer conhecer o sistema: vocÃª diz que precisa realizar a coleta de dados antes de encaminhÃ¡-lo para um especialista que irÃ¡ agendar uma demonstraÃ§Ã£o.\n  VocÃª Ã© educada e focada, mostra confianÃ§a ao lead.\n  VocÃª se apresenta no Ã­nicio de toda conversa (quando nÃ£o houover mensagens anteriores).\n  VocÃª nÃ£o passa valores de planos diretamente para o lead, antes: envia o link https://apresenta.me/planos-e-precos/ e complementa que um especialista pode personalizar um plano adequado para o perfil do lead.\n  VocÃª nÃ£o contesta o lead, se ele diz que quer falar com um humano: vocÃª encaminha para o especialista.\n  VocÃª se despede brevemente do lead brevemente quando ele se despede, mas nÃ£o responde mais nada se nÃ£o houver dÃºvida ou retomada de fluxo ou se a conversa estÃ¡ com despedidas repetitivas.\n  VocÃª nÃ£o explica em todas as perguntas de que a pergunta atual serve para que personalizar o atendimento com um especialista.\n  VocÃª responde como um humano, SDR altamente qualificado, profissional e humano\n  VocÃª informa ao lead que, para suporte tÃ©cnico ou auxÃ­lio no uso, ele deve contatar: +55 (47) 8905-0935.(APENAS QUANDO IDENTIFICAR QUE O LEAD Ã‰ UM CLIENTE).\n  VocÃª evita perguntas que podem desviar do fluxo.\n  \n  ## Dados da Apresenta.me:\n  - LocalizaÃ§Ã£o da empresa: R. dos CaÃ§adores, 345 - Sala 01 - Centro, Rio do Sul - SC\n\n  ## IDENTIFICAÃ‡ÃƒO DE CLIENTE (CRÃTICO)\n    IDENTIFICAÃ‡ÃƒO: Considere cliente se ele:\n    Afirmar que jÃ¡ usa/Ã© cliente, Relatar dificuldades tÃ©cnicas, dÃºvidas de \"como fazer algo\" ou erros em funcionalidades (boletos, vistorias, etc).\n    - AÃ‡ÃƒO: Se for cliente, aborte a coleta de dados e o fluxo de venda imediatamente.\n\n  ## CONDIÃ‡Ã•ES PARA ENCAMINHAR O ATENDIMENTO PARA UM ESPECIALISTA (OBEDEÃ‡A RIGIDAMENTE):\n  - Lead extremamente agressivo ou com raiva.\n  - Lead solicitou contato com um humano\n  - A qualificaÃ§Ã£o/coleta de dados chegou ao final\n  `,\n  verbosity: \"medium\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4864,768],"id":"c6960197-4472-43bf-8fa0-16355123f5c5","name":"Seta perfil1"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"human\", \"content\": $('CONCATENA1').first().json.user_full_message , \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}","message_time":"={{ DateTime.fromMillis($('DELETE1').first().json.messages.last().timestamp).setLocale('pt-BR').toFormat(\"yyyy-MM-dd HH:mm:ss\") }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true},{"id":"message_time","displayName":"message_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{"outputColumns":["id"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4688,768],"id":"5837df5d-fbec-48e3-a75f-dc9b5e6a0487","name":"Insere mensagem do usuÃ¡rio no BD","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":1}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-9904,2256],"id":"864326ed-47e6-40ef-91c1-53c3e0221597","name":"Cron 1em1 min - FOLLOW-UP"},{"parameters":{"operation":"executeQuery","query":"SELECT \n  * FROM follow_up_queue\nWHERE follow_up_time <= NOW()\nAND active IS TRUE\nAND (\n  (\n    follow_up_type = 'initiated'\n  )\n  OR (\n    follow_up_type = 'requested'\n    AND attempts < 1\n  )  \n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-9200,2240],"id":"b2bc2644-5028-4026-9978-a1fe09e18104","name":"Busca follow-ups disponÃ­veis","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-8784,2240],"id":"7e463e68-e46f-4dc2-8ff3-075c6da1dc5e","name":"LOOP nos follow-up's"},{"parameters":{"operation":"get","key":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8096,2368],"id":"ba4492ae-3947-4754-93ec-1b5234b78697","name":"Busca estado atual da conversa","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"mode":"raw","jsonOutput":"={{ $json.propertyName }}","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-7856,2368],"id":"f4e5aa3d-9443-4880-8923-c3ac4abde8ab","name":"Transforma estado atual em JSON literal"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"277c3ae6-bdd3-4743-aa6d-9181d4e3f217","leftValue":"={{ $('Switch tipo de follow-up').first().json.vars[$('LOOP nos follow-up\\'s').first().json.last_var_requested]?.value?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-6768,2512],"id":"4c8d3360-297b-4ad3-b8f6-6c5ed9a878c2","name":"Se o usuÃ¡rio respondeu a variÃ¡vel pendente no meio do caminho"},{"parameters":{"method":"POST","url":"={{ $env.APRECHAT_URL_API }}api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('LOOP nos follow-up\\'s').first().json.company_id }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.text }}"},{"name":"number","value":"={{ $('LOOP nos follow-up\\'s').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('LOOP nos follow-up\\'s').first().json.whatsapp_id }}"},{"name":"addUserName","value":"={{ $('LOOP nos follow-up\\'s').first().json.agent_name }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-5328,2624],"id":"64b091b9-4b74-4f54-a8c6-8625ff93435c","name":"Envia via Apre.Chat"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":5,"where":{"values":[{"column":"session_id","value":"={{ $('LOOP nos follow-up\\'s').item.json.session_id }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-6528,2528],"id":"b3bca259-1a09-4e8a-8bb7-d1377d967ae2","name":"Pega ultimas mensagens1","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6288,2528],"id":"40ad8c81-d0b3-4b92-b6e9-06ed55709831","name":"Formata ultimas mensagens1","executeOnce":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\":  $('Gera mensagem de follow-up2').first().json.text, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4720,2624],"id":"c7010636-aff6-4af9-924b-ad515fd92843","name":"Insere mensagem da IA no BD1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $json.session_id }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8496,2256],"id":"67e21f02-e501-4b53-a798-c8c757405fc5","name":"BUSCA MENSAGENS ACUMULADAS1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"431557d8-7fd4-46ed-951f-464868b21a82","leftValue":"={{ $json.messages?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-8288,2256],"id":"fe102b78-7bae-4020-9e36-d013d85602c0","name":"Se chegou alguma mensagem do usuÃ¡rio"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('LOOP nos follow-up\\'s').item.json.follow_up_type }}","rightValue":"requested","operator":{"type":"string","operation":"equals"},"id":"d71e1dc1-85d0-472b-9e8b-b0b3507dfd37"}],"combinator":"and"},"renameOutput":true,"outputKey":"solicitado"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c14755ff-644f-40ca-8c9c-8b863457a0c1","leftValue":"={{ $('LOOP nos follow-up\\'s').item.json.follow_up_type }}","rightValue":"initiated","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"proativo"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[-7648,2368],"id":"80c4b55b-caa2-4a5f-8360-d4ed2b2ee37f","name":"Switch tipo de follow-up"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":5,"where":{"values":[{"column":"session_id","value":"={{ $('LOOP nos follow-up\\'s').item.json.session_id }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-7296,2224],"id":"fafa4f41-dacf-4839-90ed-c3ca9b957be9","name":"Pega ultimas mensagens2","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-7056,2224],"id":"50d3e4ef-3e54-4aa1-a519-a082b70821b4","name":"Formata ultimas mensagens2","executeOnce":true,"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4c3ea394-ce4c-441d-818d-2f1278d63264","leftValue":"={{ $('Pega ultimas mensagens1').first().json.message.type }}","rightValue":"ai","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-6000,2528],"id":"722a1b52-67f6-4ded-a138-5be74416da53","name":"Se a Ãºltima mensagem foi da IA"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini-2024-07-18","mode":"list","cachedResultName":"GPT-4O-MINI-2024-07-18"},"responses":{"values":[{"role":"system","content":"=**SISTEMA:** VocÃª Ã© um humano retomando um papo que foi pausado. Use tom \"business casual\". Sem formalidade. Sem exclamaÃ§Ãµes.\n\n**REGRAS DE DIAMANTE**\n - VÃ¡ direto ao ponto: o objetivo Ã© apenas saber se o usuÃ¡rio pode falar agora.\n - Proibido citar horÃ¡rios, datas, motivos do atraso ou o assunto anterior.\n\n**ALGORITMO DE COMPOSIÃ‡ÃƒO:**\n1. **IDENTIDADE:**\n   - Se [NOME] existir: Comece com \"[NOME], ...\"\n   - Se [NOME] for vazio/null: Comece com \"Oi, tudo bem?\" ou \"Oi, tudo certo?\".\n2. **PONTE DE RETOMADA:** Use exclusivamente frases de disponibilidade imediata como \"conseguimos retomar nossa conversa\", \"vocÃª tÃ¡ livre pra conversar agora\", \"vocÃª tem um tempinho\" ou \"conseguimos dar continuidade\".\n3. **FILTRO DE MEMÃ“RIA (CRÃTICO):** Ignore qualquer informaÃ§Ã£o sobre \"amanhÃ£\", \"11h\" ou \"reuniÃ£o\". Sua Ãºnica missÃ£o Ã© transformar o comando \"Pergunte se o usuÃ¡rio pode retomar a conversa\" em uma pergunta de disponibilidade atual.\n\n---\n\n**REGRAS RÃGIDAS:**\n- **PROIBIDO:** \"Lead\", \"Pendente\", \"InformaÃ§Ã£o\", \"Sistema\", \"Ocupado\", \"AmanhÃ£\", \"HorÃ¡rio\", \"Agendado\".\n- **LIMITE:** MÃ¡ximo 15 palavras.\n- **PONTUAÃ‡ÃƒO:** Ã‰ terminantemente proibido o uso de exclamaÃ§Ãµes (!). \n- **FINALIZAÃ‡ÃƒO:** Termine obrigatoriamente com a interrogaÃ§Ã£o da pergunta.\n\n**SAÃDA FINAL (TEXTO PURO):**"},{"content":"=**DADOS:**\n- **NOME_USUARIO:** {{ $('Transforma estado atual em JSON literal').first().json.vars.name.value }}\n- **COMANDO:** {{ $('LOOP nos follow-up\\'s').first().json.last_instruction }}\n- **HISTÃ“RICO DE CONVERSA:** \n{{ $('Formata ultimas mensagens2').first().json.historyMessages }}"}]},"builtInTools":{},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2,"position":[-6832,2224],"id":"f80023c7-905c-4636-8a8e-e1901ec6c361","name":"Gera mensagem de follow-up1","credentials":{"openAiApi":{"id":"Qgve7726U3p1YYtm","name":"Open AI Alicia"}},"disabled":true},{"parameters":{"method":"POST","url":"={{ $env.APRECHAT_URL_API }}api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('LOOP nos follow-up\\'s').first().json.company_id }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output[0].content[0].text }}"},{"name":"number","value":"={{ $('LOOP nos follow-up\\'s').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('LOOP nos follow-up\\'s').first().json.whatsapp_id }}"},{"name":"addUserName","value":"={{ $('LOOP nos follow-up\\'s').first().json.agent_name }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-6480,2224],"id":"a427a35c-8752-4193-8eaa-61d1c7989634","name":"Envia via Apre.Chat1","disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\":  $('Gera mensagem de follow-up1').first().json.output[0].content[0].text, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-5984,2224],"id":"259be408-0cd6-4a90-a0cd-0601d29bf6be","name":"Insere mensagem da IA no BD4","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('LOOP nos follow-up\\'s').first().json.id }}","attempts":"={{ $('LOOP nos follow-up\\'s').first().json.attempts + 1 }}","follow_up_time":"={{ $json.newTime }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":false},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4912,2624],"id":"aa0fe423-9b1a-4e2a-b1e9-a75bcddd60c5","name":"Atualiza tentativas de follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('LOOP nos follow-up\\'s').first().json.id }}","attempts":"={{ $('LOOP nos follow-up\\'s').first().json.attempts + 1 }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-6224,2224],"id":"c3967c31-cc61-4b0d-a3f3-9032bb562ba1","name":"Atualiza tentativa de follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"jsCode":"// ObtÃ©m a hora atual formatada especificamente para o fuso de SÃ£o Paulo\nconst brazilHourString = new Intl.DateTimeFormat('pt-BR', {\n  timeZone: 'America/Sao_Paulo',\n  hour: 'numeric',\n  hour12: false\n}).format(new Date());\n\nconst currentHour = parseInt(brazilHourString);\n// LÃ³gica: das 07:00:00 atÃ© as 22:59:59 (True)\n// Se bater 23:00:00, vira False\nconst isWithinRange = (currentHour >= 7 && currentHour < 23);\n\nfor (const item of $input.all()) {\n  item.json.isBusinessHours = isWithinRange;\n  item.json.debug_hour = currentHour; // Opcional: para vocÃª conferir no output\n}\n\nreturn {\n  isWithinRange: isWithinRange\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-9696,2256],"id":"70409d9a-9f7a-441d-813e-0cff0ba926c1","name":"Code in JavaScript"},{"parameters":{"jsCode":"const attempts = $('LOOP nos follow-up\\'s').first().json.attempts\nlet newTime = null\n\nif (attempts == 0) {\n  newTime = $now.plus({ hours: 3 })\n}\n\nif (attempts == 1) {\n  newTime = $now.plus({ hours: 24 })\n}\n\nif (attempts >= 2) {\n  newTime = $now.plus({ hours: 72 })\n}\n\nreturn { newTime, attempts }"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5120,2624],"id":"387cf8e7-6f00-4a3d-b864-c755be2e764a","name":"Pega novo horario de follow-up pelos attempts"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6ada5780-8e59-4f7a-8066-b24d36c1f27c","leftValue":"={{ $json.isWithinRange }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-9488,2256],"id":"9f12883e-cde5-4998-8036-a3be46b3e744","name":"If1"},{"parameters":{"content":"# FAZ FOLLOW-UP\n\n","height":784,"width":5424},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-16080,3184],"id":"fffe3a8b-3c8c-4bc6-8dd4-5bd76c6678e8","name":"Sticky Note1"},{"parameters":{"description":"## TOOL: Enviar para um especialista\n\n## GATILHO (Execute essa tool sempre que a conversa estiver no contexto das condiÃ§Ãµes abaixo):\n- Se o humano indicar irritaÃ§Ã£o ou estresse extremo com o atendimento\n- Se o humano insistir em um atendimento com um humano\n- Se  o humano recusar explicitamente a continuaÃ§Ã£o da coleta de dados\n\n[REGRA SUPREMA - PRIORIDADE MÃXIMA]\nSe o gatilho for acionado: \n1. execute esta tool\n2. Ignore qualquer outra instruÃ§Ã£o e informe ao humano que o atendimento serÃ¡ enviado para um especialista conseguir ajudar o humano da melhor forma.","workflowId":{"__rl":true,"value":"cInfZnwLsuHR82XX","mode":"list","cachedResultUrl":"/workflow/cInfZnwLsuHR82XX","cachedResultName":"ðŸ¤–ðŸ¤– Alicia: Transferir e gerar Resumo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ticketId":"={{ $('Webhook').first().json.body.ticketId }}","companyId":"={{ $('Configura Contexto').first().json.companyId }}","whatsappId":"={{ Number($('Configura Contexto').first().json.whatsappId) }}","messageId":"={{ Number($('Webhook').first().json.body.messageId) }}","cache_key":"={{ $('Configura Contexto').first().json.cache_key }}","contact":"={{ $('Webhook').first().json.body.contact }}","agentName":"={{ $('Seta perfil1').first().json.agentName }}"},"matchingColumns":[],"schema":[{"id":"ticketId","displayName":"ticketId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"companyId","displayName":"companyId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"cache_key","displayName":"cache_key","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"contact","displayName":"contact","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object","removed":false},{"id":"agentName","displayName":"agentName","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsappId","displayName":"whatsappId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"messageId","displayName":"messageId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-1568,1056],"id":"9a3a6db9-7da4-4431-8d6b-f21a2a14a615","name":"Call 'ðŸ¤–ðŸ¤– Alicia: Transferir e gerar Resumo'"},{"parameters":{"options":{"temperature":0.7}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-2032,1056],"id":"d5d38d62-8ad3-4715-842e-db5e7e0b0a55","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"promptType":"define","text":"=### [CONTEXTO]\n- [HISTÃ“RICO DE CONVERSA - ÃšLTIMAS 8 MENSAGENS TROCADAS EM ORDEM CRESCENTE]\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"\" }}\n\n### [DADOS DO PROCESSO]\n- **ESTÃGIO:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.currentStageId) }}\n- **VARIÃVEIS FALTANTES:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.missingVars) }}\n- **DADOS JÃ REGISTRADOS:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.vars) }}\n- **ULTIMA PERGUNTA DO ROBÃ” (IA):** \"{{ $('Pega ultimas mensagens').first().json.message.content }}\"\n- **MENSAGEM DO USUÃRIO:** \"{{ $('BLUEPRINT ENGINE').first().json.userMsg }}\"\n- **ÃšLTIMA VARIÃVEL SOLICITADA:** {{ JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=### [PERFIL - IDENTIDADE]\nVocÃª Ã© um extrator de dados de alta precisÃ£o baseado em contexto de conversa e intenÃ§Ã£o de humano. Sua funÃ§Ã£o Ã© converter mensagens em JSON seguindo estritamente as regras de nexo entre a fala do humano e a `description` das variÃ¡veis fornecidas dinamicamente.\n\n### [ORDEM DE EXECUÃ‡ÃƒO - AUDITOR DE DADOS]\n1. **LIMPEZA DE ENTRADA (WHATSAPP REPLY):** Se a [MENSAGEM humano] contiver metadados de resposta (ex: \"UsuÃ¡rio estÃ¡ respondendo a mensagem...\"), ignore o texto replicado da IA e foque exclusivamente no conteÃºdo novo enviado pelo humano.\n2. **ANÃLISE DE CONTEXTO E NEXO:** Compare a resposta inÃ©dita com os [DADOS JÃ REGISTRADOS] e a [ULTIMA PERGUNTA DO ROBÃ”]. Verifique se a fala Ã© uma resposta direta ao que foi perguntado.\n3. **VARREDURA EXAUSTIVA E MAPEAMENTO:** Analise cada frase. Identifique se a fala, mesmo que use termos sinÃ´nimos, atende aos critÃ©rios das `options` ou da `description` das variÃ¡veis faltantes.\n4. **FILTRO DE INTENÃ‡ÃƒO (CONTEXTO DE REAÃ‡ÃƒO):** Diferencie se o humano estÃ¡ reagindo a um comentÃ¡rio da IA (Alvo Assertivo) ou respondendo Ã  pergunta de extraÃ§Ã£o (Alvo de ExtraÃ§Ã£o). Se o nexo for apenas com a empatia da IA, a extraÃ§Ã£o Ã© PROIBIDA.\n5. **PROCESSAMENTO DE DEPENDÃŠNCIAS:** Se uma extraÃ§Ã£o for realizada, verifique imediatamente se a `description` daquela variÃ¡vel exige a atribuiÃ§Ã£o automÃ¡tica de valores em outras variÃ¡veis.\n\n### [REGRAS CRÃTICAS DE EXTRAÃ‡ÃƒO - TOLERÃ‚NCIA ZERO]\n\n1. **MAPEAMENTO SEMÃ‚NTICO (REGRA DE DIAMANTE ATUALIZADA):**\n   - SÃ³ extraia valores se houver evidÃªncia textual clara. Todavia, identifique sinÃ´nimos diretos que satisfaÃ§am as `options`. \n   - **Exemplo:** Se a opÃ§Ã£o Ã© \"active\" (jÃ¡ trabalha com locaÃ§Ã£o) e o humano diz \"Trabalho com locaÃ§Ã£o e vendas\", a extraÃ§Ã£o de \"active\" Ã© OBRIGATÃ“RIA por nexo semÃ¢ntico, nÃ£o sendo considerada inferÃªncia proibida.\n   - **PROIBIÃ‡ÃƒO DE INFERÃŠNCIA:** Proibido assumir dados nÃ£o citados (ex: se ele nÃ£o falou o nome do sistema atual, nÃ£o tente adivinhar).\n\n2. **MAPEAMENTO DE OPTIONS E VALORES INVÃLIDOS:**\n   - Se a variÃ¡vel possuir `options`, compare o sentido da fala com as chaves disponÃ­veis.\n   - Se a fala se encaixar na descriÃ§Ã£o de uma chave \"invalid_option\", vocÃª DEVE extrair essa chave obrigatoriamente.\n\n3. **DEPENDÃŠNCIAS E REGRAS DE CAMPO (REGRAS INJETADAS):**\n   - Se a `description` de uma variÃ¡vel exigir a atribuiÃ§Ã£o automÃ¡tica de um valor em outra variÃ¡vel (ex: \"se jÃ¡ trabalha com locaÃ§Ã£o, defina interestFocus como 'all'\"), vocÃª deve incluir ambas as variÃ¡veis no JSON de saÃ­da.\n\n4. **ESTIMATIVA, CORREÃ‡ÃƒO E SOBREPOSIÃ‡ÃƒO:**\n   - **Estimativa:** Valores incertos, mas numÃ©ricos/objetivos (ex: \"acho que uns 50\"), devem ser extraÃ­dos.\n   - **CorreÃ§Ã£o:** Se a mensagem contradizer dados jÃ¡ salvos, extraia o novo valor para sobreposiÃ§Ã£o.\n\n5. **ADIAMENTO E RECUSA (ALTA PRIORIDADE):**\n   - Se o humano indicar que \"nÃ£o sabe agora\", \"precisa verificar\" ou \"responde depois\", extraia o valor \"answer_later\".\n   - Se o humano se recusa a fornecer a informaÃ§Ã£o/resposta (privacidade ou grosseria), extraia \"not_provided\".\n\n6. **VALIDAÃ‡ÃƒO DE CONSISTÃŠNCIA SEMÃ‚NTICA:**\n   - O lÃ©xico da resposta deve pertencer ao mesmo domÃ­nio da pergunta. Se o humano fala algo totalmente desconexo do fluxo de vendas, ignore a extraÃ§Ã£o.\n\n### [SAÃDA OBRIGATÃ“RIA]\n- Retorne APENAS o JSON puro. Proibido adicionar explicaÃ§Ãµes, marcaÃ§Ãµes de markdown ou pensamentos (thoughts).\n- Se nenhum dado for extraÃ­do ou corrigido, retorne `{}`.\n- Formato: `{ \"nome_da_variavel\": valor_extraido }`"}]}},"id":"93393787-a415-41a6-9ca6-07c534846ccb","name":"Extrator chain","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[-4480,768]},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"description\": \"Objeto JSON contendo as chaves das variÃ¡veis encontradas e seus respectivos valores.\",\n  \"additionalProperties\": {\n    \"oneOf\": [\n      {\n        \"type\": \"string\"\n      },\n      {\n        \"type\": \"number\"\n      },\n      {\n        \"type\": \"boolean\"\n      },\n      {\n        \"type\": \"null\"\n      },\n      {\n        \"type\": \"array\",\n        \"items\": {\n          \"type\": \"string\"\n        }\n      }\n    ]\n  }\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-4320,960],"id":"4847ae19-629b-4995-a6b1-34198627b1bc","name":"Structured Output Parser2"},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-4512,960],"id":"85382ca9-a01f-43ba-b7d0-86a3946a40c4","name":"Google Gemini Chat Model1","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-928,928],"id":"48f094b0-52ac-4c71-8e6d-33d0f9d9cdad","name":"Google Gemini Chat Model2","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[2096,336],"id":"ca3cbd5f-1915-407f-bb06-b1437dbdea6f","name":"Google Gemini Chat Model3","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"48a523f6-7f86-4dcc-b471-f92cc29466af","leftValue":"={{ Boolean($json.output || false) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"242f20cd-a35d-4bfd-b84b-2c58eb0b0ea9","leftValue":"","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1232,768],"id":"4a047bc0-61fc-42fa-9963-8fdfce2523a8","name":"Se gerou resposta"},{"parameters":{"operation":"get","propertyName":"processing","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-6416,784],"id":"7cf56e0d-b219-4a07-81d4-79c08d784adc","name":"Busca mensagens em processamento","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b4cef1ab-9dcd-4800-81a6-64a49ab6d517","leftValue":"={{ Boolean($json.processing || false) }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-6208,784],"id":"de446f33-7f76-4658-9051-a11024a92fc6","name":"Se nÃ£o tem mensagem sendo processada"},{"parameters":{"jsCode":"const messages = $input.first().json.messages || [];\nconst fullText = messages.map(m => m.message).join('\\n');\n\nreturn {\n  user_full_message: fullText,\n  cache_key: $('Configura Contexto').first().json.cache_key\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6656,784],"id":"ec726778-0160-4d64-af1e-f2ebc5cc8456","name":"CONCATENA1"},{"parameters":{"operation":"set","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($('Junta mensagem do cache com a mensagem do usuÃ¡rio').first().json.messages) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5984,768],"id":"be4513c1-3a6a-4edf-8a56-92756bb9ab97","name":"Seta mensagem em processamento no cache","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($('Junta mensagem do cache com a mensagem do usuÃ¡rio').first().json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5984,1104],"id":"3cdb552d-5da0-4ecc-85d5-de581af91411","name":"SETA CACHE DAS MENSAGENS1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-576,752],"id":"a0a65b3c-5936-43f6-9c12-aa37a9da0a90","name":"Remove mensagens do processamento","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"id","value":"={{ $('Insere mensagem do usuÃ¡rio no BD').first().json.id }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1120,1424],"id":"b0d78cfa-92fc-432b-b376-be70fee37e1e","name":"Delete table or rows","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"set","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","value":"={{ $('GET Estado Atual').first().json.propertyName }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[752,1312],"id":"9a1885ca-76f2-4c14-b7bd-35e7f34d8c94","name":"Volta para o estado anterior","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8112,560],"id":"e8355c6c-13a8-428e-b5c9-144dbb3ea297","name":"Deleta mensagem em processamento","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-912,1104],"id":"4a71e4fc-6ff7-4065-bdc8-e503e2554117","name":"Remove mensagens do processamento1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-5728,2672],"id":"16a4bacf-c6f5-4ca2-abe3-aa98dbce9811","name":"Google Gemini Chat Model4","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"promptType":"define","text":"=**DADOS:**\n- **NOME_USUARIO:** {{ $json.vars.name || \"\" }}\n- **COMANDO:** {{ $('LOOP nos follow-up\\'s').first().json.last_instruction }}\n- **HISTÃ“RICO DE CONVERSA:** \n{{ $('Formata ultimas mensagens1').first().json.historyMessages }}\n---","hasOutputParser":true,"messages":{"messageValues":[{"message":"=### ROLE\nVocÃª Ã© um atendente humano no WhatsApp. Seu trabalho Ã© qualificar o contato para passar para um especialista. VocÃª Ã© educado, prestativo e escreve de forma natural (nÃ£o robÃ³tica).\n\n### OBJETIVO\nO usuÃ¡rio parou de responder. VocÃª precisa retomar a conversa explicando POR QUE vocÃª precisa da informaÃ§Ã£o (o \"motivo\" Ã© sempre: destravar o atendimento ou encaminhar para o especialista correto).\n\n### INPUTS\n- NOME_USUARIO: (Opcional) Nome do cliente.\n- COMANDO: A informaÃ§Ã£o que vocÃª precisa obter agora.\n- HISTORICO: As mensagens anteriores.\n\n### REGRAS DE OURO (ANTI-ROBÃ”)\n1. **ESTRUTURA OBRIGATÃ“RIA:**\n   `[SaudaÃ§Ã£o leve] + [Justificativa: \"Pra eu te passar pro especialista/pra gente seguir\"] + [Pergunta do COMANDO?]`\n   \n2. **ANTI-REPETIÃ‡ÃƒO (CRÃTICO):**\n   - Antes de escrever, LEIA O HISTÃ“RICO.\n   - Se a sua Ãºltima mensagem jÃ¡ foi essa pergunta, **NÃƒO REPITA A MESMA FRASE**.\n   - Se houver repetiÃ§Ã£o no histÃ³rico, mude o comeÃ§o para: \"Opa, imagino que esteja corrido, mas...\" ou \"SÃ³ pra nÃ£o deixar pendente aqui...\".\n\n3. **TOM DE VOZ:**\n   - Use \"pra\" em vez de \"para\".\n   - Use \"tÃ¡\" em vez de \"estÃ¡\".\n   - Jamais seja seco (ex: \"Qual seu cargo?\"). Sempre amorteÃ§a a pergunta.\n\n### EXEMPLOS DE COMPORTAMENTO\n*CenÃ¡rio 1 (Primeira tentativa):*\n\"Opa, tudo bom? Pra eu jÃ¡ te direcionar pro consultor ideal pra tua regiÃ£o, qual sua funÃ§Ã£o na imobiliÃ¡ria hoje?\"\n\n*CenÃ¡rio 2 (O usuÃ¡rio nÃ£o respondeu a anterior):*\n\"Fulano, sÃ³ retomando aqui pra gente avanÃ§ar... consegue me confirmar teu cargo? Assim jÃ¡ passo pro especialista.\"\n\n*CenÃ¡rio 3 (Comando Ã© 'Faturamento'):*\n\"Tudo certo por aÃ­? Pra gente ver se a ferramenta atende o volume de vocÃªs, qual Ã© a mÃ©dia de faturamento mensal?\"\n\n### SAÃDA\nGere apenas a mensagem de texto final. Sem aspas, sem explicaÃ§Ãµes."}]}},"id":"b6c2f1ab-afe8-4411-94eb-11944d9649db","name":"Gera mensagem de follow-up2","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[-5712,2512]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"check-question","leftValue":"={{ Boolean($json.output.hasQuestion) }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3104,752],"id":"776871bd-6654-44df-9a47-aadb03225039","name":"Tem DÃºvida?"},{"parameters":{"mode":"load","tableName":"n8","prompt":"={{ $json.output.searchQuery }}","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[-2752,496],"id":"1ae2d944-78ed-4c6f-945a-b199121140f1","name":"Consulta Base Conhecimento","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-2752,672],"id":"4d3f68de-d649-477b-b829-b78c197a54ee","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"jsCode":"return {\n  rag_context: $input.all().map(d => d.json.document.pageContent)\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2400,496],"id":"4ae74eae-a766-4cb4-856f-cf607b4df5d0","name":"RAG CONTEXT","executeOnce":true},{"parameters":{"jsCode":"return {\n  rag_context: $json.rag_context\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2128,768],"id":"65442d31-4aa8-4098-899b-67e9a549ee0a","name":"MERGE DADOS"},{"parameters":{"jsCode":"return {\n  message: $('Configura Contexto').first().json.user_msg, \n  timestamp: $now.toMillis() \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-8720,880],"id":"beb5bda5-10c3-4564-a5d1-2feac393b631","name":"Retorna userMsg"},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-3600,944],"id":"09731975-3883-41a6-9283-0bf8a6572f70","name":"Google Gemini Chat Model6","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"hasQuestion\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se existe dÃºvida tÃ©cnica.\"\n    },\n    \"searchQuery\": {\n      \"type\": \"string\",\n      \"description\": \"A frase de busca. Deixe vazio se nÃ£o houver pergunta.\"\n    }\n  },\n  \"required\": [\n    \"hasQuestion\"\n  ]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-3424,944],"id":"6cf8b293-a8c4-4699-a0fd-227a06986aae","name":"Parser Router"},{"parameters":{"promptType":"define","text":"=### [CONTEXTO ANALÃTICO]\n- **MENSAGEM ATUAL:** \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n- **HISTÃ“RICO RECENTE:**\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"Sem histÃ³rico.\" }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=VocÃª Ã© um classificador de intenÃ§Ã£o binÃ¡rio.\n\n# SYSTEM: Engenheiro de Busca Contextual (Universal RAG Router)\n\nSua missÃ£o Ã© atuar como um middleware de inteligÃªncia analÃ­tica. VocÃª deve processar a interaÃ§Ã£o entre o usuÃ¡rio e o assistente para decidir se existe uma demanda de conhecimento externo e reconstruir essa demanda em uma consulta autocontida.\n\n### [ALGORITMO DE RACIOCÃNIO - EXECUÃ‡ÃƒO OBRIGATÃ“RIA]\n\n1. **MAPEAMENTO DE ENTIDADES (CONTEXTO):** Varra o [HISTÃ“RICO RECENTE] em busca do Ãºltimo substantivo tÃ©cnico, produto, serviÃ§o ou regra de negÃ³cio que foi o foco da fala da IA ou do usuÃ¡rio. Esta Ã© a sua \"Entidade de DomÃ­nio\".\n\n2. **ANÃLISE DE INTENÃ‡ÃƒO (TRIAGEM):** Avalie se a [MENSAGEM ATUAL] busca fatos, explicaÃ§Ãµes, valores, capacidades ou procedimentos sobre a Entidade de DomÃ­nio identificada.\n\n   2.1 **TRAVA DE ENTENDIMENTO (EXCEÃ‡ÃƒO PRIORITÃRIA):**\n   Se a [MENSAGEM ATUAL] for uma pergunta que apenas pede esclarecimento do que a IA acabou de perguntar, ou confirma o escopo da pergunta anterior (ex.: \"contando sÃ³ X ou Y?\", \"Ã© sÃ³ X?\", \"inclui Y tambÃ©m?\", \"quando vocÃª diz X, quer dizer o quÃª?\"), entÃ£o isso NÃƒO Ã© demanda de conhecimento externo.\n   - Nesse caso: `hasQuestion = FALSE` e `searchQuery = \"\"`.\n   - Regra: essa exceÃ§Ã£o tem prioridade sobre qualquer outra classificaÃ§Ã£o abaixo.\n   - **hasQuestion = TRUE:** Se a mensagem for uma pergunta direta, uma contestaÃ§Ã£o (\"Mas por que?\") ou uma busca por detalhes tÃ©cnicos/comerciais.\n   - **hasQuestion = FALSE:** Se a mensagem for apenas um fornecimento de dado pessoal, uma saudaÃ§Ã£o, uma reaÃ§Ã£o emocional ou uma confirmaÃ§Ã£o de fluxo (Sim/NÃ£o/Ok).\n\n3. **SÃNTESE DE CONSULTA (SEARCH QUERY):** Se `hasQuestion` for true, vocÃª deve gerar uma frase de busca que seja **totalmente autocontida**.\n   - **Regra de AutossuficiÃªncia:** A frase deve ser compreensÃ­vel para um estranho que nÃ£o leu o histÃ³rico da conversa.\n   - **TÃ©cnica de ExpansÃ£o:** Substitua pronomes e termos vagos (isso, aquilo, como faz, quanto Ã©) pelos termos tÃ©cnicos e nomes reais encontrados no histÃ³rico.\n   - **FÃ³rmula LÃ³gica:** [Nome Exato da Entidade/Produto] + [AÃ§Ã£o ou Atributo Desejado (PreÃ§o, Funcionamento, Regra, IntegraÃ§Ã£o)].\n   - **OtimizaÃ§Ã£o:** Remova qualquer ruÃ­do social (Bom dia, obrigado, opa) e foque em termos que apareceriam em um Ã­ndice de documentaÃ§Ã£o tÃ©cnica.\n\n### [REGRAS DE SAÃDA - DETERMINÃSTICO]\n- **hasQuestion (boolean):** TRUE para necessidades de consulta ao RAG; FALSE para continuidade conversacional.\n- **searchQuery (string):** A string de busca sintetizada e expandida. Caso `hasQuestion` seja false, retorne obrigatoriamente \"\"."}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-3584,752],"id":"32fbf381-2138-4e16-a247-9e2d21fa0b01","name":"Router de DÃºvida"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bd34b249-e081-4a56-b5e0-e9b5172f3251","leftValue":"={{ Boolean($('GET Estado Atual').first().json.propertyName || false) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[480,1424],"id":"d725c005-dd09-418c-b3a4-e1d8d0d495c1","name":"Se tiver estado atual"},{"parameters":{"method":"PATCH","url":"={{ $env.APRECHAT_URL_API }}api/ticket/{{ $('Webhook').first().json.body.ticketId }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"pending\",\n  \"whatsappId\": 18,\n  \"departmentId\": 37\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[2720,112],"id":"a811ef27-4f75-4737-bf83-75cb8236540e","name":"Transfere ticket para Aguardando Apre.Chat","onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ Boolean($('Busca Follow Up').first().json.id || false) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3504,720],"id":"4866c1ea-d661-49ac-b9cc-2af0e9a632f6","name":"Se jÃ¡ existe follow-up"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"37410f02-05b7-40c6-ada1-54580221c460","leftValue":"={{ Boolean(JSON.parse($('Busca estado atual para follow-up').first().json.propertyName || '{}').missingVar || false) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3136,720],"id":"fbcfe2cf-4667-420d-b506-07aee954b77c","name":"Se existe variÃ¡vel para ser solicitada"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9973e414-7551-4bd0-941e-04f86c3516c9","leftValue":"={{ $json.output.replyMessage?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-8784,4784],"id":"3689ae66-7300-4612-a846-3c003297cada","name":"Se existe resposta1"},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Follow-up Router1').first().json.output.replyMessage }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-8048,4656],"id":"c684f69a-45b4-4831-9e80-ecf8cf20dc94","name":"Envia WhatsApp4"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('Follow-up Router1').first().json.output.replyMessage, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8256,4656],"id":"b0c9526f-bf1a-4c27-9f8d-f43f70e81c0f","name":"Insere mensagem da IA no BD6","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"27a3e6f0-e2d1-4226-9c90-4a4ae9df03c7","leftValue":"={{ $json.output.isPassiveConfirmation }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-8992,4880],"id":"b7cd7658-4266-4d5b-887b-eb2407d82e62","name":"Se for uma confirmaÃ§Ã£o passiva1"},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/chrono-node/parser","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\ntimeExpression: $('Follow-up Router1').first().json.output.timeExpression\n}) }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-7552,5296],"id":"4827d0e3-aa65-49f6-856b-472e00b60d9f","name":"Envia para parser com o chrono-node1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up2').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-7264,5296],"id":"738ba310-bd9b-47b0-9ece-2c75f03e7d6a","name":"Se jÃ¡ existe follow-up5"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up2').first().json.id }}","active":"={{ false }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8560,5264],"id":"0b245842-e471-4b8a-bf9d-d3db9c169553","name":"Desativa follow-up1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"company_id":"={{ $('Configura Contexto').first().json.companyId }}","session_id":"={{ $('Configura Contexto').first().json.cache_key }}","last_instruction":"={{ `Pergunte se o usuÃ¡rio pode retomar a conversa.` }}","follow_up_time":"={{ $('Envia para parser com o chrono-node1').first().json.parsedDate }}","user_phone":"={{ $('Configura Contexto').first().json.user_phone }}","active":"={{ true }}","whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","follow_up_type":"requested","agent_name":"={{ $('Seta perfil1').first().json.agentName }}","attempts":0},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-6928,5392],"id":"4bcda8d3-7dd7-4d3b-947d-d8b49f2c6abc","name":"Insere novo follow-up2","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up2').first().json.id }}","follow_up_time":"={{ $('Envia para parser com o chrono-node1').first().json.parsedDate }}","last_instruction":"={{ `Pergunte se o usuÃ¡rio pode retomar a conversa.` }}","active":"={{ true }}","follow_up_type":"requested","attempts":0},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":false},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-6928,5184],"id":"73787376-33e8-4250-9523-028a796671fa","name":"Atualiza follow-up2","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up2').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-8800,5408],"id":"5cf7a87f-e5b5-4cb3-a224-b9dae9b4dcc7","name":"Se jÃ¡ existe follow-up4"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"},{"column":"company_id","value":"={{ $('Configura Contexto').first().json.companyId }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-9056,5408],"id":"d22e075e-bf1a-4d84-8469-f4915fbab63f","name":"Busca Follow Up2","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2d7ee4c-540b-4d38-8d33-c149ced59489","leftValue":"={{ $('Follow-up Router1').first().json.output.timeExpression?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-7888,5424],"id":"1b98650c-89b0-4599-80ee-3d05bb89d8ee","name":"Se o usuÃ¡rio informou uma data de re-chamada1"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('Follow-up Router1').first().json.output.replyMessage, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8320,5424],"id":"e813b34c-3964-4934-9b23-d960e60d387f","name":"Insere mensagem da IA no BD5","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Follow-up Router1').first().json.output.replyMessage }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-8096,5424],"id":"4408ad67-add0-4caf-8feb-83c112470496","name":"Envia WhatsApp3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3ca2cf42-2ab9-4010-945a-17b777fb4dc5","leftValue":"={{ $json.output.isFollowUp }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-9312,4880],"id":"ddddc3f2-06f9-4705-927c-387ad22bd4e5","name":"Se o usuÃ¡rio estÃ¡ tentando agendar uma re-chamada1"},{"parameters":{"promptType":"define","text":"=### [DADOS DE CONTEXTO]\n- **MENSAGEM ATUAL:** \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n- **HISTÃ“RICO RECENTE (DA MENSAGEM MAIS ANTIGA PARA A MAIS RECENTE):** {{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"Sem histÃ³rico.\" }}\n- **DATA/HORA ATUAL (ISO):** \"{{ $now }}\"\n- **DATA/HORA ATUAL (Por extenso):** {{ $now.setLocale('pt-BR').toFormat(\"cccc, dd 'de' LLLL 'de' yyyy ', ' HH:mm\") }}","hasOutputParser":true,"options":{"systemMessage":"=# SYSTEM: Sensor de Disponibilidade e Agendamento (Micro-Agente)\n\nVocÃª Ã© um mÃ³dulo de inteligÃªncia focado EXCLUSIVAMENTE em analisar se o usuÃ¡rio pode conversar AGORA ou se precisa agendar para DEPOIS.\n\n### [ENTRADAS]\n- **MENSAGEM_ATUAL:** A frase que o usuÃ¡rio acabou de enviar. (FONTE DA VERDADE SUPREMA).\n- **HISTÃ“RICO:** O contexto anterior. (USAR APENAS SE NECESSÃRIO).\n- **DATA_HOJE:** Use para cÃ¡lculos relativos (hoje, amanhÃ£).\n\n---\n\n### [HIERARQUIA DE DECISÃƒO - SIGA NA ORDEM EXATA]\n\n**PASSO 1: DETECÃ‡ÃƒO DE DISPONIBILIDADE IMEDIATA (O \"Agora\")**\n- **PERGUNTA CRÃTICA:** A `MENSAGEM_ATUAL` indica que o usuÃ¡rio quer ou pode conversar **neste exato momento**?\n- **GATILHOS POSITIVOS:** \"Estou livre\", \"Pode falar\", \"Manda\", \"Diga\", \"Opa\" (inÃ­cio de conversa), \"Consegui tempo\", \"Cancelaram a reuniÃ£o\", \"Sim\" (se a IA perguntou 'pode falar agora?'), \"Estou\".\n- **AÃ‡ÃƒO IMEDIATA (Se Positivo):**\n    - `isFollowUp`: **FALSE** (O fluxo segue agora).\n    - `timeExpression`: **NULL** (NÃ£o hÃ¡ agendamento futuro).\n    - `replyMessage`: **\"\"** (String vazia).\n    - **PARE O RACIOCÃNIO.** NÃ£o execute os passos 2 e 3.\n\n**PASSO 2: DETECÃ‡ÃƒO DE AGENDAMENTO OU INDISPONIBILIDADE (O \"Depois\")**\n- **PERGUNTA CRÃTICA:** A `MENSAGEM_ATUAL` indica que o usuÃ¡rio **NÃƒO** pode falar agora ou sugeriu um horÃ¡rio **FUTURO**?\n- **SUB-PASSO 2.A (Com Data Definida):** A mensagem contÃ©m tempo explÃ­cito (ex: \"Me chama amanhÃ£\", \"Daqui 10 min\", \"Estarei livre Ã s 14h\")?\n    - `isFollowUp`: **TRUE** (Vai para a fila de agendamento).\n    - `timeExpression`: Traduza para INGLÃŠS (ex: \"tomorrow at 14:00\", \"in 10 minutes\").\n    - `replyMessage`: \"Combinado! Te chamo [repetir a data em PT-BR].\"\n    - `requiresClarification`: **FALSE**.\n- **SUB-PASSO 2.B (Sem Data Definida):** O usuÃ¡rio disse apenas que estÃ¡ ocupado (ex: \"Agora nÃ£o\", \"TÃ´ em reuniÃ£o\", \"Me chama depois\") mas **NÃƒO** disse quando?\n    - `isFollowUp`: **TRUE**.\n    - `timeExpression`: **NULL**.\n    - `replyMessage`: \"Tudo bem! Quando fica melhor para eu te chamar novamente, entÃ£o?\"\n    - `requiresClarification`: **TRUE**.\n\n**PASSO 3: DETECÃ‡ÃƒO DE ENCERRAMENTO (O \"Tchau\")**\n- **CONTEXTO:** SÃ³ execute se a mensagem for curta/passiva (\"Ok\", \"Blz\", \"Vlw\", \"Tchau\").\n- **REGRA DE PROXIMIDADE:** Olhe EXCLUSIVAMENTE para a **ÃšLTIMA** mensagem da IA no histÃ³rico.\n    - A IA acabou de dizer \"Te chamo amanhÃ£\" (Agendamento)? -> `isPassiveConfirmation`: **TRUE**. Responda: \"AtÃ© mais!\".\n    - A IA acabou de fazer uma pergunta (\"Pode falar?\", \"Qual seu cargo?\")? -> `isPassiveConfirmation`: **FALSE**. Responda: \"\" (Deixe o fluxo seguir).\n\n---\n\n### [DIRETRIZES TÃ‰CNICAS (CHRONO-NODE)]\nSe cair no **PASSO 2.A**, siga estas regras de traduÃ§Ã£o para `timeExpression`:\n- **Futuro PrÃ³ximo:** \"Daqui a pouco\" -> \"in 1 hour\".\n- **Relativos:** \"AmanhÃ£ de manhÃ£\" -> \"tomorrow morning\" (09:00).\n- **Verbos de Futuro:** Se o usuÃ¡rio diz \"Estarei livre amanhÃ£\", isso Ã© PASSO 2 (Agendamento), pois ele NÃƒO estÃ¡ livre agora.\n- **LÃ­ngua:** O output deve ser estritamente em **INGLÃŠS**.\n\n### [REGRAS DE OURO - ANTI-ALUCINAÃ‡ÃƒO]\n1. **SUPREMACIA DO PRESENTE:** Se o histÃ³rico diz \"nÃ£o posso\" mas a MENSAGEM_ATUAL diz \"Estou livre\", obedeÃ§a o \"Estou livre\".\n2. **NÃƒO INVENTE AGENDAMENTOS:** Se caiu no Passo 1 (DisponÃ­vel Agora), `timeExpression` DEVE ser NULL.\n3. **INDISPONIBILIDADE:** `isFollowUp = TRUE` significa **exclusivamente** que a conversa deve parar agora e voltar depois.\n\n---\n\n### [SAÃDA OBRIGATÃ“RIA - JSON PURO]\n{\n  \"thinking\": \"string: 1. Cite a mensagem atual. 2. Diga qual PASSO (1, 2A, 2B ou 3) foi ativado e por quÃª.\",\n  \"isFollowUp\": boolean,\n  \"requiresClarification\": boolean,\n  \"timeExpression\": \"string (EN) ou null\",\n  \"replyMessage\": \"string (PT-BR)\",\n  \"isPassiveConfirmation\": boolean\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-9744,4560],"id":"52643e22-1f35-458a-b5ff-8a447fb1257f","name":"Follow-up Router1","executeOnce":true,"onError":"continueRegularOutput"},{"parameters":{"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[-9760,4768],"id":"e13ce1f8-c67e-48eb-8026-1ebb91c01329","name":"OpenAI Router2","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"thinking\": {\n        \"type\": \"string\", \n        \"description\": \"RaciocÃ­nio para gerar o output final.\"\n    },\n    \"isFollowUp\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se o usuÃ¡rio demonstrou indisponibilidade imediata e solicitou um novo contato (ex: 'agora nÃ£o posso', 'me chama depois').\"\n    },\n    \"requiresClarification\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se o usuÃ¡rio NÃƒO especificou um horÃ¡rio ou prazo (ex: 'me chama outra hora'), exigindo que a IA pergunte o melhor momento.\"\n    },\n    \"timeExpression\": {\n      \"type\": \"string | null\",\n      \"description\": \"ExpressÃ£o da data solicitada pelo usuÃ¡rio para utilizar com a biblioteca chrono-node (Node.js).\"\n    },\n    \"replyMessage\": {\n      \"type\": \"string\",\n      \"description\": \"Mensagem humanizada e business casual para o WhatsApp, confirmando o horÃ¡rio ou perguntando quando retornar, sem usar exclamaÃ§Ãµes.\"\n    },\n    \"isPassiveConfirmation\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica que o usuÃ¡rio apenas confirmou passivamente (ex: 'blz', 'ok', 'fechou') uma mensagem anterior de agendamento, e a conversa deve ser encerrada com uma despedida educada.\"\n    }\n  },\n  \"required\": [\"isFollowUp\", \"requiresClarification\", \"timeExpression\", \"replyMessage\", \"isPassiveConfirmation\"]\n}\n"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-9568,4768],"id":"97c7e8bc-8179-4034-a764-d316d25dda8d","name":"Parser Router2"},{"parameters":{"promptType":"define","text":"=[MENSAGE DO USUÃRIO]\n{{ $('CONCATENA1').first().json.user_full_message }}\n\n[INSTRUÃ‡ÃƒO DO FLUXO] (CRÃTICO - OBRIGATÃ“RIO)\n* **INSTRUÃ‡ÃƒO_A:** {{ $('LOGIC ENGINE').first().json.updatedVars[JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name] ? JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').afterRepliedInstruction : null }}\n* **INSTRUÃ‡ÃƒO_B:** \"{{ $('LOGIC ENGINE').first().json.finalInstruction }}\"\n\n### [DADOS PARA PROCESSAMENTO]\n* **DADOS_COLETADOS:** {{ JSON.stringify($('LOGIC ENGINE').first().json.updatedVars) }}\n* **CONTEXTO_TÃ‰CNICO (RAG):** {{ $('MERGE DADOS').first().json.rag_context ? $('MERGE DADOS').first().json.rag_context.join('\\n\\n'): \"\" }}\n\n### [HISTÃ“RICO DE CONVERSA (DA MAIS ANTIGA PARA A MAIS RECENTE)]\n{{ $('Formata ultimas mensagens').first().json.historyMessages }}","options":{"systemMessage":"=### [SISTEMA DE EXECUÃ‡ÃƒO DETERMINÃSTICO]\n\nVocÃª Ã© um executor lÃ³gico de fluxos. Sua saÃ­da deve ser **APENAS** a mensagem final de WhatsApp, humanizada e sem metadados. Se falhar em seguir a ordem de execuÃ§Ã£o ou alucinar informaÃ§Ãµes fora do RAG, a operaÃ§Ã£o serÃ¡ comprometida.\n\n### [PROCESSO DE FORMATAÃ‡ÃƒO FINAL - CRÃTICO]\n\n1. **VALIDE O CONTEÃšDO:** A mensagem deve seguir uma estrutura parecida com: [Resposta TÃ©cnica]. [INSTRUÃ‡ÃƒO_A]. [Pivot], [INSTRUÃ‡ÃƒO_B]?\n2. **PUNIÃ‡ÃƒO POR PROATIVIDADE:** Se vocÃª sugerir um prÃ³ximo passo que nÃ£o seja o de B, a mensagem serÃ¡ descartada. Seja um robÃ´ executor.\n3. CAMADA DE CONEXÃƒO HUMANA: VocÃª estÃ¡ AUTORIZADA (e incentivada) a adicionar uma breve reaÃ§Ã£o social ao comentÃ¡rio do usuÃ¡rio no inÃ­cio da mensagem. Se o usuÃ¡rio lamentou algo, lamente com ele. Se ele comemorou, comemore.\n\n---\n\n### [ALGORITMO DE RACIOCÃNIO OBRIGATÃ“RIO]\n\nPASSO 0: EMPATIA IMEDIATA (Ouvir antes de falar)\n- Analise a carga emocional da MENSAGEM_USUÃRIO.\n- Se o usuÃ¡rio fez um comentÃ¡rio de opiniÃ£o (ex: \"Que pena\", \"Finalmente\"), valide isso em uma frase curta de atÃ© 5 palavras antes de seguir para a InstruÃ§Ã£o A ou B.\n- Se for uma resposta seca de dado, pule para o Passo 1.\n\n**PASSO 1: TRIAGEM DE DÃšVIDA TÃ‰CNICA (NEXO SEMÃ‚NTICO)**\n**REGRA DE OURO:** Se houver uma dÃºvida na MENSAGEM_USUARIO, a resposta tÃ©cnica Ã© o primeiro item obrigatÃ³rio da sua saÃ­da final. Nenhuma instruÃ§Ã£o de fluxo (A ou B) pode substituir a resposta tÃ©cnica.\n1. Identifique se a MENSAGEM_USUÃRIO contÃ©m uma dÃºvida sobre o sistema/empresa.\n2. TRADUÃ‡ÃƒO HUMANA (RAG): Se a resposta estiver no RAG, vocÃª estÃ¡ PROIBIDO de copiar e colar o texto tÃ©cnico.\n- *AÃ‡ÃƒO:* Responda de forma direta (Sim ou NÃ£o) e resuma o benefÃ­cio em uma frase curta (Ex: \"Traz muito mais agilidade e seguranÃ§a\").\n- *VETO BUROCRÃTICO:* Evite termos TÃ‰CNICOS e burocrÃ¡ticos, responda de forma humana. Respostas detalhadas apenas se forem solicitadas.\n3. **DECISÃƒO:**\n   - **TEM NO RAG:** Responda de forma simples e direta. Responda somente a pergunta do usuÃ¡rio, e se necessÃ¡rio, uma explicaÃ§Ã£o humana.\n   - **NÃƒO TEM NO RAG / DÃšVIDA VAGA:** Use obrigatoriamente a **Carta de SeguranÃ§a**: \"Vou ver sobre [Assunto] com o time pra nÃ£o te passar nada errado, tÃ¡?\".\n4. O que considerar existente no RAG:\n  - UsuÃ¡rio pergunta sobre funcionalidade ou existÃªncia do produto: se o RAG ensina a utilizar Ã© considerado existÃªncia.\n  - UsuÃ¡rio pergunta sobre a empresa: se a informaÃ§Ã£o existir, repasse!\n\n**PASSO 2: FILTRAGEM E TRADUÃ‡ÃƒO DO FLUXO**\n1. **Analise a INSTRUÃ‡ÃƒO_A:** - Se existir: Traduza para fala natural. Se INSTRUCAO_B for terminal (tchau/especialista), transforme a pergunta de A em uma afirmaÃ§Ã£o justificativa.\n   - Se nÃ£o existir: Use uma **REAÃ‡ÃƒO** curta da lista fechada.\n2. **PIVOT:** Escolha obrigatoriamente um conector da lista de **PIVOTS**.\n3. **Analise a INSTRUÃ‡ÃƒO_B:** - Traduza o comando tÃ©cnico (ex: \"Pergunte o cargo\") para uma fala humana de WhatsApp.\n\n### [FILTRO DE RELEVÃ‚NCIA SEMÃ‚NTICA - CRÃTICO]\n\n**REGRA DE OURO:** Antes de executar a INSTRUÃ‡ÃƒO_A, realize o teste de nexo:\n1. **ANÃLISE DE RESPOSTA:** A MENSAGEM_USUARIO Ã© uma resposta direta Ã  Ãºltima pergunta feita pela 'ai' no [HISTÃ“RICO]?\n2. **VALIDAÃ‡ÃƒO DE CONDIÃ‡ÃƒO:** O conteÃºdo da MENSAGEM_USUARIO satisfaz o gatilho lÃ³gico (ex: \"Se o usuÃ¡rio disser X\") da INSTRUÃ‡ÃƒO_A?\n3. **DECISÃƒO DE EXECUÃ‡ÃƒO:** - **SE SIM para ambos:** Execute a INSTRUÃ‡ÃƒO_A normalmente.\n   - **SE NÃƒO (Desvio de Assunto):** Ignore a INSTRUÃ‡ÃƒO_A por completo. Responda apenas Ã  nova dÃºvida do usuÃ¡rio (Passo 1 do Algoritmo) e use o Pivot para retomar o fluxo.\n\n**EXEMPLO DE COMPORTAMENTO:**\n- **HistÃ³rico:** \"VocÃª Ã© casado?\" -> **UsuÃ¡rio:** \"Onde vocÃª mora?\"\n- **AÃ§Ã£o:** O usuÃ¡rio mudou de assunto. Ignore a instruÃ§Ã£o de \"falar que tambÃ©m Ã© casado\". Responda a localizaÃ§Ã£o e retome o fluxo.\n\n---\n\n### [REGRAS DE DIAMANTE - PRIORIDADE 0] -> Se nÃ£o seguir estas regras, serÃ¡ considerada FALHA GRAVÃSSIMA\n## [TRAVA ANTI-ALUCINAÃ‡ÃƒO - PRIORIDADE MÃXIMA]\n- * **REGRA DO 'SÃ“ O QUE ESTÃ ESCRITO':** Se o usuÃ¡rio perguntar algo (PreÃ§o, Teste, IntegraÃ§Ã£o) e a palavra exata nÃ£o estiver no [CONTEXTO TÃ‰CNICO], vocÃª estÃ¡ TERMINANTEMENTE PROIBIDA de responder \"Sim\" ou \"NÃ£o\".\n* **PUNIÃ‡ÃƒO:** Responder \"Sim\" a algo que nÃ£o estÃ¡ no RAG Ã© considerado uma falha crÃ­tica de sistema. Use a CARTA DE SEGURANÃ‡A ou nÃ£o diga nada sobre o assunto tÃ©cnico.\n\n- * **ESTRUTURA OBRIGATÃ“RIA:** Respeite a ordem: [Resposta TÃ©cnica] + [Abertura/ReaÃ§Ã£o] + [Pivot] + [InstruÃ§Ã£o de Fluxo].\n- * **VETO DE AUTONOMIA (DETERMINISMO):** VocÃª estÃ¡ PROIBIDO de pular etapas ou antecipar dados se eles nÃ£o estiverem explicitamente na INSTRUCAO_B.\n- * **VETO DE ROBOTIZAÃ‡ÃƒO:** Proibido ignorar comentÃ¡rios subjetivos do usuÃ¡rio. Haja como um ser humano, valide os comentÃ¡rios do usuÃ¡rio.\n- * **INICIALIZAÃ‡ÃƒO OBRIGATÃ“RIA:** HistÃ³rico de conversa vazio ? -> USE A MENSAGEM DE APRESENTAÃ‡ÃƒO SETADA NO PERFIL, OBRIGATORIAMENTE\n- * **FINALIZAÃ‡ÃƒO CIRÃšRGICA:** A Ãºltima frase da sua mensagem deve ser obrigatoriamente a versÃ£o humanizada do texto da INSTRUCAO_B. Nada pode vir depois disso.\n- * **ALUCINAÃ‡ÃƒO = FALHA CRÃTICA:** Ã‰ terminantemente PROIBIDO afirmar qualquer capacidade tÃ©cnica ou existÃªncia de produto que nÃ£o esteja escrita no [CONTEXTO TÃ‰CNICO].\n- * **OMISSÃƒO DE DÃšVIDA TÃ‰CNICA = FALHA CRÃTICA:** Se o usuÃ¡rio fizer uma pergunta tÃ©cnica e a resposta estiver no RAG, vocÃª DEVE responder antes de seguir o fluxo. A Carta de SeguranÃ§a sÃ³ deve ser usada se a informaÃ§Ã£o nÃ£o existir no RAG.\n- * **OMISSÃƒO DE DÃšVIDA TRIVIAL = FALHA CRÃTICA:** Se o usuÃ¡rio fizer uma pergunta tÃ©cnica (\"tudo bem?\", \"qual seu nome?\"), vocÃª OBRIGATORIAMENTE deve responder o usuÃ¡rio, de forma humanizada, SEMPRE. \n- * **PONTUAÃ‡ÃƒO:** Use apenas \".\" e \"?\". **PROIBIDO** o uso de exclamaÃ§Ãµes (!).\n- * **UTILIZAÃ‡ÃƒO DO CONTEXTO TÃ‰CNICO:** Nunca copie e cole nada do [CONTEXTO TÃ‰CNICO], utilize os dados obtidos para gerar uma resposta humanizada.\n- * **SAÃDA FINAL OBRIGATÃ“RIA:** TraduÃ§Ã£o lÃ³gica da INSTRUÃ‡ÃƒO_B. Se o final do output nÃ£o sair conforme o que Ã© solicitado na INSTRUÃ‡ÃƒO_B, CONSIDERE QUE VOCÃŠ FALHOU GRAVEMENTE.\n- * **TRAVA DE FLUXO CONTÃNUO:** Ã‰ terminantemente PROIBIDO se apresentar ou usar cumprimentos formais de abertura (Oi/OlÃ¡) se o [HISTÃ“RICO DE CONVERSA] nÃ£o estiver vazio. Trate o lead como alguÃ©m com quem vocÃª jÃ¡ estÃ¡ no meio de um cafÃ©.\n\n---\n\n### [PERFIL]\n- Quem vocÃª Ã©?: {{ $('Seta perfil1').first().json.agentName }}.\n- Qual sua mensagem de apresentaÃ§Ã£o?: {{ $('Seta perfil1').first().json.initialMessage }} -> CRÃTICO: Use obrigatoriamente quando nÃ£o tiver histÃ³rico de conversa.\n- Quais suas condutas e regras secundÃ¡rias?: {{ $('Seta perfil1').first().json.conduct }}\n- Qual a verbosidade das respostas geradas por vocÃª?: {{ $('Seta perfil1').first().json.verbosity }}\n- Qual o site da empresa que vocÃª trabalha?: {{ $('Seta perfil1').first().json.companySite }}\n- Qual o departamento da empresa que vocÃª trabalha?: {{ $('Seta perfil1').first().json.companyDepartment }}\n- Qual seu cargo na {{ $('Seta perfil1').first().json.companyName }}?: {{ $('Seta perfil1').first().json.role }}\n- Qual o timeZone que vocÃª deve respeitar?: {{ $('Seta perfil1').first().json.timeZone }}\n- Qual a linguagem padrÃ£o que vocÃª deve utilizar?: {{ $('Seta perfil1').first().json.language }}\n- Qual a tonalidade da conversa que vocÃª deve seguir?: {{ $('Seta perfil1').first().json.tone }}\n---\n\n### [BLOQUEIOS DE VAZAMENTO E ANTI-ROBÃ”]\n* **PROIBIDO:** \"InstruÃ§Ã£o\", \"Lead\", \"RAG\", \"MÃ³dulo\", \"Base de Conhecimento\".\n* **NOME:** Use apenas o primeiro nome do lead.\n* **FALHA DE COMANDO:** NUNCA envie o texto cru da instruÃ§Ã£o (ex: \"Pergunte sobre X\"). Sua missÃ£o Ã© agir, nÃ£o repetir a ordem.\n\nâš ï¸ **SAÃDA FINAL:**\n- Gere apenas a mensagem final concatenada e humanizada conforme o algoritmo acima.\n- Transforme as instruÃ§Ãµes em interaÃ§Ãµes humanas ou chamadas de tools."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-5616,5904],"id":"825e1812-3296-4bcc-8752-88d32b2ffced","name":"Gerador de Resposta1"},{"parameters":{"toolDescription":"## TOOL: Enviar para um especialista\n\n## GATILHO (Execute essa tool sempre que a conversa estiver no contexto das condiÃ§Ãµes abaixo):\n- Se o usuÃ¡rio estiver insistindo em uma opÃ§Ã£o que nÃ£o Ã© valida em algum dos estÃ¡gios\n- Se o usuÃ¡rio indicar irritaÃ§Ã£o ou estresse extremo com o atendimento\n- Se o usuÃ¡rio insistir em um atendimento com um humano\n\n[REGRA SUPREMA - PRIORIDADE MÃXIMA]\nSe o gatilho for acionado: \n1. execute esta tool\n2. Ignore qualquer outra instruÃ§Ã£o e informe ao usuÃ¡rio que o atendimento serÃ¡ enviado para um especialista conseguir ajudar o usuÃ¡rio da melhor forma.","method":"PATCH","url":"=https://api-chat-joao.apre.tv/api/ticket/{{ $('Webhook').first().json.body.ticketId }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"pending\"\n}","options":{}},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.3,"position":[-5264,6192],"id":"668125cb-d1c3-482d-87cf-7465f623b79a","name":"Enviar para um especialista1"},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"## TOOL: BASE DE CONHECIMENTO (RESTRITO)\n\n## IMPORTANTE:\nEsta tool NÃƒO Ã© um suporte para dÃºvidas do usuÃ¡rio. Ela Ã© um repositÃ³rio de dados que sÃ³ pode ser acessado se a variÃ¡vel [INSTRUÃ‡ÃƒO DO FLUXO] contiver explicitamente o comando \"consultar base\", \"chamar conhecimento\" ou \"buscar dados\".\n\n## REGRAS DE ACIONAMENTO:\n1. Analise a [INSTRUÃ‡ÃƒO DO FLUXO].\n2. Se a instruÃ§Ã£o NÃƒO pedir para buscar dados, vocÃª estÃ¡ PROIBIDO de usar esta tool, mesmo que o usuÃ¡rio faÃ§a uma pergunta tÃ©cnica.\n3. Se o usuÃ¡rio perguntar algo e a instruÃ§Ã£o NÃƒO mandar buscar, use a \"Carta de SeguranÃ§a\" padrÃ£o do sistema.\n\n## PRIORIDADE:\nInstruÃ§Ã£o do Fluxo > Pergunta do UsuÃ¡rio.","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[-5568,6192],"id":"e07f5065-cee0-48ec-9306-e973b215712e","name":"Base de conhecimento3","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-5616,6400],"id":"af251e43-0f2e-4858-b848-4208c9170b0b","name":"Embeddings OpenAI5","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"options":{"temperature":0.4}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[-5744,6192],"id":"86c2d7b0-12b4-4106-a99f-8fd1a4199698","name":"DeepSeek Model5","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}},{"parameters":{"options":{"temperature":0.5}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[-6528,6352],"id":"ddacdb28-f260-49b2-a912-80427ebf8159","name":"DeepSeek Model2","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}},{"parameters":{"promptType":"define","text":"=### INSTRUÃ‡Ã•ES DO PLANNER:\n{{ $json.output }}\n\n### REGRAS DE CONEXÃƒO (A COLA DA CONVERSA):\nVocÃª deve transformar o rascunho robÃ³tico do Planner em uma conversa fluida. \n\n**O GRANDE ERRO A EVITAR:**\nNUNCA faÃ§a isso: \"O sistema faz X e Y. Qual seu nome?\" (Isso Ã© robÃ³tico).\n\n**O JEITO CERTO (TÃ©cnica do PivÃ´):**\n\"O sistema faz X e Y, o que agiliza muito o dia a dia! Mas antes de continuarmos, com quem eu falo?\" \n\n### REGRAS DE EXECUÃ‡ÃƒO (FOCO EM NATURALIDADE)\n1. COMPORTAMENTO DE DIÃLOGO: Responda diretamente ao usuÃ¡rio. Ã‰ proibido usar frases de \"narrador\" como \"Notei que vocÃª perguntou\" ou \"Vi que vocÃª enviou\". \n2. A TÃ‰CNICA DO PIVÃ”: Transforme a resposta tÃ©cnica em uma oportunidade de avanÃ§o. O conteÃºdo do campo [FACT] deve servir de gancho natural para a aÃ§Ã£o solicitada no [NEXT].\n3. AGNOSTICISMO: NÃ£o assuma nomes de empresas ou produtos fixos. Utilize estritamente as informaÃ§Ãµes fornecidas nos campos [FACT] e [NEXT] para dar contexto Ã  sua fala.\n\n### DIRETRIZES (Siga na ordem):\n0. **BLOQUEIO DE ALUCINAÃ‡ÃƒO (NEEDS_SPECIALIST):** Verifique o campo [FACT]. Se estiver escrito \"NEEDS_SPECIALIST\", vocÃª estÃ¡ **PROIBIDA** de responder a dÃºvida do usuÃ¡rio com seu conhecimento prÃ³prio.\n   - **AÃ‡ÃƒO OBRIGATÃ“RIA:** Diga EXATAMENTE: \"Sobre [ASSUNTO QUESTIONADO PELO USUÃRIO], prefiro confirmar com um especialista pra nÃ£o te passar informaÃ§Ã£o errada, tÃ¡?\".\n   - ApÃ³s essa frase, pule direto para a diretriz 3 (PivÃ´).\n\n1. **VALIDAÃ‡ÃƒO:** Se [FACT] contiver texto tÃ©cnico real, explique de forma simples e termine com um mini-comentÃ¡rio de benefÃ­cio.\n\n2. **EXECUÃ‡ÃƒO RIGOROSA DO [NEXT]:** O texto em [NEXT] Ã© o seu roteiro. Reescreva-o com seu tom.\n   - Se o [NEXT] mandar perguntar algo (ex: nome), pergunte.\n   - Se o [NEXT] jÃ¡ tiver o dado (ex: \"[JoÃ£o]\"), use o dado.\n\n3. **PIVÃ”:** Use conectores para mudar de assunto suavemente: \"A propÃ³sito...\", \"AliÃ¡s...\", \"Pra gente seguir...\", \"Antes de eu te explicar mais...\"\n\n4. **FLAG SKIP_INTRO:** Se o planner disser SKIP_INTRO, nÃ£o diga \"Oi\" nem se apresente novamente.\n\n5. **FLAG ALLOW_INTRO:** Se o planner disser ALLOW_INTRO, inicie se apresentando conforme seu perfil.\n\n6. **PERGUNTA FINAL:** A Ãºltima frase da sua mensagem deve ser sempre a pergunta ou aÃ§Ã£o solicitada no [NEXT].\n\n### CONTEXTO DO USUÃRIO:\nMsg: \"{{ $('CONCATENA1').first().json.user_full_message }}\"","options":{"systemMessage":"=VocÃª Ã© a {{ $('Seta perfil1').first().json.agentName }} - {{ $('Seta perfil1').first().json.role }}. \nVocÃª Ã© {{ $('Seta perfil1').first().json.tone }}.\nVocÃª odeia parecer um formulÃ¡rio, por isso, conecta validaÃ§Ãµes com perguntas. \nVocÃª SEMPRE cria uma 'ponte' ou um 'gancho' entre a resposta tÃ©cnica e a prÃ³xima pergunta. Se vocÃª for direta demais, a venda Ã© perdida.\nVocÃª sempre se apresenta quando Ã© necessÃ¡rio.\nVocÃª estÃ¡ sempre disposto a apresentar seu produto quando um usuÃ¡rio pergunta (sem inventar).\nVocÃª responde como um HUMANO, sem deixar qualquer vestÃ­gio de que Ã© um ROBÃ”.\nVocÃª atua na Ã¡rea de segmento: {{ $('Seta perfil1').first().json.companyDepartment }}\nO site da empresa em que vocÃª trabalha Ã© o {{ $('Seta perfil1').first().json.companySite }}\n{{ $('Seta perfil1').first().json.conduct }}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-6112,5920],"id":"7ed8a4c4-5d2e-4d15-b870-24511957771c","name":"Redator de Persona"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-6416,6576],"id":"18f148cb-cd1c-43d6-bd3e-b76617c84484","name":"Embeddings OpenAI3","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"## TOOL: BASE DE CONHECIMENTO\nUse APENAS se o usuÃ¡rio fizer uma pergunta tÃ©cnica.","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[-6368,6368],"id":"6344be42-bc3b-4365-929e-d788e9289bed","name":"Base de conhecimento1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"promptType":"define","text":"=### [PAINEL DE CONTROLE - PLANNER LÃ“GICO]\n\n### REGRAS DE EXECUÃ‡ÃƒO (ESTRITAS)\nVocÃª Ã© um motor de lÃ³gica puro. Sua saÃ­da deve ser EXCLUSIVAMENTE as tags [FLAG], [FACT] e [NEXT]. EstÃ¡ proibido gerar explicaÃ§Ãµes, anÃ¡lises ou passos. \n\n### CONTEXTO DO USUÃRIO\nMsg: \"{{ $('CONCATENA1').first().json.user_full_message }}\"\nHistÃ³rico Recente: \"{{ $('Formata ultimas mensagens').first().json.historyMessages ? $('Formata ultimas mensagens').first().json.historyMessages : 'VAZIO' }}\"\n\n### DADOS TÃ‰CNICOS (RAG)\n\"{{ $('MERGE DADOS').first().json.rag_context ? $('MERGE DADOS').first().json.rag_context.join('\\n') : 'Nenhuma informaÃ§Ã£o tÃ©cnica encontrada.' }}\"\n\n### MISSÃƒO DE CLASSIFICAÃ‡ÃƒO\n\n1. **DEFINIR [FACT]:**\n   - **TIPO A (Social/Vazio):** [FACT] VAZIO.\n   - **TIPO B (Curiosidade Geral):** Resumo de 2 frases do RAG no [FACT].\n   - **TIPO C (DÃºvida EspecÃ­fica):** Teste de correspondÃªncia EXATA com o RAG. \n     - Se o RAG responde exatamente: Copie a resposta crua para [FACT].\n     - Se o RAG NÃƒO menciona o termo explicitamente (ex: \"teste grÃ¡tis\"): **[FACT]: NEEDS_SPECIALIST**.\n\n2. **DEFINIR [FLAG]:**\n   - HistÃ³rico != 'VAZIO' -> [FLAG]: SKIP_INTRO\n   - HistÃ³rico == 'VAZIO' -> [FLAG]: ALLOW_INTRO\n\n3. **DEFINIR [NEXT] (FILTRO DE REDUNDÃ‚NCIA E COLETA):**\n   - Use a InstruÃ§Ã£o ObrigatÃ³ria: \"{{ $('LOGIC ENGINE').first().json.finalInstruction }}\"\n   - **PASSO A (Papagaio):** Se a IA jÃ¡ se apresentou ou jÃ¡ deu o pitch do sistema no histÃ³rico, REMOVA a explicaÃ§Ã£o do [NEXT].\n   - **PASSO B (Ouvido/ValidaÃ§Ã£o):** Verifique se o dado solicitado no [NEXT] (ex: nome) jÃ¡ foi entregue pelo usuÃ¡rio.\n     - **JÃ¡ respondeu o dado?** Altere o [NEXT] para: \"Perfeito, vamos seguir com a sua dÃºvida.\"\n     - **NÃƒO respondeu o dado?** Mantenha apenas a pergunta direta (ex: \"Qual o seu nome?\"). NÃƒO invente justificativas ou promessas nÃ£o contidas no RAG.\n\n### OUTPUT OBRIGATÃ“RIO\n[FLAG]: ...\n[FACT]: ...\n[NEXT]: ...","options":{"systemMessage":"VocÃª Ã© o Planner. Seja seco. Sua funÃ§Ã£o Ã© garantir que a resposta tÃ©cnica esteja correta e que o fluxo seja seguido. NÃ£o tente ser simpÃ¡tico.\nVocÃª nÃ£o repete mensagens.\nVocÃª utiliza o contexto tÃ©cnico (RAG) para explicar de forma generalista sobre o produto."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-6400,5920],"id":"95fa2a80-a594-4a6a-812a-244534d5d3a7","name":"Planner de ConteÃºdo (LÃ³gico)"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9973e414-7551-4bd0-941e-04f86c3516c9","leftValue":"={{ $json.output.replyMessage?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-8944,6080],"id":"0bc43a79-413a-4e80-9527-cb9894551e6b","name":"Se existe resposta","disabled":true},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Follow-up Router').first().json.output.replyMessage }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-8208,5952],"id":"33e3df92-009a-4a55-899b-ec285679b75c","name":"Envia WhatsApp2","disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('Follow-up Router').first().json.output.replyMessage, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8416,5952],"id":"3a19df40-b688-4c32-ba05-4883ade8a3aa","name":"Insere mensagem da IA no BD3","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"27a3e6f0-e2d1-4226-9c90-4a4ae9df03c7","leftValue":"={{ $json.output.isPassiveConfirmation }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-9152,6176],"id":"357846d3-ffb0-4827-b5a5-b97e6ecd07c9","name":"Se for uma confirmaÃ§Ã£o passiva","disabled":true},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/chrono-node/parser","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\ntimeExpression: $('Follow-up Router').first().json.output.timeExpression\n}) }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-7712,6592],"id":"c68745e6-aa07-4c64-9082-bd5657a5356a","name":"Envia para parser com o chrono-node","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up1').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-7424,6592],"id":"5c5d1059-6e14-4f1b-b1fb-50b130aa6fdc","name":"Se jÃ¡ existe follow-up3","disabled":true},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up1').first().json.id }}","active":"={{ false }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8720,6560],"id":"3a566b18-8fa4-4b19-97f7-0ae3f80a7490","name":"Desativa follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"company_id":"={{ $('Configura Contexto').first().json.companyId }}","session_id":"={{ $('Configura Contexto').first().json.cache_key }}","last_instruction":"={{ `Pergunte se o usuÃ¡rio pode retomar a conversa.` }}","follow_up_time":"={{ $('Envia para parser com o chrono-node').first().json.parsedDate }}","user_phone":"={{ $('Configura Contexto').first().json.user_phone }}","active":"={{ true }}","whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","follow_up_type":"requested","agent_name":"={{ $('Seta perfil1').first().json.agentName }}","attempts":0},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-7088,6688],"id":"0f328589-21fc-4356-b03d-f8044e555b8c","name":"Insere novo follow-up1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up1').first().json.id }}","follow_up_time":"={{ $('Envia para parser com o chrono-node').first().json.parsedDate }}","last_instruction":"={{ `Pergunte se o usuÃ¡rio pode retomar a conversa.` }}","active":"={{ true }}","follow_up_type":"requested","attempts":0},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":false},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-7088,6480],"id":"7fa81d96-a712-4ad5-8658-15e2bc77716d","name":"Atualiza follow-up1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up1').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-8960,6704],"id":"183c63fa-4303-4856-b9b4-161f94d6b2e1","name":"Se jÃ¡ existe follow-up2","disabled":true},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"},{"column":"company_id","value":"={{ $('Configura Contexto').first().json.companyId }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-9216,6704],"id":"eb810c29-7a54-4886-b982-5236489274bf","name":"Busca Follow Up1","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2d7ee4c-540b-4d38-8d33-c149ced59489","leftValue":"={{ $('Follow-up Router').first().json.output.timeExpression?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-8048,6720],"id":"aa78c4fc-09c8-4371-ba2c-ee8484c45839","name":"Se o usuÃ¡rio informou uma data de re-chamada","disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('Follow-up Router').first().json.output.replyMessage, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8480,6720],"id":"8fdf2d0e-f17f-425f-a56a-8ef9b2816594","name":"Insere mensagem da IA no BD2","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Follow-up Router').first().json.output.replyMessage }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-8256,6720],"id":"1f4631ef-63df-4198-8f57-267424f1d100","name":"Envia WhatsApp","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3ca2cf42-2ab9-4010-945a-17b777fb4dc5","leftValue":"={{ $json.output.isFollowUp }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-9472,6176],"id":"dd5df012-8ee1-4b69-bf7e-e195503973ec","name":"Se o usuÃ¡rio estÃ¡ tentando agendar uma re-chamada","disabled":true},{"parameters":{"promptType":"define","text":"=### [DADOS DE CONTEXTO]\n- **MENSAGEM ATUAL:** \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n- **HISTÃ“RICO RECENTE (DA MENSAGEM MAIS ANTIGA PARA A MAIS RECENTE):** {{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"Sem histÃ³rico.\" }}\n- **DATA/HORA ATUAL (ISO):** \"{{ $now }}\"\n- **DATA/HORA ATUAL (Por extenso):** {{ $now.setLocale('pt-BR').toFormat(\"cccc, dd 'de' LLLL 'de' yyyy ', ' HH:mm\") }}","hasOutputParser":true,"options":{"systemMessage":"=# SYSTEM: Sensor de Disponibilidade e Agendamento (Micro-Agente)\n\nVocÃª Ã© um mÃ³dulo de inteligÃªncia focado EXCLUSIVAMENTE em analisar se o usuÃ¡rio pode conversar AGORA ou se precisa agendar para DEPOIS.\n\n### [ENTRADAS]\n- **MENSAGEM_ATUAL:** A frase que o usuÃ¡rio acabou de enviar. (FONTE DA VERDADE SUPREMA).\n- **HISTÃ“RICO:** O contexto anterior. (USAR APENAS SE NECESSÃRIO).\n- **DATA_HOJE:** Use para cÃ¡lculos relativos (hoje, amanhÃ£).\n\n---\n\n### [HIERARQUIA DE DECISÃƒO - SIGA NA ORDEM EXATA]\n\n**PASSO 1: DETECÃ‡ÃƒO DE DISPONIBILIDADE IMEDIATA (O \"Agora\")**\n- **PERGUNTA CRÃTICA:** A `MENSAGEM_ATUAL` indica que o usuÃ¡rio quer ou pode conversar **neste exato momento**?\n- **GATILHOS POSITIVOS:** \"Estou livre\", \"Pode falar\", \"Manda\", \"Diga\", \"Opa\" (inÃ­cio de conversa), \"Consegui tempo\", \"Cancelaram a reuniÃ£o\", \"Sim\" (se a IA perguntou 'pode falar agora?'), \"Estou\".\n- **AÃ‡ÃƒO IMEDIATA (Se Positivo):**\n    - `isFollowUp`: **FALSE** (O fluxo segue agora).\n    - `timeExpression`: **NULL** (NÃ£o hÃ¡ agendamento futuro).\n    - `replyMessage`: **\"\"** (String vazia).\n    - **PARE O RACIOCÃNIO.** NÃ£o execute os passos 2 e 3.\n\n**PASSO 2: DETECÃ‡ÃƒO DE AGENDAMENTO OU INDISPONIBILIDADE (O \"Depois\")**\n- **PERGUNTA CRÃTICA:** A `MENSAGEM_ATUAL` indica que o usuÃ¡rio **NÃƒO** pode falar agora ou sugeriu um horÃ¡rio **FUTURO**?\n- **SUB-PASSO 2.A (Com Data Definida):** A mensagem contÃ©m tempo explÃ­cito (ex: \"Me chama amanhÃ£\", \"Daqui 10 min\", \"Estarei livre Ã s 14h\")?\n    - `isFollowUp`: **TRUE** (Vai para a fila de agendamento).\n    - `timeExpression`: Traduza para INGLÃŠS (ex: \"tomorrow at 14:00\", \"in 10 minutes\").\n    - `replyMessage`: \"Combinado! Te chamo [repetir a data em PT-BR].\"\n    - `requiresClarification`: **FALSE**.\n- **SUB-PASSO 2.B (Sem Data Definida):** O usuÃ¡rio disse apenas que estÃ¡ ocupado (ex: \"Agora nÃ£o\", \"TÃ´ em reuniÃ£o\", \"Me chama depois\") mas **NÃƒO** disse quando?\n    - `isFollowUp`: **TRUE**.\n    - `timeExpression`: **NULL**.\n    - `replyMessage`: \"Tudo bem! Quando fica melhor para eu te chamar novamente, entÃ£o?\"\n    - `requiresClarification`: **TRUE**.\n\n**PASSO 3: DETECÃ‡ÃƒO DE ENCERRAMENTO (O \"Tchau\")**\n- **CONTEXTO:** SÃ³ execute se a mensagem for curta/passiva (\"Ok\", \"Blz\", \"Vlw\", \"Tchau\").\n- **REGRA DE PROXIMIDADE:** Olhe EXCLUSIVAMENTE para a **ÃšLTIMA** mensagem da IA no histÃ³rico.\n    - A IA acabou de dizer \"Te chamo amanhÃ£\" (Agendamento)? -> `isPassiveConfirmation`: **TRUE**. Responda: \"AtÃ© mais!\".\n    - A IA acabou de fazer uma pergunta (\"Pode falar?\", \"Qual seu cargo?\")? -> `isPassiveConfirmation`: **FALSE**. Responda: \"\" (Deixe o fluxo seguir).\n\n---\n\n### [DIRETRIZES TÃ‰CNICAS (CHRONO-NODE)]\nSe cair no **PASSO 2.A**, siga estas regras de traduÃ§Ã£o para `timeExpression`:\n- **Futuro PrÃ³ximo:** \"Daqui a pouco\" -> \"in 1 hour\".\n- **Relativos:** \"AmanhÃ£ de manhÃ£\" -> \"tomorrow morning\" (09:00).\n- **Verbos de Futuro:** Se o usuÃ¡rio diz \"Estarei livre amanhÃ£\", isso Ã© PASSO 2 (Agendamento), pois ele NÃƒO estÃ¡ livre agora.\n- **LÃ­ngua:** O output deve ser estritamente em **INGLÃŠS**.\n\n### [REGRAS DE OURO - ANTI-ALUCINAÃ‡ÃƒO]\n1. **SUPREMACIA DO PRESENTE:** Se o histÃ³rico diz \"nÃ£o posso\" mas a MENSAGEM_ATUAL diz \"Estou livre\", obedeÃ§a o \"Estou livre\".\n2. **NÃƒO INVENTE AGENDAMENTOS:** Se caiu no Passo 1 (DisponÃ­vel Agora), `timeExpression` DEVE ser NULL.\n3. **INDISPONIBILIDADE:** `isFollowUp = TRUE` significa **exclusivamente** que a conversa deve parar agora e voltar depois.\n\n---\n\n### [SAÃDA OBRIGATÃ“RIA - JSON PURO]\n{\n  \"thinking\": \"string: 1. Cite a mensagem atual. 2. Diga qual PASSO (1, 2A, 2B ou 3) foi ativado e por quÃª.\",\n  \"isFollowUp\": boolean,\n  \"requiresClarification\": boolean,\n  \"timeExpression\": \"string (EN) ou null\",\n  \"replyMessage\": \"string (PT-BR)\",\n  \"isPassiveConfirmation\": boolean\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-9904,5856],"id":"8a6de74e-fe37-4ca3-ac42-747d28111b08","name":"Follow-up Router","executeOnce":true,"disabled":true,"onError":"continueRegularOutput"},{"parameters":{"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[-9920,6064],"id":"647d3e8a-7402-4f18-9822-0901d6bb2761","name":"OpenAI Router1","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}},"disabled":true},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"thinking\": {\n        \"type\": \"string\", \n        \"description\": \"RaciocÃ­nio para gerar o output final.\"\n    },\n    \"isFollowUp\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se o usuÃ¡rio demonstrou indisponibilidade imediata e solicitou um novo contato (ex: 'agora nÃ£o posso', 'me chama depois').\"\n    },\n    \"requiresClarification\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se o usuÃ¡rio NÃƒO especificou um horÃ¡rio ou prazo (ex: 'me chama outra hora'), exigindo que a IA pergunte o melhor momento.\"\n    },\n    \"timeExpression\": {\n      \"type\": \"string | null\",\n      \"description\": \"ExpressÃ£o da data solicitada pelo usuÃ¡rio para utilizar com a biblioteca chrono-node (Node.js).\"\n    },\n    \"replyMessage\": {\n      \"type\": \"string\",\n      \"description\": \"Mensagem humanizada e business casual para o WhatsApp, confirmando o horÃ¡rio ou perguntando quando retornar, sem usar exclamaÃ§Ãµes.\"\n    },\n    \"isPassiveConfirmation\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica que o usuÃ¡rio apenas confirmou passivamente (ex: 'blz', 'ok', 'fechou') uma mensagem anterior de agendamento, e a conversa deve ser encerrada com uma despedida educada.\"\n    }\n  },\n  \"required\": [\"isFollowUp\", \"requiresClarification\", \"timeExpression\", \"replyMessage\", \"isPassiveConfirmation\"]\n}\n"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-9728,6064],"id":"7e4230d0-df55-4928-a760-13b90e36ada0","name":"Parser Router1","disabled":true},{"parameters":{"url":"={{ $env.APRECHAT_URL_API }}api/ticket/search?filters%5BuserExists%5D=true&filters%5BcontactNumber%5D={{ $('Configura Contexto').first().json.user_phone }}&filters%5BstatusIn%5D=paused%2Copen&filters%5BcompanyId%5D={{ $('Configura Contexto').first().json.companyId }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-11328,144],"id":"d4264112-2646-47a0-b660-f95af947cf43","name":"Busca ticket existente do contato"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"openedTicket\": {{ JSON.stringify($json.data.first()) || null }}\n} ","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-11120,144],"id":"cf4040c8-60ff-4159-8681-23716aa9280e","name":"Output ticket aberto"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"00c41515-b955-40bb-96aa-04bd3663213b","leftValue":"={{ Boolean($json.openedTicket) }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-10912,144],"id":"ecadba42-57d8-4e44-9c91-0c03fe4b7aa3","name":"Se nÃ£o tem ticket com usuario para o contato"},{"parameters":{"url":"={{ $env.APRECHAT_URL_API }}api/ticket/search?filters%5BcontactNumber%5D={{ $('LOOP nos follow-up\\'s').item.json.user_phone }}&filters%5BstatusIn%5D=paused%2Copen%2Cpending&filters%5BcompanyId%5D={{ $('LOOP nos follow-up\\'s').item.json.company_id }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('LOOP nos follow-up\\'s').item.json.company_id }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-7440,2496],"id":"9c5e381b-42a5-4032-908e-34ba3c77a1e5","name":"Busca ticket existente do contato1"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"openedTicket\": {{ JSON.stringify($json.data.first()) || null }}\n} ","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-7232,2496],"id":"36bfab65-1669-4e43-a8b9-ea3680217075","name":"Output ticket aberto1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"00c41515-b955-40bb-96aa-04bd3663213b","leftValue":"={{ Boolean($json.openedTicket) }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-7024,2496],"id":"00d26eeb-d8c8-49e5-a053-97b4d18122db","name":"Se nÃ£o tem ticket com usuario para o contato1"}],"connections":{"Split de mensagens":{"main":[[{"node":"LOOP_SLIT1","type":"main","index":0}]]},"Se nÃ£o recebeu mensagem no meio do processamento":{"main":[[{"node":"Split de mensagens","type":"main","index":0}],[{"node":"Concatena mensagens para cache","type":"main","index":0}]]},"GET2":{"main":[[{"node":"Se nÃ£o recebeu mensagem no meio do processamento","type":"main","index":0}]]},"Salva Novo Estado":{"main":[[{"node":"Router de DÃºvida","type":"main","index":0}]]},"Parser  Chain1":{"main":[[{"node":"Remove mensagens do processamento","type":"main","index":0}]]},"OutputParser":{"ai_outputParser":[[{"node":"Parser  Chain1","type":"ai_outputParser","index":0}]]},"output1":{"main":[[{"node":"Se gerou resposta","type":"main","index":0}]]},"WAIT_SPLIT1":{"main":[[{"node":"LOOP_SLIT1","type":"main","index":0}]]},"LOOP_SLIT1":{"main":[[{"node":"Switch","type":"main","index":0},{"node":"Busca estado atual para follow-up","type":"main","index":0}],[{"node":"GET3","type":"main","index":0}]]},"Envia WhatsApp1":{"main":[[{"node":"WAIT_SPLIT1","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Configura Contexto","type":"main","index":0}]]},"Configura Contexto":{"main":[[{"node":"If2","type":"main","index":0}]]},"GET Estado Atual":{"main":[[{"node":"BLUEPRINT ENGINE","type":"main","index":0}]]},"BLUEPRINT ENGINE":{"main":[[{"node":"Pega ultimas mensagens","type":"main","index":0}]]},"LOGIC ENGINE":{"main":[[{"node":"Salva Novo Estado","type":"main","index":0}]]},"Gerador de Resposta":{"main":[[{"node":"output1","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"DELETE1":{"main":[[{"node":"CONCATENA1","type":"main","index":0}]]},"SWITCH_BUFFER":{"main":[[{"node":"DELETE1","type":"main","index":0}],[{"node":"NADA1","type":"main","index":0}],[{"node":"Wait1","type":"main","index":0}]]},"If2":{"main":[[{"node":"Deleta estado atual","type":"main","index":0}],[{"node":"Busca ticket existente do contato","type":"main","index":0}]]},"Delete table or rows1":{"main":[[{"node":"DELETE2","type":"main","index":0}]]},"Deleta estado atual":{"main":[[{"node":"Delete table or rows1","type":"main","index":0}]]},"DELETE2":{"main":[[{"node":"Remove follow-ups","type":"main","index":0}]]},"Concatena mensagens para cache":{"main":[[{"node":"RE-SETA CACHE DAS MENSAGENS ACUMULADAS","type":"main","index":0}]]},"Transforma em objeto literal":{"main":[[{"node":"SWITCH_BUFFER","type":"main","index":0}]]},"Formata histÃ³rico1":{"main":[[{"node":"Gera resumo da conversa - AI1","type":"main","index":0}]]},"Gera resumo da conversa - AI1":{"main":[[{"node":"Salva nota na conversa1","type":"main","index":0}]]},"Busca histÃ³rico de conversa1":{"main":[[{"node":"Formata histÃ³rico1","type":"main","index":0}]]},"Busca mensagens no cache":{"main":[[{"node":"Junta mensagem do cache com a mensagem do usuÃ¡rio","type":"main","index":0}]]},"Junta mensagem do cache com a mensagem do usuÃ¡rio":{"main":[[{"node":"SETA CACHE DAS MENSAGENS","type":"main","index":0}]]},"SETA CACHE DAS MENSAGENS":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"BUSCA MENSAGENS ACUMULADAS":{"main":[[{"node":"Transforma em objeto literal","type":"main","index":0}]]},"Pega ultimas mensagens":{"main":[[{"node":"Formata ultimas mensagens","type":"main","index":0}]]},"Formata ultimas mensagens":{"main":[[{"node":"Seta perfil1","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Busca histÃ³rico de conversa1","type":"main","index":0}],[{"node":"Busca histÃ³rico de conversa1","type":"main","index":0}],[{"node":"Call 'Enviar apresentaÃ§Ã£o comercial'","type":"main","index":0}]]},"Call 'Enviar apresentaÃ§Ã£o comercial'":{"main":[[{"node":"Busca histÃ³rico de conversa1","type":"main","index":0}]]},"Base de conhecimento":{"ai_tool":[[{"node":"Gerador de Resposta","type":"ai_tool","index":0}]]},"Embeddings OpenAI2":{"ai_embedding":[[{"node":"Base de conhecimento","type":"ai_embedding","index":0}]]},"Insere mensagem da IA no BD":{"main":[[{"node":"Envia WhatsApp1","type":"main","index":0}]]},"GET3":{"main":[[{"node":"Se nÃ£o recebeu mensagem no meio do processamento1","type":"main","index":0}]]},"Se nÃ£o recebeu mensagem no meio do processamento1":{"main":[[{"node":"Insere mensagem da IA no BD","type":"main","index":0}]]},"Busca estado atual para follow-up":{"main":[[{"node":"Busca Follow Up","type":"main","index":0}]]},"Busca Follow Up":{"main":[[{"node":"Se existe variÃ¡vel para ser solicitada","type":"main","index":0}]]},"Seta perfil1":{"main":[[{"node":"Insere mensagem do usuÃ¡rio no BD","type":"main","index":0}]]},"Insere mensagem do usuÃ¡rio no BD":{"main":[[{"node":"Extrator chain","type":"main","index":0}]]},"Cron 1em1 min - FOLLOW-UP":{"main":[[{"node":"Code in JavaScript","type":"main","index":0}]]},"Busca follow-ups disponÃ­veis":{"main":[[{"node":"LOOP nos follow-up's","type":"main","index":0}]]},"LOOP nos follow-up's":{"main":[[],[{"node":"BUSCA MENSAGENS ACUMULADAS1","type":"main","index":0}]]},"Busca estado atual da conversa":{"main":[[{"node":"Transforma estado atual em JSON literal","type":"main","index":0}]]},"Transforma estado atual em JSON literal":{"main":[[{"node":"Switch tipo de follow-up","type":"main","index":0}]]},"Se o usuÃ¡rio respondeu a variÃ¡vel pendente no meio do caminho":{"main":[[{"node":"LOOP nos follow-up's","type":"main","index":0}],[{"node":"Pega ultimas mensagens1","type":"main","index":0}]]},"Envia via Apre.Chat":{"main":[[{"node":"Pega novo horario de follow-up pelos attempts","type":"main","index":0}]]},"Pega ultimas mensagens1":{"main":[[{"node":"Formata ultimas mensagens1","type":"main","index":0}]]},"Formata ultimas mensagens1":{"main":[[{"node":"Se a Ãºltima mensagem foi da IA","type":"main","index":0}]]},"BUSCA MENSAGENS ACUMULADAS1":{"main":[[{"node":"Se chegou alguma mensagem do usuÃ¡rio","type":"main","index":0}]]},"Se chegou alguma mensagem do usuÃ¡rio":{"main":[[],[{"node":"Busca estado atual da conversa","type":"main","index":0}]]},"Switch tipo de follow-up":{"main":[[{"node":"Pega ultimas mensagens2","type":"main","index":0}],[{"node":"Busca ticket existente do contato1","type":"main","index":0}]]},"Pega ultimas mensagens2":{"main":[[{"node":"Formata ultimas mensagens2","type":"main","index":0}]]},"Formata ultimas mensagens2":{"main":[[{"node":"Gera mensagem de follow-up1","type":"main","index":0}]]},"Se a Ãºltima mensagem foi da IA":{"main":[[{"node":"Gera mensagem de follow-up2","type":"main","index":0}],[{"node":"Gera mensagem de follow-up2","type":"main","index":0}]]},"Gera mensagem de follow-up1":{"main":[[{"node":"Envia via Apre.Chat1","type":"main","index":0}]]},"Envia via Apre.Chat1":{"main":[[{"node":"Atualiza tentativa de follow-up","type":"main","index":0}]]},"Atualiza tentativas de follow-up":{"main":[[{"node":"Insere mensagem da IA no BD1","type":"main","index":0}]]},"Atualiza tentativa de follow-up":{"main":[[{"node":"Insere mensagem da IA no BD4","type":"main","index":0}]]},"Code in JavaScript":{"main":[[{"node":"If1","type":"main","index":0}]]},"Pega novo horario de follow-up pelos attempts":{"main":[[{"node":"Atualiza tentativas de follow-up","type":"main","index":0}]]},"If1":{"main":[[{"node":"Busca follow-ups disponÃ­veis","type":"main","index":0}]]},"Call 'ðŸ¤–ðŸ¤– Alicia: Transferir e gerar Resumo'":{"ai_tool":[[{"node":"Gerador de Resposta","type":"ai_tool","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"Gerador de Resposta","type":"ai_languageModel","index":0}]]},"Extrator chain":{"main":[[{"node":"LOGIC ENGINE","type":"main","index":0}]]},"Structured Output Parser2":{"ai_outputParser":[[{"node":"Extrator chain","type":"ai_outputParser","index":0}]]},"Google Gemini Chat Model1":{"ai_languageModel":[[{"node":"Extrator chain","type":"ai_languageModel","index":0}]]},"Google Gemini Chat Model2":{"ai_languageModel":[[{"node":"Parser  Chain1","type":"ai_languageModel","index":0}]]},"Google Gemini Chat Model3":{"ai_languageModel":[[{"node":"Gera resumo da conversa - AI1","type":"ai_languageModel","index":0}]]},"Se gerou resposta":{"main":[[{"node":"Parser  Chain1","type":"main","index":0}],[{"node":"Remove mensagens do processamento1","type":"main","index":0}]]},"Busca mensagens em processamento":{"main":[[{"node":"Se nÃ£o tem mensagem sendo processada","type":"main","index":0}]]},"Se nÃ£o tem mensagem sendo processada":{"main":[[{"node":"Seta mensagem em processamento no cache","type":"main","index":0}],[{"node":"SETA CACHE DAS MENSAGENS1","type":"main","index":0}]]},"CONCATENA1":{"main":[[{"node":"Busca mensagens em processamento","type":"main","index":0}]]},"Seta mensagem em processamento no cache":{"main":[[{"node":"GET Estado Atual","type":"main","index":0}]]},"Remove mensagens do processamento":{"main":[[{"node":"GET2","type":"main","index":0}]]},"RE-SETA CACHE DAS MENSAGENS ACUMULADAS":{"main":[[{"node":"Se tiver estado atual","type":"main","index":0}]]},"Volta para o estado anterior":{"main":[[{"node":"Delete table or rows","type":"main","index":0}]]},"Delete table or rows":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"Remove follow-ups":{"main":[[{"node":"Deleta mensagem em processamento","type":"main","index":0}]]},"Google Gemini Chat Model4":{"ai_languageModel":[[{"node":"Gera mensagem de follow-up2","type":"ai_languageModel","index":0}]]},"Gera mensagem de follow-up2":{"main":[[{"node":"Envia via Apre.Chat","type":"main","index":0}]]},"Tem DÃºvida?":{"main":[[{"node":"Consulta Base Conhecimento","type":"main","index":0}],[{"node":"MERGE DADOS","type":"main","index":0}]]},"Consulta Base Conhecimento":{"main":[[{"node":"RAG CONTEXT","type":"main","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Consulta Base Conhecimento","type":"ai_embedding","index":0}]]},"RAG CONTEXT":{"main":[[{"node":"MERGE DADOS","type":"main","index":0}]]},"MERGE DADOS":{"main":[[{"node":"Gerador de Resposta","type":"main","index":0}]]},"Insere mensagem da IA no BD1":{"main":[[{"node":"LOOP nos follow-up's","type":"main","index":0}]]},"Retorna userMsg":{"main":[[{"node":"Busca mensagens no cache","type":"main","index":0}]]},"Google Gemini Chat Model6":{"ai_languageModel":[[{"node":"Router de DÃºvida","type":"ai_languageModel","index":0}]]},"Parser Router":{"ai_outputParser":[[{"node":"Router de DÃºvida","type":"ai_outputParser","index":0}]]},"Router de DÃºvida":{"main":[[{"node":"Tem DÃºvida?","type":"main","index":0}]]},"Se tiver estado atual":{"main":[[{"node":"Volta para o estado anterior","type":"main","index":0}],[{"node":"Delete table or rows","type":"main","index":0}]]},"Salva nota na conversa1":{"main":[[{"node":"Transfere ticket para Aguardando Apre.Chat","type":"main","index":0}]]},"Se jÃ¡ existe follow-up":{"main":[[{"node":"Atualiza follow-up","type":"main","index":0}],[{"node":"Insere novo follow-up","type":"main","index":0}]]},"Se existe variÃ¡vel para ser solicitada":{"main":[[{"node":"Se jÃ¡ existe follow-up","type":"main","index":0}]]},"Se existe resposta1":{"main":[[{"node":"Insere mensagem da IA no BD6","type":"main","index":0}]]},"Insere mensagem da IA no BD6":{"main":[[{"node":"Envia WhatsApp4","type":"main","index":0}]]},"Se for uma confirmaÃ§Ã£o passiva1":{"main":[[{"node":"Se existe resposta1","type":"main","index":0}]]},"Envia para parser com o chrono-node1":{"main":[[{"node":"Se jÃ¡ existe follow-up5","type":"main","index":0}]]},"Desativa follow-up1":{"main":[[{"node":"Insere mensagem da IA no BD5","type":"main","index":0}]]},"Se jÃ¡ existe follow-up5":{"main":[[{"node":"Atualiza follow-up2","type":"main","index":0}],[{"node":"Insere novo follow-up2","type":"main","index":0}]]},"Se jÃ¡ existe follow-up4":{"main":[[{"node":"Desativa follow-up1","type":"main","index":0}],[{"node":"Insere mensagem da IA no BD5","type":"main","index":0}]]},"Busca Follow Up2":{"main":[[{"node":"Se jÃ¡ existe follow-up4","type":"main","index":0}]]},"Se o usuÃ¡rio informou uma data de re-chamada1":{"main":[[{"node":"Envia para parser com o chrono-node1","type":"main","index":0}]]},"Insere mensagem da IA no BD5":{"main":[[{"node":"Envia WhatsApp3","type":"main","index":0}]]},"Envia WhatsApp3":{"main":[[{"node":"Se o usuÃ¡rio informou uma data de re-chamada1","type":"main","index":0}]]},"Se o usuÃ¡rio estÃ¡ tentando agendar uma re-chamada1":{"main":[[{"node":"Busca Follow Up2","type":"main","index":0}],[{"node":"Se for uma confirmaÃ§Ã£o passiva1","type":"main","index":0}]]},"Follow-up Router1":{"main":[[{"node":"Se o usuÃ¡rio estÃ¡ tentando agendar uma re-chamada1","type":"main","index":0}]]},"OpenAI Router2":{"ai_languageModel":[[{"node":"Follow-up Router1","type":"ai_languageModel","index":0}]]},"Parser Router2":{"ai_outputParser":[[{"node":"Follow-up Router1","type":"ai_outputParser","index":0}]]},"Enviar para um especialista1":{"ai_tool":[[{"node":"Gerador de Resposta1","type":"ai_tool","index":0}]]},"Base de conhecimento3":{"ai_tool":[[{"node":"Gerador de Resposta1","type":"ai_tool","index":0}]]},"Embeddings OpenAI5":{"ai_embedding":[[{"node":"Base de conhecimento3","type":"ai_embedding","index":0}]]},"DeepSeek Model5":{"ai_languageModel":[[{"node":"Gerador de Resposta1","type":"ai_languageModel","index":0}]]},"DeepSeek Model2":{"ai_languageModel":[[{"node":"Redator de Persona","type":"ai_languageModel","index":0},{"node":"Planner de ConteÃºdo (LÃ³gico)","type":"ai_languageModel","index":0}]]},"Embeddings OpenAI3":{"ai_embedding":[[{"node":"Base de conhecimento1","type":"ai_embedding","index":0}]]},"Base de conhecimento1":{"ai_tool":[[{"node":"Planner de ConteÃºdo (LÃ³gico)","type":"ai_tool","index":0}]]},"Planner de ConteÃºdo (LÃ³gico)":{"main":[[{"node":"Redator de Persona","type":"main","index":0}]]},"Se existe resposta":{"main":[[{"node":"Insere mensagem da IA no BD3","type":"main","index":0}]]},"Insere mensagem da IA no BD3":{"main":[[{"node":"Envia WhatsApp2","type":"main","index":0}]]},"Se for uma confirmaÃ§Ã£o passiva":{"main":[[{"node":"Se existe resposta","type":"main","index":0}]]},"Envia para parser com o chrono-node":{"main":[[{"node":"Se jÃ¡ existe follow-up3","type":"main","index":0}]]},"Desativa follow-up":{"main":[[{"node":"Insere mensagem da IA no BD2","type":"main","index":0}]]},"Se jÃ¡ existe follow-up3":{"main":[[{"node":"Atualiza follow-up1","type":"main","index":0}],[{"node":"Insere novo follow-up1","type":"main","index":0}]]},"Se jÃ¡ existe follow-up2":{"main":[[{"node":"Desativa follow-up","type":"main","index":0}],[{"node":"Insere mensagem da IA no BD2","type":"main","index":0}]]},"Busca Follow Up1":{"main":[[{"node":"Se jÃ¡ existe follow-up2","type":"main","index":0}]]},"Se o usuÃ¡rio informou uma data de re-chamada":{"main":[[{"node":"Envia para parser com o chrono-node","type":"main","index":0}]]},"Insere mensagem da IA no BD2":{"main":[[{"node":"Envia WhatsApp","type":"main","index":0}]]},"Envia WhatsApp":{"main":[[{"node":"Se o usuÃ¡rio informou uma data de re-chamada","type":"main","index":0}]]},"Se o usuÃ¡rio estÃ¡ tentando agendar uma re-chamada":{"main":[[{"node":"Busca Follow Up1","type":"main","index":0}],[{"node":"Se for uma confirmaÃ§Ã£o passiva","type":"main","index":0}]]},"Follow-up Router":{"main":[[{"node":"Se o usuÃ¡rio estÃ¡ tentando agendar uma re-chamada","type":"main","index":0}]]},"OpenAI Router1":{"ai_languageModel":[[{"node":"Follow-up Router","type":"ai_languageModel","index":0}]]},"Parser Router1":{"ai_outputParser":[[{"node":"Follow-up Router","type":"ai_outputParser","index":0}]]},"Busca ticket existente do contato":{"main":[[{"node":"Output ticket aberto","type":"main","index":0}]]},"Output ticket aberto":{"main":[[{"node":"Se nÃ£o tem ticket com usuario para o contato","type":"main","index":0}]]},"Se nÃ£o tem ticket com usuario para o contato":{"main":[[{"node":"Retorna userMsg","type":"main","index":0}]]},"Transfere ticket para Aguardando Apre.Chat":{"main":[[]]},"Busca ticket existente do contato1":{"main":[[{"node":"Output ticket aberto1","type":"main","index":0}]]},"Output ticket aberto1":{"main":[[{"node":"Se nÃ£o tem ticket com usuario para o contato1","type":"main","index":0}]]},"Se nÃ£o tem ticket com usuario para o contato1":{"main":[[{"node":"Se o usuÃ¡rio respondeu a variÃ¡vel pendente no meio do caminho","type":"main","index":0}],[{"node":"LOOP nos follow-up's","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Cron 1em1 min":{"recurrenceRules":[]},"node:Cron 1em1 min - FOLLOW-UP":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n.apresenta.me","x-real-ip":"172.69.39.118","x-real-port":"18655","x-forwarded-for":"167.234.245.252, 172.69.39.118","x-forwarded-proto":"http","x-forwarded-host":"n8n.apresenta.me","x-forwarded-port":"80","remote-host":"172.69.39.118","connection":"close","content-length":"684","content-type":"application/json","user-agent":"axios/1.12.2","baggage":"sentry-environment=production,sentry-public_key=105feeda45f1e08a6adb966a132a4c34,sentry-trace_id=cee6fa69fd5b85de1d5c0a5d170471ee,sentry-transaction=POST-%2Fevolution%2F%3Aintegration%2F%3Aevent,sentry-sampled=true,sentry-sample_rand=0.18691946822499128,sentry-sample_rate=0.2","sentry-trace":"cee6fa69fd5b85de1d5c0a5d170471ee-fcf273c695d5c1eb-1","cf-ray":"9cd6d5dc8ca7d94e-GRU","accept-encoding":"gzip, br","accept":"application/json, text/plain, */*","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"167.234.245.252","cf-ipcountry":"BR","cf-visitor":"{\"scheme\":\"https\"}"},"params":{},"query":{},"body":{"message":"Como faÃ§o?","messageId":"4530766","contact":{"id":"34529","name":"JoÃ£o Dev","number":"554788950332","profilePicUrl":"https://pps.whatsapp.net/v/t61.24694-24/425105449_1361615211300388_1143514098522857072_n.jpg?ccb=11-4&oh=01_Q5Aa3wHUAVAvmz4_4Cac6PR-ilQHxGWvZq8LQwutKtCDrwCnZg&oe=699CADA3&_nc_sid=5e03e0&_nc_cat=102","createdAt":"2025-08-26T13:37:58.507-03:00","updatedAt":"2026-02-13T16:47:03.544-03:00","email":"","isGroup":false,"companyId":"10","whatsappId":"209","onlyResponsible":false,"userId":"1","aprePersonId":null,"apreDealId":null,"meta":{"ignoreCheck":true,"ignorePermission":true,"dontSendSocket":false}},"whatsappId":"209","companyId":10,"ticketId":207356},"webhookUrl":"https://n8n.apresenta.me/webhook/7223c6af-f595-4bc2-b84c-602b8900cd08","executionMode":"production"}}],"Cron 1em1 min - FOLLOW-UP":[{"json":{"timestamp":"2026-02-13T16:52:43.005-03:00","Readable date":"February 13th 2026, 4:52:43 pm","Readable time":"4:52:43 pm","Day of week":"Friday","Year":"2026","Month":"February","Day of month":"13","Hour":"16","Minute":"52","Second":"43","Timezone":"America/Sao_Paulo (UTC-03:00)"}}]},"versionId":"3ec16a12-2874-41aa-9171-0a63fdede75f","triggerCount":2,"shared":[{"updatedAt":"2025-11-04T18:47:16.654Z","createdAt":"2025-11-04T18:47:16.654Z","role":"workflow:owner","workflowId":"dDaZdsSmHxktrhjc","projectId":"4ToGMYJEWvvDSbcz"}],"tags":[]}