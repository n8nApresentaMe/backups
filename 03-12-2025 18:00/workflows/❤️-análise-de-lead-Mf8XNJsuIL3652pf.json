{"updatedAt":"2025-12-03T20:46:09.000Z","createdAt":"2025-08-16T14:49:36.978Z","id":"Mf8XNJsuIL3652pf","name":"â¤ï¸ AnÃ¡lise de Lead","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"lead-timeline","responseMode":"lastNode","options":{}},"id":"dceaf636-09b4-41d0-ad12-84fbd9a956ae","name":"Webhook (Lead Timeline)","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-5712,-736],"webhookId":"0baf53e6-8557-49d0-8377-7fe4a87a204e"},{"parameters":{"jsCode":"const { activities, comments, stageHistory } = $('Buscar dados da Timeline do Lead').first().json\n\nfunction toBrazilDate(dateString) {\n  const date = new Date(dateString);\n  date.setHours(date.getHours() - 3);\n  return date;\n}\n\nconst data = []\n\nasync function mapperActivities() {\n  for (const item of activities) {\n    const createdAt = toBrazilDate(item.CREATED)\n    const lastUpdatedAt = toBrazilDate(item.LAST_UPDATED)\n    const startedAt = toBrazilDate(item.START_TIME)\n    const finishedAt = toBrazilDate(item.END_TIME)\n                                    \n    const mappedActivity = {\n      historyName: 'activity',\n      registerId: item.ID, \n      subject: item.SUBJECT,\n      typeId: item.PROVIDER_TYPE_ID,\n      isCompleted: item.COMPLETED == 'Y',\n      createdAt, \n      lastUpdatedAt,\n      startedAt,\n      finishedAt\n    }\n\n    if (item.CALL_DETAILS) {\n      const call = item.CALL_DETAILS\n      \n      mappedActivity.callDetails = {\n        registerId: call.ID,\n        category: call.CALL_CATEGORY,\n        durationInSeconds: call.CALL_DURATION,\n        callUrl: call.CALL_RECORD_URL,\n        callCost: call.COST, \n        callCostCurrency: call.COST_CURRENCY, \n        callKey: call.CALL_ID\n      }\n    }\n    \n    data.push(mappedActivity)\n  }\n}\nfunction mapperComments() {\n  for (const item of comments) {\n    const createdAt = toBrazilDate(item.CREATED)\n    \n    const mappedComments = {\n      historyName: 'comment',\n      registerId: item.ID,\n      createdAt,\n      comment: item.COMMENT\n    }\n\n    data.push(mappedComments)\n  }\n}\nfunction mapperStageHistory() {\n  for (const item of stageHistory) {\n    const createdAt = toBrazilDate(item.CREATED_TIME) \n    \n    const mappedStageHistory = {\n      historyName: 'stageHistory',\n      registerId: item.ID,\n      status: item.STATUS_ID,\n      createdAt\n    }\n\n    data.push(mappedStageHistory)\n  }\n}\n\nawait mapperActivities();\nawait mapperComments();\nawait mapperStageHistory();\n\nreturn data\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4192,-720],"id":"b3051bfd-3ca2-4726-b45e-39f43faf4630","name":"Mapear dados do CRM"},{"parameters":{"jsCode":"const { leadId } = $('Webhook (Lead Timeline)').first().json.query\n\nif (!leadId) {\n  throw new Error('Ã‰ necessÃ¡rio informar o id do lead.')\n}\n\nreturn [{\n  leadId \n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5296,-736],"id":"692726b5-0846-4bfa-970f-45c2494e3eca","name":"Valida parÃ¢metros"},{"parameters":{"jsCode":"const sleep = (ms) => new Promise((r) => setTimeout(r, ms));\n\nasync function bitrixList(method, params) {\n  const url = `${$env.BITRIX_URL}${method}`;\n  let start = 0;\n  const out = [];\n  let tries = 0;\n\n  while (true) {\n    const body = { ...params };\n    if (start) body.start = start;\n\n    try {\n      const res = await this.helpers.httpRequest({\n        method: \"POST\",\n        url,\n        json: true,\n        body,\n        timeout: 30000,\n      });\n\n      let items = Array.isArray(res?.result) ? (res.result ?? []) : [];\n      items = !items.length && (typeof res?.result == 'object') ? res?.result.items : items \n      out.push(...items);\n\n      if (res?.next !== undefined && res.next !== null) {\n        start = res.next;\n        tries = 0;\n        await sleep(200);\n      } else {\n        break;\n      }\n    } catch (err) {\n      if (++tries <= 3) {\n        await sleep(500 * tries);\n        continue;\n      }\n      throw new Error(`Falha em ${method}: ${err?.message || String(err)}`);\n    }\n  }\n  return out;\n}\n\nconst leadId = $input.first().json.id\n\nconst a1 = await bitrixList(\"crm.activity.list\", {\n  entityTypeId: 1,\n  order: { ID: \"ASC\" },\n  filter: { \"OWNER_ID\": leadId },\n  select: [\n    \"ID\",\n    \"SUBJECT\",\n    \"PROVIDER_TYPE_ID\",\n    \"COMPLETED\",\n    \"CREATED\",\n    \"LAST_UPDATED\",\n    \"START_TIME\",\n    \"END_TIME\"\n  ],\n});\n\nconst a2 = await bitrixList(\"crm.timeline.comment.list\", {\n  filter: {\n    ENTITY_ID: leadId,\n    ENTITY_TYPE: \"lead\",\n  },\n  select: [\"ID\", \"COMMENT\", \"CREATED\", \"AUTHOR_ID\", \"FILES\"],\n});\n\nconst a3 = await bitrixList(\"crm.stagehistory.list\", {\n    entityTypeId: 1,\n    order: { \"ID\": \"DESC\"},\n    filter: { \"OWNER_ID\": leadId },\n    select: [\"ID\", \"STATUS_ID\", \"CREATED_TIME\"],\n});\n\nfor (const item of a1) {\n    if (item.PROVIDER_TYPE_ID == 'CALL') {\n      const base = \"https://crm.apresenta.me/rest/1/2a5nmkk1mq5yvpvx\";\n      const url = `${base}/voximplant.statistic.get.json`;\n      \n      const res = await this.helpers.httpRequest({\n        method: \"POST\",\n        url,\n        json: true,\n        body: {\n          \"filter\": {\n            \"CRM_ACTIVITY_ID\": item.ID,\n            \">CALL_DURATION\": 30\n          },\n          \"order\": {\n            \"CALL_START_DATE\": \"DESC\"\n          },\n          \"start\": 0,\n          \"select\": [\n            \"CALL_ID\",\n            \"CALL_TYPE\",\n            \"CALL_START_DATE\",\n            \"DURATION\",\n            \"COMMENT\"\n          ]\n        },\n        timeout: 30000,\n      });\n  \n      item.CALL_DETAILS = res.result[0]\n    }  \n}\n\nconst out = [\n  {\n    activities: a1,\n    comments: a2,\n    stageHistory: a3,\n  },\n];\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4576,-720],"id":"2edc700b-8c22-4d00-b187-a6ac7249b879","name":"Buscar dados da Timeline do Lead"},{"parameters":{"jsCode":"const messages = $input.first().json.messages\n\nreturn {\n  messages: messages?.data?.filter(message => ['audio', 'audioMessage'].includes(message.messageType) && !!message.mediaUrl && !!message.file).map(message => ({ json: message })) || []\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3568,64],"id":"7474ac96-b870-40af-9444-3920334c1aae","name":"Filtra por Ã¡udio"},{"parameters":{"jsCode":"const stories = $input.all()\n\nreturn {\n  stories: stories.filter(history => history.json.historyName === 'activity' && history.json.typeId === 'CALL' && !!history.json.callDetails?.callUrl && history.json.isCompleted)\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4400,-720],"id":"89ebb3e6-027b-41a1-b818-8e2a6e674b68","name":"Filtra por call"},{"parameters":{"jsCode":"const allStories = $('Mapear dados do CRM').all()\nconst allStoriesMap = new Map()\nconst historyCalls = $('Filtra por call').first().json.stories\nconst transcribedCalls = $input.all()\n\nfor (const history of allStories) {\n  allStoriesMap.set(`${history.json.registerId}-${history.json.historyName}`, history)\n\n}\n\nfor (const transcribed of transcribedCalls) {\n  const call = historyCalls[transcribed.pairedItem.item]\n  const transcription = transcribed.json.text\n\n  call.json.callDetails = {\n    ...call.json.callDetails, \n    transcription\n  }\n  \n  allStoriesMap.set(`${call.json.registerId}-${call.json.historyName}`, call)\n}\n\nreturn Array.from(allStoriesMap.values())"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3440,-720],"id":"79973b1e-5ab5-4a80-b795-6d5a1ac5e5ca","name":"Junta as transcriÃ§Ãµes com a timeline"},{"parameters":{"jsCode":"const allMessages = $('Busca Mensagens do lead no Apre.Chat').first().json.messages.data\nconst allMessagesMap = new Map()\nconst audioMessages = $('Filtra por Ã¡udio').first().json.messages\nconst transcribedAudios =  $input.all()\n\nfor (const message of allMessages) {\n  allMessagesMap.set(String(message.id), {json:{\n    ...message\n  }})\n}\n\nconsole.log(audioMessages)\nconsole.log(transcribedAudios)\n\nfor (const transcribed of transcribedAudios) {\n  const audioMessage = audioMessages[transcribed.pairedItem.item]\n  const transcription = transcribed.json.text\n\n  allMessagesMap.set(String(audioMessage.json.id), {\n    json: {\n      ...audioMessage, \n      transcription: transcription\n    }\n  })\n}\n\nreturn Array.from(allMessagesMap.values())\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2640,64],"id":"950d6e56-7424-4bb5-9e83-8b06af5652e4","name":"Junta as transcriÃ§Ãµes com as mensagens"},{"parameters":{"method":"POST","url":"https://api.apresenta.me/comercial/bitrix/leadGet","sendQuery":true,"queryParameters":{"parameters":[{"name":"id","value":"={{ $json.leadId }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-5088,-736],"id":"69a95264-4bd5-45b1-8be2-2a80874445a9","name":"Busca dados do Lead"},{"parameters":{"url":"=https://api.apre.chat/api/messages/{{ $json.whatsapp || '00' }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8="},{"name":"company","value":"10"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-4160,-256],"id":"891f91b1-84bb-4041-9014-b5d2c9854e16","name":"Busca Mensagens do lead no Apre.Chat","onError":"continueRegularOutput"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-2000,-496],"id":"d6454ec9-5bb5-4814-9b3c-c2e2a5d45eff","name":"Junta mensagens com histÃ³rico da timeline do Lead","alwaysOutputData":true},{"parameters":{"method":"POST","url":"https://n8n.apresenta.me/webhook/audio-transcribe","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"url\": \"{{ $json.url }}\", \n  \"key\": \"{{ $json.key }}\",\n  \"force\": {{ $json.force }}\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3648,-720],"id":"dbb1b5f8-bee5-4c87-97f0-bd10e10e3909","name":"Transcrever calls"},{"parameters":{"jsCode":"const calls = $input.first().json.stories\n\nreturn calls.map(call => ({\n  url: call.json.callDetails.callUrl, \n  key: `${call.json.callDetails.registerId}_${call.json.callDetails.callKey}`,\n  force: $('Webhook (Lead Timeline)').first().json.query.force == 'Y'\n}))"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3872,-720],"id":"654acd51-3390-4cd0-bfa2-110c5ef233e6","name":"Mapear url das calls"},{"parameters":{"jsCode":"const audios = $(\"Filtra por Ã¡udio\").first().json.messages\n\nreturn audios?.map(audio => ({\n  url: audio.json.mediaUrl, \n  force: $('Webhook (Lead Timeline)').first().json.query.force == 'Y',\n  key: `${audio.json.id}_${audio.json.file.fileName}`\n}))"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3072,64],"id":"efc2b4a0-187e-495f-b34e-df7b67b71dab","name":"Mapear url dos Ã¡udios"},{"parameters":{"method":"POST","url":"https://n8n.apresenta.me/webhook/audio-transcribe","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"url\": \"{{ $json.url }}\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2864,64],"id":"702f2af9-8bd2-4326-a309-3d16451d572c","name":"Transcrever audios"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0e7bb9f9-1d07-47aa-b731-59c869540da5","leftValue":"={{ $json.whatsapp?.length.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4432,-240],"id":"e84d78ff-ca86-4e06-859d-901f99973f84","name":"Verifica se o Lead tem WhatsApp cadastrado"},{"parameters":{"jsCode":"const stories = $input.all()\nconst sortedStories = stories.sort((a, b) => new Date(a.json.createdAt) - new Date(b.json.createdAt))\nreturn {\n  sortedStories\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1792,-496],"id":"8e99cd84-7817-4f96-afe7-f7bbc3bbb13e","name":"Ordena por data de criaÃ§Ã£o"},{"parameters":{"jsCode":"return $('Busca Mensagens do lead no Apre.Chat').first().json.messages?.data?.map(message => ({\n  historyName: 'whatsAppMessage', \n  ...message  \n}))"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3376,64],"id":"6dcc2d7a-0e78-4764-9249-bb7358f77646","name":"Normaliza dados"},{"parameters":{"method":"POST","url":"={{ $env.BITRIX_URL }}crm.timeline.logmessage.add","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"fields\": {\n        \"entityTypeId\": 1,\n        \"entityId\": \"{{ $json.query.leadId }}\",\n        \"title\": \"â¤ï¸ AnÃ¡lise de Lead inciada.\",\n        \"text\": \"AnÃ¡lise do Lead foi iniciada com sucesso!\",\n        \"iconCode\": \"task-activity\"\n    }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-5504,-736],"id":"088ecf1e-91c2-40a7-bc77-f154b8440442","name":"Salva Log no Lead","retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $env.BITRIX_URL }}crm.lead.update","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"id\": \"{{ $('Busca dados do Lead').first().json.id }}\",\n    \"fields\": {\n        \"UF_CRM_LEAD_ANALYSIS\": {{ $json.lead.analysisWithoutEmojiEncoded }},\n        \"UF_CRM_LEAD_ANALYSIS_DATE\": \"{{ (() => { const d = new Date(); const pad = n => String(n).padStart(2,'0'); const tz = -d.getTimezoneOffset(); const sign = tz >= 0 ? '+' : '-'; const h = pad(Math.floor(Math.abs(tz) / 60)); const m = pad(Math.abs(tz) % 60); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}${sign}${h}:${m}`; })() }}\"\n    }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-816,-496],"id":"c1c5e4f6-3afd-46fe-85aa-01f4a20a4800","name":"âœï¸ Altera dados do Lead","retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $env.BITRIX_URL }}crm.timeline.comment.add","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"fields\": {\n        \"ENTITY_TYPE\": \"lead\",\n        \"ENTITY_ID\": \"{{ $('Busca dados do Lead').first().json.id }}\",\n        \"COMMENT\": {{ $('Ajusta informaÃ§Ãµes').item.json.lead.analysisBbCodeEncoded }}\n    }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-624,-496],"id":"d7ac28bd-ac72-499b-aaa4-170c30507981","name":"Salva comentÃ¡rio com AnÃ¡lise no Lead","retryOnFail":true},{"parameters":{"jsCode":"function removeEmojis(str) {\n  const re = /(?:[\\u{1F1E6}-\\u{1F1FF}]{2}|[#*0-9]\\uFE0F?\\u20E3|\\p{Extended_Pictographic}(?:\\uFE0F|\\u200D(?:\\p{Extended_Pictographic}|\\u2640|\\u2642)\\uFE0F?)*|\\uFE0F|\\u200D)/gu;\n  return str.replace(re, '');\n}\n\n\nfunction markdownToBBCode(markdown) {\n  return markdown\n    // TÃ­tulos\n    .replace(/^### (.*$)/gim, '[b]$1[/b]')\n    .replace(/^## (.*$)/gim, '[b]$1[/b]')\n    .replace(/^# (.*$)/gim, '[b]$1[/b]')\n\n    // Negrito\n    .replace(/\\*\\*(.*?)\\*\\*/g, '[b]$1[/b]')\n\n    // ItÃ¡lico (opcional, se quiser suportar *texto*)\n    .replace(/\\*(.*?)\\*/g, '[i]$1[/i]')\n\n    // Quebras de linha duplas viram parÃ¡grafo\n    .replace(/\\n{2,}/g, '\\n\\n')\n}\n\nreturn {\n  lead: {\n    id: $('Busca dados do Lead').first().json.id,\n    analysisBbCodeEncoded: JSON.stringify(markdownToBBCode($input.first().json.output)),\n    analysisWithoutEmojiEncoded: JSON.stringify(removeEmojis($input.first().json.output)),\n  }\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1008,-496],"id":"a4c893da-2cf7-46bf-9cd6-195b89d254cd","name":"Ajusta informaÃ§Ãµes"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"dcb1dc1a-aa81-4222-a916-5aad835db918","leftValue":"={{ $('Filtra por call').item.json.stories.length.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4032,-880],"id":"38f04dff-c3a7-412d-8a5a-b1d67d5941a0","name":"Se tiver call na timeline"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"571ae3a5-3f06-46ff-bae6-6ced09fb6ca4","leftValue":"={{ $json._original.UF_CRM_LEAD_ANALYSIS }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"8ee34270-f834-401c-9cd9-83d920a86df9","leftValue":"={{ $('Webhook (Lead Timeline)').item.json.query.force != 'Y' }}","rightValue":"=","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4880,-736],"id":"83661b43-e1b2-49cd-b80e-998347748499","name":"Se o Lead jÃ¡ tiver anÃ¡lise"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eeeab0b2-44f3-4838-9a0c-30110ac166f2","leftValue":"={{ $('Filtra por Ã¡udio').item.json.messages.length.toBoolean() }}","rightValue":"True","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{"ignoreCase":false}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3216,256],"id":"e459569a-191a-476c-8089-e2a7a54eb1ca","name":"Verifica se tem audio nas mensagens","alwaysOutputData":false},{"parameters":{"method":"POST","url":"={{ $env.BITRIX_URL }}crm.lead.update","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"id\": \"{{ $('Busca dados do Lead').item.json.id }}\",\n    \"fields\": {\n        \"UF_CRM_LEAD_ANALYSIS_DATE\": \"{{ (() => { const d = new Date(); const pad = n => String(n).padStart(2,'0'); const tz = -d.getTimezoneOffset(); const sign = tz >= 0 ? '+' : '-'; const h = pad(Math.floor(Math.abs(tz) / 60)); const m = pad(Math.abs(tz) % 60); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}${sign}${h}:${m}`; })() }}\"\n    }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-4592,-1200],"id":"ffb1083a-3c5b-4d84-a04a-87da9ec11d54","name":"Altera da da Ãºltima AnÃ¡lise de Lead","retryOnFail":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a49d6896-c524-4dfe-8579-457dfbd9a51c","leftValue":"={{ $json.messages.data.length.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3904,-256],"id":"94e140c5-afb3-44fa-b74d-4e039a4be130","name":"If"},{"parameters":{"jsCode":"const whatsapp = $input.first().json.whatsapp || '';\n\nreturn {\n  whatsapp: whatsapp.replace(/\\D/g, '') \n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4656,-336],"id":"665d9fe4-717e-4d4f-abf8-1abd9e36ec9e","name":"Remove caracteres diferentes de numero e espaÃ§o do whatsapp do lead"},{"parameters":{"fromEmail":"Apresenta.me <no-reply@apresenta.me>","toEmail":"joao.rorato@apresenta.me","subject":"=ğŸ’— AnÃ¡lise de Lead | {{ $('Busca dados do Lead').first().json.user_seller_details.name }} {{ $('Busca dados do Lead').first().json.user_seller_details.last_name }} | {{ $('Busca dados do Lead').first().json.title }}, {{ $('Busca dados do Lead').first().json.company_title }}","html":"={{ $json.message.content }}","options":{"appendAttribution":false,"ccEmail":"="}},"type":"n8n-nodes-base.emailSend","typeVersion":2.1,"position":[-80,-496],"id":"72490bf0-3efd-40c1-8691-c66c8ba9ab2c","name":"Envia anÃ¡lise por e-mail","webhookId":"b8842732-9025-4c04-924e-06cfbb051a19","notesInFlow":false,"credentials":{"smtp":{"id":"aeF6k2hPp8cZPPHg","name":"SMTP account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-5-mini","mode":"list","cachedResultName":"GPT-5-MINI"},"messages":{"values":[{"content":"=VocÃª Ã© um ASSISTENTE ESPECIALISTA em formataÃ§Ã£o de relatÃ³rios de anÃ¡lise de leads para o mercado imobiliÃ¡rio. Sua missÃ£o Ã© transformar a anÃ¡lise bruta de uma call de qualificaÃ§Ã£o ou demonstraÃ§Ã£o em um e-mail visualmente moderno e legÃ­vel no Gmail, com foco em facilitar a leitura rÃ¡pida por vendedores.\n\nO e-mail deve ser claro, escaneÃ¡vel e chamar atenÃ§Ã£o para os principais pontos da conversa. Use blocos bem separados, cores, listas e emojis estratÃ©gicos. Cada parte do conteÃºdo deve â€œparecer listaâ€, com itens facilmente identificÃ¡veis para leitura rÃ¡pida.\n\nATENÃ‡ÃƒO (REGRAS ESPECIAIS DE EMOJI):\n- âŒ NUNCA usar o emoji ğŸ“ em hipÃ³tese alguma.\n- âŒ NUNCA adicionar emoji no inÃ­cio de uma linha que JÃ COMEÃ‡A com emoji no texto original.\n- SÃ³ adicionar emoji como bullet quando a linha original nÃ£o tiver emoji no comeÃ§o.\n\n==========================\nğŸ§  OBJETIVO PRINCIPAL\n==========================\nTransformar um relatÃ³rio bruto (transcriÃ§Ã£o ou anÃ¡lise da call) em um e-mail HTML responsivo e elegante, otimizado para Gmail, com foco na leitura rÃ¡pida de vendedores, destacando pontos fortes, pontos fracos, oportunidades e alertas.\n\nO RESULTADO FINAL DEVE:\n- Ser extremamente escaneÃ¡vel (o vendedor deve â€œbater o olhoâ€ e entender).\n- Usar blocos coloridos para separar seÃ§Ãµes.\n- Usar listas e emojis para praticamente todas as informaÃ§Ãµes importantes, SEM ALTERAR TEXTO.\n\n==========================\nğŸ”§ INSTRUÃ‡Ã•ES DE FORMAÃ‡ÃƒO\n==========================\n\n1. FIDELIDADE AO CONTEÃšDO\n- NÃƒO reescreva, NÃƒO resuma, NÃƒO reordene e NÃƒO interprete o conteÃºdo original do RELATÃ“RIO_BRUTO.\n- Use exatamente o texto original, apenas mudando a forma de apresentaÃ§Ã£o (HTML, blocos, listas, emojis).\n- Mantenha todos os tÃ­tulos, subtÃ­tulos e seÃ§Ãµes na ordem original, mesmo que estejam vazios ou pareÃ§am repetitivos.\n\n2. E-MAIL EM HTML INLINE (compatÃ­vel com Gmail)\n- Somente HTML com CSS inline.\n- NÃƒO usar tags externas como <html>, <head>, <body>.\n- NÃƒO usar comentÃ¡rios.\n- A saÃ­da final deve ser APENAS o HTML pronto para colagem no Gmail.\n\n3. VISUAL MODERNO, LEITURA FLUÃDA E ESPAÃ‡AMENTO\n- Fonte: Helvetica, Arial, sans-serif.\n- line-height: 1.6; color: #333.\n- TÃ­tulos em cor #1a73e8, em negrito, e sempre com EMOJIS (ex: ğŸ¯, âœ…, âš ï¸, ğŸ“Œ, ğŸ§©, ğŸ’¡).\n- Usar ESPAÃ‡AMENTO MÃ‰DIO entre blocos (tÃ­tulos, parÃ¡grafos, boxes e listas):\n  - Evitar texto â€œcoladoâ€ (sem espaÃ§amento) que pareÃ§a bloco corrido.\n  - Evitar espaÃ§amentos gigantes que quebrem demais o fluxo.\n  - RecomendaÃ§Ãµes tÃ­picas:\n    - margin-top entre seÃ§Ãµes: 12pxâ€“18px\n    - margin-bottom entre parÃ¡grafos/listas: 6pxâ€“10px\n- Emojis com moderaÃ§Ã£o porÃ©m consistentes em TODO o relatÃ³rio:\n  - Principalmente em tÃ­tulos de seÃ§Ãµes e itens de listas.\n  - Exemplos permitidos: âœ… âš ï¸ ğŸ“Œ ğŸ” ğŸ”— ğŸ’¡\n  - Emoji ğŸ“ Ã© proibido.\n\n4. ESTRUTURA EM BLOCOS COLORIDOS (SEMPRE)\n- TODA seÃ§Ã£o importante do RELATÃ“RIO_BRUTO deve estar dentro de um box/bloco com fundo colorido.\n- Usar estes padrÃµes de cor:\n  - InformaÃ§Ã£o Geral: background-color:#E8F0FE\n  - Sucesso/Oportunidade/Pontos Fortes: background-color:#E6F4EA\n  - Alerta/Problema/Pontos de AtenÃ§Ã£o: background-color:#FFF4E5\n  - Neutro/ObservaÃ§Ã£o/Contexto: background-color:#F1F3F4\n- Sempre aplicar: border-radius:6px; padding:12px 14px; margin:12px 0;\n- Se nÃ£o for Ã³bvio qual cor usar, utilizar o bloco Neutro (#F1F3F4).\n\n5. TUDO DEVE â€œPARECER LISTAâ€\n- Sempre que possÃ­vel, apresentar o conteÃºdo em forma de lista, SEM alterar o texto original:\n  - Transformar linhas separadas por quebras (\\n) em itens de lista.\n  - Utilizar <ul> e <li> ou listas com emojis no inÃ­cio de cada item.\n- Regra de emojis nas listas:\n  - Se a linha ORIGINAL jÃ¡ comeÃ§ar com emoji, NÃƒO adicionar outro emoji na frente, apenas colocar essa linha como <li>.\n  - Se a linha ORIGINAL NÃƒO tiver emoji no comeÃ§o, vocÃª pode adicionar um emoji (ex: âœ…, âš ï¸, ğŸ“Œ, ğŸ’¡) como bullet visual.\n- Manter o texto de cada linha exatamente igual ao original, apenas adicionando, quando permitido, um emoji ANTES do texto dentro da lista.\n- Exemplos de estilos de lista:\n  - <ul> com bullets normais (sem emoji).\n  - Listas com emojis como prefixo do item: âœ…, âš ï¸, ğŸ“Œ, ğŸ’¡ (nunca ğŸ“).\n- Evitar parÃ¡grafos muito longos:\n  - Sempre que houver quebras de linha no texto original, respeitar essas quebras com <br> ou transformÃ¡-las em itens de lista.\n- Manter blocos visuais bem definidos:\n  - TÃ­tulo da seÃ§Ã£o â†’ box colorido com conteÃºdo em formato de lista â†’ listas adicionais se necessÃ¡rio.\n\n6. QUEBRAS E ESTRUTURA\n- Converter \\n para <br> quando o texto estiver em bloco.\n- Preferencialmente, quando o conteÃºdo for uma enumeraÃ§Ã£o ou pontos soltos, usar listas (<ul><li>) mantendo o texto literal de cada linha.\n- NÃ£o juntar frases de linhas diferentes em um Ãºnico parÃ¡grafo se elas estiverem separadas no RELATÃ“RIO_BRUTO.\n\n7. TABELAS (se existirem)\n- CabeÃ§alhos em negrito.\n- border-collapse: collapse;\n- padding interno.\n- EspaÃ§amento vertical mÃ©dio entre a tabela e o conteÃºdo anterior/posterior (margin:12px 0).\n- Se a informaÃ§Ã£o da tabela permitir, pode ser reforÃ§ada com listas e emojis abaixo dela, sem alterar o texto original (apenas reapresentando o mesmo conteÃºdo em formato de lista).\n\n8. LINKS\n- Sempre precedidos de ğŸ”—.\n- Exemplo: ğŸ”— <a href=\"URL\" style=\"color:#1a73e8; text-decoration:underline;\">Texto do link</a>\n- Nunca deixar uma URL â€œsoltaâ€ sem estar clicÃ¡vel.\n\n9. IMAGEM E CABEÃ‡ALHO\n- Sempre iniciar o e-mail com o logo:\n<img src=\"https://s.apresenta.me/comercial/automations/apresentame-300.png\" alt=\"Apresenta.me ~ O Futuro das ImobiliÃ¡rias\" width=\"300\" style=\"display:inline-block; margin-bottom:20px;\">\n\n10. TÃTULO PRINCIPAL DO E-MAIL\n- Usar sempre um tÃ­tulo chamativo com emoji:\n<h2 style=\"color:#1a73e8; font-family: Helvetica, Arial, sans-serif; margin:0 0 16px 0;\">ğŸ¯ AnÃ¡lise de Lead | Apresenta.me | NOME DO LEAD ~ ASSUNTO DA CALL</h2>\n\n11. ASSINATURA FINAL (obrigatÃ³ria)\n- Sempre ao final, exatamente assim:\n<p style=\"font-style:italic; margin-top: 30px; border-top:1px solid #ddd; padding-top:10px; font-family: Helvetica, Arial, sans-serif;\">RelatÃ³rio pela <b>Sofia</b>, assistente da Apresenta.me</p>\n\n==========================\nğŸ“Œ EXEMPLO DE ORGANIZAÃ‡ÃƒO (TUDO EM BLOCOS E LISTAS)\n==========================\n\n<strong style=\"font-family: Helvetica, Arial, sans-serif;\">ğŸ¯ Objetivo da Call</strong>\n<div style=\"background-color:#E8F0FE; border-radius:6px; padding:12px 14px; margin:8px 0 14px 0; font-family: Helvetica, Arial, sans-serif;\">\n  <ul style=\"margin:0; padding-left:18px;\">\n    <li>ğŸ’¡ ConteÃºdo literal da seÃ§Ã£o, exatamente como no relatÃ³rio.</li>\n    <li>ğŸ’¡ Quebras de linha do original podem virar novos itens de lista.</li>\n  </ul>\n</div>\n\n<strong style=\"font-family: Helvetica, Arial, sans-serif;\">âœ… Pontos Fortes do Lead</strong>\n<div style=\"background-color:#E6F4EA; border-radius:6px; padding:12px 14px; margin:8px 0 14px 0; font-family: Helvetica, Arial, sans-serif;\">\n  <ul style=\"margin:0; padding-left:18px;\">\n    <li>âœ… Pontos fortes identificados exatamente como no relatÃ³rio.</li>\n    <li>ğŸ’¡ Respeitar o texto original, apenas formatando como lista.</li>\n  </ul>\n</div>\n\n<strong style=\"font-family: Helvetica, Arial, sans-serif;\">âš ï¸ Pontos de AtenÃ§Ã£o</strong>\n<div style=\"background-color:#FFF4E5; border-radius:6px; padding:12px 14px; margin:8px 0 14px 0; font-family: Helvetica, Arial, sans-serif;\">\n  <ul style=\"margin:0; padding-left:18px;\">\n    <li>âš ï¸ ObstÃ¡culos ou dÃºvidas levantadas pelo lead.</li>\n    <li>ğŸ’¡ Destacar riscos, incertezas ou dependÃªncias.</li>\n  </ul>\n</div>\n\n<strong style=\"font-family: Helvetica, Arial, sans-serif;\">ğŸ“Œ PrÃ³ximos Passos</strong>\n<div style=\"background-color:#F1F3F4; border-radius:6px; padding:12px 14px; margin:8px 0 16px 0; font-family: Helvetica, Arial, sans-serif;\">\n  <ul style=\"margin:0; padding-left:18px;\">\n    <li>ğŸ“Œ Aguardar aprovaÃ§Ã£o interna.</li>\n    <li>ğŸ“Œ Agendar prÃ³xima call com decisor.</li>\n  </ul>\n</div>\n\n==========================\nğŸ“¤ INSTRUÃ‡ÃƒO FINAL\n==========================\n- A SAÃDA DEVE SER SOMENTE O HTML INLINE FINAL, pronto para colagem no Gmail.\n- NÃƒO incluir blocos de cÃ³digo, comentÃ¡rios ou explicaÃ§Ãµes.\n- MANTER 100% do conteÃºdo textual do RELATÃ“RIO_BRUTO, na MESMA ORDEM ORIGINAL.\n- TRANSFORMAR o conteÃºdo em HTML visualmente moderno, claro, escaneÃ¡vel e responsivo.\n- USAR blocos COLORIDOS para separar visualmente as seÃ§Ãµes.\n- FAZER COM QUE QUASE TUDO PAREÃ‡A LISTA, com uso de emojis nos itens, sem alterar o texto original.\n- NÃƒO USAR o emoji ğŸ“ em nenhuma situaÃ§Ã£o.\n- NÃƒO ADICIONAR emoji no inÃ­cio de linhas que JÃ COMEÃ‡AM com emoji no texto original.\n- USAR cores, espaÃ§amentos e emojis estrategicamente para facilitar a leitura por vendedores.\n- GARANTIR ESPAÃ‡AMENTO MÃ‰DIO entre seÃ§Ãµes, parÃ¡grafos, boxes e listas, evitando tanto texto corrido quanto espaÃ§os excessivos.\n\nDADOS DE ENTRADA:\n- Dados do lead/empresa (opcional).\n- RELATÃ“RIO_BRUTO: texto completo da anÃ¡lise da call, com seÃ§Ãµes e ordem originais (pode conter â€œ\\nâ€).\n\nSAÃDA ESPERADA:\n- Somente HTML inline, pronto para Gmail.\n- Estrutura moderna, visualmente atrativa e fiel ao conteÃºdo original.\n- Leitura extremamente rÃ¡pida e facilitada para times de venda, com blocos coloridos, estilo de lista e uso consistente (e controlado) de emojis.\n","role":"system"},{"content":"={{ $('AnÃ¡lise de Lead').first().json.output }}"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-432,-496],"id":"e5240460-b811-4a41-b91e-bf83d74fa0e8","name":"Cria html da analise de Lead","retryOnFail":true,"credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"jsCode":"const items = $input.first().json.sortedStories\n// FunÃ§Ã£o para formatar data (transforma 2025-08-19T21:41:15.000Z em 19/08 21:41)\nfunction formatDate(isoString) {\n    if (!isoString) return \"\";\n    try {\n        const date = new Date(isoString);\n        return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;\n    } catch (e) {\n        return \"\";\n    }\n}\n\nfor (const item of items) {\n    const rawHistory = item.json.compressedHistory || \"\";\n    \n    // Se nÃ£o tiver histÃ³rico, pula\n    if (!rawHistory) continue;\n\n    let entries = rawHistory.split('---');\n    let cleanTimeline = [];\n\n    for (let entry of entries) {\n        entry = entry.trim();\n        if (entry.length < 5) continue;\n\n        // 1. EXTRAIR A DATA (EstÃ¡ geralmente no cabeÃ§alho entre colchetes)\n        // Ex: [MUDANÃ‡A DE ETAPA (CRM) - 2025-08-19T21:42:14.000Z]\n        const dateMatch = entry.match(/(\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2})/);\n        const dateStr = dateMatch ? formatDate(dateMatch[0]) : \"Data N/A\";\n\n        // 2. FILTRO INTELIGENTE (O que manter e como formatar)\n\n        // CASO A: MudanÃ§a de Etapa (Timeline) -> Manter, mas encurtar\n        if (entry.includes('MUDANÃ‡A DE ETAPA') || entry.includes('Status do Lead alterado')) {\n            // Extrai apenas o nome da nova fase (ex: \"SCHEDULED\")\n            const statusMatch = entry.match(/para \"([^\"]+)\"/);\n            const newStatus = statusMatch ? statusMatch[1] : \"Fase Desconhecida\";\n            \n            // SÃ³ adiciona se nÃ£o for um loop de automaÃ§Ã£o inÃºtil\n            if (!['JUNK', 'ANALYSIS', 'REQUALIFICATION'].includes(newStatus)) {\n                 cleanTimeline.push(`ğŸ•’ ${dateStr} - Mudou fase para: ${newStatus}`);\n            }\n            continue; \n        }\n\n        // CASO B: Agendamentos/Cancelamentos (Manter resumido)\n        if (entry.includes('Evento marcado') || entry.includes('Cliente solicitou o cancelamento')) {\n            // Remove BBCode e deixa o texto limpo\n            let text = entry.replace(/\\[.*?\\]/g, '').replace(/<[^>]*>/g, '');\n            // Pega as primeiras 2 linhas apenas (evita links gigantes)\n            let lines = text.split('\\n').filter(l => l.trim()).slice(0, 2); \n            cleanTimeline.push(`ğŸ“… ${dateStr} - Agenda: ${lines.join(' - ')}`);\n            continue;\n        }\n\n        // CASO C: Lixo de AutomaÃ§Ã£o (REMOVER)\n        if (entry.includes('Fluxo de trabalho concluÃ­do')) continue;\n        if (entry.includes('O usuÃ¡rio SDR Novo Teste foi inativado')) continue;\n        if (entry.includes('Tarefa criada para o dia')) continue; // Log de tarefa interna\n        if (entry.includes('Ativo:  Y  | ResponsÃ¡vel')) continue; // Log de sistema\n\n        // CASO D: ConteÃºdo Humano (Mensagens, Notas, E-mails) -> MANTER COMPLETO\n        // Limpa apenas formataÃ§Ã£o suja\n        let cleanContent = entry\n            .replace(/\\[MUDANÃ‡A.*?\\]/g, '') // Remove cabeÃ§alho tÃ©cnico\n            .replace(/\\[COMENTÃRIO.*?\\]/g, '')\n            .replace(/\\[ATIVIDADE.*?\\]/g, '')\n            .replace(/\\[USER=\\d+\\].*?\\[\\/USER\\]/g, '') // Remove tags de usuÃ¡rio\n            .replace(/\\[B\\]|\\[\\/B\\]/g, '') // Remove negrito BBCode\n            .trim();\n\n        if (cleanContent.length > 0) {\n            cleanTimeline.push(`ğŸ’¬ ${dateStr} - InteraÃ§Ã£o: \\n${cleanContent}`);\n        }\n    }\n\n    // Atualiza o campo com a timeline limpa e organizada\n    item.json.compressedHistory = cleanTimeline.join('\\n\\n');\n}\n\nreturn {\n  items: JSON.stringify(items)\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1584,-496],"id":"47db443b-c5e0-4f3c-b5a9-9cfe1ffb359e","name":"Comprime texto"},{"parameters":{"model":{"__rl":true,"value":"gpt-5.1","mode":"list","cachedResultName":"gpt-5.1"},"options":{"timeout":600000}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1408,-272],"id":"ea0d1c24-996b-42bd-9fc6-65154df3a0b6","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"=ğŸš€ VocÃª Ã© um Diretor de Vendas SÃªnior no mercado imobiliÃ¡rio.  \nSua missÃ£o Ã© criar uma **AnÃ¡lise CrÃ­tica de Lead** para a Apresenta.me, **curta, objetiva e prÃ¡tica**, para uso pelo time comercial em uma reuniÃ£o de venda **jÃ¡ agendada** (briefing PRÃ‰-call, o consultor ainda nÃ£o falou com o lead).\n\nâš ï¸ REGRAS FIXAS (NÃƒO ALTERAR)  \n- Idioma: PT-BR  \n- NÃƒO altere links/IDs a seguir.  \n- Vendedor: {{ $('Busca dados do Lead').first().json.user_seller_details.name }} {{ $('Busca dados do Lead').first().json.user_seller_details.last_name }}  \n- SDR: {{ $('Busca dados do Lead').first().json.user_sdr_details.name }} {{ $('Busca dados do Lead').first().json.user_sdr_details.last_name }}  \n- Nome do Lead: \"{{ $('Busca dados do Lead').first().json.name }}\"  \n- Id do Lead (link CRM): https://crm.apresenta.me/crm/lead/details/{{ $('Busca dados do Lead').first().json.id }}/  \n- Fonte ÃšNICA de verdade: HistÃ³rico de InteraÃ§Ãµes (JSON) recebido em: {{ $json.items }}  \n- Use apenas o que estiver no histÃ³rico (e em variÃ¡veis explÃ­citas). NÃƒO invente nem complete com achismos.  \n- Identifique dentro das mensagens quem Ã© o lead; ignore suposiÃ§Ãµes sem evidÃªncia.\n\n---\n\nğŸ§  MODO DE ANÃLISE (SEM TEXTÃƒO)\n\n- Toda afirmaÃ§Ã£o importante (decisor, dor, orÃ§amento etc.) deve ter uma **evidÃªncia curta entre aspas**: â€œ...â€.  \n- NÃ£o repita informaÃ§Ãµes nem use parÃ¡grafos longos.  \n- Use bullets diretos, com mÃ¡x. 2 linhas por item.  \n- Priorize clareza, concisÃ£o e aÃ§Ã£o para vendedor e SDR.\n\n---\n\nğŸ“¤ FORMATO DA SAÃDA (EM ORDEM)\n\n---\n\n0) ğŸ§¾ **RESUMO EXECUTIVO (30 SEGUNDOS)**\n\nBloco direto, com os pontos-chave da oportunidade.  \n**Todos os bullets obrigatÃ³rios.**\n\n- ğŸ¯ **Score de fechamento:** X/10 (ğŸ§Š 0â€“3 / ğŸŒ¤ï¸ 4â€“7 / ğŸ”¥ 8â€“10) â€” â€œ...â€  \n- ğŸ§© **Fit com ICP:** X/10 (ğŸŸ¢ bom / ğŸŸ¡ mÃ©dio / ğŸ”´ baixo) â€” â€œ...â€  \n- ğŸ‘‘ **Decisor:** â€œ...â€  \n- ğŸ’° **OrÃ§amento:** â€œ...â€  \n- ğŸ—“ï¸ **Janela de compra:** â€œ...â€  \n- ğŸ’¥ **3 dores principais:**  \n  1. â€œ...â€  \n  2. â€œ...â€  \n  3. â€œ...â€  \n- âš ï¸ **Maior risco hoje:** â€œ...â€  \n- ğŸ¯ **Foco da reuniÃ£o pro vendedor:** â€œ...â€  \n- ğŸ“Œ **PrÃ³ximo passo ideal ao fim da call:** â€œ...â€\n\nSe faltar qualquer item acima, escreva â€œNÃƒO INFORMADOâ€.\n\n---\n\n1) ğŸ’¡ **DICAS & GATILHOS (VENDEDOR + SDR)**\n\nğŸ‘” **Para o VENDEDOR (converter na call):**\n\n- ğŸ™ï¸ **Abertura sugerida:**  \n  > â€œ{{ $('Busca dados do Lead').first().json.name }}, pelo que vocÃª comentou sobre â€˜â€¦â€™, hoje vou te mostrar como outras imobiliÃ¡rias resolveram isso e em quanto tempo tiveram retorno.â€\n\n- ğŸ¯ **Gatilhos para conduzir a conversa:**  \n  - â€œ...â€ (ex.: â€œancorar em ganho de tempo na locaÃ§Ã£oâ€)  \n  - â€œ...â€ (ex.: â€œmostrar seguranÃ§a na migraÃ§Ã£o do sistema atualâ€)  \n\n- ğŸ–¥ï¸ **O que NÃƒO pode faltar na demo:**  \n  - ğŸ’¬ Apre.Chat â†’ â€œ...â€  \n  - ğŸ§¾ ERP / automaÃ§Ã£o de locaÃ§Ã£o â†’ â€œ...â€  \n  - ğŸ’³ ApBank â†’ â€œ...â€  \n  - âœï¸ Assinatura EletrÃ´nica / Vistoria â†’ â€œ...â€\n\nğŸ“ **Para o SDR (se faltar dados):**\n\nSe estiver tudo completo:  \n- ğŸ“ **SDR:** â€œdados de qualificaÃ§Ã£o completos, sem aÃ§Ãµes adicionais.â€\n\nSe houver lacunas:  \n- â“ **Perguntas obrigatÃ³rias para completar qualificaÃ§Ã£o:**  \n  1. ğŸ‘‘ â€œ...?â€ (decisor)  \n  2. ğŸ’° â€œ...?â€ (budget / quanto paga hoje)  \n  3. ğŸ—“ï¸ â€œ...?â€ (quando quer implementar / resolver)  \n  4. ğŸ”¥ â€œ...?â€ (onde dÃ³i mais)  \n  5. ğŸ¢ â€œ...?â€ (carteira / equipe, se faltar)\n\n---\n\n2) ğŸ” **CONTEXTO DO LEAD & OPORTUNIDADE**\n\n- ğŸ‘¤ **Contato principal / cargo:** â€œ...â€ â†’ evidÃªncia â€œ...â€  \n- ğŸ’¼ **Sistema atual / concorrente:** â€œ...â€ â†’ â€œ...â€  \n- ğŸ”¥ **Top 3 dores:**  \n  1. â€œ...â€  \n  2. â€œ...â€  \n  3. â€œ...â€  \n- ğŸ¯ **Motivadores principais:** (â³ tempo / ğŸ’¸ dinheiro / ğŸ—‚ï¸ organizaÃ§Ã£o / ğŸ›¡ï¸ seguranÃ§a)  \n  â†’ â€œ...â€\n\n---\n\n3) â±ï¸ **LINHA DO TEMPO ESSENCIAL**\n\n- ğŸ“… DD/MM â€” â€œ...â€ (primeiro contato / origem)  \n- ğŸ“… DD/MM â€” â€œ...â€ (avanÃ§o ou trava relevante)  \n- ğŸ” Seguimento / reagendamento â€” â€œ...â€  \n- âš ï¸ Oportunidade de melhoria do SDR â€” â€œ...â€\n\nSe aplicÃ¡vel:  \n- ğŸ§± **Ponto-chave de melhoria do SDR:** â€œ...â€ (curto e direto)\n\n---\n\n4) âš ï¸ **INSIGHTS FINAIS & CHECK DE QUALIFICAÃ‡ÃƒO**\n\n4.1 ğŸ” **Insights & Riscos (para o Vendedor)**\n\n- âœ… **Sinais positivos:**  \n  - â€œ...â€  \n  - â€œ...â€  \n- âš ï¸ **Riscos / travas:**  \n  - â€œ...â€  \n  - â€œ...â€  \n- ğŸ§© **Postura recomendada na call:**  \n  - â€œ...â€  \n  - â€œ...â€\n\n4.2 ğŸ§± **Feedback rÃ¡pido para SDR**  \n(Preencher sÃ³ se houver algo claro)\n\n- ğŸ§± **Pontos de melhoria do SDR:**  \n  - â€œ...â€\n\nSe nÃ£o houver:  \n- ğŸ§± **SDR:** â€œsem pontos de melhoria relevantes identificados.â€\n\n4.3 âœ… **CHECK DE QUALIFICAÃ‡ÃƒO VISUAL**\n\n- ğŸ‘‘ **Decisor:** ğŸ”´/ğŸŸ¡/ğŸŸ¢ â€” â€œ...â€  \n- ğŸ’° **OrÃ§amento:** ğŸ”´/ğŸŸ¡/ğŸŸ¢ â€” â€œ...â€  \n- ğŸ—“ï¸ **Janela de compra:** ğŸ”´/ğŸŸ¡/ğŸŸ¢ â€” â€œ...â€  \n- ğŸ”¥ **3 dores claras:** ğŸ”´/ğŸŸ¡/ğŸŸ¢ â€” â€œ...â€  \n- ğŸ’¼ **Sistema atual / concorrente:** ğŸ”´/ğŸŸ¡/ğŸŸ¢ â€” â€œ...â€  \n- ğŸ§© **Fit com ICP:** ğŸ”´/ğŸŸ¡/ğŸŸ¢ â€” â€œ...â€\n\nğŸ“Œ Regras:  \n- Sem evidÃªncia â†’ ğŸ”´ + â€œNÃƒO INFORMADOâ€  \n- InformaÃ§Ã£o vaga â†’ ğŸŸ¡  \n- InformaÃ§Ã£o clara â†’ ğŸŸ¢\n","options":{"returnIntermediateSteps":true}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2,"position":[-1360,-496],"id":"48c12300-3445-439a-9bba-f608910372fb","name":"AnÃ¡lise de Lead","retryOnFail":false}],"connections":{"Webhook (Lead Timeline)":{"main":[[{"node":"Salva Log no Lead","type":"main","index":0}]]},"Mapear dados do CRM":{"main":[[{"node":"Se tiver call na timeline","type":"main","index":0}]]},"Valida parÃ¢metros":{"main":[[{"node":"Busca dados do Lead","type":"main","index":0}]]},"Buscar dados da Timeline do Lead":{"main":[[{"node":"Filtra por call","type":"main","index":0}]]},"Filtra por Ã¡udio":{"main":[[{"node":"Normaliza dados","type":"main","index":0}]]},"Filtra por call":{"main":[[{"node":"Mapear dados do CRM","type":"main","index":0}]]},"Junta as transcriÃ§Ãµes com a timeline":{"main":[[{"node":"Junta mensagens com histÃ³rico da timeline do Lead","type":"main","index":0}]]},"Junta as transcriÃ§Ãµes com as mensagens":{"main":[[{"node":"Junta mensagens com histÃ³rico da timeline do Lead","type":"main","index":1}]]},"Busca dados do Lead":{"main":[[{"node":"Se o Lead jÃ¡ tiver anÃ¡lise","type":"main","index":0}]]},"Busca Mensagens do lead no Apre.Chat":{"main":[[{"node":"If","type":"main","index":0}]]},"Junta mensagens com histÃ³rico da timeline do Lead":{"main":[[{"node":"Ordena por data de criaÃ§Ã£o","type":"main","index":0}]]},"Transcrever calls":{"main":[[{"node":"Junta as transcriÃ§Ãµes com a timeline","type":"main","index":0}]]},"Mapear url das calls":{"main":[[{"node":"Transcrever calls","type":"main","index":0}]]},"Mapear url dos Ã¡udios":{"main":[[{"node":"Transcrever audios","type":"main","index":0}]]},"Transcrever audios":{"main":[[{"node":"Junta as transcriÃ§Ãµes com as mensagens","type":"main","index":0}]]},"Verifica se o Lead tem WhatsApp cadastrado":{"main":[[{"node":"Busca Mensagens do lead no Apre.Chat","type":"main","index":0}]]},"Ordena por data de criaÃ§Ã£o":{"main":[[{"node":"Comprime texto","type":"main","index":0}]]},"Normaliza dados":{"main":[[{"node":"Verifica se tem audio nas mensagens","type":"main","index":0}]]},"Salva Log no Lead":{"main":[[{"node":"Valida parÃ¢metros","type":"main","index":0}]]},"âœï¸ Altera dados do Lead":{"main":[[{"node":"Salva comentÃ¡rio com AnÃ¡lise no Lead","type":"main","index":0}]]},"Salva comentÃ¡rio com AnÃ¡lise no Lead":{"main":[[{"node":"Cria html da analise de Lead","type":"main","index":0}]]},"Ajusta informaÃ§Ãµes":{"main":[[{"node":"âœï¸ Altera dados do Lead","type":"main","index":0}]]},"Se tiver call na timeline":{"main":[[{"node":"Mapear url das calls","type":"main","index":0}],[{"node":"Junta mensagens com histÃ³rico da timeline do Lead","type":"main","index":0}]]},"Se o Lead jÃ¡ tiver anÃ¡lise":{"main":[[{"node":"Altera da da Ãºltima AnÃ¡lise de Lead","type":"main","index":0}],[{"node":"Buscar dados da Timeline do Lead","type":"main","index":0},{"node":"Remove caracteres diferentes de numero e espaÃ§o do whatsapp do lead","type":"main","index":0}]]},"Verifica se tem audio nas mensagens":{"main":[[{"node":"Mapear url dos Ã¡udios","type":"main","index":0}],[{"node":"Junta mensagens com histÃ³rico da timeline do Lead","type":"main","index":1}]]},"If":{"main":[[{"node":"Filtra por Ã¡udio","type":"main","index":0}]]},"Remove caracteres diferentes de numero e espaÃ§o do whatsapp do lead":{"main":[[{"node":"Verifica se o Lead tem WhatsApp cadastrado","type":"main","index":0}]]},"Cria html da analise de Lead":{"main":[[{"node":"Envia anÃ¡lise por e-mail","type":"main","index":0}]]},"Comprime texto":{"main":[[{"node":"AnÃ¡lise de Lead","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AnÃ¡lise de Lead","type":"ai_languageModel","index":0}]]},"AnÃ¡lise de Lead":{"main":[[{"node":"Ajusta informaÃ§Ãµes","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook (Lead Timeline)":[{"json":{"headers":{"host":"n8n.apresenta.me","x-real-ip":"172.71.164.20","x-real-port":"15846","x-forwarded-for":"52.29.163.104, 172.71.164.20","x-forwarded-proto":"http","x-forwarded-host":"n8n.apresenta.me","x-forwarded-port":"80","remote-host":"172.71.164.20","connection":"close","content-length":"311","user-agent":"Bitrix24 Webhook Engine","accept-encoding":"gzip, br","content-type":"application/x-www-form-urlencoded","cf-ray":"9a74aa91aeb7d236-FRA","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"52.29.163.104","cf-ipcountry":"DE","cf-visitor":"{\"scheme\":\"https\"}"},"params":{},"query":{"leadId":"139285","force":"Y"},"body":{"document_id[0]":"crm","document_id[1]":"CCrmDocumentLead","document_id[2]":"LEAD_139285","auth[domain]":"crm.apresenta.me","auth[client_endpoint]":"https://crm.apresenta.me/rest/","auth[server_endpoint]":"https://oauth.bitrix.info/rest/","auth[member_id]":"e0399350f7ed44f078e2b21954de695d"},"webhookUrl":"https://n8n.apresenta.me/webhook/lead-timeline","executionMode":"production"}}]},"versionId":"69d91000-57aa-4b03-87d1-535ea0edd120","triggerCount":1,"shared":[{"updatedAt":"2025-08-16T14:49:36.984Z","createdAt":"2025-08-16T14:49:36.984Z","role":"workflow:owner","workflowId":"Mf8XNJsuIL3652pf","projectId":"4ToGMYJEWvvDSbcz"}],"tags":[]}