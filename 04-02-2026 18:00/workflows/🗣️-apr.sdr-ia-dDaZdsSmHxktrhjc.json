{"updatedAt":"2026-02-04T20:54:43.000Z","createdAt":"2025-11-04T18:47:16.651Z","id":"dDaZdsSmHxktrhjc","name":"ðŸ—£ï¸ Apr.SDR IA","active":true,"isArchived":false,"nodes":[{"parameters":{"operation":"set","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","value":"={{ JSON.stringify({ \n  stage_id: $json.newStageId, \n  vars: $json.updatedVars, \n  missingVar: $json.missingVar, \n  afterRepliedInstruction: $json.missingVar.afterRepliedInstruction, \n  lastInstruction: $json.finalInstruction\n}) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-144,3232],"id":"738d4eef-8303-464e-8462-dba3d8f1f028","name":"Salva Novo Estado","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"hasQuestion\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se o usuÃ¡rio fez uma pergunta tÃ©cnica ou comercial que exige consulta Ã  base de conhecimento.\"\n    },\n    \"searchQuery\": {\n      \"type\": \"string | null\",\n      \"description\": \"Uma frase curta e descritiva otimizada para busca semÃ¢ntica, unindo a dÃºvida do usuÃ¡rio com o contexto da conversa (substituindo pronomes pelo assunto real).\"\n    }\n  },\n  \"required\": [\"hasQuestion\", \"searchQuery\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[224,3456],"id":"1e0d9efa-c9a0-4034-9780-5020f7291e27","name":"Parser Router"},{"parameters":{"options":{"temperature":0.1}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[96,3456],"id":"aac02e21-f12c-4c7d-873c-9c1800e3438c","name":"OpenAI Router","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"=# SYSTEM: Engenheiro de Busca Contextual (Universal RAG Router)\n\nSua missÃ£o Ã© atuar como um middleware de inteligÃªncia analÃ­tica. VocÃª deve processar a interaÃ§Ã£o entre o usuÃ¡rio e o assistente para decidir se existe uma demanda de conhecimento externo e reconstruir essa demanda em uma consulta autocontida.\n\n### [CONTEXTO ANALÃTICO]\n- **MENSAGEM ATUAL:** \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n- **HISTÃ“RICO RECENTE:**\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"Sem histÃ³rico.\" }}\n\n### [ALGORITMO DE RACIOCÃNIO - EXECUÃ‡ÃƒO OBRIGATÃ“RIA]\n\n1. **MAPEAMENTO DE ENTIDADES (CONTEXTO):** Varra o [HISTÃ“RICO RECENTE] em busca do Ãºltimo substantivo tÃ©cnico, produto, serviÃ§o ou regra de negÃ³cio que foi o foco da fala da IA ou do usuÃ¡rio. Esta Ã© a sua \"Entidade de DomÃ­nio\".\n\n2. **ANÃLISE DE INTENÃ‡ÃƒO (TRIAGEM):** Avalie se a [MENSAGEM ATUAL] busca fatos, explicaÃ§Ãµes, valores, capacidades ou procedimentos sobre a Entidade de DomÃ­nio identificada.\n   - **hasQuestion = TRUE:** Se a mensagem for uma pergunta direta, uma contestaÃ§Ã£o (\"Mas por que?\") ou uma busca por detalhes tÃ©cnicos/comerciais.\n   - **hasQuestion = FALSE:** Se a mensagem for apenas um fornecimento de dado pessoal, uma saudaÃ§Ã£o, uma reaÃ§Ã£o emocional ou uma confirmaÃ§Ã£o de fluxo (Sim/NÃ£o/Ok).\n\n3. **SÃNTESE DE CONSULTA (SEARCH QUERY):** Se `hasQuestion` for true, vocÃª deve gerar uma frase de busca que seja **totalmente autocontida**.\n   - **Regra de AutossuficiÃªncia:** A frase deve ser compreensÃ­vel para um estranho que nÃ£o leu o histÃ³rico da conversa.\n   - **TÃ©cnica de ExpansÃ£o:** Substitua pronomes e termos vagos (isso, aquilo, como faz, quanto Ã©) pelos termos tÃ©cnicos e nomes reais encontrados no histÃ³rico.\n   - **FÃ³rmula LÃ³gica:** [Nome Exato da Entidade/Produto] + [AÃ§Ã£o ou Atributo Desejado (PreÃ§o, Funcionamento, Regra, IntegraÃ§Ã£o)].\n   - **OtimizaÃ§Ã£o:** Remova qualquer ruÃ­do social (Bom dia, obrigado, opa) e foque em termos que apareceriam em um Ã­ndice de documentaÃ§Ã£o tÃ©cnica.\n\n### [REGRAS DE SAÃDA - DETERMINÃSTICO]\n- **hasQuestion (boolean):** TRUE para necessidades de consulta ao RAG; FALSE para continuidade conversacional.\n- **searchQuery (string):** A string de busca sintetizada e expandida. Caso `hasQuestion` seja false, retorne obrigatoriamente `null`.\n\n### [SAÃDA OBRIGATÃ“RIA - JSON PURO]\nResponda EXCLUSIVAMENTE com o objeto JSON. Ã‰ terminantemente proibido incluir blocos de cÃ³digo markdown (```json), explicaÃ§Ãµes ou qualquer texto fora das chaves.\n\n{ \n  \"hasQuestion\": boolean, \n  \"searchQuery\": \"string ou null\" \n}","hasOutputParser":true,"options":{"systemMessage":"VocÃª Ã© um classificador de intenÃ§Ã£o binÃ¡rio."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[80,3232],"id":"327e946c-4df1-4a66-8de8-302008a1d2e2","name":"Router de DÃºvida","executeOnce":true,"onError":"continueRegularOutput"},{"parameters":{"httpMethod":"POST","path":"7223c6af-f595-4bc2-b84c-602b8900cd08","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-4608,3328],"id":"297535a6-9e37-4bca-a09c-fe84dde17538","name":"Webhook","webhookId":"7223c6af-f595-4bc2-b84c-602b8900cd08"},{"parameters":{"jsCode":"return { \n  cache_key: `session_${$json.body.ticketId}`,\n  companyId: $json.body.companyId,\n  whatsappId: $json.body.whatsappId,\n  user_msg: $json.body.message,\n  user_phone: $json.body.contact.number,\n  timestamp: new Date().getTime()\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4384,3328],"id":"d70c4970-e8e5-4cd6-af88-9d8786224bef","name":"Configura Contexto"},{"parameters":{"operation":"get","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2000,3248],"id":"31d9859b-d634-498e-ad98-c8349ddf9c5a","name":"GET Estado Atual","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"// --- BLUEPRINT COMPLETO (Baseado na sua regra de negÃ³cio original) ---\nconst workflow = {\n  START: {\n    type: \"message\",\n    instruction:\n      \"Apresente-se como Alicia da Apresenta.me. Seja breve e pergunte o nome.\",\n    next_stage: \"WAIT_NAME\",\n  },\n  WAIT_NAME: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"name\",\n        afterRepliedInstruction: \"Diga ao lead que Ã© um prazer conhecÃª-lo.\",\n        description: \"Nome do Lead\",\n      },\n    ],\n    next_stage: \"ASK_WANT_DATA_COLLECTION\",\n  },\n  ASK_WANT_DATA_COLLECTION: {\n    type: \"message\",\n    instruction:\n      'Pergunte ao Lead se ele aceita participar de uma coleta de dados, usando a seguinte mensagem: \"[NOME], sÃ³ pra te explicar um pouco mais sobre a Apresenta.me: nÃ³s centralizamos a operaÃ§Ã£o da imobiliÃ¡ria em um sÃ³ lugar, ajudando a organizar processos, ganhar eficiÃªncia e aumentar conversÃµes, com uma tecnologia simples e suporte humanizado. Se fizer sentido pra vocÃª, seguimos com alguns dados essenciais pra agendar a demonstraÃ§Ã£o, pode ser ?\"',\n    next_stage: \"WAIT_WANT_DATA_COLLECTION\",\n  },\n  WAIT_WANT_DATA_COLLECTION: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"wantDataCollection\",\n        afterRepliedInstruction: `Se o usuÃ¡rio estÃ¡ aceitando a coleta de dados, de abertura para a coleta de dados. Ex: \"Show, [nome do lead], entÃ£o vamos lÃ¡\".`,\n        description: \"Se o usuÃ¡rio QUER participar da COLETA DE DADOS.\",\n      },\n    ],\n    next_stage: \"ROUTER_DATA_COLLECTION\",\n  },\n  ROUTER_DATA_COLLECTION: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"wantDataCollection\",\n        value: false,\n        next_stage: \"SEND_COMMERCIAL_PRESENTATION\",\n      },\n      { default: \"ASK_ROLE\" },\n    ],\n  },\n  SEND_COMMERCIAL_PRESENTATION: {\n    type: \"message\",\n    instruction:\n      \"Responda para o Lead: [NOME DO LEAD], estou te enviando nossa apresentaÃ§Ã£o comercial! Caso vocÃª mude de ideia e queira nos conhecer melhor, Ã© sÃ³ avisar. AtÃ© mais!\",\n    next_stage: \"STOP\",\n  },\n  ASK_ROLE: {\n    type: \"message\",\n    instruction: \"Pergunte qual o cargo ou funÃ§Ã£o dele na imobiliÃ¡ria.\",\n    next_stage: \"WAIT_ROLE\",\n  },\n  WAIT_ROLE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"role\",\n        afterRepliedInstruction: `Se o Lead informou um cargo vÃ¡lido, responda na tonalidade do lead, validando o cargo dele, em Ãºltimos casos, responda algo como: \"Perfeito, [NOME DO LEAD], obrigada por compartilhar!\"`,\n        description:\n          'Cargo ou funÃ§Ã£o na imobiliÃ¡ria. NÃƒO MOSTRAR EXEMPLOS PARA O USUÃRIO. A RESPOSTA SEMPRE DEVE AUTOMATICAMENTE ATRIBUIR VALOR PARA \"isAutonomous\". Considere \"isAutonomous\" com false apenas quando o usuÃ¡rio INDICAR que trabalha sozinho, ou falar de forma explicita que Ã© autÃ´nomo.',\n      },\n      {\n        name: \"isAutonomous\",\n        description:\n          \"(CAMPO LÃ“GICO): Defina AUTOMATICAMENTE TRUE se o usuÃ¡rio trabalha sozinho/autÃ´nomo (isso deve ser indicado pelo LEAD). Defina FALSE se for imobiliÃ¡ria/equipe/sÃ³cio/dono/auxiliar etc.\",\n        type: \"boolean\",\n      },\n    ],\n    next_stage: \"ROUTER_PROFILE\",\n  },\n  // --- DECISÃƒO: AUTÃ”NOMO VS IMOBILIÃRIA ---\n  ROUTER_PROFILE: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"isAutonomous\",\n        value: true,\n        next_stage: \"ASK_RENTAL_STATUS\",\n      }, // AutÃ´nomo pula tamanho do time\n      { default: \"ASK_TEAM_SIZE\" },\n    ],\n  },\n  ASK_TEAM_SIZE: {\n    type: \"message\",\n    instruction: \"Pergunte quantas pessoas trabalham na imobiliÃ¡ria hoje.\",\n    next_stage: \"WAIT_TEAM_SIZE\",\n  },\n  WAIT_TEAM_SIZE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"teamSize\",\n        afterRepliedInstruction:\n          'Se o lead estiver em um cargo de gerencia E a equipe for MAIOR que 10: \"Bacana, [NOME DO LEAD], deve tÃ¡ corrido pra vocÃªs gerenciar todo esse pessoal, nÃ©?\".\\n Se a quantidade de pessoas na equipe for menor do que 10 pessoas, responda naturalmente: \"Show, [NOME DO LEAD]!!\"',\n        description: \"Tamanho total da equipe (sÃ³cios + corretores)\",\n      },\n    ],\n    next_stage: \"ASK_RENTAL_STATUS\",\n  },\n  ASK_RENTAL_STATUS: {\n    type: \"message\",\n    instruction:\n      'Pergunte se eles jÃ¡ trabalham com locaÃ§Ãµes ou estÃ£o estruturando agora. Ex: \"[NOME DO LEAD], e hoje, vocÃªs jÃ¡ trabalham com locaÃ§Ãµes ou estÃ£o comeÃ§ando a estruturar ?\"',\n    next_stage: \"WAIT_RENTAL_STATUS\",\n  },\n  WAIT_RENTAL_STATUS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"rentalStatus\",\n        afterRepliedInstruction: `Se o usuÃ¡rio disser que Ã© focado em vendas, sem indicar que trabalha com locaÃ§Ãµes: \"Entendi, [NOME DO LEAD]. Como vocÃªs sÃ£o focados em venda, Ã© necessÃ¡rio ter um bom sistema de fÃºnil, para follow-up e um bom CRM pra manter o histÃ³rico dos Leads, isso tudo a Apresenta.me te entrega!! Mas vocÃªs trabalham com locaÃ§Ãµes tambÃ©m, ou somente vendas?\". Se o usuÃ¡rio disser que trabalha com locaÃ§Ãµes : \"Bacana, [NOME DO LEAD], pra trabalhar com locaÃ§Ãµes, tem que ter um bom sistema. Quando me refiro Ã  um \"bom sistema\", digo um sistema que trabalhe pra vocÃªs, e nÃ£o que faÃ§a vocÃªs trabalharem mais. E isso Ã© o que o nosso sistema melhor oferece, automaÃ§Ã£o de processos, alÃ©m de ser um sistema completo que agrupa tudo em um lugar sÃ³.\". Se o usuÃ¡rio disser que sÃ³ trabalha com vendas: \\\"Entendi, [NOME DO LEAD]. Como vocÃªs sÃ£o focados em venda, Ã© necessÃ¡rio ter um bom sistema de fÃºnil, para follow-up e um bom CRM pra manter o histÃ³rico dos Leads, isso tudo a Apresenta.me te entrega!!\\\"\"`,\n        description:\n          \"Momento atual da imobiliÃ¡ria em relaÃ§Ã£o a locaÃ§Ã£o (jÃ¡ trabalham, estÃ£o comeÃ§ando a estruturar, ou nÃ£o trabalham). NÃƒO MOSTRE NENHUMA OPÃ‡ÃƒO PARA O USUÃRIO, DEIXE ELE RESPONDER LIVREMENTE. (Preencha com as opÃ§Ãµes: active = se jÃ¡ trabalha / starting = se comeÃ§ando / none = se nÃ£o trabalha ou se trabalha somente com vendas). Se ele jÃ¡ trabalha com locaÃ§Ãµes, defina o valor de \\\"interestFocus\\\" como 'all'\",\n      },\n    ],\n    next_stage: \"ASK_PORTFOLIO_SIZE\",\n  },\n  ASK_PORTFOLIO_SIZE: {\n    type: \"message\",\n    instruction:\n      \"Pergunte a quantidade total de imÃ³veis que o Lead/imobiliÃ¡ria tem na carteira, contando venda e locaÃ§Ã£o. Se o lead trabalhar somenta com vendas, nÃ£o cite locaÃ§Ã£o, e vice-versa.\",\n    next_stage: \"WAIT_PORTFOLIO_SIZE\",\n  },\n  WAIT_PORTFOLIO_SIZE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"portfolioSize\",\n        afterRepliedInstruction: `Se o usuÃ¡rio informar o tamanho do portifÃ³lio, entenda o contexto do LEAD, faÃ§a um comentÃ¡rio sobre o tamanho do portifÃ³lio, exemplo (adapte e humanize): \"Entendi, [NOME DO LEAD]. com essa carteira jÃ¡ Ã© preciso ter uma boa organizaÃ§Ã£o.\"`,\n        description:\n          \"Quantidade total de imÃ³veis na carteira (venda + locaÃ§Ã£o). Se o lead trabalhar somenta com vendas, nÃ£o cite locaÃ§Ã£o, e vice-versa.\",\n      },\n    ],\n    next_stage: \"ASK_INTEREST_FOCUS\"\n  },\n  ASK_INTEREST_FOCUS: {\n    type: \"message\",\n    instruction:\n      'Informe que a Apresenta.me entrega um sistema completo, com site, crm e gestÃ£o financeira e pergunte ao usuÃ¡rio quais dessas opÃ§Ãµes ele precisa, em especÃ­fico. Ex: \"[NOME DO LEAD], hoje a gente entrega um sistema completo, com site, crm e gestÃ£o fincanceira, quais desses mÃ³dulos fazem sentido pra vocÃª?\"',\n    next_stage: \"WAIT_INTEREST_FOCUS\",\n  },\n  WAIT_INTEREST_FOCUS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"interestFocus\",\n        description:\n          \"Quais mÃ³dulos do sistema o usuÃ¡rio estÃ¡ interessado: Site + CRM, GestÃ£o financeira ou todos.\",\n        afterRepliedInstruction:\n          'Se o usuÃ¡rio estiver insistindo em uma opÃ§Ã£o invÃ¡lida, responda-o que nÃ£o vendemos a opÃ§Ã£o avulsa. Ex: \"[NOME DO LEAD], que pena! Infelizmente a gente nÃ£o vende nenhum mÃ³dulo avulso...\". Se o usuÃ¡rio quiser sÃ³ site: responda-o que nÃ£o vendemos site avulso. Ex: \"Entendo, [NOME DO LEAD]! O site Ã© justamente a porta de entrada pra divulgar seus imÃ³veis. Aqui ele jÃ¡ vem integrado ao CRM, o que ajuda vocÃª a receber os leads e acompanhar as vendas sem perder contato. Faz sentido pra vocÃª CRM e site integrados?\". Se o usuÃ¡rio quiser somente CRM: responda-o que na contrataÃ§Ã£o do CRM o site jÃ¡ vem integrado e que nÃ£o vendemos o CRM separado. Ex: \"Legal, [NOME DO LEAD]! Na contrataÃ§Ã£o do CRM, o site jÃ¡ vem integrado, mas nÃ£o Ã© possÃ­vel contratar CRM avulso. Faz sentido pra vocÃª CRM e site integrados?\". Se o usuÃ¡rio estÃ¡ insistindo na mesma opÃ§Ã£o invÃ¡lida (Ã© no mÃ­nimo a segunda fez que ele afirma que quer a mesma opÃ§Ã£o inexistente), ignore essa instruÃ§Ã£o. Se o usuÃ¡rio forneceu uma opÃ§Ã£o/resposta vÃ¡lida: \"Show de bola [NOME DO LEAD], pode ter certeza que vamos conseguir te entregar bons resultados com [OPÃ‡ÃƒO QUE O LEAD ESCOLHEU (Site + CRM ou Sistema completo/todos os mÃ³dulos)].\"',\n        options: {\n          site_crm:\n            \"Se o usuÃ¡rio quiser site + CRM. NÃ£o selecione essa opÃ§Ã£o se ele apenas disser que quer site ou se ele apenas disser que quer CRM.\",\n          all: \"Se o usuÃ¡rio jÃ¡ trabalhar com locaÃ§Ã£o, selecione obrigatoriamente essa opÃ§Ã£o, ou se ele dizer que quer site + crm + gestÃ£o financeira.\",\n          invalid_option:\n            \"Se o usuÃ¡rio precisar de uma opÃ§Ã£o inexistente (ex: SÃ³ site, sÃ³ CRM, sÃ³ gestÃ£o financeira). Ou se ele falar que precisa de site, mas nÃ£o citar que precisa de crm. Ou se ele falar que precisa de CRM, mas nÃ£o citar que precisa de site.\",\n        },\n      },\n    ],\n    next_stage: \"ROUTER_INVALID_INTEREST_FOCUS\",\n  },\n  ROUTER_INVALID_INTEREST_FOCUS: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"interestFocus\",\n        value: \"invalid_option\",\n        next_stage: \"ASK_INTEREST_FOCUS_2\",\n      },\n      { default: \"ASK_CURRENT_SYSTEM\" },\n    ],\n  },\n  ASK_INTEREST_FOCUS_2: {\n    type: \"message\",\n    instruction:\n      'Se o usuÃ¡rio quiser sÃ³ site: responda-o que nÃ£o vendemos site avulso. Ex: \"Entendo, [NOME DO LEAD]! O site Ã© justamente a porta de entrada pra divulgar seus imÃ³veis. Aqui ele jÃ¡ vem integrado ao CRM, o que ajuda vocÃª a receber os leads e acompanhar as vendas sem perder contato. Faz sentido pra vocÃª CRM e site integrados?\". Se o usuÃ¡rio quiser somente CRM: responda-o que na contrataÃ§Ã£o do CRM o site jÃ¡ vem integrado e que nÃ£o vendemos o CRM separado. Ex: \"Legal, [NOME DO LEAD]! Na contrataÃ§Ã£o do CRM, o site jÃ¡ vem integrado, mas nÃ£o Ã© possÃ­vel contratar CRM avulso. Faz sentido pra vocÃª CRM e site integrados?\"',\n    next_stage: \"ROUTER_INVALID_INTEREST_FOCUS_2\",\n  },\n  ROUTER_INVALID_INTEREST_FOCUS_2: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"interestFocus\",\n        value: \"invalid_option\",\n        next_stage: \"CLOSING_WHEN_INVALID_OPTION\",\n      },\n      { default: \"ASK_CURRENT_SYSTEM\" },\n    ],\n  },\n  ASK_PAIN_POINT: {\n    type: \"message\",\n    instruction:\n      'Se o lead nÃ£o tem utiliza nenhum sistema: cite o cenÃ¡rio do lead e pergunte qual a PRINCIPAL DOR do lead.\\n Ex: (Adapte esse exemplo para o cenÃ¡rio do lead): \"[NOME DO LEAD], com x colaboradores, x imÃ³veis na carteira, trabalhando com vendas e locaÃ§Ãµes, o que vocÃª apontaria como o maior problema ou dor de vocÃªs aÃ­ na [NOME DA IMOBILIÃRIA (se cidado), ou NA IMOBILIÃRIA]? Seja na gestÃ£o financeira, automaÃ§Ã£o de processos, vendas, etc.\". Se o usuÃ¡rio jÃ¡ utiliza algum sistema ou CRM imobiliÃ¡rio: valide e pergunte quais sÃ£o os problemas existentes no sistema atual. Ex: \"Certo, [NOME DO LEAD]. O que hoje no sistema que vocÃªs usam acaba nÃ£o acompanhando o crescimento ou a rotina de vocÃªs?\"',\n    next_stage: \"WAIT_PAIN_POINT\",\n  },\n  WAIT_PAIN_POINT: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"mainPainPoint\",\n        afterRepliedInstruction:\n          \"Valide a dor do cliente do cliente de forma humana. Pegue o problema do Lead e procure por funcionalidades na base de conhecimento que resolvam o problema do lead e forme um texto breve e de fÃ¡cil leitura com as funcionalidades/soluÃ§Ãµes existentes e explique para o Lead como a Apresenta.me pode solucionar seus problemas.\",\n        description: \"Principal dor, problema ou gargalo citado pelo lead\",\n      },\n    ],\n    next_stage: \"ROUTER_LOCACAO\",\n  },\n  ASK_CURRENT_SYSTEM: {\n    type: \"message\",\n    instruction:\n      'Pergunte se jÃ¡ utilizam algum sistema ou CRM imobiliÃ¡rio hoje, e qual. Se no meio da conversa o usuÃ¡rio indicar que nÃ£o tem um CRM, pergunte SOMENTE se ele jÃ¡ utiliza algum Sistema ImobiliÃ¡rio. Ex: \"[NOME DO LEAD], pra eu me contextualizar melhor, vocÃªs jÃ¡ estÃ£o utilizando algum sistema imobiliÃ¡rio ou CRM pra melhorar o processo de vocÃªs? Se sim, qual ?\" ',\n    next_stage: \"WAIT_CURRENT_SYSTEM\",\n  },\n  WAIT_CURRENT_SYSTEM: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"currentSystem\",\n        afterRepliedInstruction:\n          'Se o lead jÃ¡ utiliza algum sistema ou CRM imobiliÃ¡rio: pergunte quais sÃ£o os problemas existentes no sistema atual. Ex: \"Legal, [NOME DO LEAD]. O que hoje no sistema que vocÃªs usam acaba nÃ£o acompanhando o crescimento ou a rotina de vocÃªs?\". Se o lead nÃ£o utiliza nenhum sistema ou CRM imobiliÃ¡rio, valide a dor do lead, entendendo que processos manuais os tomam muito tempo e que a Apresenta.me consegue automatizar diversos processos, facilitando a vida da imobiliÃ¡ria, se necessÃ¡rio.',\n        description: \"Nome do sistema atual (ex: Kenlo, Jetimob, Planilhas)\",\n      },\n    ],\n    next_stage: \"ASK_PAIN_POINT\",\n  },\n  // --- DECISÃƒO: APROFUNDAR LOCAÃ‡ÃƒO? ---\n  ROUTER_LOCACAO: {\n    type: \"router\",\n    rules: [\n      // Se jÃ¡ tem locaÃ§Ã£o ativa ('active'), pergunta detalhes tÃ©cnicos\n      {\n        variable: \"rentalStatus\",\n        value: \"active\",\n        next_stage: \"ASK_CONTRACT_DETAILS\",\n      },\n      // Se nÃ£o tem ou estÃ¡ comeÃ§ando, vai direto pro orÃ§amento\n      { default: \"ASK_PLAN\" },\n    ],\n  },\n  ASK_CONTRACT_DETAILS: {\n    type: \"message\",\n    instruction:\n      'Pergunte quantos contratos ativos administram e como fazem o repasse dos valores dos aluguÃ©is para proprietÃ¡rios e corretores hoje. Ex: \"Pra gente entender mehor, qual Ã© o nÃºmero de contratos ativos pra locaÃ§Ã£o que vocÃªs possuem? E hoje, como fazem os repasses para os proprietÃ¡rios e corretores ?\"',\n    next_stage: \"WAIT_CONTRACT_DETAILS\",\n  },\n  WAIT_CONTRACT_DETAILS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"numberOfContracts\",\n        afterRepliedInstruction:\n          \"Baseando-se no cenÃ¡rio que o LEAD jÃ¡ informou ao longo da conversa:\\n Se anteriormente ele disse que utilizam sistemas genÃ©ricos (como planilhas) ou que nÃ£o usam nenhum sistema imobiliÃ¡rio e se tiver um nÃºmero consideravelmente alto de contratos: mencione para o lead que com a quantidade de contratos mencionado pelo lead, deve ser um desafio fazer o gerenciamento sem um sistema imobiliÃ¡rio; Se tiver um numero de contratos considerÃ¡velmente alto e jÃ¡ utilizar algum sistema imobiliÃ¡rio: validar de forma simples e natural, sem elogiar ou desdenhar; Se o usuÃ¡rio informou tambÃ©m o mÃ©todo de repasse: adicione uma validaÃ§Ã£o final para o repasse: Se o lead indicar que Ã© manual/banco: Cite o cenÃ¡rio dele, e diga que no cenÃ¡rio que o lead informou, fazer repasse manual em 2026 Ã© inaceitÃ¡vel e informe que a Apesenta.me dispÃµe de funcionalidades que automatizam esse processo; Se ele indicar que o repasse jÃ¡ Ã© feito de forma automÃ¡tica de enfase ao nosso produto/funcionalidade: valide a fala do Lead e diga que aqui na Apresenta.me entregamos a funcionalidade de repasse automÃ¡tico tambÃ©m e que tem ajudado muito nossos clientes.\",\n        description: \"Quantidade de contratos de locaÃ§Ã£o ativos\",\n      },\n      {\n        name: \"transferMode\",\n        afterRepliedInstruction:\n          \"Se o lead indicar que Ã© manual/banco: Fale sobre o cenÃ¡rio do lead, e diga que no cenÃ¡rio que o lead informou, fazer repasse manual em 2026 Ã© inaceitÃ¡vel e informe que a Apesenta.me dispÃµe de funcionalidades que automatizam esse processo. Se ele indicar que o repasse jÃ¡ Ã© feito de forma automÃ¡tica, de enfase ao nosso produto/funcionalidade: valide a fala do Lead e diga que aqui na Apresenta.me entregamos a funcionalidade de repasse automÃ¡tico tambÃ©m e que tem ajudado bastante nossos clientes.\",\n        description:\n          \"MÃ©todo de repasse (Ex: Manual, Banco, Split etc.). NUNCA MOSTRE EXEMPLOS PARA O USUARIO E DEIXE ELE RESPONDER LIVREMENTE.\",\n      },\n    ],\n    next_stage: \"ASK_PLAN\",\n  },\n  ASK_PLAN: {\n    type: \"message\",\n    instruction: `\nAgora que vocÃª jÃ¡ entende o cenÃ¡rio do lead, pense lÃ³gicamente, com base nas informaÃ§Ãµes que ele passou, qual dos planos abaixo se enquadra melhor no cenÃ¡rio dele:    \n- **Start IMOB (R$ 449,99/mÃªs):** 2 usuÃ¡rios, 300 imÃ³veis, 500 negÃ³cios. Inclui Site e WhatsApp -> REMOVA ESSA OPÃ‡ÃƒO SE O USUÃRIO JÃ TRABALHA COM LOCAÃ‡ÃƒO (rentalStatus = active/starting).\n- **Basic IMOB (R$ 699,99/mÃªs):** 5 usuÃ¡rios, 1000 imÃ³veis, 2000 negÃ³cios. Inclui 50 contratos e gestÃ£o financeira.\n- **Big IMOB (R$ 999,99/mÃªs):** 12 usuÃ¡rios, imÃ³veis ilimitados, 5000 negÃ³cios. Inclui 150 contratos e geraÃ§Ã£o automÃ¡tica de boletos.\n- **Super IMOB (Especialista):** Acima de 25 usuÃ¡rios ou 300 contratos. GestÃ£o completa de comissÃµes.\nApÃ³s vocÃª selecionar um desses planos, como resposta: cite o cenÃ¡rio do Lead, informe o porquÃª o plano selecionado faz sentido para o lead e informe o plano selecionado.\nOBS: NÃƒO ENVIE TODOS OS PLANOS PARA O LEAD, SELECIONE APENAS UM PLANO QUE SE ENCAIXA MELHOR NO CENÃRIO/CONTEXTO ATUAL DA IMOBILIÃRIA ATUALMENTE.\n`,\n    next_stage: \"WAIT_PLAN\",\n  },\n  WAIT_PLAN: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"selectedPlanWasAccepted\",\n        afterRepliedInstruction:\n          \"Se o lead informar que precisa AUMENTAR o nÃºmero de usuÃ¡rios, contratos, imÃ³veis, negÃ³cios, etc: informe que o plano pode ser personalizado de acordo com o que ele precisa, e que o Plano Selecionado Ã© apenas um plano base. PorÃ©m, apenas um especialista pode personalizar o plano do lead; Se o lead informar que precisa DIMINUIR o nÃºmero de usuÃ¡rios, contratos, imÃ³veis, negÃ³cios, etc: informe que um especialista vai tentar entender melhor as necessidades do Lead e selecionar um plano mais adequado.\",\n        description:\n          \"Se o plano selecionado jÃ¡ foi apresentado um plano com base no cenÃ¡rio do lead e ele disse que o plano faz sentido pra ele, que estÃ¡ dentro do que planejam investir. Se o plano selecionado ainda nÃ£o foi apresentado para o lead: NÃƒO PREENCHA esta variÃ¡vel. Se for atribuido qualquer valor para whyDidntAcceptedThePlan, atribua FALSE para esta variÃ¡vel\",\n      },\n    ],\n    next_stage: \"ROUTER_PLAN_ACCEPTED\",\n  },\n  ROUTER_PLAN_ACCEPTED: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"selectedPlanWasAccepted\",\n        value: false,\n        next_stage: \"ASK_WHY_DIDNT_ACCEPTED_THE_PLAN\",\n      },\n      { default: \"CLOSING\" },\n    ],\n  },\n  ASK_WHY_DIDNT_ACCEPTED_THE_PLAN: {\n    type: \"message\",\n    instruction:\n      'Se o lead nÃ£o informou o motivo pelo qual o plano nÃ£o faz sentido para ele, pergunte de forma objetiva o motivo. Ex: \"Entendi, [NOME DO LEAD], vocÃª poderia me contar por qual motivo o [PLANO SELECIONADO] nÃ£o faz sentido pra vocÃª?\"',\n    next_stage: \"WAIT_WHY_DIDNT_ACCEPTED_THE_PLAN\",\n  },\n  WAIT_WHY_DIDNT_ACCEPTED_THE_PLAN: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"whyDidntAcceptedThePlan\",\n        afterRepliedInstruction:\n          \"Se ele informou que precisa de uma funcionalidade que nÃ£o temos, procure na base de conhecimento pela funcionalidade e se esta existir, informe ao cliente que possuÃ­mos, se nenhuma funcionalidade que o lead precisa existe na base de conhecimento, entÃ£o informe que iremos encaminhar o caso do lead para um especialista. Se o cliente reclamou do valor, informe que iremos encaminhar para um especialista cuidar desse caso especÃ­fico. Se ele informar que precisa de mais usuÃ¡rios, mais contratos, mais imÃ³veis ou qualquer outro item existente no plano, informe que trabalhamos que podemos personalizar os planos, mas que um especialista precisa fazer essa personalizaÃ§Ã£o para o Lead.\",\n        description:\n          \"Motivo pelo qual o plano nÃ£o foi aceito pelo usuÃ¡rio. Se o usuÃ¡rio disse o motivo pelo qual nÃ£o aceita o plano, altere selectedPlanWasAccepted\",\n      },\n    ],\n    next_stage: \"CLOSING\",\n  },\n  CLOSING: {\n    type: \"message\",\n    instruction:\n      'AgradeÃ§a de forma cordial, se despeÃ§a e diga que foi um prazer conhecer o lead, citando o nome dele. Diga que coletou todos os dados necessÃ¡rios e informe que um especialista entrarÃ¡ em contato para agendar uma apresentaÃ§Ã£o. Ex: \"[NOME DO LEAD], coletei todos os dados necessÃ¡rios aqui e vou prosseguir com o agendamento de uma demonstraÃ§Ã£o te encaminhando pra um especialista. Foi um prazer te conhecer, atÃ© mais!\"',\n    next_stage: \"STOP\",\n  },\n  CLOSING_WHEN_INVALID_OPTION: {\n    type: \"message\",\n    instruction:\n      \"AgradeÃ§a de forma cordial e simpÃ¡tica, diga que irÃ¡ encaminhar o atendimento para um especialista que poderÃ¡ cuidar do caso especÃ­fico do lead e se despeÃ§a dizendo que foi um prazer conhecÃª-lo.\",\n    next_stage: \"STOP\",\n  },\n};\n\nconst redisData = $(\"GET Estado Atual\").item.json.propertyName\n  ? JSON.parse($(\"GET Estado Atual\").item.json.propertyName)\n  : {};\nconst currentStageId = redisData.stage_id || \"START\";\nconst vars = redisData.vars || {};\nconst stageConfig = workflow[currentStageId] || workflow[\"START\"];\n\n// --- VARREDURA GLOBAL DE VARIÃVEIS ---\nlet missingVars = [];\nfor (const key in workflow) {\n  const step = workflow[key];\n  if (step.type === \"input\" && step.variables) {\n    step.variables.forEach((v) => {\n      if (!vars[v.name] || vars[v.name].value === null || vars[v.name].value === 'invalid_option' || vars[v.name].value === 'not_provided' || vars[v.name].value === 'answer_later') {\n        missingVars.push({\n          name: v.name,\n          description: v.description,\n          options: v.options || null,\n        });\n      }\n    });\n  }\n}\n\nreturn {\n  workflow,\n  currentStageId,\n  stageConfig,\n  vars,\n  missingVars,\n  userMsg: $(\"CONCATENA1\").item.json.user_full_message,\n  missingVar: JSON.parse($input.first().json.propertyName)?.missingVar,\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1776,3248],"id":"ea335fc1-895b-4f3b-b7cb-f3aca26fa576","name":"BLUEPRINT ENGINE"},{"parameters":{"promptType":"define","text":"=### [CONTEXTO]\n- [HISTÃ“RICO DE CONVERSA - ÃšLTIMAS 8 MENSAGENS TROCADAS EM ORDEM CRESCENTE]\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"\" }}\n\n### [DADOS DO PROCESSO]\n- **ESTÃGIO:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.currentStageId) }}\n- **VARIÃVEIS FALTANTES:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.missingVars) }}\n- **DADOS JÃ REGISTRADOS:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.vars) }}\n- **ULTIMA PERGUNTA DO ROBÃ” (IA):** \"{{ $('Pega ultimas mensagens').first().json.message.content }}\"\n- **MENSAGEM DO USUÃRIO:** \"{{ $('BLUEPRINT ENGINE').first().json.userMsg }}\"\n- **ÃšLTIMA VARIÃVEL SOLICITADA:** {{ JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name }}","hasOutputParser":true,"options":{"systemMessage":"=VocÃª Ã© um extrator de dados baseado em contexto de conversa e intenÃ§Ã£o de usuÃ¡rio.\n\n\n### [ORDEM DE EXECUÃ‡ÃƒO - AUDITOR DE DADOS]\n\n1. **ANÃLISE DE CONTEXTO:** Compare a [MENSAGEM DO USUÃRIO] com os [DADOS JÃ REGISTRADOS] e a [ULTIMA PERGUNTA DO ROBÃ”].\n2. **VARREDURA EXAUSTIVA:** NÃ£o pare na primeira informaÃ§Ã£o. Analise cada frase da mensagem. O usuÃ¡rio pode responder uma variÃ¡vel, corrigir uma antiga e tirar uma dÃºvida tÃ©cnica na mesma mensagem.\n3. **FILTRO DE INTENÃ‡ÃƒO (CONTEXTO DE REAÃ‡ÃƒO):**\nÂ  Â - Identifique se o usuÃ¡rio estÃ¡ respondendo ao **comentÃ¡rio/reaÃ§Ã£o** do robÃ´ (ex: \"NÃ£o Ã© difÃ­cil\", \"Verdade\") ou Ã  **pergunta de extraÃ§Ã£o**.\nÂ  Â - Se a mensagem do usuÃ¡rio for uma resposta clara apenas ao comentÃ¡rio de empatia da IA (ex: negando que estÃ¡ corrido), vocÃª estÃ¡ PROIBIDO de extrair esse \"NÃ£o\" ou \"Sim\" como valor para a variÃ¡vel de dados.\n4. **EXTRAÃ‡ÃƒO E MAPEAMENTO LÃ“GICO:**\nÂ  Â - **Passo A:** Identifique o \"Assunto Central\" da fala do usuÃ¡rio.\nÂ  Â - **Passo B:** Procure nas VARIÃVEIS FALTANTES qual description possui o maior nexo semÃ¢ntico com esse assunto.\nÂ  Â - **Passo C:** Se a fala for apenas uma reaÃ§Ã£o emocional (\"Show!\", \"Massa!\"), verifique se o robÃ´ fez uma pergunta de \"Sim ou NÃ£o\". Se nÃ£o fez, a extraÃ§Ã£o Ã© {}.\n\n### [REGRAS CRÃTICAS DE EXTRAÃ‡ÃƒO]\n\n1. **ESTIMATIVA > INCERTEZA (REGRA DO NÃšMERO):**\nÂ  Â - Se o usuÃ¡rio der um valor mas demonstrar incerteza, **EXTRAIA O NÃšMERO**. Valores estimados sÃ£o prioritÃ¡rios.\n\n2. **MAPEAMENTO SEMÃ‚NTICO DE OPTIONS:**\n   - REGRA DA OPÃ‡ÃƒO INVÃLIDA: Se a resposta do usuÃ¡rio se encaixar na descriÃ§Ã£o da chave invalid_option (ex: pediu produto avulso nÃ£o permitido), vocÃª DEVE OBRIGATORIAMENTE extrair a chave \"invalid_option\".\n  - PERMISSÃƒO: NÃ£o tenha medo de classificar pedidos parciais (ex: \"SÃ³ site\") como invalid_option.\n  - Para as demais chaves: PROIBIDO selecionar se nÃ£o houver correspondÃªncia semÃ¢ntica com a description.\n\n3. **CORREÃ‡ÃƒO E SOBREPOSIÃ‡ÃƒO (PRIORIDADE MÃXIMA):**\nÂ  Â - Se a mensagem contradizer algo salvo, extraia o novo valor para **SOBRESCREVER** o antigo.\n\n4. **VALIDAÃ‡ÃƒO DE POSSE (ANTI-ALUCINAÃ‡ÃƒO):**\nÂ  Â - Extraia ferramentas apenas se houver indÃ­cio claro de **USO ATUAL**.\n\n5. **NEGATIVAS, ADIAMENTO E RECUSA:**\n   - **RESPOSTA NEGATIVA:** Se a resposta for uma negaÃ§Ã£o clara Ã  pergunta binÃ¡ria (Sim/NÃ£o), extraia o valor booleano correspondente (FALSE) conforme a descriÃ§Ã£o.\n   - **ADIAMENTO ESPECÃFICO (answer_later):** Use APENAS se o usuÃ¡rio declarar explicitamente que nÃ£o possui aquela informaÃ§Ã£o especÃ­fica no momento presente (falta do dado), mas que pretende fornecer depois.\n   - **RECUSA (not_provided):** Use estritamente quando houver negativa motivada por privacidade, seguranÃ§a ou nÃ£o consentimento.\n\n6. **RETROATIVIDADE:**\nÂ  Â - Se responder algo que estava como `answer_later`, atualize com o novo dado.\n\n7. **VÃNCULO SEMÃ‚NTICO E PRECEDÃŠNCIA (ALVO DA RESPOSTA):**\n   - **AnÃ¡lise de Componente:** Identifique que a mensagem da IA possui dois alvos: o *Alvo Assertivo* (comentÃ¡rio de empatia/opiniÃ£o) e o *Alvo de ExtraÃ§Ã£o* (a pergunta de dado).\n   - **Nexo de Resposta:** Verifique se a resposta do usuÃ¡rio (especialmente \"Sim\", \"NÃ£o\", \"Mais ou menos\") estÃ¡ invalidando ou confirmando o *Alvo Assertivo* (adjetivos e estados descritos pela IA) ou o *Alvo de ExtraÃ§Ã£o*.\n   - **Prioridade de Descarte:** Se a justificativa que acompanha a resposta (o texto apÃ³s o Sim/NÃ£o) for semanticamente ligada ao *Alvo Assertivo*, vocÃª estÃ¡ PROIBIDO de extrair esse valor para a variÃ¡vel. O nexo deve ser com a `description` da variÃ¡vel, nÃ£o com o comentÃ¡rio social da IA.\n\n8. **VALIDAÃ‡ÃƒO DE CONSISTÃŠNCIA SEMÃ‚NTICA:**\n   - **Mapeamento de DomÃ­nio:** Antes de extrair, classifique o domÃ­nio da resposta do usuÃ¡rio.\n   - **LÃ³gica:** Se o usuÃ¡rio nega algo (\"NÃ£o...\") e a continuaÃ§Ã£o da frase trata de um assunto diferente ou fora de contexto em relaÃ§Ã£o a Ãºltima pergunta feita pelo robÃ´, ignore a extraÃ§Ã£o. \n   - **Regra de Ouro:** SÃ³ extraia o valor se o lÃ©xico utilizado pelo usuÃ¡rio (palavras-chave e contexto) pertencer ao mesmo domÃ­nio semÃ¢ntico da `description` da variÃ¡vel. NegaÃ§Ãµes de adjetivos nunca devem ser mapeadas como valores de estado de processo.\n\n9. **CONFLITO DE DADO + INDISPONIBILIDADE (PRIORIDADE DE EXTRAÃ‡ÃƒO):**\n   - **CENÃRIO:** O usuÃ¡rio fornece a resposta vÃ¡lida/valor para a variÃ¡vel solicitada, mas na mesma mensagem informa que precisarÃ¡ interromper a conversa (estar ocupado, saindo, entrando em reuniÃ£o).\n   - **AÃ‡ÃƒO OBRIGATÃ“RIA:** IGNORE o aviso de interrupÃ§Ã£o para fins de extraÃ§Ã£o e **EXTRAIA O DADO VÃLIDO**.\n   - **LÃ“GICA:** A existÃªncia do dado vÃ¡lido na mensagem tem precedÃªncia absoluta sobre o status de disponibilidade do usuÃ¡rio. O gerenciamento da pausa na conversa Ã© responsabilidade de outro agente; sua funÃ§Ã£o Ã© garantir que o dado fornecido seja salvo.\n---\n\n### [SAÃDA OBRIGATÃ“RIA]\n- Retorne **APENAS** o JSON puro. Proibido adicionar explicaÃ§Ãµes.\n- Se nenhum dado for extraÃ­do ou corrigido, retorne `{}`.\n- Formato: `{ \"nome_da_variavel\": valor_extraido }`"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-720,3232],"id":"739f0de6-728c-4ae4-9b50-0ec36296d4d5","name":"Extrator Inteligente"},{"parameters":{"options":{"temperature":0.5}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[-704,3456],"id":"a3bcb857-749d-4f3b-b187-c7fa841f4151","name":"DeepSeek Model","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}},{"parameters":{"jsCode":"const inputData = $input.all()[0].json;\nconst workflow = $('BLUEPRINT ENGINE').first().json.workflow;\nlet currentStageId = $('BLUEPRINT ENGINE').first().json.currentStageId;\nlet vars = $('BLUEPRINT ENGINE').first().json.vars;\nlet stageConfig = $('BLUEPRINT ENGINE').first().json.stageConfig;\nconst lastInstruction = JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').lastInstruction\nconst lastMissingVar = JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar \nlet outputInstruction = \"\";\nlet missingVar = \"\";\nlet immediatelyNextStage = \"\";\n\n// --- 1. ATUALIZAÃ‡ÃƒO GLOBAL (Check-in) ---\nconst extractedObj = inputData.output || {};\nfor (const [key, value] of Object.entries(extractedObj)) {\n    // SÃ³ atualiza se tiver valor real\n    if (value !== null && value !== undefined && value !== \"\") {\n        vars[key] = { value: value, type: 'extracted' };\n    }\n}\n\n// Helper: Verifica se TODAS as variÃ¡veis do estÃ¡gio estÃ£o preenchidas\nfunction isInputSatisfied(stage) {\n    if (!stage || stage.type !== 'input') return false;\n    // Retorna true apenas se TODAS as variÃ¡veis listadas existirem em 'vars'\n    return stage.variables.every(v => vars[v.name] && vars[v.name].value !== null && vars[v.name].value !== \"\");\n}\n\n\n// --- 2. LOOP DE AVANÃ‡O (Auto-Skip & Look Ahead) ---\nlet safetyLoop = 0;\nlet advancing = true;\n\nwhile (advancing && safetyLoop < 50) {\n    stageConfig = workflow[currentStageId];\n    if (!stageConfig) break;\n\n    if (stageConfig.immediately_next_stage) {\n      immediatelyNextStage = stageConfig.immediately_next_stage\n    }\n\n    advancing = false; // Por padrÃ£o, o loop para aqui, a menos que encontre motivo para seguir\n\n    // ======================================================\n    // CASO 1: INPUT (Esperando dados do usuÃ¡rio)\n    // ======================================================\n    if (stageConfig.type === 'input') {\n        if (isInputSatisfied(stageConfig)) {\n            // Temos tudo! Pula para o prÃ³ximo estÃ¡gio.\n            currentStageId = stageConfig.next_stage;\n            advancing = true; \n        } else {\n            // [CORREÃ‡ÃƒO AQUI] Falta resposta. NÃ£o podemos deixar a instruÃ§Ã£o vazia.\n            // Descobre qual variÃ¡vel estÃ¡ faltando para orientar a IA\n            missingVar = stageConfig.variables.find(v => !vars[v.name] || !vars[v.name].value);\n            \n            if (missingVar) {\n                // Se o usuÃ¡rio falou algo nada a ver (extraÃ§Ã£o rodou mas nÃ£o pegou o dado)\n                if (Object.keys(extractedObj).length > 0 && !Object.values(extractedObj).find(v => v)) {\n                     outputInstruction = `O usuÃ¡rio respondeu algo, mas nÃ£o entendi o(a) ${missingVar.description}. Pergunte novamente de forma clara.`;\n                } else {\n                    if (lastMissingVar && !vars[lastMissingVar.name]?.value) {\n                      outputInstruction = lastInstruction\n                    } else {\n                      outputInstruction = `Pergunte: ${missingVar.description}`; \n                    }\n                }\n            }\n            // Mantemos advancing = false para PARAR aqui e esperar o user responder\n        }\n    }\n\n    // ======================================================\n    // CASO 2: MENSAGEM (O robÃ´ fala)\n    // ======================================================\n    else if (stageConfig.type === 'message') {\n        // [LOOK AHEAD]\n        // Verifica se a mensagem serve para pedir um dado que JÃ TEMOS.\n        const nextStage = workflow[stageConfig.next_stage];\n        \n        // Se o prÃ³ximo passo Ã© input E jÃ¡ estÃ¡ preenchido -> Pula a mensagem atual\n        if (nextStage && nextStage.type === 'input' && isInputSatisfied(nextStage)) {\n            currentStageId = nextStage.next_stage;\n            advancing = true; \n        } else {\n            // Mensagem necessÃ¡ria. Define instruÃ§Ã£o.\n            outputInstruction = stageConfig.instruction;\n            \n            // JÃ¡ aponta o ponteiro para o prÃ³ximo estÃ¡gio (onde vamos esperar o input)\n            if (stageConfig.next_stage !== 'STOP') {\n                currentStageId = stageConfig.next_stage;\n                const nextStage = workflow[currentStageId]   \n\n                if (nextStage.type == 'input') {\n                  missingVar = nextStage.variables.find(v => !vars[v.name] || !vars[v.name].value);\n                }\n              \n            }\n            // Para o loop para a IA falar.\n            advancing = false; \n        }\n    }\n\n    // ======================================================\n    // CASO 3: ROUTER (LÃ³gica condicional)\n    // ======================================================\n    else if (stageConfig.type === 'router') {\n        let routeFound = false;\n        for (const rule of stageConfig.rules) {\n            if (rule.default) {\n                currentStageId = rule.default;\n                routeFound = true;\n                break;\n            }\n            // ValidaÃ§Ã£o simples de valor\n            if (vars[rule.variable] && vars[rule.variable].value === rule.value) {\n                currentStageId = rule.next_stage;\n                routeFound = true;\n                break;\n            }\n        }\n        // Se achou rota, continua avanÃ§ando no mesmo tick\n        if (routeFound) advancing = true; \n    }\n    \n    safetyLoop++;\n}\n\nreturn {\n    newStageId: currentStageId,\n    updatedVars: vars,\n    finalInstruction: outputInstruction,\n    missingVar, \n    immediatelyNextStage\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-368,3232],"id":"49d85cc1-5324-427b-b56e-d7d5d61cbef2","name":"LOGIC ENGINE"},{"parameters":{"jsCode":"const messages = $input.item.json.messages || [];\nconst fullText = messages.map(m => m.message).join('\\n');\n\nreturn {\n  user_full_message: fullText,\n  cache_key: $('Configura Contexto').item.json.cache_key\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2240,3248],"id":"cf14ddf9-674e-44b9-8f23-d09c3b549e59","name":"CONCATENA1"},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"description\": \"Objeto JSON contendo as chaves das variÃ¡veis encontradas e seus respectivos valores.\",\n  \"additionalProperties\": {\n    \"oneOf\": [\n      {\n        \"type\": \"string\"\n      },\n      {\n        \"type\": \"number\"\n      },\n      {\n        \"type\": \"boolean\"\n      },\n      {\n        \"type\": \"null\"\n      },\n      {\n        \"type\": \"array\",\n        \"items\": {\n          \"type\": \"string\"\n        }\n      }\n    ]\n  }\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-576,3456],"id":"f42bfe98-ea4e-4b64-b4b1-f60e99297356","name":"Structured Output Parser1"},{"parameters":{"amount":6},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-2464,3616],"id":"7c1edbf7-ad5e-4dcf-aa0e-789071fc18e4","name":"Wait1","webhookId":"d1e38aad-57ac-45e5-b64a-08e2f1ce1a6f"},{"parameters":{"operation":"delete","key":"=temp.{{ $('Configura Contexto').item.json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2464,3248],"id":"69e79069-efac-44b0-8752-141944a73578","name":"DELETE1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2aafb32-380d-4510-810a-888831d36437","leftValue":"={{ DateTime.fromMillis($json.messages?.last().timestamp) }}","rightValue":"={{ $now.minus(6, 'seconds' )}}","operator":{"type":"dateTime","operation":"before"}}],"combinator":"and"},"renameOutput":true,"outputKey":"segue"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3d2a33da-ed74-4906-92aa-74ad3a37c4f1","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"nada"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"espera"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-2688,3328],"id":"cbc8d2d2-e285-4ae7-a886-fbb287f7321e","name":"SWITCH_BUFFER"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-2464,3424],"id":"f59c0a36-e6c1-4183-93dd-37cdb508a130","name":"NADA1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1f5bcbd1-6685-469d-bbf2-7939008b234d","leftValue":"={{ $json.user_msg }}","rightValue":"clear:cache:111222","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4144,3328],"id":"bf1ca13a-53ea-4963-a585-f189a6563522","name":"If2"},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3680,3024],"id":"79a002fa-786e-458a-ac14-5ab9f9e0fbc0","name":"Delete table or rows1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"delete","key":"={{ $('Configura Contexto').item.json.cache_key }}_state"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3856,3024],"id":"a8343dfa-0bf6-4e9a-af8b-f6b1434c747e","name":"Deleta estado atual","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=temp.{{ $('Configura Contexto').item.json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3488,3024],"id":"255c8c55-36e5-4b1d-8a37-680c09c93110","name":"DELETE2","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"const messages = typeof $input.first().json.messages == 'string' ? JSON.parse($input.first().json.messages) : $input.first().json.messages\n\nreturn {\n  messages: messages?.map(message => typeof message === 'string' ? JSON.parse(message) : message) ?? null\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3008,3344],"id":"d10f3004-81bf-4a98-8b5c-0fddeae017c0","name":"Transforma em objeto literal"},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3904,3344],"id":"86b0b7d7-5b3c-40b5-9b36-5d105fb09f76","name":"Busca mensagens no cache","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"const inputMessages = typeof $input.first().json.messages == 'string' ?  JSON.parse($input.first().json.messages) : $input.first().json.messages\nconst cacheMessagesToArrayJSON = inputMessages?.map(message => typeof message == 'string' ? JSON.parse(message) : message) || []\n\nconst userMsg = {\n  message: $('Configura Contexto').first().json.user_msg, \n  timestamp: $now.toMillis() \n}\n\nreturn {\n  messages: [\n    ...cacheMessagesToArrayJSON, \n    userMsg\n  ]\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3680,3344],"id":"a3f5df3e-7e44-4e89-a83b-b12e2a600f89","name":"Junta mensagem do cache com a mensagem do usuÃ¡rio"},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3456,3344],"id":"b152ad4c-b260-4607-a58f-db9cc01ff585","name":"SETA CACHE DAS MENSAGENS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3232,3344],"id":"bbd78cab-c1e3-4d77-8975-3355a5797611","name":"BUSCA MENSAGENS ACUMULADAS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"check-question","leftValue":"={{ $json.output.hasQuestion }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[544,3232],"id":"a4b5d3a6-6c42-4ce0-b065-2e706646d9d3","name":"Tem DÃºvida?"},{"parameters":{"mode":"load","tableName":"n8","prompt":"={{ $json.output.searchQuery }}","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[896,2976],"id":"513d1da3-48a6-4591-b2bd-4b45188d3b7e","name":"Consulta Base Conhecimento","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[896,3152],"id":"ca10a115-b9dc-4272-9f40-aecce6cb838d","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"jsCode":"return {\n  rag_context: $input.all().map(d => d.json.document.pageContent)\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1248,2976],"id":"612f63e5-d3b4-4e60-89cd-0c55d2ecd635","name":"RAG CONTEXT","executeOnce":true},{"parameters":{"jsCode":"return {\n  rag_context: $json.rag_context\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1520,3248],"id":"84b694d4-8676-4034-a103-ccf5f04499da","name":"MERGE DADOS"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":8,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').item.json.cache_key }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1552,3248],"id":"7466f742-b65f-413a-997f-b79463f0e820","name":"Pega ultimas mensagens","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length || !messages[0].json.message) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,3248],"id":"a882932e-22d3-4b22-b1c1-c6827396490b","name":"Formata ultimas mensagens","executeOnce":true},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":1}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-4704,5568],"id":"d2cb6fa2-a445-437f-b103-6fb3dc8e60c7","name":"Cron 1em1 min - FOLLOW-UP"},{"parameters":{"operation":"executeQuery","query":"SELECT \n  * FROM follow_up_queue\nWHERE follow_up_time <= NOW()\nAND active IS TRUE\nAND (\n  (\n    attempts < 2 \n    AND follow_up_type = 'initiated'\n  )\n  OR (\n    follow_up_type = 'requested'\n    AND attempts < 1\n  )  \n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4480,5568],"id":"8f0fffad-cae2-4930-861a-6353cea9084f","name":"Busca follow-ups disponÃ­veis","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-4064,5568],"id":"8f466cf5-ea14-445d-9e92-7299fbbfc567","name":"LOOP nos follow-up's"},{"parameters":{"operation":"get","key":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3376,5696],"id":"952c8220-c42d-4df1-99a6-4be940dfa3f4","name":"Busca estado atual da conversa","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"mode":"raw","jsonOutput":"={{ $json.propertyName }}","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3136,5696],"id":"61b2bb84-fd12-42f6-bd23-5c0cfe10ef97","name":"Transforma estado atual em JSON literal"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"277c3ae6-bdd3-4743-aa6d-9181d4e3f217","leftValue":"={{ $json.vars[$('LOOP nos follow-up\\'s').first().json.last_var_requested]?.value?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2592,5840],"id":"3ac53cb0-33ea-4a0f-9ff0-cec62aaac9bd","name":"Se o usuÃ¡rio respondeu a variÃ¡vel pendente no meio do caminho"},{"parameters":{"content":"# FAZ FOLLOW-UP\n\n","height":960,"width":4688},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4800,5280],"id":"fd151bd6-83c9-422f-a9a8-309b8bfa7d51","name":"Sticky Note"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini-2024-07-18","mode":"list","cachedResultName":"GPT-4O-MINI-2024-07-18"},"responses":{"values":[{"role":"system","content":"=**SISTEMA:** VocÃª Ã© um humano retomando um papo que esfriou. Use tom \"business casual\". Sem formalidade. Sem exclamaÃ§Ãµes.\n\n**REGRAS DE DIAMANTE**\n - NÃ£o valide a Ãºltima mensagem do usuÃ¡rio, vÃ¡ direto ao ponto.\n - Varie a forma como vocÃª chama o usuÃ¡rio para retomar a conversa.\n\n**ALGORITMO DE COMPOSIÃ‡ÃƒO:**\n1. **IDENTIDADE:**\n   - Se [NOME] existir: Comece com \"[NOME], ...\"\n   - Se [NOME] for vazio/null: Comece com \"Oi, tudo bem?\" ou \"Oi, tudo certo por aÃ­?\".\n2. **PONTE DE CONEXÃƒO:** Use expressÃµes de continuidade como \"acabei nÃ£o pegando\", \"ficou faltando vocÃª me falar\" ou \"queria confirmar um detalhe\".\n3. **TRADUTOR DE COMANDO:** Pegue o texto apÃ³s \"Pergunte sobre:\" e transforme em algo empÃ¡tico e informal. \n   - *Exemplo:* \"Pergunte sobre: Nome\" -> \"Oi, tudo bem? VocÃª ficou de me falar seu nome, como posso te chamar?\"\n\n**REGRAS RÃGIDAS:**\n- **PROIBIDO:** \"Lead\", \"Pendente\", \"InformaÃ§Ã£o\", \"Sistema\", \"Pergunte sobre\".\n- **LIMITE:** MÃ¡ximo 20 palavras.\n- **PONTUAÃ‡ÃƒO:** Ã‰ terminantemente proibido o uso de exclamaÃ§Ãµes (!). \n- **FINALIZAÃ‡ÃƒO:** Termine obrigatoriamente com a interrogaÃ§Ã£o da pergunta.\n\n**SAÃDA FINAL (TEXTO PURO):**"},{"content":"=**DADOS:**\n- **NOME_USUARIO:** {{ $json.vars.name || \"\" }}\n- **COMANDO:** {{ $('LOOP nos follow-up\\'s').first().json.last_instruction }}\n- **HISTÃ“RICO DE CONVERSA:** \n{{ $('Formata ultimas mensagens1').first().json.historyMessages }}\n---"}]},"builtInTools":{},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2,"position":[-1488,5840],"id":"265cb3af-29ac-459a-a81f-f882ab728704","name":"Gera mensagem de follow-up","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('LOOP nos follow-up\\'s').first().json.company_id }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output[0].content[0].text }}"},{"name":"number","value":"={{ $('LOOP nos follow-up\\'s').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('LOOP nos follow-up\\'s').first().json.whatsapp_id }}"},{"name":"addUserName","value":"={{ $('LOOP nos follow-up\\'s').first().json.agent_name }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1104,5840],"id":"dba8fe7b-5e5c-4fb7-9936-c2b87a2e2e28","name":"Envia via Apre.Chat"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":5,"where":{"values":[{"column":"session_id","value":"={{ $('LOOP nos follow-up\\'s').item.json.session_id }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2352,5856],"id":"768756d6-6e72-47ec-ba59-5b14c00a0f7e","name":"Pega ultimas mensagens1","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2112,5856],"id":"1a178063-f427-47e9-85ad-b70e524f6e5d","name":"Formata ultimas mensagens1","executeOnce":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\":  $('Gera mensagem de follow-up').item.json.output[0].content[0].text, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-608,5840],"id":"a59ba9f9-47b3-4997-923b-f14a0743570d","name":"Insere mensagem da IA no BD1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3280,3024],"id":"c04ca390-7134-4bea-a8b9-2f0f5888ad75","name":"Remove follow-ups","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $json.session_id }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3776,5584],"id":"fe2a74fa-4460-4254-b55c-1c4f6c5a85fa","name":"BUSCA MENSAGENS ACUMULADAS1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"431557d8-7fd4-46ed-951f-464868b21a82","leftValue":"={{ $json.messages?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3568,5584],"id":"25dafc46-93fe-46c5-90d5-a508806aa3f1","name":"Se chegou alguma mensagem do usuÃ¡rio"},{"parameters":{"amount":2},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-4272,5568],"id":"65c23647-fb2a-4584-9a45-053cc71e46ab","name":"Wait","webhookId":"d1e38aad-57ac-45e5-b64a-08e2f1ce1a6f"},{"parameters":{"jsCode":"return {\n  tone: \"SimpÃ¡tica e leve\",\n  agentName: \"Alicia\",\n  internalName: \"Alicia da Apresenta.me\",\n  initialMessage: \"OlÃ¡, tudo bem? ðŸ‘‹ \\n\\nEu sou a Alicia, assistente da Apresenta.me, vou te ajudar entendendo melhor sua necessidade.\",\n  language: \"pt-BR\",\n  timeZone: \"Sao Paulo (GTM -3)\",\n  role: \"SDR SÃªnior\",\n  companyName: \"Apresenta.me\",\n  companyDepartment: \"Software\",\n  companySite: \"https://apresenta.me\",\n  conduct: \"SYSTEM ROLE: Alicia (SDR consultiva - Apresenta.me).\\n\\nObjetivo: qualificar o lead seguindo estritamente a coleta de dados e o fluxo de estÃ¡gio. Nao marcar reuniao agora, nao falar de preco/ofertas.\\n\\nTom: business casual (WhatsApp). Curta, humana e direta. Evitar formalidade robotica e girias. Usar ponto final e interrogacao. Evitar ao maximo exclamacao. Emojis no maximo 1 por mensagem e so se suavizar.\\n\\nRegra: uma pergunta por vez. Mensagens curtas.\\n\\nNome: sempre chamar o lead pelo primeiro nome em toda mensagem (no inicio ou fim). Nunca usar nome completo.\\n\\nConcorrencia: nunca citar concorrentes nem comparar. Se insistirem, puxar pro cenario do lead com uma pergunta.\\n\\nAnti-desvio: se o lead mudar de assunto ou informar uma dor, responda de forma breve/humana e use o Pivot para retomar a qualificacao imediatamente. O foco Ã© o dado, nao o suporte.\\n\\nTrivial: se perguntarem algo trivial, responder curto e humano e depois retomar com uma pergunta.\\n\\nSem suporte tecnico: vocÃª nao Ã© suporte. Se perguntarem algo tecnico e nao tiver instruÃ§Ã£o de busca, use a Carta de SeguranÃ§a apenas se necessÃ¡rio.\\n\\nSe o lead pedir demonstracao (\\\"quero conhecer\\\", \\\"quero ver\\\"): dizer que antes precisa terminar de entender o cenario atual dele.\\n\\nDados da empresa (usar se relevante): Apresenta.me, software de gestao imobiliaria. Endereco: R. dos Cacadores, 345 - Sala 01 - Centro, Rio do Sul - SC.\\n\\n ## UTILIZAÃ‡ÃƒO DA BASE DE CONHECIMENTO (ACIONAMENTO RESTRITO): \\n - O uso da base de conhecimento Ã© REATIVO e SUBORDINADO. \\n - VocÃª estÃ¡ PROIBIDA de identificar dores e consultar a base por conta prÃ³pria. \\n - Chame a TOOL de conhecimento *APENAS* se a INSTRUCAO_A ou INSTRUCAO_B pedir explicitamente para \\\"buscar na base\\\", \\\"consultar\\\" ou \\\"verificar\\\". \\n - Se houver uma dor mas a instruÃ§Ã£o mandar apenas coletar um dado, valide a dor de forma rÃ¡pida (ex: \\\"Puxa, imagino a correria\\\") e siga para a pergunta de dado.\\n\\n **REGRAS DE DIAMANTE:** \\n 1. Foque 100% em cumprir a INSTRUCAO_A e INSTRUCAO_B. Elas sobrepÃµem qualquer proatividade consultiva.\\n 2. **NUNCA** adivinhe o nome do Lead, e nÃ£o se apresente se os dados jÃ¡ possuÃ­rem o nome dele.\\n\",\n  verbosity: \"medium\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1136,3248],"id":"e3f2d5c5-1eac-4928-abad-f248544a502f","name":"Seta perfil1"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"human\", \"content\": $('CONCATENA1').first().json.user_full_message , \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{"outputColumns":["id"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-960,3248],"id":"064fd852-3cc6-4497-bb84-6a338dbe4651","name":"Insere mensagem do usuÃ¡rio no BD","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"thinking\": {\n        \"type\": \"string\", \n        \"description\": \"RaciocÃ­nio para gerar o output final.\"\n    },\n    \"isFollowUp\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se o usuÃ¡rio demonstrou indisponibilidade imediata e solicitou um novo contato (ex: 'agora nÃ£o posso', 'me chama depois').\"\n    },\n    \"requiresClarification\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se o usuÃ¡rio NÃƒO especificou um horÃ¡rio ou prazo (ex: 'me chama outra hora'), exigindo que a IA pergunte o melhor momento.\"\n    },\n    \"timeExpression\": {\n      \"type\": \"string | null\",\n      \"description\": \"ExpressÃ£o da data solicitada pelo usuÃ¡rio para utilizar com a biblioteca chrono-node (Node.js).\"\n    },\n    \"replyMessage\": {\n      \"type\": \"string\",\n      \"description\": \"Mensagem humanizada e business casual para o WhatsApp, confirmando o horÃ¡rio ou perguntando quando retornar, sem usar exclamaÃ§Ãµes.\"\n    },\n    \"isPassiveConfirmation\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica que o usuÃ¡rio apenas confirmou passivamente (ex: 'blz', 'ok', 'fechou') uma mensagem anterior de agendamento, e a conversa deve ser encerrada com uma despedida educada.\"\n    }\n  },\n  \"required\": [\"isFollowUp\", \"requiresClarification\", \"timeExpression\", \"replyMessage\", \"isPassiveConfirmation\"]\n}\n"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-4576,7216],"id":"e69bbb55-3b39-4b4f-a258-71fb6c4b529c","name":"Parser Router1","disabled":true},{"parameters":{"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[-4768,7216],"id":"27444b92-593b-4f9c-b559-d1258bf5e154","name":"OpenAI Router1","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}},"disabled":true},{"parameters":{"promptType":"define","text":"=### [DADOS DE CONTEXTO]\n- **MENSAGEM ATUAL:** \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n- **HISTÃ“RICO RECENTE (DA MENSAGEM MAIS ANTIGA PARA A MAIS RECENTE):** {{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"Sem histÃ³rico.\" }}\n- **DATA/HORA ATUAL (ISO):** \"{{ $now }}\"\n- **DATA/HORA ATUAL (Por extenso):** {{ $now.setLocale('pt-BR').toFormat(\"cccc, dd 'de' LLLL 'de' yyyy ', ' HH:mm\") }}","hasOutputParser":true,"options":{"systemMessage":"=# SYSTEM: Sensor de Disponibilidade e Agendamento (Micro-Agente)\n\nVocÃª Ã© um mÃ³dulo de inteligÃªncia focado EXCLUSIVAMENTE em analisar se o usuÃ¡rio pode conversar AGORA ou se precisa agendar para DEPOIS.\n\n### [ENTRADAS]\n- **MENSAGEM_ATUAL:** A frase que o usuÃ¡rio acabou de enviar. (FONTE DA VERDADE SUPREMA).\n- **HISTÃ“RICO:** O contexto anterior. (USAR APENAS SE NECESSÃRIO).\n- **DATA_HOJE:** Use para cÃ¡lculos relativos (hoje, amanhÃ£).\n\n---\n\n### [HIERARQUIA DE DECISÃƒO - SIGA NA ORDEM EXATA]\n\n**PASSO 1: DETECÃ‡ÃƒO DE DISPONIBILIDADE IMEDIATA (O \"Agora\")**\n- **PERGUNTA CRÃTICA:** A `MENSAGEM_ATUAL` indica que o usuÃ¡rio quer ou pode conversar **neste exato momento**?\n- **GATILHOS POSITIVOS:** \"Estou livre\", \"Pode falar\", \"Manda\", \"Diga\", \"Opa\" (inÃ­cio de conversa), \"Consegui tempo\", \"Cancelaram a reuniÃ£o\", \"Sim\" (se a IA perguntou 'pode falar agora?'), \"Estou\".\n- **AÃ‡ÃƒO IMEDIATA (Se Positivo):**\n    - `isFollowUp`: **FALSE** (O fluxo segue agora).\n    - `timeExpression`: **NULL** (NÃ£o hÃ¡ agendamento futuro).\n    - `replyMessage`: **\"\"** (String vazia).\n    - **PARE O RACIOCÃNIO.** NÃ£o execute os passos 2 e 3.\n\n**PASSO 2: DETECÃ‡ÃƒO DE AGENDAMENTO OU INDISPONIBILIDADE (O \"Depois\")**\n- **PERGUNTA CRÃTICA:** A `MENSAGEM_ATUAL` indica que o usuÃ¡rio **NÃƒO** pode falar agora ou sugeriu um horÃ¡rio **FUTURO**?\n- **SUB-PASSO 2.A (Com Data Definida):** A mensagem contÃ©m tempo explÃ­cito (ex: \"Me chama amanhÃ£\", \"Daqui 10 min\", \"Estarei livre Ã s 14h\")?\n    - `isFollowUp`: **TRUE** (Vai para a fila de agendamento).\n    - `timeExpression`: Traduza para INGLÃŠS (ex: \"tomorrow at 14:00\", \"in 10 minutes\").\n    - `replyMessage`: \"Combinado! Te chamo [repetir a data em PT-BR].\"\n    - `requiresClarification`: **FALSE**.\n- **SUB-PASSO 2.B (Sem Data Definida):** O usuÃ¡rio disse apenas que estÃ¡ ocupado (ex: \"Agora nÃ£o\", \"TÃ´ em reuniÃ£o\", \"Me chama depois\") mas **NÃƒO** disse quando?\n    - `isFollowUp`: **TRUE**.\n    - `timeExpression`: **NULL**.\n    - `replyMessage`: \"Tudo bem! Quando fica melhor para eu te chamar novamente, entÃ£o?\"\n    - `requiresClarification`: **TRUE**.\n\n**PASSO 3: DETECÃ‡ÃƒO DE ENCERRAMENTO (O \"Tchau\")**\n- **CONTEXTO:** SÃ³ execute se a mensagem for curta/passiva (\"Ok\", \"Blz\", \"Vlw\", \"Tchau\").\n- **REGRA DE PROXIMIDADE:** Olhe EXCLUSIVAMENTE para a **ÃšLTIMA** mensagem da IA no histÃ³rico.\n    - A IA acabou de dizer \"Te chamo amanhÃ£\" (Agendamento)? -> `isPassiveConfirmation`: **TRUE**. Responda: \"AtÃ© mais!\".\n    - A IA acabou de fazer uma pergunta (\"Pode falar?\", \"Qual seu cargo?\")? -> `isPassiveConfirmation`: **FALSE**. Responda: \"\" (Deixe o fluxo seguir).\n\n---\n\n### [DIRETRIZES TÃ‰CNICAS (CHRONO-NODE)]\nSe cair no **PASSO 2.A**, siga estas regras de traduÃ§Ã£o para `timeExpression`:\n- **Futuro PrÃ³ximo:** \"Daqui a pouco\" -> \"in 1 hour\".\n- **Relativos:** \"AmanhÃ£ de manhÃ£\" -> \"tomorrow morning\" (09:00).\n- **Verbos de Futuro:** Se o usuÃ¡rio diz \"Estarei livre amanhÃ£\", isso Ã© PASSO 2 (Agendamento), pois ele NÃƒO estÃ¡ livre agora.\n- **LÃ­ngua:** O output deve ser estritamente em **INGLÃŠS**.\n\n### [REGRAS DE OURO - ANTI-ALUCINAÃ‡ÃƒO]\n1. **SUPREMACIA DO PRESENTE:** Se o histÃ³rico diz \"nÃ£o posso\" mas a MENSAGEM_ATUAL diz \"Estou livre\", obedeÃ§a o \"Estou livre\".\n2. **NÃƒO INVENTE AGENDAMENTOS:** Se caiu no Passo 1 (DisponÃ­vel Agora), `timeExpression` DEVE ser NULL.\n3. **INDISPONIBILIDADE:** `isFollowUp = TRUE` significa **exclusivamente** que a conversa deve parar agora e voltar depois.\n\n---\n\n### [SAÃDA OBRIGATÃ“RIA - JSON PURO]\n{\n  \"thinking\": \"string: 1. Cite a mensagem atual. 2. Diga qual PASSO (1, 2A, 2B ou 3) foi ativado e por quÃª.\",\n  \"isFollowUp\": boolean,\n  \"requiresClarification\": boolean,\n  \"timeExpression\": \"string (EN) ou null\",\n  \"replyMessage\": \"string (PT-BR)\",\n  \"isPassiveConfirmation\": boolean\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-4752,7008],"id":"52ecc462-ecfb-40ad-b761-0995b6808930","name":"Follow-up Router","executeOnce":true,"disabled":true,"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3ca2cf42-2ab9-4010-945a-17b777fb4dc5","leftValue":"={{ $json.output.isFollowUp }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4320,7328],"id":"5c63454d-32fa-4db6-a705-197446131375","name":"Se o usuÃ¡rio estÃ¡ tentando agendar uma re-chamada","disabled":true},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Follow-up Router').first().json.output.replyMessage }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3104,7872],"id":"06d009ec-7e31-4995-97da-c4ccd16ccaa6","name":"Envia WhatsApp","disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('Follow-up Router').first().json.output.replyMessage, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3328,7872],"id":"0daf087c-ef52-497e-a4be-6c69f87dee7a","name":"Insere mensagem da IA no BD2","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2d7ee4c-540b-4d38-8d33-c149ced59489","leftValue":"={{ $('Follow-up Router').first().json.output.timeExpression?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2896,7872],"id":"07279712-f688-4031-9062-500bb9cfcd2c","name":"Se o usuÃ¡rio informou uma data de re-chamada","disabled":true},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"},{"column":"company_id","value":"={{ $('Configura Contexto').first().json.companyId }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4064,7856],"id":"107157a5-4ea4-4a44-86d8-47545b68b8cb","name":"Busca Follow Up1","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up1').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3808,7856],"id":"2b8d604b-5f7b-4525-abfe-c1c2ba887358","name":"Se jÃ¡ existe follow-up2","disabled":true},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up1').first().json.id }}","follow_up_time":"={{ $('Envia para parser com o chrono-node').first().json.parsedDate }}","last_instruction":"={{ `Pergunte se o usuÃ¡rio pode retomar a conversa.` }}","active":"={{ true }}","follow_up_type":"requested","attempts":0},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":false},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1936,7632],"id":"9db9e23b-e8a7-4898-be3f-10287d17a55a","name":"Atualiza follow-up1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"company_id":"={{ $('Configura Contexto').first().json.companyId }}","session_id":"={{ $('Configura Contexto').first().json.cache_key }}","last_instruction":"={{ `Pergunte se o usuÃ¡rio pode retomar a conversa.` }}","follow_up_time":"={{ $('Envia para parser com o chrono-node').first().json.parsedDate }}","user_phone":"={{ $('Configura Contexto').first().json.user_phone }}","active":"={{ true }}","whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","follow_up_type":"requested","agent_name":"={{ $('Seta perfil1').first().json.agentName }}","attempts":0},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1936,7840],"id":"bb167e48-7094-4c63-8a12-abb00a6f8632","name":"Insere novo follow-up1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up1').first().json.id }}","active":"={{ false }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3568,7712],"id":"db74c302-e4b0-47ec-8263-b4fafc50e2e4","name":"Desativa follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up1').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2272,7744],"id":"26799fc3-a79d-4c0c-900b-808cdfa8b327","name":"Se jÃ¡ existe follow-up3","disabled":true},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/chrono-node/parser","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\ntimeExpression: $('Follow-up Router').first().json.output.timeExpression\n}) }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2560,7744],"id":"f54ca22f-9f67-48b4-b486-651824e8e13c","name":"Envia para parser com o chrono-node","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"27a3e6f0-e2d1-4226-9c90-4a4ae9df03c7","leftValue":"={{ $json.output.isPassiveConfirmation }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4000,7328],"id":"817c381a-9352-4f73-9f08-7a49bbef0422","name":"Se for uma confirmaÃ§Ã£o passiva","disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('Follow-up Router').first().json.output.replyMessage, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3264,7104],"id":"78d39fb9-8ab3-44b6-96e1-9ee5b1b49d78","name":"Insere mensagem da IA no BD3","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Follow-up Router').first().json.output.replyMessage }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3056,7104],"id":"7e63f4de-8508-4ebf-b940-d42b1a52202e","name":"Envia WhatsApp2","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9973e414-7551-4bd0-941e-04f86c3516c9","leftValue":"={{ $json.output.replyMessage?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3792,7232],"id":"943e4ce4-3773-4e65-82d3-5fee4cfe0d03","name":"Se existe resposta","disabled":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('LOOP nos follow-up\\'s').item.json.follow_up_type }}","rightValue":"requested","operator":{"type":"string","operation":"equals"},"id":"d71e1dc1-85d0-472b-9e8b-b0b3507dfd37"}],"combinator":"and"},"renameOutput":true,"outputKey":"solicitado"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c14755ff-644f-40ca-8c9c-8b863457a0c1","leftValue":"={{ $('LOOP nos follow-up\\'s').item.json.follow_up_type }}","rightValue":"initiated","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"proativo"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[-2928,5696],"id":"630ebd56-7e07-454c-9fde-da7015d068f3","name":"Switch tipo de follow-up"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":5,"where":{"values":[{"column":"session_id","value":"={{ $('LOOP nos follow-up\\'s').item.json.session_id }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2576,5552],"id":"c0b5832b-162d-47cd-b2f4-1c4499d6edc3","name":"Pega ultimas mensagens2","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2336,5552],"id":"bbd27b67-251c-46de-a2c3-32f7729bf9af","name":"Formata ultimas mensagens2","executeOnce":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4c3ea394-ce4c-441d-818d-2f1278d63264","leftValue":"={{ $('Pega ultimas mensagens1').first().json.message.type }}","rightValue":"ai","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1824,5856],"id":"e14b1744-ead3-486e-a913-e930d4bdfc4e","name":"Se a Ãºltima mensagem foi da IA"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini-2024-07-18","mode":"list","cachedResultName":"GPT-4O-MINI-2024-07-18"},"responses":{"values":[{"role":"system","content":"=**SISTEMA:** VocÃª Ã© um humano retomando um papo que foi pausado. Use tom \"business casual\". Sem formalidade. Sem exclamaÃ§Ãµes.\n\n**REGRAS DE DIAMANTE**\n - VÃ¡ direto ao ponto: o objetivo Ã© apenas saber se o usuÃ¡rio pode falar agora.\n - Proibido citar horÃ¡rios, datas, motivos do atraso ou o assunto anterior.\n\n**ALGORITMO DE COMPOSIÃ‡ÃƒO:**\n1. **IDENTIDADE:**\n   - Se [NOME] existir: Comece com \"[NOME], ...\"\n   - Se [NOME] for vazio/null: Comece com \"Oi, tudo bem?\" ou \"Oi, tudo certo?\".\n2. **PONTE DE RETOMADA:** Use exclusivamente frases de disponibilidade imediata como \"conseguimos retomar nossa conversa\", \"vocÃª tÃ¡ livre pra conversar agora\", \"vocÃª tem um tempinho\" ou \"conseguimos dar continuidade\".\n3. **FILTRO DE MEMÃ“RIA (CRÃTICO):** Ignore qualquer informaÃ§Ã£o sobre \"amanhÃ£\", \"11h\" ou \"reuniÃ£o\". Sua Ãºnica missÃ£o Ã© transformar o comando \"Pergunte se o usuÃ¡rio pode retomar a conversa\" em uma pergunta de disponibilidade atual.\n\n---\n\n**REGRAS RÃGIDAS:**\n- **PROIBIDO:** \"Lead\", \"Pendente\", \"InformaÃ§Ã£o\", \"Sistema\", \"Ocupado\", \"AmanhÃ£\", \"HorÃ¡rio\", \"Agendado\".\n- **LIMITE:** MÃ¡ximo 15 palavras.\n- **PONTUAÃ‡ÃƒO:** Ã‰ terminantemente proibido o uso de exclamaÃ§Ãµes (!). \n- **FINALIZAÃ‡ÃƒO:** Termine obrigatoriamente com a interrogaÃ§Ã£o da pergunta.\n\n**SAÃDA FINAL (TEXTO PURO):**"},{"content":"=**DADOS:**\n- **NOME_USUARIO:** {{ $('Transforma estado atual em JSON literal').first().json.vars.name.value }}\n- **COMANDO:** {{ $('LOOP nos follow-up\\'s').first().json.last_instruction }}\n- **HISTÃ“RICO DE CONVERSA:** \n{{ $('Formata ultimas mensagens2').first().json.historyMessages }}"}]},"builtInTools":{},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2,"position":[-2112,5552],"id":"2f02f8bf-13bf-4d5d-bd09-12b76deb65bc","name":"Gera mensagem de follow-up1","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('LOOP nos follow-up\\'s').first().json.company_id }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output[0].content[0].text }}"},{"name":"number","value":"={{ $('LOOP nos follow-up\\'s').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('LOOP nos follow-up\\'s').first().json.whatsapp_id }}"},{"name":"addUserName","value":"={{ $('LOOP nos follow-up\\'s').first().json.agent_name }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1760,5552],"id":"80198c26-f6bd-4bcd-bb7b-31a2c66190f1","name":"Envia via Apre.Chat1"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\":  $('Gera mensagem de follow-up1').first().json.output[0].content[0].text, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1264,5552],"id":"83d0c83e-1b72-45f1-a15d-bb1e0a1cce16","name":"Insere mensagem da IA no BD4","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('LOOP nos follow-up\\'s').first().json.id }}","attempts":"={{ $('LOOP nos follow-up\\'s').first().json.attempts + 1 }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-848,5840],"id":"d203fff1-dea3-41cc-9e9b-90d42d0b6cc6","name":"Atualiza tentativas de follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('LOOP nos follow-up\\'s').first().json.id }}","attempts":"={{ $('LOOP nos follow-up\\'s').first().json.attempts + 1 }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1504,5552],"id":"3a9264c0-93cb-4300-ae8b-e1b7bbd37b51","name":"Atualiza tentativa de follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"return $('Parser  Chain').first().json.output.messages.map(message => ({\n  json: { message }\n}))"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3824,3232],"id":"4ebf1087-a9a5-4c50-b99b-143a8a316946","name":"Split de mensagens1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2dfab0a2-c614-429c-a13d-36ecb7803f12","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3376,3248],"id":"b00f66ca-3aa0-4014-94cb-845f5050c306","name":"Se nÃ£o recebeu mensagem no meio do processamento2","alwaysOutputData":false},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3168,3248],"id":"7171f650-6353-4a3b-99dd-a9fb6d76b35d","name":"GET","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"=Whatsapp message to be splitted and formated: {{ $json.output }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=# SYSTEM: Otimizador de Texto WhatsApp\nObjetivo: Dividir o texto de entrada em 1 a 4 balÃµes de leitura fluida.\n\n# REGRAS DE EXECUÃ‡ÃƒO\n1. **FormataÃ§Ã£o:**\n   - Converta `**texto**` â†’ `*texto*` -> Apenas para textos que utilizam **.\n   - Converta `~~texto~~` â†’ `~texto~` -> Apenas para textos que utilizam ~~.\n   - Converta `__texto__` â†’ `_texto_` -> Apenas para textos que utilizam __.\n   - URLs: Devem ser isoladas em uma mensagem exclusiva e envoltas em crase (`url`).\n   - Um split NUNCA deve terminar com vÃ­rgula. Ex: 'Bacana, agora me diz uma coisa,' -> 'Bacana, agora me diz uma coisa' \n\n2. **SegmentaÃ§Ã£o (Split):**\n   - **Tamanho:** Alvo de ~150 caracteres (Max 250).\n   - **Corte:** Nunca quebre frases no meio. Use pontuaÃ§Ã£o (. ? !) como guia.\n   - **CoesÃ£o:** Emojis ficam sempre colados Ã  palavra anterior.\n   - **Contexto:** Separe saudaÃ§Ãµes e perguntas finais em balÃµes prÃ³prios se possÃ­vel.\n\n3. **Output:**\n   - Gere JSON estrito. Sem blocos de cÃ³digo markdown.\n\n# JSON SCHEMA\n{ \"messages\": [\"msg1\", \"msg2\", \"msg3\"] }"}]}},"id":"e47446ec-c412-4426-bc59-ab63c86241ac","name":"Parser  Chain","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[2656,3248]},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}"},"id":"5fea572b-e1d8-496f-960e-40c0dec581de","name":"OutputParser1","type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[2832,3424]},{"parameters":{"model":"gpt-4o-mini-2024-07-18","options":{"temperature":0.5}},"id":"da92c2e6-f03e-4044-a8a2-8416afe63dff","name":"OpenAI1","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[2624,3488],"credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[5440,3360],"id":"56a6a1f0-ee61-461c-ae93-1a7e515d0655","name":"WAIT_SPLIT","webhookId":"3cea2837-6c05-4e79-8798-96260c4f8dc6"},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[4032,3232],"id":"16d90e04-0b2b-4433-82a5-7e2dcc9e9898","name":"LOOP_SLIT"},{"parameters":{"method":"POST","url":"https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('LOOP_SLIT').item.json.message }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5184,3328],"id":"46dcaaa2-4f15-4245-bd7b-13c95808848d","name":"Envia WhatsApp3"},{"parameters":{"amount":2},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[2944,3248],"id":"2d8bec83-a26d-4d85-85fc-e0697fb61404","name":"WAIT_SPLIT3","webhookId":"3cea2837-6c05-4e79-8798-96260c4f8dc6"},{"parameters":{"jsCode":"return {\n  messages: [\n    ...(typeof $('BUSCA MENSAGENS ACUMULADAS').first().json.messages == 'string' ? JSON.parse($('BUSCA MENSAGENS ACUMULADAS').first().json.messages) : $('BUSCA MENSAGENS ACUMULADAS').first().json.messages), \n    ...(typeof $('GET').first().json.messages == 'string' ? JSON.parse($('GET').first().json.messages) : $('GET').first().json.messages)\n  ]\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3568,3696],"id":"07282f93-4672-4aa1-acc4-14f0f49beb6f","name":"Concatena mensagens para cache1"},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4256,3296],"id":"cc840b47-35b4-4a38-ad9b-85b66fba958f","name":"GET4","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2dfab0a2-c614-429c-a13d-36ecb7803f12","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[4464,3296],"id":"7ceefa7d-c1db-40e2-affb-7dc96226d9d2","name":"Se nÃ£o recebeu mensagem no meio do processamento3","alwaysOutputData":false},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($('Concatena mensagens para cache1').first().json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3776,3696],"id":"9c208772-6963-47b9-b0ab-dcf0b089adf6","name":"RE-SETA CACHE DAS MENSAGENS ACUMULADAS1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('LOOP_SLIT').first().json.message , \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[4784,3312],"id":"286c03b2-32c9-4ad9-bcf0-9f6fa2a15ccf","name":"Insere mensagem da IA no BD5","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"wd0uAb0Sm1fW5YNt","mode":"list","cachedResultUrl":"/workflow/wd0uAb0Sm1fW5YNt","cachedResultName":"Enviar apresentaÃ§Ã£o comercial"},"workflowInputs":{"mappingMode":"defineBelow","value":{"whatsappId":"={{ $('Configura Contexto').first().json.whatsappId.toNumber() }}","messageRepliedId":0,"company":"={{ $('Configura Contexto').first().json.companyId }}","number":"={{ $('Configura Contexto').first().json.user_phone }}","addUserName":"={{ $('Seta perfil1').first().json.agentName }}","message":"Segue! ðŸš€ðŸš€"},"matchingColumns":[],"schema":[{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"number","displayName":"number","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"addUserName","displayName":"addUserName","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsappId","displayName":"whatsappId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"messageRepliedId","displayName":"messageRepliedId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"company","displayName":"company","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[4544,2704],"id":"2c1f2e81-4a37-45a7-bd9e-ac219f41a296","name":"Call 'Enviar apresentaÃ§Ã£o comercial'1","executeOnce":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"CLOSING","operator":{"type":"string","operation":"equals"},"id":"732957f5-38a8-4204-ab63-9403f96c1a78"}],"combinator":"and"},"renameOutput":true,"outputKey":"closing"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1a022d7b-9866-445e-824d-ee7a7616d891","leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"CLOSING_WHEN_INVALID_OPTION","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"closing_when_invalid_option"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3807d7cc-18c1-470f-9689-a991e3d75d2b","leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"SEND_COMMERCIAL_PRESENTATION","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"send_commercial_presentation"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[4640,3040],"id":"1bb162f6-eb71-4134-ae64-955f1f8cec47","name":"Switch1"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"sort":{"values":[{"column":"id"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[5168,2704],"id":"736158cd-b547-4e37-8f11-0ac28da9f4ed","name":"Busca histÃ³rico de conversa","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[5648,2912],"id":"42e59136-4848-4c26-84e0-76be6e951e00","name":"DeepSeek Chat Model","credentials":{"deepSeekApi":{"id":"RhJeeogDvgiUtqv2","name":"DeepSeek account"}}},{"parameters":{"promptType":"define","text":"=[HISTÃ“RICO DE CONVERSA]\n{{ $json.result }}","options":{"systemMessage":"*DOSSIÃŠ*\nCrie um breve DossiÃª da conversa, listando cada informaÃ§Ã£o separada por linha e colocando a label em negrito.\n\n*ANÃLISE*\nTom: Defina o tom/perfil do usuÃ¡rio.\nResumo: Gere um breve resumo da conversa\n\n*ONDE PAROU*\nInforme onde a conversa parou\n\n*PRÃ“XIMOS PASSOS*\nDefina os prÃ³ximos passos\n\n## FORMATAÃ‡ÃƒO:\nNegrito: Um asterisco antes e depois da palavra/frase. Ex: '*Teste*'\nItÃ¡lico:  Um underline antes e depois da palavra/frase. Ex: '_Teste_'\n\n## REGRAS DE OURO:\n- Seja breve\n- Crie um resumo objetivo\n- Texto corrido apenas no resumo (bloco anÃ¡lise)\n\n\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[5664,2704],"id":"e256bec9-1aef-4c96-a091-38bce4312a39","name":"Gera resumo da conversa - AI"},{"parameters":{"jsCode":"const data = $input.all();\nconst formatChatHistory = (inputData) => {\n  return inputData.map(jsonItem => {\n    const item = jsonItem.json\n    // 1. Define o remetente\n    const sender = item.message.type === 'human' ? 'User' : 'IA';\n    \n    // 2. Pega o conteÃºdo original\n    let content = item.message.content;\n\n    // 3. Se for IA, aplica a Regex para limpar o \"lixo\" tÃ©cnico\n    if (item.message.type === 'ai') {\n      // REGEX EXPLICADA:\n      // ^              -> ComeÃ§a no inÃ­cio da string\n      // \\[Used tools:  -> Procura literalmente por \"[Used tools:\"\n      // [\\s\\S]*?       -> Pega qualquer caractere (incluindo quebra de linha) de forma nÃ£o-gulosa (para no primeiro match)\n      // \\]\\]           -> Procura o fechamento dos colchetes duplos \"]]\"\n      // \\s* -> Remove quaisquer espaÃ§os ou quebras de linha que sobrem logo apÃ³s\n      content = content.replace(/^\\[Used tools:[\\s\\S]*?\\]\\]\\s*/, '');\n    }\n\n    // 4. Retorna no formato solicitado\n    return `${sender}: ${content}`;\n  }).join('\\n'); // Une tudo com quebra de linha\n};\n\n// Executa e mostra o resultado\nconst result = formatChatHistory(data);\n\nreturn  {\n  result\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5392,2704],"id":"11045a1d-c2d0-4ec2-a725-b5d13ab33523","name":"Formata histÃ³rico","executeOnce":true},{"parameters":{"method":"POST","url":"=https://api-chat-joao.apre.tv/api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output }}"},{"name":"number","value":"={{ $('Webhook').first().json.body.contact.number }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"},{"name":"whatsappId","value":"={{ $('Webhook').first().json.body.whatsappId }}"},{"name":"messageRepliedId","value":"={{ $('Webhook').first().json.body.messageId }}"},{"name":"messageType","value":"internalNote"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[6032,2704],"id":"c8bccaf2-387b-4983-bdb4-5d26cc5e04c3","name":"Salva nota na conversa"},{"parameters":{"method":"PATCH","url":"=https://api-chat-joao.apre.tv/api/ticket/{{ $('Webhook').first().json.body.ticketId }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"pending\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[4896,2704],"id":"5f2e90c5-ff84-4322-937d-4f723684d98a","name":"Transfere ticket para Aguardando Apre.Chat1"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"company_id":"={{ $('Configura Contexto').first().json.companyId }}","session_id":"={{ $('Configura Contexto').first().json.cache_key }}","last_instruction":"={{ `Pergunte: ${JSON.parse($('Busca estado atual para follow-up1').item.json.propertyName || '{}').missingVar.description}` }}","last_var_requested":"={{ JSON.parse($('Busca estado atual para follow-up1').item.json.propertyName || '{}').missingVar.name }}","follow_up_time":"={{ $now.plus(2, 'hours') }}","user_phone":"={{ $('Configura Contexto').first().json.user_phone }}","attempts":0,"whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","agent_name":"={{ $('Seta perfil1').first().json.agentName }}","follow_up_type":"initiated"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[5312,3984],"id":"c44971a3-4ae8-4284-b96f-b38ed2018812","name":"Insere novo follow-up2","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up2').item.json.id }}","last_instruction":"={{ `Pergunte: ${JSON.parse($('Busca estado atual para follow-up1').item.json.propertyName || '{}').missingVar.description}` }}","last_var_requested":"={{ JSON.parse($('Busca estado atual para follow-up1').item.json.propertyName || '{}').missingVar.name }}","follow_up_time":"={{ $now.plus(2, 'hours') }}","attempts":0,"active":"={{ true }}","follow_up_type":"initiated","whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[5312,3792],"id":"cd5b9ebf-7534-4cb3-82e0-48f1f2a06aee","name":"Atualiza follow-up2","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up2').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[5104,3888],"id":"fa72d105-b34d-4df7-b8ea-7f7511da96fe","name":"Se jÃ¡ existe follow-up1"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"},{"column":"company_id","value":"={{ $('Configura Contexto').first().json.companyId }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[4896,3888],"id":"f307f1e1-e012-48ea-8f70-8c1452c1f86a","name":"Busca Follow Up2","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4688,3888],"id":"8068ba67-639f-4fd0-8a2f-fb974956f66e","name":"Busca estado atual para follow-up1","executeOnce":true,"credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"=### [PAINEL DE CONTROLE - PLANNER LÃ“GICO]\n\n### CONTEXTO DO USUÃRIO:\nMsg: \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n\n1. ANÃLISE DE CONTEXTO:\n- HistÃ³rico Recente: \"{{ $('Formata ultimas mensagens').first().json.historyMessages ? $('Formata ultimas mensagens').first().json.historyMessages : 'VAZIO' }}\"\n- Tem mensagens anteriores? {{ $('Formata ultimas mensagens').first().json.historyMessages ? 'SIM' : 'NÃƒO' }}\n- Tem [dÃºvida especÃ­fica] ? {{ $('Router de DÃºvida').first().json.output.hasQuestion ? 'SIM' : 'NÃƒO' }}\n\n2. DADOS TÃ‰CNICOS (RAG):\n\"{{ $('MERGE DADOS').first().json.rag_context ? $('MERGE DADOS').first().json.rag_context.join('\\n') : 'Nenhuma informaÃ§Ã£o tÃ©cnica encontrada.' }}\"\n\n3. ORDEM DO FLUXO (BLUEPRINT):\n- InstruÃ§Ã£o ObrigatÃ³ria: \"{{ $('LOGIC ENGINE').first().json.finalInstruction }}\"\n\n### MISSÃƒO DO PLANNER (CLASSIFICAÃ‡ÃƒO ESTRITA):\n\n**PASSO 1: Analise a Msg do usuÃ¡rio e CLASSIFIQUE em um dos 3 tipos:**\n\n* **TIPO A (Social/ConfirmaÃ§Ã£o/Vazio):** \"Oi\", \"Bom dia\", \"Tudo bem?\", \"Sim\", \"NÃ£o\", \"Pode ser\", \"Aguardo\", \"Tranquilo\", \"Entendi\".\n    * *AÃ§Ã£o:* Deixe `[FACT]` totalmente **VAZIO**.\n\n* **TIPO B (Curiosidade Geral):** ex: \"Como funciona?\", \"O que o sistema faz?\", \"Quero conhecer\".\n    * *AÃ§Ã£o:* Crie um resumo de 2 frases usando o RAG e coloque em `[FACT]`.\n\n* **TIPO C (DÃºvida EspecÃ­fica):** ex: \"Tem teste grÃ¡tis?\", \"Integra com X?\", \"Qual o valor?\".\n    * *AÃ§Ã£o:* FaÃ§a um **TESTE DE CORRESPONDÃŠNCIA EXATA** com o RAG.\n        * Pergunta: \"O texto do RAG contÃ©m explicitamente a resposta para o termo perguntado?\"\n        * **SIM:** Copie a resposta crua para `[FACT]`.\n        * **NÃƒO / PARECIDO:** Se o usuÃ¡rio perguntou \"A\" (Venda de carros) e o RAG sÃ³ fala de \"B\" (Venda de frutas), ISSO NÃƒO Ã‰ A MESMA COISA. Escreva: `[FACT]: NEEDS_SPECIALIST`.\n\n**PASSO 2: Defina a Flag de SaudaÃ§Ã£o:**\n* Se HistÃ³rico != 'VAZIO' -> `[FLAG]: SKIP_INTRO`\n* Se HistÃ³rico == 'VAZIO' -> `[FLAG]: ALLOW_INTRO`\n\n**PASSO 3: Filtro de RedundÃ¢ncia (OtimizaÃ§Ã£o do [NEXT]):**\nAnalise a `InstruÃ§Ã£o ObrigatÃ³ria`. O conteÃºdo explicativo dela JÃ FOI ENVIADO pela IA nas mensagens recentes do histÃ³rico?\n* **SIM (JÃ¡ explicado):** O `[NEXT]` deve conter **APENAS a pergunta final** ou a chamada de aÃ§Ã£o (CTA).\n    * *Exemplo:* Se a instruÃ§Ã£o Ã© \"Explicar X e perguntar algo\", e a IA jÃ¡ explicou X, o `[NEXT]` vira apenas a nova pergunta\".\n* **NÃƒO (ConteÃºdo Novo):** O `[NEXT]` deve ser a cÃ³pia fiel da `InstruÃ§Ã£o ObrigatÃ³ria`.\n\n### OUTPUT OBRIGATÃ“RIO:\n[FLAG]: ...\n[FACT]: ...\n[NEXT]: ...","options":{"systemMessage":"VocÃª Ã© o Planner. Seja seco. Sua funÃ§Ã£o Ã© garantir que a resposta tÃ©cnica esteja correta e que o fluxo seja seguido. NÃ£o tente ser simpÃ¡tico.\nVocÃª nÃ£o repete mensagens.\nVocÃª"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[1840,3248],"id":"dcad4307-9ecd-4b98-809d-358665cb9028","name":"Planner de ConteÃºdo (LÃ³gico)"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini-2024-07-18","mode":"list","cachedResultName":"gpt-4o-mini-2024-07-18"},"builtInTools":{},"options":{"temperature":0.6}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[1744,3600],"id":"41d0edee-6aff-4458-922c-b31f23517a20","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"## TOOL: BASE DE CONHECIMENTO\nUse APENAS se o usuÃ¡rio fizer uma pergunta tÃ©cnica.","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[1872,3696],"id":"597ee3ce-b1b7-42d8-8456-23a287e468cb","name":"Base de conhecimento1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[1824,3904],"id":"abb84165-14be-43cd-8c1c-8c4464ca8309","name":"Embeddings OpenAI3","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"assignments":{"assignments":[{"id":"ae48936d-1ae8-440b-a604-2a6e4c4418f1","name":"output","value":"={{ $json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2432,3248],"id":"a17cdfce-f05e-41c2-8093-4f1ed286c08b","name":"output"},{"parameters":{"promptType":"define","text":"=### INSTRUÃ‡Ã•ES DO PLANNER:\n{{ $json.output }}\n\n### REGRAS DE CONEXÃƒO (A COLA DA CONVERSA):\nVocÃª deve transformar o rascunho robÃ³tico do Planner em uma conversa fluida. \n\n**O GRANDE ERRO A EVITAR:**\nNUNCA faÃ§a isso: \"O sistema faz X e Y. Qual seu nome?\" (Isso Ã© robÃ³tico).\n\n**O JEITO CERTO (TÃ©cnica do PivÃ´):**\n\"O sistema faz X e Y, o que agiliza muito o dia a dia! Mas antes de continuarmos, com quem eu falo?\" \n\n### DIRETRIZES (Siga na ordem):\n0. **BLOQUEIO DE ALUCINAÃ‡ÃƒO (NEEDS_SPECIALIST):** Verifique o campo [FACT]. Se estiver escrito \"NEEDS_SPECIALIST\", vocÃª estÃ¡ **PROIBIDA** de responder a dÃºvida do usuÃ¡rio com seu conhecimento prÃ³prio.\n   - **AÃ‡ÃƒO OBRIGATÃ“RIA:** Diga EXATAMENTE: \"Sobre [ASSUNTO QUESTIONADO PELO USUÃRIO], prefiro confirmar com um especialista pra nÃ£o te passar informaÃ§Ã£o errada, tÃ¡?\".\n   - ApÃ³s essa frase, pule direto para a diretriz 3 (PivÃ´).\n\n1. **VALIDAÃ‡ÃƒO:** Se [FACT] contiver texto tÃ©cnico real, explique de forma simples e termine com um mini-comentÃ¡rio de benefÃ­cio.\n\n2. **EXECUÃ‡ÃƒO RIGOROSA DO [NEXT]:** O texto em [NEXT] Ã© o seu roteiro. Reescreva-o com seu tom.\n   - Se o [NEXT] mandar perguntar algo (ex: nome), pergunte.\n   - Se o [NEXT] jÃ¡ tiver o dado (ex: \"[JoÃ£o]\"), use o dado.\n\n3. **PIVÃ”:** Use conectores para mudar de assunto suavemente: \"A propÃ³sito...\", \"AliÃ¡s...\", \"Pra gente seguir...\", \"Antes de eu te explicar mais...\"\n\n4. **FLAG SKIP_INTRO:** Se o planner disser SKIP_INTRO, nÃ£o diga \"Oi\" nem se apresente novamente.\n\n5. **FLAG ALLOW_INTRO:** Se o planner disser ALLOW_INTRO, inicie se apresentando conforme seu perfil.\n\n6. **PERGUNTA FINAL:** A Ãºltima frase da sua mensagem deve ser sempre a pergunta ou aÃ§Ã£o solicitada no [NEXT].\n\n### CONTEXTO DO USUÃRIO:\nMsg: \"{{ $('CONCATENA1').first().json.user_full_message }}\"","options":{"systemMessage":"=VocÃª Ã© a {{ $('Seta perfil1').first().json.agentName }} - {{ $('Seta perfil1').first().json.role }}. \nVocÃª Ã© {{ $('Seta perfil1').first().json.tone }}.\nVocÃª odeia parecer um formulÃ¡rio, por isso, conecta validaÃ§Ãµes com perguntas. \nVocÃª SEMPRE cria uma 'ponte' ou um 'gancho' entre a resposta tÃ©cnica e a prÃ³xima pergunta. Se vocÃª for direta demais, a venda Ã© perdida.\nVocÃª sempre se apresenta quando Ã© necessÃ¡rio.\nVocÃª estÃ¡ sempre disposto a apresentar seu produto quando um usuÃ¡rio pergunta (sem inventar).\nVocÃª responde como um HUMANO, sem deixar qualquer vestÃ­gio de que Ã© um ROBÃ”.\nVocÃª atua na Ã¡rea de segmento: {{ $('Seta perfil1').first().json.companyDepartment }}\nO site da empresa em que vocÃª trabalha Ã© o {{ $('Seta perfil1').first().json.companySite }}\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[2128,3248],"id":"e0cfa549-a2c1-40af-b95c-646ca2eef7a4","name":"Redator de Persona"}],"connections":{"Salva Novo Estado":{"main":[[{"node":"Router de DÃºvida","type":"main","index":0}]]},"Parser Router":{"ai_outputParser":[[{"node":"Router de DÃºvida","type":"ai_outputParser","index":0}]]},"OpenAI Router":{"ai_languageModel":[[{"node":"Router de DÃºvida","type":"ai_languageModel","index":0}]]},"Router de DÃºvida":{"main":[[{"node":"Tem DÃºvida?","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Configura Contexto","type":"main","index":0}]]},"GET Estado Atual":{"main":[[{"node":"BLUEPRINT ENGINE","type":"main","index":0}]]},"BLUEPRINT ENGINE":{"main":[[{"node":"Pega ultimas mensagens","type":"main","index":0}]]},"Extrator Inteligente":{"main":[[{"node":"LOGIC ENGINE","type":"main","index":0}]]},"DeepSeek Model":{"ai_languageModel":[[{"node":"Extrator Inteligente","type":"ai_languageModel","index":0}]]},"LOGIC ENGINE":{"main":[[{"node":"Salva Novo Estado","type":"main","index":0}]]},"CONCATENA1":{"main":[[{"node":"GET Estado Atual","type":"main","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"Extrator Inteligente","type":"ai_outputParser","index":0}]]},"Wait1":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"DELETE1":{"main":[[{"node":"CONCATENA1","type":"main","index":0}]]},"SWITCH_BUFFER":{"main":[[{"node":"DELETE1","type":"main","index":0}],[{"node":"NADA1","type":"main","index":0}],[{"node":"Wait1","type":"main","index":0}]]},"Configura Contexto":{"main":[[{"node":"If2","type":"main","index":0}]]},"If2":{"main":[[{"node":"Deleta estado atual","type":"main","index":0}],[{"node":"Busca mensagens no cache","type":"main","index":0}]]},"Deleta estado atual":{"main":[[{"node":"Delete table or rows1","type":"main","index":0}]]},"Delete table or rows1":{"main":[[{"node":"DELETE2","type":"main","index":0}]]},"Transforma em objeto literal":{"main":[[{"node":"SWITCH_BUFFER","type":"main","index":0}]]},"Busca mensagens no cache":{"main":[[{"node":"Junta mensagem do cache com a mensagem do usuÃ¡rio","type":"main","index":0}]]},"Junta mensagem do cache com a mensagem do usuÃ¡rio":{"main":[[{"node":"SETA CACHE DAS MENSAGENS","type":"main","index":0}]]},"SETA CACHE DAS MENSAGENS":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"BUSCA MENSAGENS ACUMULADAS":{"main":[[{"node":"Transforma em objeto literal","type":"main","index":0}]]},"Tem DÃºvida?":{"main":[[{"node":"Consulta Base Conhecimento","type":"main","index":0}],[{"node":"MERGE DADOS","type":"main","index":0}]]},"Consulta Base Conhecimento":{"main":[[{"node":"RAG CONTEXT","type":"main","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Consulta Base Conhecimento","type":"ai_embedding","index":0}]]},"RAG CONTEXT":{"main":[[{"node":"MERGE DADOS","type":"main","index":0}]]},"MERGE DADOS":{"main":[[{"node":"Planner de ConteÃºdo (LÃ³gico)","type":"main","index":0}]]},"Pega ultimas mensagens":{"main":[[{"node":"Formata ultimas mensagens","type":"main","index":0}]]},"Formata ultimas mensagens":{"main":[[{"node":"Seta perfil1","type":"main","index":0}]]},"Cron 1em1 min - FOLLOW-UP":{"main":[[{"node":"Busca follow-ups disponÃ­veis","type":"main","index":0}]]},"Busca follow-ups disponÃ­veis":{"main":[[{"node":"Wait","type":"main","index":0}]]},"LOOP nos follow-up's":{"main":[[],[{"node":"BUSCA MENSAGENS ACUMULADAS1","type":"main","index":0}]]},"Busca estado atual da conversa":{"main":[[{"node":"Transforma estado atual em JSON literal","type":"main","index":0}]]},"Transforma estado atual em JSON literal":{"main":[[{"node":"Switch tipo de follow-up","type":"main","index":0}]]},"Se o usuÃ¡rio respondeu a variÃ¡vel pendente no meio do caminho":{"main":[[],[{"node":"Pega ultimas mensagens1","type":"main","index":0}]]},"Gera mensagem de follow-up":{"main":[[{"node":"Envia via Apre.Chat","type":"main","index":0}]]},"Envia via Apre.Chat":{"main":[[{"node":"Atualiza tentativas de follow-up","type":"main","index":0}]]},"Pega ultimas mensagens1":{"main":[[{"node":"Formata ultimas mensagens1","type":"main","index":0}]]},"Formata ultimas mensagens1":{"main":[[{"node":"Se a Ãºltima mensagem foi da IA","type":"main","index":0}]]},"DELETE2":{"main":[[{"node":"Remove follow-ups","type":"main","index":0}]]},"BUSCA MENSAGENS ACUMULADAS1":{"main":[[{"node":"Se chegou alguma mensagem do usuÃ¡rio","type":"main","index":0}]]},"Se chegou alguma mensagem do usuÃ¡rio":{"main":[[],[{"node":"Busca estado atual da conversa","type":"main","index":0}]]},"Wait":{"main":[[{"node":"LOOP nos follow-up's","type":"main","index":0}]]},"Seta perfil1":{"main":[[{"node":"Insere mensagem do usuÃ¡rio no BD","type":"main","index":0}]]},"Insere mensagem do usuÃ¡rio no BD":{"main":[[{"node":"Extrator Inteligente","type":"main","index":0}]]},"Parser Router1":{"ai_outputParser":[[{"node":"Follow-up Router","type":"ai_outputParser","index":0}]]},"OpenAI Router1":{"ai_languageModel":[[{"node":"Follow-up Router","type":"ai_languageModel","index":0}]]},"Follow-up Router":{"main":[[{"node":"Se o usuÃ¡rio estÃ¡ tentando agendar uma re-chamada","type":"main","index":0}]]},"Se o usuÃ¡rio estÃ¡ tentando agendar uma re-chamada":{"main":[[{"node":"Busca Follow Up1","type":"main","index":0}],[{"node":"Se for uma confirmaÃ§Ã£o passiva","type":"main","index":0}]]},"Envia WhatsApp":{"main":[[{"node":"Se o usuÃ¡rio informou uma data de re-chamada","type":"main","index":0}]]},"Insere mensagem da IA no BD2":{"main":[[{"node":"Envia WhatsApp","type":"main","index":0}]]},"Se o usuÃ¡rio informou uma data de re-chamada":{"main":[[{"node":"Envia para parser com o chrono-node","type":"main","index":0}]]},"Busca Follow Up1":{"main":[[{"node":"Se jÃ¡ existe follow-up2","type":"main","index":0}]]},"Se jÃ¡ existe follow-up2":{"main":[[{"node":"Desativa follow-up","type":"main","index":0}],[{"node":"Insere mensagem da IA no BD2","type":"main","index":0}]]},"Desativa follow-up":{"main":[[{"node":"Insere mensagem da IA no BD2","type":"main","index":0}]]},"Se jÃ¡ existe follow-up3":{"main":[[{"node":"Atualiza follow-up1","type":"main","index":0}],[{"node":"Insere novo follow-up1","type":"main","index":0}]]},"Envia para parser com o chrono-node":{"main":[[{"node":"Se jÃ¡ existe follow-up3","type":"main","index":0}]]},"Se for uma confirmaÃ§Ã£o passiva":{"main":[[{"node":"Se existe resposta","type":"main","index":0}],[]]},"Insere mensagem da IA no BD3":{"main":[[{"node":"Envia WhatsApp2","type":"main","index":0}]]},"Se existe resposta":{"main":[[{"node":"Insere mensagem da IA no BD3","type":"main","index":0}]]},"Switch tipo de follow-up":{"main":[[{"node":"Pega ultimas mensagens2","type":"main","index":0}],[{"node":"Se o usuÃ¡rio respondeu a variÃ¡vel pendente no meio do caminho","type":"main","index":0}]]},"Pega ultimas mensagens2":{"main":[[{"node":"Formata ultimas mensagens2","type":"main","index":0}]]},"Se a Ãºltima mensagem foi da IA":{"main":[[{"node":"Gera mensagem de follow-up","type":"main","index":0}]]},"Formata ultimas mensagens2":{"main":[[{"node":"Gera mensagem de follow-up1","type":"main","index":0}]]},"Envia via Apre.Chat1":{"main":[[{"node":"Atualiza tentativa de follow-up","type":"main","index":0}]]},"Atualiza tentativas de follow-up":{"main":[[{"node":"Insere mensagem da IA no BD1","type":"main","index":0}]]},"Gera mensagem de follow-up1":{"main":[[{"node":"Envia via Apre.Chat1","type":"main","index":0}]]},"Atualiza tentativa de follow-up":{"main":[[{"node":"Insere mensagem da IA no BD4","type":"main","index":0}]]},"Split de mensagens1":{"main":[[{"node":"LOOP_SLIT","type":"main","index":0}]]},"Se nÃ£o recebeu mensagem no meio do processamento2":{"main":[[{"node":"Split de mensagens1","type":"main","index":0}],[{"node":"Concatena mensagens para cache1","type":"main","index":0}]]},"GET":{"main":[[{"node":"Se nÃ£o recebeu mensagem no meio do processamento2","type":"main","index":0}]]},"Parser  Chain":{"main":[[{"node":"WAIT_SPLIT3","type":"main","index":0}]]},"OutputParser1":{"ai_outputParser":[[{"node":"Parser  Chain","type":"ai_outputParser","index":0}]]},"OpenAI1":{"ai_languageModel":[[{"node":"Parser  Chain","type":"ai_languageModel","index":0}]]},"WAIT_SPLIT":{"main":[[{"node":"LOOP_SLIT","type":"main","index":0}]]},"LOOP_SLIT":{"main":[[{"node":"Switch1","type":"main","index":0},{"node":"Busca estado atual para follow-up1","type":"main","index":0}],[{"node":"GET4","type":"main","index":0}]]},"Envia WhatsApp3":{"main":[[{"node":"WAIT_SPLIT","type":"main","index":0}]]},"WAIT_SPLIT3":{"main":[[{"node":"GET","type":"main","index":0}]]},"Concatena mensagens para cache1":{"main":[[{"node":"RE-SETA CACHE DAS MENSAGENS ACUMULADAS1","type":"main","index":0}]]},"GET4":{"main":[[{"node":"Se nÃ£o recebeu mensagem no meio do processamento3","type":"main","index":0}]]},"Se nÃ£o recebeu mensagem no meio do processamento3":{"main":[[{"node":"Insere mensagem da IA no BD5","type":"main","index":0}]]},"Insere mensagem da IA no BD5":{"main":[[{"node":"Envia WhatsApp3","type":"main","index":0}]]},"Call 'Enviar apresentaÃ§Ã£o comercial'1":{"main":[[{"node":"Transfere ticket para Aguardando Apre.Chat1","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Transfere ticket para Aguardando Apre.Chat1","type":"main","index":0}],[{"node":"Transfere ticket para Aguardando Apre.Chat1","type":"main","index":0}],[{"node":"Call 'Enviar apresentaÃ§Ã£o comercial'1","type":"main","index":0}]]},"Busca histÃ³rico de conversa":{"main":[[{"node":"Formata histÃ³rico","type":"main","index":0}]]},"DeepSeek Chat Model":{"ai_languageModel":[[{"node":"Gera resumo da conversa - AI","type":"ai_languageModel","index":0}]]},"Gera resumo da conversa - AI":{"main":[[{"node":"Salva nota na conversa","type":"main","index":0}]]},"Formata histÃ³rico":{"main":[[{"node":"Gera resumo da conversa - AI","type":"main","index":0}]]},"Transfere ticket para Aguardando Apre.Chat1":{"main":[[{"node":"Busca histÃ³rico de conversa","type":"main","index":0}]]},"Se jÃ¡ existe follow-up1":{"main":[[{"node":"Atualiza follow-up2","type":"main","index":0}],[{"node":"Insere novo follow-up2","type":"main","index":0}]]},"Busca Follow Up2":{"main":[[{"node":"Se jÃ¡ existe follow-up1","type":"main","index":0}]]},"Busca estado atual para follow-up1":{"main":[[{"node":"Busca Follow Up2","type":"main","index":0}]]},"Planner de ConteÃºdo (LÃ³gico)":{"main":[[{"node":"Redator de Persona","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Planner de ConteÃºdo (LÃ³gico)","type":"ai_languageModel","index":0},{"node":"Redator de Persona","type":"ai_languageModel","index":0}]]},"Base de conhecimento1":{"ai_tool":[[{"node":"Planner de ConteÃºdo (LÃ³gico)","type":"ai_tool","index":0}]]},"Embeddings OpenAI3":{"ai_embedding":[[{"node":"Base de conhecimento1","type":"ai_embedding","index":0}]]},"output":{"main":[[{"node":"Parser  Chain","type":"main","index":0}]]},"Redator de Persona":{"main":[[{"node":"output","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Cron 1em1 min":{"recurrenceRules":[]},"node:Cron 1em1 min - FOLLOW-UP":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Cron 1em1 min - FOLLOW-UP":[{"json":{"timestamp":"2026-02-04T13:31:09.005-03:00","Readable date":"February 4th 2026, 1:31:09 pm","Readable time":"1:31:09 pm","Day of week":"Wednesday","Year":"2026","Month":"February","Day of month":"04","Hour":"13","Minute":"31","Second":"09","Timezone":"America/Sao_Paulo (UTC-03:00)"}}],"Webhook":[{"json":{"headers":{"host":"n8n.apresenta.me","x-real-ip":"172.68.191.166","x-real-port":"17656","x-forwarded-for":"177.136.163.95, 172.68.191.166","x-forwarded-proto":"http","x-forwarded-host":"n8n.apresenta.me","x-forwarded-port":"80","remote-host":"172.68.191.166","connection":"close","content-length":"719","accept":"application/json, text/plain, */*","accept-encoding":"gzip, br","user-agent":"axios/1.12.2","cf-ray":"9c8d039e384b9da8-NVT","content-type":"application/json","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"177.136.163.95","cf-ipcountry":"BR","cf-visitor":"{\"scheme\":\"https\"}"},"params":{},"query":{},"body":{"message":"Vcs tem teste grÃ¡tis ?","messageId":"2587546","contact":{"id":"38043","name":"554788950332","number":"554788950332","profilePicUrl":"https://pps.whatsapp.net/v/t61.24694-24/425105449_1361615211300388_1143514098522857072_n.jpg?ccb=11-4&oh=01_Q5Aa3gHE3OJ4C5UmLC0u7DfwPlVOtWHA1d7S7vF3I_nIQYqeKg&oe=6990D023&_nc_sid=5e03e0&_nc_cat=102","createdAt":"2025-10-09T16:20:11.311-03:00","updatedAt":"2026-02-04T17:45:51.994-03:00","email":"","isGroup":false,"companyId":"5005","whatsappId":"4","onlyResponsible":false,"userId":"1","aprePersonId":"4916708","apreDealId":null,"blocked":false,"meta":{"ignoreCheck":true,"ignorePermission":true,"dontSendSocket":false}},"whatsappId":"4","companyId":5005,"ticketId":88005},"webhookUrl":"https://n8n.apresenta.me/webhook/7223c6af-f595-4bc2-b84c-602b8900cd08","executionMode":"production"}}]},"versionId":"065124d6-cc94-4ace-80f3-3f205ef0f0c9","triggerCount":2,"shared":[{"updatedAt":"2025-11-04T18:47:16.654Z","createdAt":"2025-11-04T18:47:16.654Z","role":"workflow:owner","workflowId":"dDaZdsSmHxktrhjc","projectId":"4ToGMYJEWvvDSbcz"}],"tags":[]}