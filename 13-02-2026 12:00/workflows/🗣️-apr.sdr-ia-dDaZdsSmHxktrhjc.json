{"updatedAt":"2026-02-13T14:23:31.000Z","createdAt":"2025-11-04T18:47:16.651Z","id":"dDaZdsSmHxktrhjc","name":"ðŸ—£ï¸ Apr.SDR IA","active":true,"isArchived":false,"nodes":[{"parameters":{"jsCode":"return $('Parser  Chain1').first().json.output.messages.map(message => ({\n  json: { message }\n}))"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-32,736],"id":"4ce1a0fd-a14f-4336-926d-bd852f45941b","name":"Split de mensagens"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2dfab0a2-c614-429c-a13d-36ecb7803f12","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-320,752],"id":"52a8f1a7-c5c1-4c5b-aa63-cc6f4d821148","name":"Se nÃ£o recebeu mensagem no meio do processamento","alwaysOutputData":false},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-528,752],"id":"697a9015-bc65-48e9-85e7-2b6cd5d57290","name":"GET2","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","value":"={{ JSON.stringify({ \n  stage_id: $json.newStageId, \n  vars: $json.updatedVars, \n  missingVar: $json.missingVar, \n  afterRepliedInstruction: $json.missingVar.afterRepliedInstruction, \n  lastInstruction: $json.finalInstruction\n}) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4080,752],"id":"0fcaab6f-2a68-4927-86f8-84fdfa4202fc","name":"Salva Novo Estado","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"=Whatsapp message to be splitted and formated: {{ $json.output }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=# SYSTEM: Otimizador de Texto WhatsApp\nObjetivo: Dividir o texto de entrada em 1 a 4 balÃµes de leitura fluida para o WhatsApp.\n\n# REGRAS DE EXECUÃ‡ÃƒO (CRÃTICAS)\n1. FormataÃ§Ã£o de Markdown (ConversÃ£o):\n   - Converta **texto** â†’ *texto* (negrito padrÃ£o WhatsApp).\n   - Converta ~~texto~~ â†’ ~texto~ (tachado padrÃ£o WhatsApp).\n   - Converta __texto__ â†’ _texto_ (itÃ¡lico padrÃ£o WhatsApp).\n   - URLs: Devem ser isoladas em uma mensagem exclusiva e envoltas em crase: (`url`).\n   - PontuaÃ§Ã£o: Um split NUNCA deve terminar com vÃ­rgula. Se o corte ocorrer em uma vÃ­rgula, remova-a ou ajuste o texto para terminar em ponto, interrogaÃ§Ã£o ou exclamaÃ§Ã£o.\n\n2. SegmentaÃ§Ã£o de BalÃµes (Split):\n   - Tamanho: Alvo de ~150 caracteres por balÃ£o (MÃ¡ximo de 250).\n   - Corte: Ã‰ proibido quebrar frases ao meio. Utilize pontuaÃ§Ã£o (. ? !) como guia obrigatÃ³rio para a divisÃ£o.\n   - CoesÃ£o: Emojis devem ficar sempre colados Ã  palavra anterior, sem espaÃ§o.\n   - Contexto: Separe saudaÃ§Ãµes iniciais e perguntas finais em balÃµes prÃ³prios sempre que o tamanho permitir.\n\n3. RestriÃ§Ã£o de ConteÃºdo (Anti-Vazamento):\n   - Ã‰ terminantemente proibido incluir explicaÃ§Ãµes, metadados, definiÃ§Ãµes de JSON Schema ou qualquer texto tÃ©cnico sobre o funcionamento deste prompt no output.\n   - O conteÃºdo das mensagens deve ser exclusivamente a versÃ£o formatada e segmentada do texto original fornecido.\n\n# FORMATO DE SAÃDA (ESTRITO)\n- Retorne apenas o objeto JSON puro.\n- Proibido o uso de blocos de cÃ³digo markdown (como ```json).\n- Proibido qualquer texto fora das chaves do JSON.\n\n# ESTRUTURA REQUERIDA\n{\n  \"messages\": [\"msg1\", \"msg2\", \"msg3\"]\n}"}]}},"id":"a12ef693-b73f-4f20-9ae8-7d0a0c832737","name":"Parser  Chain1","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[-1152,752]},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}"},"id":"f89516e9-ef73-4405-9438-42fc591f9780","name":"OutputParser","type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[-976,928]},{"parameters":{"assignments":{"assignments":[{"id":"ae48936d-1ae8-440b-a604-2a6e4c4418f1","name":"output","value":"={{ $('Gerador de Resposta').item.json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1712,768],"id":"b56901ca-95b2-4556-8b1b-44b4445d3ff3","name":"output1"},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1792,864],"id":"5a64dbfb-1546-417a-8bc6-f4e23603dbfc","name":"WAIT_SPLIT1","webhookId":"3cea2837-6c05-4e79-8798-96260c4f8dc6"},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[384,736],"id":"7e4de75e-f33c-4e60-8e5e-5c4d568a0b93","name":"LOOP_SLIT1"},{"parameters":{"method":"POST","url":"={{ $env.APRECHAT_URL_API }}api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Configura Contexto').first().json.companyId }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $('LOOP_SLIT1').item.json.message }}"},{"name":"number","value":"={{ $('Configura Contexto').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('Configura Contexto').first().json.whatsappId }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1536,832],"id":"a29ee757-25de-49ec-ac6a-30dac3b1a649","name":"Envia WhatsApp1"},{"parameters":{"httpMethod":"POST","path":"7223c6af-f595-4bc2-b84c-602b8900cd08","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-9728,864],"id":"93c6170f-0ea4-42b8-a3ff-57f163806546","name":"Webhook","webhookId":"7223c6af-f595-4bc2-b84c-602b8900cd08"},{"parameters":{"jsCode":"return { \n  cache_key: `session_${$json.body.contact.number}_${$json.body.companyId}`,\n  companyId: $json.body.companyId,\n  whatsappId: $json.body.whatsappId,\n  user_msg: $json.body.message,\n  user_phone: $json.body.contact.number,\n  timestamp: new Date().getTime()\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-9504,864],"id":"72628082-945b-48bd-8087-a0aa46649eee","name":"Configura Contexto"},{"parameters":{"operation":"get","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5936,768],"id":"0e9eea20-3c5b-4187-a155-53e270e74014","name":"GET Estado Atual","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"// --- BLUEPRINT COMPLETO (Baseado na sua regra de negÃ³cio original) ---\nconst workflow = {\n  START: {\n    type: \"message\",\n    instruction:\n      \"Apresente-se como Alicia da Apresenta.me. Seja breve e pergunte como vocÃª pode chamar o lead.\",\n    next_stage: \"WAIT_NAME\",\n  },\n  WAIT_NAME: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"name\",\n        afterRepliedInstruction: \"Diga ao lead que Ã© um prazer conhecÃª-lo.\",\n        description: \"Nome do Lead\",\n      },\n    ],\n    next_stage: \"ASK_WANT_DATA_COLLECTION\",\n  },\n  ASK_WANT_DATA_COLLECTION: {\n    type: \"message\",\n    instruction:\n      'Pergunte ao Lead se ele aceita participar de uma coleta de dados, explicando um pouco sobre a apresenta.me antes (verifique no HISTÃ“RICO se ainda nÃ£o explicou sobre a apresenta.me): \"[NOME], sÃ³ pra te explicar um pouco mais sobre a Apresenta.me: nÃ³s centralizamos a operaÃ§Ã£o da imobiliÃ¡ria em um sÃ³ lugar, ajudando a organizar processos, ganhar eficiÃªncia e aumentar conversÃµes, com uma tecnologia simples e suporte humanizado. Se fizer sentido pra vocÃª, seguimos com alguns dados essenciais pra agendar a demonstraÃ§Ã£o, pode ser ?\"',\n    next_stage: \"WAIT_WANT_DATA_COLLECTION\",\n  },\n  WAIT_WANT_DATA_COLLECTION: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"wantDataCollection\",\n        description: \"Se o usuÃ¡rio QUER participar da COLETA DE DADOS.\",\n      },\n    ],\n    next_stage: \"ROUTER_DATA_COLLECTION\",\n  },\n  ROUTER_DATA_COLLECTION: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"wantDataCollection\",\n        value: false,\n        next_stage: \"SEND_COMMERCIAL_PRESENTATION\",\n      },\n      { default: \"ASK_ROLE\" },\n    ],\n  },\n  SEND_COMMERCIAL_PRESENTATION: {\n    type: \"message\",\n    instruction:\n      \"Responda para o Lead: [NOME DO LEAD], estou te enviando nossa apresentaÃ§Ã£o comercial! Caso vocÃª mude de ideia e queira nos conhecer melhor, Ã© sÃ³ avisar. AtÃ© mais!\",\n    next_stage: \"STOP\",\n  },\n  ASK_ROLE: {\n    type: \"message\",\n    instruction: \"Pergunte qual o cargo ou funÃ§Ã£o dele na imobiliÃ¡ria.\",\n    next_stage: \"WAIT_ROLE\",\n  },\n  WAIT_ROLE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"role\",\n        description:\n          'Cargo ou funÃ§Ã£o na imobiliÃ¡ria. NÃƒO MOSTRAR EXEMPLOS PARA O USUÃRIO. A RESPOSTA SEMPRE DEVE AUTOMATICAMENTE ATRIBUIR VALOR PARA \"isAutonomous\". Considere \"isAutonomous\" com false apenas quando o usuÃ¡rio INDICAR que trabalha sozinho, ou falar de forma explicita que Ã© autÃ´nomo.',\n      },\n      {\n        name: \"isAutonomous\",\n        description:\n          \"(CAMPO LÃ“GICO): Defina AUTOMATICAMENTE TRUE se o usuÃ¡rio trabalha sozinho/autÃ´nomo (isso deve ser indicado pelo LEAD). Defina FALSE se for imobiliÃ¡ria/equipe/sÃ³cio/dono/auxiliar etc.\",\n        type: \"boolean\",\n      },\n    ],\n    next_stage: \"ROUTER_PROFILE\",\n  },\n  // --- DECISÃƒO: AUTÃ”NOMO VS IMOBILIÃRIA ---\n  ROUTER_PROFILE: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"isAutonomous\",\n        value: true,\n        next_stage: \"ASK_RENTAL_STATUS\",\n      }, // AutÃ´nomo pula tamanho do time\n      { default: \"ASK_TEAM_SIZE\" },\n    ],\n  },\n  ASK_TEAM_SIZE: {\n    type: \"message\",\n    instruction: \"Pergunte quantas pessoas trabalham na imobiliÃ¡ria hoje.\",\n    next_stage: \"WAIT_TEAM_SIZE\",\n  },\n  WAIT_TEAM_SIZE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"teamSize\",\n        description: \"Tamanho total da equipe (sÃ³cios + corretores)\",\n      },\n    ],\n    next_stage: \"ASK_RENTAL_STATUS\",\n  },\n  ASK_RENTAL_STATUS: {\n    type: \"message\",\n    instruction:\n      'Pergunte se eles jÃ¡ trabalham com locaÃ§Ãµes ou estÃ£o estruturando agora. Ex: \"[NOME DO LEAD], e hoje, vocÃªs jÃ¡ trabalham com locaÃ§Ãµes ou estÃ£o comeÃ§ando a estruturar ?\"',\n    next_stage: \"WAIT_RENTAL_STATUS\",\n  },\n  WAIT_RENTAL_STATUS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"rentalStatus\",\n        afterRepliedInstruction: `Se o usuÃ¡rio disser que Ã© focado em vendas, sem indicar que trabalha com locaÃ§Ãµes, personalize a resposta: \"Entendi, [NOME DO LEAD]. Como vocÃªs sÃ£o focados em venda, Ã© necessÃ¡rio ter um bom sistema de fÃºnil, para follow-up e um bom CRM pra manter o histÃ³rico dos Leads, isso tudo a Apresenta.me te entrega!! Mas vocÃªs trabalham com locaÃ§Ãµes tambÃ©m, ou somente vendas?\". Se o usuÃ¡rio disser que trabalha com locaÃ§Ãµes, personalize a resposta : \"Bacana, [NOME DO LEAD], pra trabalhar com locaÃ§Ãµes, tem que ter um bom sistema. Quando me refiro Ã  um \"bom sistema\", digo um sistema que trabalhe pra vocÃªs, e nÃ£o que faÃ§a vocÃªs trabalharem mais. E isso Ã© o que o nosso sistema melhor oferece, automaÃ§Ã£o de processos, alÃ©m de ser um sistema completo que agrupa tudo em um lugar sÃ³.\". Se o usuÃ¡rio disser que sÃ³ trabalha com vendas, personalize a resposta: \\\"Entendi, [NOME DO LEAD]. Como vocÃªs sÃ£o focados em venda, Ã© necessÃ¡rio ter um bom sistema de fÃºnil, para follow-up e um bom CRM pra manter o histÃ³rico dos Leads, isso tudo a Apresenta.me te entrega!!\\\"\"`,\n        description:\n          \"Momento atual da imobiliÃ¡ria em relaÃ§Ã£o a locaÃ§Ã£o (jÃ¡ trabalham, estÃ£o comeÃ§ando a estruturar, ou nÃ£o trabalham). NÃƒO MOSTRE NENHUMA OPÃ‡ÃƒO PARA O USUÃRIO, DEIXE ELE RESPONDER LIVREMENTE. (Preencha com as opÃ§Ãµes: active = se jÃ¡ trabalha / starting = se comeÃ§ando / none = se nÃ£o trabalha ou se trabalha somente com vendas). Se ele jÃ¡ trabalha com locaÃ§Ãµes, defina o valor de \\\"interestFocus\\\" como 'all'\",\n      },\n    ],\n    next_stage: \"ASK_PORTFOLIO_SIZE\",\n  },\n  ASK_PORTFOLIO_SIZE: {\n    type: \"message\",\n    instruction:\n      \"Pergunte a quantidade total de imÃ³veis que o Lead/imobiliÃ¡ria tem na carteira, contando venda e locaÃ§Ã£o. Se o lead trabalhar somenta com vendas, nÃ£o cite locaÃ§Ã£o, e vice-versa.\",\n    next_stage: \"WAIT_PORTFOLIO_SIZE\",\n  },\n  WAIT_PORTFOLIO_SIZE: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"portfolioSize\",\n        afterRepliedInstruction: `Se o usuÃ¡rio informar o tamanho do portifÃ³lio, entenda o contexto do LEAD, faÃ§a um comentÃ¡rio sobre o tamanho do portifÃ³lio, exemplo (adapte e humanize): \"Entendi, [NOME DO LEAD]. com essa carteira jÃ¡ Ã© preciso ter uma boa organizaÃ§Ã£o.\"`,\n        description:\n          \"Quantidade total de imÃ³veis na carteira (venda + locaÃ§Ã£o). Se o lead trabalhar APENAS com vendas, nÃ£o cite locaÃ§Ã£o, e vice-versa. AtenÃ§Ã£o: muitas vezes o usuÃ¡rio vai dizer que trabalha com locaÃ§Ãµes mas Ã© focado em vendas, e vice-versa. Nesses casos, pergunte o total de imÃ³veis considerando vendas + locaÃ§Ã£o.\",\n      },\n    ],\n    next_stage: \"ASK_INTEREST_FOCUS\"\n  },\n  ASK_INTEREST_FOCUS: {\n    type: \"message\",\n    instruction:\n      'Informe que a Apresenta.me entrega um sistema completo, com site, crm e gestÃ£o financeira e pergunte ao usuÃ¡rio quais dessas opÃ§Ãµes ele precisa, em especÃ­fico. Ex: \"[NOME DO LEAD], hoje a gente entrega um sistema completo, com site, crm e gestÃ£o fincanceira, quais desses mÃ³dulos fazem sentido pra vocÃª?\"',\n    next_stage: \"WAIT_INTEREST_FOCUS\",\n  },\n  WAIT_INTEREST_FOCUS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"interestFocus\",\n        description:\n          \"Quais mÃ³dulos do sistema o usuÃ¡rio estÃ¡ interessado: Site + CRM, GestÃ£o financeira ou todos.\",\n        afterRepliedInstruction:\n          'Se o usuÃ¡rio estiver insistindo em uma opÃ§Ã£o invÃ¡lida, responda-o que nÃ£o vendemos a opÃ§Ã£o avulsa. Ex: \"[NOME DO LEAD], que pena! Infelizmente a gente nÃ£o vende nenhum mÃ³dulo avulso...\". Se o usuÃ¡rio quiser sÃ³ site: responda-o que nÃ£o vendemos site avulso. Ex: \"Entendo, [NOME DO LEAD]! O site Ã© justamente a porta de entrada pra divulgar seus imÃ³veis. Aqui ele jÃ¡ vem integrado ao CRM, o que ajuda vocÃª a receber os leads e acompanhar as vendas sem perder contato. Faz sentido pra vocÃª CRM e site integrados?\". Se o usuÃ¡rio quiser somente CRM: responda-o que na contrataÃ§Ã£o do CRM o site jÃ¡ vem integrado e que nÃ£o vendemos o CRM separado. Ex: \"Legal, [NOME DO LEAD]! Na contrataÃ§Ã£o do CRM, o site jÃ¡ vem integrado, mas nÃ£o Ã© possÃ­vel contratar CRM avulso. Faz sentido pra vocÃª CRM e site integrados?\". Se o usuÃ¡rio estÃ¡ insistindo na mesma opÃ§Ã£o invÃ¡lida (Ã© no mÃ­nimo a segunda fez que ele afirma que quer a mesma opÃ§Ã£o inexistente), ignore essa instruÃ§Ã£o. Se o usuÃ¡rio forneceu uma opÃ§Ã£o/resposta vÃ¡lida: \"Show de bola [NOME DO LEAD], pode ter certeza que vamos conseguir te entregar bons resultados com [OPÃ‡ÃƒO QUE O LEAD ESCOLHEU (Site + CRM ou Sistema completo/todos os mÃ³dulos)].\"',\n        options: {\n          site_crm:\n            \"Se o usuÃ¡rio quiser site + CRM. NÃ£o selecione essa opÃ§Ã£o se ele apenas disser que quer site ou se ele apenas disser que quer CRM.\",\n          all: \"Se o usuÃ¡rio jÃ¡ trabalhar com locaÃ§Ã£o, selecione obrigatoriamente essa opÃ§Ã£o. ou se ele dizer que quer site + crm + gestÃ£o financeira ou explicitamente TODOS.\",\n          invalid_option:\n            \"Se o usuÃ¡rio precisar de uma opÃ§Ã£o inexistente (ex: SÃ³ site, sÃ³ CRM, sÃ³ gestÃ£o financeira). Ou se ele falar que precisa de site, mas nÃ£o citar que precisa de crm. Ou se ele falar que precisa de CRM, mas nÃ£o citar que precisa de site.\",\n        },\n      },\n    ],\n    next_stage: \"ROUTER_INVALID_INTEREST_FOCUS\",\n  },\n  ROUTER_INVALID_INTEREST_FOCUS: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"interestFocus\",\n        value: \"invalid_option\",\n        next_stage: \"ASK_INTEREST_FOCUS_2\",\n      },\n      { default: \"ASK_CURRENT_SYSTEM\" },\n    ],\n  },\n  ASK_INTEREST_FOCUS_2: {\n    type: \"message\",\n    instruction:\n      'Se o usuÃ¡rio quiser sÃ³ site: responda-o que nÃ£o vendemos site avulso. Ex: \"Entendo, [NOME DO LEAD]! O site Ã© justamente a porta de entrada pra divulgar seus imÃ³veis. Aqui ele jÃ¡ vem integrado ao CRM, o que ajuda vocÃª a receber os leads e acompanhar as vendas sem perder contato. Faz sentido pra vocÃª CRM e site integrados?\". Se o usuÃ¡rio quiser somente CRM: responda-o que na contrataÃ§Ã£o do CRM o site jÃ¡ vem integrado e que nÃ£o vendemos o CRM separado. Ex: \"Legal, [NOME DO LEAD]! Na contrataÃ§Ã£o do CRM, o site jÃ¡ vem integrado, mas nÃ£o Ã© possÃ­vel contratar CRM avulso. Faz sentido pra vocÃª CRM e site integrados?\"',\n    next_stage: \"ROUTER_INVALID_INTEREST_FOCUS_2\",\n  },\n  ROUTER_INVALID_INTEREST_FOCUS_2: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"interestFocus\",\n        value: \"invalid_option\",\n        next_stage: \"CLOSING_WHEN_INVALID_OPTION\",\n      },\n      { default: \"ASK_CURRENT_SYSTEM\" },\n    ],\n  },\n  ASK_PAIN_POINT: {\n    type: \"message\",\n    instruction:\n      'Se o lead nÃ£o tem utiliza nenhum sistema: cite o cenÃ¡rio do lead e pergunte qual a PRINCIPAL DOR do lead.\\n Ex: (Adapte esse exemplo para o cenÃ¡rio do lead): \"[NOME DO LEAD], com x colaboradores, x imÃ³veis na carteira, trabalhando com vendas e locaÃ§Ãµes, o que vocÃª apontaria como o maior problema ou dor de vocÃªs aÃ­ na [NOME DA IMOBILIÃRIA (se cidado), ou NA IMOBILIÃRIA]? Seja na gestÃ£o financeira, automaÃ§Ã£o de processos, vendas, etc.\". Se o usuÃ¡rio jÃ¡ utiliza algum sistema ou CRM imobiliÃ¡rio: valide e pergunte quais sÃ£o os problemas existentes no sistema atual. Ex: \"Certo, [NOME DO LEAD]. O que hoje no sistema que vocÃªs usam acaba nÃ£o acompanhando o crescimento ou a rotina de vocÃªs?\"',\n    next_stage: \"WAIT_PAIN_POINT\",\n  },\n  WAIT_PAIN_POINT: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"mainPainPoint\",\n        afterRepliedInstruction:\n          \"Valide a dor do cliente do cliente de forma humana. Pegue o problema do Lead e procure por funcionalidades na base de conhecimento que resolvam o problema do lead e forme um texto breve e de fÃ¡cil leitura com as funcionalidades/soluÃ§Ãµes existentes e explique para o Lead como a Apresenta.me pode solucionar seus problemas.\",\n        description: \"Principal dor, problema ou gargalo citado pelo lead\",\n      },\n    ],\n    next_stage: \"ROUTER_LOCACAO\",\n  },\n  ASK_CURRENT_SYSTEM: {\n    type: \"message\",\n    instruction:\n      'Pergunte se jÃ¡ utilizam algum sistema ou CRM imobiliÃ¡rio hoje, e qual. Se no meio da conversa o usuÃ¡rio indicar que nÃ£o tem um CRM, pergunte SOMENTE se ele jÃ¡ utiliza algum Sistema ImobiliÃ¡rio. Ex: \"[NOME DO LEAD], pra eu me contextualizar melhor, vocÃªs jÃ¡ estÃ£o utilizando algum sistema imobiliÃ¡rio ou CRM pra melhorar o processo de vocÃªs? Se sim, qual ?\" ',\n    next_stage: \"WAIT_CURRENT_SYSTEM\",\n  },\n  WAIT_CURRENT_SYSTEM: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"currentSystem\",\n        afterRepliedInstruction:\n          'Se o lead jÃ¡ utiliza algum sistema ou CRM imobiliÃ¡rio: pergunte quais sÃ£o os problemas existentes no sistema atual. Ex: \"Legal, [NOME DO LEAD]. O que hoje no sistema que vocÃªs usam acaba nÃ£o acompanhando o crescimento ou a rotina de vocÃªs?\". Se o lead nÃ£o utiliza nenhum sistema ou CRM imobiliÃ¡rio, valide a dor do lead, entendendo que processos manuais os tomam muito tempo e que a Apresenta.me consegue automatizar diversos processos, facilitando a vida da imobiliÃ¡ria, se necessÃ¡rio.',\n        description: \"Nome do sistema imobiliÃ¡rio que o lead estÃ¡ usando atualmente (ex: Kenlo, Jetimob, Planilhas)\",\n      },\n    ],\n    next_stage: \"ASK_PAIN_POINT\",\n  },\n  // --- DECISÃƒO: APROFUNDAR LOCAÃ‡ÃƒO? ---\n  ROUTER_LOCACAO: {\n    type: \"router\",\n    rules: [\n      // Se jÃ¡ tem locaÃ§Ã£o ativa ('active'), pergunta detalhes tÃ©cnicos\n      {\n        variable: \"rentalStatus\",\n        value: \"active\",\n        next_stage: \"ASK_CONTRACT_DETAILS\",\n      },\n      // Se nÃ£o tem ou estÃ¡ comeÃ§ando, vai direto pro orÃ§amento\n      { default: \"ASK_PLAN\" },\n    ],\n  },\n  ASK_CONTRACT_DETAILS: {\n    type: \"message\",\n    instruction:\n      'Pergunte quantos contratos ativos administram e como fazem o repasse dos valores dos aluguÃ©is para proprietÃ¡rios e corretores hoje. Ex: \"Pra gente entender mehor, qual Ã© o nÃºmero de contratos ativos pra locaÃ§Ã£o que vocÃªs possuem? E hoje, como fazem os repasses para os proprietÃ¡rios e corretores ?\"',\n    next_stage: \"WAIT_CONTRACT_DETAILS\",\n  },\n  WAIT_CONTRACT_DETAILS: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"numberOfContracts\",\n        afterRepliedInstruction:\n          \"Baseando-se no cenÃ¡rio que o LEAD jÃ¡ informou ao longo da conversa:\\n Se anteriormente ele disse que utilizam sistemas genÃ©ricos (como planilhas) ou que nÃ£o usam nenhum sistema imobiliÃ¡rio e se tiver um nÃºmero consideravelmente alto de contratos: mencione para o lead que com a quantidade de contratos mencionado pelo lead, deve ser um desafio fazer o gerenciamento sem um sistema imobiliÃ¡rio; Se tiver um numero de contratos considerÃ¡velmente alto e jÃ¡ utilizar algum sistema imobiliÃ¡rio: validar de forma simples e natural, sem elogiar ou desdenhar; Se o usuÃ¡rio informou tambÃ©m o mÃ©todo de repasse: adicione uma validaÃ§Ã£o final para o repasse: Se o lead indicar que Ã© manual/banco: Cite o cenÃ¡rio dele, e diga que no cenÃ¡rio que o lead informou, fazer repasse manual em 2026 Ã© inaceitÃ¡vel e informe que a Apesenta.me dispÃµe de funcionalidades que automatizam esse processo; Se ele indicar que o repasse jÃ¡ Ã© feito de forma automÃ¡tica de enfase ao nosso produto/funcionalidade: valide a fala do Lead e diga que aqui na Apresenta.me entregamos a funcionalidade de repasse automÃ¡tico tambÃ©m e que tem ajudado muito nossos clientes.\",\n        description: \"Quantidade de contratos de locaÃ§Ã£o ativos\",\n      },\n      {\n        name: \"transferMode\",\n        afterRepliedInstruction:\n          \"Se o lead indicar que Ã© manual/banco: Fale sobre o cenÃ¡rio do lead, e diga que no cenÃ¡rio que o lead informou, fazer repasse manual em 2026 Ã© inaceitÃ¡vel e informe que a Apesenta.me dispÃµe de funcionalidades que automatizam esse processo. Se ele indicar que o repasse jÃ¡ Ã© feito de forma automÃ¡tica, de enfase ao nosso produto/funcionalidade: valide a fala do Lead e diga que aqui na Apresenta.me entregamos a funcionalidade de repasse automÃ¡tico tambÃ©m e que tem ajudado bastante nossos clientes.\",\n        description:\n          \"MÃ©todo de repasse (Ex: Manual, Banco, Split etc.). NUNCA MOSTRE EXEMPLOS PARA O USUARIO E DEIXE ELE RESPONDER LIVREMENTE.\",\n      },\n    ],\n    next_stage: \"ASK_PLAN\",\n  },\n  ASK_PLAN: {\n    type: \"message\",\n    instruction: `\nAgora que vocÃª jÃ¡ entende o cenÃ¡rio do lead, pense lÃ³gicamente, com base nas informaÃ§Ãµes que ele passou, qual dos planos abaixo se enquadra melhor no cenÃ¡rio dele:    \n- **Start IMOB (R$ 449,99/mÃªs):** 2 usuÃ¡rios, 300 imÃ³veis, 500 negÃ³cios. Inclui Site e WhatsApp -> REMOVA ESSA OPÃ‡ÃƒO SE O USUÃRIO JÃ TRABALHA COM LOCAÃ‡ÃƒO (rentalStatus = active/starting).\n- **Basic IMOB (R$ 699,99/mÃªs):** 5 usuÃ¡rios, 1000 imÃ³veis, 2000 negÃ³cios. Inclui 50 contratos e gestÃ£o financeira.\n- **Big IMOB (R$ 999,99/mÃªs):** 12 usuÃ¡rios, imÃ³veis ilimitados, 5000 negÃ³cios. Inclui 150 contratos e geraÃ§Ã£o automÃ¡tica de boletos.\n- **Super IMOB (Especialista):** Acima de 25 usuÃ¡rios ou 300 contratos. GestÃ£o completa de comissÃµes.\nApÃ³s vocÃª selecionar um desses planos, como resposta: cite o cenÃ¡rio do Lead, informe o porquÃª o plano selecionado faz sentido para o lead e informe o plano selecionado.\nOBS: NÃƒO ENVIE TODOS OS PLANOS PARA O LEAD, SELECIONE APENAS UM PLANO QUE SE ENCAIXA MELHOR NO CENÃRIO/CONTEXTO ATUAL DA IMOBILIÃRIA ATUALMENTE.\n`,\n    next_stage: \"WAIT_PLAN\",\n  },\n  WAIT_PLAN: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"selectedPlanWasAccepted\",\n        afterRepliedInstruction:\n          \"Se o lead informar que precisa AUMENTAR o nÃºmero de usuÃ¡rios, contratos, imÃ³veis, negÃ³cios, etc: informe que o plano pode ser personalizado de acordo com o que ele precisa, e que o Plano Selecionado Ã© apenas um plano base. PorÃ©m, apenas um especialista pode personalizar o plano do lead; Se o lead informar que precisa DIMINUIR o nÃºmero de usuÃ¡rios, contratos, imÃ³veis, negÃ³cios, etc: informe que um especialista vai tentar entender melhor as necessidades do Lead e selecionar um plano mais adequado.\",\n        description:\n          \"Se o plano selecionado jÃ¡ foi apresentado um plano com base no cenÃ¡rio do lead e ele disse que o plano faz sentido pra ele, que estÃ¡ dentro do que planejam investir. Se o plano selecionado ainda nÃ£o foi apresentado para o lead: NÃƒO PREENCHA esta variÃ¡vel. Se for atribuido qualquer valor para whyDidntAcceptedThePlan, atribua FALSE para esta variÃ¡vel\",\n      },\n    ],\n    next_stage: \"ROUTER_PLAN_ACCEPTED\",\n  },\n  ROUTER_PLAN_ACCEPTED: {\n    type: \"router\",\n    rules: [\n      {\n        variable: \"selectedPlanWasAccepted\",\n        value: false,\n        next_stage: \"ASK_WHY_DIDNT_ACCEPTED_THE_PLAN\",\n      },\n      { default: \"CLOSING\" },\n    ],\n  },\n  ASK_WHY_DIDNT_ACCEPTED_THE_PLAN: {\n    type: \"message\",\n    instruction:\n      'Se o lead nÃ£o informou o motivo pelo qual o plano nÃ£o faz sentido para ele, pergunte de forma objetiva o motivo. Ex: \"Entendi, [NOME DO LEAD], vocÃª poderia me contar por qual motivo o [PLANO SELECIONADO] nÃ£o faz sentido pra vocÃª?\"',\n    next_stage: \"WAIT_WHY_DIDNT_ACCEPTED_THE_PLAN\",\n  },\n  WAIT_WHY_DIDNT_ACCEPTED_THE_PLAN: {\n    type: \"input\",\n    variables: [\n      {\n        name: \"whyDidntAcceptedThePlan\",\n        afterRepliedInstruction:\n          \"Se ele informou que precisa de uma funcionalidade que nÃ£o temos, procure na base de conhecimento pela funcionalidade e se esta existir, informe ao cliente que possuÃ­mos, se nenhuma funcionalidade que o lead precisa existe na base de conhecimento, entÃ£o informe que iremos encaminhar o caso do lead para um especialista. Se o cliente reclamou do valor, informe que iremos encaminhar para um especialista cuidar desse caso especÃ­fico. Se ele informar que precisa de mais usuÃ¡rios, mais contratos, mais imÃ³veis ou qualquer outro item existente no plano, informe que trabalhamos que podemos personalizar os planos, mas que um especialista precisa fazer essa personalizaÃ§Ã£o para o Lead.\",\n        description:\n          \"Motivo pelo qual o plano nÃ£o foi aceito pelo usuÃ¡rio. Se o usuÃ¡rio disse o motivo pelo qual nÃ£o aceita o plano, altere selectedPlanWasAccepted\",\n      },\n    ],\n    next_stage: \"CLOSING\",\n  },\n  CLOSING: {\n    type: \"message\",\n    instruction:\n      'AgradeÃ§a de forma cordial, se despeÃ§a e diga que foi um prazer conhecer o lead, citando o nome dele. Diga que coletou todos os dados necessÃ¡rios e informe que um especialista entrarÃ¡ em contato para agendar uma apresentaÃ§Ã£o. Ex: \"[NOME DO LEAD], coletei todos os dados necessÃ¡rios aqui e vou prosseguir com o agendamento de uma demonstraÃ§Ã£o te encaminhando pra um especialista. Foi um prazer te conhecer, atÃ© mais!\"',\n    next_stage: \"STOP\",\n  },\n  CLOSING_WHEN_INVALID_OPTION: {\n    type: \"message\",\n    instruction:\n      \"AgradeÃ§a de forma cordial e simpÃ¡tica, diga que irÃ¡ encaminhar o atendimento para um especialista que poderÃ¡ cuidar do caso especÃ­fico do lead e se despeÃ§a dizendo que foi um prazer conhecÃª-lo.\",\n    next_stage: \"STOP\",\n  },\n};\n\nconst redisData = $(\"GET Estado Atual\").item.json.propertyName\n  ? JSON.parse($(\"GET Estado Atual\").item.json.propertyName)\n  : {};\nconst currentStageId = redisData.stage_id || \"START\";\nconst vars = redisData.vars || {};\nconst stageConfig = workflow[currentStageId] || workflow[\"START\"];\n\n// --- VARREDURA GLOBAL DE VARIÃVEIS ---\nlet missingVars = [];\nfor (const key in workflow) {\n  const step = workflow[key];\n  if (step.type === \"input\" && step.variables) {\n    step.variables.forEach((v) => {\n      if (!vars[v.name] || vars[v.name].value === null || vars[v.name].value === 'invalid_option' || vars[v.name].value === 'not_provided' || vars[v.name].value === 'answer_later') {\n        missingVars.push({\n          name: v.name,\n          description: v.description,\n          options: v.options || null,\n        });\n      }\n    });\n  }\n}\n\nreturn {\n  workflow,\n  currentStageId,\n  stageConfig,\n  vars,\n  missingVars,\n  userMsg: $(\"CONCATENA1\").item.json.user_full_message,\n  missingVar: JSON.parse($input.first().json.propertyName)?.missingVar,\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5712,768],"id":"98cfc05a-d3fa-487e-9e32-776bfb8b94f9","name":"BLUEPRINT ENGINE"},{"parameters":{"jsCode":"const inputData = $input.all()[0].json;\nconst workflow = $('BLUEPRINT ENGINE').first().json.workflow;\nlet currentStageId = $('BLUEPRINT ENGINE').first().json.currentStageId;\nlet vars = $('BLUEPRINT ENGINE').first().json.vars;\nlet stageConfig = $('BLUEPRINT ENGINE').first().json.stageConfig;\nconst lastInstruction = JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').lastInstruction\nconst lastMissingVar = JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar \nlet outputInstruction = \"\";\nlet missingVar = \"\";\nlet immediatelyNextStage = \"\";\n\n// --- 1. ATUALIZAÃ‡ÃƒO GLOBAL (Check-in) ---\nconst extractedObj = inputData.output || {};\nfor (const [key, value] of Object.entries(extractedObj)) {\n    // SÃ³ atualiza se tiver valor real\n    if (value !== null && value !== undefined && value !== \"\") {\n        vars[key] = { value: value, type: 'extracted' };\n    }\n}\n\n// Helper: Verifica se TODAS as variÃ¡veis do estÃ¡gio estÃ£o preenchidas\nfunction isInputSatisfied(stage) {\n    if (!stage || stage.type !== 'input') return false;\n    // Retorna true apenas se TODAS as variÃ¡veis listadas existirem em 'vars'\n    return stage.variables.every(v => vars[v.name] && vars[v.name].value !== null && vars[v.name].value !== \"\");\n}\n\n\n// --- 2. LOOP DE AVANÃ‡O (Auto-Skip & Look Ahead) ---\nlet safetyLoop = 0;\nlet advancing = true;\n\nwhile (advancing && safetyLoop < 50) {\n    stageConfig = workflow[currentStageId];\n    if (!stageConfig) break;\n\n    if (stageConfig.immediately_next_stage) {\n      immediatelyNextStage = stageConfig.immediately_next_stage\n    }\n\n    advancing = false; // Por padrÃ£o, o loop para aqui, a menos que encontre motivo para seguir\n\n    // ======================================================\n    // CASO 1: INPUT (Esperando dados do usuÃ¡rio)\n    // ======================================================\n    if (stageConfig.type === 'input') {\n        if (isInputSatisfied(stageConfig)) {\n            // Temos tudo! Pula para o prÃ³ximo estÃ¡gio.\n            currentStageId = stageConfig.next_stage;\n            advancing = true; \n        } else {\n            // [CORREÃ‡ÃƒO AQUI] Falta resposta. NÃ£o podemos deixar a instruÃ§Ã£o vazia.\n            // Descobre qual variÃ¡vel estÃ¡ faltando para orientar a IA\n            missingVar = stageConfig.variables.find(v => !vars[v.name] || !vars[v.name].value);\n            \n            if (missingVar) {\n                // Se o usuÃ¡rio falou algo nada a ver (extraÃ§Ã£o rodou mas nÃ£o pegou o dado)\n                if (Object.keys(extractedObj).length > 0 && !Object.values(extractedObj).find(v => v)) {\n                     outputInstruction = `O usuÃ¡rio respondeu algo, mas nÃ£o entendi o(a) ${missingVar.description}. Pergunte novamente de forma clara.`;\n                } else {\n                    if (lastMissingVar && !vars[lastMissingVar.name]?.value) {\n                      outputInstruction = lastInstruction\n                    } else {\n                      outputInstruction = `Pergunte: ${missingVar.description}`; \n                    }\n                }\n            }\n            // Mantemos advancing = false para PARAR aqui e esperar o user responder\n        }\n    }\n\n    // ======================================================\n    // CASO 2: MENSAGEM (O robÃ´ fala)\n    // ======================================================\n    else if (stageConfig.type === 'message') {\n        // [LOOK AHEAD]\n        // Verifica se a mensagem serve para pedir um dado que JÃ TEMOS.\n        const nextStage = workflow[stageConfig.next_stage];\n        \n        // Se o prÃ³ximo passo Ã© input E jÃ¡ estÃ¡ preenchido -> Pula a mensagem atual\n        if (nextStage && nextStage.type === 'input' && isInputSatisfied(nextStage)) {\n            currentStageId = nextStage.next_stage;\n            advancing = true; \n        } else {\n            // Mensagem necessÃ¡ria. Define instruÃ§Ã£o.\n            outputInstruction = stageConfig.instruction;\n            \n            // JÃ¡ aponta o ponteiro para o prÃ³ximo estÃ¡gio (onde vamos esperar o input)\n            if (stageConfig.next_stage !== 'STOP') {\n                currentStageId = stageConfig.next_stage;\n                const nextStage = workflow[currentStageId]   \n\n                if (nextStage.type == 'input') {\n                  missingVar = nextStage.variables.find(v => !vars[v.name] || !vars[v.name].value);\n                }\n              \n            }\n            // Para o loop para a IA falar.\n            advancing = false; \n        }\n    }\n\n    // ======================================================\n    // CASO 3: ROUTER (LÃ³gica condicional)\n    // ======================================================\n    else if (stageConfig.type === 'router') {\n        let routeFound = false;\n        for (const rule of stageConfig.rules) {\n            if (rule.default) {\n                currentStageId = rule.default;\n                routeFound = true;\n                break;\n            }\n            // ValidaÃ§Ã£o simples de valor\n            if (vars[rule.variable] && vars[rule.variable].value === rule.value) {\n                currentStageId = rule.next_stage;\n                routeFound = true;\n                break;\n            }\n        }\n        // Se achou rota, continua avanÃ§ando no mesmo tick\n        if (routeFound) advancing = true; \n    }\n    \n    safetyLoop++;\n}\n\nreturn {\n    newStageId: currentStageId,\n    updatedVars: vars,\n    finalInstruction: outputInstruction,\n    missingVar, \n    immediatelyNextStage\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4304,752],"id":"2cb6799d-290a-473e-ae81-bea790fc1a8d","name":"LOGIC ENGINE"},{"parameters":{"promptType":"define","text":"=[MENSAGEM DO HUMANO]\n{{ $('CONCATENA1').first().json.user_full_message }}\n\n[INSTRUÃ‡ÃƒO DO FLUXO] (CRÃTICO - OBRIGATÃ“RIO)\n* **INSTRUÃ‡ÃƒO_A:** {{ $('LOGIC ENGINE').first().json.updatedVars[JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name].value && !['not_provided', 'answer_later'].includes($('LOGIC ENGINE').first().json.updatedVars[JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name].value)  ? JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').afterRepliedInstruction : null }}\n* **INSTRUÃ‡ÃƒO_B:** \"{{ $('LOGIC ENGINE').first().json.finalInstruction }}\"\n\n### [DADOS PARA PROCESSAMENTO]\n* **DADOS_COLETADOS:** {{ JSON.stringify($('LOGIC ENGINE').first().json.updatedVars) }}\n* **CONTEXTO_TÃ‰CNICO (RAG):** {{ $('MERGE DADOS').first().json.rag_context ? $('MERGE DADOS').first().json.rag_context.join('\\n\\n'): \"\" }}\n\n### [HISTÃ“RICO DE CONVERSA (DA MAIS ANTIGA PARA A MAIS RECENTE)]\n{{ $('Formata ultimas mensagens').first().json.historyMessages }}\n\n\n### [DATA/HORA ATUAL]\n{{ $now.toFormat('dd/MM/yyyy HH:mm') }}\nPOR EXTENSO: {{ $now.setLocale('pt-BR').toFormat(\"d 'de' MMMM 'de' yyyy\") }}","options":{"systemMessage":"=# PERFIL E IDENTIDADE\nAgente: {{ $('Seta perfil1').first().json.agentName }} | Empresa: {{ $('Seta perfil1').first().json.companyName }}\nDepto: {{ $('Seta perfil1').first().json.companyDepartment }}\nTom/Conduta: {{ $('Seta perfil1').first().json.tone }} | {{ $('Seta perfil1').first().json.conduct }}\n\n## DIRETRIZES DE SAÃDA (WHATSAPP)\n- Mensagem Ãºnica, fluida e humanizada.\n- Evite ao MÃXIMO usar o sinal de exclamaÃ§Ã£o (!).\n- Proibido mencionar que Ã© uma inteligÃªncia artificial.\n\n## LÃ“GICA DE EXECUÃ‡ÃƒO (ORDEM DE PENSAMENTO)\n\n1. FILTRO DE SUPORTE (CRÃTICO):\n   - Se o lead demonstrar ser CLIENTE (relatar erros, dÃºvidas de uso ou afirmar que jÃ¡ usa), interrompa a venda.\n   - Resposta: Informe que para suporte tÃ©cnico ele deve contatar: +55 (47) 8905-0935. Finalize ali.\n\n2. FILTRO DE ENCERRAMENTO:\n   - Se o humano enviar mensagens de despedida ou agradecimento final (Ex: \"Valeu\", \"Obrigado\"), apenas despeÃ§a-se gentilmente. NÃ£o faÃ§a novas perguntas e ignore a INSTRUCAO_B.\n\n3. CONSTRUÃ‡ÃƒO DA RESPOSTA (O FLUXO):\n   - PASSO A (ValidaÃ§Ã£o): Comece SEMPRE validando a fala do humano usando a [INSTRUCAO_A]. Adapte o texto para ser uma ponte natural. Se a instruÃ§Ã£o pedir algo que vocÃª jÃ¡ disse no histÃ³rico recente, mude as palavras para nÃ£o ser repetitiva.\n   - PASSO B (DÃºvida TÃ©cnica): Se houver dÃºvida (Flag: {{ $('Router de DÃºvida').first().json.output.hasQuestion }}), responda curto via CONTEXTO_TÃ‰CNICO. Se a info nÃ£o existir, use a Carta de SeguranÃ§a: {{ $('Seta perfil1').first().json.securityLetter }}.\n   - PASSO C (Engajamento): Se a coleta de dados estiver ativa, insira a [INSTRUCAO_B]. \n     - REGRA ANTI-REPETIÃ‡ÃƒO: Se a pergunta da INSTRUCAO_B jÃ¡ foi feita nas Ãºltimas 3 mensagens e o humano ainda nÃ£o respondeu, NÃƒO repita a pergunta. Apenas valide a fala dele (Passo A) e aguarde.\n\n## REGRAS DE OURO (ANTI-ROBÃ”)\n- SEM PAPAGAIO: Proibido repetir apresentaÃ§Ãµes ou saudaÃ§Ãµes se jÃ¡ estiverem no histÃ³rico.\n- APRESENTAÃ‡ÃƒO: Apenas se o HISTORICO estiver 100% vazio.\n- Se a INSTRUCAO_B nÃ£o trouxer nada de novo ou jÃ¡ tiver sido atendida nos DADOS_COLETADOS, ignore-a.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[-2128,768],"id":"e022f843-b822-479c-ade1-ef286b87342b","name":"Gerador de Resposta"},{"parameters":{"amount":6},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-7088,1152],"id":"f8c547ba-6c58-4010-87d2-fc4453f1e442","name":"Wait1","webhookId":"d1e38aad-57ac-45e5-b64a-08e2f1ce1a6f"},{"parameters":{"operation":"delete","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-7088,784],"id":"c687ee84-4b3d-4d6b-a138-f2565404c804","name":"DELETE1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2aafb32-380d-4510-810a-888831d36437","leftValue":"={{ DateTime.fromMillis($json.messages?.last().timestamp) }}","rightValue":"={{ $now.minus(6, 'seconds' )}}","operator":{"type":"dateTime","operation":"before"}}],"combinator":"and"},"renameOutput":true,"outputKey":"segue"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3d2a33da-ed74-4906-92aa-74ad3a37c4f1","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"nada"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"espera"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-7312,864],"id":"65f3fcf3-b645-497b-89ff-44c9074b742d","name":"SWITCH_BUFFER"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-7088,960],"id":"70ea16d7-2da5-4d28-b7c6-cbf961ee66d9","name":"NADA1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1f5bcbd1-6685-469d-bbf2-7939008b234d","leftValue":"={{ $json.user_msg }}","rightValue":"clear:cache:111222","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-9264,864],"id":"3f264b4d-de14-4fdb-a44b-ec44b64dd580","name":"If2"},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8720,560],"id":"63694275-a282-4cc7-bac2-fddb37de9afe","name":"Delete table or rows1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"delete","key":"={{ $('Configura Contexto').item.json.cache_key }}_state"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8896,560],"id":"97e89849-0861-43e8-b3cd-c33830791799","name":"Deleta estado atual","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=temp.{{ $('Configura Contexto').item.json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8528,560],"id":"4aafa985-084a-4eda-9067-7d76c5d41671","name":"DELETE2","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"return {\n  messages: [\n    ...(typeof $('BUSCA MENSAGENS ACUMULADAS').first().json.messages == 'string' ? JSON.parse($('BUSCA MENSAGENS ACUMULADAS').first().json.messages) : $('BUSCA MENSAGENS ACUMULADAS').first().json.messages), \n    ...(typeof $('GET2').first().json.messages == 'string' ? JSON.parse($('GET2').first().json.messages) : $('GET2').first().json.messages)\n  ]\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-144,1424],"id":"2a4a848a-caa8-46fb-b3fd-60cfe71bfeb9","name":"Concatena mensagens para cache"},{"parameters":{"jsCode":"const messages = typeof $input.first().json.messages == 'string' ? JSON.parse($input.first().json.messages) : $input.first().json.messages\n\nreturn {\n  messages: messages?.map(message => typeof message === 'string' ? JSON.parse(message) : message) ?? null\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-7632,880],"id":"7f4a145a-25fb-4e89-8e15-d914618f2268","name":"Transforma em objeto literal"},{"parameters":{"method":"POST","url":"={{ $env.APRECHAT_URL_API }}api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output }}"},{"name":"number","value":"={{ $('Webhook').first().json.body.contact.number }}"},{"name":"addUserName","value":"={{ $('Seta perfil1').first().json.agentName }}"},{"name":"whatsappId","value":"={{ $('Webhook').first().json.body.whatsappId }}"},{"name":"messageRepliedId","value":"={{ $('Webhook').first().json.body.messageId }}"},{"name":"messageType","value":"internalNote"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2288,112],"id":"93574b12-f35a-4f6e-89aa-5aefee29528f","name":"Salva nota na conversa1"},{"parameters":{"jsCode":"const data = $input.all();\nconst formatChatHistory = (inputData) => {\n  return inputData.map(jsonItem => {\n    const item = jsonItem.json\n    // 1. Define o remetente\n    const sender = item.message.type === 'human' ? 'User' : 'IA';\n    \n    // 2. Pega o conteÃºdo original\n    let content = item.message.content;\n\n    // 3. Se for IA, aplica a Regex para limpar o \"lixo\" tÃ©cnico\n    if (item.message.type === 'ai') {\n      // REGEX EXPLICADA:\n      // ^              -> ComeÃ§a no inÃ­cio da string\n      // \\[Used tools:  -> Procura literalmente por \"[Used tools:\"\n      // [\\s\\S]*?       -> Pega qualquer caractere (incluindo quebra de linha) de forma nÃ£o-gulosa (para no primeiro match)\n      // \\]\\]           -> Procura o fechamento dos colchetes duplos \"]]\"\n      // \\s* -> Remove quaisquer espaÃ§os ou quebras de linha que sobrem logo apÃ³s\n      content = content.replace(/^\\[Used tools:[\\s\\S]*?\\]\\]\\s*/, '');\n    }\n\n    // 4. Retorna no formato solicitado\n    return `${sender}: ${content}`;\n  }).join('\\n'); // Une tudo com quebra de linha\n};\n\n// Executa e mostra o resultado\nconst result = formatChatHistory(data);\n\nreturn  {\n  result\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1648,112],"id":"861dee0d-29f2-46f7-ae77-ca27ac4eaa74","name":"Formata histÃ³rico1","executeOnce":true},{"parameters":{"promptType":"define","text":"=[HISTÃ“RICO DE CONVERSA]\n{{ $json.result }}","options":{"systemMessage":"*DOSSIÃŠ*\nCrie um breve dossiÃª da conversa, listando cada informaÃ§Ã£o separada por linha e colocando a label em negrito. Use emojis no inÃ­cio de cada linha para dar destaque e reforÃ§ar o significado do item.\n\n*ANÃLISE*\nTom: Defina o tom/perfil do usuÃ¡rio. Use emojis relevantes no inÃ­cio.\nResumo: Gere um breve resumo da conversa em texto corrido. Use emojis ao longo do texto para dar ritmo e destacar pontos importantes.\n\n*ONDE PAROU*\nInforme onde a conversa parou. Use emojis para marcar status e contexto.\n\n*PRÃ“XIMOS PASSOS*\nDefina os prÃ³ximos passos. Use emojis em cada passo para guiar o olhar e deixar mais chamativo.\n\n## FORMATAÃ‡ÃƒO:\nNegrito: Um asterisco antes e depois da palavra/frase. Ex: '*Teste*'\nItÃ¡lico: Um underline antes e depois da palavra/frase. Ex: '_Teste_'\n\n## REGRAS DE OURO:\n- Seja breve\n- Crie um resumo objetivo\n- Texto corrido apenas no resumo (bloco anÃ¡lise)\n- ABUSE DE EMOJIS para chamar atenÃ§Ã£o, sem parecer aleatÃ³rio\n- Emojis devem ser condizentes com a informaÃ§Ã£o de cada linha\n- Em listas, usar pelo menos 1 emoji por linha\n- No resumo, usar emojis espalhados ao longo do texto, destacando temas, decisÃµes, dores e prÃ³ximos passos\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3,"position":[1920,112],"id":"984581d9-2d1c-48bb-9ce2-6e8bdcb37d66","name":"Gera resumo da conversa - AI1"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"sort":{"values":[{"column":"id"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1424,112],"id":"4460bb7b-e758-4ce3-8569-196683a7ff4b","name":"Busca histÃ³rico de conversa1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8656,880],"id":"35f88924-42c0-4c4b-a0b6-555d7fb214f7","name":"Busca mensagens no cache","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"jsCode":"const inputMessages = typeof $input.first().json.messages == 'string' ?  JSON.parse($input.first().json.messages) : $input.first().json.messages\nconst cacheMessagesToArrayJSON = inputMessages?.map(message => typeof message == 'string' ? JSON.parse(message) : message) || []\nconst userMsg = $('Retorna userMsg').first().json\nconst currentMessageIsAlreadyOnCache = inputMessages?.find(message => message.message === userMsg.message && message.timestamp === userMsg.timestamp) || false\n\n\nreturn {\n  messages: [\n    ...cacheMessagesToArrayJSON, \n    userMsg\n  ], \n  currentMessageIsAlreadyOnCache\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-8368,880],"id":"abb33b8c-c1aa-4fd8-9b56-39ee07ae596a","name":"Junta mensagem do cache com a mensagem do usuÃ¡rio"},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8080,880],"id":"da193626-7c80-40d4-aa4b-03615db6b521","name":"SETA CACHE DAS MENSAGENS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-7856,880],"id":"9e9b1ed3-2741-4675-95c1-5235034308e6","name":"BUSCA MENSAGENS ACUMULADAS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($('Concatena mensagens para cache').first().json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[64,1424],"id":"8e1d5359-92c7-4f2e-af7c-bbe67b8c079f","name":"RE-SETA CACHE DAS MENSAGENS ACUMULADAS","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":8,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-5488,768],"id":"1a0b8458-99d4-47e3-90fe-be1af825c0cd","name":"Pega ultimas mensagens","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length || !messages[0].json?.message?.content) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5264,768],"id":"b4b42675-1168-4e41-a586-598a5a0b8e7d","name":"Formata ultimas mensagens","executeOnce":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"CLOSING","operator":{"type":"string","operation":"equals"},"id":"732957f5-38a8-4204-ab63-9403f96c1a78"}],"combinator":"and"},"renameOutput":true,"outputKey":"closing"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1a022d7b-9866-445e-824d-ee7a7616d891","leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"CLOSING_WHEN_INVALID_OPTION","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"closing_when_invalid_option"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3807d7cc-18c1-470f-9689-a991e3d75d2b","leftValue":"={{ $('LOGIC ENGINE').first().json.newStageId }}","rightValue":"SEND_COMMERCIAL_PRESENTATION","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"send_commercial_presentation"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[896,448],"id":"0dd46236-dd8e-4533-af6e-026d3aebe0eb","name":"Switch"},{"parameters":{"workflowId":{"__rl":true,"value":"wd0uAb0Sm1fW5YNt","mode":"list","cachedResultUrl":"/workflow/wd0uAb0Sm1fW5YNt","cachedResultName":"Enviar apresentaÃ§Ã£o comercial"},"workflowInputs":{"mappingMode":"defineBelow","value":{"whatsappId":"={{ $('Configura Contexto').first().json.whatsappId.toNumber() }}","messageRepliedId":0,"company":"={{ $('Configura Contexto').first().json.companyId }}","number":"={{ $('Configura Contexto').first().json.user_phone }}","addUserName":"={{ $('Seta perfil1').first().json.agentName }}","message":"Segue! ðŸš€ðŸš€"},"matchingColumns":[],"schema":[{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"number","displayName":"number","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"addUserName","displayName":"addUserName","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsappId","displayName":"whatsappId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"messageRepliedId","displayName":"messageRepliedId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"company","displayName":"company","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[800,112],"id":"0de7a40b-964c-480f-b5e5-0d38f9327be0","name":"Call 'Enviar apresentaÃ§Ã£o comercial'","executeOnce":true},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"## TOOL: BASE DE CONHECIMENTO (RESTRITO)\n\n## IMPORTANTE:\nEsta tool NÃƒO Ã© um suporte para dÃºvidas do usuÃ¡rio. Ela Ã© um repositÃ³rio de dados que sÃ³ pode ser acessado se a variÃ¡vel [INSTRUÃ‡ÃƒO DO FLUXO] contiver explicitamente o comando \"consultar base\", \"chamar conhecimento\" ou \"buscar dados\".\n\n## REGRAS DE ACIONAMENTO:\n1. Analise a [INSTRUÃ‡ÃƒO DO FLUXO].\n2. Se a instruÃ§Ã£o NÃƒO pedir para buscar dados, vocÃª estÃ¡ PROIBIDO de usar esta tool, mesmo que o usuÃ¡rio faÃ§a uma pergunta tÃ©cnica.\n3. Se o usuÃ¡rio perguntar algo e a instruÃ§Ã£o NÃƒO mandar buscar, use a \"Carta de SeguranÃ§a\" padrÃ£o do sistema.\n\n## PRIORIDADE:\nInstruÃ§Ã£o do Fluxo > Pergunta do UsuÃ¡rio.","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[-2080,1056],"id":"3f34599c-6416-4774-8e77-3b10f405bb0a","name":"Base de conhecimento","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-2080,1232],"id":"e7de475f-32dc-4380-b947-78eb5638f4ab","name":"Embeddings OpenAI2","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\": $('LOOP_SLIT1').first().json.message , \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}","message_time":"={{ $now.toFormat('yyyy-MM-dd HH:mm:ss') }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true},{"id":"message_time","displayName":"message_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1136,816],"id":"28917971-b3f8-434a-8b17-f31d6fc30c22","name":"Insere mensagem da IA no BD","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[576,752],"id":"c78a582d-9cd4-47a7-bab5-fc674930eebf","name":"GET3","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2dfab0a2-c614-429c-a13d-36ecb7803f12","leftValue":"={{ $json.messages?.length ?? 0 }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[816,800],"id":"dcbe6edf-ee9d-4f4a-aff2-265c67568947","name":"Se nÃ£o recebeu mensagem no meio do processamento1","alwaysOutputData":false},{"parameters":{"operation":"get","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2512,720],"id":"391130c8-63f6-40ea-bbab-b2084f8da012","name":"Busca estado atual para follow-up","executeOnce":true,"credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"returnAll":true,"where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"},{"column":"company_id","value":"={{ $('Configura Contexto').first().json.companyId }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2720,720],"id":"4a2b715c-d811-475f-a1d9-8244a44b7b26","name":"Busca Follow Up","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Busca Follow Up').item.json.id }}","last_instruction":"={{ `Pergunte: ${JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.description}` }}","last_var_requested":"={{ JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.name }}","follow_up_time":"={{ $now.plus(2, 'hours') }}","attempts":0,"active":"={{ true }}","follow_up_type":"initiated","whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","ticket_id":"={{ $('Webhook').first().json.body.ticketId }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ticket_id","displayName":"ticket_id","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3504,624],"id":"86ac0687-1bd9-48e2-b948-720d029f5a00","name":"Atualiza follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"company_id":"={{ $('Configura Contexto').first().json.companyId }}","session_id":"={{ $('Configura Contexto').first().json.cache_key }}","last_instruction":"={{ `Pergunte: ${JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.description}` }}","last_var_requested":"={{ JSON.parse($('Busca estado atual para follow-up').item.json.propertyName || '{}').missingVar.name }}","follow_up_time":"={{ $now.plus(2, 'hours') }}","user_phone":"={{ $('Configura Contexto').first().json.user_phone }}","attempts":0,"whatsapp_id":"={{ $('Configura Contexto').first().json.whatsappId }}","agent_name":"={{ $('Seta perfil1').first().json.agentName }}","follow_up_type":"initiated","ticket_id":"={{ $('Webhook').first().json.body.ticketId }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"active","displayName":"active","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":false},{"id":"whatsapp_id","displayName":"whatsapp_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"follow_up_type","displayName":"follow_up_type","required":false,"defaultMatch":false,"display":true,"type":"options","canBeUsedToMatch":true,"options":[{"name":"initiated","value":"initiated"},{"name":"requested","value":"requested"}],"removed":false},{"id":"last_var_requested","displayName":"last_var_requested","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ticket_id","displayName":"ticket_id","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3504,816],"id":"fb4d381c-a1e2-45a2-b996-3df26eeaeea0","name":"Insere novo follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('Configura Contexto').first().json.cache_key }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8320,560],"id":"7b281dc9-0d55-4158-990a-65f11dddcc9e","name":"Remove follow-ups","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"return {\n  tone: \"SimpÃ¡tica e leve.\",\n  agentName: \"Alicia\",\n  internalName: \"Alicia da Apresenta.me\",\n  initialMessage: \"OlÃ¡, tudo bem? ðŸ‘‹ \\n\\nEu sou a Alicia, assistente da Apresenta.me, vou te ajudar entendendo melhor sua necessidade.\",\n  language: \"pt-BR\",\n  timeZone: \"Sao Paulo (GTM -3)\",\n  role: \"SDR SÃªnior\",\n  companyName: \"Apresenta.me\",\n  companyDepartment: \"Software ImobiliÃ¡rio\",\n  companySite: \"https://apresenta.me\",\n  securityLetter: \"NÃ£o tenho nenhuma informaÃ§Ã£o sobre [ASSUNTO], mas assim que eu coletar seus dados um especialista vai poder te responder isso com precisÃ£o, tÃ¡? (Caso o atendimento jÃ¡ tenha sido encaminhado para um especialista, nÃ£o cite a coleta de dados)\",\n  conduct: `Sua funÃ§Ã£o Ã© coletar dados de leads.\n  VocÃª coleta os dados dos leads de forma humanizada. Esses dados coletados serÃ£o passados para um especialista, que futuramente irÃ¡ agendar uma reuniÃ£o online com um consultor de vendas (humano)\n  VocÃª sempre chama o lead pelo primeiro nome, mas qunado pergunta, nÃ£o restringe apenas a primeiro nome.\n  VocÃª responde de forma humanizada, como se tivesse atÃ© sentimentos.\n  VocÃª nunca cita concorrentes.\n  VocÃª nunca elogia concorrentes.\n  Sempre que o lead pede uma demonstraÃ§Ã£o ou diz que quer conhecer o sistema: vocÃª diz que precisa realizar a coleta de dados primeiro para encaminhÃ¡-lo para um especialista que irÃ¡ agendar uma demonstraÃ§Ã£o.\n  VocÃª Ã© educada e focada, mostra confianÃ§a ao lead.\n  VocÃª se apresenta no Ã­nicio de toda conversa (quando nÃ£o houover mensagens anteriores).\n  Se o lead perguntar sobre valores (de forma raza), envie o link https://apresenta.me/planos-e-precos/, mas complemente que um especialista pode personalizar melhor um plano adequado para o lead, vocÃª sÃ³ precisa coletar alguns dados pra personalizar da melhor forma.\n  LocalizaÃ§Ã£o da empresa: R. dos CaÃ§adores, 345 - Sala 01 - Centro, Rio do Sul - SC\n  Se a conversa chegou ao final e o lead entendeu que serÃ¡ encaminhado para um especialista (fazendo alguma confirmaÃ§Ã£o passiva), se despeÃ§a brevemente e diga que estÃ¡ a disposiÃ§Ã£o para sanar dÃºvidas ou retomar com a coleta de dados.\n  Se vocÃª entender a conversa estÃ¡ com tom de finalizaÃ§Ã£o, nÃ£o faÃ§a mais perguntas se entender que o Lead nÃ£o quer continuar com a sua qualificaÃ§Ã£o para um especialista personalizar uma demonstraÃ§Ã£o. Caso o lead esteja sÃ³ tirando dÃºvidas, responda brevemente e sÃ³ volte a realizar perguntas caso ele cite que quer uma demonstraÃ§Ã£o/teste/conhecer o sistema.\n  Jamais diga que vocÃª Ã© uma inteligÃªncia artificial. VocÃª Ã© a Alicia, assistente comercial da Apresenta.me.\n  IDENTIFICAÃ‡ÃƒO DE CLIENTE (CRÃTICO)\n    IDENTIFICAÃ‡ÃƒO: Considere cliente se ele:\n    Afirmar que jÃ¡ usa/Ã© cliente, Relatar dificuldades tÃ©cnicas, dÃºvidas de \"como fazer algo\" ou erros em funcionalidades (boletos, vistorias, etc).\n    - AÃ‡ÃƒO: Se for cliente, aborte a coleta de dados e o fluxo de venda imediatamente.\n    - RESPOSTA: Informe que, para suporte tÃ©cnico ou auxÃ­lio no uso, ele deve contatar: +55 (47) 8905-0935.\n    - NEGATIVO: Se ele disser explicitamente que nÃ£o Ã© cliente, ignore este bloco.\n  Antes de fazer a pergunta pro humano, nÃ£o fique justificando que a pergunta estÃ¡ sendo feita para um especialista entender o cenÃ¡rio dele, isso torna a conversa em algo repetitivo.\n  SE NOS DADOS COLETADOS, A VARIÃVEL NOME AINDA NÃƒO ESTIVER PREENCHIDA: nÃ£o chame o lead por nenhum nome, considere que vocÃª nÃ£o sabe.\n  `,\n  verbosity: \"medium\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5072,768],"id":"c6960197-4472-43bf-8fa0-16355123f5c5","name":"Seta perfil1"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Configura Contexto').first().json.cache_key }}","message":"={{ JSON.stringify({\"type\": \"human\", \"content\": $('CONCATENA1').first().json.user_full_message , \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}","message_time":"={{ DateTime.fromMillis($('DELETE1').first().json.messages.last().timestamp).setLocale('pt-BR').toFormat(\"yyyy-MM-dd HH:mm:ss\") }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true},{"id":"message_time","displayName":"message_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{"outputColumns":["id"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4896,768],"id":"5837df5d-fbec-48e3-a75f-dc9b5e6a0487","name":"Insere mensagem do usuÃ¡rio no BD","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":1}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-9904,2256],"id":"864326ed-47e6-40ef-91c1-53c3e0221597","name":"Cron 1em1 min - FOLLOW-UP"},{"parameters":{"operation":"executeQuery","query":"SELECT \n  * FROM follow_up_queue\nWHERE follow_up_time <= NOW()\nAND active IS TRUE\nAND (\n  (\n    follow_up_type = 'initiated'\n  )\n  OR (\n    follow_up_type = 'requested'\n    AND attempts < 1\n  )  \n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-9200,2240],"id":"b2bc2644-5028-4026-9978-a1fe09e18104","name":"Busca follow-ups disponÃ­veis","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-8784,2240],"id":"7e463e68-e46f-4dc2-8ff3-075c6da1dc5e","name":"LOOP nos follow-up's"},{"parameters":{"operation":"get","key":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}_state","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8096,2368],"id":"ba4492ae-3947-4754-93ec-1b5234b78697","name":"Busca estado atual da conversa","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"mode":"raw","jsonOutput":"={{ $json.propertyName }}","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-7856,2368],"id":"f4e5aa3d-9443-4880-8923-c3ac4abde8ab","name":"Transforma estado atual em JSON literal"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"277c3ae6-bdd3-4743-aa6d-9181d4e3f217","leftValue":"={{ $('Switch tipo de follow-up').first().json.vars[$('LOOP nos follow-up\\'s').first().json.last_var_requested]?.value?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-6768,2512],"id":"4c8d3360-297b-4ad3-b8f6-6c5ed9a878c2","name":"Se o usuÃ¡rio respondeu a variÃ¡vel pendente no meio do caminho"},{"parameters":{"method":"POST","url":"={{ $env.APRECHAT_URL_API }}api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('LOOP nos follow-up\\'s').first().json.company_id }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.text }}"},{"name":"number","value":"={{ $('LOOP nos follow-up\\'s').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('LOOP nos follow-up\\'s').first().json.whatsapp_id }}"},{"name":"addUserName","value":"={{ $('LOOP nos follow-up\\'s').first().json.agent_name }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-5328,2624],"id":"64b091b9-4b74-4f54-a8c6-8625ff93435c","name":"Envia via Apre.Chat"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":5,"where":{"values":[{"column":"session_id","value":"={{ $('LOOP nos follow-up\\'s').item.json.session_id }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-6528,2528],"id":"b3bca259-1a09-4e8a-8bb7-d1377d967ae2","name":"Pega ultimas mensagens1","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6288,2528],"id":"40ad8c81-d0b3-4b92-b6e9-06ed55709831","name":"Formata ultimas mensagens1","executeOnce":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\":  $('Gera mensagem de follow-up2').first().json.text, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4720,2624],"id":"c7010636-aff6-4af9-924b-ad515fd92843","name":"Insere mensagem da IA no BD1","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"=temp.{{ $json.session_id }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8496,2256],"id":"67e21f02-e501-4b53-a798-c8c757405fc5","name":"BUSCA MENSAGENS ACUMULADAS1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"431557d8-7fd4-46ed-951f-464868b21a82","leftValue":"={{ $json.messages?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-8288,2256],"id":"fe102b78-7bae-4020-9e36-d013d85602c0","name":"Se chegou alguma mensagem do usuÃ¡rio"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('LOOP nos follow-up\\'s').item.json.follow_up_type }}","rightValue":"requested","operator":{"type":"string","operation":"equals"},"id":"d71e1dc1-85d0-472b-9e8b-b0b3507dfd37"}],"combinator":"and"},"renameOutput":true,"outputKey":"solicitado"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c14755ff-644f-40ca-8c9c-8b863457a0c1","leftValue":"={{ $('LOOP nos follow-up\\'s').item.json.follow_up_type }}","rightValue":"initiated","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"proativo"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[-7648,2368],"id":"80c4b55b-caa2-4a5f-8360-d4ed2b2ee37f","name":"Switch tipo de follow-up"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"limit":5,"where":{"values":[{"column":"session_id","value":"={{ $('LOOP nos follow-up\\'s').item.json.session_id }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{"outputColumns":["message"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-7296,2224],"id":"fafa4f41-dacf-4839-90ed-c3ca9b957be9","name":"Pega ultimas mensagens2","alwaysOutputData":true,"credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"jsCode":"const messages = $input.all()\n\nif (!Object.entries(messages).length) return { historyMessages: null }\n\nconst lastMessagesSorted = messages.reverse()\n\nconst historyMessages = lastMessagesSorted.map(m => {\n  return `**${m.json.message?.type?.toLocaleLowerCase()}**: ${m.json.message?.content}`\n}).join('\\n\\n')\n\nreturn {\n  historyMessages \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-7056,2224],"id":"50d3e4ef-3e54-4aa1-a519-a082b70821b4","name":"Formata ultimas mensagens2","executeOnce":true,"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4c3ea394-ce4c-441d-818d-2f1278d63264","leftValue":"={{ $('Pega ultimas mensagens1').first().json.message.type }}","rightValue":"ai","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-6000,2528],"id":"722a1b52-67f6-4ded-a138-5be74416da53","name":"Se a Ãºltima mensagem foi da IA"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini-2024-07-18","mode":"list","cachedResultName":"GPT-4O-MINI-2024-07-18"},"responses":{"values":[{"role":"system","content":"=**SISTEMA:** VocÃª Ã© um humano retomando um papo que foi pausado. Use tom \"business casual\". Sem formalidade. Sem exclamaÃ§Ãµes.\n\n**REGRAS DE DIAMANTE**\n - VÃ¡ direto ao ponto: o objetivo Ã© apenas saber se o usuÃ¡rio pode falar agora.\n - Proibido citar horÃ¡rios, datas, motivos do atraso ou o assunto anterior.\n\n**ALGORITMO DE COMPOSIÃ‡ÃƒO:**\n1. **IDENTIDADE:**\n   - Se [NOME] existir: Comece com \"[NOME], ...\"\n   - Se [NOME] for vazio/null: Comece com \"Oi, tudo bem?\" ou \"Oi, tudo certo?\".\n2. **PONTE DE RETOMADA:** Use exclusivamente frases de disponibilidade imediata como \"conseguimos retomar nossa conversa\", \"vocÃª tÃ¡ livre pra conversar agora\", \"vocÃª tem um tempinho\" ou \"conseguimos dar continuidade\".\n3. **FILTRO DE MEMÃ“RIA (CRÃTICO):** Ignore qualquer informaÃ§Ã£o sobre \"amanhÃ£\", \"11h\" ou \"reuniÃ£o\". Sua Ãºnica missÃ£o Ã© transformar o comando \"Pergunte se o usuÃ¡rio pode retomar a conversa\" em uma pergunta de disponibilidade atual.\n\n---\n\n**REGRAS RÃGIDAS:**\n- **PROIBIDO:** \"Lead\", \"Pendente\", \"InformaÃ§Ã£o\", \"Sistema\", \"Ocupado\", \"AmanhÃ£\", \"HorÃ¡rio\", \"Agendado\".\n- **LIMITE:** MÃ¡ximo 15 palavras.\n- **PONTUAÃ‡ÃƒO:** Ã‰ terminantemente proibido o uso de exclamaÃ§Ãµes (!). \n- **FINALIZAÃ‡ÃƒO:** Termine obrigatoriamente com a interrogaÃ§Ã£o da pergunta.\n\n**SAÃDA FINAL (TEXTO PURO):**"},{"content":"=**DADOS:**\n- **NOME_USUARIO:** {{ $('Transforma estado atual em JSON literal').first().json.vars.name.value }}\n- **COMANDO:** {{ $('LOOP nos follow-up\\'s').first().json.last_instruction }}\n- **HISTÃ“RICO DE CONVERSA:** \n{{ $('Formata ultimas mensagens2').first().json.historyMessages }}"}]},"builtInTools":{},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2,"position":[-6832,2224],"id":"f80023c7-905c-4636-8a8e-e1901ec6c361","name":"Gera mensagem de follow-up1","credentials":{"openAiApi":{"id":"Qgve7726U3p1YYtm","name":"Open AI Alicia"}},"disabled":true},{"parameters":{"method":"POST","url":"={{ $env.APRECHAT_URL_API }}api/messages/send","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('LOOP nos follow-up\\'s').first().json.company_id }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output[0].content[0].text }}"},{"name":"number","value":"={{ $('LOOP nos follow-up\\'s').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('LOOP nos follow-up\\'s').first().json.whatsapp_id }}"},{"name":"addUserName","value":"={{ $('LOOP nos follow-up\\'s').first().json.agent_name }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-6480,2224],"id":"a427a35c-8752-4193-8eaa-61d1c7989634","name":"Envia via Apre.Chat1","disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('LOOP nos follow-up\\'s').first().json.session_id }}","message":"={{ JSON.stringify({\"type\": \"ai\", \"content\":  $('Gera mensagem de follow-up1').first().json.output[0].content[0].text, \"tool_calls\": [], \"additional_kwargs\": {}, \"response_metadata\": {}, \"invalid_tool_calls\": []}) }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-5984,2224],"id":"259be408-0cd6-4a90-a0cd-0601d29bf6be","name":"Insere mensagem da IA no BD4","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('LOOP nos follow-up\\'s').first().json.id }}","attempts":"={{ $('LOOP nos follow-up\\'s').first().json.attempts + 1 }}","follow_up_time":"={{ $json.newTime }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":false},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4912,2624],"id":"aa0fe423-9b1a-4e2a-b1e9-a75bcddd60c5","name":"Atualiza tentativas de follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"follow_up_queue","mode":"list","cachedResultName":"follow_up_queue"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('LOOP nos follow-up\\'s').first().json.id }}","attempts":"={{ $('LOOP nos follow-up\\'s').first().json.attempts + 1 }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_instruction","displayName":"last_instruction","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_var_requested","displayName":"last_var_requested","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"follow_up_time","displayName":"follow_up_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"attempts","displayName":"attempts","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_phone","displayName":"user_phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-6224,2224],"id":"c3967c31-cc61-4b0d-a3f3-9032bb562ba1","name":"Atualiza tentativa de follow-up","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}},"disabled":true},{"parameters":{"jsCode":"// ObtÃ©m a hora atual formatada especificamente para o fuso de SÃ£o Paulo\nconst brazilHourString = new Intl.DateTimeFormat('pt-BR', {\n  timeZone: 'America/Sao_Paulo',\n  hour: 'numeric',\n  hour12: false\n}).format(new Date());\n\nconst currentHour = parseInt(brazilHourString);\n// LÃ³gica: das 07:00:00 atÃ© as 22:59:59 (True)\n// Se bater 23:00:00, vira False\nconst isWithinRange = (currentHour >= 7 && currentHour < 23);\n\nfor (const item of $input.all()) {\n  item.json.isBusinessHours = isWithinRange;\n  item.json.debug_hour = currentHour; // Opcional: para vocÃª conferir no output\n}\n\nreturn {\n  isWithinRange: isWithinRange\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-9696,2256],"id":"70409d9a-9f7a-441d-813e-0cff0ba926c1","name":"Code in JavaScript"},{"parameters":{"jsCode":"const attempts = $('LOOP nos follow-up\\'s').first().json.attempts\nlet newTime = null\n\nif (attempts == 0) {\n  newTime = $now.plus({ hours: 3 })\n}\n\nif (attempts == 1) {\n  newTime = $now.plus({ hours: 24 })\n}\n\nif (attempts >= 2) {\n  newTime = $now.plus({ hours: 72 })\n}\n\nreturn { newTime, attempts }"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5120,2624],"id":"387cf8e7-6f00-4a3d-b864-c755be2e764a","name":"Pega novo horario de follow-up pelos attempts"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6ada5780-8e59-4f7a-8066-b24d36c1f27c","leftValue":"={{ $json.isWithinRange }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-9488,2256],"id":"9f12883e-cde5-4998-8036-a3be46b3e744","name":"If1"},{"parameters":{"url":"={{ $env.APRECHAT_URL_API }}api/ticket/show/{{ $('LOOP nos follow-up\\'s').item.json.ticket_id || $('LOOP nos follow-up\\'s').item.json.session_id.split('session_')[1]}}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('LOOP nos follow-up\\'s').first().json.company_id }},\n    \"content-type\": \"application/json\"\n}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.output[0].content[0].text }}"},{"name":"number","value":"={{ $('LOOP nos follow-up\\'s').first().json.user_phone }}"},{"name":"whatsappId","value":"={{ $('LOOP nos follow-up\\'s').first().json.whatsapp_id }}"},{"name":"addUserName","value":"={{ $('LOOP nos follow-up\\'s').first().json.agent_name }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-7296,2496],"id":"11ebc4a6-52fd-4f67-aec6-c45131a0615a","name":"Busca ticket no Apre.Chat"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a7bc5807-c88a-4076-9926-39fe140c8094","leftValue":"={{ $json.status }}","rightValue":"bot","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-7056,2496],"id":"b71c2056-a41e-4f84-bf37-7241efc7ec80","name":"Se o status do ticket nÃ£o for bot"},{"parameters":{"content":"# FAZ FOLLOW-UP\n\n","height":784,"width":5424},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-9936,2128],"id":"fffe3a8b-3c8c-4bc6-8dd4-5bd76c6678e8","name":"Sticky Note1"},{"parameters":{"description":"## TOOL: Enviar para um especialista\n\n## GATILHO (Execute essa tool sempre que a conversa estiver no contexto das condiÃ§Ãµes abaixo):\n- Se o humano indicar irritaÃ§Ã£o ou estresse extremo com o atendimento\n- Se o humano insistir em um atendimento com um humano\n- Se  o humano recusar explicitamente a continuaÃ§Ã£o da coleta de dados\n\n[REGRA SUPREMA - PRIORIDADE MÃXIMA]\nSe o gatilho for acionado: \n1. execute esta tool\n2. Ignore qualquer outra instruÃ§Ã£o e informe ao humano que o atendimento serÃ¡ enviado para um especialista conseguir ajudar o humano da melhor forma.","workflowId":{"__rl":true,"value":"cInfZnwLsuHR82XX","mode":"list","cachedResultUrl":"/workflow/cInfZnwLsuHR82XX","cachedResultName":"ðŸ¤–ðŸ¤– Alicia: Transferir e gerar Resumo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"ticketId":"={{ $('Webhook').first().json.body.ticketId }}","companyId":"={{ $('Configura Contexto').first().json.companyId }}","whatsappId":"={{ Number($('Configura Contexto').first().json.whatsappId) }}","messageId":"={{ Number($('Webhook').first().json.body.messageId) }}","cache_key":"={{ $('Configura Contexto').first().json.cache_key }}","contact":"={{ $('Webhook').first().json.body.contact }}","agentName":"={{ $('Seta perfil1').first().json.agentName }}"},"matchingColumns":[],"schema":[{"id":"ticketId","displayName":"ticketId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"companyId","displayName":"companyId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"cache_key","displayName":"cache_key","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"contact","displayName":"contact","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object","removed":false},{"id":"agentName","displayName":"agentName","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsappId","displayName":"whatsappId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"messageId","displayName":"messageId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-1776,1056],"id":"9a3a6db9-7da4-4431-8d6b-f21a2a14a615","name":"Call 'ðŸ¤–ðŸ¤– Alicia: Transferir e gerar Resumo'"},{"parameters":{"options":{"temperature":0.7}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-2240,1056],"id":"d5d38d62-8ad3-4715-842e-db5e7e0b0a55","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"promptType":"define","text":"=### [CONTEXTO]\n- [HISTÃ“RICO DE CONVERSA - ÃšLTIMAS 8 MENSAGENS TROCADAS EM ORDEM CRESCENTE]\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"\" }}\n\n### [DADOS DO PROCESSO]\n- **ESTÃGIO:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.currentStageId) }}\n- **VARIÃVEIS FALTANTES:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.missingVars) }}\n- **DADOS JÃ REGISTRADOS:** {{ JSON.stringify($('BLUEPRINT ENGINE').first().json.vars) }}\n- **ULTIMA PERGUNTA DO ROBÃ” (IA):** \"{{ $('Pega ultimas mensagens').first().json.message.content }}\"\n- **MENSAGEM DO USUÃRIO:** \"{{ $('BLUEPRINT ENGINE').first().json.userMsg }}\"\n- **ÃšLTIMA VARIÃVEL SOLICITADA:** {{ JSON.parse($('GET Estado Atual').first().json.propertyName || '{}').missingVar.name }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=### [PERFIL - IDENTIDADE]\nVocÃª Ã© um extrator de dados de alta precisÃ£o baseado em contexto de conversa e intenÃ§Ã£o de humano. Sua funÃ§Ã£o Ã© converter mensagens em JSON seguindo estritamente as regras de nexo entre a fala do humano e a `description` das variÃ¡veis fornecidas dinamicamente.\n\n### [ORDEM DE EXECUÃ‡ÃƒO - AUDITOR DE DADOS]\n1. **LIMPEZA DE ENTRADA (WHATSAPP REPLY):** Se a [MENSAGEM humano] contiver metadados de resposta (ex: \"UsuÃ¡rio estÃ¡ respondendo a mensagem...\"), ignore o texto replicado da IA e foque exclusivamente no conteÃºdo novo enviado pelo humano.\n2. **ANÃLISE DE CONTEXTO E NEXO:** Compare a resposta inÃ©dita com os [DADOS JÃ REGISTRADOS] e a [ULTIMA PERGUNTA DO ROBÃ”]. Verifique se a fala Ã© uma resposta direta ao que foi perguntado.\n3. **VARREDURA EXAUSTIVA E MAPEAMENTO:** Analise cada frase. Identifique se a fala, mesmo que use termos sinÃ´nimos, atende aos critÃ©rios das `options` ou da `description` das variÃ¡veis faltantes.\n4. **FILTRO DE INTENÃ‡ÃƒO (CONTEXTO DE REAÃ‡ÃƒO):** Diferencie se o humano estÃ¡ reagindo a um comentÃ¡rio da IA (Alvo Assertivo) ou respondendo Ã  pergunta de extraÃ§Ã£o (Alvo de ExtraÃ§Ã£o). Se o nexo for apenas com a empatia da IA, a extraÃ§Ã£o Ã© PROIBIDA.\n5. **PROCESSAMENTO DE DEPENDÃŠNCIAS:** Se uma extraÃ§Ã£o for realizada, verifique imediatamente se a `description` daquela variÃ¡vel exige a atribuiÃ§Ã£o automÃ¡tica de valores em outras variÃ¡veis.\n\n### [REGRAS CRÃTICAS DE EXTRAÃ‡ÃƒO - TOLERÃ‚NCIA ZERO]\n\n1. **MAPEAMENTO SEMÃ‚NTICO (REGRA DE DIAMANTE ATUALIZADA):**\n   - SÃ³ extraia valores se houver evidÃªncia textual clara. Todavia, identifique sinÃ´nimos diretos que satisfaÃ§am as `options`. \n   - **Exemplo:** Se a opÃ§Ã£o Ã© \"active\" (jÃ¡ trabalha com locaÃ§Ã£o) e o humano diz \"Trabalho com locaÃ§Ã£o e vendas\", a extraÃ§Ã£o de \"active\" Ã© OBRIGATÃ“RIA por nexo semÃ¢ntico, nÃ£o sendo considerada inferÃªncia proibida.\n   - **PROIBIÃ‡ÃƒO DE INFERÃŠNCIA:** Proibido assumir dados nÃ£o citados (ex: se ele nÃ£o falou o nome do sistema atual, nÃ£o tente adivinhar).\n\n2. **MAPEAMENTO DE OPTIONS E VALORES INVÃLIDOS:**\n   - Se a variÃ¡vel possuir `options`, compare o sentido da fala com as chaves disponÃ­veis.\n   - Se a fala se encaixar na descriÃ§Ã£o de uma chave \"invalid_option\", vocÃª DEVE extrair essa chave obrigatoriamente.\n\n3. **DEPENDÃŠNCIAS E REGRAS DE CAMPO (REGRAS INJETADAS):**\n   - Se a `description` de uma variÃ¡vel exigir a atribuiÃ§Ã£o automÃ¡tica de um valor em outra variÃ¡vel (ex: \"se jÃ¡ trabalha com locaÃ§Ã£o, defina interestFocus como 'all'\"), vocÃª deve incluir ambas as variÃ¡veis no JSON de saÃ­da.\n\n4. **ESTIMATIVA, CORREÃ‡ÃƒO E SOBREPOSIÃ‡ÃƒO:**\n   - **Estimativa:** Valores incertos, mas numÃ©ricos/objetivos (ex: \"acho que uns 50\"), devem ser extraÃ­dos.\n   - **CorreÃ§Ã£o:** Se a mensagem contradizer dados jÃ¡ salvos, extraia o novo valor para sobreposiÃ§Ã£o.\n\n5. **ADIAMENTO E RECUSA (ALTA PRIORIDADE):**\n   - Se o humano indicar que \"nÃ£o sabe agora\", \"precisa verificar\" ou \"responde depois\", extraia o valor \"answer_later\".\n   - Se o humano se recusa a fornecer a informaÃ§Ã£o/resposta (privacidade ou grosseria), extraia \"not_provided\".\n\n6. **VALIDAÃ‡ÃƒO DE CONSISTÃŠNCIA SEMÃ‚NTICA:**\n   - O lÃ©xico da resposta deve pertencer ao mesmo domÃ­nio da pergunta. Se o humano fala algo totalmente desconexo do fluxo de vendas, ignore a extraÃ§Ã£o.\n\n### [SAÃDA OBRIGATÃ“RIA]\n- Retorne APENAS o JSON puro. Proibido adicionar explicaÃ§Ãµes, marcaÃ§Ãµes de markdown ou pensamentos (thoughts).\n- Se nenhum dado for extraÃ­do ou corrigido, retorne `{}`.\n- Formato: `{ \"nome_da_variavel\": valor_extraido }`"}]}},"id":"93393787-a415-41a6-9ca6-07c534846ccb","name":"Extrator chain","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[-4688,768]},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"description\": \"Objeto JSON contendo as chaves das variÃ¡veis encontradas e seus respectivos valores.\",\n  \"additionalProperties\": {\n    \"oneOf\": [\n      {\n        \"type\": \"string\"\n      },\n      {\n        \"type\": \"number\"\n      },\n      {\n        \"type\": \"boolean\"\n      },\n      {\n        \"type\": \"null\"\n      },\n      {\n        \"type\": \"array\",\n        \"items\": {\n          \"type\": \"string\"\n        }\n      }\n    ]\n  }\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-4528,960],"id":"4847ae19-629b-4995-a6b1-34198627b1bc","name":"Structured Output Parser2"},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-4720,960],"id":"85382ca9-a01f-43ba-b7d0-86a3946a40c4","name":"Google Gemini Chat Model1","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-1136,928],"id":"48f094b0-52ac-4c71-8e6d-33d0f9d9cdad","name":"Google Gemini Chat Model2","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[1888,336],"id":"ca3cbd5f-1915-407f-bb06-b1437dbdea6f","name":"Google Gemini Chat Model3","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"48a523f6-7f86-4dcc-b471-f92cc29466af","leftValue":"={{ $json.output?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1440,768],"id":"4a047bc0-61fc-42fa-9963-8fdfce2523a8","name":"Se gerou resposta"},{"parameters":{"operation":"get","propertyName":"processing","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}","keyType":"string","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-6624,784],"id":"7cf56e0d-b219-4a07-81d4-79c08d784adc","name":"Busca mensagens em processamento","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b4cef1ab-9dcd-4800-81a6-64a49ab6d517","leftValue":"={{ $json.processing?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-6416,784],"id":"de446f33-7f76-4658-9051-a11024a92fc6","name":"Se nÃ£o tem mensagem sendo processada"},{"parameters":{"jsCode":"const messages = $input.first().json.messages || [];\nconst fullText = messages.map(m => m.message).join('\\n');\n\nreturn {\n  user_full_message: fullText,\n  cache_key: $('Configura Contexto').first().json.cache_key\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-6864,784],"id":"ec726778-0160-4d64-af1e-f2ebc5cc8456","name":"CONCATENA1"},{"parameters":{"operation":"set","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($('Junta mensagem do cache com a mensagem do usuÃ¡rio').first().json.messages) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-6192,768],"id":"be4513c1-3a6a-4edf-8a56-92756bb9ab97","name":"Seta mensagem em processamento no cache","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=temp.{{ $('Configura Contexto').first().json.cache_key }}","value":"={{ JSON.stringify($('Junta mensagem do cache com a mensagem do usuÃ¡rio').first().json.messages) }}","keyType":"string"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-6192,1104],"id":"3cdb552d-5da0-4ecc-85d5-de581af91411","name":"SETA CACHE DAS MENSAGENS1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-784,752],"id":"a0a65b3c-5936-43f6-9c12-aa37a9da0a90","name":"Remove mensagens do processamento","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"id","value":"={{ $('Insere mensagem do usuÃ¡rio no BD').first().json.id }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[912,1424],"id":"b0d78cfa-92fc-432b-b376-be70fee37e1e","name":"Delete table or rows","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"operation":"set","key":"={{ $('Configura Contexto').first().json.cache_key }}_state","value":"={{ $('GET Estado Atual').first().json.propertyName }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[544,1312],"id":"9a1885ca-76f2-4c14-b7bd-35e7f34d8c94","name":"Volta para o estado anterior","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-8112,560],"id":"e8355c6c-13a8-428e-b5c9-144dbb3ea297","name":"Deleta mensagem em processamento","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=processing.{{ $('Configura Contexto').first().json.cache_key }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1120,1104],"id":"4a71e4fc-6ff7-4065-bdc8-e503e2554117","name":"Remove mensagens do processamento1","credentials":{"redis":{"id":"6zkVquzWhiKtaU5H","name":"Redis account"}}},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-5728,2672],"id":"16a4bacf-c6f5-4ca2-abe3-aa98dbce9811","name":"Google Gemini Chat Model4","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"promptType":"define","text":"=**DADOS:**\n- **NOME_USUARIO:** {{ $json.vars.name || \"\" }}\n- **COMANDO:** {{ $('LOOP nos follow-up\\'s').first().json.last_instruction }}\n- **HISTÃ“RICO DE CONVERSA:** \n{{ $('Formata ultimas mensagens1').first().json.historyMessages }}\n---","hasOutputParser":true,"messages":{"messageValues":[{"message":"=### ROLE\nVocÃª Ã© um atendente humano no WhatsApp. Seu trabalho Ã© qualificar o contato para passar para um especialista. VocÃª Ã© educado, prestativo e escreve de forma natural (nÃ£o robÃ³tica).\n\n### OBJETIVO\nO usuÃ¡rio parou de responder. VocÃª precisa retomar a conversa explicando POR QUE vocÃª precisa da informaÃ§Ã£o (o \"motivo\" Ã© sempre: destravar o atendimento ou encaminhar para o especialista correto).\n\n### INPUTS\n- NOME_USUARIO: (Opcional) Nome do cliente.\n- COMANDO: A informaÃ§Ã£o que vocÃª precisa obter agora.\n- HISTORICO: As mensagens anteriores.\n\n### REGRAS DE OURO (ANTI-ROBÃ”)\n1. **ESTRUTURA OBRIGATÃ“RIA:**\n   `[SaudaÃ§Ã£o leve] + [Justificativa: \"Pra eu te passar pro especialista/pra gente seguir\"] + [Pergunta do COMANDO?]`\n   \n2. **ANTI-REPETIÃ‡ÃƒO (CRÃTICO):**\n   - Antes de escrever, LEIA O HISTÃ“RICO.\n   - Se a sua Ãºltima mensagem jÃ¡ foi essa pergunta, **NÃƒO REPITA A MESMA FRASE**.\n   - Se houver repetiÃ§Ã£o no histÃ³rico, mude o comeÃ§o para: \"Opa, imagino que esteja corrido, mas...\" ou \"SÃ³ pra nÃ£o deixar pendente aqui...\".\n\n3. **TOM DE VOZ:**\n   - Use \"pra\" em vez de \"para\".\n   - Use \"tÃ¡\" em vez de \"estÃ¡\".\n   - Jamais seja seco (ex: \"Qual seu cargo?\"). Sempre amorteÃ§a a pergunta.\n\n### EXEMPLOS DE COMPORTAMENTO\n*CenÃ¡rio 1 (Primeira tentativa):*\n\"Opa, tudo bom? Pra eu jÃ¡ te direcionar pro consultor ideal pra tua regiÃ£o, qual sua funÃ§Ã£o na imobiliÃ¡ria hoje?\"\n\n*CenÃ¡rio 2 (O usuÃ¡rio nÃ£o respondeu a anterior):*\n\"Fulano, sÃ³ retomando aqui pra gente avanÃ§ar... consegue me confirmar teu cargo? Assim jÃ¡ passo pro especialista.\"\n\n*CenÃ¡rio 3 (Comando Ã© 'Faturamento'):*\n\"Tudo certo por aÃ­? Pra gente ver se a ferramenta atende o volume de vocÃªs, qual Ã© a mÃ©dia de faturamento mensal?\"\n\n### SAÃDA\nGere apenas a mensagem de texto final. Sem aspas, sem explicaÃ§Ãµes."}]}},"id":"b6c2f1ab-afe8-4411-94eb-11944d9649db","name":"Gera mensagem de follow-up2","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[-5712,2512]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"check-question","leftValue":"={{ $json.output.hasQuestion }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3312,752],"id":"776871bd-6654-44df-9a47-aadb03225039","name":"Tem DÃºvida?"},{"parameters":{"mode":"load","tableName":"n8","prompt":"={{ $json.output.searchQuery }}","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.3,"position":[-2960,496],"id":"1ae2d944-78ed-4c6f-945a-b199121140f1","name":"Consulta Base Conhecimento","credentials":{"postgres":{"id":"pXgXB3fm4CWNM9Pd","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-2960,672],"id":"4d3f68de-d649-477b-b829-b78c197a54ee","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"weD4ayyAuWgClQqA","name":"OpenAi account"}}},{"parameters":{"jsCode":"return {\n  rag_context: $input.all().map(d => d.json.document.pageContent)\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2608,496],"id":"4ae74eae-a766-4cb4-856f-cf607b4df5d0","name":"RAG CONTEXT","executeOnce":true},{"parameters":{"jsCode":"return {\n  rag_context: $json.rag_context\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2336,768],"id":"65442d31-4aa8-4098-899b-67e9a549ee0a","name":"MERGE DADOS"},{"parameters":{"jsCode":"return {\n  message: $('Configura Contexto').first().json.user_msg, \n  timestamp: $now.toMillis() \n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-8928,880],"id":"beb5bda5-10c3-4564-a5d1-2feac393b631","name":"Retorna userMsg"},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-3808,944],"id":"09731975-3883-41a6-9283-0bf8a6572f70","name":"Google Gemini Chat Model6","credentials":{"googlePalmApi":{"id":"sMTfS675yuIxdSeK","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"hasQuestion\": {\n      \"type\": \"boolean\",\n      \"description\": \"Indica se existe dÃºvida tÃ©cnica.\"\n    },\n    \"searchQuery\": {\n      \"type\": \"string\",\n      \"description\": \"A frase de busca. Deixe vazio se nÃ£o houver pergunta.\"\n    }\n  },\n  \"required\": [\n    \"hasQuestion\"\n  ]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-3632,944],"id":"6cf8b293-a8c4-4699-a0fd-227a06986aae","name":"Parser Router"},{"parameters":{"promptType":"define","text":"=### [CONTEXTO ANALÃTICO]\n- **MENSAGEM ATUAL:** \"{{ $('CONCATENA1').first().json.user_full_message }}\"\n- **HISTÃ“RICO RECENTE:**\n{{ $('Formata ultimas mensagens').first().json.historyMessages ?? \"Sem histÃ³rico.\" }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=VocÃª Ã© um classificador de intenÃ§Ã£o binÃ¡rio.\n\n# SYSTEM: Engenheiro de Busca Contextual (Universal RAG Router)\n\nSua missÃ£o Ã© atuar como um middleware de inteligÃªncia analÃ­tica. VocÃª deve processar a interaÃ§Ã£o entre o usuÃ¡rio e o assistente para decidir se existe uma demanda de conhecimento externo e reconstruir essa demanda em uma consulta autocontida.\n\n### [ALGORITMO DE RACIOCÃNIO - EXECUÃ‡ÃƒO OBRIGATÃ“RIA]\n\n1. **MAPEAMENTO DE ENTIDADES (CONTEXTO):** Varra o [HISTÃ“RICO RECENTE] em busca do Ãºltimo substantivo tÃ©cnico, produto, serviÃ§o ou regra de negÃ³cio que foi o foco da fala da IA ou do usuÃ¡rio. Esta Ã© a sua \"Entidade de DomÃ­nio\".\n\n2. **ANÃLISE DE INTENÃ‡ÃƒO (TRIAGEM):** Avalie se a [MENSAGEM ATUAL] busca fatos, explicaÃ§Ãµes, valores, capacidades ou procedimentos sobre a Entidade de DomÃ­nio identificada.\n\n   2.1 **TRAVA DE ENTENDIMENTO (EXCEÃ‡ÃƒO PRIORITÃRIA):**\n   Se a [MENSAGEM ATUAL] for uma pergunta que apenas pede esclarecimento do que a IA acabou de perguntar, ou confirma o escopo da pergunta anterior (ex.: \"contando sÃ³ X ou Y?\", \"Ã© sÃ³ X?\", \"inclui Y tambÃ©m?\", \"quando vocÃª diz X, quer dizer o quÃª?\"), entÃ£o isso NÃƒO Ã© demanda de conhecimento externo.\n   - Nesse caso: `hasQuestion = FALSE` e `searchQuery = \"\"`.\n   - Regra: essa exceÃ§Ã£o tem prioridade sobre qualquer outra classificaÃ§Ã£o abaixo.\n   - **hasQuestion = TRUE:** Se a mensagem for uma pergunta direta, uma contestaÃ§Ã£o (\"Mas por que?\") ou uma busca por detalhes tÃ©cnicos/comerciais.\n   - **hasQuestion = FALSE:** Se a mensagem for apenas um fornecimento de dado pessoal, uma saudaÃ§Ã£o, uma reaÃ§Ã£o emocional ou uma confirmaÃ§Ã£o de fluxo (Sim/NÃ£o/Ok).\n\n3. **SÃNTESE DE CONSULTA (SEARCH QUERY):** Se `hasQuestion` for true, vocÃª deve gerar uma frase de busca que seja **totalmente autocontida**.\n   - **Regra de AutossuficiÃªncia:** A frase deve ser compreensÃ­vel para um estranho que nÃ£o leu o histÃ³rico da conversa.\n   - **TÃ©cnica de ExpansÃ£o:** Substitua pronomes e termos vagos (isso, aquilo, como faz, quanto Ã©) pelos termos tÃ©cnicos e nomes reais encontrados no histÃ³rico.\n   - **FÃ³rmula LÃ³gica:** [Nome Exato da Entidade/Produto] + [AÃ§Ã£o ou Atributo Desejado (PreÃ§o, Funcionamento, Regra, IntegraÃ§Ã£o)].\n   - **OtimizaÃ§Ã£o:** Remova qualquer ruÃ­do social (Bom dia, obrigado, opa) e foque em termos que apareceriam em um Ã­ndice de documentaÃ§Ã£o tÃ©cnica.\n\n### [REGRAS DE SAÃDA - DETERMINÃSTICO]\n- **hasQuestion (boolean):** TRUE para necessidades de consulta ao RAG; FALSE para continuidade conversacional.\n- **searchQuery (string):** A string de busca sintetizada e expandida. Caso `hasQuestion` seja false, retorne obrigatoriamente \"\"."}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-3792,752],"id":"32fbf381-2138-4e16-a247-9e2d21fa0b01","name":"Router de DÃºvida"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bd34b249-e081-4a56-b5e0-e9b5172f3251","leftValue":"={{ $('GET Estado Atual').first().json.propertyName?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[272,1424],"id":"d725c005-dd09-418c-b3a4-e1d8d0d495c1","name":"Se tiver estado atual"},{"parameters":{"method":"PATCH","url":"={{ $env.APRECHAT_URL_API }}api/ticket/{{ $('Webhook').first().json.body.ticketId }}","sendHeaders":true,"specifyHeaders":"json","jsonHeaders":"={\n    \"accept\": \"application/json, text/plain, */*\",\n    \"accept-language\": \"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7\",\n    \"authorization\": \"Bearer kZaOTd+YZpjRUyyuQUpigJaEMk4vcW4YOymKPZX0Ts8=\",\n    \"company\": {{ $('Webhook').first().json.body.companyId }},\n    \"content-type\": \"application/json\"\n  } ","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"status\": \"pending\",\n  \"whatsappId\": 18,\n  \"departmentId\": 37\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[2512,112],"id":"a811ef27-4f75-4737-bf83-75cb8236540e","name":"Transfere ticket para Aguardando Apre.Chat","onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78613adc-f045-436b-b2c6-51b000e2cf1f","leftValue":"={{ $('Busca Follow Up').first().json.id?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3296,720],"id":"4866c1ea-d661-49ac-b9cc-2af0e9a632f6","name":"Se jÃ¡ existe follow-up"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"37410f02-05b7-40c6-ada1-54580221c460","leftValue":"={{ JSON.parse($('Busca estado atual para follow-up').first().json.propertyName || '{}').missingVar?.toBoolean() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2928,720],"id":"fbcfe2cf-4667-420d-b506-07aee954b77c","name":"Se existe variÃ¡vel para ser solicitada"}],"connections":{"Split de mensagens":{"main":[[{"node":"LOOP_SLIT1","type":"main","index":0}]]},"Se nÃ£o recebeu mensagem no meio do processamento":{"main":[[{"node":"Split de mensagens","type":"main","index":0}],[{"node":"Concatena mensagens para cache","type":"main","index":0}]]},"GET2":{"main":[[{"node":"Se nÃ£o recebeu mensagem no meio do processamento","type":"main","index":0}]]},"Salva Novo Estado":{"main":[[{"node":"Router de DÃºvida","type":"main","index":0}]]},"Parser  Chain1":{"main":[[{"node":"Remove mensagens do processamento","type":"main","index":0}]]},"OutputParser":{"ai_outputParser":[[{"node":"Parser  Chain1","type":"ai_outputParser","index":0}]]},"output1":{"main":[[{"node":"Se gerou resposta","type":"main","index":0}]]},"WAIT_SPLIT1":{"main":[[{"node":"LOOP_SLIT1","type":"main","index":0}]]},"LOOP_SLIT1":{"main":[[{"node":"Switch","type":"main","index":0},{"node":"Busca estado atual para follow-up","type":"main","index":0}],[{"node":"GET3","type":"main","index":0}]]},"Envia WhatsApp1":{"main":[[{"node":"WAIT_SPLIT1","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Configura Contexto","type":"main","index":0}]]},"Configura Contexto":{"main":[[{"node":"If2","type":"main","index":0}]]},"GET Estado Atual":{"main":[[{"node":"BLUEPRINT ENGINE","type":"main","index":0}]]},"BLUEPRINT ENGINE":{"main":[[{"node":"Pega ultimas mensagens","type":"main","index":0}]]},"LOGIC ENGINE":{"main":[[{"node":"Salva Novo Estado","type":"main","index":0}]]},"Gerador de Resposta":{"main":[[{"node":"output1","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"DELETE1":{"main":[[{"node":"CONCATENA1","type":"main","index":0}]]},"SWITCH_BUFFER":{"main":[[{"node":"DELETE1","type":"main","index":0}],[{"node":"NADA1","type":"main","index":0}],[{"node":"Wait1","type":"main","index":0}]]},"If2":{"main":[[{"node":"Deleta estado atual","type":"main","index":0}],[{"node":"Retorna userMsg","type":"main","index":0}]]},"Delete table or rows1":{"main":[[{"node":"DELETE2","type":"main","index":0}]]},"Deleta estado atual":{"main":[[{"node":"Delete table or rows1","type":"main","index":0}]]},"DELETE2":{"main":[[{"node":"Remove follow-ups","type":"main","index":0}]]},"Concatena mensagens para cache":{"main":[[{"node":"RE-SETA CACHE DAS MENSAGENS ACUMULADAS","type":"main","index":0}]]},"Transforma em objeto literal":{"main":[[{"node":"SWITCH_BUFFER","type":"main","index":0}]]},"Formata histÃ³rico1":{"main":[[{"node":"Gera resumo da conversa - AI1","type":"main","index":0}]]},"Gera resumo da conversa - AI1":{"main":[[{"node":"Salva nota na conversa1","type":"main","index":0}]]},"Busca histÃ³rico de conversa1":{"main":[[{"node":"Formata histÃ³rico1","type":"main","index":0}]]},"Busca mensagens no cache":{"main":[[{"node":"Junta mensagem do cache com a mensagem do usuÃ¡rio","type":"main","index":0}]]},"Junta mensagem do cache com a mensagem do usuÃ¡rio":{"main":[[{"node":"SETA CACHE DAS MENSAGENS","type":"main","index":0}]]},"SETA CACHE DAS MENSAGENS":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"BUSCA MENSAGENS ACUMULADAS":{"main":[[{"node":"Transforma em objeto literal","type":"main","index":0}]]},"Pega ultimas mensagens":{"main":[[{"node":"Formata ultimas mensagens","type":"main","index":0}]]},"Formata ultimas mensagens":{"main":[[{"node":"Seta perfil1","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Busca histÃ³rico de conversa1","type":"main","index":0}],[{"node":"Busca histÃ³rico de conversa1","type":"main","index":0}],[{"node":"Call 'Enviar apresentaÃ§Ã£o comercial'","type":"main","index":0}]]},"Call 'Enviar apresentaÃ§Ã£o comercial'":{"main":[[{"node":"Busca histÃ³rico de conversa1","type":"main","index":0}]]},"Base de conhecimento":{"ai_tool":[[{"node":"Gerador de Resposta","type":"ai_tool","index":0}]]},"Embeddings OpenAI2":{"ai_embedding":[[{"node":"Base de conhecimento","type":"ai_embedding","index":0}]]},"Insere mensagem da IA no BD":{"main":[[{"node":"Envia WhatsApp1","type":"main","index":0}]]},"GET3":{"main":[[{"node":"Se nÃ£o recebeu mensagem no meio do processamento1","type":"main","index":0}]]},"Se nÃ£o recebeu mensagem no meio do processamento1":{"main":[[{"node":"Insere mensagem da IA no BD","type":"main","index":0}]]},"Busca estado atual para follow-up":{"main":[[{"node":"Busca Follow Up","type":"main","index":0}]]},"Busca Follow Up":{"main":[[{"node":"Se existe variÃ¡vel para ser solicitada","type":"main","index":0}]]},"Seta perfil1":{"main":[[{"node":"Insere mensagem do usuÃ¡rio no BD","type":"main","index":0}]]},"Insere mensagem do usuÃ¡rio no BD":{"main":[[{"node":"Extrator chain","type":"main","index":0}]]},"Cron 1em1 min - FOLLOW-UP":{"main":[[{"node":"Code in JavaScript","type":"main","index":0}]]},"Busca follow-ups disponÃ­veis":{"main":[[{"node":"LOOP nos follow-up's","type":"main","index":0}]]},"LOOP nos follow-up's":{"main":[[],[{"node":"BUSCA MENSAGENS ACUMULADAS1","type":"main","index":0}]]},"Busca estado atual da conversa":{"main":[[{"node":"Transforma estado atual em JSON literal","type":"main","index":0}]]},"Transforma estado atual em JSON literal":{"main":[[{"node":"Switch tipo de follow-up","type":"main","index":0}]]},"Se o usuÃ¡rio respondeu a variÃ¡vel pendente no meio do caminho":{"main":[[{"node":"LOOP nos follow-up's","type":"main","index":0}],[{"node":"Pega ultimas mensagens1","type":"main","index":0}]]},"Envia via Apre.Chat":{"main":[[{"node":"Pega novo horario de follow-up pelos attempts","type":"main","index":0}]]},"Pega ultimas mensagens1":{"main":[[{"node":"Formata ultimas mensagens1","type":"main","index":0}]]},"Formata ultimas mensagens1":{"main":[[{"node":"Se a Ãºltima mensagem foi da IA","type":"main","index":0}]]},"BUSCA MENSAGENS ACUMULADAS1":{"main":[[{"node":"Se chegou alguma mensagem do usuÃ¡rio","type":"main","index":0}]]},"Se chegou alguma mensagem do usuÃ¡rio":{"main":[[],[{"node":"Busca estado atual da conversa","type":"main","index":0}]]},"Switch tipo de follow-up":{"main":[[{"node":"Pega ultimas mensagens2","type":"main","index":0}],[{"node":"Busca ticket no Apre.Chat","type":"main","index":0}]]},"Pega ultimas mensagens2":{"main":[[{"node":"Formata ultimas mensagens2","type":"main","index":0}]]},"Formata ultimas mensagens2":{"main":[[{"node":"Gera mensagem de follow-up1","type":"main","index":0}]]},"Se a Ãºltima mensagem foi da IA":{"main":[[{"node":"Gera mensagem de follow-up2","type":"main","index":0}],[{"node":"Gera mensagem de follow-up2","type":"main","index":0}]]},"Gera mensagem de follow-up1":{"main":[[{"node":"Envia via Apre.Chat1","type":"main","index":0}]]},"Envia via Apre.Chat1":{"main":[[{"node":"Atualiza tentativa de follow-up","type":"main","index":0}]]},"Atualiza tentativas de follow-up":{"main":[[{"node":"Insere mensagem da IA no BD1","type":"main","index":0}]]},"Atualiza tentativa de follow-up":{"main":[[{"node":"Insere mensagem da IA no BD4","type":"main","index":0}]]},"Code in JavaScript":{"main":[[{"node":"If1","type":"main","index":0}]]},"Pega novo horario de follow-up pelos attempts":{"main":[[{"node":"Atualiza tentativas de follow-up","type":"main","index":0}]]},"If1":{"main":[[{"node":"Busca follow-ups disponÃ­veis","type":"main","index":0}]]},"Busca ticket no Apre.Chat":{"main":[[{"node":"Se o status do ticket nÃ£o for bot","type":"main","index":0}]]},"Se o status do ticket nÃ£o for bot":{"main":[[{"node":"LOOP nos follow-up's","type":"main","index":0}],[{"node":"Se o usuÃ¡rio respondeu a variÃ¡vel pendente no meio do caminho","type":"main","index":0}]]},"Call 'ðŸ¤–ðŸ¤– Alicia: Transferir e gerar Resumo'":{"ai_tool":[[{"node":"Gerador de Resposta","type":"ai_tool","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"Gerador de Resposta","type":"ai_languageModel","index":0}]]},"Extrator chain":{"main":[[{"node":"LOGIC ENGINE","type":"main","index":0}]]},"Structured Output Parser2":{"ai_outputParser":[[{"node":"Extrator chain","type":"ai_outputParser","index":0}]]},"Google Gemini Chat Model1":{"ai_languageModel":[[{"node":"Extrator chain","type":"ai_languageModel","index":0}]]},"Google Gemini Chat Model2":{"ai_languageModel":[[{"node":"Parser  Chain1","type":"ai_languageModel","index":0}]]},"Google Gemini Chat Model3":{"ai_languageModel":[[{"node":"Gera resumo da conversa - AI1","type":"ai_languageModel","index":0}]]},"Se gerou resposta":{"main":[[{"node":"Parser  Chain1","type":"main","index":0}],[{"node":"Remove mensagens do processamento1","type":"main","index":0}]]},"Busca mensagens em processamento":{"main":[[{"node":"Se nÃ£o tem mensagem sendo processada","type":"main","index":0}]]},"Se nÃ£o tem mensagem sendo processada":{"main":[[{"node":"Seta mensagem em processamento no cache","type":"main","index":0}],[{"node":"SETA CACHE DAS MENSAGENS1","type":"main","index":0}]]},"CONCATENA1":{"main":[[{"node":"Busca mensagens em processamento","type":"main","index":0}]]},"Seta mensagem em processamento no cache":{"main":[[{"node":"GET Estado Atual","type":"main","index":0}]]},"Remove mensagens do processamento":{"main":[[{"node":"GET2","type":"main","index":0}]]},"RE-SETA CACHE DAS MENSAGENS ACUMULADAS":{"main":[[{"node":"Se tiver estado atual","type":"main","index":0}]]},"Volta para o estado anterior":{"main":[[{"node":"Delete table or rows","type":"main","index":0}]]},"Delete table or rows":{"main":[[{"node":"BUSCA MENSAGENS ACUMULADAS","type":"main","index":0}]]},"Remove follow-ups":{"main":[[{"node":"Deleta mensagem em processamento","type":"main","index":0}]]},"Google Gemini Chat Model4":{"ai_languageModel":[[{"node":"Gera mensagem de follow-up2","type":"ai_languageModel","index":0}]]},"Gera mensagem de follow-up2":{"main":[[{"node":"Envia via Apre.Chat","type":"main","index":0}]]},"Tem DÃºvida?":{"main":[[{"node":"Consulta Base Conhecimento","type":"main","index":0}],[{"node":"MERGE DADOS","type":"main","index":0}]]},"Consulta Base Conhecimento":{"main":[[{"node":"RAG CONTEXT","type":"main","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Consulta Base Conhecimento","type":"ai_embedding","index":0}]]},"RAG CONTEXT":{"main":[[{"node":"MERGE DADOS","type":"main","index":0}]]},"MERGE DADOS":{"main":[[{"node":"Gerador de Resposta","type":"main","index":0}]]},"Insere mensagem da IA no BD1":{"main":[[{"node":"LOOP nos follow-up's","type":"main","index":0}]]},"Retorna userMsg":{"main":[[{"node":"Busca mensagens no cache","type":"main","index":0}]]},"Google Gemini Chat Model6":{"ai_languageModel":[[{"node":"Router de DÃºvida","type":"ai_languageModel","index":0}]]},"Parser Router":{"ai_outputParser":[[{"node":"Router de DÃºvida","type":"ai_outputParser","index":0}]]},"Router de DÃºvida":{"main":[[{"node":"Tem DÃºvida?","type":"main","index":0}]]},"Se tiver estado atual":{"main":[[{"node":"Volta para o estado anterior","type":"main","index":0}],[{"node":"Delete table or rows","type":"main","index":0}]]},"Salva nota na conversa1":{"main":[[{"node":"Transfere ticket para Aguardando Apre.Chat","type":"main","index":0}]]},"Se jÃ¡ existe follow-up":{"main":[[{"node":"Atualiza follow-up","type":"main","index":0}],[{"node":"Insere novo follow-up","type":"main","index":0}]]},"Se existe variÃ¡vel para ser solicitada":{"main":[[{"node":"Se jÃ¡ existe follow-up","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Cron 1em1 min":{"recurrenceRules":[]},"node:Cron 1em1 min - FOLLOW-UP":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Cron 1em1 min - FOLLOW-UP":[{"json":{"timestamp":"2026-02-13T08:10:00.003-03:00","Readable date":"February 13th 2026, 8:10:00 am","Readable time":"8:10:00 am","Day of week":"Friday","Year":"2026","Month":"February","Day of month":"13","Hour":"08","Minute":"10","Second":"00","Timezone":"America/Sao_Paulo (UTC-03:00)"}}],"Webhook":[{"json":{"headers":{"host":"n8n.apresenta.me","x-real-ip":"104.22.10.69","x-real-port":"17712","x-forwarded-for":"167.234.245.252, 104.22.10.69","x-forwarded-proto":"http","x-forwarded-host":"n8n.apresenta.me","x-forwarded-port":"80","remote-host":"104.22.10.69","connection":"close","content-length":"693","content-type":"application/json","user-agent":"axios/1.12.2","baggage":"sentry-environment=production,sentry-public_key=105feeda45f1e08a6adb966a132a4c34,sentry-trace_id=22f01a7b03a1eb967c52d0bab053a79f,sentry-sampled=false,sentry-sample_rand=0.37234432404673723,sentry-sample_rate=0.2","sentry-trace":"22f01a7b03a1eb967c52d0bab053a79f-9909b8f87f56d1e0-0","cf-ray":"9cd41cc51fada648-GRU","accept-encoding":"gzip, br","accept":"application/json, text/plain, */*","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"167.234.245.252","cf-ipcountry":"BR","cf-visitor":"{\"scheme\":\"https\"}"},"params":{},"query":{},"body":{"message":"Me chamo JoÃ£o Vitor","messageId":"4516312","contact":{"id":"34529","name":"JoÃ£o Dev","number":"554788950332","profilePicUrl":"https://pps.whatsapp.net/v/t61.24694-24/425105449_1361615211300388_1143514098522857072_n.jpg?ccb=11-4&oh=01_Q5Aa3wGGJohZb8tPrhwLmosLvgVmq3lEGrYsim3CVwIudZo3-g&oe=699C3D23&_nc_sid=5e03e0&_nc_cat=102","createdAt":"2025-08-26T13:37:58.507-03:00","updatedAt":"2026-02-13T08:51:10.663-03:00","email":"","isGroup":false,"companyId":"10","whatsappId":"209","onlyResponsible":false,"userId":"1","aprePersonId":null,"apreDealId":null,"meta":{"ignoreCheck":true,"ignorePermission":true,"dontSendSocket":false}},"whatsappId":"209","companyId":10,"ticketId":206417},"webhookUrl":"https://n8n.apresenta.me/webhook/7223c6af-f595-4bc2-b84c-602b8900cd08","executionMode":"production"}}]},"versionId":"84bc2d66-c09e-44a8-b166-7fdc68be66eb","triggerCount":2,"shared":[{"updatedAt":"2025-11-04T18:47:16.654Z","createdAt":"2025-11-04T18:47:16.654Z","role":"workflow:owner","workflowId":"dDaZdsSmHxktrhjc","projectId":"4ToGMYJEWvvDSbcz"}],"tags":[]}